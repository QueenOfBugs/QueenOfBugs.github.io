<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flask Web 全栈开发实战</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="kamisama" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./index.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">Flask Web 全栈开发实战</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org51603c6">环境搭建</a>
<ul>
<li><a href="#orgae342ee">Python 环境</a></li>
<li><a href="#orge5c41bb">Flask 版本</a></li>
<li><a href="#orge3aefb7">开发软件以及虚拟环境搭建</a></li>
<li><a href="#org51462b4">Org mode 里运行项目的设置</a></li>
</ul>
</li>
<li><a href="#org466c2a9">项目配置</a>
<ul>
<li><a href="#org7075189">Debug 模式, Host, Port 配置</a>
<ul>
<li><a href="#org0d798b6">Debug 模式</a></li>
<li><a href="#org30c5ea6">设置 Host 和 Port</a></li>
</ul>
</li>
<li><a href="#orgcb66f86">在 app.config 中添加配置</a>
<ul>
<li><a href="#orgb3908cb">使用 app.config 配置</a></li>
<li><a href="#org4fa9e04">使用 Python 配置文件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgf67b485">URL 和视图</a>
<ul>
<li><a href="#org01e598f">定义 URL</a>
<ul>
<li><a href="#org07b9028">定义无参数的URL</a></li>
<li><a href="#org995f4e3">定义有参数的URL</a></li>
</ul>
</li>
<li><a href="#org67afe89">HTTP 请求方法</a></li>
<li><a href="#orgd4c90c5">页面重定向</a></li>
<li><a href="#orgcca1ec6">构造 URL</a></li>
</ul>
</li>
<li><a href="#org18b68c3">Jinja2 模板</a>
<ul>
<li><a href="#orgdf98d72">模板的基本使用</a>
<ul>
<li><a href="#org7ce84c6">渲染模板</a></li>
<li><a href="#orge5ecb4d">渲染变量</a></li>
</ul>
</li>
<li><a href="#org9f81389">过滤器和测试器</a>
<ul>
<li><a href="#org87a7b8c">自定义过滤器</a></li>
<li><a href="#org8040532">Jinja2 内置过滤器</a></li>
<li><a href="#org6a15173">测试器</a></li>
</ul>
</li>
<li><a href="#org33ecbf6">控制语句</a>
<ul>
<li><a href="#org006e4c2">if 判断语句</a></li>
<li><a href="#org9cf0b92">for 循环语句</a></li>
</ul>
</li>
<li><a href="#org6500f55">模板结构</a>
<ul>
<li><a href="#org052a421">宏和 import 语句</a></li>
<li><a href="#org9338c37">模板继承</a></li>
<li><a href="#org4473400">引入模板</a></li>
</ul>
</li>
<li><a href="#orgdc681a0">模板环境</a>
<ul>
<li><a href="#org579884d">模板上下文(context?)</a></li>
<li><a href="#orgfb4bcdc">全局函数</a></li>
<li><a href="#orgb212d2c">Flask 模板环境</a></li>
</ul>
</li>
<li><a href="#org4312458">其他</a>
<ul>
<li><a href="#orgd3f355c">转义</a></li>
<li><a href="#orgdc8983f">加载静态文件</a></li>
<li><a href="#orgaf5016f">闪现消息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org33b1550">数据库</a>
<ul>
<li><a href="#org822e70d">准备工作</a>
<ul>
<li><a href="#org8c7e25d">MySQL 软件</a></li>
<li><a href="#org1a557f0">Python 操作 MySQL 驱动</a></li>
<li><a href="#orgc81ef97">Flask-SQLAlchemy</a></li>
</ul>
</li>
<li><a href="#orge56ed21">Flask-SQLAlchemy 的基本使用</a>
<ul>
<li><a href="#orgd8b5fc8">连接 MySQL</a></li>
<li><a href="#org770f5a6">ORM模型</a></li>
<li><a href="#org9a1f7cf">CRUD 操作</a></li>
</ul>
</li>
<li><a href="#org8aee9f7">表关系</a>
<ul>
<li><a href="#orgbdfd2de">外键</a></li>
<li><a href="#org8975eae">一对多关系</a></li>
<li><a href="#org6b5679c">一对一关系</a></li>
<li><a href="#org113d32a">多对多关系</a></li>
<li><a href="#org8ea0e87">级联操作</a></li>
</ul>
</li>
<li><a href="#orgd56b847">ORM 模型迁移</a>
<ul>
<li><a href="#orgbff662d">创建迁移对象</a></li>
<li><a href="#org975c666">初始化迁移环境</a></li>
<li><a href="#org1ed2330">生成迁移脚本</a></li>
<li><a href="#org473c172">执行迁移脚本</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5dbfee6">表单</a>
<ul>
<li><a href="#orgec9fd7e">表单验证</a>
<ul>
<li><a href="#orga509485">表单类编写</a></li>
<li><a href="#org8e8e31a">视图函数中使用表单</a></li>
<li><a href="#orge960b88">自定义验证字段</a></li>
</ul>
</li>
<li><a href="#orgedf3c1d">渲染表单模板</a></li>
<li><a href="#orgc220582">CSRF 攻击</a>
<ul>
<li><a href="#org72c8972">防御 CSRF 攻击原理</a></li>
<li><a href="#org45bcdda">Flask-WTF 防御 CSRF 攻击</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
:header-args: :eval never-export :results verbatim
</p>
<p>
Last modified:2023-04-25 15:54:10 kamisama
</p>
<div id="outline-container-org51603c6" class="outline-2">
<h2 id="org51603c6">环境搭建</h2>
<div class="outline-text-2" id="text-org51603c6">
</div>
<div id="outline-container-orgae342ee" class="outline-3">
<h3 id="orgae342ee">Python 环境</h3>
<div class="outline-text-3" id="text-orgae342ee">
<p>
书里使用的是 Python 3.9, 作者推荐至少使用 Python 3.6 以上的版本.
</p>
</div>
</div>
<div id="outline-container-orge5c41bb" class="outline-3">
<h3 id="orge5c41bb">Flask 版本</h3>
<div class="outline-text-3" id="text-orge5c41bb">
<p>
书里的知识点和项目都基于 Flask 2.0.1.
</p>

<p>
使用 pip 安装 2.0.1 版本 flask.
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install <span style="font-weight: bold; font-style: italic;">flask</span>==2.0.1
</pre>
</div>

<pre class="example">
Collecting flask==2.0.1
  Using cached Flask-2.0.1-py3-none-any.whl (94 kB)
Requirement already satisfied: Werkzeug&gt;=2.0 in e:\python38\lib\site-packages (from flask==2.0.1) (2.2.3)
Requirement already satisfied: click&gt;=7.1.2 in e:\python38\lib\site-packages (from flask==2.0.1) (8.1.3)
Requirement already satisfied: itsdangerous&gt;=2.0 in e:\python38\lib\site-packages (from flask==2.0.1) (2.1.2)
Requirement already satisfied: Jinja2&gt;=3.0 in e:\python38\lib\site-packages (from flask==2.0.1) (3.1.2)
Requirement already satisfied: colorama in e:\python38\lib\site-packages (from click&gt;=7.1.2-&gt;flask==2.0.1) (0.4.5)
Requirement already satisfied: MarkupSafe&gt;=2.0 in e:\python38\lib\site-packages (from Jinja2&gt;=3.0-&gt;flask==2.0.1) (2.1.1)
Installing collected packages: flask
Successfully installed flask-2.0.1
</pre>
</div>
</div>

<div id="outline-container-orge3aefb7" class="outline-3">
<h3 id="orge3aefb7">开发软件以及虚拟环境搭建</h3>
<div class="outline-text-3" id="text-orge3aefb7">
<p>
作者推荐使用 Pycharm. 但我当前的目标是使用 Org 文档进行文学编程,笔记记录等,所以
仍然尝试用这个笔记文件来进行开发以及笔记记录,也就是说用 Emacs 作为开发软件(吧).
</p>

<p>
Pycharm 创建项目会创建虚拟环境,我们也可以通过 Org-babel 创建文件/目录和执行相关
命令来创建虚拟环境.
</p>

<p>
在家目录创建一个文件夹用作这本书的项目练习目录:
我 linux 上的 Python 版本是 3.10,且安装有多个 python 版本,所以用了 3_10 的后缀区
分.
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10
</pre>
</div>

<p>
创建目录后进入该目录创建虚拟环境:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10;python -m venv ./
</pre>
</div>

<p>
或者直接
</p>
<div class="org-src-container">
<pre class="src src-sh">python -m venv ~/flask_web_py3_10
</pre>
</div>

<p>
然后就可以(一定要)激活虚拟环境了,不激活就使用的是系统安装的 python 而不是虚拟环
境里的 python.
windows 和 linux 的激活命令不一致,但一般都是叫 activate.* 的,在 bin 目录或
scripts 目录里就可以找到. 具体的激活方法在官方文档里可以找到: <a href="https://docs.python.org/3/library/venv.html#how-venvs-work">venv</a>
</p>

<p>
linux:
</p>
<div class="org-src-container">
<pre class="src src-sh">source ~/flask_web_py3_10/bin/activate
</pre>
</div>

<p>
Windows:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31561;&#25105;&#20999;&#25442;&#21040; Windows &#31995;&#32479;&#19978;&#22312;&#20889;&#36825;&#37096;&#20998;.</span>
<span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">~/flask_web_py3_10/Scripts/activate.bat</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30001;&#20110;&#25105;&#26159;&#22312; Emacs &#30340; org mode &#20195;&#30721;&#22359;&#37324;&#25191;&#34892;&#20195;&#30721;,&#25152;&#20197;&#36824;&#26159;&#20351;&#29992; source</span>
source ~/flask_web_py3_10/Scripts/activate
</pre>
</div>

<pre class="example">
sh: cannot set terminal process group (-1): Inappropriate ioctl for device
sh: no job control in this shell
</pre>



<p>
激活了 python 虚拟环境之后,相当于在一个新安装的 python 环境下了,所以系统环境的
python 里安装的包都没了,需要重新安装.
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install <span style="font-weight: bold; font-style: italic;">flask</span>==2.0.1
</pre>
</div>

<pre class="example">
Collecting flask==2.0.1
  Downloading Flask-2.0.1-py3-none-any.whl (94 kB)
=3.0
  Downloading Jinja2-3.1.2-py3-none-any.whl (133 kB)
=2.0
  Downloading Werkzeug-2.2.3-py3-none-any.whl (233 kB)
=2.0
  Downloading itsdangerous-2.1.2-py3-none-any.whl (15 kB)
=7.1.2
  Downloading click-8.1.3-py3-none-any.whl (96 kB)
=2.0
  Downloading MarkupSafe-2.1.2-cp38-cp38-win_amd64.whl (16 kB)
Collecting colorama; platform_system == "Windows"
  Downloading colorama-0.4.6-py2.py3-none-any.whl (25 kB)
Installing collected packages: MarkupSafe, Jinja2, Werkzeug, itsdangerous, colorama, click, flask
Successfully installed Jinja2-3.1.2 MarkupSafe-2.1.2 Werkzeug-2.2.3 click-8.1.3 colorama-0.4.6 flask-2.0.1 itsdangerous-2.1.2
WARNING: You are using pip version 20.2.1; however, version 23.0.1 is available.
You should consider upgrading via the 'c:\users\kamisama\flask_web_py3_10\scripts\python.exe -m pip install --upgrade pip' command.
</pre>

<p>
安装完毕.
</p>

<p>
下面使用 Hello World! 来测试一下环境搭建和安装的过程是否有错.
首先,创建一个 hello_world 目录,来放置这个测试项目,然后创建 flask 项目的入口文件 app.py.
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/
mkdir hello_world;<span style="font-weight: bold;">cd</span> hello_world
touch app.py
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/hello_world/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run()

</pre>
</div>

<p>
使用 tangle 将代码导出到 app.py 文件里,然后执行该文件,如果没有出错,就可以在浏览器里输入
<a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 并看到网页显示 Hello World! 了.
</p>
<div class="org-src-container">
<pre class="src src-sh">python -m flask run
</pre>
</div>

<p>
用 C-c C-c 执行上面代码块会导致 Emacs 卡死,这是因为在执行上面的代码,而上面的代码
不会自动切换到后台执行,所以才导致卡死,可以用 C-g 中断执行, Emacs 就会恢复正常了,
另外应该是有一种可以让代码块后台执行的头参数设置,我还没学习到,有空再说.
</p>

<p>
此外,其实直接运行 app.py 文件也是可以的:
</p>
<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>

<p>
浏览器的页面里出现 Hello World 就表示已经安装成功了.
</p>

<blockquote>
<p>
使用 :session 头参数可以创建一个新的缓冲区,用来执行同一个 session 的代码,虽然也
会卡死,但用 C-g 退出后只会退出卡死状态,创建的新缓冲区没有消失,且仍然在运行代码,
这个就像是 Pycharm 的终端界面一样,可以用这种方法来让代码在后台执行,同时又不影响
对代码的编辑操作.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org51462b4" class="outline-3">
<h3 id="org51462b4">Org mode 里运行项目的设置</h3>
<div class="outline-text-3" id="text-org51462b4">
<p>
将代码块命名可以通过调用来执行该代码块,利用这一点,我们将运行项目的代码编写到一起,需
要时调用即可,如同IDE 的运行按钮一样.
先进入项目目录并激活虚拟环境
</p>
<div class="org-src-container">
<pre class="src src-sh" id="orgfe7acff"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10
source Scripts/activate
</pre>
</div>

<pre class="example">
sh: cannot set terminal process group (-1): Inappropriate ioctl for device
sh: no job control in this shell
</pre>


<div class="org-src-container">
<pre class="src src-shell" id="org349aae0">ls
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org466c2a9" class="outline-2">
<h2 id="org466c2a9">项目配置</h2>
<div class="outline-text-2" id="text-org466c2a9">
<p>
Flask 项目开发或部署到服务器上,都需要做一些配置. 这些配置可以开启或关闭一些
Flask 项目的功能,比如 Debug 模式,连接数据库参数信息等都需要通过配置才能开启.
</p>

<p>
这章的练习都放在 flask_web_py3_10/demo02 文件夹里.
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo02
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo02
</pre>
</div>

<pre class="example">
mkdir: cannot create directory '/c/Users/kamisama/flask_web_py3_10/demo02': File exists
</pre>
</div>



<div id="outline-container-org7075189" class="outline-3">
<h3 id="org7075189">Debug 模式, Host, Port 配置</h3>
<div class="outline-text-3" id="text-org7075189">
<p>
Debug 模式表示是否开启调试模式, Host 和 Port 配置则代表项目运行使用的 Host 和监
听的端口号.
</p>

<blockquote>
<p>
网络通信需要知道主机地址以及通信工具使用的端口号,简单理解 Host 就是地址,是一个单
位大楼,而 Port 就是房间号或办事窗口号,而运行的 flask 项目就是在 Host 这个大楼的
Port 窗口/房间里处理对应事情的人员,发送到 Host 大楼,Port 窗口的消息会被 flask 项
目接收处理,这对 flask 项目来讲就是 "监听".
</p>
</blockquote>
</div>

<div id="outline-container-org0d798b6" class="outline-4">
<h4 id="org0d798b6">Debug 模式</h4>
<div class="outline-text-4" id="text-org0d798b6">
<p>
使用 Flask 开发项目过程中,会不断添加和修改代码,如果没有开启 Debug 模式,每次修改
后都需要重新启动项目才能看到运行效果,开启 Debug 模式后,对代码的修改被检测到后
Flask 会自动重启项目,而且,如果程序出错了,在开启 Debug 模式时,在浏览器端会显示错
误信息,并标记错误行为,这样对定位 bug 有很大帮助.
</p>

<p>
Pycharm Professional 里集成了 flask 运行环境,可以在它的编辑配置里勾选
FLASK_DEBUG, 就可以开启 Debug 模式.
</p>

<p>
用普通的方法就是在 app.run 方法里添加 debug=True 参数.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>


<p>
添加 debug 参数后运行,再修改 app.py 中的代码(Hello World 改为 Hello Flask),可以
在终端窗口看到项目重新运行了,浏览器访问 <a href="http:127.0.0.1:5000">http:127.0.0.1:5000</a> 可以看到输出结果变为
Hello Flask! 而不需要我们手动去重启项目让修改生效了.
</p>

<blockquote>
<p>
我是在 Org mode 里运行,所以用的是 Emacs 提供的 shell 终端,分一个窗口出来就可以像
IDE 一样查看终端的输出了.使用 IDE 或者直接就是在终端里运行的应该更容易观察到结果,至
少不用额外调度出 shell 的缓冲区.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello Flask!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-org30c5ea6" class="outline-4">
<h4 id="org30c5ea6">设置 Host 和 Port</h4>
<div class="outline-text-4" id="text-org30c5ea6">
<p>
Host 表示主机,Port 表示端口号. 例如,百度首页的网址: <a href="https://www.baidu.com">https://www.baidu.com</a>,
www.baidu.com 就是 Host, 443 就是 Port. https 表示该网址使用的是 https 协议,因为
https 默认的端口号是 443,所以,平常即使我们没有写明 443 端口号,浏览器也会自动请求
百度服务器的 443 端口,即使用 <a href="https://www.baidu.com">https://www.baidu.com</a> 也可以访问百度首页.
</p>

<p>
运行 Flask 项目,控制台(终端)会打印信息 <code>Running on http://217.0.0.1:5000</code>, 这表
明 Host 是 127.0.0.1, Port 是 5000.
</p>

<p>
修改 Host 和 Port 在 Pycharm Professional 上仍然在 Edit Configurations 里,找到
Additional options, 在文本框里添加 "&#x2013;port=8000" ,单击 OK, 再次运行,就可以看到监
听端口从 5000 变成 8000.修改 Host 也是在同一个文本框里添加 "&#x2013;host=0.0.0.0" 就可
以修改host 了.
</p>

<blockquote>
<p>
一般需要在一台机器上运行两个 Flask 项目时就要修改端口了,不然两个项目都监听 5000
端口就会导致其中一个不能正确运行.所以在端口号被占用的情况下,设置不同的端口号可以
让项目正常运行起来.
</p>
</blockquote>

<blockquote>
<p>
Host 不是修改为什么都可以的,必需是下面三种之一:
</p>
<ul class="org-ul">
<li>本机的局域网 IP 地址: 表示不管从本机还是局域网其他设备访问都需要通过改局域网
IP 才能访问.</li>
<li>127.0.0.1: 代表本机的 IP 地址,表示只能在本机访问.</li>
<li>0.0.0.0: 表示可以用上面两种任意一种访问.</li>
</ul>


<p>
第一种地址的访问例子: 连接在同一个局域网(WIFI) 的手机可以通过访问本机的局域网ip
来访问地址, <a href="http://局域网ip:8000">http://局域网ip:8000</a>
</p>

<p>
第二种地址的访问例子: 只能在本机的浏览器上通过输入 <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a> 来访问.
</p>

<p>
第三种地址: 上面两种访问方式都可以.
</p>
</blockquote>

<p>
非 Pycharm professional 的设置方式和设置 Debug 模式一样,在 app.run() 里添加对应
的参数 <code>port = 8000, host = "0.0.0.0"</code> 即可.
</p>
<blockquote>
<p>
port 参数只能设置整型值,host 只能设置为字符串. host设置为"0.0.0.0" 后,控制台显示
运行在 <a href="http://192.168.31.22:8000">http://192.168.31.22:8000</a> 这种形式的地址里,这个 192.168.31.22 就是局域网
地址,但是我们用 127.0.0.1 的 host 也是可以访问的.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello Flask!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>, host=<span style="font-style: italic;">"0.0.0.0"</span>, port=8000)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcb66f86" class="outline-3">
<h3 id="orgcb66f86">在 app.config 中添加配置</h3>
<div class="outline-text-3" id="text-orgcb66f86">
<p>
除了 Debug,Host 和 Port 这三个配置之外,其他的配置参数都需要配置到 Flask 对象
(app)的 app.config 属性中,在配置较多的情况下,还会将配置放到配置文件中.
</p>
</div>

<div id="outline-container-orgb3908cb" class="outline-4">
<h4 id="orgb3908cb">使用 app.config 配置</h4>
<div class="outline-text-4" id="text-orgb3908cb">
<p>
app.config 是 Config 的对象, Config 是继承自 dict 的子类,所以可以像操作字典一样
操作它.
</p>

<p>
<b>注意: app.config 的所有配置项的名称必须大写.</b>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26377;&#25928;&#37197;&#32622;</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"asdfjk@##!"</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"RIGHT"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26080;&#25928;&#37197;&#32622;</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"test"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"Test"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>

<p>
app.config 里的配置项可以是 Flask 及其插件内置的一些配置项,也可以是用户自定义的
配置项.如果在开发中需要使用到 app.config 里配置好的配置项数据,就可以通过类似字典
的方式获取数据项的值:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"TEST"</span>]=<span style="font-weight: bold; text-decoration: underline;">True</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20013;&#38388;&#20195;&#30721;&#30465;&#30053;...</span>
<span style="font-weight: bold; font-style: italic;">test</span> = app.config[<span style="font-style: italic;">"TEST"</span>]
</pre>
</div>

<p>
直接对 app.config 进行设置的方法适合比较小的项目,配置东西不多时几行代码就搞定了,
但项目越大越复杂,配置项就越多, app.py 就会包含大量设置配置项的代码,这样就不够优
雅和简洁了. 所以企业开发的项目都会使用配置文件来设置配置项.
</p>
</div>
</div>

<div id="outline-container-org4fa9e04" class="outline-4">
<h4 id="org4fa9e04">使用 Python 配置文件</h4>
<div class="outline-text-4" id="text-org4fa9e04">
<p>
在项目文件夹下创建一个 config.py 文件,用来专门存放配置项.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">config.py</span>
<span style="font-weight: bold; font-style: italic;">TOKEN_KEY</span> = <span style="font-style: italic;">"123456"</span>
</pre>
</div>

<p>
然后在 app.py 里倒入这个文件(模块):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; config &#27169;&#22359;(&#25991;&#20214;)&#37324;&#35835;&#21462;&#37197;&#32622;&#21040; app.config</span>
app.config.from_object(config)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
<span style="font-weight: bold;">print</span>(app.config[<span style="font-style: italic;">"TOKEN_KEY"</span>])
</pre>
</div>
<p>
运行项目后可以看到打印出 123456.
</p>

<p>
app.config.from_object 除了使用导入的 python 模块之外,还可以通过字符串形式加载:
<code>app.config.from_object("config")</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">import config</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; config &#27169;&#22359;(&#25991;&#20214;)&#37324;&#35835;&#21462;&#37197;&#32622;&#21040; app.config</span>
app.config.from_object(<span style="font-style: italic;">"config"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
<span style="font-weight: bold;">print</span>(app.config[<span style="font-style: italic;">"TOKEN_KEY"</span>])
</pre>
</div>

<p>
Flask 还有许多方式添加读取配置文件,如 app.config.from_file 和
app.config.from_json. 查阅 Flask 官方文档可以看到相关内容:
<a href="https://flask.palletsprojects.com/en/2.0.x/config/">configuration-handling</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgf67b485" class="outline-2">
<h2 id="orgf67b485">URL 和视图</h2>
<div class="outline-text-2" id="text-orgf67b485">
<div class="org-src-container">
<pre class="src src-sh" id="org61b96aa">source ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo03/
python  app.py
</pre>
</div>


<p>
Pycharm Professional 创建 flask 项目后会自动生成 app.py 文件,里面默认代码应该如
下:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run()
</pre>
</div>

<p>
我们手动操作也要创建 app.py 文件,因为 app.py 是 flask 项目入口文件.
</p>

<p>
上面代码里 <code>@app.route()</code> 括号里的第一个参数叫做 URL, 把 <code>@app.route</code> 装饰的函数
叫做视图函数.
</p>

<p>
上面代码里 URL "<i>" 和视图函数 hello_world 绑定. 访问 URL 的规则 "</i>" 即网站的根路
径,就会执行 hello_world 函数,因为它只返回了 "Hello World!" 字符串,所以浏览器访问
时只会看到 "Hello World!".
</p>
</div>

<div id="outline-container-org01e598f" class="outline-3">
<h3 id="org01e598f">定义 URL</h3>
<div class="outline-text-3" id="text-org01e598f">
<p>
多数网站不可能只有首页一个页面,所以需要定义多个不同的 URL 来满足不同页面的访问需
求. URL 又分为两种,一种为无参URL, 另一种是带参URL.
</p>
</div>

<div id="outline-container-org07b9028" class="outline-4">
<h4 id="org07b9028">定义无参数的URL</h4>
<div class="outline-text-4" id="text-org07b9028">
<p>
无参URL 值得是定义 URL 时不需要定义参数.例如,定义博客个人中心的页面URL
"/profile":
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"This is profile page!"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run()
</pre>
</div>

<blockquote>
<p>
这里我们说的页面 URL "/profile" 是省略了域名和端口号的,实际访问时应该用
<a href="http://127.0.0.1:5000/profile">http://127.0.0.1:5000/profile</a> 来访问. 为了方便,说明 URL 时都是省略域名和端口号的.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org995f4e3" class="outline-4">
<h4 id="org995f4e3">定义有参数的URL</h4>
<div class="outline-text-4" id="text-org995f4e3">
<p>
其实现在大多数 URL 访问时都是带参数的.比如获取博客第10页的页面,则需要传入10到
URL 里,URL 可能为 "/blog/page/10", URL 里的10 表示页码,以参数形式传入.
</p>
<blockquote>
<p>
如果不带参数,可以想象下如果有一百个页面,就需要定义100个不带参数的 URL,
"/blog/page/1" 到 "/blog/page/100", 如果是带参数的 URL, 则只需要定义一个 URL 然
后将页码作为参数传入即可.
</p>
</blockquote>

<p>
以博客平台的每个博客详情页为例,每个博客以 ID 惟一标识:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458; ID &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(blog_id)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码里 URL "/blog/&lt;blog_id&gt;" 比之前定义的 URL 多了一对尖括号,且尖括号里有一
个 blog_id ,这个 blog_id 就是在浏览器里访问时 URL 的参数.对应视图函数
blog_detail 里也定义了一个相应的参数 blog_id. 当浏览器访问该 URL 时, Flask 接受
到请求,然后会解析 URL 中的参数 blog_id, 并将它传递给视图函数 blog_detail. 浏览器
里输入 <a href="http://127.0.0.1:5000/blog/1">http://127.0.0.1:5000/blog/1</a> 就会看到 <code>你访问的博客 ID 为: 1</code>.
</p>


<p>
URL 里的参数还可以指定数据类型,指定参数的数据类型有两点好处:
</p>
<ul class="org-ul">
<li>访问URL 时,如果传入的参数不能被转换成指定类型,例如定义URL 时指定参数为整数类型,但
是访问时传入的参数值是 hello 这种不能被转换成整型的值,那么URL 就不会被批匹配,
并抛出 404 错误,而不是匹配了URL 然后确抛出程序错误,例如浏览器传入 hello 作为
blog_id 参数值而视图函数里默认 blog_id 是整型值并做出计算,那就会导致程序错误.</li>
<li>URL 本质上是一个字符串,如果没有指定参数类型,那传入到视图函数时也是默认字符串类
型.如果指定了参数类型,传入视图函数的就是转换后的类型,更加方便.</li>
</ul>


<p>
指定参数类型的语法也很简单: <code>&lt;类型:参数名&gt;</code>,还是以 "/blog/&lt;blog_id&gt;" URL 为例,如
果要指定 blog_id 为 int 类型: 将URL 定义改为 "/blog/&lt;int:blog_id&gt;" 即可,修改后,
浏览器里访问 "/blog/hello" 就会显示 Not Found. 因为 hello 不能转换成 int 类型.
</p>

<p>
URL 中的参数可以指定为其他类型:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">参数类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">string</td>
<td class="org-left">字符串类型,可以接收"/"以外的字符</td>
</tr>

<tr>
<td class="org-left">int</td>
<td class="org-left">整型,可以接收能通过 int() 方法转换的字符</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">浮点类型,可以接收能通过 float() 方法转换的字符</td>
</tr>

<tr>
<td class="org-left">path</td>
<td class="org-left">路径,类似 string, 但是中间可以添加 "/"</td>
</tr>

<tr>
<td class="org-left">uuid</td>
<td class="org-left">UUID 类型,由一组32位的十六进制数构成</td>
</tr>

<tr>
<td class="org-left">any</td>
<td class="org-left">any 类型,可以接收备选值中的任意一个</td>
</tr>
</tbody>
</table>

<p>
上表就 any 需要额外讲解,它的用法是: <code>&lt;any(value1,value2,...):arg&gt;</code>, 例如要实现某
个分类的URL, 种类只能是 python, flask, django 之一,就可以用 any 来实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;any(python,flask,django):category&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_category</span>(category):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;&#20998;&#31867; &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(category)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
这样修改后,访问 "/blog/list/python" 会显示 "你访问的博客分类 为: python" 而访问
"/blog/list/java" 就会显示 "Not Found".
</p>

<p>
如果 URL 中要传递多个参数,就需要用斜杠("/")隔开.例如要获取某个用户的某个博客页面,需
要传递用户 id 和页码号:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"This is profile page!"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458; ID &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(blog_id)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;any(python,flask,django):category&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_category</span>(category):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;&#20998;&#31867; &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(category)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;/&lt;int:page&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list</span>(user_id, page):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#27491;&#22312;&#35775;&#38382;&#29992;&#25143; {}, &#39029;&#38754; {}"</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
定义 URL 时,通常都追求简洁,上面博客页面 URL 通常情况下都是访问第一页的页面,如果
可以把在第一页时省略page 参数,URL 看起来会更加简洁,代码可以做如下修改:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;/&lt;int:page&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list</span>(user_id, page=1):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#27491;&#22312;&#35775;&#38382;&#21338;&#23458; {}, &#39029;&#38754; {}"</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
我们只是给视图函数里的 page 参数添加了一个默认值1,这样当 URL 不带 page 参数访问
时,默认的 page 就是1,从而简化了 URL. 例如访问URL "/blog/list/10" ,会看到 "你正在
访问博客 10,页面 1".
</p>

<p>
上面代码里,定义了两个 URL, 第一格没有 page 参数,但是视图函数有 page 且默认值为1,
这样当访问不带 page 的 URL 时,就默认使用1 为 page 的值.
</p>

<p>
参数的传递还可以通过查询字符串来实现,即在 URL 后面加上 "?" 来添加参数,多个参数用
"&amp;" 连接:
</p>
<pre class="example">
URL?参数名1=参数值1&amp;参数名2=参数值2
</pre>
<p>
查询字符串的方式传递参数不需要在 URL 里定义好参数,只需要在访问时通过 URL 传递即
可,这种方式传递的参数值可以通过 Flask 的 request.args 对象获取, 以 URL
"blog/list?user_id=10&amp;page=8" 为例获取URL 里的参数值代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/list'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_query_str</span>():
    <span style="font-weight: bold; font-style: italic;">user_id</span> = request.args.get(<span style="font-style: italic;">'user_id'</span>)
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">'page'</span>)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'&#27491;&#22312;&#26597;&#25214;&#30340;&#29992;&#25143;&#20026; {}, &#39029;&#38754;&#20026; {}'</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
request 是线程隔离的全局对象, request.args 是继承自 dict 的对象,保存了当前请求的
查询字符串参数,可以通过字典的方式获取.
</p>

<p>
查询字符串的方式传递参数,参数是视图函数规定好的,浏览器按照规定传递,上面代码里规
定获取 user_id 和 page 参数,但如果浏览器没有按照规定传递参数,比如URL是
"/blog/list?user_id=10&amp;pig=1", 注意这个 URL 里是 pig 不是 page, 那么就会看到 "正
在查找的用户为 10, 页面为 None".
</p>

<p>
URL 中定义参数和查询字符串两种方式都可以传递参数,但还是有些区别的.
URL 中定义参数, 实际上参数是 URL 的一部分了, 查询字符串方式则是 HTTP 协议层面用
来传递参数的技术,后面还有 POST 方式传递参数(数据).
</p>

<p>
两种方法的特点总结:
</p>
<ul class="org-ul">
<li>URL 中定义参数的方式比查询字符串的方式更利于 SEO 优化,能更好被搜索引擎检索和收
录.简书的文章详情和CSDN 的博客id 就是通过URL中定义参数再传递的.</li>
<li>URL 中定义参数可以做好类型约束,不会让错误类型的数据匹配URL, 提高了程序的 <del>健壮
性</del></li>
<li>查询字符串方式传递参数更加灵活,不需要修改URL, 就可以方便的添加和修改参数.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-org67afe89" class="outline-3">
<h3 id="org67afe89">HTTP 请求方法</h3>
<div class="outline-text-3" id="text-org67afe89">
<p>
HTTP 协议中,请求 URL 有不同的方法(method), 不同的请求方法有不同的应用场景.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> HTTP 请求方法以及使用方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">请求方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">GET</td>
<td class="org-left">从服务器获取资源,浏览器中输入网址访问就是默认使用 GET 请求.</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">提交资源到服务器,如提交表单或上传文件,一般用于创建新的资源或修改已有资源</td>
</tr>

<tr>
<td class="org-left">HEAD</td>
<td class="org-left">类似于 GET 请求,响应体中不包含具体内容,专门用来获取消息头</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left">请求服务器上传资源</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left">请求服务器替换或修改已有资源</td>
</tr>

<tr>
<td class="org-left">OPTIONS</td>
<td class="org-left">请求服务器返回某个资源支持的所有 HTTP 请求方法,如 AJAX 跨域请求常用 OPTIONS 方法发送嗅探请求,来判断是否有对某个资源的访问权限</td>
</tr>

<tr>
<td class="org-left">PATCH</td>
<td class="org-left">类似于 PUT 方法,但是 PATCH 一般用于局部资源更新, PUT 方法用于整个资源的替换</td>
</tr>
</tbody>
</table>

<p>
Flask 项目中使用 app.route 装饰器定义 URL 时,默认使用的就是 GET 请求,在浏览器里
输入网址访问时,默认使用的也是 GET 请求,所以可以正常访问.
</p>

<p>
想要更改 URL 的请求方法,可以在定义 URL 时,通过设置 app.route 的 methods 参数来指
定:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/add'</span>, methods = [<span style="font-style: italic;">'POST'</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_add</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; POST &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码给 method 参数赋值为一个列表,且列表中只有一个 POST 来限制了这个 URL 只能
通过 POST 方法进行访问. 如果直接在浏览器的网址里输入 '/blog/add' 访问,就会显示错
误信息 : "Method Not Allowed".
</p>

<p>
如果想要一个 URL 允许多种方法访问,可以在 methods 参数的列表中添加多个元素:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/add'</span>, methods = [<span style="font-style: italic;">'POST'</span>, <span style="font-style: italic;">'GET'</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_add</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">'GET'</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; GET &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
    <span style="font-weight: bold;">elif</span> request.method == <span style="font-style: italic;">'POST'</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; POST &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
修改后再次访问 '/blog/add' 的url 则会显示 "使用 GET 方法添加博客"
</p>

<p>
从 Flask 2.0 开始,添加了5个快捷路由装饰器,用于定义只接收某种类型请求方法的 URL:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> 快捷路由装饰器</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">快捷路由装饰器</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">app.get('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["GET"])</td>
</tr>

<tr>
<td class="org-left">app.post('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["POST"])</td>
</tr>

<tr>
<td class="org-left">app.put('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["PUT"])</td>
</tr>

<tr>
<td class="org-left">app.delete('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["DELETE"])</td>
</tr>

<tr>
<td class="org-left">app.patch('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["PATCH"])</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgd4c90c5" class="outline-3">
<h3 id="orgd4c90c5">页面重定向</h3>
<div class="outline-text-3" id="text-orgd4c90c5">
<p>
页面重定向, 一般简称为重定向. 重定向在页面中的表现就是,浏览器会自动从一个页面跳
转到另一个页面.最常见的就是访问需要登录才能访问的页面,但是用户没有登录,然后就跳
转到登录页面了.
</p>

<p>
重定向分为 <b>永久性重定向</b> 和 <b>暂时性重定向</b>:
</p>
<dl class="org-dl">
<dt>永久性重定向</dt><dd>HTTP 的状态码是 301, 多用于旧的网址已经被废弃, 要转到新的网址,
保证用户正常的访问.比如之前的京东网站用过很多其他域名,www.360buy.com
,www.jingdong.com 等,当用户不知道京东网址变成了 www.jd.com ,且前面两个域名没有
废弃之前,访问前两个网址就会自动跳转到 www.jd.com. 因为两个旧网址是要废弃的,所
以这种情况就用永久性重定向.重定向可以保证老用户正常访问,且告知他们新网址.</dd>
<dt>暂时性重定向</dt><dd>HTTP 的状态码是 302, 表示页面暂时性跳转. 访问一个需要权限的网
址,但是用户当前没有登录,这时候就应该重定向到登录页面,而且是暂时性的重定向.</dd>
</dl>


<p>
flask 里的重定向是通过 flask.redirect(location,code=302) 函数来实现的, location
是重定向的目标 URL, code 表示状态码,默认值是 302,暂时性重定向.
</p>

<p>
下面用简单的例子说明用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, redirect, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"login page"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():
    <span style="font-weight: bold; font-style: italic;">name</span> = request.args.get(<span style="font-style: italic;">"name"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#27809;&#26377;&#26597;&#35810;&#23383;&#31526;&#20018;&#20256;&#36882; name &#21442;&#25968;,&#20195;&#34920;&#27809;&#26377;&#30331;&#24405;,&#37325;&#23450;&#21521;&#21040;&#30331;&#24405;&#39029;&#38754;</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> name:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/login"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">return</span> name

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
直接访问 "/profile" 会重定向到 "/login" 页面,显示 "login page" ,访问
"/profile?name=admin" 就会显示 "admin"
</p>
</div>
</div>

<div id="outline-container-orgcca1ec6" class="outline-3">
<h3 id="orgcca1ec6">构造 URL</h3>
<div class="outline-text-3" id="text-orgcca1ec6">
<p>
上面重定向时使用的 <code>redict("/login")</code> 里的 URL 是硬编码的,而URL 可能会随着发展而
变化,一旦发生改变,只要是用硬编码方式使用该 URL 的地方,在项目代码里都需要修改,会
很麻烦.而url 对应的视图函数是开发者自己使用的,一般不会发生修改,且都是可以惟一标
识的,所以我们需要使用某个 URL 时可以使用 url_for 函数,它可以根据视图函数来使用对
应的 URL.
</p>

<p>
用博客详情页的例子说明下 url_for 的用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;int:blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;id &#20026;{}"</span>.<span style="font-weight: bold;">format</span>(blog_id)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/urlfor"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_url_for</span>():
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"blog_detail"</span>, blog_id=2, user=<span style="font-style: italic;">"admin"</span>)
    <span style="font-weight: bold;">return</span> url

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
在 get_url_for 视图函数中使用了 url_for, 第一个参数是视图函数 blog_detail 的函数
名,因为 blog_detail 需要 blog_id 参数,因此将 blog_id 也作为参数传递给了 url_for,
而多出来的 user 参数在原本的 blog_detail 函数里是没有的,所以它不是必需的,因此构
建URL 时会把它作为查询字符串拼接到 URL 上. 访问 "/urlfor" 这个 URL 会看到结果:
"/blog/2?user=admin". 如果需要重定向,这样使用 url 不管要重定向的 URL 怎么变,只要
对应的视图函数不变,就不需要额外修改代码了.
</p>

<p>
使用 url_for 函数动态构建 URL 的优点:
</p>
<ul class="org-ul">
<li>URL 是对外的,可能会经常改变,但是视图函数不会经常变化,如果直接将 URL 硬编码,那
后期URL改变时,凡是硬编码了该 URL 的地方都要做修改,费时费力,而用 url_for 就可以
避免这点.</li>
<li>URL 在网络通信过程中,只能使用 ASCII 编码的数据,因此一些特殊字符,如中文就需要进
行编码才能放到 URL 中去,使用 url_for 函数可以自动进行编码设置,省时省力.</li>
</ul>


<blockquote>
<p>
我们平时在浏览器的地址栏可能看见过中文,但其实那都是浏览器做了额外处理显示出的中
文,假设访问一个 URL "127.0.0.1:5000/天", 输入到浏览器中访问,由于没有相关设置,所
以结果肯定是 Not Found, 但地址栏我们可以看见 "天" 这个中文,如果眼力好的可能会注
意到,我们输入会车开始访问后,网址中的 "天" 字是变成了一堆带百分号的字符然后又变成
"天" 字的,时间很短,但确实有这个过程,我们也可以按下 F12 打开浏览器开发工具,重新输
入网址,可以在开发工具的 "网络" 一栏找到我们刚刚输入的网址,可以看到在消息头中的网
址显示的是 "<a href="http://127.0.0.1:5000/%E5%9C%B0">http://127.0.0.1:5000/%E5%9C%B0</a>" 而没有天字,后面那个带百分号的字符就
是 "天" 字编码后的产物了.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org18b68c3" class="outline-2">
<h2 id="org18b68c3">Jinja2 模板</h2>
<div class="outline-text-2" id="text-org18b68c3">
<p>
前面使用的视图函数都是简单的返回了一个字符串,所以看到的页面都只有很简单的一句话,
这是为了演示用的,实际开发过程中服务器响应用户请求(浏览器访问网址就是发送了请求)
的内容通常包含大量 HTML 代码,如果这些代码也放在字符串里,那代码的编写和维护就会变
成一场噩梦,因此, Flask 将 HTML 代码的渲染交给了模板引擎来完成,而 Flask 中默认配
套的模板引擎是 Jinja2, Jinja2 是一个高效,可扩展的模板引擎.
</p>

<blockquote>
<p>
Jinja2 不是 flask 的一部分,它可以独立于 flask 使用,例如在 django 里也可以使用它
来渲染 HTML 页面.
</p>
</blockquote>

<p>
Jinja2 在作者写书的时候最新版是 3.0.2 现在最新版是 3.1.2, 官方文档: <a href="https://jinja.palletsprojects.com/en/3.1.x/">最新版本文档</a>.
</p>

<p>
运行这一章的项目使用的代码:
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org72277e6">source ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo04/
python app.py
</pre>
</div>
</div>

<div id="outline-container-orgdf98d72" class="outline-3">
<h3 id="orgdf98d72">模板的基本使用</h3>
<div class="outline-text-3" id="text-orgdf98d72">
</div>
<div id="outline-container-org7ce84c6" class="outline-4">
<h4 id="org7ce84c6">渲染模板</h4>
<div class="outline-text-4" id="text-org7ce84c6">
<p>
Flask 项目默认在 templates 文件夹里查找模板文件, Pycharm professional 在创建
Flask 项目时会自动创建该文件夹, 其他编辑环境需要手动创建.
</p>

<p>
模板文件可以是纯文本格式的任意文件,如 TXT, HTML, XML 等,但为了与前端更好协作,一
般都使用 HTML 文件来写模板代码.
</p>

<p>
首先在 templates 文件夹下面创建一个 index.html 文件,然后输入下面代码:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> &#39318;&#39029; </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> &#36825;&#26159;&#39318;&#39029; </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
在视图函数中使用 render_template 函数渲染 index.html 模板:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
render_template 默认从当前项目的 templates 文件夹下面查找 index.html 文件,读取后
进行解析,然后再渲染成 HTML 代码返回给浏览器. 访问 <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 可以看到
用一级标题显示的 "这是首页" 四个字.因为模板中这四个字是放在 h1 标签里的.这样就是
一个最简单的模板渲染.
</p>

<blockquote>
<p>
如果对前后端交互没有了解的可能会疑惑,index.html 已经是 html 代码了,为什么还说是
先进行解析,然后再渲染成 html 代码返回给浏览器呢?这是因为通常我们要在页面中填充数
据,而这些数据通常是会改变的,不可能直接硬编码到 html 代码里,所以一般需要填充数据
的 html 代码中都有用作数据填充的代码,这些数据就需要后端传递,所谓渲染就是将数据填
充到 html 中,在上面这个简单的例子中都是硬编码的数据,并没有填充数据的过程,后面会
讲解到.
</p>
</blockquote>

<p>
如果想要修改模板文件的查找地址,可以在创建 app 对象时,给 Flask 传递一个关键字参数
template_folder 来指定模板文件的查找路径,这个 template_folder 指定的路径是相对于
项目的根目录的.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>, template_folder = r<span style="font-style: italic;">"mytemplates"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
这样操作后, render_template 函数就会在当前目录的 demo04 文件夹下面的 mytemplates
文件夹里查找模板文件.
</p>

<p>
此时再次访问首页URL <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 就会出现 TemplateNotFound 的错误提示,
这是因为我们没有创建 template_folder 参数指定的 mytemplates 文件,所以是找不到模
板文件的.解决该问题只需要把 templates 文件夹下的 index.html 复制到新创建的
mytemplates 文件夹下就可以了.
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo04/mytemplates
cp ~/flask_web_py3_10/demo04/templates/index.html ~/flask_web_py3_10/demo04/mytemplates/index.html
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5ecb4d" class="outline-4">
<h4 id="orge5ecb4d">渲染变量</h4>
<div class="outline-text-4" id="text-orge5ecb4d">
<p>
上一小节提高过, HTML 文件中有数据是需要填充的,不能硬编码在 HTML 文件中. 一般做法
是,先在视图函数中将数据准备好,然后使用 render_template 函数渲染模板时将数据传递
给模板,然后 render_template 渲染并返回数据填充完整的 HTML 文件.
</p>

<p>
充当数据传递桥梁的就是变量, render_template 会将变量的数据填充到 HTML 文件中使用
变量的地方.(我的理解这个"渲染"过程就是变量做占位用,然后数据填充到相应位置)
</p>

<p>
新建一个URL 和视图函数映射:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, hobby=hobby_value)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的 variable 视图函数渲染一个 variable.html 模板,并向这个模板传递了一个 hobby
参数,表示向模板文件中一个 hobby 的变量传递数据 hobby_value.
</p>

<p>
现在我们在 templates 文件夹下面创建一个 variable.html 模板文件,输入下面代码:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#25105;&#30340;&#29233;&#22909;&#26159;: {{hobby}} </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在访问 <a href="http://127.0.0.1:5000/ariable">http://127.0.0.1:5000/ariable</a> 就可以看到 "我的爱好是游戏" 的页面内容.
html 文件中不包含 "游戏" 这两个字的数据,它是我们通过 render_template 渲染页面,使
用 hobby 变量进行传递的. 所以变量的使用可以让一个 HTML 模板(文件) 渲染出多个不同
的页面(数据不同).
</p>

<p>
模板文件数据中字典的键值和对象的属性值都可以通过 "." 点号的形式访问. 在 variable
视图函数里添加字典类型的 person 和类对象类型 user 来看模板文件如何使用这些数据:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, username, email):
        <span style="font-weight: bold;">self</span>.username=username
        <span style="font-weight: bold;">self</span>.email=email

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold; font-style: italic;">person</span> = {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#24352;&#19977;"</span>,
              <span style="font-style: italic;">"age"</span>: 18}
    <span style="font-weight: bold; font-style: italic;">user</span> = User(<span style="font-style: italic;">"&#26446;&#22235;"</span>, <span style="font-style: italic;">"lisi@qq.com"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, hobby=hobby_value, person=person, user=user)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
再在 variable.html 模板文件中通过 "." 访问 person 的键值和 user 的属性值.
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#25105;&#30340;&#29233;&#22909;&#26159;: {{hobby}} </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;person &#30340;&#22995;&#21517;&#26159;: {{person.name}}, person &#30340;&#24180;&#40836;&#26159;: {{person.age}} &lt;/<span style="font-weight: bold;">p</span>&gt;

&lt;<span style="font-weight: bold;">p</span>&gt;user &#30340;&#29992;&#25143;&#21517;&#26159;: {{user.name}},user &#30340;&#37038;&#31665;&#26159;: {{user.email}} &lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
再次访问 <a href="http://127.0.0.1:5000/ariable">http://127.0.0.1:5000/ariable</a> 可以看到如下效果:
</p>
<pre class="example">
变量使用
我的爱好是: 游戏

person 的姓名是: 张三, person 的年龄是: 18

user 的用户名是: ,user 的邮箱是: lisi@qq.com
</pre>
<p>
字典的键值和对象的属性也可以通过括号的形式获取, <code>{{user.name}}</code> 和
<code>{{user["name"]}}</code> 是等价的
</p>

<p>
虽然效果看起来都是一样的,但它们的作用原理有所不同:
</p>
<ul class="org-ul">
<li>如果模板中有一个变量的使用方式为 foo.bar, 那么 Jinja2 中按照下面规则进行访问:
<ul class="org-ul">
<li>通过 getattr(foo, 'bar') 访问,先找这个对象的属性.</li>
<li>如果没有找到,就通过 foo.__getitem__("bar") 方式访问,即访问这个对象的键值.</li>
<li>如果上面两种方式都没有找到,返回一个 undefined 对象.</li>
</ul></li>
<li>如果模板中有一个变量的使用方式为 foo["bar"], 那么在 Jinja2 中按照下面规则进行
访问:
<ul class="org-ul">
<li>通过 foo.__getitem__("bar") 访问,先访问这个对象的键值.</li>
<li>如果没有找到,就通过 getattr(foo, "bar") 方式访问,即访问这个对象的属性.</li>
<li>如果上面两种方式都没有找到,返回一个 undefined 对象.</li>
</ul></li>
</ul>


<p>
上面示例中只传递了三个变量, 算是比较少的情况,可以分开来写,但是如果变量较多,就可
以先把所有变量存放到字典中,然后在给 render_template 传递参数时使用 <code>**</code> 语法,将
字典变成关键字参数,上面的代码用这种方法改写:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, username, email):
        <span style="font-weight: bold;">self</span>.username=username
        <span style="font-weight: bold;">self</span>.email=email

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold; font-style: italic;">person</span> = {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#24352;&#19977;"</span>,
              <span style="font-style: italic;">"age"</span>: 18}
    <span style="font-weight: bold; font-style: italic;">user</span> = User(<span style="font-style: italic;">"&#26446;&#22235;"</span>, <span style="font-style: italic;">"lisi@qq.com"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"hobby"</span>: hobby_value,
              <span style="font-style: italic;">"person"</span>: person,
              <span style="font-style: italic;">"user"</span>: user}
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, **context)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
变量较多的情况都推荐使用这种方法,可以让代码变得更直观简洁,变量只有一个两个的时候
(一般很少出现这种情况吧,除非是做小测试)可以将变量全写到 render_template 参数里.
</p>
</div>
</div>
</div>

<div id="outline-container-org9f81389" class="outline-3">
<h3 id="org9f81389">过滤器和测试器</h3>
<div class="outline-text-3" id="text-org9f81389">
<p>
Python 中对变量(数据) 进行处理可以通过函数来实现,而在模板中,就要通过"过滤器"来实
现.
</p>

<p>
过滤器本质上也是函数,但是模板中的使用方式是通过管道符号(<code>|</code>) 来实现的. 例如,一个
字符串类型的变量 name, 要获取它的长度,可以通过 <code>{{name|length}}</code> 来获取, Jinja2
会把 name 当做参数传递给 length 过滤器(底层对应的函数).length 是 Jianja2 内置的
过滤器, Jinja2 内置了许多好用的过滤器,而且还可以自定义过滤器.
</p>

<blockquote>
<p>
管道的用法学过 linux 的 shell 脚本的应该不会陌生,简单理解为管道左边的作为参数传
递到管道右边.
</p>
</blockquote>
</div>

<div id="outline-container-org87a7b8c" class="outline-4">
<h4 id="org87a7b8c">自定义过滤器</h4>
<div class="outline-text-4" id="text-org87a7b8c">
<p>
过滤器本质上是 Python 的函数,它把管道符号左边的值(被过滤的值)当做第一个参数传递
给过滤器这个函数,值(数据)经过处理后,再返回新的值.
</p>

<p>
过滤器函数写好后可以通过 <code>@app.template_filter</code> 装饰器或
<code>app.add_template_filter</code> 函数来把自定义的过滤器函数注册成为 Jinja2 能用的过滤器.
</p>

<p>
一个自定义的格式化时间的过滤器为例子:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime <span style="font-weight: bold;">as</span> dt
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">datetime_format</span>(value, <span style="font-weight: bold;">format</span>=<span style="font-style: italic;">"%Y-%d-%m %H%M"</span>):
    <span style="font-weight: bold;">return</span> value.strftime(<span style="font-weight: bold;">format</span>)

app.add_template_filter(datetime_format, <span style="font-style: italic;">"dformat"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_filter</span>():
    <span style="font-weight: bold; font-style: italic;">article</span> = {<span style="font-style: italic;">"pub_date"</span>: dt.now()}
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>,article=article)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码定义了一个 datetime_format 函数,第一个参数是需要处理的值,第二个参数是时
间的格式,并指定了一个默认值. 然后用 <code>app.add_template_filter</code> 将这个函数注册成为
了过滤器,且这个过滤器的名字叫做 dformat, 然后在模板文件里,就可以使用这个过滤器
dformat 了,而如果 add_template_filter 没有第二个参数,那过滤器名就默认是函数名了.当
然也可以使用 <code>@app.template_filter(datetime_format)</code> 装饰器来注册过滤器,这个代码
也是注册 datetime_format 作为过滤器,过滤器名默认为 datetime_format 这个函数名.
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#33258;&#23450;&#20041;&#36807;&#28388;&#22120;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#33258;&#23450;&#20041;&#36807;&#28388;&#22120;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
{{article.pub_date|dformat}}
{{article.pub_date|dformat("<span style="font-weight: bold; font-style: italic;">%B</span> <span style="font-weight: bold; font-style: italic;">%Y</span>")}}

  &lt;<span style="font-weight: bold;">div</span>&gt;default &#36807;&#28388;&#22120;: {{ ""|default('admin', boolean=True)}}&lt;/<span style="font-weight: bold;">div</span>&gt;

&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org8040532" class="outline-4">
<h4 id="org8040532">Jinja2 内置过滤器</h4>
<div class="outline-text-4" id="text-org8040532">
<p>
了解了 Jinja2 过滤器原理之后,再学习和使用 Jinja2 内置的过滤器就容易理解了.
Jinja2 内置了许多过滤器,不需要全部记住(用多了自然就记住了),只需要在使用的时候翻
阅文档即可. Jinja2 官方文档: <a href="https://jinja.palletsprojects.com/en/3.1.x/templates/#list-of-builtin-filters">List of Builtin filters</a> . 作者写书时 Jinja2 还是
3.0.x 版本,现在最新到了 3.1.x 了.
</p>

<p>
Jinja2 内置过滤器:
</p>
<dl class="org-dl">
<dt>abs(value)</dt><dd>获取 value 的绝对值</dd>
<dt>default(value, default_value, boolean=False)</dt><dd><p>
如果 value 没有定义,则返回第二
个参数 default_value. 如果要让 value 在判断为 False 的情况下使用
default_value, 就将 boolean 参数设置为 True:
</p>
<pre class="example">
&lt;div&gt;default 过滤器: {{ user|default('admin')}}&lt;/div&gt;
</pre>
<p>
如果 user 没有定义,那么将会使用 admin 作为默认的值.
</p>
<pre class="example">
&lt;div&gt;default 过滤器: {{ ""|default('admin', boolean=False)}}&lt;/div&gt;
</pre>
<p>
因为 "" (空字符串) 在使用 if 时会判断返回 False,所以这时如果想要使用默认值
admin 就必需加上 boolean=True, 表示会对 value 进行 if 判断.
</p></dd>
<dt>escape(value)</dt><dd>将一些特殊字符进行转移,如 <code>&amp;,&lt;,&gt;,",'</code>. 因为 Jinja2 默认开启了
全局转义,所以大部分情况下无需手动使用这个过滤器进行转义,只有关闭了全局转义的情
况下,才会需要使用到它.</dd>
<dt>filesizeformat(value,binary=False)</dt><dd>将值格式化为方便阅读的单位.例如 13KB,
4.1MB, 102Bytes 等等. 默认的单位是 Mega, Giga, 即相邻单位换算是1:1000. 如果
binary 设置为 True, 则使用二进制的换算,相邻单位换算是 1:1024.</dd>
<dt>first(value)</dt><dd>返回 value 序列的第一格元素.</dd>
<dt>float(value,default=0.0)</dt><dd>将 value 转换成浮点类型,如果转换失败会返回 0.0 .</dd>
<dt>format(value,*args,**kwargs)</dt><dd><p>
格式化字符串,示例代码如下
</p>
<pre class="example">
{{ "%s,%s"|format(greeting, name) }}
</pre></dd>
<dt>groupby(value, attribute, default=None)</dt><dd><p>
value 是一个序列,可以使用参数
attribute 进行分组. 例如,如果有一个 users 列表,里面每个 user 都有一个属性
city, 要将 user 按照 city 分组,可以用下面代码实现:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;

  &lt;<span style="font-weight: bold;">ul</span>&gt;
    {% for group in users|groupby("city") %}
    &lt;<span style="font-weight: bold;">li</span>&gt;{{ group.grouper}}: {{ group.list|join(", ")}}&lt;/<span style="font-weight: bold;">li</span>&gt;
    {% endfor %}
  &lt;/<span style="font-weight: bold;">ul</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
这些 <code>%</code>,for, in 之类的就是模板里使用语句块的语法,不同的模板引擎语法可能会有不
同,但大体上应该都差不多. Jinja2 是 Python 的模板引擎,所以上面的用法也和 python
语法有点像.
</p></dd>
<dt>int(value,default=0,base=10)</dt><dd>转换成整型,如果转换失败会返回0,默认按照10进制
转换.</dd>
<dt>join(value,attribute)</dt><dd>使用 attribute 指定的元素,将一个序列拼接成一个字符串.和
Python 中的 join 方法类似.</dd>
<dt>last(value)</dt><dd>返回 value 序列的最后一个元素.</dd>
<dt>length(value)</dt><dd>返回 value 序列的长度.</dd>
<dt>list(value)</dt><dd>转换 value 为一个列表.</dd>
<dt>lower(value)</dt><dd><p>
转换 value 为全部小写.如果要将 titles 序列中每个元素都转换为全
部小写:
</p>
<pre class="example">
{{ titles|map('lower') }}
</pre></dd>
<dt>map(value, *args, **kwargs)</dt><dd><p>
将 value 这个序列都执行某个操作,如获取 users 这
个序列中每个 user 的 username 字段:
</p>
<pre class="example">
{{ users|map(attribute="username") }}
</pre></dd>
<dt>max(value)</dt><dd>求序列中的最大值</dd>
<dt>min(value)</dt><dd>求序列中的最小值</dd>
<dt>random(value)</dt><dd>返回 value 中的一个随机值</dd>
<dt>reject(value, *args, **kwargs)</dt><dd><p>
过滤 value 序列中的一些值,过滤的条件通过后面
的参数给定,例如要过滤所有的奇数,可以把内置的 odd 过滤器传给 reject 作为参数来
实现:
</p>
<pre class="example">
{{ numbers|reject('odd') }}
</pre></dd>
<dt>rejectattr( value,*args,**kwargs)</dt><dd><p>
根据序列中元素的某个属性进行过滤. 只要属
性满足条件,就会被过滤掉:
</p>
<pre class="example">
{{ user|rejectattr("is_active") }}
{{ user|rejectattr("email", "none") }}
</pre>
<p>
第一行代码过滤了 is_active 为 True 的对象,第二行代码过滤了 email 为 none 的对
象.
</p></dd>
<dt>replace( value,old,new,count)</dt><dd>将 value 中的 old 用 new 来替换,如果给定了
count, 则限制替换的次数.用法和 python 的 replace 一致.</dd>
<dt>reverse( value)</dt><dd>将 value 这个序列逆序.</dd>
<dt>safe( value)</dt><dd><p>
渲染 value 时,关闭自动转义.
</p>
<pre class="example">
&lt;div&gt;safe 过滤器: {{ "&lt;p style='background-color:red;'&gt;China&lt;/p&gt;"|safe }}
</pre>
<p>
Jinja2 默认的全局转义会让上例中的所有特殊字符按照原义显示在页面中,就不会产生
HTML 的渲染效果了,所以需要让 safe 关闭它们的自动转义.
</p></dd>
<dt>select( value,*args,**kwargs)</dt><dd>根据 value 序列中元素的某个属性进行过滤,留下
满足条件的,与 rejectattr 正好相反.</dd>
<dt>sort( value, reverse=False, case_sensitive= False, attribute=None)</dt><dd>将 value
序列进行排序,底层用的是 python 的 sorted 函数, reverse 代表是否逆向排序,
case_sensitive 代表是否忽略大小写, attribute 代表根据序列中某元素的某个属性排
序.</dd>
<dt>string( value)</dt><dd>将 value 转换成字符串类型.</dd>
<dt>striptags( value)</dt><dd>将字符串 value 中的 HTML 标签去除, 留下文本内容.</dd>
<dt>tojson( value)</dt><dd>将 value 转换成 JSON 格式的字符串</dd>
<dt>trim( value)</dt><dd>删除 value 前面和后面的空白字符</dd>
<dt>truncate( value, length=255, killwords=False, end="&#x2026;")</dt><dd>将字符串 value 进
行截取, length 代表保留多少字符, killwords 代表在截取字符串时是否要裁减单词,
end 表示末尾的结束字符.在文章简介,个人简介等只需要显示一部分字符的场景下非常有
用.</dd>
<dt>unique( vaule, case_sensitive=False, attribute=None)</dt><dd>将 value 序列中的重复
元素删除. case_sensitive 表示是否忽略大小写,attribute 代表使用 value 序列中某
个元素的某个属性来判断是否重复.</dd>
<dt>upper( value)</dt><dd>将 value 的所有字符全部大写.</dd>
<dt>urlencode( value)</dt><dd>如果 value 是字符串,底层调用 Python 的
urllib.parse.quote;如果 value 是字段,底层调用 Python 的
url.lib.parse.urlencode.</dd>
<dt>(no term)</dt><dd>urlize( value, trim_url_limit=None, nofollow=False, target=None, rel=None,
extra_schemes=None :: 将 value 变成可以单击的链接,如 url 和邮箱,注意: value 必
需是以 <a href="http://">http://</a>, <a href="https://">https://</a> , www. , mailto 开头的字符串.</dd>
<dt>wordcount( value)</dt><dd>统计 value 中有多少个单词.</dd>
<dt>xmlattr( value,autospace=True)</dt><dd><p>
value 为一个字典,根据这个字典创建一个 xml
格式的属性,示例代码:
</p>
<pre class="example">
&lt;ul {{ {'class': 'my_list', 'missing': none,
	'id': 'list-%d'|format(variable)}|xmlattr}}&gt;
	...
&lt;/ul&gt;
</pre></dd>
</dl>


<p>
过滤器可以嵌套使用,上面的示例里都展示过了:
</p>
<pre class="example">
{{ titles|map("lower")|join(",") }}
</pre>
<p>
titles 传递给 map, map 对 titles 应用 lower 过滤器(函数), 并返回结果值,map 过滤
器返回的结果值又作为参数传递给 join.
</p>
</div>
</div>

<div id="outline-container-org6a15173" class="outline-4">
<h4 id="org6a15173">测试器</h4>
<div class="outline-text-4" id="text-org6a15173">
<p>
测试器是用来判断某些元素是否满足某个条件的.和过滤器一样,也是一种函数,不过它的使
用与管道和普通 python 函数调用又不一样:
</p>
<pre class="example">
{% if user is defined %}
   user 定义了 : {{ user }}
{% else %}
   user 没有定义
{% endif %}
</pre>

<p>
测试器是通过 <code>if VAR is TEST</code> 来使用的, 上面代码里使用了 defined 测试器. 和过滤
器一样, Jinja2 也提供了许多内置的测试器: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#builtin-tests">Jinja2 builtin tests</a>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> 测试器(官网最新版的测试器,可能与书中有差别)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">测试器</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">boolean()</td>
<td class="org-left">是否为布尔类型</td>
</tr>

<tr>
<td class="org-left">callable()</td>
<td class="org-left">是否能被调用</td>
</tr>

<tr>
<td class="org-left">defined()</td>
<td class="org-left">是否定义了</td>
</tr>

<tr>
<td class="org-left">divisibleby()</td>
<td class="org-left">是否能被某个数整除</td>
</tr>

<tr>
<td class="org-left">eq()</td>
<td class="org-left">是否与另一个值相等</td>
</tr>

<tr>
<td class="org-left">escaped()</td>
<td class="org-left">是否已经被转义了</td>
</tr>

<tr>
<td class="org-left">even()</td>
<td class="org-left">是否为偶数</td>
</tr>

<tr>
<td class="org-left">false()</td>
<td class="org-left">是否为 False</td>
</tr>

<tr>
<td class="org-left">filter()</td>
<td class="org-left">是否为过滤器</td>
</tr>

<tr>
<td class="org-left">float()</td>
<td class="org-left">是否为浮点数</td>
</tr>

<tr>
<td class="org-left">ge()</td>
<td class="org-left">是否大于或等于某个数</td>
</tr>

<tr>
<td class="org-left">gt()</td>
<td class="org-left">是否大于某个数</td>
</tr>

<tr>
<td class="org-left">in()</td>
<td class="org-left">是否在某个序列中</td>
</tr>

<tr>
<td class="org-left">integer()</td>
<td class="org-left">是否为整数</td>
</tr>

<tr>
<td class="org-left">iterable()</td>
<td class="org-left">是否为可迭代类型</td>
</tr>

<tr>
<td class="org-left">le()</td>
<td class="org-left">是否小于或等于某个数</td>
</tr>

<tr>
<td class="org-left">lower()</td>
<td class="org-left">是否全部为小写</td>
</tr>

<tr>
<td class="org-left">lt()</td>
<td class="org-left">是否小于某个数</td>
</tr>

<tr>
<td class="org-left">mapping()</td>
<td class="org-left">是否为一个 mapping 对象(例如字典)</td>
</tr>

<tr>
<td class="org-left">ne()</td>
<td class="org-left">是否不等于某个数</td>
</tr>

<tr>
<td class="org-left">none()</td>
<td class="org-left">是否为 None</td>
</tr>

<tr>
<td class="org-left">number()</td>
<td class="org-left">是否为数值类型</td>
</tr>

<tr>
<td class="org-left">odd()</td>
<td class="org-left">是否为奇数</td>
</tr>

<tr>
<td class="org-left">sameas()</td>
<td class="org-left">是否在内存中和另一个对象是一样的</td>
</tr>

<tr>
<td class="org-left">sequence()</td>
<td class="org-left">是否为序列(如元组,列表)</td>
</tr>

<tr>
<td class="org-left">string()</td>
<td class="org-left">是否为字符串</td>
</tr>

<tr>
<td class="org-left">test()</td>
<td class="org-left">是否为一个测试器</td>
</tr>

<tr>
<td class="org-left">true()</td>
<td class="org-left">是否为 True</td>
</tr>

<tr>
<td class="org-left">undefined()</td>
<td class="org-left">是否没有定义</td>
</tr>

<tr>
<td class="org-left">upper()</td>
<td class="org-left">是否全部为大写</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org33ecbf6" class="outline-3">
<h3 id="org33ecbf6">控制语句</h3>
<div class="outline-text-3" id="text-org33ecbf6">
<p>
Jinja2 模板中也是有 if 判断和for 循环等控制语句的,前面代码示例里用过但没有具体解
释.
</p>

<p>
所有的控制语句都是放在 <code>{%%}</code> 中间的,并且在结束控制语句时要加入相应的结束语句.
</p>
</div>

<div id="outline-container-org006e4c2" class="outline-4">
<h4 id="org006e4c2">if 判断语句</h4>
<div class="outline-text-4" id="text-org006e4c2">
<p>
Jinja2 的 if 判断语句和 Python 中的 if 判断语句非常类似,可以使用关系运算符
<code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>==</code>, <code>!=</code> 来进行判断,也可以通过 and , or, not 来进行逻辑
操作.
</p>

<p>
用一个视图函数来测试下测试器的用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面的代码定义了一个  age 变量,并传递给 if.html 模板:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">if &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  {% if age &gt; 18 %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#25104;&#24180;&#20154; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% elif age &lt; 18 %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#26410;&#25104;&#24180; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#21018;&#22909;&#25104;&#24180; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% endif %}
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
浏览器访问 <a href="http://127.0.0.1:5000/if">http://127.0.0.1:5000/if</a> 会看到"刚好成年" 的内容,因为传递的 age 值为
</p>
<ol class="org-ol">
<li></li>
</ol>


<blockquote>
<p>
Jinja2 中的代码缩进只是为了方便阅读,与 Python 的缩进是语法的一部分不同.
因此 Jinja2 的控制语句需要添加结束语句来表示语句的结束.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org9cf0b92" class="outline-4">
<h4 id="org9cf0b92">for 循环语句</h4>
<div class="outline-text-4" id="text-org9cf0b92">
<p>
Jinja2 中的 for 循环与 Python 的 for 循环也非常类似,也只多一个 endfor 语句表示语
句结束:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
    <span style="font-weight: bold; font-style: italic;">books</span> = [{<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#19977;&#22269;&#28436;&#20041;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#32599;&#36143;&#20013;"</span>,
              <span style="font-style: italic;">"price"</span>: 100},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#27700;&#27986;&#20256;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26045;&#32784;&#24245;"</span>,
              <span style="font-style: italic;">"price"</span>: 99},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#32418;&#27004;&#26790;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26361;&#38634;&#33465;"</span>,
              <span style="font-style: italic;">"price"</span>: 101},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#35199;&#28216;&#35760;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#21556;&#25215;&#24681;"</span>,
              <span style="font-style: italic;">"price"</span>: 102}
             ]
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码新定义了一个 for_statement 视图函数,传递了一个 books 列表变量到 for.html
模板,列表里存放的是图书信息的字典.下面在模板文件中循环这个列表:
</p>


<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
因为 table 表格标签中, 一个 tr 标签代表表格中的一行,所以 tr 外面加 for 循环,来循
环 books 列表, 一个td 表示一列,每列从 book 中获取相应数据. 页面结果应该是下面这
样:
</p>
<pre class="example">
BookName Author Price
三国演义 罗贯中 100
水浒传 	施耐庵 	99
红楼梦 	曹雪芹 	101
西游记 	吴承恩 	102
</pre>

<p>
如果被循环的序列(例如上面的 books)中没有元素,则可以使用 else 来处理.这点和
Python 的 for 和 else 一起的用法有所不同,我们可以用它来处理没有数据传递的情况:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
在 books 中没有数据的情况下,就会执行 else, 可以将 for_statement 视图函数的 books
修改成一个空的列表,再看看效果:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">books = [{"name": "&#19977;&#22269;&#28436;&#20041;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#32599;&#36143;&#20013;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 100},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#27700;&#27986;&#20256;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#26045;&#32784;&#24245;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 99},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#32418;&#27004;&#26790;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#26361;&#38634;&#33465;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 101},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#35199;&#28216;&#35760;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#21556;&#25215;&#24681;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 102}</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">]</span>
    <span style="font-weight: bold; font-style: italic;">books</span> = []
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
再次访问 <a href="http://127.0.0.1:5000/for">http://127.0.0.1:5000/for</a> 可以看到下面结果:
</p>
<pre class="example">
BookName Author Price
No data
</pre>

<p>
Jinja2 的 for 循环里还内置了许多好用的变量. 例如,可以用 loop.index 来实现获取当
前循环到了第几次:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
    <span style="font-weight: bold; font-style: italic;">books</span> = [{<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#19977;&#22269;&#28436;&#20041;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#32599;&#36143;&#20013;"</span>,
              <span style="font-style: italic;">"price"</span>: 100},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#27700;&#27986;&#20256;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26045;&#32784;&#24245;"</span>,
              <span style="font-style: italic;">"price"</span>: 99},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#32418;&#27004;&#26790;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26361;&#38634;&#33465;"</span>,
              <span style="font-style: italic;">"price"</span>: 101},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#35199;&#28216;&#35760;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#21556;&#25215;&#24681;"</span>,
              <span style="font-style: italic;">"price"</span>: 102}
             ]
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后在 for.html 模板中给图书增加一个名为序号的列,用 loop.index 显示每行的序号:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
然后可以看到页面效果:
</p>
<pre class="example">
Index 	BookName 	Author 	Price
1 	三国演义 	罗贯中 	100
2 	水浒传 	施耐庵 	99
3 	红楼梦 	曹雪芹 	101
4 	西游记 	吴承恩 	102
</pre>

<p>
除了 loop.index 之外, Jinja2 的 for 循环还提供了下面这些变量: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#for">jinja2 for loop</a>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> for 循环中的变量</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">变量</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">loop.index</td>
<td class="org-left">当前迭代的序号,从1开始</td>
</tr>

<tr>
<td class="org-left">loop.index0</td>
<td class="org-left">当前迭代的序号,从0开始</td>
</tr>

<tr>
<td class="org-left">loop.revindex</td>
<td class="org-left">当前迭代的逆向序号,最后一个为1,倒数第二为2,依此类推</td>
</tr>

<tr>
<td class="org-left">loop.revindex0</td>
<td class="org-left">当前迭代的逆向序号,最后一个为0,倒数第二为1,依此类推</td>
</tr>

<tr>
<td class="org-left">loop.first</td>
<td class="org-left">判断当前是否为第一次迭代</td>
</tr>

<tr>
<td class="org-left">loop.last</td>
<td class="org-left">判断当前是否为最后一次迭代</td>
</tr>

<tr>
<td class="org-left">loop.length</td>
<td class="org-left">序列的长度</td>
</tr>

<tr>
<td class="org-left">loop.cycle</td>
<td class="org-left">和外层的循环一起循环某个序列</td>
</tr>

<tr>
<td class="org-left">loop.depth</td>
<td class="org-left">在多层循环中,指示当前是第几层循环,从1开始</td>
</tr>

<tr>
<td class="org-left">loop.depth0</td>
<td class="org-left">多层循环中,指示当前是第几层循环,从0开始</td>
</tr>

<tr>
<td class="org-left">loop.previtem</td>
<td class="org-left">当前迭代的上一个元素,如果当前是第一次迭代,变量会返回 undefined 对象</td>
</tr>

<tr>
<td class="org-left">loop.nextitem</td>
<td class="org-left">当前迭代的下一个元素,如果当前是最后一次迭代,变量会返回 undefined 对象</td>
</tr>

<tr>
<td class="org-left">loop.changed</td>
<td class="org-left">判断当前元素的某个值是否和上一次迭代一样,如果不一样,返回 True, 否则返回 False</td>
</tr>
</tbody>
</table>

<p>
上面只有 cycle 和 changed 是函数,其余全是变量.
</p>
<ul class="org-ul">
<li><p>
loop.cycle: 假设需要对 table 标签中的行号为奇数的 tr 标签添加 odd 类,行数为偶
数的 tr 标签添加 even 类:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"{{ loop.cycle('odd', 'even') }}"</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
在循环 books 过程中, loop.cycle 也会不断在 odd 和 even 两个变量中循环,从而实现
奇数使用 odd 类,偶数使用 even 类.
</p></li>
<li><p>
loop.changed: 假设想要知道当前循环的 book.name 是否和上一次循环的一致,可以通过
loop.changed 实现:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName Changed?&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"{{ loop.cycle('odd', 'even') }}"</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.changed(book.name)}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div></li>
</ul>


<p>
Jinja2 模板的 for 循环不存在 break 和 continue 来中断循环,这是和 Python 中的 for
循环最大的区别,另外 Jinja2 中只有 for 循环,没有 while 循环.
</p>
</div>
</div>
</div>

<div id="outline-container-org6500f55" class="outline-3">
<h3 id="org6500f55">模板结构</h3>
<div class="outline-text-3" id="text-org6500f55">
<p>
Jinja2 比传统的 HTML 有更强大的功能,其中一个就是代码模块化.
</p>

<p>
HTML 除了通过 iframe 标签在浏览器端动态加载其他网页外,它自身几乎不具备任何代码木
块化的能力. 而 Jinja2 可以通过宏,模板继承,引入模板等方式实现代码模块化.
</p>
</div>

<div id="outline-container-org052a421" class="outline-4">
<h4 id="org052a421">宏和 import 语句</h4>
<div class="outline-text-4" id="text-org052a421">
<p>
模板中的 "宏" 与函数类似,可以传递参数,但没有返回值.
</p>

<p>
常用的代码片段可以放在宏中,然后把一些不规定的值抽取出来当做参数:
</p>
<pre class="example">
{% macro input(name, value='', type='text')%}
&lt;input type="{{ type }}" value="{{ value|escape }}" name="{{ name }}"&gt;
{% endmacro %}
</pre>
<p>
上面代码创建了一个叫做 input 的宏,接收三个参数,第一个是作为 input 的 name 属性,
第二个作为 input 的 value 属性值,第三个作为 type 属性值,其中第一个参数是必需给定
的,剩下两个都有默认值.给定参数的方法也和 python 的位置参数和关键字参数用法一致.
</p>

<p>
定义了input宏之后,我们就可以使用它来快速创建 input 标签了:
</p>
<pre class="example">
&lt;div&gt;{{ input('username') }}&lt;/div&gt;

&lt;div&gt;{{ input('password', type='password', value='pwd') }}&lt;/div&gt;
</pre>
<p>
创建一个新的模板文件来试试效果:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;

{% macro input(name, <span style="font-weight: bold; font-style: italic;">value</span>='', <span style="font-weight: bold; font-style: italic;">type</span>='text')%}
&lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"{{ type }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ value|escape }}"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span>&gt;
{% endmacro %}

&lt;<span style="font-weight: bold;">div</span>&gt;{{ input('username') }}&lt;/<span style="font-weight: bold;">div</span>&gt;

&lt;<span style="font-weight: bold;">div</span>&gt;{{ input('password', <span style="font-weight: bold; font-style: italic;">type</span>='password', <span style="font-weight: bold; font-style: italic;">value</span>='pwd') }}&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
创建视图函数让它渲染这个模板文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/macro"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">macro</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"macro.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
运行后访问 <a href="http://127.0.0.1:5000/macro">http://127.0.0.1:5000/macro</a> 可以看到出现了两个输入框,一个用于输入用户
名,一个用于输入密码,使用这样的宏可以很方便创建需要的代码块,这里我们只是将一个
input 标签制作成了宏,如果可以确定网页中会有多个相同结构的代码,我们可以将更多的代
码制作成宏,这就和函数概念有点像了. 宏对于网页中统一风格/UI 的地方很有效,比如网页
首部的导航栏,底部的信息栏,使用宏就只需要将大量相同的代码编写一次,需要时再调用就
可以了.
</p>

<p>
实际开发过程中,经常是将一些常用的宏单独放到一个文件里,需要时再从文件进行导入.导
入使用的时 import 语句,Jinja2 的import 与 Python 的import 也类似,形式可以直接是
<code>import ... as ...</code>, 也可以是 <code>from ... import ...</code> 或者是 <code>from ... import
... as ...</code>
</p>

<p>
下面用实际例子做演示:
先创建一个 forms.html 存放定义的宏:
</p>


<div class="org-src-container">
<pre class="src src-html">{% macro input(name, <span style="font-weight: bold; font-style: italic;">value</span>='', <span style="font-weight: bold; font-style: italic;">type</span>='text') %}
&lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"{{ type }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ value }}"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span>&gt;
{% endmacro %}


{% macro textarea(name, value= '', rows=10, cols=40) %}
&lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"{{ rows }}"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"{{ cols }}"</span>&gt;{{ value|escape }}&lt;/<span style="font-weight: bold;">textarea</span>&gt;
{% endmacro %}
</pre>
</div>
<p>
现在, form.html 中定义了两个宏, input 和 textarea, 下面再在另一个文件中用 import
语句导入即可使用它们:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% import 'forms.html' as forms %}
&lt;<span style="font-weight: bold;">dl</span>&gt;
  &lt;<span style="font-weight: bold;">dt</span>&gt;Username&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ forms.input('username') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;

  &lt;<span style="font-weight: bold;">dt</span>&gt;Password&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ forms.input('password', <span style="font-weight: bold; font-style: italic;">type</span>='password') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;
&lt;/<span style="font-weight: bold;">dl</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ forms.textarea(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在再次访问 <a href="http://127.0.0.1:5000/macro">http://127.0.0.1:5000/macro</a> 可以看到两个输入框和一个文本框.
</p>

<p>
也可以通过 from &#x2026; import &#x2026; as &#x2026; 或 from &#x2026; import &#x2026; 形式导入:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% from 'forms.html' import input as input_field, textarea as ta%}
&lt;<span style="font-weight: bold;">dl</span>&gt;
  &lt;<span style="font-weight: bold;">dt</span>&gt;Username&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ input_field('username') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;

  &lt;<span style="font-weight: bold;">dt</span>&gt;Password&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ input_field('password', <span style="font-weight: bold; font-style: italic;">type</span>='password') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;
&lt;/<span style="font-weight: bold;">dl</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ ta(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
另外,需要注意的是,通过 import 导入的模板不会把当前模板中的变量添加到被导入的模板
中,如果要在被导入的模板中使用当前模板的变量,可以通过以下两种方式:
</p>
<ul class="org-ul">
<li>显示地通过参数形式传递(就是将当前模板中的变量作为参数传递到宏调用里)</li>
<li><p>
使用 with context 方式:
</p>
<pre class="example">
{% form 'forms.html' import input with contex %}
</pre></li>
</ul>


<p>
以上面的 textarea 宏为例子,传递参数给其 value 变量可以让我们在页面的文本框中看到
value 的值:
视图函数传递变量 value:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/macro"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">macro</span>():
    <span style="font-weight: bold; font-style: italic;">values</span> = <span style="font-style: italic;">"this is some text."</span>
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"macro.html"</span>, value= values)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
用参数形式形式显示传递:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% from 'forms.html' import input as input_field, textarea as ta with context%}
&lt;<span style="font-weight: bold;">p</span>&gt;{{ ta(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
用参数形式很好理解,就类似函数传参吧,但用 context 的例子我暂时想不到用法,可能会是
对于一个全局变量,然后 import 的模板加上 with context 了,模板里的宏就可以访问这个
全局变量了? 这个没搞清楚用法用例,不过查找的资料说 context 其实就是
render_template 传递给模板的所以数据的 "集合", 不能直接作为变量使用的,应该理解为
是一个概念性的对象吧,所有传递到模板的变量都在 context 里. with context 就相当于
把当前模板的所有变量都传递到要导入的这个 forms.html 模板中了,那么在 forms.html
这个模板文件中就可以"提前"(因为要先导入它才使用它)使用传递给模板的变量(尽管没有
变量传递给 forms.html, 但仍然可以将变量提前在代码里使用)
</p>
</div>
</div>

<div id="outline-container-org9338c37" class="outline-4">
<h4 id="org9338c37">模板继承</h4>
<div class="outline-text-4" id="text-org9338c37">
<p>
网站中大部分网页的模块是重复的,例如顶部导航栏,底部备案信息. 如果每个页面都重复写
这些代码,就会让项目臃肿,且后期不易维护. 比较好的做法是,通过模板继承,把重复性的代
码写在父模板中,子模板继承父模板后,再分别实现自己页面的代码.
</p>

<p>
先看一个父模板 base.html:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"base.css"</span>/&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> {% block title %}{% endblock %} </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
    {% block head %}{% endblock %}
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"body"</span>&gt;
      {% block body %}
      {% endblock %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"footer"</span>&gt;
      {% block footer %}
      <span style="font-weight: bold; font-style: italic;">&amp;copy;</span>Copyright 2008 by &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"http://domain.invalid/"</span>&gt;you&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endblock %}&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
这个父模板编写了网页的整体结构,还提前引用了所有模板都要用到的样式文件 base.css.
将子模板需要重写的地方都定义成了 <b>block</b> 结构,如 title, head, body, footer, 子模
板继承父模板之后,重写对应的 block 的代码,就可以完成子模板的渲染.
下面就用继承 base.html 的方式来实现一个 index.html:
</p>


<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">style</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/css"</span>&gt;
  .detail{color:red;}
&lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#36825;&#26159;&#39318;&#39029;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>

<p>
子模板通过 extends 语法加载父模板,因为 base.html 和 index.html 都放在 templates
文件夹下,所以直接写文件名即可,需要注意的是, extends 必需放在子模板所有代码的前面.
然后三个代码块分别重写(实现)了title,head 和 body 三个代码块,这三个代码块会填充到
父模板的对应三个代码块的位置,并最终生成一个有完整HTML 结构的 index.html 文件.
</p>

<p>
模板中不能出现重名的 block, 如果一个地方需要使用另一个 block 里的内容,可以用
self.blockname 来引用:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ self.title() }}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>
<p>
上面代码中,h1 标签的内容是通过 {{ self.title() }} 将 block title 里的内容引用到
h1 里的.
如果子模板要继承父模板的某个 block 的内容,可以使用 super() 来实现,比如要继承父模
板的 footer 这个 block 的已有内容:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ self.title() }}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}

{% block footer %}
{{ super() }}
&lt;<span style="font-weight: bold;">p</span>&gt; &#21097;&#19979;&#37096;&#20998;&#26159;&#23376;&#27169;&#26495;&#33258;&#24049;&#30340;&#20869;&#23481;&#20102; &lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>

<p>
上面代码中,如果没有使用 {{ super() }} 那么子模板是不会继承父模板 footer 的内容的,不
过删除上面代码的 block footer 块就会原封不动的继承父模板的 footer 块了,这与面向
对象编程思想中的继承是一致的.不做修改就会自然继承,做了修改且仍想使用父模板的代码
就要使用 super.
</p>
</div>
</div>

<div id="outline-container-org4473400" class="outline-4">
<h4 id="org4473400">引入模板</h4>
<div class="outline-text-4" id="text-org4473400">
<p>
有些HTML 的模块需要在交给页面中使用,如果使用模板继承,就会在所有子模板中都加载,所
以不合适;如果每个需要该模块的页面中添加相通的代码,又会导致维护成本增加,此时就可
以使用 "include" 引用(引入) 模板. 例如网站的二维码联系方式,有的页面需要,但并不是
所有的页面都需要,所以可以把相关代码写到一个 _contact.html 里,然后在需要的地方
进行引用:
</p>
<pre class="example">
{% include "_contact.html" %}
</pre>
<p>
因为 _contact.html 是作为被引用的模板存在的,为了以示区分,一般在命名上会在前面加
上一个下划线,表示它专门作为被引用的模板,不是普通模板文件.
</p>

<blockquote>
<p>
这一部分的模板结构有宏,模板继承和模板的引入,模板继承可以让所有页面都需要的 HTML
代码只编写一次就可以多次使用,比如那些用作网页结构的 HTML 标签,使用继承就可以不用
每次都写上 html,head 等标签了; 宏的使用可以简化常用的代码片段;模板的引入可以减少
重复代码的编写.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orgdc681a0" class="outline-3">
<h3 id="orgdc681a0">模板环境</h3>
<div class="outline-text-3" id="text-orgdc681a0">
</div>
<div id="outline-container-org579884d" class="outline-4">
<h4 id="org579884d">模板上下文(context?)</h4>
<div class="outline-text-4" id="text-org579884d">
<p>
通过 render_template 传入的变量,实际上是保存到了模板的上下文中, Jinja2 也有一些
内置的上下文变量,可以通过 app.context_processor 来添加全局上下文.所以简单理解为
上下文是模板中可以直接使用的变量.
</p>
<blockquote>
<p>
这里的全局上下文可能就是前面的 import 宏加上 "with context" 的 context,
app.context_processor 添加的全局上下文应该就是通过 "with context" 被宏使用的.
</p>
</blockquote>
</div>

<ul class="org-ul">
<li><a id="orgdd48c72"></a>自定义变量<br />
<div class="outline-text-5" id="text-orgdd48c72">
<p>
变量除了通过 render_template 传递外,还可以在模板中通过 set 语法定义新的变量:
</p>
<pre class="example">
{% set name='admin' %}
</pre>
<p>
使用 set 赋值语句创建的变量在它后面的代码都是有效的.如果不想让变量污染全局环境,
可以用 with 语句创建一个内部作用域,将 set 语句放到其中,这样 set 创建的变量就只在
这个 with 语句代码块中有效:
</p>
<pre class="example">
{% with %}
{% set foo = 42 %}
{{ foo }}
{% endwith %}
</pre>
<p>
with 语句也有简写形式:
</p>
<pre class="example">
{% with foo = 42 %}
{{ foo }}
{% endwith %}
</pre>

<blockquote>
<p>
之前的宏导入使用变量的两种方法的地方我还疑惑能不能在模板中定义变量,这里不就是了.
</p>
</blockquote>
</div>
</li>

<li><a id="orgb072f15"></a>Jinja2 内置全局上下文变量<br />
<div class="outline-text-5" id="text-orgb072f15">
<p>
Jinja2 内置了一些常用的全局上下文变量:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Jinja2 内置全局上下文变量</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">变量</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">g</td>
<td class="org-left">当前请求中的全局变量.一般会把当前请求中多个地方需要用到的变量绑定</td>
</tr>

<tr>
<td class="org-left">request</td>
<td class="org-left">当前请求对象,通过它可以获得请求的信息</td>
</tr>

<tr>
<td class="org-left">session</td>
<td class="org-left">当前请求的 session 对象</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">项目的配置对象(flask.config)</td>
</tr>
</tbody>
</table>
<p>
上面的上下文变量可以在左右模板中直接使用,不需要额外传递参数.
</p>
</div>
</li>

<li><a id="org690dc9b"></a>上下文处理器(context processor)<br />
<div class="outline-text-5" id="text-org690dc9b">
<p>
Jinja2 虽然内置了一些上下文变量,但是有时我们需要传递自定义的变量,例如网站当前登
录的用户名,几乎所有模板都会用到这个数据,因此需要把 user 变量传递到几乎所有模板中,如
果使用 render_template ,就需要在所有调用它的地方带上 user 参数,会非常麻烦.我们可
以使用上下文处理器这个装饰器函数 <code>@app.context_processor</code> 来将变量绑定到上下文
(context):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">context_user</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = {<span style="font-style: italic;">"username"</span>: <span style="font-style: italic;">"admin"</span>,
            <span style="font-style: italic;">"level"</span>: 2}
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"user"</span>: user}
</pre>
</div>
<p>
自定义的上下文处理器函数中,要把变量放到字典才能被模板使用(应该是由于 Web 开发传
递数据多用 JSON 格式的原因吧).另外,在上下文的变量中,除了 Jinja2 内置的全局上下文
变量外,其余的上下文变量是不能被 import 导入的模板使用的,如果需要使用,就要用 with
context 语法(详见 <a href="#org052a421">宏和 import 语句</a>).
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgfb4bcdc" class="outline-4">
<h4 id="orgfb4bcdc">全局函数</h4>
<div class="outline-text-4" id="text-orgfb4bcdc">
</div>
<ul class="org-ul">
<li><a id="org1fbb580"></a>内置全局函数<br />
<div class="outline-text-5" id="text-org1fbb580">
<p>
为了增强 Jinja2 的逻辑功能,Jinja2 内置了一些全局函数,它们在所有模板中都可以使用,
包括被导入的模板.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Jinja2 内置全局函数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">函数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">range(start,stop,step)</td>
<td class="org-left">和python 中的range 一样,获取一个等差的列表</td>
</tr>

<tr>
<td class="org-left">lipsum(n=5,html=True,min=20,max=100)</td>
<td class="org-left">在模板中生成随即的文本,默认生成5段 HTML 代码,每段20-100 个字符,如果 HTML 设置为 False, 则返回纯文本内容</td>
</tr>

<tr>
<td class="org-left">dict(**items)</td>
<td class="org-left">转换成字典,和 Python 中的 dict 一样</td>
</tr>
</tbody>
</table>

<p>
另外还有三个全局类,即 cycler, joiner 和 namespace, 详细文档: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#list-of-global-functions">Global Functions</a>
</p>

<p>
除了 Jinja2 内置的全局函数外, Flask 也提供了两个全局函数:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Flask 提供的全局函数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">函数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">url_for</td>
<td class="org-left">用于加载静态文件,或构建 URL</td>
</tr>

<tr>
<td class="org-left">get_flashed_messages</td>
<td class="org-left">用于获取闪现消息</td>
</tr>
</tbody>
</table>

<p>
url_for 函数可以用来构建 URL 和加载静态文件,和在 Python 中的 url_for 用法一样:
</p>
<div class="org-src-container">
<pre class="src src-flask">{{ url_for("book_detail", book_id=1) }}
</pre>
</div>

<p>
url_for 加载静态文件以及 get_flashed_messages 的使用会在<a href="#orgdc8983f">加载静态文件</a> 和 <a href="#orgaf5016f">闪现消息</a>
中讲解
</p>
</div>
</li>


<li><a id="orgb5fc9e9"></a>自定义全局函数<br />
<div class="outline-text-5" id="text-orgb5fc9e9">
<p>
想要自定义全局函数可以通过 app.template_global 装饰器来实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.template_global</span>()
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">greet</span>(name):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Welcome {}!"</span>.<span style="font-weight: bold;">format</span>(name)
</pre>
</div>

<p>
上面的自定义全局函数可以在模板中直接使用:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">div</span>&gt;
  {{ greet("god") }}
&lt;/<span style="font-weight: bold;">div</span>&gt;

</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgb212d2c" class="outline-4">
<h4 id="orgb212d2c">Flask 模板环境</h4>
<div class="outline-text-4" id="text-orgb212d2c">
<p>
Flask 中使用 Jinja2, 可以通过 app.jinja_env 属性来配置模板.
</p>

<p>
app.jinja_env 是 Jinja2.Environment 类的对象.下面是一些 Jinja2.Environment 对象
常用的属性.
</p>
</div>

<ul class="org-ul">
<li><a id="orgc90422d"></a>设置 autoescape(自动转义)<br />
<div class="outline-text-5" id="text-orgc90422d">
<p>
Jinja2 默认是开启了全局转义,如果要关闭全局转义,可以通过下面代码实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app.jinja_env.autospace</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
</pre>
</div>
</div>
</li>

<li><a id="org0373e6a"></a>添加过滤器<br />
<div class="outline-text-5" id="text-org0373e6a">
<p>
添加过滤器还可以通过 app.jinja_env.filters 实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">my_add_filter</span>(a,b):
    <span style="font-weight: bold;">return</span> a+b

<span style="font-weight: bold; font-style: italic;">app.jinja_env.filters</span>[<span style="font-style: italic;">"my_add_filter"</span>] = my_add_filter
</pre>
</div>

<blockquote>
<p>
嗯,这个添加过滤器的代码应该就是 @app.add_template_filter 装饰器函数装饰的代码吧.
</p>
</blockquote>
</div>
</li>

<li><a id="org8a5e9d8"></a>添加全局对象<br />
<div class="outline-text-5" id="text-org8a5e9d8">
<p>
app.template_global() 装饰器只能添加全局函数,如果需要添加其他的 Pytho 对象,可以
通过 app.jinja_env.globals 实现:
</p>
<div class="org-src-container">
<pre class="src src-python">app.jinja_env.<span style="font-weight: bold;">globals</span>[<span style="font-style: italic;">"user"</span>] = user
</pre>
</div>
</div>
</li>

<li><a id="org554fcf7"></a>添加测试器<br />
<div class="outline-text-5" id="text-org554fcf7">
<p>
测试器也可以通过 app.jinja_env.tests 添加:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">is_admin</span>(user):
    <span style="font-weight: bold;">if</span> user.role == <span style="font-style: italic;">"admin"</span>:
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>


<span style="font-weight: bold; font-style: italic;">app.jinja_env.tests</span>[<span style="font-style: italic;">"is_admin"</span>] = is_admin
</pre>
</div>

<p>
Jinja2.Environment 的其他属性可以查阅官网文档:<a href="https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=environment#jinja2.Environment">Jinja2.Envronment</a>
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org4312458" class="outline-3">
<h3 id="org4312458">其他</h3>
<div class="outline-text-3" id="text-org4312458">
</div>
<div id="outline-container-orgd3f355c" class="outline-4">
<h4 id="orgd3f355c">转义</h4>
<div class="outline-text-4" id="text-orgd3f355c">
<p>
模板渲染字符串时,字符串中有一些字符可能会破坏原本的 HTML 标签,如 "&amp;","&lt;","/"等,
更严重可能会发生 XSS 跨域脚本供给.因此,处理这些特殊字符时,要将其转义成 HTML 能正
确表达且不影响其自身的字符,如 "&lt;" 小于号的字符 在 HTML 中要正确表达而不被当成是
标签的开头,应该将其转换成 "&amp;lt;". 在使用 render_template 时, Flask 会对以 .html,
.htm, .xml 和 .xhtml 作为后缀名的文件进行全局转义,对其他后缀名的文件则不会开启全
局转义.如果想要关闭针对 html 等类型文件的全局转义,设置
<code>app.jinja_env.autoescape=False</code> 就可以了.
</p>
<blockquote>
<p>
如果是需要渲染由用户提交的字符串,强烈建议开启全局的转义,因为开发者永远不知道用户
会输入提交什么东西.
</p>
</blockquote>

<p>
没有开启全局转义的情况下,对于一些不信任的字符串,可以用 <code>{{ value|escape }}</code> 进行
局部转义(比如用户的输入), 在开启了全局转义的情况下,可以用 <code>{{ value|safe }}</code> 来
局部取消转义. 使用下面的 autospace 语法可以在一段代码块中整体关闭或开启自动转义:
</p>
<div class="org-src-container">
<pre class="src src-html">{% autospace false %}
&lt;<span style="font-weight: bold;">p</span>&gt;&#36825;&#20010;&#20195;&#30721;&#22359;&#20013;&#20851;&#38381;&#20102;&#33258;&#21160;&#36716;&#20041;&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ will_not_be_escaped }}&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endautospace %}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdc8983f" class="outline-4">
<h4 id="orgdc8983f">加载静态文件</h4>
<div class="outline-text-4" id="text-orgdc8983f">
<p>
网页中除了 HTML 代码外,还有 CSS, JavaScript 和图片文件. 静态文件默认存放的目录为
当前目录的 static 文件夹中,如果要修改静态文件存放的路径,可以在创建 Flask 对象时
设置 static_folder 参数(和设置 template_folder 类似的):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>, static_folder=<span style="font-style: italic;">"static"</span>, template_folder=<span style="font-style: italic;">"templates"</span>)
</pre>
</div>
<p>
它们的路径都是相对于项目路径的,也可以直接用完整路径表示.
</p>

<p>
在模板文件中,则可以用 url_for 加载静态文件:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static', filename='about.css') }}"</span>&gt;
</pre>
</div>
<p>
url_for 的第一个参数 static 是固定的,表示生成一个静态文件的 URL; 第二个参数
filename 是文件名或文件路径,路径是相对于 static_folder 的路径(应该也可以是完整路
径),上面的代码在模板被渲染后会解析成下面这样:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/static/about.css"</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaf5016f" class="outline-4">
<h4 id="orgaf5016f">闪现消息</h4>
<div class="outline-text-4" id="text-orgaf5016f">
<p>
用户发送请求后,网站可能需要发送给用户一些提示消息,如登录失败或登录成功,这些提示
一般用闪现消息实现.
</p>

<p>
使用闪现消息,要先在视图函数中通过 flash 函数提交消息的内容,消息内容可以有多条,然
后在模板中使用 get_flashed_messages 函数获取 flash 函数提交的消息内容.
</p>

<p>
get_flashed_messages 函数返回的是一个列表,因此需要用 for 循环或者下标来取出消息内
容. 闪现消息的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template,flash

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/flash"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">myflash</span>():
    flash(<span style="font-style: italic;">"message1"</span>)
    flash(<span style="font-style: italic;">"message2"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"flash.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
模板文件获取消息:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 flash</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">ul</span>&gt;
  {% for message in get_flashed_messages() %}
  &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
  {% endfor %}
&lt;/<span style="font-weight: bold;">ul</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
因为闪现消息是储存在 session 中的, 而使用 session 之前必需要在 app.config 里设置
SECRET_KEY, 如果没有设置,就会出现下面这种错误提示:
</p>
<pre class="example">
RuntimeError

RuntimeError: The session is unavailable because no secret key was set.  Set the secret_key on the application to something unique and secret.
</pre>

<p>
我们在 app.config 里随便设置一个字符串就好了(测试):
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template,flash

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/flash"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">myflash</span>():
    flash(<span style="font-style: italic;">"message1"</span>)
    flash(<span style="font-style: italic;">"message2"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"flash.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
再次访问 <a href="http://127.0.0.1:5000/flash">http://127.0.0.1:5000/flash</a> 就可以看到内容:
</p>
<pre class="example">
message1
message2
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org33b1550" class="outline-2">
<h2 id="org33b1550">数据库</h2>
<div class="outline-text-2" id="text-org33b1550">
<p>
数据库是动态站必备的基础功能,通过使用数据库,数据可以被动态展示,修改,删除,极大提
高了数据的管理能力以及数据的传递效率.
</p>

<p>
数据库有很多种,例如 SQL Server, Oracle, PostgreSQL, MySQL 等. 因为 MySQL 免费,稳
定,灵活,跨平台,成为了流形的关系型数据库之一.
</p>

<p>
这一部分的代码放在 demo05 文件夹中:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10
mkdir demo05
source Scripts/activate
<span style="font-weight: bold;">cd</span> demo05
</pre>
</div>

<pre class="example">
sh: cannot set terminal process group (-1): Inappropriate ioctl for device
sh: no job control in this shell
sh-5.2$ mkdir: cannot create directory 'demo05': File exists
</pre>
</div>


<div id="outline-container-org822e70d" class="outline-3">
<h3 id="org822e70d">准备工作</h3>
<div class="outline-text-3" id="text-org822e70d">
</div>
<div id="outline-container-org8c7e25d" class="outline-4">
<h4 id="org8c7e25d">MySQL 软件</h4>
<div class="outline-text-4" id="text-org8c7e25d">
<p>
书中使用的 MySQL 8.0 版本.下载安装的图文教程:<a href="https://zlkt.net/book/detail/10/306">Install MySQL</a>
</p>
</div>
</div>

<div id="outline-container-org1a557f0" class="outline-4">
<h4 id="org1a557f0">Python 操作 MySQL 驱动</h4>
<div class="outline-text-4" id="text-org1a557f0">
<p>
Flask 是 Python 的框架,想要用 Flask 操作 MySQL 要先安装 Python 操作 MySQL 的驱动.目
前有下面这些 MySQL 驱动包:
</p>
<ul class="org-ul">
<li>MySQL-python: 也就是 MySQLdb, 是对 C 语言操作 MySQL 数据库的一个简单封装,遵循
Python DB API v2, 只支持 python2.</li>
<li>mysqlclient: MySQL-python 的另一个分支,支持 Python3 且修复了一些 bug, 是目前执
行效率最高的驱动,但是安装时容易因为环境问题出错.</li>
<li>pymysql: 纯 Python 实现的驱动,执行效率不如 mysqlclient. 但因为是纯 Python 实现
的,所以可以和 Python 代码无缝衔接.</li>
<li>mysql-connector-python: MySQL 官方推出的纯 Python 连接 MySQL 的驱动,但执行效率
比 pymysql 还低.</li>
</ul>


<p>
为了减少出错,作者使用 pymysql 作为驱动程序,并推荐学完以后再移植到 mysqlclient.
</p>

<p>
pymysql 不是内置的包,所以需要安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install pymysql -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<pre class="example">
Looking in indexes: https://mirrors.163.com/pypi/simple/
Collecting pymysql
  Using cached https://mirrors.163.com/pypi/packages/4f/52/a115fe175028b058df353c5a3d5290b71514a83f67078a6482cff24d6137/PyMySQL-1.0.2-py3-none-any.whl (43 kB)
Installing collected packages: pymysql
Successfully installed pymysql-1.0.2
WARNING: You are using pip version 20.2.1; however, version 21.3.1 is available.
You should consider upgrading via the 'c:\users\kamisama\flask_web_py3_10\scripts\python.exe -m pip install --upgrade pip' command.
</pre>
</div>
</div>

<div id="outline-container-orgc81ef97" class="outline-4">
<h4 id="orgc81ef97">Flask-SQLAlchemy</h4>
<div class="outline-text-4" id="text-orgc81ef97">
<p>
Flask 中,很少会使用 pymysql 直接写原生的 SQL 语句去操作数据库,更多的是通过
SQLAlchemy 提供的 ORM 技术,类似于操作普通 Python 对象一样,来实现对数据库的增删改
查操作. 而 Flask-SQLAlchemy 是对 SQLAlchemy 的一个封装,这让在 Flask 使用
SQLAlchemy 更方便.
</p>

<p>
Flask-SQLAlchemy 也需要单独安装,因为 Flask-SQLAlchemy 依赖 SQLAlchemy, 所以安装
了 Flask-SQLAlchemy , SQLAlchemy 就会自动安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-sqlalchemy -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<pre class="example">
Looking in indexes: https://mirrors.163.com/pypi/simple/
Collecting flask-sqlalchemy
  Downloading https://mirrors.163.com/pypi/packages/26/2c/9088b6bd95bca539230bbe9ad446737ed391aab9a83aff403e18dded3e75/Flask_SQLAlchemy-2.5.1-py2.py3-none-any.whl (17 kB)
=0.8.0
  Downloading https://mirrors.163.com/pypi/packages/ee/c0/ea1a59dbf8dd63bbea7cc2e89d304e01a4c313d6ff9bd7a98f3594b387af/SQLAlchemy-1.4.29-cp38-cp38-win_amd64.whl (1.5 MB)
=0.10 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from flask-sqlalchemy) (2.0.1)
= "3" and (platform_machine == "aarch64" or (platform_machine == "ppc64le" or (platform_machine == "x86_64" or (platform_machine == "amd64" or (platform_machine == "AMD64" or (platform_machine == "win32" or platform_machine == "WIN32"))))))
  WARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ReadTimeoutError("HTTPSConnectionPool(host='mirrors.163.com', port=443): Read timed out. (read timeout=15)")': /pypi/packages/76/75/02949455e365fe0f47958e956aa688d185178e7280d73695e5c831cbbe0d/greenlet-1.1.0-cp38-cp38-win_amd64.whl
  WARNING: Retrying (Retry(total=3, connect=None, read=None, redirect=None, status=None)) after connection broken by 'ReadTimeoutError("HTTPSConnectionPool(host='mirrors.163.com', port=443): Read timed out. (read timeout=15)")': /pypi/packages/76/75/02949455e365fe0f47958e956aa688d185178e7280d73695e5c831cbbe0d/greenlet-1.1.0-cp38-cp38-win_amd64.whl
  Downloading https://mirrors.163.com/pypi/packages/76/75/02949455e365fe0f47958e956aa688d185178e7280d73695e5c831cbbe0d/greenlet-1.1.0-cp38-cp38-win_amd64.whl (96 kB)
=3.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask&gt;=0.10-&gt;flask-sqlalchemy) (3.1.2)
=7.1.2 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask&gt;=0.10-&gt;flask-sqlalchemy) (8.1.3)
=2.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask&gt;=0.10-&gt;flask-sqlalchemy) (2.1.2)
=2.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask&gt;=0.10-&gt;flask-sqlalchemy) (2.2.3)
=2.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Jinja2&gt;=3.0-&gt;Flask&gt;=0.10-&gt;flask-sqlalchemy) (2.1.2)
=7.1.2-&gt;Flask&gt;=0.10-&gt;flask-sqlalchemy) (0.4.6)
Installing collected packages: greenlet, SQLAlchemy, flask-sqlalchemy
Successfully installed SQLAlchemy-1.4.29 flask-sqlalchemy-2.5.1 greenlet-1.1.0
WARNING: You are using pip version 20.2.1; however, version 23.0.1 is available.
You should consider upgrading via the 'c:\users\kamisama\flask_web_py3_10\scripts\python.exe -m pip install --upgrade pip' command.
</pre>

<p>
SQLAlchemy 类似于 Jinja2, 也可以独立于 Flask 使用, 完全可以在任何 Python 程序中
使用. SQLAlchemy 的功能非常强大,书中没有完全讲解,有需要可以查阅其官方文档: <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>
</p>
</div>
</div>
</div>

<div id="outline-container-orge56ed21" class="outline-3">
<h3 id="orge56ed21">Flask-SQLAlchemy 的基本使用</h3>
<div class="outline-text-3" id="text-orge56ed21">
</div>
<div id="outline-container-orgd8b5fc8" class="outline-4">
<h4 id="orgd8b5fc8">连接 MySQL</h4>
<div class="outline-text-4" id="text-orgd8b5fc8">
<p>
Flask-SQLAlchemy 操作数据库需要先创建一个由 Flask-SQLAlchemy 提供的 SQLAlchemy
类的对象.创建这个对象时,要传入当前 app, 还要在 app.config 里设置
SQLALCHEMY_DATABASE_URI, 这个参数就是 Flask-SQLAlchemy 连接数据库时需要用到的"命
令":
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold;">with</span> db.engine.connect() <span style="font-weight: bold;">as</span> conn:
    <span style="font-weight: bold; font-style: italic;">rs</span> = conn.execute(<span style="font-style: italic;">"select 1"</span>)
    <span style="font-weight: bold;">print</span>(rs.fetchone())
</pre>
</div>

<p>
Flask-SQLAlchemy 连接数据库时会从传入的 app 的 config 属性中读取
SQLALCHEMY_DATABASE_URI 的参数值,根据不同的数据库,该 URI 的格式有所不同,MYSQL 的
连接格式:
</p>
<pre class="example">
mysql+[driver]://[username]:[password]@[host]:[port]/[database]?charset=utf8
</pre>
<p>
driver 就是 python 操作数据库的驱动程序,我们前面选择并安装了 pymysql, 所以上面代
码的 URI 里也是 pymysql, DATABASE 需要在数据库中提前创建好,我印象中应该是有用
Python 连接MYSQL 并创建数据库的方法的,但那个就离这本书的内容有点远了,直接开个终
端连接 MYSQL 创建数据库就行了:
连接MYSQL:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; MYSQL, &#26412;&#22320;&#25968;&#25454;&#24211;,&#36335;&#30001;&#22120;&#23616;&#22495;&#32593;,&#23494;&#30721;&#38543;&#20415;</span>
mysql -uroot -pkamisama
</pre>
</div>
<p>
创建 database_learn 数据库:
</p>
<pre class="example">
mysql&gt; create database database_learn;
</pre>
<p>
如果数据库已经创建好了,代码也没有错误,那么上面的代码运行的结果应该是:
</p>

<div class="org-src-container">
<pre class="src src-sh">python testMysql.py
</pre>
</div>

<pre class="example">
C:\Users\kamisama\flask_web_py3_10\lib\site-packages\flask_sqlalchemy\__init__.py:872: FSADeprecationWarning: SQLALCHEMY_TRACK_MODIFICATIONS adds significant overhead and will be disabled by default in the future.  Set it to True or False to suppress this warning.
  warnings.warn(FSADeprecationWarning(
(1,)
</pre>


<p>
成功打印了 "(1,)", 说明已经连接成功, 我在2023年的 Sqlalchemy 版本里使用时有下面
的警告提示:
</p>
<pre class="example">

FSADeprecationWarning: SQLALCHEMY_TRACK_MODIFICATIONS adds significant overhead and will be disabled by default in the future.  Set it to True or False to suppress this warning.
  warnings.warn(FSADeprecationWarning(
</pre>
<p>
暂时不知作用,暂且不管.
</p>
</div>
</div>

<div id="outline-container-org770f5a6" class="outline-4">
<h4 id="org770f5a6">ORM模型</h4>
<div class="outline-text-4" id="text-org770f5a6">
<p>
object relationship mapping 对象关系映射,简称 ORM. 它是一种可以用面向对象的方式
来操作关系型数据库的技术.我们将能够映射数据库表的 Python 类称为 ORM 模型(当然了,
其他的面相对象编程的语言都有类似的概念,或者干脆也叫这个名字).
</p>

<p>
一个 ORM 模型对应数据库中的一个表, ORM 模型中的每个类的属性都分别对应表的每个字
段; ORM 模型的每个实例对象对应表中的每一条记录.
</p>

<p>
ORM 技术可以让开发者用面向对象的方式操作数据库, ORM 模型有以下优点:
</p>
<ul class="org-ul">
<li><p>
开发效率高: (几乎)不需要写原生 SQL 语句,纯 Python 的方式操作数据库,提高了开发
效率.
</p>
<blockquote>
<p>
这一点我倒是没什么感觉,觉得写原生 SQL 语句没有纯 Python 开发效率高感觉没多大改变
的样子, SQL 熟练的话也就开个终端输入语句,不过这里的开发效率应该是指的不用将数据
放到 SQL 语句字符串里而可以直接使用 ORM 技术提供的接口?或者是纯 Python 就不用写
原生 SQL 的存储过程,视图函数等等复杂的 SQL 语句了?
</p>
</blockquote></li>
<li><p>
安全性高: ORM 模型底层代码对一些常见的安全问题,例如 SQL 注入等做了防护,比直接
使用 SQL 语句更加安全.
</p>
<blockquote>
<p>
这点倒是的,直接使用 SQL 语句大多都是将数据拼接到 SQL 语句的字符串里,很容易就出现
可以 SQL 注入的地方.
</p>
</blockquote></li>
<li><p>
灵活性强: Flask-SQLAlchemy 底层支持 SQLite, MYSQL, Oracle, PostgreSQL 等关系型
数据库,但针对不同的数据库, ORM 模型的代码几乎一模一样,只需要修改少量代码,就可
以完成底层数据库的更换.
</p>
<blockquote>
<p>
这点倒是很强的一点,应该只有某些特定数据库软件的功能和特性相关的代码需要修改,但一
般这种地方都很少,比如就是前面测试数据库连接中使用的 Sqlalchemy_database_uri 的格
式, SQL 语句虽说基本语法都很相似,但不同的数据库总有一些差别,直接使用数据库驱动执
行原生 SQL 语句的话要后期要维护代码的工作量就很令人难受了, SQLAlchemy 相当于提供
一个统一的操作数据库的接口,底层数据库的不同它都为我们处理了.
</p>
</blockquote></li>
</ul>



<p>
下面在测试连接的代码的基础上用 Flask-SQLAlchemy 创建一个User 模型:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

db.create_all()
</pre>
</div>

<p>
上面代码创建了一个 User 类,它继承了 db.Model 类, 所有 ORM 模型都必须是 db.Model
的直接或间接子类. 然后通过 <code>__tablename__</code> 属性指定了User 模型映射到数据库中表的
表名.然后定义了三个 db.Column 类型的类属性,只有使用 db.Column 定义的类属性才会映
射到数据库中成为表的字段. 在这个模型中, id 是 db.Integer  类型,映射到数据库中则
为整型,且传递了 primary_key 为 True 映射到数据库中为指定这个字段为主键,
autoincrement=True 则是设置该字段自增; 另外还设置了 username 和 password 字段,
db.String 类型映射到数据库中则为 varchar 类型,并指定最大长度为 100.
</p>

<p>
最后的 db.create_all() 语句把 User 模型映射为数据库中的表,可以使用数据库软件或
SQL 语句查看数据库中创建的表.
列出当前使用的数据库的所有表:
</p>
<pre class="example">
show tables;
</pre>
<p>
查看表结构:
</p>
<pre class="example">
show create table User;
</pre>

<p>
创建数据库的字段类型,除了上面的 db.Integer 和 db.String 还有许多,基本都和数据库
中可用的字段类型一一对应:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Flask-SQLAlchemy 字段类型</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">db.Integer</td>
<td class="org-left">整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.SmallInteger</td>
<td class="org-left">小整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.BigInteger</td>
<td class="org-left">长整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.Decimal</td>
<td class="org-left">定点类型,可以指定总长度和小数点后位数</td>
</tr>

<tr>
<td class="org-left">db.Boolean</td>
<td class="org-left">布尔类型</td>
</tr>

<tr>
<td class="org-left">db.Date</td>
<td class="org-left">日期类型,存储 Python 中的 datetime.date 对象</td>
</tr>

<tr>
<td class="org-left">db.DateTime</td>
<td class="org-left">日期时间类型,存储 Python 中的 datetime.datetime 对象</td>
</tr>

<tr>
<td class="org-left">db.Time</td>
<td class="org-left">时间类型,存储 Python 中的 datetime.time 对象</td>
</tr>

<tr>
<td class="org-left">db.Interval</td>
<td class="org-left">时间间隔,存储 Python 中的 datetime.timedelay 对象</td>
</tr>

<tr>
<td class="org-left">db.String</td>
<td class="org-left">字符串类型,使用时需要指定长度,不能超过 255 个字符</td>
</tr>

<tr>
<td class="org-left">db.Text</td>
<td class="org-left">文本类型,用于字符串长度不可控制的情况</td>
</tr>

<tr>
<td class="org-left">db.Enum</td>
<td class="org-left">枚举类型</td>
</tr>

<tr>
<td class="org-left">db.PickleType</td>
<td class="org-left">存储经过 Pickle 后的对象</td>
</tr>

<tr>
<td class="org-left">db.LargeBinary</td>
<td class="org-left">存储二进制数据</td>
</tr>
</tbody>
</table>

<p>
字段在数据库中的设置,都是通过 db.Column 的参数实现的. db.Column 常用参数:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> db.Column 常用参数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">参数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">字段在数据库中的名称,如果没有设置,则使用属性名作为字段名</td>
</tr>

<tr>
<td class="org-left">type_</td>
<td class="org-left">字段类型</td>
</tr>

<tr>
<td class="org-left">autoincrement</td>
<td class="org-left">自增</td>
</tr>

<tr>
<td class="org-left">default</td>
<td class="org-left">默认值</td>
</tr>

<tr>
<td class="org-left">index</td>
<td class="org-left">如果设置为 True ,则将该字段设置为索引</td>
</tr>

<tr>
<td class="org-left">nullable</td>
<td class="org-left">是否可以为 NULL ,就是是否可以为空值</td>
</tr>

<tr>
<td class="org-left">onupdate</td>
<td class="org-left">修改对象时,会自动使用这个属性指定的值</td>
</tr>

<tr>
<td class="org-left">primary_key</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">unique</td>
<td class="org-left">设置为 True 表示该字段的值必需唯一</td>
</tr>

<tr>
<td class="org-left">comment</td>
<td class="org-left">创建表时的注释</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9a1f7cf" class="outline-4">
<h4 id="org9a1f7cf">CRUD 操作</h4>
<div class="outline-text-4" id="text-org9a1f7cf">
<p>
使用 ORM 进行 CRUD(create,read,update,delete) 操作,需要先把操作添加到会话中,通过
db.session 可以获取到会话对象.会话对象存在于内存,如果需要把会话的操作提交到数据
库中,要调用 db.session.commit() 操作;如果要将会话的操作回滚,要调用
db.session.rollback() .
</p>

<blockquote>
<p>
其实用其他编程语言而不是原生 SQL 操作数据库,跟写 SQL 语句使用存储过程还是触发器
什么的一样,都要提交生效,回滚取消,具体是什么的现在都忘了,有空再去复习下 SQL.
</p>
</blockquote>
</div>

<ul class="org-ul">
<li><a id="org96bc637"></a>Create 操作<br />
<div class="outline-text-5" id="text-org96bc637">
<p>
使用 ORM 添加/创建以一条数据非常简单,先用 ORM 模型创建一个对象,然后添加到会话中,
再进行 commit 操作就可以了.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>

<p>
上面代码中创建了 3个User 类的对象,因为 User 类初始化的参数使用的全是关键字参
数,所以必需要写明 username 和 password, 另外,(我自己)也不推荐在数据库相关的对象
相关操作上使用位置参数,这样很容易出错.由于 id 是一个自增的主键,因此可以不需要赋
值,然后再把三个对象添加到会话中(session), 最后统一进行 commit 操作,即可把数据添
加到数据库中.
</p>

<blockquote>
<p>
总是看见 commit 和 rollback, 不查不舒服,还是去查了下,记起来了需要提交和回滚的数
据库里的概念叫做 "事务",有原子性,一致性,隔离性和持久性,事务中的 SQL 语句要么全部
执行,要么全不执行,"事务" 的原子性,一致性和持久性是靠 "日志" 来实现的日志记录了事
务对数据库的更新,如果发生错误,就可以根据日志撤销事务对数据库的更改,让数据库 "回
滚" 到更改前的状态.这应该就是 "会话" 这个概念/对象的存在需要,不可能为所有执行过
的事务都维护一个日志,那样电脑资源的开销应该会巨大,所以是为每个 "会话" 维护一个事
务的日志,会话结束就可以释放这些日志占用的电脑资源(删除日志).
</p>
</blockquote>
</div>
</li>

<li><a id="org5ebd08e"></a>Read 操作<br />
<div class="outline-text-5" id="text-org5ebd08e">
<p>
Read 就是查询操作. ORM 模型都继承自 db.Model. db.Model 内置的 query 属性有许多方
法,可以实现对 ORM 模型的查寻操作.
</p>

<p>
query 上的方法可分为两大类,分别是提取和过滤.
</p>

<p>
提取和过滤是对应的简单的SQL 查询和复杂的 SQL 查询操作.
</p>

<p>
先看看简单的(提取):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/fetch"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_fetch</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; User &#34920;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#20027;&#38190;&#20026; 1 &#30340; User &#23545;&#35937;(&#35760;&#24405;)</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#31532;&#19968;&#26465;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#25552;&#21462;&#25104;&#21151;!"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码里 ,all() 方法获取所有的 User 对象,即获取 User 表的所有记录(一条记录对应
一个 Use 对象); get() 方法获取指定主键的 User 对象(差不多等价于 <code>select * from
User where id = **</code>);first() 方法获取第一个 User 对象(第一条记录),提取数据常用的
方法:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> 提取数据的常用方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">query.all()</td>
<td class="org-left">获取查询结果集的所有对象,列表类型</td>
</tr>

<tr>
<td class="org-left">query.first()</td>
<td class="org-left">获取查询结果集的第一个对象</td>
</tr>

<tr>
<td class="org-left">query.one()</td>
<td class="org-left">获取查询结果集的一个对象,如果对象数量不等于1,则抛出异常</td>
</tr>

<tr>
<td class="org-left">query.one_or_none()</td>
<td class="org-left">与 one 方法类似,结果不等于1时不是抛出异常,而是返回 None</td>
</tr>

<tr>
<td class="org-left">query.get(pk)</td>
<td class="org-left">根据主键获取当前 ORM 模型的第一条数据</td>
</tr>

<tr>
<td class="org-left">query.exists()</td>
<td class="org-left">判断数据是否存在</td>
</tr>

<tr>
<td class="org-left">query.count()</td>
<td class="org-left">获取查询结果集的个数</td>
</tr>
</tbody>
</table>

<p>
复杂的查询(过滤),经常需要根据多个条件进行判断,分组,排序等操作:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/fetch"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_fetch</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; User &#34920;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#20027;&#38190;&#20026; 1 &#30340; User &#23545;&#35937;(&#35760;&#24405;)</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#31532;&#19968;&#26465;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#25552;&#21462;&#25104;&#21151;!"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">filter &#26041;&#27861;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">filter_by &#26041;&#27861;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.filter_by(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
filter 方法传递查询条件,emm 应该类似与 WHERE 后面的 SQL 语句, filter_by 传递关键
字参数,应该是限制在字段中的查询. filter 可以查询的范围要更广.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> 常用的过滤方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">query.filter()</td>
<td class="org-left">根据查询条件过滤</td>
</tr>

<tr>
<td class="org-left">query.filter_by()</td>
<td class="org-left">根据关键字参数过滤</td>
</tr>

<tr>
<td class="org-left">query.slice(start, stop)</td>
<td class="org-left">对结果进行切片操作</td>
</tr>

<tr>
<td class="org-left">query.limit(limit)</td>
<td class="org-left">对结果进行数量限制</td>
</tr>

<tr>
<td class="org-left">query.offset(offset)</td>
<td class="org-left">在查询时条过前面 offset 条数据</td>
</tr>

<tr>
<td class="org-left">query.order_by()</td>
<td class="org-left">根据给定字段排序</td>
</tr>

<tr>
<td class="org-left">query.group_by()</td>
<td class="org-left">根据给定字段分组</td>
</tr>
</tbody>
</table>


<p>
slice(),limit(),offset() 方法比较简单,不用过多讲解,order_by() 和 group_by() 这两
个用的多也不容易理解的需要演示下用法(即使纯 SQL 这两个也属于复杂操作,特别是
groupby 分组):
</p>

<p>
query.order_by():
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">query.order_by()</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27491;&#24207;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(<span style="font-style: italic;">"id"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(User.<span style="font-weight: bold;">id</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20498;&#24207;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(db.text(<span style="font-style: italic;">"-id"</span>))
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(User.<span style="font-weight: bold;">id</span>.desc())

    <span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> desc
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(desc(<span style="font-style: italic;">"id"</span>))


    <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> users:
        <span style="font-weight: bold;">print</span>(user.<span style="font-weight: bold;">id</span>)

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
query.group_by():
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">query.group_by()</span>
    <span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> func
    <span style="font-weight: bold; font-style: italic;">users</span> = db.session.query(User.username,func.count(User.<span style="font-weight: bold;">id</span>)).group_by(<span style="font-style: italic;">"username"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
分组方法是根据某个字段进行分组,主要用来获取分组后的最大值,最小值,平均值,总和等,
多做统计视图用. 因为提取的数据不再是某个模型,所以不能通过 Model.query 的方式获取,而
是通过 db.session.query 来提取,上面的代码获取了所有用户名在表中存在的个数.
</p>
<blockquote>
<p>
如果我没记错,上面的查询语句应该等价于:
SELECT username, count(id) from User group by username;
</p>

<p>
mysql&gt; SELECT username, count(id) from User group by username;
嗯,没错,执行结果:
</p>
<!-- This HTML table template is generated by emacs 27.1 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;username&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;count(id)&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;张三&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;李四&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;王武&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;
    </td>
  </tr>
</table>
<p>
3 rows in set (0.00 sec)
</p>
</blockquote>

<p>
过滤是数据提取中很重要的功能,除了直接使用 <code>==</code> <code>!=</code> 之外,下面这些过滤条件在 SQL
中也很常用,但是这些过滤条件只能通过 filter 方法实现:
</p>
<ul class="org-ul">
<li>like : 模糊查询,与 SQL 语句中的 like 类似,可以在搜索字符串两边添加 <code>%</code> 来匹配
任意字符,例如 <code>users = User.query.filter(User.username.like(%张%))</code>,用来查找用
户名里含有 "张" 这个字符的记录</li>
<li>contains: 也是模糊查找,相当于在 like 的搜索字符两边都加上了 <code>%</code>, <code>users =
  User.query.filter(User.username.contains())</code> 和上面查找名字带 "张" 的 like 语
句效果一样.</li>
<li>in : 判断值是否在指定数据集中,为了不与 Python 的 in 关键字混淆,在 in 后面加上
了下划线,实际的方法名为 in_:
<code>users = User.query.filter(User.username.in_(["张三","李四","王五"]))</code></li>
<li>not in: 作用和 in 相反,使用方法也很简单,在 in_ 方法代码的表达式前面加上 <code>~</code> 就
可以了: <code>users = User.query.filter(~User.username.in_(["张三"]))</code></li>
<li>is null: 判断值是否为空,可以通过值判断是否为 None ,也可以通过 is_ 方法判断(下
划线同样是为了不与 Python is 关键字混淆):
<code>users = User.query.filter(User.username==None)</code>, 查询 username 为空的记录
<code>users = User.query.filter(User.username.is_(None))</code>, 和上面代码等价</li>
<li>is not null: 作用和 is null 相反,实际的方法名为 isnot:
<code>users = User.query.filter(User.username!=(None))</code>, 查询 username 不为空的记录
<code>users = User.query.filter(User.username.isnot(None))</code>, 和上面代码等价</li>
<li><p>
and: 用于同时满足多个条件的查询,实际方法名为 and_:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> and_
<span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(and_(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>, User.<span style="font-weight: bold;">id</span> &lt; 10))
</pre>
</div></li>
<li><p>
or: 用于满足一个或多个条件,实际方法名为 or_:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> or_
<span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(or_(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>, User.username==<span style="font-style: italic;">"&#26446;&#22235;"</span>))
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="org4b8c7f9"></a>update 操作<br />
<div class="outline-text-5" id="text-org4b8c7f9">
<p>
更新操作也分为两种,一种针对一条数据,另一种针对多条数据.
</p>

<p>
更新一条数据可以直接修改对象的属性,然后执行 commit 操作:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
<span style="font-weight: bold; font-style: italic;">user.username</span> = <span style="font-style: italic;">"&#24352;&#19977;_&#26356;&#26032;"</span>
db.session.commit()
</pre>
</div>

<p>
多条数据修改的情况,需要先通过 filter 或 filter_by 获取 BaseQuery 对象,然后再调用
update 方法批量修改,最后提交使修改生效:
</p>
<div class="org-src-container">
<pre class="src src-python">User.query.<span style="font-weight: bold;">filter</span>(User.username.like(<span style="font-style: italic;">"%&#24352;&#19977;%"</span>)).update({<span style="font-style: italic;">"password"</span>: User.password+<span style="font-style: italic;">"_&#26356;&#26032;"</span>}, synchronize_session=<span style="font-weight: bold; text-decoration: underline;">False</span>)
db.session.commit()
</pre>
</div>

<blockquote>
<p>
synchronize_session 的作用: <a href="https://stackoverflow.com/questions/70350298/what-does-synchronize-session-false-do-exactly-in-update-functions-for-sqlalch">https://stackoverflow.com/questions/70350298/what-does-synchronize-session-false-do-exactly-in-update-functions-for-sqlalch</a>
</p>

<p>
简单阅读了下,这个是设置 session 的同步策略的,是在执行更新或删除之前同步还是事务
完成之后同步或是其他策略,我们不希望在更新操作没有执行完毕时就修改了内存中会话缓
存的数据库数据,这样很可能导致错误,尤其是我们使用了模糊匹配,还进行的是更新操作,所
以设置为 False ,当会话结束或事务提交之后才同步内存中缓存的数据库数据.
</p>
</blockquote>
</div>
</li>

<li><a id="org8820b5c"></a>delete 操作<br />
<div class="outline-text-5" id="text-org8820b5c">
<p>
删除也分删除一条或删除多条数据两种.
</p>

<p>
删除单条数据也很简单:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
db.session.delete(user)
db.session.commit()
</pre>
</div>
<p>
删除多条数据和更新多条数据类似:
</p>
<div class="org-src-container">
<pre class="src src-python">User.query.<span style="font-weight: bold;">filter</span>(User.username.contains(<span style="font-style: italic;">"%&#24352;&#19977;%"</span>)).delete(synchronize_session=<span style="font-weight: bold; text-decoration: underline;">False</span>)
db.session.commit()
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8aee9f7" class="outline-3">
<h3 id="org8aee9f7">表关系</h3>
<div class="outline-text-3" id="text-org8aee9f7">
<p>
关系型数据库的一个强大功能就是多个表可以建立关系.
</p>

<p>
例如,存储文章信息的表,通常需要作者的信息,但我们不需要直接保存作者信息到文章的表
里,只需要通过用户id 作为外键引用用户表就可以了.
</p>

<p>
这种表关系可以存储非常复杂的数据,且让查询非常迅速.
</p>


<p>
Flask-SQLAlchemy 对数据库的表关系也有对应的映射实现.表关系的建立是通过数据的外键
实现的,Flask-SQLAlchemy 的对应实现就是创建表(db.Model类)时用 db.ForeignKey 指定
另一个表的字段(类属性).
</p>

<p>
表的关系总的来说可以分为3种: 一对多(多对一), 多对多, 一对一.
</p>
</div>

<div id="outline-container-orgbdfd2de" class="outline-4">
<h4 id="orgbdfd2de">外键</h4>
<div class="outline-text-4" id="text-orgbdfd2de">
<p>
外键是数据库里的概念, Flask-SQLAlchemy 中支持在创建 ORM 模型时就指定外键,创建外
键通过 db.ForeginKey 实现. 例如,前面已经有了用户表 User ,现在要创建一个文章表
Article, 来存储每篇文章的信息,包括作者信息,这张表有一个 author_id 字段,通过外键
引用 User 表的 id 字段,就可以保存文章的作者信息:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"Article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"User.id"</span>))
</pre>
</div>
<p>
上面代码中,除了常规的 id,title,content 属性外,还添加了一个 author_id , author_id
通过 db.ForeignKey("User.id") 引用了前面创建的 User 表里的 id 字段. 因为它是引用
的 User 表的 id 字段,所以 author_id 的字段类型也要和 User.id 字段类型一致.
</p>
</div>
</div>

<div id="outline-container-org8975eae" class="outline-4">
<h4 id="org8975eae">一对多关系</h4>
<div class="outline-text-4" id="text-org8975eae">
<p>
一对多和多对一其实是一个概念(吧),或者说是同一个关系不同角度的解释,一篇博客文章只
能属于一个作者,但一个作者可以发布多篇博客,作者和文章就是一对多的关系,换个角度,文
章和作者就是多对一的关系了.
</p>
</div>

<ul class="org-ul">
<li><a id="org0f624ff"></a>建立关系<br />
<div class="outline-text-5" id="text-org0f624ff">
<p>
关系是通过外键建立的, <a href="#orgbdfd2de">外键</a> 部分创建的 Article 模型中其实已经通过 author_id 外键
建立了博客和作者的关系. 但是只是建立了一个外键,通过 Article 对象还是无法直接获取
到 author_id 对应的 User 对象.
</p>

<p>
可以使用 db.relationship 来引用外键指向的 ORM 模型.
</p>

<blockquote>
<p>
我没记错的话这个在数据库的表结构设计中是不能实现,也是没有必要实现的,因为外键一定
是能唯一识别另一个表的某条记录的,一般就是另一个表的主键,而通过这个外键我们就可以
查询另一个表的数据,所以在输出数据视图时经常会根据外键筛选另一个表的数据,就比如要
展示文章/博客的标题和作者,只需要根据 author_id 去 User 表里查找用户名数据即可,所
以实际上数据库的 Article 表只存储了 User 表的主键,并没有存储该主键对应的某条数据,
但是 ORM 模型通过 db.relationship 来引用 User 表的某条记录,就相当于帮我们把根据
这个外键(author_id)去外键对应的表(User) 查找对应记录的操作完成了,我们直接使用就
可以了,但这是 Flask-SQLAlchemy 做的工作,实际数据库中存储的数据应该只会有外键,而
不会真正存储 db.relationship 返回的数据.
</p>
</blockquote>

<p>
在上面的 Article 模型中添加 db.relationship:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    db.session.add(article)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">article</span> = Article.query.filter_by(title=<span style="font-style: italic;">"aa"</span>).first()
    <span style="font-weight: bold;">return</span> article.author.username
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码的视图函数创建了 article 对象,并添加到数据库中,然后提取出其信息,并通过
article.author.username 访问到了 article 对象的用户名.
</p>

<blockquote>
<p>
这个代码其实有点坑, db.ForeignKey 和 db.relationship 的参数竟然用的是字符串,用字
符串引用/表示数据库表或字段的方式是只有在 Python 中写原生的 SQL 代码才会用到的,
而既然已经使用了 ORM 模型了,那么用对应的 User.id 和 User 的类属性和类来表示/指代
表字段和表格才是合乎编程原则的写法吧,况且这种字符串的写法对数据库配置也有要求,比
如 MYSQL 在 windows 上不分大小写,linux 上却是大小写敏感的,这种写法在测试和运行环
境不同时也可能导致错误.
</p>

<p>
既然 SQLAlchemy 提供Python 和数据库的映射,那应该所有的操作都是可以的,实际上我将
字符串的写法替换成 User.id 和 User 之后仍然正确运行了,这说明确实是可行的,作者要
是想用这种写法表示 SQLAlchemy 操作数据库和原生 SQL 语句用法的无缝衔接那我还能理
解,但他连说明都没有,直接就上了代码,有点难受.
</p>

<p>
后面我把用字符串的方式都换成 SQLAlchemy 的映射对象了,结果发现会出现错误,实际上,
用 SQLAlchemy 映射的对象确实可以,但是有一个问题,就是对象在使用时是否被定义的问题,上
面代码替换后正确运行是因为只在 Article 模型里引用了 User 类和 User.id 属性,而
User 是在 Article 前面定义的,所以没错,但在后面我们需要建立 User 和 Article 的双
向关系的时候,在 User 里面引用 Article 就会报措,因为此时 Article 还是未定义的,因
此 SQLAlchemy 使用相关类/对象的名称(字符串)来引用它们,如果参数是字符串就会交由
<a href="https://docs.sqlalchemy.org/en/20/orm/relationship_api.html#sqlalchemy.orm.relationship.params.argument">registry</a> 来处理,由它来生成对相关类/对象/映射的引用.
</p>

<p>
所以这里不管是 "user.id" 还是 "User" 都是交给 registry 处理的, "User" 确实是类名,所
以大写是必要的, ForeignKey() 的参数中 "user.id" 是 &lt;table&gt;.&lt;column&gt; 格式的字符串,所
以 user 确实是表名,经过测试,这个外键的表名或字段引用的写法是大小写敏感的,与使用
什么数据库无关,有了 registry 这一个概念的认知,才容易理解为什么代码使用字符串作为
参数,而不是使用映射类/对象作为参数.
</p>
</blockquote>
</div>
</li>


<li><a id="org2e5f7a7"></a>建立双向关系<br />
<div class="outline-text-5" id="text-org2e5f7a7">
<p>
通过上面代码, Article 模型可以通过 author 属性访问到 User 的实例对象,但 User 的
实例对象不能访问到与其关联的 Article 实例对象,因此,为了实现双向的绑定,我们需要在
User 模型上也添加一个 db.relationship 类型的属性 articles, 并且在双方的
db.relationship 上都加上一个参数 back_populates 用于绑定对方访问自己的属性:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, back_populates=<span style="font-style: italic;">"author"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates= <span style="font-style: italic;">"articles"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码在 User 和 Article 模型之间建立了双向关系,现在 User 也能通过 articles 属
性访问 Article 的实例对象了.
</p>
<blockquote>
<p>
另外,这里 back_populates 直接使用的是 "articles" 和 "author" 并没有加 &lt;table&gt;,
我理解的有两个原因,第一是因为 "关系" 在实际数据库中不是一个真实存在的数据,而是数
据库之间联系的一种概念,所以不应该使用 &lt;table&gt;.&lt;column&gt; 这种形式来引用它们, 第二,
正是因为关系是 Sqlalchemy 抽象出来方便我们操作数据的类,所以 registry 在处理它时
肯定是与数据库中真实存在的内容的映射区分开的,说不定是专门在一个存放 "关系" 实例
对象的容器中引用的.
</p>
</blockquote>
</div>
</li>

<li><a id="orge0bdffa"></a>简化关系定义<br />
<div class="outline-text-5" id="text-orge0bdffa">
<p>
上面的 User 和 Article 模型,二者都通过 db.relationship 传递 bakc_populates 参数
实现双向绑定,这种方式还是有些繁琐.我们可以修改一下代码,实现只在一个模型上定义
db.relationship 类属性,就实现双向绑定,只需要在 db.relationship 实例化时传递
backref 参数即可:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
使用 backref 参数的这种方式,删除了 User 中的 articles 属性,并将 Article 中
author 属性的 db.relationship 的 back_populates 修改成 backref. backref 参数可以
自动给对方添加 db.relationship 属性.
</p>

<p>
这种方式虽然方便,但是在模型较多,团队人数较多时很容易造成困扰,为了更直观和方便团
队协作,还是推荐使用 back_populates 实现双向绑定.
</p>

<blockquote>
<p>
backref 双向绑定可以在第一个绑定对象定义后再进行绑定,这样 db.relationship 就可以
直接使用 ORM 的映射对象了,但是又由于第一个对象中没有定义对应的 db.relationship
属性, backref 又只能使用字符串的方式,结果风格还是不统一,所以还是一直使用字符串方
式引用 ORM 对象吧,都交给 registry 处理就好了.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org6b5679c" class="outline-4">
<h4 id="org6b5679c">一对一关系</h4>
<div class="outline-text-4" id="text-org6b5679c">
<p>
一对一的关系,只需要在一对多的基础上,将 "多" 的一端设置未 "一"即可.
</p>

<p>
在 Flask-SQLAlchemy 中,给 db.relationship 传递 uselist=False 就可以将 "多" 设置
为 "一", 在数据库层面,还需要在外键上设置 unique=True. 上面的文章与用户的表格和关
系就不适合一对一,所以换成用户表以及用户信息表来举例,为了查询时的速度保证,一般将
用户的详细信息表与用户表分开存储,用用户id 作为联系. 用户和用户信息就是典型的一对
一关系,一位用户只有一条详细信息的数据,一条详细信息的数据只属于一位用户.
</p>

<p>
下面新增一个 UserInfo 模型,与原来的 User 模型建立一对一关系:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)
db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<blockquote>
<p>
这里"多" 的一端指的是字段被用作外键的表,例如 user_info 表用了 user 表的 id 字段
作为外键,那 user 表就是多的一端,所以就将 User 模型中与 UserInfo 模型的关系属性
info 的 db.relationship 中传递 uselist=False 参数.
</p>
</blockquote>

<p>
外键添加到 UserInfo 模型上,所以 UserInfo 是 "一" 端,要将其在数据库层面的实现设置
为 "一",所以将 user_id 属性设置为 unique=False, User 模型是 "多" 端,要在
Flask-SQLAlchemy 层面限制为 "一" 所以将其关系属性 info 的参数 uselist 设置为
uselist=False.
</p>

<p>
此时,如果要在一个 User 对象上添加多个 UserInfo 对象,就会抛出异常.
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)
db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/one2one"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">one2one</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">info1</span> = UserInfo(school=<span style="font-style: italic;">"&#28165;&#21326;"</span>, user=user)
    <span style="font-weight: bold; font-style: italic;">info2</span> = UserInfo(school=<span style="font-style: italic;">"&#21271;&#22823;"</span>, user=user)
    db.session.add(info1)
    db.session.add(info2)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#28155;&#21152;&#25104;&#21151;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
异常结果会显示类似异常: blablabla <b>"Duplicate entry"</b> blablabla, 主要就看
duplicate entry 显示重复的实体/条目,因为 UserInfo 模型的 user_id 属性设置了
unique=True (user_info 表的 user_id 字段设置了unique), 所以在尝试添加两条
user_id 重复的数据时会抛出异常.
</p>
</div>
</div>

<div id="outline-container-org113d32a" class="outline-4">
<h4 id="org113d32a">多对多关系</h4>
<div class="outline-text-4" id="text-org113d32a">
<p>
多对多的关系在数据库层面需要通过一张中间表来实现, Flask-SQLAlchemy 中也是一样
(ORM 是关系型数据库的抽象,当然得保持一致).文章表和标签表就很适合多对多的关系,一
篇文章可以有多个标签,一个标签也可以添加到多个文章上.
</p>


<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)
    <span style="font-weight: bold; font-style: italic;">tags</span> = db.relationship(<span style="font-style: italic;">"Tag"</span>,secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Tag</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"tag"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"tags"</span>)

<span style="font-weight: bold; font-style: italic;">article_tag_table</span> = db.Table(<span style="font-style: italic;">"article_tag_table"</span>,
                             db.Column(<span style="font-style: italic;">"article_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"article.id"</span>,primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)),
                             db.Column(<span style="font-style: italic;">"tag_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"tag.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)
                             )


db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/one2one"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">one2one</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">info1</span> = UserInfo(school=<span style="font-style: italic;">"&#28165;&#21326;"</span>, user=user)
    <span style="font-weight: bold; font-style: italic;">info2</span> = UserInfo(school=<span style="font-style: italic;">"&#21271;&#22823;"</span>, user=user)
    db.session.add(info1)
    db.session.add(info2)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
为了实现 Article 和 Tag 模型(表格)的多对多,我们用 db.Table 建立了一张新的表格
article_tag_table, 并添加了 article_id 和 tag_id 两个外键来分别关联 article 和
tag 表,然后在 Tag 和 Article 类中分别添加了 tags 和 articles 属性来建立双向关系,
并且都用 secondary="article_tag_table" 来绑定中间表.
</p>
<blockquote>
<p>
这里代码和作者代码有些许不同,作者把 article_tag_table 表格的建立写在最前面,而
Article 和 Tag 模型里使用的是 secondary=article_tag_table, 这样又使用了不同的编
写风格,而且这个风格还与代码块的顺序有关,所以我直接改用字符串,统一交给 registry
处理就好了.
</p>
</blockquote>

<p>
然后我们可以添加一个 many2many 视图函数来添加数据:
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)
    <span style="font-weight: bold; font-style: italic;">tags</span> = db.relationship(<span style="font-style: italic;">"Tag"</span>,secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Tag</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"tag"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"tags"</span>)

<span style="font-weight: bold; font-style: italic;">article_tag_table</span> = db.Table(<span style="font-style: italic;">"article_tag_table"</span>,
                             db.Column(<span style="font-style: italic;">"article_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"article.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>),
                             db.Column(<span style="font-style: italic;">"tag_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"tag.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)
                             )


db.create_all()


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/many2many"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">many2many</span>():
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"11"</span>, content=<span style="font-style: italic;">"abc"</span>)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"12"</span>, content=<span style="font-style: italic;">"abcdef"</span>)
    <span style="font-weight: bold; font-style: italic;">tag1</span> = Tag(name = <span style="font-style: italic;">"Python"</span>)
    <span style="font-weight: bold; font-style: italic;">tag2</span> = Tag(name = <span style="font-style: italic;">"Flask"</span>)
    article1.tags.append(tag1)
    article1.tags.append(tag2)
    article2.tags.append(tag1)
    article2.tags.append(tag2)
    db.session.add_all([article1,article2,tag1,tag2])
    db.session.commit()

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#22810;&#23545;&#22810;&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;!"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面的代码中,分别创建了两个 Article 和两个 Tag 对象,然后把两个 Tag 对象分别添加
到 article1 和 article2 中,最后通过 db.session.add_all 方法添加到会话中,再执行
commit 操作.
</p>

<p>
因为两个 Tag 对象都与 article 和 article2 进行了关联,所以在 article 被添加到会话
中后, 两个 Tag 对象也会被添加到会话中,在多对多关系中,添加对象使用的是 append 方
法,移出对象使用 remove 方法.
</p>

<blockquote>
<p>
上面的代码中没有显式对 article_tag_table 操作的部分,但是数据库的
article_tag_table 表中却插入了对应的记录,这就是 db.relationship 的 secondary 参
数的作用了,它帮我们完成了对应的操作,Tag 的实例与 Article 的实例建立关系后就会自
动在 secondary 设置的关系表中插入对应数据. 我的印象中,多对多的关系用原生 SQL 实
现也只是建立相应表结构,然后还是要使用语句插入对应的数据,并没有直接实现关联就自动
插入数据的,也就是说,如果用 SQL 语句,上面代码的数据需要插入两条 article 表数据,两
条 tag 表数据,还有4条 article_tag_table 数据, 或者说是编写 SQL 语句使用存储过程
来实现功能.虽然SQL 也可以实现,但用 SQL 语句实现要么需要一名数据库管理员,或者后台
开发兼职DBA, 但这样就不利于将来数据库的迁移,而且要配置的东西又多了一堆,这样看
来,ORM 模型正的是个好东西亚.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org8ea0e87" class="outline-4">
<h4 id="org8ea0e87">级联操作</h4>
<div class="outline-text-4" id="text-org8ea0e87">
<p>
级联操作(cascade) 是操作某个对象时,其关联的对象也会进行对应的操作.
</p>

<p>
数据库层面的级联操作包括级联删除,级联更新等.
</p>

<p>
Flask-SQLAlchemy 提供了比数据库更强大的级联操作. Flask-SQLAlchemy 的级联是通过对
db.relationship 传递 cascade 参数实现的,参数值可以是 all, save-update, merge,
refresh-expire, expunge, delete 中的一个或多个,多个值需要用逗号隔开(半角英文),例
如 "save-update,delete".
</p>

<p>
设置了 cascade 参数的就是父表, 父表数据变化,关联的从表数据也会执行相应操作.为了
不影响前面的数据,我们使用目录和新闻两个新的 ORM 模型来进行测试:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates(<span style="font-style: italic;">"category"</span>))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"news"</span>)

db.create_all()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的代码创建了两个模型,分别是新闻的分类模型 Category 和新闻模型 News, 并且都建
立了联系.
</p>
</div>

<ul class="org-ul">
<li><a id="org5fed2ea"></a>save-update<br />
<div class="outline-text-5" id="text-org5fed2ea">
<p>
save-update 是 cascade 的默认值,即如果不设置 cascade 就按照 save-update 的方式处
理.它的处理方式是当某个对象被添加到会话中时,与其相关联的对象也会被添加进去:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/auto-update"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">auto_update</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category(name = <span style="font-style: italic;">"&#20891;&#20107;"</span>)
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title=<span style="font-style: italic;">"&#20891;&#20107;&#26032;&#38395;1"</span>, content = <span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;1"</span>)
    <span style="font-weight: bold; font-style: italic;">news.category</span> = category
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码创建了 news 和 category 对象,但只添加和提交了 news 对象,视图函数执行完毕
后会在数据库中发现 category 对象(记录/数据)也被添加到了 category 数据库中,这是因
为它们两个对象之间建立了联系,所以默认的 cascade 选项 auto-update 将相关的对象自
动添加到会话中了.
如果把模型修改影响,将 News 模型中的 category 关系的 cascade 设置为 "" 即啥都不设
置,并取消默认值:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">""</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/auto-update"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">auto_update</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category(name = <span style="font-style: italic;">"&#20891;&#20107;"</span>)
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title=<span style="font-style: italic;">"&#20891;&#20107;&#26032;&#38395;1"</span>, content = <span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;1"</span>)
    <span style="font-weight: bold; font-style: italic;">news.category</span> = category
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后再次访问 "/auto-update" ,会发现页面正常返回 "数据添加成功,请在数据库中查看记
录",但是控制台/终端会打印消息:
</p>
<pre class="example">
Object of type &lt;Category&gt; not in session, add operation along 'News.category' won't proceed db.session.commit()
</pre>
<p>
意思是 category 这个 Category 类的实例没有添加到会话中, 所以 News 的关系属性
category 不会处理相关操作.
在数据库中会发现只有 news 数据添加了,category 数据没有添加,且新添加的 news 数据
category_id 这一字段是 NULL, 这也是因为 category 对象没有被添加到会话中的原因,因
为我们将 "关系" 交给了 Sqlalchemy 处理,所以前面都没有直接在对象实例化时设置外键
的值,而是设置 "关系",其他的交给 Sqlalchemy 处理,但由于这次 cascade 没有被设置为
save-update, 关联的对象 category 没有被添加到会话中,所以获取不到值,自然就为 NULL
了.
</p>

<blockquote>
<p>
以前没有接触过 ORM 模型的时候用过 C# 操作数据库的,那时侯外键的值之类的全都是需要
自己处理,基本就是换了个环境编写和执行原生的 SQL 语句, ORM 将数据库中的关系概念抽
象出来了,确实方便很多.
</p>
</blockquote>
</div>
</li>

<li><a id="orgb9c38ba"></a>delete<br />
<div class="outline-text-5" id="text-orgb9c38ba">
<p>
delete 表示当删除某个对象时,被关联的所有对象都会删除,
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">"delete"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/delete"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cascade_delete</span>():
    <span style="font-weight: bold; font-style: italic;">news</span> = News.query.first()
    db.session.delete(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#21024;&#38500;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
访问 "/delete" 后查看数据库表,会发现上面的视图函数中只删除了 news 对象,但是
category 表对应的记录/数据也被删除了.
</p>

<blockquote>
<p>
emm 这个级联给我的印象是记忆中一个叫做触发器的东西,搜索了下,它们的功能确实有些类
似,总之 ORM 的 "关系" 功能真的好用啊,将多个数据库里不同的概念/操作都用一个
relationship 完成了.
</p>
</blockquote>
</div>
</li>

<li><a id="orgd3b2ef8"></a>delete-orphan<br />
<div class="outline-text-5" id="text-orgd3b2ef8">
<p>
delete-orphan 表示某个对象被父表解除关联时,该对象也会自动被删除(与 delete 不同的
地方).当然了,如果父表中的数据被删除,该对象也会被删除(与 delete 相同的地方).
</p>

<p>
将 Category 的关系属性 newses 修改,然后在视图函数里执行删除操作:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/delete-orphan"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cascade_delete_orphan</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category.query.first()
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title = <span style="font-style: italic;">"&#26032;&#38395;2"</span>, content=<span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;2"</span>)
    category.newses.append(news)
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23558; news &#20174; category &#20013;&#35299;&#38500;&#20851;&#32852;</span>
    category.newses.remove(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#21024;&#38500;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的代码先将 news 对象添加到 category.newses 关系属性中,然后通过 commit 操作提
交到数据库.然后又将关系移除(解除关联),因为 Category 的 newses 属性设置了 cascade
为 delete-orphan ,所以一旦解除了关联, newses 对象绑定的 news 就成了 orphan(孤儿),那
么就会自动从数据库中被删除. 这个一般用在一对多的关系,不能用于多对多和多对一,比如
上面的例子,删除了一条新闻数据(多),不会影响到新闻分类(一),删除了新闻分类,该分类的
新闻都被删除了,才符合实际.
</p>

<blockquote>
<p>
作者的代码中是没有 session.add 的,事实上学到这里我就觉得这个作者的示例代码经常有
问题,要么像这里一样不能运行,要么像之前一样关键用法也不说明,直接就摆上代码.
</p>

<p>
session.add 是添加记录用的,如果不加上的话,上面第一个commit 之前的语句就相当于创
建了两个对象 category 和 news 然后进行了一些操作,却没有将这些映射到数据库,所以实
际上什么都不会发生,而按照作者给出的代码会报措 <code>ValueError ValueError:
list.remove(x): x not in list</code> 因为数据根本没有添加到数据库,所以数据库映射出来的
category.newses 的关系里并没有 news 对象(数据/记录).
</p>

<p>
只有执行了 session.add() 才会将改变添加到会话中再进行提交操作就将对 ORM 模型的操
作映射到数据库中了,所以这里又可以知道一点,只有一些真正改变数据库的操作才会让ORM
的操作提交到数据库中去,比如增删改查操作,或者是 Sqlalchemy 抽象出来的 "关系" 的操
作,像上面代码中的创建 news 的操作并没有将新建的对象提交到会话,因此作者书中贴出的
代码才会出错.
</p>
</blockquote>
</div>
</li>

<li><a id="org4ddef5e"></a>merge<br />
<div class="outline-text-5" id="text-org4ddef5e">
<p>
merge 也是默认的 cascade 值(它是可以有多个值的). 在使用 session.merge 合并对象时,会
使用 db.relationship 关联的对象也进行 merge 操作.
</p>

<p>
这个参数作者说很少用到,让我们了解即可.
</p>

<p>
官网的文档:
<a href="https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.merge">session.merge</a>
</p>

<p>
说是用来复制某个实例的状态到当前会话的实例中,emmm 确实不知道干啥用的, 看说明是根
据主键进行合并,合并的概念暂时不去了解了,先留下链接: <a href="https://docs.sqlalchemy.org/en/20/orm/session_state_management.html#unitofwork-merging">merging</a>
</p>
</div>
</li>

<li><a id="orgbadf33a"></a>expunge<br />
<div class="outline-text-5" id="text-orgbadf33a">
<p>
进行移除操作时,将关联的对象也移除.这个操作只将对象从 session 中移除,而不会从数据
库中删除.
</p>
<blockquote>
<p>
进行移除操作的测试时要先理解部分 session 会话的概念, 实例化的 db.Model 类对象都
是存在于 session 中的,对 session 中的对象进行增删改查等影响实际数据库内容的操作
Sqlalchemy 就会完成相应的操作,执行提交操作后就会将 session 中对象的改变映射到数
据库中. 移除操作就是在 session 中删除某个对象,这样的话不管对该对象进行任何操作,
都不会生效了,因为 commit() 对 session 中的对象生效,而该对象不在 session 中.
</p>
</blockquote>

<p>
我们将 News 模型的 category 属性的 cascade 参数修改,并在视图函数中进行测试:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">"expunge"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/expunge"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">expunge</span>():
    <span style="font-weight: bold; font-style: italic;">news</span> = News.query.first()
    <span style="font-weight: bold; font-style: italic;">category</span> = news.category
    db.session.expunge(news)
    <span style="font-weight: bold; font-style: italic;">category.name</span> = <span style="font-style: italic;">"&#27979;&#35797;&#20998;&#31867;"</span>
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#23519;&#30475;&#25968;&#25454;&#24211; category &#34920;&#20013;&#31532;&#19968;&#26465;&#25968;&#25454;&#26159;&#21542;&#25913;&#21464;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面视图函数里通过 news 表的第一条数据获取了对应的 category 表的一条数据,然后将
news 从 session 中移除了,因为 news 设置了 cascade = "expunge" 所以相关联的
category 也从 session 移除了,因此 session 中就不存在 category 了,那对 category
的 name 属性的更改就只是对某个 python 对象的属性更改,而不会被commit 操作映射到数
据库中了,因此 category 的数据不会被更改.
</p>

<blockquote>
<p>
直接修改实例对象属性值属于单条记录的更新操作,也是会影响数据库的,参见 <a href="#org4b8c7f9">update 操作</a>
</p>
</blockquote>
</div>
</li>

<li><a id="orgf4ba637"></a>all<br />
<div class="outline-text-5" id="text-orgf4ba637">
<p>
all 就是 save-update, merge, expunge, delete 的缩写,不包括 delete-orphan.
</p>
</div>
</li>

<li><a id="org69204fa"></a>默认值<br />
<div class="outline-text-5" id="text-org69204fa">
<p>
cascade 在没有进行设置时的默认值是 save-update 和 merge.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgd56b847" class="outline-3">
<h3 id="orgd56b847">ORM 模型迁移</h3>
<div class="outline-text-3" id="text-orgd56b847">
<p>
前面的代码里 ORM 模型定义好了之后,是通过 db.create_all 将 ORM 模型映射到数据库的.
</p>

<p>
这种方法只能识别到新增了模型之后映射到数据库中的对于模型中字段的修改,对于类型的
修改是无法做到的.
</p>
<blockquote>
<p>
这里的修改我暂时还不理解是什么意思,我测试了在数据库已建有表的情况下增加表格的字
段,结果抛出异常了,并不会对已有的表格生效,修改其字段属性,也没有生效,也就是说想要
用这种方法修改已有的表结构,需要先将表格删除才行.因为它只对新的表格生效.
</p>
</blockquote>

<p>
在实际开发中都不会使用 db.create_all 来做 ORM 模型的迁移(修改?), 而是借助第三方
插件 Flask-Migrate 实现.
</p>

<p>
Flask-Migrate 是基于 alembic 实现的, alembic 是专门用来给 SQLAlchemy 的 ORM 模型
做迁移的.它需要额外安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-migrate
</pre>
</div>
<p>
alembic 会自动随着 flask-migrate安装. 完成安装后就可以配置使用了.
</p>
</div>

<div id="outline-container-orgbff662d" class="outline-4">
<h4 id="orgbff662d">创建迁移对象</h4>
<div class="outline-text-4" id="text-orgbff662d">
<p>
先创建迁移对象:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">... &#20013;&#38388;&#20195;&#30721;&#30465;&#30053;</span>

db.SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
</pre>
</div>

<p>
上面代码里,先从 flask_migrate 导入了 Migrate 类,然后实例化该类时传入 app 和 db
对象,并且赋值给 migrate 变量.
<b>在后续的迁移操作时, Flask-Migrate 会自动读取 app.py 中的 migrate 变量,所以变量名必需是 migrate</b>
</p>
</div>
</div>

<div id="outline-container-org975c666" class="outline-4">
<h4 id="org975c666">初始化迁移环境</h4>
<div class="outline-text-4" id="text-org975c666">
<p>
创建迁移对象后,要初始化迁移环境.
</p>

<p>
方法是在当前目录的根目录下执行下面命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db init
</pre>
</div>
<p>
执行完成后会在项目根目录生成一个 migrations 文件夹,其中有下列内容:
</p>
<ul class="org-ul">
<li>versions 文件夹: 用于存放后面生成的迁移脚本文件.出次生成是空文件夹.</li>
<li>alembic.ini: alembic 的配置文件.</li>
<li>env.py: 配合 Flask 项目进行迁移的 Python 文件.</li>
<li>script.py.mako: 生成迁移脚本的模板文件.</li>
</ul>


<p>
上面的文件/夹,除非完全了解自己要做什么,否则不要轻易修改其内容.
</p>

<p>
到此为止,初始化迁移环境就已经完成了,后续只需要不断生成迁移脚本和映射脚本就可以完
成迁移工作,无需再次初始化.
</p>
</div>
</div>

<div id="outline-container-org1ed2330" class="outline-4">
<h4 id="org1ed2330">生成迁移脚本</h4>
<div class="outline-text-4" id="text-org1ed2330">
<p>
初始化迁移环境后,无论是新增 ORM 模型,或者是 ORM 模型的字段信息发生变化,且想要将
变化同步到数据库中,都需要将当前的修改生成一个迁移脚本,生成迁移脚本的命令如下:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db migrate -m <span style="font-style: italic;">"&#22791;&#27880;&#20449;&#24687;"</span>
</pre>
</div>
<p>
-m 添加备注信息可以方便察看迁移脚本做了哪些事情, -m 不是必需的,但是强烈推荐加上
备注.
</p>

<p>
执行完毕后,会看到 versions 文件夹中新增了一个 python 脚本文件,该文件记录了此次修
改的变更内容.
</p>
</div>
</div>

<div id="outline-container-org473c172" class="outline-4">
<h4 id="org473c172">执行迁移脚本</h4>
<div class="outline-text-4" id="text-org473c172">
<p>
迁移脚本只是写好了修改数据库的代码,但并没有更新数据库(因为这些代码并没有被执行!),所
以我们需要执行生成的迁移脚本,才能将改变映射到数据库中.
</p>

<p>
执行脚本的命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db upgrage
</pre>
</div>

<p>
上面的命令会自动从 versions 文件夹中寻找最新的迁移脚本文件,然后执行迁移脚本文件
中的 upgrage 函数. 这条命令执行完毕后,修改就真正映射到数据库中了.
</p>

<p>
flask-migrate 进行迁移操作需要注意的是,被迁移的 ORM 模型必需被 app.py 间接或直接
加载. 为了代码组织的更有序,一般会把 ORM 模型放到 models.py 文件中,如果 models.py
没有被 app.py 直接/间接加载,那么 models.py 中的 ORM 模型就不会被 flask-migrate
识别到,就不会参见迁移.
</p>

<blockquote>
<p>
这又让我向到了 session 的概念,我认为这些 ORM 模型的类以及类实例化的对象都是存在
于 session 中的,被 app.py 加载就相当于加载到了 session 中,所以 flask-migrate 很
可能就是读取 session 中的 ORM 模型的数据,然后对比数据库中表的参数执行迁移(修改)
操作的. 所以不被 app.py 加载就不能被识别的原因是 session (吧).
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-org5dbfee6" class="outline-2">
<h2 id="org5dbfee6">表单</h2>
<div class="outline-text-2" id="text-org5dbfee6">
<p>
表单是网站和用户进行交互必不可少的元素.
</p>

<p>
表单可以提供文本输入框,单选按钮,复选框,按钮等供用户提交数据.
</p>

<p>
Flask 中, 抽象出来的表单除了可以表示传统的 HTML 标签(元素)外,还有数据验证的作用.数
据被发送到服务器后,服务器会对提交的数据进行验证,因为有非正常用户会尝试提交一些 "
非法"的数据, 来获得服务器的权限或是破坏网站运行.所以要通过数据验证来保证数据合法,通
常在前端也会有数据合法性的验证和限制,但了解过爬虫或是网络安全的都知道会有各种方
法绕过限制,因此服务器端的数据验证仍然是必要的.
</p>

<p>
要实现表单的验证功能,我们需要使用插件 Flask-WTF, Flask-WTF 是对 WTForms 库的封装,让
WTForms 库在 Flask 项目中更方便的被使用,不过 Flask-WTF 提供的功能有限,大部分是直
接从 WTForms 导入的. WTForms 主要有两个功能,分别是验证数据和在模板中渲染表单HTML
标签. WTForms 也还有一些其他的功能,比如 CSRF 保护,文件上传等.
</p>

<p>
安装 Flask-WTF 同时也会安装依赖 WTForms :
激活虚拟环境:
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo06
source ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo06
</pre>
</div>



<p>
安装 Flask-Wtf
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-wtf -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<pre class="example">
Looking in indexes: https://mirrors.163.com/pypi/simple/
Collecting flask-wtf
  Downloading https://mirrors.163.com/pypi/packages/36/a9/8c01171066bd7a524ee005d81bb4a8aa446ab178043a1ad6cb5dc8f0bd83/Flask_WTF-0.14.3-py2.py3-none-any.whl (13 kB)
Requirement already satisfied: Flask in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from flask-wtf) (2.0.1)
Collecting WTForms
  Downloading https://mirrors.163.com/pypi/packages/e0/31/614fc7dc7d76005b0acb8c0c8920d962b83d7422b4ba912886dfb63f86ff/WTForms-2.3.3-py2.py3-none-any.whl (169 kB)
Requirement already satisfied: itsdangerous in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from flask-wtf) (2.1.2)
=7.1.2 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask-&gt;flask-wtf) (8.1.3)
=3.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask-&gt;flask-wtf) (3.1.2)
=2.0 in c:\users\kamisama\flask_web_py3_10\lib\site-packages (from Flask-&gt;flask-wtf) (2.2.3)
flask-wtf) (2.1.2)
=7.1.2-&gt;Flask-&gt;flask-wtf) (0.4.6)
Installing collected packages: WTForms, flask-wtf
Successfully installed WTForms-2.3.3 flask-wtf-0.14.3
</pre>

<p>
安装完毕后,创建一个 demo06 文件夹用来存放这一章的项目文件(作者创建的 formlearn
文件夹/项目)
</p>
</div>

<div id="outline-container-orgec9fd7e" class="outline-3">
<h3 id="orgec9fd7e">表单验证</h3>
<div class="outline-text-3" id="text-orgec9fd7e">
<p>
通常表单都是用来提交大量/隐私数据的,所以这里以注册的功能为例,讲解表单的验证功能.
</p>

<p>
注册时一般都需要提供邮箱,用户名,密码,确认密码4个字段的数据.
</p>

<p>
首先,在 templates 文件夹中创建一个 register.html 模板文件:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
上面代码中,创建了一个 form 表单标签,然后设置 action 为 url_for('register') ,就是
将 register 视图函数反转为 URL (就是返回 register 视图函数对应的 URL), 在点击提
交按钮时, form 表单就会将表单标签中输入框的内容都提交给这个 URL. 然后设置了
method 为 POST, 指定数据以 POST 方式提交. 然后在 form 标签下,添加了属性 name 分
别为 username, email, password 以及 confirm_password 的input 标签. 最后添加了一
个 type="submit" 的 input 标签,它会生成一个按钮,点击就会提交数据.
</p>

<p>
模板写好后,再用一个视图函数渲染该模板:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
运行项目,访问 <a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 就会看到4个输入框,一个按钮,以及对应
的说明文本,虽然样式简陋,但功能看起来和用过的注册页面差不多.
</p>
</div>

<div id="outline-container-orga509485" class="outline-4">
<h4 id="orga509485">表单类编写</h4>
<div class="outline-text-4" id="text-orga509485">
<p>
上一小节,完成了前端模板代码的编写,用于已经可以通过该简陋的注册页面输入和提交数据
了,这个页面输入的数据也是有一定要求的:
</p>
<ul class="org-ul">
<li>username : 最少要输入3位以上的字符.</li>
<li>email: 格式必须用 <code>**@example.com</code> 的格式.</li>
<li>password: 至少要输入 6 位以上字符.</li>
<li>confirm password: 该内容必需与上面的 password 内容一致.</li>
</ul>


<p>
一般来说,我们不能指望用户完全按照这些要求输入数据,如果用户输入错误,应该在页面中
进行提示.这个一般是通过前端的 JavaScript 来完成的,但是我们需要在服务器端做好验证,因
为有一定技术功底的"用户",可以通过抓包形式获取请求参数,然后用工具或代码构造请求,
来模拟注册,这样就绕开了前端的限制,而此时我们如果不在服务器端进行限制,那就会导致
错误的数据提交到程序中,好点的后果程序出错,网站崩溃,坏一点的可能就被找到漏洞,让人
黑进服务器了.
</p>

<p>
服务器端的验证可以通过 WTForms 来实现:
先在项目根目录创建一个 forms.py 文件:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])
</pre>
</div>

<p>
上面代码从 wtforms 导入 Form 基类,所有表单类都继承自 Form 类. 然后在
RegisterForm 中添加了 username, email, password 和 confirm_password 4个字段,这里
的字段名称必需和模板文件中表单元素的 name 值一致. 前面模板文件中 4 个 input 标签
的name 是 username , email , password 和 confirm_password 与这里一致.
</p>

<p>
这 4 个属性(字段)都是字符串类型,因此使用 StringField 类型,除了 StringField 外,还
有下表这些类型可以用:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Field类的类型</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">字段类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">StringField</td>
<td class="org-left">字符串类型</td>
</tr>

<tr>
<td class="org-left">IntegerField</td>
<td class="org-left">整型类型</td>
</tr>

<tr>
<td class="org-left">FloatField</td>
<td class="org-left">浮点类型</td>
</tr>

<tr>
<td class="org-left">DecimalField</td>
<td class="org-left">定点类型</td>
</tr>

<tr>
<td class="org-left">BooleanField</td>
<td class="org-left">布尔类型</td>
</tr>

<tr>
<td class="org-left">DateTimFielde</td>
<td class="org-left">日期时间类型</td>
</tr>

<tr>
<td class="org-left">DateField</td>
<td class="org-left">日期类型</td>
</tr>

<tr>
<td class="org-left">TimeField</td>
<td class="org-left">时间类型</td>
</tr>

<tr>
<td class="org-left">FileField</td>
<td class="org-left">文件类型</td>
</tr>
</tbody>
</table>

<p>
每个字段都传递了 validators 参数,这个参数可以存储多个验证器的集合. 不同的字段应
该根据实际需要设置不同的验证器:
</p>
<ul class="org-ul">
<li>username : 添加了 length 验证器,用来规定最短和最长的字符串长度,如果不在范围,会
提示错误信息,错误信息的内容为 message 指定的值.</li>
<li>email : 添加了 email 验证器,它会自动验证上传的值是否满足邮箱格式,不满足,则提示
message 指定的值.</li>
<li>password: 同样使用 length 验证器,指定长度6-20 字符.</li>
<li>confirm_password: 确认密码是否一致使用的是 equal_to 验证器,验证两个字段的值是
否相等.</li>
</ul>


<p>
除了上面使用的 length , email 和 equal_to 外,WTForms 还提供了这些验证器:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> WTForms 常用验证器</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">验证器</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">length(min,max,message)</td>
<td class="org-left">验证长度是否在区间内</td>
</tr>

<tr>
<td class="org-left">email()</td>
<td class="org-left">验证内容是否满足邮箱格式规则</td>
</tr>

<tr>
<td class="org-left">equal_to(filename,message)</td>
<td class="org-left">验证是否和另一个字段的值相等</td>
</tr>

<tr>
<td class="org-left">ip_address(message)</td>
<td class="org-left">验证是否满足 IP 地址的规则</td>
</tr>

<tr>
<td class="org-left">mac_address(message)</td>
<td class="org-left">验证是否满足 mac 地址的规则</td>
</tr>

<tr>
<td class="org-left">number_range(min,max,message)</td>
<td class="org-left">验证数字是否在指定区间</td>
</tr>

<tr>
<td class="org-left">optional(strip_whitespace)</td>
<td class="org-left">设置数据可以为空,并停止其他验证器的验证</td>
</tr>

<tr>
<td class="org-left">input_required(message)</td>
<td class="org-left">验证是否为空</td>
</tr>

<tr>
<td class="org-left">data_required(message)</td>
<td class="org-left">验证是否有效</td>
</tr>

<tr>
<td class="org-left">url(message)</td>
<td class="org-left">验证是否满足 URL 规则</td>
</tr>

<tr>
<td class="org-left">any_of(values,message, values_formatter)</td>
<td class="org-left">验证是否为 values 中的一个</td>
</tr>

<tr>
<td class="org-left">none_of( values, message, values_formatter)</td>
<td class="org-left">验证是否不是 values 中的一个</td>
</tr>

<tr>
<td class="org-left">regexp(regex, flags, message)</td>
<td class="org-left">自己指定正则表达式验证</td>
</tr>
</tbody>
</table>

<p>
这些验证器中, input_required 和 data_required 经常会被混淆, input_required 只是
验证字段是否有值, data_required 则是验证数据是否有效. 如果字段的类型是
Integerfield, 但是传入的数据不能被转换成整型(比如传入 123a ), input_required 会验证成功,因为有值
传入,但 data_required 会验证失败,因为它不能被转换成整型.
</p>

<blockquote>
<p>
验证器都是小写形式,是为了方便使用,它们的原始名称是大驼峰命名法,如 length 的原始
名称是 Length,input_required 的原始名称是 InputRequired.
</p>

<p>
其实我还是更喜欢下划线命名法,可能是 <del>学 C 语言</del> 用 linux 多的原因吧.看起来更清晰
明了
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org8e8e31a" class="outline-4">
<h4 id="org8e8e31a">视图函数中使用表单</h4>
<div class="outline-text-4" id="text-org8e8e31a">
<p>
forms.py 中创建完 RegisterForm 表单类后,就可以在视图函数里对数据进行验证了.
前面的视图函数 register 并没有写完(处理表单的部分用 pass 暂替了),现在我们就可以
完善它了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<blockquote>
<p>
运行后又有坑,邮箱验证器需要  email_validator 包提供支持,作者用的 Pycharm Pro 不
知道是不是自动安装了这些包,毕竟是有 Flask 集成的 Pro 版,反正我自己用 pip 安装是没
有的,运行会报措: <code>Exception: Install 'email_validator' for email validation support.</code>
</p>

<p>
运行下面命令安装:
pip install email_validator -i <a href="https://mirrors.163.com/pypi/simple/">https://mirrors.163.com/pypi/simple/</a>
</p>

<p>
然后就可以正常运行了.
</p>

<p>
另外,要使用 flash 消息,必需要配置 SECRET_KEY  或者直接通过 app.secret_key 设置秘
钥
</p>
</blockquote>

<p>
上面代码先创建了一个 RegisterForm 的 form 对象,并且把 request.form 作为参数传递
给 RegisterForm, request.form 是一个类字典类型,用键值对的形式保存了从浏览器中提
交的表单数据. 然后调用了 form.validate() 方法判断 RegisterForm 中定义的所有字段
是否都通过了验证,如果通过了验证,则可以用 form.&lt;字段名&gt;.data 来获取对应字段的数据,这
里是从 form 对象上获取了数据, 而不是从 request.form 上获取数据的原因,就是服务器
获取从浏览器提交的数据,本质上都是字符串类型,所以 request.form 上的所有数据都是字
符串类型,但是经过 form 对象获取的数据是经过处理的. 上面代码中没有获取
confirm_password 的值,是因为它的意义就是验证值和 password 是否一致,如果通过了,就
相等,所以没有必要再次获取.
</p>

<p>
所有数据都获取了就可以保存数据到数据库或是进行其他的操作了,如果表单验证失败了,
可以通过 form.errors 获取错误信息. form.errors 是字典类型 , key 是字段名称,
value 是错误信息的列表,假如表单中什么都不输入就点击提交按钮,那么 form.errors 的
值就会是:
</p>
<pre class="example">
{"username" : ["请输入正确长度的用户名"],
"email": ["请输入正确格式的邮箱"],
"password": ["请输入正确长度的密码"]}
</pre>
<p>
所以在表单验证失败的情况下,通过循环获取 form.errors.values() 可以获取所有内容,并
将它们存储到 flash 中. 然后就可以在模板中把 flash 消息显示出来(目前的代码,如果验
证失败不会有任何提示,虽然我们把错误消息 flash 到了浏览器的 session 中,但是前端模
板并没有读取这些消息的代码.),修改 register.html 读取flash 的消息:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span>&gt;
        {% for message in get_flashed_messages() %}
        &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
如果在浏览器中访问 <a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 什么都不输入,点击提交按钮,就会
显示下列信息:
</p>
<pre class="example">
请输入正确长度的用户名(3-20个字符)
请输入正确格式的邮箱
请输入正确长度的密码
</pre>
</div>
</div>

<div id="outline-container-orge960b88" class="outline-4">
<h4 id="orge960b88">自定义验证字段</h4>
<div class="outline-text-4" id="text-orge960b88">
<p>
虽然 Wtforms 已经提供了许多验证器,但是我们有时候还是需要根据需求自定义验证逻辑.
</p>

<p>
仍然用上面的 RegisterForm 为例子,在验证 email 字段时,除了验证 email 是否满足邮箱
格式,还需要验证邮箱是否已经被注册过了,这就必需查询数据库,来判断邮箱是否存在.如果
要自定义某个字段的验证逻辑,可以在表单类中自定义方法 validate_&lt;fieldname&gt; 来实现,
以验证 email 字段为例:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to

<span style="font-weight: bold; font-style: italic;">registed_email</span> = [<span style="font-style: italic;">'aa@example.com'</span>, <span style="font-style: italic;">'bb@example.com'</span>]

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold;">if</span> email <span style="font-weight: bold;">in</span> registed_email:
            <span style="font-weight: bold;">raise</span> ValidationError(<span style="font-style: italic;">"&#35813;&#37038;&#31665;&#24050;&#32463;&#34987;&#27880;&#20876;"</span>)
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>

<p>
这里用 registed_email 模拟从数据库中查询出的已经被注册的邮箱,真实应用中可以结合
ORM 和数据库进行查找(另外,这种把所有数据读取到程序中进行判断的思路并不现实,只做
测试用).然后在 RegisterForm 中定义了一个 validate_email(self,fiedl) 方法,以后在
视图函数中调用 form.validate() 方法进行验证时,RegisterForm 类的底层会自动调用
validate_email 方法,并且会传递一个 field 参数,这里验证的是 email ,所以这个 field
就代表 email 字段,如果验证的是其他字段,field 就代表其他字段. 然后通过 field.data
就可以那到对应的值,再进行判断,验证失败就抛出 wtforms.ValidationError 异常,并且指
定一个错误信息,这个错误信息会出现在 form.errors 中,成功就直接返回 True.
</p>
<blockquote>
<p>
这个自定义的验证器需要严格按照规则命名 validate_&lt;fieldname&gt; 因为它的生效机制都是
按照命名来得, fieldname 指定了函数内部 field 会获取哪一个字段的值, validate 开头
表示是一个验证器,在 form.validate() 验证时会自动调用. 要是格式不对,就不能生效了.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orgedf3c1d" class="outline-3">
<h3 id="orgedf3c1d">渲染表单模板</h3>
<div class="outline-text-3" id="text-orgedf3c1d">
<p>
WTForms 和 Flask-WTF 提供了将 Python 表单渲染成 HTML 表单模板的功能.
</p>

<p>
以登录为例,先实现一个登录的表单类:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, BooleanField, SubmitField, ValidationError
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> FlaskForm

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30331;&#24405;&#34920;&#21333;&#31867;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LoginForm</span>(FlaskForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(label=<span style="font-style: italic;">"Email:"</span>, validators = [email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)], render_kw={<span style="font-style: italic;">"placeholder"</span>:<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#37038;&#31665;"</span>})

    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(label=<span style="font-style: italic;">"Password:"</span>, validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)],
                           render_kw={<span style="font-style: italic;">"placeholder"</span>:<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#23494;&#30721;"</span>})
    <span style="font-weight: bold; font-style: italic;">remember</span> = BooleanField(label=<span style="font-style: italic;">"Remember Me:"</span>)
    <span style="font-weight: bold; font-style: italic;">submit</span> = SubmitField(label=<span style="font-style: italic;">"Submit"</span>)

<span style="font-weight: bold; font-style: italic;">registed_email</span> = [<span style="font-style: italic;">'aa@example.com'</span>, <span style="font-style: italic;">'bb@example.com'</span>]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34920;&#21333;&#31867;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold;">if</span> email <span style="font-weight: bold;">in</span> registed_email:
            <span style="font-weight: bold;">raise</span> ValidationError(<span style="font-style: italic;">"&#35813;&#37038;&#31665;&#24050;&#32463;&#34987;&#27880;&#20876;"</span>)
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>
<p>
新增的 LoginForm 表单类除了新使用了 Booleanfield 和 SubmitField 字段类外只新增了
label 和 render_kw 两个参数, BooleanField 和 SubmitField 字段和其他字段没什么不
同. label 会被被设置成属性 value 的值, render_kw 可以设置表单标签的一些其他属性,
比如上面的 placeholder .
LoginForm 和 RegisterForm 最大的区别是它继承自 FlaskForm 类,而不是 Form 类,
FlaskForm 的父类是 wtforms.Form 类,其在 wtforms.Form 类的基础上增加了一些方便的
方法,来让验证表单数据时,不再需要手动传入 request.form.
</p>

<p>
定义好了表单类后,就可以在视图函数中使用,因为这个表单类和模板深度结合,所以使用方
式有所不同了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(meta={<span style="font-style: italic;">"csrf"</span>:<span style="font-weight: bold; text-decoration: underline;">False</span>})
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<blockquote>
<p>
又有坑来
了
,<a href="https://stackoverflow.com/questions/71652965/importerror-cannot-import-name-safe-str-cmp-from-werkzeug-security">https://stackoverflow.com/questions/71652965/importerror-cannot-import-name-safe-str-cmp-from-werkzeug-security</a>
通过 WTForms 定义表单类并渲染表单的方式会用到 Werkzeug 包, 新版的 Werkzeug 包移
除了 safe_str_cmp, 所以上面代码运行就会报措,根据前面贴出的链接,将 Werkzeug 重新
安装成 2.0.0 且将 Jinja2 安装成 3.0.2 版本,才能正常运行.
</p>
</blockquote>
<p>
上述代码,定义一个 login 视图函数,支持 GET 和 POST 请求,然后创建一个 LoginForm 对
象,并通过传递 meta 参数关闭了 CSRF 验证(<a href="#orgc220582">CSRF 攻击</a> 中会讲到). 不同的重点在于渲染
模板的代码, 我们把 form 对象传递给了 login.html 模板,而在 login.html 模板中,就可
以使用 form 对象来渲染表单了:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Login Page</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tbody</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.email.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.password.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.submit }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;/<span style="font-weight: bold;">tbody</span>&gt;
      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
上述代码,通过 form.&lt;fieldname&gt;.label 渲染了 email, password 和 remember 三个字段
的label标签, 每个字段下面循环 form.&lt;fieldname&gt;.errors 进行验证,若验证出错,就会展
示错误信息.
再重新看看 login() 视图函数,调用 form.validate_on_submit() 判断是否通过 POST 请
求使表单验证成功,如果通过,就下一步,否则仍然渲染 login.html 模板. 此时重新渲染的
模板中传递的 form 已经保存了验证失败的信息,所以在模板中用
form.&lt;fieldname&gt;.errors 可以获取对应字段的错误信息,访问
<a href="http://127.0.0.1:5000/login">http://127.0.0.1:5000/login</a> 不输入数据,直接提交,可以看到错误信息都显示出来了.
</p>

<blockquote>
<p>
作者并不推荐使用 WTForms 和 Flask-WTF 在模板中渲染表单. 因为在 Python 类中去定义
HTML 的标签以及样式,会提高代码的耦合度,造成本该在 HTML 模块中完成的工作却要在
Python 文件中修改,这在前后端工程师共同开发时缺点尤为明显.
</p>

<p>
这点我有点体会,之前也看过一本学 Flask 的书,上来就给我用 Flask 渲染表单,给我一种
不仅要做后端开发,还要别扭的用 python 做前端工作的感觉, 一想到学这个要一个人干两
个人的活,那本书就看不下去了.印象深刻,当时其实都没看太懂,所以就记得那本书讲了个表
单我就读不下去了.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgc220582" class="outline-3">
<h3 id="orgc220582">CSRF 攻击</h3>
<div class="outline-text-3" id="text-orgc220582">
<p>
CSRF &#x2013; cross site request forgery (跨站请求伪造) 我听别人提到都简称叫跨域攻击.
CSRf 是一种网络攻击.(作者建议能理解原理是最好,暂时不能理解可以在掌握了 cookie 和
session 的相关知识再回过头理解)
</p>

<p>
CSRF 攻击原理: 网站通常都是通过 cookie 实现登录功能,浏览器访问某个网站时,会自动
把之前保存在浏览器中的 cookie 数据携带到服务器上. 如果有一个病毒网站,在其网站源
代码中有恶意的 Javascript 代码,当访问这个病毒网站时,会自动给具有 CSRF 漏洞的网站
的服务器发送请求. 因为发送请求时,浏览器会自动把网站的 cookie 数据发送给对应服务
器,而服务器并不知道请求是用户自己发送的还是由恶意代码伪造的,导致服务器接收并处理
了请求,这样就会造成损失.
比如用户曾经使用浏览器登录过 AC 站,该站没有相应的防御 CSRF 的功能,无法识别请求是
伪造的还是真实的,所以用户后面访问恶意网站时,就被伪造了请求,将 AC 站中的账户里的
硬币全部花掉了.
</p>
</div>

<div id="outline-container-org72c8972" class="outline-4">
<h4 id="org72c8972">防御 CSRF 攻击原理</h4>
<div class="outline-text-4" id="text-org72c8972">
<p>
CSRF 攻击的要点,就在于相应的 cookie 会自动发送给服务器,而服务器无法识别携带
cookie 的请求是来自真实用户还是伪造,所以,可以在用户每次访问有表单的网页时,在表单
中加入一个随机的字符串,例如 csrf_token, 同时在 cookie 中加入一个具有相通值的
csrf_token 键值对,以后再发送请求时,必需在表单和 cookie 中携带 csrf_token, 因为在
不同域名下的 Javascript 不能操作对方的 cookie ,所以服务器只有在检测到 cookie 中
的 csrf_token 和表单中的 csrf_token 相同,才会认为请求是正常的,否则就是伪造的.然
后服务器就会进行相应防御操作.
</p>

<blockquote>
<p>
这个和爬虫和反爬虫也有点像啊, 爬虫需要数据就得尽力伪造真实请求,反爬虫机制识别到
了就进行防御,不过这个 CSRF 是在别人访问恶意网站时通过浏览器发送伪造请求,而爬虫直
接就是分析网站的请求,模拟伪造请求发送.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org45bcdda" class="outline-4">
<h4 id="org45bcdda">Flask-WTF 防御 CSRF 攻击</h4>
<div class="outline-text-4" id="text-org45bcdda">
<p>
使用 Flask-WTF 可以方便地实现 CSRF 防御. CSRF 防御可以分为 3 种方式.
</p>
<ol class="org-ol">
<li>全局防御</li>
<li>表单防御</li>
<li>AJAX</li>
</ol>


<p>
三种方式的前提是 cookie 中已经设置好了 csrf, 然后再从表单中获取 csrf_token, 二者
进行比对,一致则通过验证,否则验证失败.
</p>

<p>
<b>全局防御</b>
CSRF 全局防御是通过 Flask-WTF 中的 CSRFProtect 类实现的,它接收 app 作为参数,使用
CSRFProtect 创建对象后,它会自动在 Jinja2 模板的上下文(context) 中添加 csrf_token
函数,然后通过在模板中调用这个函数,就会自动生成 csrf_token.
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20026; app &#35774;&#32622; CSRF &#38450;&#24481;</span>
<span style="font-weight: bold; font-style: italic;">app.secret_key</span> = <span style="font-style: italic;">"&#33258;&#23450;&#20041;&#30340; app &#23494;&#38053;"</span>
CSRFProtect(app)

<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(meta={<span style="font-style: italic;">"csrf"</span>:<span style="font-weight: bold; text-decoration: underline;">False</span>})
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
使用注册页面 register.html 为例,添加 csrf_token:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span>&gt;
        {% for message in get_flashed_messages() %}
        &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
修改后的 register.html 添加了一个 type 为 hidden 的input 标签,它不会被显示在浏览
器上,但是点击提交按钮时,它的值仍然会发送给服务器. 这个标签的 name 设置为了
csrf_token, 除非通过配置文件进行了修改,否则,必须将值设置为 csrf_token, 接着调用
csrf_token() 函数,设置 value 值. 这样渲染模板后,在
<a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 察看网页源代码,可以看到类似的 input 标签:
</p>
<pre class="example">
&lt;input type="hidden" name="csrf_token" value="IjdiNGFlOTg4ODY5N2NlOTZiYzMwN2UyYzQwNTFmMjU0MGRkMjZmYTIi.ZEeBXg.HrHQkLzkgThu5gt7VuFQTl8KF5o"&gt;
</pre>
<p>
表单中有 csrf_token 之后,在视图函数中调用 form.validate() 方法时, RegisterForm
会自动对比 request.form 中的 csrf_token 是否和 cookie 中的 csrf 值相等,相等就通
过验证,否则验证失败.
</p>

<p>
<b>单表单防御</b>
单表单防御是通过在模板中传递 FlaskForm 子类实现的,也就是<a href="#orgedf3c1d">渲染表单模板</a> 中登录功能
的实现. FlaskForm 子类默认是开启 csrf 防御的,如果想要关闭,在创建表单对象时传递
meta={"csrf":False} 就可以了,不传递这个参数就默认开启 CSRF 防御了. 在 login.html
中只要渲染 form.csrf_token, 就会自动生成 type 为 hiddern 类型的 input 标签:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Login Page</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tbody</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.csrf_token }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.email.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.password.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.submit }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;/<span style="font-weight: bold;">tbody</span>&gt;
      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20026; app &#35774;&#32622; CSRF &#38450;&#24481;</span>
CSRFProtect(app)

<span style="font-weight: bold; font-style: italic;">app.config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm()
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
访问 <a href="http://127.0.0.1:5000/login">http://127.0.0.1:5000/login</a> 察看网页源代码,会看到类似这样的 input 标签:
</p>
<pre class="example">
&lt;input id="csrf_token" name="csrf_token" type="hidden" value="IjdiNGFlOTg4ODY5N2NlOTZiYzMwN2UyYzQwNTFmMjU0MGRkMjZmYTIi.ZEeDsg.tKBe_BowLYOtC0aCvX10dxXY6qo"&gt;
</pre>
<p>
同样的,在视图函数中调用 form.validate() 方法会自动比对cookie 和 form 提交的
csrf, 判断是否通过验证.
</p>

<p>
<b>使用AJAX</b>
使用 AJAX 提交表单数据,前提是开启全局 CSRF 保护.
</p>

<p>
为了方便,我们可以在HTML父模板中的 head 标签内添加一个 meta 标签,然后把
csrf_token 添加到该标签中,这样所有子模板都可以获取到 csrf_token:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"base.css"</span>/&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> {% block title %}{% endblock %} </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
    {% block head %}{% endblock %}
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"body"</span>&gt;
      {% block body %}
      {% endblock %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"footer"</span>&gt;
      {% block footer %}
      <span style="font-weight: bold; font-style: italic;">&amp;copy;</span>Copyright 2008 by &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"http://domain.invalid/"</span>&gt;you&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endblock %}&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
在使用 Javascript 发送请求前,先从模板获取 csrf_token, 然后再设置到请求头中.
Flask-WTF 验证 csrf_token ,除了用 cookie 和表单中的值比对外,还会用 cookie 和请求
头中的值进行对比,从请求头中获取,是通过 X-CSRFToken 参数获取的.
</p>

<p>
以 jQuery 为例,设置每次发送请求之前都添加好 csrf_token:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">csrftoken</span> = $(<span style="font-style: italic;">'meta[name=csrf_token]'</span>.attr(<span style="font-style: italic;">'content'</span>))
$.ajaxSetup({
    beforeSend:
    <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">xhr</span>, <span style="font-weight: bold; font-style: italic;">settings</span>){
        <span style="font-weight: bold;">if</span>(!<span style="font-style: italic;">/^(GET|HEAD|OPTIONS|TRACE)$/</span>i.test(settings.type) &amp;&amp; !<span style="font-weight: bold; text-decoration: underline;">this</span>.crossDomain)
            xhr.setRequestHeader(<span style="font-style: italic;">"X-CSRFTOKEN"</span>, csrftoken)
        }
    })
</pre>
</div>
<p>
上面的代码,先从模板文件中获取了 csrf_token 的值, 然后通过设置 beforeSend 方法,在
每次发送请求之前都把 csrf_token 设置到请求头中,这样就可以完成 csrf 的验证了.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: kamisama</p>
</div>
</body>
</html>
