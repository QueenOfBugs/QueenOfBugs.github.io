<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title> Flask Web 全栈开发实战</title>
<meta name="author" content="kamisama" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
// @license-end
</script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="./index.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title"> Flask Web 全栈开发实战</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org6b94c3d">环境搭建</a>
<ul>
<li><a href="#org296b5dc">Python 环境</a></li>
<li><a href="#orgcf3e541">Flask 版本</a></li>
<li><a href="#orgfe25dfb">开发软件以及虚拟环境搭建</a></li>
<li><a href="#orge2568fb">Org mode 里运行项目的设置</a></li>
</ul>
</li>
<li><a href="#orgcf502c6">项目配置</a>
<ul>
<li><a href="#org6146bee">Debug 模式, Host, Port 配置</a>
<ul>
<li><a href="#org7016295">Debug 模式</a></li>
<li><a href="#orgbe366ad">设置 Host 和 Port</a></li>
</ul>
</li>
<li><a href="#org5eb2cb7">在 app.config 中添加配置</a>
<ul>
<li><a href="#orgfbeca22">使用 app.config 配置</a></li>
<li><a href="#orge9fb123">使用 Python 配置文件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb76e963">URL 和视图</a>
<ul>
<li><a href="#org16fb3e1">定义 URL</a>
<ul>
<li><a href="#org4cbda15">定义无参数的URL</a></li>
<li><a href="#orgdfbe32c">定义有参数的URL</a></li>
</ul>
</li>
<li><a href="#orge9fad70">HTTP 请求方法</a></li>
<li><a href="#orgaf5446e">页面重定向</a></li>
<li><a href="#org1e8b24a">构造 URL</a></li>
</ul>
</li>
<li><a href="#org10f3962">Jinja2 模板</a>
<ul>
<li><a href="#orgf7049cb">模板的基本使用</a>
<ul>
<li><a href="#orgc3d7e60">渲染模板</a></li>
<li><a href="#org678c407">渲染变量</a></li>
</ul>
</li>
<li><a href="#orga618d82">过滤器和测试器</a>
<ul>
<li><a href="#org8a499e5">自定义过滤器</a></li>
<li><a href="#orgd7e9263">Jinja2 内置过滤器</a></li>
<li><a href="#orgcd51e36">测试器</a></li>
</ul>
</li>
<li><a href="#org34b87de">控制语句</a>
<ul>
<li><a href="#org659a288">if 判断语句</a></li>
<li><a href="#org1b76628">for 循环语句</a></li>
</ul>
</li>
<li><a href="#orgaceb1a4">模板结构</a>
<ul>
<li><a href="#orge3c75d3">宏和 import 语句</a></li>
<li><a href="#orgde3420c">模板继承</a></li>
<li><a href="#org8ad7329">引入模板</a></li>
</ul>
</li>
<li><a href="#org11dbe31">模板环境</a>
<ul>
<li><a href="#org24fccea">模板上下文(context?)</a></li>
<li><a href="#orgee6a8f8">全局函数</a></li>
<li><a href="#org51928e2">Flask 模板环境</a></li>
</ul>
</li>
<li><a href="#org26bb167">其他</a>
<ul>
<li><a href="#org3adced1">转义</a></li>
<li><a href="#org56489eb">加载静态文件</a></li>
<li><a href="#org25463c5">闪现消息</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org31df5f6">数据库</a>
<ul>
<li><a href="#orga365c2f">准备工作</a>
<ul>
<li><a href="#orge18bd54">MySQL 软件</a></li>
<li><a href="#org028613e">Python 操作 MySQL 驱动</a></li>
<li><a href="#org1078acc">Flask-SQLAlchemy</a></li>
</ul>
</li>
<li><a href="#org081b143">Flask-SQLAlchemy 的基本使用</a>
<ul>
<li><a href="#org16abe9b">连接 MySQL</a></li>
<li><a href="#org4b2da7a">ORM模型</a></li>
<li><a href="#org9309e5a">CRUD 操作</a></li>
</ul>
</li>
<li><a href="#org8f1ce5e">表关系</a>
<ul>
<li><a href="#orgd266ccd">外键</a></li>
<li><a href="#org6e8cf7b">一对多关系</a></li>
<li><a href="#orgf12d702">一对一关系</a></li>
<li><a href="#org896c7b2">多对多关系</a></li>
<li><a href="#orgad73789">级联操作</a></li>
</ul>
</li>
<li><a href="#org544cf63">ORM 模型迁移</a>
<ul>
<li><a href="#orgd06e655">创建迁移对象</a></li>
<li><a href="#org4345e72">初始化迁移环境</a></li>
<li><a href="#orgfb4435b">生成迁移脚本</a></li>
<li><a href="#orgd0de3ca">执行迁移脚本</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd42e2c5">表单</a>
<ul>
<li><a href="#org7231ebd">表单验证</a>
<ul>
<li><a href="#org95c1c0c">表单类编写</a></li>
<li><a href="#orgde77770">视图函数中使用表单</a></li>
<li><a href="#orgadc778a">自定义验证字段</a></li>
</ul>
</li>
<li><a href="#org162b946">渲染表单模板</a></li>
<li><a href="#org26ded82">CSRF 攻击</a>
<ul>
<li><a href="#orge760275">防御 CSRF 攻击原理</a></li>
<li><a href="#org1996304">Flask-WTF 防御 CSRF 攻击</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd55657a">Flask 进阶</a>
<ul>
<li><a href="#orgb9622e8">类视图</a>
<ul>
<li><a href="#org8854176">基本使用</a></li>
<li><a href="#org8baa81b">方法限制</a></li>
<li><a href="#org2ac86c8">基于方法的类视图</a></li>
<li><a href="#org243d6d8">添加装饰器</a></li>
</ul>
</li>
<li><a href="#orgd90d84a">蓝图</a>
<ul>
<li><a href="#org11fd3d2">基本使用</a></li>
<li><a href="#org2e3c18a">寻找模板</a></li>
<li><a href="#org1ea3730">寻找静态文件</a></li>
</ul>
</li>
<li><a href="#org8bf2e9a">cookie 和 session</a>
<ul>
<li><a href="#org7d03b32">关于 cookie 和 session 的介绍</a></li>
<li><a href="#org4af7804">Flask 中使用 cookie 和 session</a></li>
</ul>
</li>
<li><a href="#org5c5efde">request 对象</a></li>
<li><a href="#orge6cf06a">Flask 信号机制</a>
<ul>
<li><a href="#orga7c8da2">自定义行号</a></li>
<li><a href="#org016d594">Flask 内置信号</a></li>
</ul>
</li>
<li><a href="#org8823c22">常用钩子函数</a>
<ul>
<li><a href="#org2fb48bd">before_first_request</a></li>
<li><a href="#org5b0dca0">before_request</a></li>
<li><a href="#orgbed8c39">teardown_appcontext</a></li>
<li><a href="#orge5774c9">context_processor</a></li>
<li><a href="#org5d4c83e">errorhandler</a></li>
</ul>
</li>
<li><a href="#org18726a3">上下文</a>
<ul>
<li><a href="#org526b544">线程隔离对象</a></li>
<li><a href="#orgd3eec7e">LocalStack 类</a></li>
<li><a href="#orgca7d499">LocalProxy 类</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org981b76f">缓存系统</a>
<ul>
<li><a href="#org994bddc">Memcached</a>
<ul>
<li><a href="#org884f6dd">安装 Memcached</a></li>
<li><a href="#org1e50877">telnet 操作 Memcached</a></li>
<li><a href="#orgf7f244e">Python 操作 Memcached</a></li>
<li><a href="#org8e4d3a0">Memcached 的安全性</a></li>
</ul>
</li>
<li><a href="#org31752f0">Redis</a>
<ul>
<li><a href="#org7576512">Redis 使用场景</a></li>
<li><a href="#orge6d64dc">Redis 和 Memcached 比较</a></li>
<li><a href="#org7732869">Redis 的安装与使用</a></li>
<li><a href="#orgc5966a2">Redis 操作命令</a></li>
<li><a href="#orgeb6ef18">同步数据到硬盘</a></li>
<li><a href="#org3fb2029">设置密码</a></li>
<li><a href="#org1fe8cf8">Python 操作 Redis.</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org33cbf50">项目实战</a>
<ul>
<li><a href="#org6213e93">创建项目</a>
<ul>
<li><a href="#org5db62f9">config.py 文件</a></li>
<li><a href="#org3886962">exts.py 文件</a></li>
<li><a href="#orgc49e9bc">blueprints 模块</a></li>
<li><a href="#orgee6ca0e">models 模块</a></li>
</ul>
</li>
<li><a href="#org98c4418">创建用户相关模型</a>
<ul>
<li><a href="#orgbbfae29">创建权限和角色</a></li>
<li><a href="#orgf379709">创建用户模型</a></li>
<li><a href="#org2663ee6">创建测试用户</a></li>
<li><a href="#org80c1c09">创建管理员</a></li>
</ul>
</li>
<li><a href="#org3a05cdc">注册</a>
<ul>
<li><a href="#org4f2131a">渲染注册模板</a></li>
<li><a href="#org456fc8b">使用 Flask-Mail 发送邮箱验证码</a></li>
<li><a href="#org93f5eb2">使用 Flask-Caching 和 Redis 缓存验证码</a></li>
<li><a href="#org766e6a4">使用 Celery 发送邮件</a></li>
<li><a href="#org07048df">RESTful API</a></li>
<li><a href="#org56c9c6d">CSRF 保护</a></li>
<li><a href="#org44e0a92">使用 AJAX 获取邮箱验证码</a></li>
<li><a href="#orgb914b68"><span class="todo TODO">TODO</span> 实现注册功能</a></li>
</ul>
</li>
<li><a href="#org440a569">登录</a></li>
<li><a href="#org09da87d">发布帖子</a>
<ul>
<li><a href="#orgc3d81a6">添加帖子相关模型</a></li>
<li><a href="#org08d7ea0">初始化板块数据</a></li>
<li><a href="#org94a3dac">渲染发布帖子模板</a></li>
<li><a href="#org0a10f78">使用 wangEditor 富文本编辑器</a></li>
<li><a href="#orgf4b87a6">未登录限制</a></li>
<li><a href="#org984c6cd">服务端实现发帖功能</a></li>
<li><a href="#orgebd4a29">使用 AJAX 发布帖子</a></li>
</ul>
</li>
<li><a href="#org307ef04">首页</a>
<ul>
<li><a href="#orgde2540a">生成帖子测试数据</a></li>
<li><a href="#org963083e">使用 Flask-Paginate 实现分页</a></li>
<li><a href="#org299fdf4">过滤帖子</a></li>
</ul>
</li>
<li><a href="#org686c917">帖子详情</a>
<ul>
<li><a href="#org47b505b">动态加载帖子详情数据</a></li>
<li><a href="#org56d2939">发布评论</a></li>
</ul>
</li>
<li><a href="#org47c6993">个人中心</a>
<ul>
<li><a href="#org7e2b221">使用 Flask-Avatars 生成随机头像</a></li>
<li><a href="#org17b69f8">修改导航条上的登录状态</a></li>
<li><a href="#orgea5273d">根据用户显示个人中心</a></li>
<li><a href="#org123199c">修改用户信息</a></li>
</ul>
</li>
<li><a href="#org89bc5cb">CMS 管理系统</a>
<ul>
<li><a href="#orgd7e43bf">CMS 入口</a></li>
<li><a href="#org25a04f1">权限管理</a></li>
<li><a href="#org8947633">员工管理页面</a></li>
<li><a href="#orgf8a2773">添加员工</a></li>
<li><a href="#org0dca321">编辑员工</a></li>
<li><a href="#orge5f1ca9">管理前台用户</a></li>
<li><a href="#org1394b85">帖子管理</a></li>
<li><a href="#org3b5a8b5">评论管理</a></li>
<li><a href="#org9b1fc70">板块管理</a></li>
</ul>
</li>
<li><a href="#org716fcd7">错误处理</a></li>
<li><a href="#org1684c1f">日志</a>
<ul>
<li><a href="#orgc67b2f0">loggers模块</a></li>
<li><a href="#org996c933">handlers模块</a></li>
<li><a href="#org52bc74b">filters 模块</a></li>
<li><a href="#org79c4fba">formatters 模块</a></li>
</ul>
</li>
<li><a href="#org1cca4a6">部署</a>
<ul>
<li><a href="#org31fe80a">导出依赖包</a></li>
<li><a href="#org1d62643">使用 Git 上传代码</a></li>
<li><a href="#org0a12af9">生产环境的配置</a></li>
<li><a href="#orga2eb202">安装常用软件</a></li>
<li><a href="#orge091f1c">配置网站</a></li>
<li><a href="#org773c918">使用 Gunicorn 部署网站</a></li>
<li><a href="#orga2070da">使用Nginx 部署网站</a></li>
<li><a href="#org61aeff9">压力测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org43a6c3e">WebSocket实战</a>
<ul>
<li><a href="#org845b4ea">安装相应的包</a></li>
<li><a href="#org8bf77b5">创建 SocketIO 对象</a></li>
<li><a href="#org9945a17">实现登录</a></li>
<li><a href="#orgf955bab">连接和取消连接</a></li>
<li><a href="#orge0f9d00">获取在线用户</a></li>
<li><a href="#org5c1ff25">实现单聊</a></li>
<li><a href="#org1b117b1">实现群聊</a></li>
<li><a href="#orgb58bee5">完整项目代码</a></li>
<li><a href="#orgd97f277">部署项目</a></li>
</ul>
</li>
<li><a href="#orgf62f186">Flask 异步编程</a>
<ul>
<li><a href="#org66f8cec">asyncio 标准库</a>
<ul>
<li><a href="#org56daade">事件循环</a></li>
<li><a href="#orgf08c80a">协程</a></li>
<li><a href="#org0f06a04">Task(任务)对象</a></li>
<li><a href="#org50fd794">Future对象</a></li>
</ul>
</li>
<li><a href="#orgdb2ec77">aiohttp库</a></li>
<li><a href="#org63522f9">异步版 Flask 安装与异步编程性能</a>
<ul>
<li><a href="#orgde8d330">安装异步版Flask</a></li>
<li><a href="#orgc76b3b1">Flask异步编程性能</a></li>
<li><a href="#orgc8e81e4">实战&#x2013;异步发送HTTP请求</a></li>
<li><a href="#org4d2f930">使用异步SQLAlchemy</a></li>
<li><a href="#org59862d7">Jinja2开启异步支持</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<p>
:header-args: :eval never-export :results verbatim
</p>
<p>
Last modified:2024-02-16 13:27:41 kamisama
</p>
<blockquote>
<p>
全部读完,1-9 章可以全看, 10-11 更像是介绍额外知识的内容,可以简单看看,深入还是需
要文档和其他书籍补充. 全书前面内容质量较好,到了实战章节的后期内容质量下降,有错误
代码和错误的内容表述,以及部分从文档中借鉴的内容.
</p>

<p>
看完全书, Flask 简单网站完全可以自己写,但前端还是麻烦的,后端没问题了.
</p>
</blockquote>

<div id="outline-container-org6b94c3d" class="outline-2">
<h2 id="org6b94c3d">环境搭建</h2>
<div class="outline-text-2" id="text-org6b94c3d">
</div>
<div id="outline-container-org296b5dc" class="outline-3">
<h3 id="org296b5dc">Python 环境</h3>
<div class="outline-text-3" id="text-org296b5dc">
<p>
书里使用的是 Python 3.9, 作者推荐至少使用 Python 3.6 以上的版本.
</p>
</div>
</div>
<div id="outline-container-orgcf3e541" class="outline-3">
<h3 id="orgcf3e541">Flask 版本</h3>
<div class="outline-text-3" id="text-orgcf3e541">
<p>
书里的知识点和项目都基于 Flask 2.0.1.
</p>

<p>
使用 pip 安装 2.0.1 版本 flask.
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install <span style="font-weight: bold; font-style: italic;">flask</span>==2.0.1
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe25dfb" class="outline-3">
<h3 id="orgfe25dfb">开发软件以及虚拟环境搭建</h3>
<div class="outline-text-3" id="text-orgfe25dfb">
<p>
作者推荐使用 Pycharm. 但我当前的目标是使用 Org 文档进行文学编程,笔记记录等,所以
仍然尝试用这个笔记文件来进行开发以及笔记记录,也就是说用 Emacs 作为开发软件(吧).
</p>

<p>
Pycharm 创建项目会创建虚拟环境,我们也可以通过 Org-babel 创建文件/目录和执行相关
命令来创建虚拟环境.
</p>

<p>
在家目录创建一个文件夹用作这本书的项目练习目录:
我 linux 上的 Python 版本是 3.10,且安装有多个 python 版本,所以用了 3_10 的后缀区
分.
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10
</pre>
</div>

<p>
创建目录后进入该目录创建虚拟环境:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10;python -m venv ./
</pre>
</div>

<p>
或者直接
</p>
<div class="org-src-container">
<pre class="src src-sh">python -m venv ~/flask_web_py3_10
</pre>
</div>

<p>
然后就可以(一定要)激活虚拟环境了,不激活就使用的是系统安装的 python 而不是虚拟环
境里的 python.
windows 和 linux 的激活命令不一致,但一般都是叫 activate.* 的,在 bin 目录或
scripts 目录里就可以找到. 具体的激活方法在官方文档里可以找到: <a href="https://docs.python.org/3/library/venv.html#how-venvs-work">venv</a>
</p>

<p>
linux:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">source</span> ~/flask_web_py3_10/bin/activate
</pre>
</div>

<p>
Windows:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31561;&#25105;&#20999;&#25442;&#21040; Windows &#31995;&#32479;&#19978;&#22312;&#20889;&#36825;&#37096;&#20998;.</span>
<span style="font-weight: bold; font-style: italic;">#  </span><span style="font-weight: bold; font-style: italic;">~/flask_web_py3_10/Scripts/activate.bat</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30001;&#20110;&#25105;&#26159;&#22312; Emacs &#30340; org mode &#20195;&#30721;&#22359;&#37324;&#25191;&#34892;&#20195;&#30721;,&#25152;&#20197;&#36824;&#26159;&#20351;&#29992; source</span>
<span style="font-weight: bold;">source</span> ~/flask_web_py3_10/Scripts/activate
</pre>
</div>


<p>
激活了 python 虚拟环境之后,相当于在一个新安装的 python 环境下了,所以系统环境的
python 里安装的包都没了,需要重新安装.
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install <span style="font-weight: bold; font-style: italic;">flask</span>==2.0.1
</pre>
</div>

<p>
安装完毕.
</p>

<p>
下面使用 Hello World! 来测试一下环境搭建和安装的过程是否有错.
首先,创建一个 hello_world 目录,来放置这个测试项目,然后创建 flask 项目的入口文件 app.py.
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/
mkdir hello_world;<span style="font-weight: bold;">cd</span> hello_world
touch app.py
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/hello_world/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run()

</pre>
</div>

<p>
使用 tangle 将代码导出到 app.py 文件里,然后执行该文件,如果没有出错,就可以在浏览器里输入
<a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 并看到网页显示 Hello World! 了.
</p>
<div class="org-src-container">
<pre class="src src-sh">python -m flask run
</pre>
</div>

<p>
用 C-c C-c 执行上面代码块会导致 Emacs 卡死,这是因为在执行上面的代码,而上面的代码
不会自动切换到后台执行,所以才导致卡死,可以用 C-g 中断执行, Emacs 就会恢复正常了,
另外应该是有一种可以让代码块后台执行的头参数设置,我还没学习到,有空再说.
</p>

<p>
此外,其实直接运行 app.py 文件也是可以的:
</p>
<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>

<p>
浏览器的页面里出现 Hello World 就表示已经安装成功了.
</p>

<blockquote>
<p>
使用 :session 头参数可以创建一个新的缓冲区,用来执行同一个 session 的代码,虽然也
会卡死,但用 C-g 退出后只会退出卡死状态,创建的新缓冲区没有消失,且仍然在运行代码,
这个就像是 Pycharm 的终端界面一样,可以用这种方法来让代码在后台执行,同时又不影响
对代码的编辑操作.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orge2568fb" class="outline-3">
<h3 id="orge2568fb">Org mode 里运行项目的设置</h3>
<div class="outline-text-3" id="text-orge2568fb">
<p>
将代码块命名可以通过调用来执行该代码块,利用这一点,我们将运行项目的代码编写到一起,需
要时调用即可,如同IDE 的运行按钮一样.
先进入项目目录并激活虚拟环境
</p>
<div class="org-src-container">
<pre class="src src-sh" id="orgdf14178"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10
<span style="font-weight: bold;">source</span> Scripts/activate
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell" id="org300071e">ls
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcf502c6" class="outline-2">
<h2 id="orgcf502c6">项目配置</h2>
<div class="outline-text-2" id="text-orgcf502c6">
<p>
Flask 项目开发或部署到服务器上,都需要做一些配置. 这些配置可以开启或关闭一些
Flask 项目的功能,比如 Debug 模式,连接数据库参数信息等都需要通过配置才能开启.
</p>

<p>
这章的练习都放在 flask_web_py3_10/demo02 文件夹里.
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo02
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo02
</pre>
</div>
</div>



<div id="outline-container-org6146bee" class="outline-3">
<h3 id="org6146bee">Debug 模式, Host, Port 配置</h3>
<div class="outline-text-3" id="text-org6146bee">
<p>
Debug 模式表示是否开启调试模式, Host 和 Port 配置则代表项目运行使用的 Host 和监
听的端口号.
</p>

<blockquote>
<p>
网络通信需要知道主机地址以及通信工具使用的端口号,简单理解 Host 就是地址,是一个单
位大楼,而 Port 就是房间号或办事窗口号,而运行的 flask 项目就是在 Host 这个大楼的
Port 窗口/房间里处理对应事情的人员,发送到 Host 大楼,Port 窗口的消息会被 flask 项
目接收处理,这对 flask 项目来讲就是 "监听".
</p>
</blockquote>
</div>

<div id="outline-container-org7016295" class="outline-4">
<h4 id="org7016295">Debug 模式</h4>
<div class="outline-text-4" id="text-org7016295">
<p>
使用 Flask 开发项目过程中,会不断添加和修改代码,如果没有开启 Debug 模式,每次修改
后都需要重新启动项目才能看到运行效果,开启 Debug 模式后,对代码的修改被检测到后
Flask 会自动重启项目,而且,如果程序出错了,在开启 Debug 模式时,在浏览器端会显示错
误信息,并标记错误行为,这样对定位 bug 有很大帮助.
</p>

<p>
Pycharm Professional 里集成了 flask 运行环境,可以在它的编辑配置里勾选
FLASK_DEBUG, 就可以开启 Debug 模式.
</p>

<p>
用普通的方法就是在 app.run 方法里添加 debug=True 参数.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)

</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>


<p>
添加 debug 参数后运行,再修改 app.py 中的代码(Hello World 改为 Hello Flask),可以
在终端窗口看到项目重新运行了,浏览器访问 <a href="http:127.0.0.1:5000">http:127.0.0.1:5000</a> 可以看到输出结果变为
Hello Flask! 而不需要我们手动去重启项目让修改生效了.
</p>

<blockquote>
<p>
我是在 Org mode 里运行,所以用的是 Emacs 提供的 shell 终端,分一个窗口出来就可以像
IDE 一样查看终端的输出了.使用 IDE 或者直接就是在终端里运行的应该更容易观察到结果,至
少不用额外调度出 shell 的缓冲区.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello Flask!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)

</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe366ad" class="outline-4">
<h4 id="orgbe366ad">设置 Host 和 Port</h4>
<div class="outline-text-4" id="text-orgbe366ad">
<p>
Host 表示主机,Port 表示端口号. 例如,百度首页的网址: <a href="https://www.baidu.com">https://www.baidu.com</a>,
www.baidu.com 就是 Host, 443 就是 Port. https 表示该网址使用的是 https 协议,因为
https 默认的端口号是 443,所以,平常即使我们没有写明 443 端口号,浏览器也会自动请求
百度服务器的 443 端口,即使用 <a href="https://www.baidu.com">https://www.baidu.com</a> 也可以访问百度首页.
</p>

<p>
运行 Flask 项目,控制台(终端)会打印信息 <code>Running on http://217.0.0.1:5000</code>, 这表
明 Host 是 127.0.0.1, Port 是 5000.
</p>

<p>
修改 Host 和 Port 在 Pycharm Professional 上仍然在 Edit Configurations 里,找到
Additional options, 在文本框里添加 "&#x2013;port=8000" ,单击 OK, 再次运行,就可以看到监
听端口从 5000 变成 8000.修改 Host 也是在同一个文本框里添加 "&#x2013;host=0.0.0.0" 就可
以修改host 了.
</p>

<blockquote>
<p>
一般需要在一台机器上运行两个 Flask 项目时就要修改端口了,不然两个项目都监听 5000
端口就会导致其中一个不能正确运行.所以在端口号被占用的情况下,设置不同的端口号可以
让项目正常运行起来.
</p>
</blockquote>

<blockquote>
<p>
Host 不是修改为什么都可以的,必需是下面三种之一:
</p>
<ul class="org-ul">
<li>本机的局域网 IP 地址: 表示不管从本机还是局域网其他设备访问都需要通过改局域网
IP 才能访问.</li>
<li>127.0.0.1: 代表本机的 IP 地址,表示只能在本机访问.</li>
<li>0.0.0.0: 表示可以用上面两种任意一种访问.</li>
</ul>


<p>
第一种地址的访问例子: 连接在同一个局域网(WIFI) 的手机可以通过访问本机的局域网ip
来访问地址, <a href="http://局域网ip:8000">http://局域网ip:8000</a>
</p>

<p>
第二种地址的访问例子: 只能在本机的浏览器上通过输入 <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a> 来访问.
</p>

<p>
第三种地址: 上面两种访问方式都可以.
</p>
</blockquote>

<p>
非 Pycharm professional 的设置方式和设置 Debug 模式一样,在 app.run() 里添加对应
的参数 <code>port = 8000, host = "0.0.0.0"</code> 即可.
</p>
<blockquote>
<p>
port 参数只能设置整型值,host 只能设置为字符串. host设置为"0.0.0.0" 后,控制台显示
运行在 <a href="http://192.168.31.22:8000">http://192.168.31.22:8000</a> 这种形式的地址里,这个 192.168.31.22 就是局域网
地址,但是我们用 127.0.0.1 的 host 也是可以访问的.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello Flask!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>, host=<span style="font-style: italic;">"0.0.0.0"</span>, port=8000)
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5eb2cb7" class="outline-3">
<h3 id="org5eb2cb7">在 app.config 中添加配置</h3>
<div class="outline-text-3" id="text-org5eb2cb7">
<p>
除了 Debug,Host 和 Port 这三个配置之外,其他的配置参数都需要配置到 Flask 对象
(app)的 app.config 属性中,在配置较多的情况下,还会将配置放到配置文件中.
</p>
</div>

<div id="outline-container-orgfbeca22" class="outline-4">
<h4 id="orgfbeca22">使用 app.config 配置</h4>
<div class="outline-text-4" id="text-orgfbeca22">
<p>
app.config 是 Config 的对象, Config 是继承自 dict 的子类,所以可以像操作字典一样
操作它.
</p>

<p>
<b>注意: app.config 的所有配置项的名称必须大写.</b>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26377;&#25928;&#37197;&#32622;</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"asdfjk@##!"</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"RIGHT"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26080;&#25928;&#37197;&#32622;</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"test"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"Test"</span>] = <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>

<p>
app.config 里的配置项可以是 Flask 及其插件内置的一些配置项,也可以是用户自定义的
配置项.如果在开发中需要使用到 app.config 里配置好的配置项数据,就可以通过类似字典
的方式获取数据项的值:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"TEST"</span>]=<span style="font-weight: bold; text-decoration: underline;">True</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20013;&#38388;&#20195;&#30721;&#30465;&#30053;...</span>
<span style="font-weight: bold; font-style: italic;">test</span> = app.config[<span style="font-style: italic;">"TEST"</span>]
</pre>
</div>

<p>
直接对 app.config 进行设置的方法适合比较小的项目,配置东西不多时几行代码就搞定了,
但项目越大越复杂,配置项就越多, app.py 就会包含大量设置配置项的代码,这样就不够优
雅和简洁了. 所以企业开发的项目都会使用配置文件来设置配置项.
</p>
</div>
</div>

<div id="outline-container-orge9fb123" class="outline-4">
<h4 id="orge9fb123">使用 Python 配置文件</h4>
<div class="outline-text-4" id="text-orge9fb123">
<p>
在项目文件夹下创建一个 config.py 文件,用来专门存放配置项.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">config.py</span>
<span style="font-weight: bold; font-style: italic;">TOKEN_KEY</span> = <span style="font-style: italic;">"123456"</span>
</pre>
</div>

<p>
然后在 app.py 里倒入这个文件(模块):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; config &#27169;&#22359;(&#25991;&#20214;)&#37324;&#35835;&#21462;&#37197;&#32622;&#21040; app.config</span>
app.config.from_object(config)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
<span style="font-weight: bold;">print</span>(app.config[<span style="font-style: italic;">"TOKEN_KEY"</span>])
</pre>
</div>
<p>
运行项目后可以看到打印出 123456.
</p>

<p>
app.config.from_object 除了使用导入的 python 模块之外,还可以通过字符串形式加载:
<code>app.config.from_object("config")</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">file: ~/flask_web_py3_10/demo02/app.py</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">import config</span>
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; config &#27169;&#22359;(&#25991;&#20214;)&#37324;&#35835;&#21462;&#37197;&#32622;&#21040; app.config</span>
app.config.from_object(<span style="font-style: italic;">"config"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
<span style="font-weight: bold;">print</span>(app.config[<span style="font-style: italic;">"TOKEN_KEY"</span>])
</pre>
</div>

<p>
Flask 还有许多方式添加读取配置文件,如 app.config.from_file 和
app.config.from_json. 查阅 Flask 官方文档可以看到相关内容:
<a href="https://flask.palletsprojects.com/en/2.0.x/config/">configuration-handling</a>
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb76e963" class="outline-2">
<h2 id="orgb76e963">URL 和视图</h2>
<div class="outline-text-2" id="text-orgb76e963">
<div class="org-src-container">
<pre class="src src-sh" id="org0bb75d5"><span style="font-weight: bold;">source</span> ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo03/
python  app.py
</pre>
</div>


<p>
Pycharm Professional 创建 flask 项目后会自动生成 app.py 文件,里面默认代码应该如
下:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run()
</pre>
</div>

<p>
我们手动操作也要创建 app.py 文件,因为 app.py 是 flask 项目入口文件.
</p>

<p>
上面代码里 <code>@app.route()</code> 括号里的第一个参数叫做 URL, 把 <code>@app.route</code> 装饰的函数
叫做视图函数.
</p>

<p>
上面代码里 URL "<i>" 和视图函数 hello_world 绑定. 访问 URL 的规则 "</i>" 即网站的根路
径,就会执行 hello_world 函数,因为它只返回了 "Hello World!" 字符串,所以浏览器访问
时只会看到 "Hello World!".
</p>
</div>

<div id="outline-container-org16fb3e1" class="outline-3">
<h3 id="org16fb3e1">定义 URL</h3>
<div class="outline-text-3" id="text-org16fb3e1">
<p>
多数网站不可能只有首页一个页面,所以需要定义多个不同的 URL 来满足不同页面的访问需
求. URL 又分为两种,一种为无参URL, 另一种是带参URL.
</p>
</div>

<div id="outline-container-org4cbda15" class="outline-4">
<h4 id="org4cbda15">定义无参数的URL</h4>
<div class="outline-text-4" id="text-org4cbda15">
<p>
无参URL 值得是定义 URL 时不需要定义参数.例如,定义博客个人中心的页面URL
"/profile":
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"This is profile page!"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run()
</pre>
</div>

<blockquote>
<p>
这里我们说的页面 URL "/profile" 是省略了域名和端口号的,实际访问时应该用
<a href="http://127.0.0.1:5000/profile">http://127.0.0.1:5000/profile</a> 来访问. 为了方便,说明 URL 时都是省略域名和端口号的.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgdfbe32c" class="outline-4">
<h4 id="orgdfbe32c">定义有参数的URL</h4>
<div class="outline-text-4" id="text-orgdfbe32c">
<p>
其实现在大多数 URL 访问时都是带参数的.比如获取博客第10页的页面,则需要传入10到
URL 里,URL 可能为 "/blog/page/10", URL 里的10 表示页码,以参数形式传入.
</p>
<blockquote>
<p>
如果不带参数,可以想象下如果有一百个页面,就需要定义100个不带参数的 URL,
"/blog/page/1" 到 "/blog/page/100", 如果是带参数的 URL, 则只需要定义一个 URL 然
后将页码作为参数传入即可.
</p>
</blockquote>

<p>
以博客平台的每个博客详情页为例,每个博客以 ID 惟一标识:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458; ID &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(blog_id)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码里 URL "/blog/&lt;blog_id&gt;" 比之前定义的 URL 多了一对尖括号,且尖括号里有一
个 blog_id ,这个 blog_id 就是在浏览器里访问时 URL 的参数.对应视图函数
blog_detail 里也定义了一个相应的参数 blog_id. 当浏览器访问该 URL 时, Flask 接受
到请求,然后会解析 URL 中的参数 blog_id, 并将它传递给视图函数 blog_detail. 浏览器
里输入 <a href="http://127.0.0.1:5000/blog/1">http://127.0.0.1:5000/blog/1</a> 就会看到 <code>你访问的博客 ID 为: 1</code>.
</p>


<p>
URL 里的参数还可以指定数据类型,指定参数的数据类型有两点好处:
</p>
<ul class="org-ul">
<li>访问URL 时,如果传入的参数不能被转换成指定类型,例如定义URL 时指定参数为整数类型,但
是访问时传入的参数值是 hello 这种不能被转换成整型的值,那么URL 就不会被批匹配,
并抛出 404 错误,而不是匹配了URL 然后确抛出程序错误,例如浏览器传入 hello 作为
blog_id 参数值而视图函数里默认 blog_id 是整型值并做出计算,那就会导致程序错误.</li>
<li>URL 本质上是一个字符串,如果没有指定参数类型,那传入到视图函数时也是默认字符串类
型.如果指定了参数类型,传入视图函数的就是转换后的类型,更加方便.</li>
</ul>


<p>
指定参数类型的语法也很简单: <code>&lt;类型:参数名&gt;</code>,还是以 "/blog/&lt;blog_id&gt;" URL 为例,如
果要指定 blog_id 为 int 类型: 将URL 定义改为 "/blog/&lt;int:blog_id&gt;" 即可,修改后,
浏览器里访问 "/blog/hello" 就会显示 Not Found. 因为 hello 不能转换成 int 类型.
</p>

<p>
URL 中的参数可以指定为其他类型:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">参数类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">string</td>
<td class="org-left">字符串类型,可以接收"/"以外的字符</td>
</tr>

<tr>
<td class="org-left">int</td>
<td class="org-left">整型,可以接收能通过 int() 方法转换的字符</td>
</tr>

<tr>
<td class="org-left">float</td>
<td class="org-left">浮点类型,可以接收能通过 float() 方法转换的字符</td>
</tr>

<tr>
<td class="org-left">path</td>
<td class="org-left">路径,类似 string, 但是中间可以添加 "/"</td>
</tr>

<tr>
<td class="org-left">uuid</td>
<td class="org-left">UUID 类型,由一组32位的十六进制数构成</td>
</tr>

<tr>
<td class="org-left">any</td>
<td class="org-left">any 类型,可以接收备选值中的任意一个</td>
</tr>
</tbody>
</table>

<p>
上表就 any 需要额外讲解,它的用法是: <code>&lt;any(value1,value2,...):arg&gt;</code>, 例如要实现某
个分类的URL, 种类只能是 python, flask, django 之一,就可以用 any 来实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;any(python,flask,django):category&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_category</span>(category):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;&#20998;&#31867; &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(category)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
这样修改后,访问 "/blog/list/python" 会显示 "你访问的博客分类 为: python" 而访问
"/blog/list/java" 就会显示 "Not Found".
</p>

<p>
如果 URL 中要传递多个参数,就需要用斜杠("/")隔开.例如要获取某个用户的某个博客页面,需
要传递用户 id 和页码号:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"This is profile page!"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458; ID &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(blog_id)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;any(python,flask,django):category&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_category</span>(category):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;&#20998;&#31867; &#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(category)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;/&lt;int:page&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list</span>(user_id, page):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#27491;&#22312;&#35775;&#38382;&#29992;&#25143; {}, &#39029;&#38754; {}"</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
定义 URL 时,通常都追求简洁,上面博客页面 URL 通常情况下都是访问第一页的页面,如果
可以把在第一页时省略page 参数,URL 看起来会更加简洁,代码可以做如下修改:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/list/&lt;int:user_id&gt;/&lt;int:page&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list</span>(user_id, page=1):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#27491;&#22312;&#35775;&#38382;&#21338;&#23458; {}, &#39029;&#38754; {}"</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
我们只是给视图函数里的 page 参数添加了一个默认值1,这样当 URL 不带 page 参数访问
时,默认的 page 就是1,从而简化了 URL. 例如访问URL "/blog/list/10" ,会看到 "你正在
访问博客 10,页面 1".
</p>

<p>
上面代码里,定义了两个 URL, 第一格没有 page 参数,但是视图函数有 page 且默认值为1,
这样当访问不带 page 的 URL 时,就默认使用1 为 page 的值.
</p>

<p>
参数的传递还可以通过查询字符串来实现,即在 URL 后面加上 "?" 来添加参数,多个参数用
"&amp;" 连接:
</p>
<pre class="example" id="org64eebaa">
URL?参数名1=参数值1&amp;参数名2=参数值2
</pre>
<p>
查询字符串的方式传递参数不需要在 URL 里定义好参数,只需要在访问时通过 URL 传递即
可,这种方式传递的参数值可以通过 Flask 的 request.args 对象获取, 以 URL
"blog/list?user_id=10&amp;page=8" 为例获取URL 里的参数值代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/list'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_list_query_str</span>():
    <span style="font-weight: bold; font-style: italic;">user_id</span> = request.args.get(<span style="font-style: italic;">'user_id'</span>)
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">'page'</span>)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'&#27491;&#22312;&#26597;&#25214;&#30340;&#29992;&#25143;&#20026; {}, &#39029;&#38754;&#20026; {}'</span>.<span style="font-weight: bold;">format</span>(user_id, page)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
request 是线程隔离的全局对象, request.args 是继承自 dict 的对象,保存了当前请求的
查询字符串参数,可以通过字典的方式获取.
</p>

<p>
查询字符串的方式传递参数,参数是视图函数规定好的,浏览器按照规定传递,上面代码里规
定获取 user_id 和 page 参数,但如果浏览器没有按照规定传递参数,比如URL是
"/blog/list?user_id=10&amp;pig=1", 注意这个 URL 里是 pig 不是 page, 那么就会看到 "正
在查找的用户为 10, 页面为 None".
</p>

<p>
URL 中定义参数和查询字符串两种方式都可以传递参数,但还是有些区别的.
URL 中定义参数, 实际上参数是 URL 的一部分了, 查询字符串方式则是 HTTP 协议层面用
来传递参数的技术,后面还有 POST 方式传递参数(数据).
</p>

<p>
两种方法的特点总结:
</p>
<ul class="org-ul">
<li>URL 中定义参数的方式比查询字符串的方式更利于 SEO 优化,能更好被搜索引擎检索和收
录.简书的文章详情和CSDN 的博客id 就是通过URL中定义参数再传递的.</li>
<li>URL 中定义参数可以做好类型约束,不会让错误类型的数据匹配URL, 提高了程序的 <del>健壮
性</del></li>
<li>查询字符串方式传递参数更加灵活,不需要修改URL, 就可以方便的添加和修改参数.</li>
</ul>
</div>
</div>
</div>


<div id="outline-container-orge9fad70" class="outline-3">
<h3 id="orge9fad70">HTTP 请求方法</h3>
<div class="outline-text-3" id="text-orge9fad70">
<p>
HTTP 协议中,请求 URL 有不同的方法(method), 不同的请求方法有不同的应用场景.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> HTTP 请求方法以及使用方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">请求方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">GET</td>
<td class="org-left">从服务器获取资源,浏览器中输入网址访问就是默认使用 GET 请求.</td>
</tr>

<tr>
<td class="org-left">POST</td>
<td class="org-left">提交资源到服务器,如提交表单或上传文件,一般用于创建新的资源或修改已有资源</td>
</tr>

<tr>
<td class="org-left">HEAD</td>
<td class="org-left">类似于 GET 请求,响应体中不包含具体内容,专门用来获取消息头</td>
</tr>

<tr>
<td class="org-left">DELETE</td>
<td class="org-left">请求服务器上传资源</td>
</tr>

<tr>
<td class="org-left">PUT</td>
<td class="org-left">请求服务器替换或修改已有资源</td>
</tr>

<tr>
<td class="org-left">OPTIONS</td>
<td class="org-left">请求服务器返回某个资源支持的所有 HTTP 请求方法,如 AJAX 跨域请求常用 OPTIONS 方法发送嗅探请求,来判断是否有对某个资源的访问权限</td>
</tr>

<tr>
<td class="org-left">PATCH</td>
<td class="org-left">类似于 PUT 方法,但是 PATCH 一般用于局部资源更新, PUT 方法用于整个资源的替换</td>
</tr>
</tbody>
</table>

<p>
Flask 项目中使用 app.route 装饰器定义 URL 时,默认使用的就是 GET 请求,在浏览器里
输入网址访问时,默认使用的也是 GET 请求,所以可以正常访问.
</p>

<p>
想要更改 URL 的请求方法,可以在定义 URL 时,通过设置 app.route 的 methods 参数来指
定:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/add'</span>, methods = [<span style="font-style: italic;">'POST'</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_add</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; POST &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码给 method 参数赋值为一个列表,且列表中只有一个 POST 来限制了这个 URL 只能
通过 POST 方法进行访问. 如果直接在浏览器的网址里输入 '/blog/add' 访问,就会显示错
误信息 : "Method Not Allowed".
</p>

<p>
如果想要一个 URL 允许多种方法访问,可以在 methods 参数的列表中添加多个元素:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/'</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">hello_world</span>():

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">'Hello World!'</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">'/blog/add'</span>, methods = [<span style="font-style: italic;">'POST'</span>, <span style="font-style: italic;">'GET'</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_add</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">'GET'</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; GET &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
    <span style="font-weight: bold;">elif</span> request.method == <span style="font-style: italic;">'POST'</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20351;&#29992; POST &#26041;&#27861;&#28155;&#21152;&#21338;&#23458;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
修改后再次访问 '/blog/add' 的url 则会显示 "使用 GET 方法添加博客"
</p>

<p>
从 Flask 2.0 开始,添加了5个快捷路由装饰器,用于定义只接收某种类型请求方法的 URL:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 2:</span> 快捷路由装饰器</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">快捷路由装饰器</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">app.get('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["GET"])</td>
</tr>

<tr>
<td class="org-left">app.post('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["POST"])</td>
</tr>

<tr>
<td class="org-left">app.put('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["PUT"])</td>
</tr>

<tr>
<td class="org-left">app.delete('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["DELETE"])</td>
</tr>

<tr>
<td class="org-left">app.patch('/login')</td>
<td class="org-left">等价于 app.route('/login', methods=["PATCH"])</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgaf5446e" class="outline-3">
<h3 id="orgaf5446e">页面重定向</h3>
<div class="outline-text-3" id="text-orgaf5446e">
<p>
页面重定向, 一般简称为重定向. 重定向在页面中的表现就是,浏览器会自动从一个页面跳
转到另一个页面.最常见的就是访问需要登录才能访问的页面,但是用户没有登录,然后就跳
转到登录页面了.
</p>

<p>
重定向分为 <b>永久性重定向</b> 和 <b>暂时性重定向</b>:
</p>
<dl class="org-dl">
<dt>永久性重定向</dt><dd>HTTP 的状态码是 301, 多用于旧的网址已经被废弃, 要转到新的网址,
保证用户正常的访问.比如之前的京东网站用过很多其他域名,www.360buy.com
,www.jingdong.com 等,当用户不知道京东网址变成了 www.jd.com ,且前面两个域名没有
废弃之前,访问前两个网址就会自动跳转到 www.jd.com. 因为两个旧网址是要废弃的,所
以这种情况就用永久性重定向.重定向可以保证老用户正常访问,且告知他们新网址.</dd>
<dt>暂时性重定向</dt><dd>HTTP 的状态码是 302, 表示页面暂时性跳转. 访问一个需要权限的网
址,但是用户当前没有登录,这时候就应该重定向到登录页面,而且是暂时性的重定向.</dd>
</dl>


<p>
flask 里的重定向是通过 flask.redirect(location,code=302) 函数来实现的, location
是重定向的目标 URL, code 表示状态码,默认值是 302,暂时性重定向.
</p>

<p>
下面用简单的例子说明用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, redirect, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"login page"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/profile"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>():
    <span style="font-weight: bold; font-style: italic;">name</span> = request.args.get(<span style="font-style: italic;">"name"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#27809;&#26377;&#26597;&#35810;&#23383;&#31526;&#20018;&#20256;&#36882; name &#21442;&#25968;,&#20195;&#34920;&#27809;&#26377;&#30331;&#24405;,&#37325;&#23450;&#21521;&#21040;&#30331;&#24405;&#39029;&#38754;</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> name:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/login"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">return</span> name

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
直接访问 "/profile" 会重定向到 "/login" 页面,显示 "login page" ,访问
"/profile?name=admin" 就会显示 "admin"
</p>
</div>
</div>

<div id="outline-container-org1e8b24a" class="outline-3">
<h3 id="org1e8b24a">构造 URL</h3>
<div class="outline-text-3" id="text-org1e8b24a">
<p>
上面重定向时使用的 <code>redict("/login")</code> 里的 URL 是硬编码的,而URL 可能会随着发展而
变化,一旦发生改变,只要是用硬编码方式使用该 URL 的地方,在项目代码里都需要修改,会
很麻烦.而url 对应的视图函数是开发者自己使用的,一般不会发生修改,且都是可以惟一标
识的,所以我们需要使用某个 URL 时可以使用 url_for 函数,它可以根据视图函数来使用对
应的 URL.
</p>

<p>
用博客详情页的例子说明下 url_for 的用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/blog/&lt;int:blog_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">blog_detail</span>(blog_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#21338;&#23458;id &#20026;{}"</span>.<span style="font-weight: bold;">format</span>(blog_id)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/urlfor"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_url_for</span>():
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"blog_detail"</span>, blog_id=2, user=<span style="font-style: italic;">"admin"</span>)
    <span style="font-weight: bold;">return</span> url

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">'__main__'</span>:

    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
在 get_url_for 视图函数中使用了 url_for, 第一个参数是视图函数 blog_detail 的函数
名,因为 blog_detail 需要 blog_id 参数,因此将 blog_id 也作为参数传递给了 url_for,
而多出来的 user 参数在原本的 blog_detail 函数里是没有的,所以它不是必需的,因此构
建URL 时会把它作为查询字符串拼接到 URL 上. 访问 "/urlfor" 这个 URL 会看到结果:
"/blog/2?user=admin". 如果需要重定向,这样使用 url 不管要重定向的 URL 怎么变,只要
对应的视图函数不变,就不需要额外修改代码了.
</p>

<p>
使用 url_for 函数动态构建 URL 的优点:
</p>
<ul class="org-ul">
<li>URL 是对外的,可能会经常改变,但是视图函数不会经常变化,如果直接将 URL 硬编码,那
后期URL改变时,凡是硬编码了该 URL 的地方都要做修改,费时费力,而用 url_for 就可以
避免这点.</li>
<li>URL 在网络通信过程中,只能使用 ASCII 编码的数据,因此一些特殊字符,如中文就需要进
行编码才能放到 URL 中去,使用 url_for 函数可以自动进行编码设置,省时省力.</li>
</ul>


<blockquote>
<p>
我们平时在浏览器的地址栏可能看见过中文,但其实那都是浏览器做了额外处理显示出的中
文,假设访问一个 URL "127.0.0.1:5000/天", 输入到浏览器中访问,由于没有相关设置,所
以结果肯定是 Not Found, 但地址栏我们可以看见 "天" 这个中文,如果眼力好的可能会注
意到,我们输入会车开始访问后,网址中的 "天" 字是变成了一堆带百分号的字符然后又变成
"天" 字的,时间很短,但确实有这个过程,我们也可以按下 F12 打开浏览器开发工具,重新输
入网址,可以在开发工具的 "网络" 一栏找到我们刚刚输入的网址,可以看到在消息头中的网
址显示的是 "<a href="http://127.0.0.1:5000/%E5%9C%B0">http://127.0.0.1:5000/%E5%9C%B0</a>" 而没有天字,后面那个带百分号的字符就
是 "天" 字编码后的产物了.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org10f3962" class="outline-2">
<h2 id="org10f3962">Jinja2 模板</h2>
<div class="outline-text-2" id="text-org10f3962">
<p>
前面使用的视图函数都是简单的返回了一个字符串,所以看到的页面都只有很简单的一句话,
这是为了演示用的,实际开发过程中服务器响应用户请求(浏览器访问网址就是发送了请求)
的内容通常包含大量 HTML 代码,如果这些代码也放在字符串里,那代码的编写和维护就会变
成一场噩梦,因此, Flask 将 HTML 代码的渲染交给了模板引擎来完成,而 Flask 中默认配
套的模板引擎是 Jinja2, Jinja2 是一个高效,可扩展的模板引擎.
</p>

<blockquote>
<p>
Jinja2 不是 flask 的一部分,它可以独立于 flask 使用,例如在 django 里也可以使用它
来渲染 HTML 页面.
</p>
</blockquote>

<p>
Jinja2 在作者写书的时候最新版是 3.0.2 现在最新版是 3.1.2, 官方文档: <a href="https://jinja.palletsprojects.com/en/3.1.x/">最新版本文档</a>.
</p>

<p>
运行这一章的项目使用的代码:
</p>
<div class="org-src-container">
<pre class="src src-sh" id="org26dae98"><span style="font-weight: bold;">source</span> ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo04/
python app.py
</pre>
</div>
</div>

<div id="outline-container-orgf7049cb" class="outline-3">
<h3 id="orgf7049cb">模板的基本使用</h3>
<div class="outline-text-3" id="text-orgf7049cb">
</div>
<div id="outline-container-orgc3d7e60" class="outline-4">
<h4 id="orgc3d7e60">渲染模板</h4>
<div class="outline-text-4" id="text-orgc3d7e60">
<p>
Flask 项目默认在 templates 文件夹里查找模板文件, Pycharm professional 在创建
Flask 项目时会自动创建该文件夹, 其他编辑环境需要手动创建.
</p>

<p>
模板文件可以是纯文本格式的任意文件,如 TXT, HTML, XML 等,但为了与前端更好协作,一
般都使用 HTML 文件来写模板代码.
</p>

<p>
首先在 templates 文件夹下面创建一个 index.html 文件,然后输入下面代码:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> &#39318;&#39029; </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> &#36825;&#26159;&#39318;&#39029; </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
在视图函数中使用 render_template 函数渲染 index.html 模板:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
render_template 默认从当前项目的 templates 文件夹下面查找 index.html 文件,读取后
进行解析,然后再渲染成 HTML 代码返回给浏览器. 访问 <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 可以看到
用一级标题显示的 "这是首页" 四个字.因为模板中这四个字是放在 h1 标签里的.这样就是
一个最简单的模板渲染.
</p>

<blockquote>
<p>
如果对前后端交互没有了解的可能会疑惑,index.html 已经是 html 代码了,为什么还说是
先进行解析,然后再渲染成 html 代码返回给浏览器呢?这是因为通常我们要在页面中填充数
据,而这些数据通常是会改变的,不可能直接硬编码到 html 代码里,所以一般需要填充数据
的 html 代码中都有用作数据填充的代码,这些数据就需要后端传递,所谓渲染就是将数据填
充到 html 中,在上面这个简单的例子中都是硬编码的数据,并没有填充数据的过程,后面会
讲解到.
</p>
</blockquote>

<p>
如果想要修改模板文件的查找地址,可以在创建 app 对象时,给 Flask 传递一个关键字参数
template_folder 来指定模板文件的查找路径,这个 template_folder 指定的路径是相对于
项目的根目录的.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>, template_folder = r<span style="font-style: italic;">"mytemplates"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
这样操作后, render_template 函数就会在当前目录的 demo04 文件夹下面的 mytemplates
文件夹里查找模板文件.
</p>

<p>
此时再次访问首页URL <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 就会出现 TemplateNotFound 的错误提示,
这是因为我们没有创建 template_folder 参数指定的 mytemplates 文件,所以是找不到模
板文件的.解决该问题只需要把 templates 文件夹下的 index.html 复制到新创建的
mytemplates 文件夹下就可以了.
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo04/mytemplates
cp ~/flask_web_py3_10/demo04/templates/index.html ~/flask_web_py3_10/demo04/mytemplates/index.html
</pre>
</div>
</div>
</div>

<div id="outline-container-org678c407" class="outline-4">
<h4 id="org678c407">渲染变量</h4>
<div class="outline-text-4" id="text-org678c407">
<p>
上一小节提高过, HTML 文件中有数据是需要填充的,不能硬编码在 HTML 文件中. 一般做法
是,先在视图函数中将数据准备好,然后使用 render_template 函数渲染模板时将数据传递
给模板,然后 render_template 渲染并返回数据填充完整的 HTML 文件.
</p>

<p>
充当数据传递桥梁的就是变量, render_template 会将变量的数据填充到 HTML 文件中使用
变量的地方.(我的理解这个"渲染"过程就是变量做占位用,然后数据填充到相应位置)
</p>

<p>
新建一个URL 和视图函数映射:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, hobby=hobby_value)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的 variable 视图函数渲染一个 variable.html 模板,并向这个模板传递了一个 hobby
参数,表示向模板文件中一个 hobby 的变量传递数据 hobby_value.
</p>

<p>
现在我们在 templates 文件夹下面创建一个 variable.html 模板文件,输入下面代码:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#25105;&#30340;&#29233;&#22909;&#26159;: {{hobby}} </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在访问 <a href="http://127.0.0.1:5000/ariable">http://127.0.0.1:5000/ariable</a> 就可以看到 "我的爱好是游戏" 的页面内容.
html 文件中不包含 "游戏" 这两个字的数据,它是我们通过 render_template 渲染页面,使
用 hobby 变量进行传递的. 所以变量的使用可以让一个 HTML 模板(文件) 渲染出多个不同
的页面(数据不同).
</p>

<p>
模板文件数据中字典的键值和对象的属性值都可以通过 "." 点号的形式访问. 在 variable
视图函数里添加字典类型的 person 和类对象类型 user 来看模板文件如何使用这些数据:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, username, email):
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">username</span>=username
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">email</span>=email

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold; font-style: italic;">person</span> = {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#24352;&#19977;"</span>,
              <span style="font-style: italic;">"age"</span>: 18}
    <span style="font-weight: bold; font-style: italic;">user</span> = User(<span style="font-style: italic;">"&#26446;&#22235;"</span>, <span style="font-style: italic;">"lisi@qq.com"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, hobby=hobby_value, person=person, user=user)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
再在 variable.html 模板文件中通过 "." 访问 person 的键值和 user 的属性值.
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21464;&#37327;&#20351;&#29992;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#25105;&#30340;&#29233;&#22909;&#26159;: {{hobby}} </span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;person &#30340;&#22995;&#21517;&#26159;: {{person.name}}, person &#30340;&#24180;&#40836;&#26159;: {{person.age}} &lt;/<span style="font-weight: bold;">p</span>&gt;

&lt;<span style="font-weight: bold;">p</span>&gt;user &#30340;&#29992;&#25143;&#21517;&#26159;: {{user.name}},user &#30340;&#37038;&#31665;&#26159;: {{user.email}} &lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
再次访问 <a href="http://127.0.0.1:5000/ariable">http://127.0.0.1:5000/ariable</a> 可以看到如下效果:
</p>
<pre class="example" id="org4f585ac">
变量使用
我的爱好是: 游戏

person 的姓名是: 张三, person 的年龄是: 18

user 的用户名是: ,user 的邮箱是: lisi@qq.com
</pre>
<p>
字典的键值和对象的属性也可以通过括号的形式获取, <code>{{user.name}}</code> 和
<code>{{user["name"]}}</code> 是等价的
</p>

<p>
虽然效果看起来都是一样的,但它们的作用原理有所不同:
</p>
<ul class="org-ul">
<li>如果模板中有一个变量的使用方式为 foo.bar, 那么 Jinja2 中按照下面规则进行访问:
<ul class="org-ul">
<li>通过 getattr(foo, 'bar') 访问,先找这个对象的属性.</li>
<li>如果没有找到,就通过 foo.__getitem__("bar") 方式访问,即访问这个对象的键值.</li>
<li>如果上面两种方式都没有找到,返回一个 undefined 对象.</li>
</ul></li>
<li>如果模板中有一个变量的使用方式为 foo["bar"], 那么在 Jinja2 中按照下面规则进行
访问:
<ul class="org-ul">
<li>通过 foo.__getitem__("bar") 访问,先访问这个对象的键值.</li>
<li>如果没有找到,就通过 getattr(foo, "bar") 方式访问,即访问这个对象的属性.</li>
<li>如果上面两种方式都没有找到,返回一个 undefined 对象.</li>
</ul></li>
</ul>


<p>
上面示例中只传递了三个变量, 算是比较少的情况,可以分开来写,但是如果变量较多,就可
以先把所有变量存放到字典中,然后在给 render_template 传递参数时使用 <code>**</code> 语法,将
字典变成关键字参数,上面的代码用这种方法改写:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>:
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, username, email):
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">username</span>=username
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">email</span>=email

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/variable"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">variable</span>():
    <span style="font-weight: bold; font-style: italic;">hobby_value</span> = <span style="font-style: italic;">"&#28216;&#25103;"</span>
    <span style="font-weight: bold; font-style: italic;">person</span> = {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#24352;&#19977;"</span>,
              <span style="font-style: italic;">"age"</span>: 18}
    <span style="font-weight: bold; font-style: italic;">user</span> = User(<span style="font-style: italic;">"&#26446;&#22235;"</span>, <span style="font-style: italic;">"lisi@qq.com"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"hobby"</span>: hobby_value,
              <span style="font-style: italic;">"person"</span>: person,
              <span style="font-style: italic;">"user"</span>: user}
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"variable.html"</span>, **context)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
变量较多的情况都推荐使用这种方法,可以让代码变得更直观简洁,变量只有一个两个的时候
(一般很少出现这种情况吧,除非是做小测试)可以将变量全写到 render_template 参数里.
</p>
</div>
</div>
</div>

<div id="outline-container-orga618d82" class="outline-3">
<h3 id="orga618d82">过滤器和测试器</h3>
<div class="outline-text-3" id="text-orga618d82">
<p>
Python 中对变量(数据) 进行处理可以通过函数来实现,而在模板中,就要通过"过滤器"来实
现.
</p>

<p>
过滤器本质上也是函数,但是模板中的使用方式是通过管道符号(<code>|</code>) 来实现的. 例如,一个
字符串类型的变量 name, 要获取它的长度,可以通过 <code>{{name|length}}</code> 来获取, Jinja2
会把 name 当做参数传递给 length 过滤器(底层对应的函数).length 是 Jianja2 内置的
过滤器, Jinja2 内置了许多好用的过滤器,而且还可以自定义过滤器.
</p>

<blockquote>
<p>
管道的用法学过 linux 的 shell 脚本的应该不会陌生,简单理解为管道左边的作为参数传
递到管道右边.
</p>
</blockquote>
</div>

<div id="outline-container-org8a499e5" class="outline-4">
<h4 id="org8a499e5">自定义过滤器</h4>
<div class="outline-text-4" id="text-org8a499e5">
<p>
过滤器本质上是 Python 的函数,它把管道符号左边的值(被过滤的值)当做第一个参数传递
给过滤器这个函数,值(数据)经过处理后,再返回新的值.
</p>

<p>
过滤器函数写好后可以通过 <code>@app.template_filter</code> 装饰器或
<code>app.add_template_filter</code> 函数来把自定义的过滤器函数注册成为 Jinja2 能用的过滤器.
</p>

<p>
一个自定义的格式化时间的过滤器为例子:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime <span style="font-weight: bold;">as</span> dt
<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">datetime_format</span>(value, <span style="font-weight: bold;">format</span>=<span style="font-style: italic;">"%Y-%d-%m %H%M"</span>):
    <span style="font-weight: bold;">return</span> value.strftime(<span style="font-weight: bold;">format</span>)

app.add_template_filter(datetime_format, <span style="font-style: italic;">"dformat"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_filter</span>():
    <span style="font-weight: bold; font-style: italic;">article</span> = {<span style="font-style: italic;">"pub_date"</span>: dt.now()}
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>,article=article)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码定义了一个 datetime_format 函数,第一个参数是需要处理的值,第二个参数是时
间的格式,并指定了一个默认值. 然后用 <code>app.add_template_filter</code> 将这个函数注册成为
了过滤器,且这个过滤器的名字叫做 dformat, 然后在模板文件里,就可以使用这个过滤器
dformat 了,而如果 add_template_filter 没有第二个参数,那过滤器名就默认是函数名了.当
然也可以使用 <code>@app.template_filter(datetime_format)</code> 装饰器来注册过滤器,这个代码
也是注册 datetime_format 作为过滤器,过滤器名默认为 datetime_format 这个函数名.
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#33258;&#23450;&#20041;&#36807;&#28388;&#22120;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#33258;&#23450;&#20041;&#36807;&#28388;&#22120;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
{{article.pub_date|dformat}}
{{article.pub_date|dformat("<span style="font-weight: bold; font-style: italic;">%B</span> <span style="font-weight: bold; font-style: italic;">%Y</span>")}}

  &lt;<span style="font-weight: bold;">div</span>&gt;default &#36807;&#28388;&#22120;: {{ ""|default('admin', boolean=True)}}&lt;/<span style="font-weight: bold;">div</span>&gt;

&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd7e9263" class="outline-4">
<h4 id="orgd7e9263">Jinja2 内置过滤器</h4>
<div class="outline-text-4" id="text-orgd7e9263">
<p>
了解了 Jinja2 过滤器原理之后,再学习和使用 Jinja2 内置的过滤器就容易理解了.
Jinja2 内置了许多过滤器,不需要全部记住(用多了自然就记住了),只需要在使用的时候翻
阅文档即可. Jinja2 官方文档: <a href="https://jinja.palletsprojects.com/en/3.1.x/templates/#list-of-builtin-filters">List of Builtin filters</a> . 作者写书时 Jinja2 还是
3.0.x 版本,现在最新到了 3.1.x 了.
</p>

<p>
Jinja2 内置过滤器:
</p>
<dl class="org-dl">
<dt>abs(value)</dt><dd>获取 value 的绝对值</dd>
<dt>default(value, default_value, boolean=False)</dt><dd><p>
如果 value 没有定义,则返回第二
个参数 default_value. 如果要让 value 在判断为 False 的情况下使用
default_value, 就将 boolean 参数设置为 True:
</p>
<pre class="example" id="org0526003">
&lt;div&gt;default 过滤器: {{ user|default('admin')}}&lt;/div&gt;
</pre>
<p>
如果 user 没有定义,那么将会使用 admin 作为默认的值.
</p>
<pre class="example" id="orgc461d15">
&lt;div&gt;default 过滤器: {{ ""|default('admin', boolean=False)}}&lt;/div&gt;
</pre>
<p>
因为 "" (空字符串) 在使用 if 时会判断返回 False,所以这时如果想要使用默认值
admin 就必需加上 boolean=True, 表示会对 value 进行 if 判断.
</p></dd>
<dt>escape(value)</dt><dd>将一些特殊字符进行转移,如 <code>&amp;,&lt;,&gt;,",'</code>. 因为 Jinja2 默认开启了
全局转义,所以大部分情况下无需手动使用这个过滤器进行转义,只有关闭了全局转义的情
况下,才会需要使用到它.</dd>
<dt>filesizeformat(value,binary=False)</dt><dd>将值格式化为方便阅读的单位.例如 13KB,
4.1MB, 102Bytes 等等. 默认的单位是 Mega, Giga, 即相邻单位换算是1:1000. 如果
binary 设置为 True, 则使用二进制的换算,相邻单位换算是 1:1024.</dd>
<dt>first(value)</dt><dd>返回 value 序列的第一格元素.</dd>
<dt>float(value,default=0.0)</dt><dd>将 value 转换成浮点类型,如果转换失败会返回 0.0 .</dd>
<dt>format(value,*args,**kwargs)</dt><dd><p>
格式化字符串,示例代码如下
</p>
<pre class="example" id="org2822ce0">
{{ "%s,%s"|format(greeting, name) }}
</pre></dd>
<dt>groupby(value, attribute, default=None)</dt><dd><p>
value 是一个序列,可以使用参数
attribute 进行分组. 例如,如果有一个 users 列表,里面每个 user 都有一个属性
city, 要将 user 按照 city 分组,可以用下面代码实现:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;

  &lt;<span style="font-weight: bold;">ul</span>&gt;
    {% for group in users|groupby("city") %}
    &lt;<span style="font-weight: bold;">li</span>&gt;{{ group.grouper}}: {{ group.list|join(", ")}}&lt;/<span style="font-weight: bold;">li</span>&gt;
    {% endfor %}
  &lt;/<span style="font-weight: bold;">ul</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
这些 <code>%</code>,for, in 之类的就是模板里使用语句块的语法,不同的模板引擎语法可能会有不
同,但大体上应该都差不多. Jinja2 是 Python 的模板引擎,所以上面的用法也和 python
语法有点像.
</p></dd>
<dt>int(value,default=0,base=10)</dt><dd>转换成整型,如果转换失败会返回0,默认按照10进制
转换.</dd>
<dt>join(value,attribute)</dt><dd>使用 attribute 指定的元素,将一个序列拼接成一个字符串.和
Python 中的 join 方法类似.</dd>
<dt>last(value)</dt><dd>返回 value 序列的最后一个元素.</dd>
<dt>length(value)</dt><dd>返回 value 序列的长度.</dd>
<dt>list(value)</dt><dd>转换 value 为一个列表.</dd>
<dt>lower(value)</dt><dd><p>
转换 value 为全部小写.如果要将 titles 序列中每个元素都转换为全
部小写:
</p>
<pre class="example" id="org2a5b367">
{{ titles|map('lower') }}
</pre></dd>
<dt>map(value, *args, **kwargs)</dt><dd><p>
将 value 这个序列都执行某个操作,如获取 users 这
个序列中每个 user 的 username 字段:
</p>
<pre class="example" id="org488acd9">
{{ users|map(attribute="username") }}
</pre></dd>
<dt>max(value)</dt><dd>求序列中的最大值</dd>
<dt>min(value)</dt><dd>求序列中的最小值</dd>
<dt>random(value)</dt><dd>返回 value 中的一个随机值</dd>
<dt>reject(value, *args, **kwargs)</dt><dd><p>
过滤 value 序列中的一些值,过滤的条件通过后面
的参数给定,例如要过滤所有的奇数,可以把内置的 odd 过滤器传给 reject 作为参数来
实现:
</p>
<pre class="example" id="org2e123a3">
{{ numbers|reject('odd') }}
</pre></dd>
<dt>rejectattr( value,*args,**kwargs)</dt><dd><p>
根据序列中元素的某个属性进行过滤. 只要属
性满足条件,就会被过滤掉:
</p>
<pre class="example" id="org3acced0">
{{ user|rejectattr("is_active") }}
{{ user|rejectattr("email", "none") }}
</pre>
<p>
第一行代码过滤了 is_active 为 True 的对象,第二行代码过滤了 email 为 none 的对
象.
</p></dd>
<dt>replace( value,old,new,count)</dt><dd>将 value 中的 old 用 new 来替换,如果给定了
count, 则限制替换的次数.用法和 python 的 replace 一致.</dd>
<dt>reverse( value)</dt><dd>将 value 这个序列逆序.</dd>
<dt>safe( value)</dt><dd><p>
渲染 value 时,关闭自动转义.
</p>
<pre class="example" id="org280dd6c">
&lt;div&gt;safe 过滤器: {{ "&lt;p style='background-color:red;'&gt;China&lt;/p&gt;"|safe }}
</pre>
<p>
Jinja2 默认的全局转义会让上例中的所有特殊字符按照原义显示在页面中,就不会产生
HTML 的渲染效果了,所以需要让 safe 关闭它们的自动转义.
</p></dd>
<dt>select( value,*args,**kwargs)</dt><dd>根据 value 序列中元素的某个属性进行过滤,留下
满足条件的,与 rejectattr 正好相反.</dd>
<dt>sort( value, reverse=False, case_sensitive= False, attribute=None)</dt><dd>将 value
序列进行排序,底层用的是 python 的 sorted 函数, reverse 代表是否逆向排序,
case_sensitive 代表是否忽略大小写, attribute 代表根据序列中某元素的某个属性排
序.</dd>
<dt>string( value)</dt><dd>将 value 转换成字符串类型.</dd>
<dt>striptags( value)</dt><dd>将字符串 value 中的 HTML 标签去除, 留下文本内容.</dd>
<dt>tojson( value)</dt><dd>将 value 转换成 JSON 格式的字符串</dd>
<dt>trim( value)</dt><dd>删除 value 前面和后面的空白字符</dd>
<dt>truncate( value, length=255, killwords=False, end="&#x2026;")</dt><dd>将字符串 value 进
行截取, length 代表保留多少字符, killwords 代表在截取字符串时是否要裁减单词,
end 表示末尾的结束字符.在文章简介,个人简介等只需要显示一部分字符的场景下非常有
用.</dd>
<dt>unique( vaule, case_sensitive=False, attribute=None)</dt><dd>将 value 序列中的重复
元素删除. case_sensitive 表示是否忽略大小写,attribute 代表使用 value 序列中某
个元素的某个属性来判断是否重复.</dd>
<dt>upper( value)</dt><dd>将 value 的所有字符全部大写.</dd>
<dt>urlencode( value)</dt><dd>如果 value 是字符串,底层调用 Python 的
urllib.parse.quote;如果 value 是字段,底层调用 Python 的
url.lib.parse.urlencode.</dd>
<dt>(no term)</dt><dd>urlize( value, trim_url_limit=None, nofollow=False, target=None, rel=None,
extra_schemes=None :: 将 value 变成可以单击的链接,如 url 和邮箱,注意: value 必
需是以 <a href="http://">http://</a>, <a href="https://">https://</a> , www. , mailto 开头的字符串.</dd>
<dt>wordcount( value)</dt><dd>统计 value 中有多少个单词.</dd>
<dt>xmlattr( value,autospace=True)</dt><dd><p>
value 为一个字典,根据这个字典创建一个 xml
格式的属性,示例代码:
</p>
<pre class="example" id="org0d80d5f">
&lt;ul {{ {'class': 'my_list', 'missing': none,
	'id': 'list-%d'|format(variable)}|xmlattr}}&gt;
	...
&lt;/ul&gt;
</pre></dd>
</dl>


<p>
过滤器可以嵌套使用,上面的示例里都展示过了:
</p>
<pre class="example" id="orge50aab5">
{{ titles|map("lower")|join(",") }}
</pre>
<p>
titles 传递给 map, map 对 titles 应用 lower 过滤器(函数), 并返回结果值,map 过滤
器返回的结果值又作为参数传递给 join.
</p>
</div>
</div>

<div id="outline-container-orgcd51e36" class="outline-4">
<h4 id="orgcd51e36">测试器</h4>
<div class="outline-text-4" id="text-orgcd51e36">
<p>
测试器是用来判断某些元素是否满足某个条件的.和过滤器一样,也是一种函数,不过它的使
用与管道和普通 python 函数调用又不一样:
</p>
<pre class="example" id="orgd6a6c3e">
{% if user is defined %}
   user 定义了 : {{ user }}
{% else %}
   user 没有定义
{% endif %}
</pre>

<p>
测试器是通过 <code>if VAR is TEST</code> 来使用的, 上面代码里使用了 defined 测试器. 和过滤
器一样, Jinja2 也提供了许多内置的测试器: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#builtin-tests">Jinja2 builtin tests</a>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 3:</span> 测试器(官网最新版的测试器,可能与书中有差别)</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">测试器</th>
<th scope="col" class="org-left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">boolean()</td>
<td class="org-left">是否为布尔类型</td>
</tr>

<tr>
<td class="org-left">callable()</td>
<td class="org-left">是否能被调用</td>
</tr>

<tr>
<td class="org-left">defined()</td>
<td class="org-left">是否定义了</td>
</tr>

<tr>
<td class="org-left">divisibleby()</td>
<td class="org-left">是否能被某个数整除</td>
</tr>

<tr>
<td class="org-left">eq()</td>
<td class="org-left">是否与另一个值相等</td>
</tr>

<tr>
<td class="org-left">escaped()</td>
<td class="org-left">是否已经被转义了</td>
</tr>

<tr>
<td class="org-left">even()</td>
<td class="org-left">是否为偶数</td>
</tr>

<tr>
<td class="org-left">false()</td>
<td class="org-left">是否为 False</td>
</tr>

<tr>
<td class="org-left">filter()</td>
<td class="org-left">是否为过滤器</td>
</tr>

<tr>
<td class="org-left">float()</td>
<td class="org-left">是否为浮点数</td>
</tr>

<tr>
<td class="org-left">ge()</td>
<td class="org-left">是否大于或等于某个数</td>
</tr>

<tr>
<td class="org-left">gt()</td>
<td class="org-left">是否大于某个数</td>
</tr>

<tr>
<td class="org-left">in()</td>
<td class="org-left">是否在某个序列中</td>
</tr>

<tr>
<td class="org-left">integer()</td>
<td class="org-left">是否为整数</td>
</tr>

<tr>
<td class="org-left">iterable()</td>
<td class="org-left">是否为可迭代类型</td>
</tr>

<tr>
<td class="org-left">le()</td>
<td class="org-left">是否小于或等于某个数</td>
</tr>

<tr>
<td class="org-left">lower()</td>
<td class="org-left">是否全部为小写</td>
</tr>

<tr>
<td class="org-left">lt()</td>
<td class="org-left">是否小于某个数</td>
</tr>

<tr>
<td class="org-left">mapping()</td>
<td class="org-left">是否为一个 mapping 对象(例如字典)</td>
</tr>

<tr>
<td class="org-left">ne()</td>
<td class="org-left">是否不等于某个数</td>
</tr>

<tr>
<td class="org-left">none()</td>
<td class="org-left">是否为 None</td>
</tr>

<tr>
<td class="org-left">number()</td>
<td class="org-left">是否为数值类型</td>
</tr>

<tr>
<td class="org-left">odd()</td>
<td class="org-left">是否为奇数</td>
</tr>

<tr>
<td class="org-left">sameas()</td>
<td class="org-left">是否在内存中和另一个对象是一样的</td>
</tr>

<tr>
<td class="org-left">sequence()</td>
<td class="org-left">是否为序列(如元组,列表)</td>
</tr>

<tr>
<td class="org-left">string()</td>
<td class="org-left">是否为字符串</td>
</tr>

<tr>
<td class="org-left">test()</td>
<td class="org-left">是否为一个测试器</td>
</tr>

<tr>
<td class="org-left">true()</td>
<td class="org-left">是否为 True</td>
</tr>

<tr>
<td class="org-left">undefined()</td>
<td class="org-left">是否没有定义</td>
</tr>

<tr>
<td class="org-left">upper()</td>
<td class="org-left">是否全部为大写</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org34b87de" class="outline-3">
<h3 id="org34b87de">控制语句</h3>
<div class="outline-text-3" id="text-org34b87de">
<p>
Jinja2 模板中也是有 if 判断和for 循环等控制语句的,前面代码示例里用过但没有具体解
释.
</p>

<p>
所有的控制语句都是放在 <code>{%%}</code> 中间的,并且在结束控制语句时要加入相应的结束语句.
</p>
</div>

<div id="outline-container-org659a288" class="outline-4">
<h4 id="org659a288">if 判断语句</h4>
<div class="outline-text-4" id="text-org659a288">
<p>
Jinja2 的 if 判断语句和 Python 中的 if 判断语句非常类似,可以使用关系运算符
<code>&gt;</code>, <code>&lt;</code>, <code>&gt;=</code>, <code>&lt;=</code>, <code>==</code>, <code>!=</code> 来进行判断,也可以通过 and , or, not 来进行逻辑
操作.
</p>

<p>
用一个视图函数来测试下测试器的用法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面的代码定义了一个  age 变量,并传递给 if.html 模板:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">if &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  {% if age &gt; 18 %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#25104;&#24180;&#20154; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% elif age &lt; 18 %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#26410;&#25104;&#24180; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">div</span>&gt; &#21018;&#22909;&#25104;&#24180; &lt;/<span style="font-weight: bold;">div</span>&gt;
  {% endif %}
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
浏览器访问 <a href="http://127.0.0.1:5000/if">http://127.0.0.1:5000/if</a> 会看到"刚好成年" 的内容,因为传递的 age 值为
</p>
<ol class="org-ol">
<li></li>
</ol>


<blockquote>
<p>
Jinja2 中的代码缩进只是为了方便阅读,与 Python 的缩进是语法的一部分不同.
因此 Jinja2 的控制语句需要添加结束语句来表示语句的结束.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org1b76628" class="outline-4">
<h4 id="org1b76628">for 循环语句</h4>
<div class="outline-text-4" id="text-org1b76628">
<p>
Jinja2 中的 for 循环与 Python 的 for 循环也非常类似,也只多一个 endfor 语句表示语
句结束:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
    <span style="font-weight: bold; font-style: italic;">books</span> = [{<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#19977;&#22269;&#28436;&#20041;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#32599;&#36143;&#20013;"</span>,
              <span style="font-style: italic;">"price"</span>: 100},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#27700;&#27986;&#20256;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26045;&#32784;&#24245;"</span>,
              <span style="font-style: italic;">"price"</span>: 99},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#32418;&#27004;&#26790;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26361;&#38634;&#33465;"</span>,
              <span style="font-style: italic;">"price"</span>: 101},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#35199;&#28216;&#35760;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#21556;&#25215;&#24681;"</span>,
              <span style="font-style: italic;">"price"</span>: 102}
             ]
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码新定义了一个 for_statement 视图函数,传递了一个 books 列表变量到 for.html
模板,列表里存放的是图书信息的字典.下面在模板文件中循环这个列表:
</p>


<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
因为 table 表格标签中, 一个 tr 标签代表表格中的一行,所以 tr 外面加 for 循环,来循
环 books 列表, 一个td 表示一列,每列从 book 中获取相应数据. 页面结果应该是下面这
样:
</p>
<pre class="example" id="org151ca86">
BookName Author Price
三国演义 罗贯中 100
水浒传 	施耐庵 	99
红楼梦 	曹雪芹 	101
西游记 	吴承恩 	102
</pre>

<p>
如果被循环的序列(例如上面的 books)中没有元素,则可以使用 else 来处理.这点和
Python 的 for 和 else 一起的用法有所不同,我们可以用它来处理没有数据传递的情况:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
在 books 中没有数据的情况下,就会执行 else, 可以将 for_statement 视图函数的 books
修改成一个空的列表,再看看效果:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">books = [{"name": "&#19977;&#22269;&#28436;&#20041;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#32599;&#36143;&#20013;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 100},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#27700;&#27986;&#20256;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#26045;&#32784;&#24245;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 99},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#32418;&#27004;&#26790;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#26361;&#38634;&#33465;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 101},</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">{"name": "&#35199;&#28216;&#35760;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"author": "&#21556;&#25215;&#24681;",</span>
<span style="font-weight: bold; font-style: italic;">#              </span><span style="font-weight: bold; font-style: italic;">"price": 102}</span>
<span style="font-weight: bold; font-style: italic;">#             </span><span style="font-weight: bold; font-style: italic;">]</span>
    <span style="font-weight: bold; font-style: italic;">books</span> = []
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
再次访问 <a href="http://127.0.0.1:5000/for">http://127.0.0.1:5000/for</a> 可以看到下面结果:
</p>
<pre class="example" id="orgf550e62">
BookName Author Price
No data
</pre>

<p>
Jinja2 的 for 循环里还内置了许多好用的变量. 例如,可以用 loop.index 来实现获取当
前循环到了第几次:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/if"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">if_statement</span>():
    <span style="font-weight: bold; font-style: italic;">age</span> = 18
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"if.html"</span>, age=age)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/for"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">for_statement</span>():
    <span style="font-weight: bold; font-style: italic;">books</span> = [{<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#19977;&#22269;&#28436;&#20041;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#32599;&#36143;&#20013;"</span>,
              <span style="font-style: italic;">"price"</span>: 100},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#27700;&#27986;&#20256;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26045;&#32784;&#24245;"</span>,
              <span style="font-style: italic;">"price"</span>: 99},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#32418;&#27004;&#26790;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#26361;&#38634;&#33465;"</span>,
              <span style="font-style: italic;">"price"</span>: 101},
             {<span style="font-style: italic;">"name"</span>: <span style="font-style: italic;">"&#35199;&#28216;&#35760;"</span>,
              <span style="font-style: italic;">"author"</span>: <span style="font-style: italic;">"&#21556;&#25215;&#24681;"</span>,
              <span style="font-style: italic;">"price"</span>: 102}
             ]
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"for.html"</span>, books=books)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后在 for.html 模板中给图书增加一个名为序号的列,用 loop.index 显示每行的序号:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
然后可以看到页面效果:
</p>
<pre class="example" id="org5833ac4">
Index 	BookName 	Author 	Price
1 	三国演义 	罗贯中 	100
2 	水浒传 	施耐庵 	99
3 	红楼梦 	曹雪芹 	101
4 	西游记 	吴承恩 	102
</pre>

<p>
除了 loop.index 之外, Jinja2 的 for 循环还提供了下面这些变量: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#for">jinja2 for loop</a>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 4:</span> for 循环中的变量</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">变量</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">loop.index</td>
<td class="org-left">当前迭代的序号,从1开始</td>
</tr>

<tr>
<td class="org-left">loop.index0</td>
<td class="org-left">当前迭代的序号,从0开始</td>
</tr>

<tr>
<td class="org-left">loop.revindex</td>
<td class="org-left">当前迭代的逆向序号,最后一个为1,倒数第二为2,依此类推</td>
</tr>

<tr>
<td class="org-left">loop.revindex0</td>
<td class="org-left">当前迭代的逆向序号,最后一个为0,倒数第二为1,依此类推</td>
</tr>

<tr>
<td class="org-left">loop.first</td>
<td class="org-left">判断当前是否为第一次迭代</td>
</tr>

<tr>
<td class="org-left">loop.last</td>
<td class="org-left">判断当前是否为最后一次迭代</td>
</tr>

<tr>
<td class="org-left">loop.length</td>
<td class="org-left">序列的长度</td>
</tr>

<tr>
<td class="org-left">loop.cycle</td>
<td class="org-left">和外层的循环一起循环某个序列</td>
</tr>

<tr>
<td class="org-left">loop.depth</td>
<td class="org-left">在多层循环中,指示当前是第几层循环,从1开始</td>
</tr>

<tr>
<td class="org-left">loop.depth0</td>
<td class="org-left">多层循环中,指示当前是第几层循环,从0开始</td>
</tr>

<tr>
<td class="org-left">loop.previtem</td>
<td class="org-left">当前迭代的上一个元素,如果当前是第一次迭代,变量会返回 undefined 对象</td>
</tr>

<tr>
<td class="org-left">loop.nextitem</td>
<td class="org-left">当前迭代的下一个元素,如果当前是最后一次迭代,变量会返回 undefined 对象</td>
</tr>

<tr>
<td class="org-left">loop.changed</td>
<td class="org-left">判断当前元素的某个值是否和上一次迭代一样,如果不一样,返回 True, 否则返回 False</td>
</tr>
</tbody>
</table>

<p>
上面只有 cycle 和 changed 是函数,其余全是变量.
</p>
<ul class="org-ul">
<li><p>
loop.cycle: 假设需要对 table 标签中的行号为奇数的 tr 标签添加 odd 类,行数为偶
数的 tr 标签添加 even 类:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"{{ loop.cycle('odd', 'even') }}"</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
在循环 books 过程中, loop.cycle 也会不断在 odd 和 even 两个变量中循环,从而实现
奇数使用 odd 类,偶数使用 even 类.
</p></li>
<li><p>
loop.changed: 假设想要知道当前循环的 book.name 是否和上一次循环的一致,可以通过
loop.changed 实现:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">for &#35821;&#21477;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Index&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Author&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;Price&lt;/<span style="font-weight: bold;">th</span>&gt;
        &lt;<span style="font-weight: bold;">th</span>&gt;BookName Changed?&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
  {% for book in books %}
  &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"{{ loop.cycle('odd', 'even') }}"</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.index}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.name}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.author}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{book.price}} &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;<span style="font-weight: bold;">td</span>&gt; {{loop.changed(book.name)}} &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% else %}
  &lt;<span style="font-weight: bold;">tr</span>&gt;
    &lt;<span style="font-weight: bold;">td</span> <span style="font-weight: bold; font-style: italic;">colspan</span>=<span style="font-style: italic;">"3"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span> &gt; No data &lt;/<span style="font-weight: bold;">td</span>&gt;
  &lt;/<span style="font-weight: bold;">tr</span>&gt;
  {% endfor %}
  &lt;/<span style="font-weight: bold;">table</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div></li>
</ul>


<p>
Jinja2 模板的 for 循环不存在 break 和 continue 来中断循环,这是和 Python 中的 for
循环最大的区别,另外 Jinja2 中只有 for 循环,没有 while 循环.
</p>
</div>
</div>
</div>

<div id="outline-container-orgaceb1a4" class="outline-3">
<h3 id="orgaceb1a4">模板结构</h3>
<div class="outline-text-3" id="text-orgaceb1a4">
<p>
Jinja2 比传统的 HTML 有更强大的功能,其中一个就是代码模块化.
</p>

<p>
HTML 除了通过 iframe 标签在浏览器端动态加载其他网页外,它自身几乎不具备任何代码木
块化的能力. 而 Jinja2 可以通过宏,模板继承,引入模板等方式实现代码模块化.
</p>
</div>

<div id="outline-container-orge3c75d3" class="outline-4">
<h4 id="orge3c75d3">宏和 import 语句</h4>
<div class="outline-text-4" id="text-orge3c75d3">
<p>
模板中的 "宏" 与函数类似,可以传递参数,但没有返回值.
</p>

<p>
常用的代码片段可以放在宏中,然后把一些不规定的值抽取出来当做参数:
</p>
<pre class="example" id="orgca702d9">
{% macro input(name, value='', type='text')%}
&lt;input type="{{ type }}" value="{{ value|escape }}" name="{{ name }}"&gt;
{% endmacro %}
</pre>
<p>
上面代码创建了一个叫做 input 的宏,接收三个参数,第一个是作为 input 的 name 属性,
第二个作为 input 的 value 属性值,第三个作为 type 属性值,其中第一个参数是必需给定
的,剩下两个都有默认值.给定参数的方法也和 python 的位置参数和关键字参数用法一致.
</p>

<p>
定义了input宏之后,我们就可以使用它来快速创建 input 标签了:
</p>
<pre class="example" id="org11b70b0">
&lt;div&gt;{{ input('username') }}&lt;/div&gt;

&lt;div&gt;{{ input('password', type='password', value='pwd') }}&lt;/div&gt;
</pre>
<p>
创建一个新的模板文件来试试效果:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;

{% macro input(name, <span style="font-weight: bold; font-style: italic;">value</span>='', <span style="font-weight: bold; font-style: italic;">type</span>='text')%}
&lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"{{ type }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ value|escape }}"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span>&gt;
{% endmacro %}

&lt;<span style="font-weight: bold;">div</span>&gt;{{ input('username') }}&lt;/<span style="font-weight: bold;">div</span>&gt;

&lt;<span style="font-weight: bold;">div</span>&gt;{{ input('password', <span style="font-weight: bold; font-style: italic;">type</span>='password', <span style="font-weight: bold; font-style: italic;">value</span>='pwd') }}&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
创建视图函数让它渲染这个模板文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/macro"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">macro</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"macro.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
运行后访问 <a href="http://127.0.0.1:5000/macro">http://127.0.0.1:5000/macro</a> 可以看到出现了两个输入框,一个用于输入用户
名,一个用于输入密码,使用这样的宏可以很方便创建需要的代码块,这里我们只是将一个
input 标签制作成了宏,如果可以确定网页中会有多个相同结构的代码,我们可以将更多的代
码制作成宏,这就和函数概念有点像了. 宏对于网页中统一风格/UI 的地方很有效,比如网页
首部的导航栏,底部的信息栏,使用宏就只需要将大量相同的代码编写一次,需要时再调用就
可以了.
</p>

<p>
实际开发过程中,经常是将一些常用的宏单独放到一个文件里,需要时再从文件进行导入.导
入使用的时 import 语句,Jinja2 的import 与 Python 的import 也类似,形式可以直接是
<code>import ... as ...</code>, 也可以是 <code>from ... import ...</code> 或者是 <code>from ... import
... as ...</code>
</p>

<p>
下面用实际例子做演示:
先创建一个 forms.html 存放定义的宏:
</p>


<div class="org-src-container">
<pre class="src src-html">{% macro input(name, <span style="font-weight: bold; font-style: italic;">value</span>='', <span style="font-weight: bold; font-style: italic;">type</span>='text') %}
&lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"{{ type }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ value }}"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span>&gt;
{% endmacro %}


{% macro textarea(name, value= '', rows=10, cols=40) %}
&lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"{{ name }}"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"{{ rows }}"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"{{ cols }}"</span>&gt;{{ value|escape }}&lt;/<span style="font-weight: bold;">textarea</span>&gt;
{% endmacro %}
</pre>
</div>
<p>
现在, form.html 中定义了两个宏, input 和 textarea, 下面再在另一个文件中用 import
语句导入即可使用它们:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% import 'forms.html' as forms %}
&lt;<span style="font-weight: bold;">dl</span>&gt;
  &lt;<span style="font-weight: bold;">dt</span>&gt;Username&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ forms.input('username') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;

  &lt;<span style="font-weight: bold;">dt</span>&gt;Password&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ forms.input('password', <span style="font-weight: bold; font-style: italic;">type</span>='password') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;
&lt;/<span style="font-weight: bold;">dl</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ forms.textarea(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在再次访问 <a href="http://127.0.0.1:5000/macro">http://127.0.0.1:5000/macro</a> 可以看到两个输入框和一个文本框.
</p>

<p>
也可以通过 from &#x2026; import &#x2026; as &#x2026; 或 from &#x2026; import &#x2026; 形式导入:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% from 'forms.html' import input as input_field, textarea as ta%}
&lt;<span style="font-weight: bold;">dl</span>&gt;
  &lt;<span style="font-weight: bold;">dt</span>&gt;Username&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ input_field('username') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;

  &lt;<span style="font-weight: bold;">dt</span>&gt;Password&lt;/<span style="font-weight: bold;">dt</span>&gt;
  &lt;<span style="font-weight: bold;">dd</span>&gt;{{ input_field('password', <span style="font-weight: bold; font-style: italic;">type</span>='password') }}&lt;/<span style="font-weight: bold;">dd</span>&gt;
&lt;/<span style="font-weight: bold;">dl</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ ta(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
另外,需要注意的是,通过 import 导入的模板不会把当前模板中的变量添加到被导入的模板
中,如果要在被导入的模板中使用当前模板的变量,可以通过以下两种方式:
</p>
<ul class="org-ul">
<li>显示地通过参数形式传递(就是将当前模板中的变量作为参数传递到宏调用里)</li>
<li><p>
使用 with context 方式:
</p>
<pre class="example" id="org011aa0a">
{% form 'forms.html' import input with contex %}
</pre></li>
</ul>


<p>
以上面的 textarea 宏为例子,传递参数给其 value 变量可以让我们在页面的文本框中看到
value 的值:
视图函数传递变量 value:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/macro"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">macro</span>():
    <span style="font-weight: bold; font-style: italic;">values</span> = <span style="font-style: italic;">"this is some text."</span>
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"macro.html"</span>, value= values)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
用参数形式形式显示传递:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 Macro</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
{% from 'forms.html' import input as input_field, textarea as ta with context%}
&lt;<span style="font-weight: bold;">p</span>&gt;{{ ta(comment) }}&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
用参数形式很好理解,就类似函数传参吧,但用 context 的例子我暂时想不到用法,可能会是
对于一个全局变量,然后 import 的模板加上 with context 了,模板里的宏就可以访问这个
全局变量了? 这个没搞清楚用法用例,不过查找的资料说 context 其实就是
render_template 传递给模板的所以数据的 "集合", 不能直接作为变量使用的,应该理解为
是一个概念性的对象吧,所有传递到模板的变量都在 context 里. with context 就相当于
把当前模板的所有变量都传递到要导入的这个 forms.html 模板中了,那么在 forms.html
这个模板文件中就可以"提前"(因为要先导入它才使用它)使用传递给模板的变量(尽管没有
变量传递给 forms.html, 但仍然可以将变量提前在代码里使用)
</p>
</div>
</div>

<div id="outline-container-orgde3420c" class="outline-4">
<h4 id="orgde3420c">模板继承</h4>
<div class="outline-text-4" id="text-orgde3420c">
<p>
网站中大部分网页的模块是重复的,例如顶部导航栏,底部备案信息. 如果每个页面都重复写
这些代码,就会让项目臃肿,且后期不易维护. 比较好的做法是,通过模板继承,把重复性的代
码写在父模板中,子模板继承父模板后,再分别实现自己页面的代码.
</p>

<p>
先看一个父模板 base.html:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"base.css"</span>/&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> {% block title %}{% endblock %} </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
    {% block head %}{% endblock %}
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"body"</span>&gt;
      {% block body %}
      {% endblock %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"footer"</span>&gt;
      {% block footer %}
      <span style="font-weight: bold; font-style: italic;">&amp;copy;</span>Copyright 2008 by &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"http://domain.invalid/"</span>&gt;you&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endblock %}&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
这个父模板编写了网页的整体结构,还提前引用了所有模板都要用到的样式文件 base.css.
将子模板需要重写的地方都定义成了 <b>block</b> 结构,如 title, head, body, footer, 子模
板继承父模板之后,重写对应的 block 的代码,就可以完成子模板的渲染.
下面就用继承 base.html 的方式来实现一个 index.html:
</p>


<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">style</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/css"</span>&gt;
  .detail{color:red;}
&lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#36825;&#26159;&#39318;&#39029;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>

<p>
子模板通过 extends 语法加载父模板,因为 base.html 和 index.html 都放在 templates
文件夹下,所以直接写文件名即可,需要注意的是, extends 必需放在子模板所有代码的前面.
然后三个代码块分别重写(实现)了title,head 和 body 三个代码块,这三个代码块会填充到
父模板的对应三个代码块的位置,并最终生成一个有完整HTML 结构的 index.html 文件.
</p>

<p>
模板中不能出现重名的 block, 如果一个地方需要使用另一个 block 里的内容,可以用
self.blockname 来引用:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ self.title() }}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>
<p>
上面代码中,h1 标签的内容是通过 {{ self.title() }} 将 block title 里的内容引用到
h1 里的.
如果子模板要继承父模板的某个 block 的内容,可以使用 super() 来实现,比如要继承父模
板的 footer 这个 block 的已有内容:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "base.html"%}
{% block title %}
&#39318;&#39029;
{% endblock %}

{% block body %}
&lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ self.title() }}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
&lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"detail"</span>&gt;&#36825;&#26159;&#39318;&#39029;&#20869;&#23481;&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}

{% block footer %}
{{ super() }}
&lt;<span style="font-weight: bold;">p</span>&gt; &#21097;&#19979;&#37096;&#20998;&#26159;&#23376;&#27169;&#26495;&#33258;&#24049;&#30340;&#20869;&#23481;&#20102; &lt;/<span style="font-weight: bold;">p</span>&gt;
{% endblock %}
</pre>
</div>

<p>
上面代码中,如果没有使用 {{ super() }} 那么子模板是不会继承父模板 footer 的内容的,不
过删除上面代码的 block footer 块就会原封不动的继承父模板的 footer 块了,这与面向
对象编程思想中的继承是一致的.不做修改就会自然继承,做了修改且仍想使用父模板的代码
就要使用 super.
</p>
</div>
</div>

<div id="outline-container-org8ad7329" class="outline-4">
<h4 id="org8ad7329">引入模板</h4>
<div class="outline-text-4" id="text-org8ad7329">
<p>
有些HTML 的模块需要在交给页面中使用,如果使用模板继承,就会在所有子模板中都加载,所
以不合适;如果每个需要该模块的页面中添加相通的代码,又会导致维护成本增加,此时就可
以使用 "include" 引用(引入) 模板. 例如网站的二维码联系方式,有的页面需要,但并不是
所有的页面都需要,所以可以把相关代码写到一个 _contact.html 里,然后在需要的地方
进行引用:
</p>
<pre class="example" id="orgddb17d6">
{% include "_contact.html" %}
</pre>
<p>
因为 _contact.html 是作为被引用的模板存在的,为了以示区分,一般在命名上会在前面加
上一个下划线,表示它专门作为被引用的模板,不是普通模板文件.
</p>

<blockquote>
<p>
这一部分的模板结构有宏,模板继承和模板的引入,模板继承可以让所有页面都需要的 HTML
代码只编写一次就可以多次使用,比如那些用作网页结构的 HTML 标签,使用继承就可以不用
每次都写上 html,head 等标签了; 宏的使用可以简化常用的代码片段;模板的引入可以减少
重复代码的编写.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org11dbe31" class="outline-3">
<h3 id="org11dbe31">模板环境</h3>
<div class="outline-text-3" id="text-org11dbe31">
</div>
<div id="outline-container-org24fccea" class="outline-4">
<h4 id="org24fccea">模板上下文(context?)</h4>
<div class="outline-text-4" id="text-org24fccea">
<p>
通过 render_template 传入的变量,实际上是保存到了模板的上下文中, Jinja2 也有一些
内置的上下文变量,可以通过 app.context_processor 来添加全局上下文.所以简单理解为
上下文是模板中可以直接使用的变量.
</p>
<blockquote>
<p>
这里的全局上下文可能就是前面的 import 宏加上 "with context" 的 context,
app.context_processor 添加的全局上下文应该就是通过 "with context" 被宏使用的.
</p>
</blockquote>
</div>

<ul class="org-ul">
<li><a id="orgf00abe7"></a>自定义变量<br />
<div class="outline-text-5" id="text-orgf00abe7">
<p>
变量除了通过 render_template 传递外,还可以在模板中通过 set 语法定义新的变量:
</p>
<pre class="example" id="orgf87bf0c">
{% set name='admin' %}
</pre>
<p>
使用 set 赋值语句创建的变量在它后面的代码都是有效的.如果不想让变量污染全局环境,
可以用 with 语句创建一个内部作用域,将 set 语句放到其中,这样 set 创建的变量就只在
这个 with 语句代码块中有效:
</p>
<pre class="example" id="orgeaf4c15">
{% with %}
{% set foo = 42 %}
{{ foo }}
{% endwith %}
</pre>
<p>
with 语句也有简写形式:
</p>
<pre class="example" id="orgd47a92d">
{% with foo = 42 %}
{{ foo }}
{% endwith %}
</pre>

<blockquote>
<p>
之前的宏导入使用变量的两种方法的地方我还疑惑能不能在模板中定义变量,这里不就是了.
</p>
</blockquote>
</div>
</li>

<li><a id="org5f6282c"></a>Jinja2 内置全局上下文变量<br />
<div class="outline-text-5" id="text-org5f6282c">
<p>
Jinja2 内置了一些常用的全局上下文变量:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 5:</span> Jinja2 内置全局上下文变量</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">变量</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">g</td>
<td class="org-left">当前请求中的全局变量.一般会把当前请求中多个地方需要用到的变量绑定</td>
</tr>

<tr>
<td class="org-left">request</td>
<td class="org-left">当前请求对象,通过它可以获得请求的信息</td>
</tr>

<tr>
<td class="org-left">session</td>
<td class="org-left">当前请求的 session 对象</td>
</tr>

<tr>
<td class="org-left">config</td>
<td class="org-left">项目的配置对象(flask.config)</td>
</tr>
</tbody>
</table>
<p>
上面的上下文变量可以在左右模板中直接使用,不需要额外传递参数.
</p>
</div>
</li>

<li><a id="orgfca0fcc"></a>上下文处理器(context processor)<br />
<div class="outline-text-5" id="text-orgfca0fcc">
<p>
Jinja2 虽然内置了一些上下文变量,但是有时我们需要传递自定义的变量,例如网站当前登
录的用户名,几乎所有模板都会用到这个数据,因此需要把 user 变量传递到几乎所有模板中,如
果使用 render_template ,就需要在所有调用它的地方带上 user 参数,会非常麻烦.我们可
以使用上下文处理器这个装饰器函数 <code>@app.context_processor</code> 来将变量绑定到上下文
(context):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">context_user</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = {<span style="font-style: italic;">"username"</span>: <span style="font-style: italic;">"admin"</span>,
            <span style="font-style: italic;">"level"</span>: 2}
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"user"</span>: user}
</pre>
</div>
<p>
自定义的上下文处理器函数中,要把变量放到字典才能被模板使用(应该是由于 Web 开发传
递数据多用 JSON 格式的原因吧).另外,在上下文的变量中,除了 Jinja2 内置的全局上下文
变量外,其余的上下文变量是不能被 import 导入的模板使用的,如果需要使用,就要用 with
context 语法(详见 <a href="#orge3c75d3">宏和 import 语句</a>).
</p>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgee6a8f8" class="outline-4">
<h4 id="orgee6a8f8">全局函数</h4>
<div class="outline-text-4" id="text-orgee6a8f8">
</div>
<ul class="org-ul">
<li><a id="orga6e3bed"></a>内置全局函数<br />
<div class="outline-text-5" id="text-orga6e3bed">
<p>
为了增强 Jinja2 的逻辑功能,Jinja2 内置了一些全局函数,它们在所有模板中都可以使用,
包括被导入的模板.
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 6:</span> Jinja2 内置全局函数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">函数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">range(start,stop,step)</td>
<td class="org-left">和python 中的range 一样,获取一个等差的列表</td>
</tr>

<tr>
<td class="org-left">lipsum(n=5,html=True,min=20,max=100)</td>
<td class="org-left">在模板中生成随即的文本,默认生成5段 HTML 代码,每段20-100 个字符,如果 HTML 设置为 False, 则返回纯文本内容</td>
</tr>

<tr>
<td class="org-left">dict(**items)</td>
<td class="org-left">转换成字典,和 Python 中的 dict 一样</td>
</tr>
</tbody>
</table>

<p>
另外还有三个全局类,即 cycler, joiner 和 namespace, 详细文档: <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#list-of-global-functions">Global Functions</a>
</p>

<p>
除了 Jinja2 内置的全局函数外, Flask 也提供了两个全局函数:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 7:</span> Flask 提供的全局函数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">函数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">url_for</td>
<td class="org-left">用于加载静态文件,或构建 URL</td>
</tr>

<tr>
<td class="org-left">get_flashed_messages</td>
<td class="org-left">用于获取闪现消息</td>
</tr>
</tbody>
</table>

<p>
url_for 函数可以用来构建 URL 和加载静态文件,和在 Python 中的 url_for 用法一样:
</p>
<div class="org-src-container">
<pre class="src src-flask">{{ url_for("book_detail", book_id=1) }}
</pre>
</div>

<p>
url_for 加载静态文件以及 get_flashed_messages 的使用会在<a href="#org56489eb">加载静态文件</a> 和 <a href="#org25463c5">闪现消息</a>
中讲解
</p>
</div>
</li>


<li><a id="org7bc8da5"></a>自定义全局函数<br />
<div class="outline-text-5" id="text-org7bc8da5">
<p>
想要自定义全局函数可以通过 app.template_global 装饰器来实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.template_global</span>()
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">greet</span>(name):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Welcome {}!"</span>.<span style="font-weight: bold;">format</span>(name)
</pre>
</div>

<p>
上面的自定义全局函数可以在模板中直接使用:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">div</span>&gt;
  {{ greet("god") }}
&lt;/<span style="font-weight: bold;">div</span>&gt;

</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org51928e2" class="outline-4">
<h4 id="org51928e2">Flask 模板环境</h4>
<div class="outline-text-4" id="text-org51928e2">
<p>
Flask 中使用 Jinja2, 可以通过 app.jinja_env 属性来配置模板.
</p>

<p>
app.jinja_env 是 Jinja2.Environment 类的对象.下面是一些 Jinja2.Environment 对象
常用的属性.
</p>
</div>

<ul class="org-ul">
<li><a id="org0b15e7c"></a>设置 autoescape(自动转义)<br />
<div class="outline-text-5" id="text-org0b15e7c">
<p>
Jinja2 默认是开启了全局转义,如果要关闭全局转义,可以通过下面代码实现:
</p>
<div class="org-src-container">
<pre class="src src-python">app.jinja_env.<span style="font-weight: bold; font-style: italic;">autospace</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
</pre>
</div>
</div>
</li>

<li><a id="orge057e4e"></a>添加过滤器<br />
<div class="outline-text-5" id="text-orge057e4e">
<p>
添加过滤器还可以通过 app.jinja_env.filters 实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">my_add_filter</span>(a,b):
    <span style="font-weight: bold;">return</span> a+b

app.jinja_env.<span style="font-weight: bold; font-style: italic;">filters</span>[<span style="font-style: italic;">"my_add_filter"</span>] = my_add_filter
</pre>
</div>

<blockquote>
<p>
嗯,这个添加过滤器的代码应该就是 @app.add_template_filter 装饰器函数装饰的代码吧.
</p>
</blockquote>
</div>
</li>

<li><a id="org322bba6"></a>添加全局对象<br />
<div class="outline-text-5" id="text-org322bba6">
<p>
app.template_global() 装饰器只能添加全局函数,如果需要添加其他的 Pytho 对象,可以
通过 app.jinja_env.globals 实现:
</p>
<div class="org-src-container">
<pre class="src src-python">app.jinja_env.<span style="font-weight: bold;">globals</span>[<span style="font-style: italic;">"user"</span>] = user
</pre>
</div>
</div>
</li>

<li><a id="org3500989"></a>添加测试器<br />
<div class="outline-text-5" id="text-org3500989">
<p>
测试器也可以通过 app.jinja_env.tests 添加:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">is_admin</span>(user):
    <span style="font-weight: bold;">if</span> user.role == <span style="font-style: italic;">"admin"</span>:
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>


app.jinja_env.<span style="font-weight: bold; font-style: italic;">tests</span>[<span style="font-style: italic;">"is_admin"</span>] = is_admin
</pre>
</div>

<p>
Jinja2.Environment 的其他属性可以查阅官网文档:<a href="https://jinja.palletsprojects.com/en/3.0.x/api/?highlight=environment#jinja2.Environment">Jinja2.Envronment</a>
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org26bb167" class="outline-3">
<h3 id="org26bb167">其他</h3>
<div class="outline-text-3" id="text-org26bb167">
</div>
<div id="outline-container-org3adced1" class="outline-4">
<h4 id="org3adced1">转义</h4>
<div class="outline-text-4" id="text-org3adced1">
<p>
模板渲染字符串时,字符串中有一些字符可能会破坏原本的 HTML 标签,如 "&amp;","&lt;","/"等,
更严重可能会发生 XSS 跨域脚本供给.因此,处理这些特殊字符时,要将其转义成 HTML 能正
确表达且不影响其自身的字符,如 "&lt;" 小于号的字符 在 HTML 中要正确表达而不被当成是
标签的开头,应该将其转换成 "&amp;lt;". 在使用 render_template 时, Flask 会对以 .html,
.htm, .xml 和 .xhtml 作为后缀名的文件进行全局转义,对其他后缀名的文件则不会开启全
局转义.如果想要关闭针对 html 等类型文件的全局转义,设置
<code>app.jinja_env.autoescape=False</code> 就可以了.
</p>
<blockquote>
<p>
如果是需要渲染由用户提交的字符串,强烈建议开启全局的转义,因为开发者永远不知道用户
会输入提交什么东西.
</p>
</blockquote>

<p>
没有开启全局转义的情况下,对于一些不信任的字符串,可以用 <code>{{ value|escape }}</code> 进行
局部转义(比如用户的输入), 在开启了全局转义的情况下,可以用 <code>{{ value|safe }}</code> 来
局部取消转义. 使用下面的 autospace 语法可以在一段代码块中整体关闭或开启自动转义:
</p>
<div class="org-src-container">
<pre class="src src-html">{% autospace false %}
&lt;<span style="font-weight: bold;">p</span>&gt;&#36825;&#20010;&#20195;&#30721;&#22359;&#20013;&#20851;&#38381;&#20102;&#33258;&#21160;&#36716;&#20041;&lt;/<span style="font-weight: bold;">p</span>&gt;
&lt;<span style="font-weight: bold;">p</span>&gt;{{ will_not_be_escaped }}&lt;/<span style="font-weight: bold;">p</span>&gt;
{% endautospace %}
</pre>
</div>
</div>
</div>

<div id="outline-container-org56489eb" class="outline-4">
<h4 id="org56489eb">加载静态文件</h4>
<div class="outline-text-4" id="text-org56489eb">
<p>
网页中除了 HTML 代码外,还有 CSS, JavaScript 和图片文件. 静态文件默认存放的目录为
当前目录的 static 文件夹中,如果要修改静态文件存放的路径,可以在创建 Flask 对象时
设置 static_folder 参数(和设置 template_folder 类似的):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>, static_folder=<span style="font-style: italic;">"static"</span>, template_folder=<span style="font-style: italic;">"templates"</span>)
</pre>
</div>
<p>
它们的路径都是相对于项目路径的,也可以直接用完整路径表示.
</p>

<p>
在模板文件中,则可以用 url_for 加载静态文件:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static', filename='about.css') }}"</span>&gt;
</pre>
</div>
<p>
url_for 的第一个参数 static 是固定的,表示生成一个静态文件的 URL; 第二个参数
filename 是文件名或文件路径,路径是相对于 static_folder 的路径(应该也可以是完整路
径),上面的代码在模板被渲染后会解析成下面这样:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/static/about.css"</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org25463c5" class="outline-4">
<h4 id="org25463c5">闪现消息</h4>
<div class="outline-text-4" id="text-org25463c5">
<p>
用户发送请求后,网站可能需要发送给用户一些提示消息,如登录失败或登录成功,这些提示
一般用闪现消息实现.
</p>

<p>
使用闪现消息,要先在视图函数中通过 flash 函数提交消息的内容,消息内容可以有多条,然
后在模板中使用 get_flashed_messages 函数获取 flash 函数提交的消息内容.
</p>

<p>
get_flashed_messages 函数返回的是一个列表,因此需要用 for 循环或者下标来取出消息内
容. 闪现消息的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template,flash

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/flash"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">myflash</span>():
    flash(<span style="font-style: italic;">"message1"</span>)
    flash(<span style="font-style: italic;">"message2"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"flash.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
模板文件获取消息:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Jinja2 flash</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">ul</span>&gt;
  {% for message in get_flashed_messages() %}
  &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
  {% endfor %}
&lt;/<span style="font-weight: bold;">ul</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
因为闪现消息是储存在 session 中的, 而使用 session 之前必需要在 app.config 里设置
SECRET_KEY, 如果没有设置,就会出现下面这种错误提示:
</p>
<pre class="example" id="org99fca0d">
RuntimeError

RuntimeError: The session is unavailable because no secret key was set.  Set the secret_key on the application to something unique and secret.
</pre>

<p>
我们在 app.config 里随便设置一个字符串就好了(测试):
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template,flash

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/flash"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">myflash</span>():
    flash(<span style="font-style: italic;">"message1"</span>)
    flash(<span style="font-style: italic;">"message2"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"flash.html"</span>)
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
再次访问 <a href="http://127.0.0.1:5000/flash">http://127.0.0.1:5000/flash</a> 就可以看到内容:
</p>
<pre class="example" id="orgbd816cb">
message1
message2
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org31df5f6" class="outline-2">
<h2 id="org31df5f6">数据库</h2>
<div class="outline-text-2" id="text-org31df5f6">
<p>
数据库是动态站必备的基础功能,通过使用数据库,数据可以被动态展示,修改,删除,极大提
高了数据的管理能力以及数据的传递效率.
</p>

<p>
数据库有很多种,例如 SQL Server, Oracle, PostgreSQL, MySQL 等. 因为 MySQL 免费,稳
定,灵活,跨平台,成为了流形的关系型数据库之一.
</p>

<p>
这一部分的代码放在 demo05 文件夹中:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> ~/flask_web_py3_10
mkdir demo05
<span style="font-weight: bold;">source</span> Scripts/activate
<span style="font-weight: bold;">cd</span> demo05
</pre>
</div>
</div>


<div id="outline-container-orga365c2f" class="outline-3">
<h3 id="orga365c2f">准备工作</h3>
<div class="outline-text-3" id="text-orga365c2f">
</div>
<div id="outline-container-orge18bd54" class="outline-4">
<h4 id="orge18bd54">MySQL 软件</h4>
<div class="outline-text-4" id="text-orge18bd54">
<p>
书中使用的 MySQL 8.0 版本.下载安装的图文教程:<a href="https://zlkt.net/book/detail/10/306">Install MySQL</a>
</p>
</div>
</div>

<div id="outline-container-org028613e" class="outline-4">
<h4 id="org028613e">Python 操作 MySQL 驱动</h4>
<div class="outline-text-4" id="text-org028613e">
<p>
Flask 是 Python 的框架,想要用 Flask 操作 MySQL 要先安装 Python 操作 MySQL 的驱动.目
前有下面这些 MySQL 驱动包:
</p>
<ul class="org-ul">
<li>MySQL-python: 也就是 MySQLdb, 是对 C 语言操作 MySQL 数据库的一个简单封装,遵循
Python DB API v2, 只支持 python2.</li>
<li>mysqlclient: MySQL-python 的另一个分支,支持 Python3 且修复了一些 bug, 是目前执
行效率最高的驱动,但是安装时容易因为环境问题出错.</li>
<li>pymysql: 纯 Python 实现的驱动,执行效率不如 mysqlclient. 但因为是纯 Python 实现
的,所以可以和 Python 代码无缝衔接.</li>
<li>mysql-connector-python: MySQL 官方推出的纯 Python 连接 MySQL 的驱动,但执行效率
比 pymysql 还低.</li>
</ul>


<p>
为了减少出错,作者使用 pymysql 作为驱动程序,并推荐学完以后再移植到 mysqlclient.
</p>

<p>
pymysql 不是内置的包,所以需要安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install pymysql -i https://mirrors.163.com/pypi/simple/
</pre>
</div>
</div>
</div>

<div id="outline-container-org1078acc" class="outline-4">
<h4 id="org1078acc">Flask-SQLAlchemy</h4>
<div class="outline-text-4" id="text-org1078acc">
<p>
Flask 中,很少会使用 pymysql 直接写原生的 SQL 语句去操作数据库,更多的是通过
SQLAlchemy 提供的 ORM 技术,类似于操作普通 Python 对象一样,来实现对数据库的增删改
查操作. 而 Flask-SQLAlchemy 是对 SQLAlchemy 的一个封装,这让在 Flask 使用
SQLAlchemy 更方便.
</p>

<p>
Flask-SQLAlchemy 也需要单独安装,因为 Flask-SQLAlchemy 依赖 SQLAlchemy, 所以安装
了 Flask-SQLAlchemy , SQLAlchemy 就会自动安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-sqlalchemy -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<p>
SQLAlchemy 类似于 Jinja2, 也可以独立于 Flask 使用, 完全可以在任何 Python 程序中
使用. SQLAlchemy 的功能非常强大,书中没有完全讲解,有需要可以查阅其官方文档: <a href="https://www.sqlalchemy.org/">SQLAlchemy</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org081b143" class="outline-3">
<h3 id="org081b143">Flask-SQLAlchemy 的基本使用</h3>
<div class="outline-text-3" id="text-org081b143">
</div>
<div id="outline-container-org16abe9b" class="outline-4">
<h4 id="org16abe9b">连接 MySQL</h4>
<div class="outline-text-4" id="text-org16abe9b">
<p>
Flask-SQLAlchemy 操作数据库需要先创建一个由 Flask-SQLAlchemy 提供的 SQLAlchemy
类的对象.创建这个对象时,要传入当前 app, 还要在 app.config 里设置
SQLALCHEMY_DATABASE_URI, 这个参数就是 Flask-SQLAlchemy 连接数据库时需要用到的"命
令":
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold;">with</span> db.engine.connect() <span style="font-weight: bold;">as</span> conn:
    <span style="font-weight: bold; font-style: italic;">rs</span> = conn.execute(<span style="font-style: italic;">"select 1"</span>)
    <span style="font-weight: bold;">print</span>(rs.fetchone())
</pre>
</div>

<p>
Flask-SQLAlchemy 连接数据库时会从传入的 app 的 config 属性中读取
SQLALCHEMY_DATABASE_URI 的参数值,根据不同的数据库,该 URI 的格式有所不同,MYSQL 的
连接格式:
</p>
<pre class="example" id="orgb5ded69">
mysql+[driver]://[username]:[password]@[host]:[port]/[database]?charset=utf8
</pre>
<p>
driver 就是 python 操作数据库的驱动程序,我们前面选择并安装了 pymysql, 所以上面代
码的 URI 里也是 pymysql, DATABASE 需要在数据库中提前创建好,我印象中应该是有用
Python 连接MYSQL 并创建数据库的方法的,但那个就离这本书的内容有点远了,直接开个终
端连接 MYSQL 创建数据库就行了:
连接MYSQL:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; MYSQL, &#26412;&#22320;&#25968;&#25454;&#24211;,&#36335;&#30001;&#22120;&#23616;&#22495;&#32593;,&#23494;&#30721;&#38543;&#20415;</span>
mysql -uroot -pkamisama
</pre>
</div>
<p>
创建 database_learn 数据库:
</p>
<pre class="example" id="orgd80a19c">
mysql&gt; create database database_learn;
</pre>
<p>
如果数据库已经创建好了,代码也没有错误,那么上面的代码运行的结果应该是:
</p>

<div class="org-src-container">
<pre class="src src-sh">python testMysql.py
</pre>
</div>

<p>
成功打印了 "(1,)", 说明已经连接成功, 我在2023年的 Sqlalchemy 版本里使用时有下面
的警告提示:
</p>
<pre class="example" id="orgb105acc">

FSADeprecationWarning: SQLALCHEMY_TRACK_MODIFICATIONS adds significant overhead and will be disabled by default in the future.  Set it to True or False to suppress this warning.
  warnings.warn(FSADeprecationWarning(
</pre>
<p>
暂时不知作用,暂且不管.
</p>
</div>
</div>

<div id="outline-container-org4b2da7a" class="outline-4">
<h4 id="org4b2da7a">ORM模型</h4>
<div class="outline-text-4" id="text-org4b2da7a">
<p>
object relationship mapping 对象关系映射,简称 ORM. 它是一种可以用面向对象的方式
来操作关系型数据库的技术.我们将能够映射数据库表的 Python 类称为 ORM 模型(当然了,
其他的面相对象编程的语言都有类似的概念,或者干脆也叫这个名字).
</p>

<p>
一个 ORM 模型对应数据库中的一个表, ORM 模型中的每个类的属性都分别对应表的每个字
段; ORM 模型的每个实例对象对应表中的每一条记录.
</p>

<p>
ORM 技术可以让开发者用面向对象的方式操作数据库, ORM 模型有以下优点:
</p>
<ul class="org-ul">
<li><p>
开发效率高: (几乎)不需要写原生 SQL 语句,纯 Python 的方式操作数据库,提高了开发
效率.
</p>
<blockquote>
<p>
这一点我倒是没什么感觉,觉得写原生 SQL 语句没有纯 Python 开发效率高感觉没多大改变
的样子, SQL 熟练的话也就开个终端输入语句,不过这里的开发效率应该是指的不用将数据
放到 SQL 语句字符串里而可以直接使用 ORM 技术提供的接口?或者是纯 Python 就不用写
原生 SQL 的存储过程,视图函数等等复杂的 SQL 语句了?
</p>
</blockquote></li>
<li><p>
安全性高: ORM 模型底层代码对一些常见的安全问题,例如 SQL 注入等做了防护,比直接
使用 SQL 语句更加安全.
</p>
<blockquote>
<p>
这点倒是的,直接使用 SQL 语句大多都是将数据拼接到 SQL 语句的字符串里,很容易就出现
可以 SQL 注入的地方.
</p>
</blockquote></li>
<li><p>
灵活性强: Flask-SQLAlchemy 底层支持 SQLite, MYSQL, Oracle, PostgreSQL 等关系型
数据库,但针对不同的数据库, ORM 模型的代码几乎一模一样,只需要修改少量代码,就可
以完成底层数据库的更换.
</p>
<blockquote>
<p>
这点倒是很强的一点,应该只有某些特定数据库软件的功能和特性相关的代码需要修改,但一
般这种地方都很少,比如就是前面测试数据库连接中使用的 Sqlalchemy_database_uri 的格
式, SQL 语句虽说基本语法都很相似,但不同的数据库总有一些差别,直接使用数据库驱动执
行原生 SQL 语句的话要后期要维护代码的工作量就很令人难受了, SQLAlchemy 相当于提供
一个统一的操作数据库的接口,底层数据库的不同它都为我们处理了.
</p>
</blockquote></li>
</ul>



<p>
下面在测试连接的代码的基础上用 Flask-SQLAlchemy 创建一个User 模型:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

db.create_all()
</pre>
</div>

<p>
上面代码创建了一个 User 类,它继承了 db.Model 类, 所有 ORM 模型都必须是 db.Model
的直接或间接子类. 然后通过 <code>__tablename__</code> 属性指定了User 模型映射到数据库中表的
表名.然后定义了三个 db.Column 类型的类属性,只有使用 db.Column 定义的类属性才会映
射到数据库中成为表的字段. 在这个模型中, id 是 db.Integer  类型,映射到数据库中则
为整型,且传递了 primary_key 为 True 映射到数据库中为指定这个字段为主键,
autoincrement=True 则是设置该字段自增; 另外还设置了 username 和 password 字段,
db.String 类型映射到数据库中则为 varchar 类型,并指定最大长度为 100.
</p>

<p>
最后的 db.create_all() 语句把 User 模型映射为数据库中的表,可以使用数据库软件或
SQL 语句查看数据库中创建的表.
列出当前使用的数据库的所有表:
</p>
<pre class="example" id="org0dfea98">
show tables;
</pre>
<p>
查看表结构:
</p>
<pre class="example" id="org17404bd">
show create table User;
</pre>

<p>
创建数据库的字段类型,除了上面的 db.Integer 和 db.String 还有许多,基本都和数据库
中可用的字段类型一一对应:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 8:</span> Flask-SQLAlchemy 字段类型</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">db.Integer</td>
<td class="org-left">整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.SmallInteger</td>
<td class="org-left">小整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.BigInteger</td>
<td class="org-left">长整型,范围与数据库一致</td>
</tr>

<tr>
<td class="org-left">db.Decimal</td>
<td class="org-left">定点类型,可以指定总长度和小数点后位数</td>
</tr>

<tr>
<td class="org-left">db.Boolean</td>
<td class="org-left">布尔类型</td>
</tr>

<tr>
<td class="org-left">db.Date</td>
<td class="org-left">日期类型,存储 Python 中的 datetime.date 对象</td>
</tr>

<tr>
<td class="org-left">db.DateTime</td>
<td class="org-left">日期时间类型,存储 Python 中的 datetime.datetime 对象</td>
</tr>

<tr>
<td class="org-left">db.Time</td>
<td class="org-left">时间类型,存储 Python 中的 datetime.time 对象</td>
</tr>

<tr>
<td class="org-left">db.Interval</td>
<td class="org-left">时间间隔,存储 Python 中的 datetime.timedelay 对象</td>
</tr>

<tr>
<td class="org-left">db.String</td>
<td class="org-left">字符串类型,使用时需要指定长度,不能超过 255 个字符</td>
</tr>

<tr>
<td class="org-left">db.Text</td>
<td class="org-left">文本类型,用于字符串长度不可控制的情况</td>
</tr>

<tr>
<td class="org-left">db.Enum</td>
<td class="org-left">枚举类型</td>
</tr>

<tr>
<td class="org-left">db.PickleType</td>
<td class="org-left">存储经过 Pickle 后的对象</td>
</tr>

<tr>
<td class="org-left">db.LargeBinary</td>
<td class="org-left">存储二进制数据</td>
</tr>
</tbody>
</table>

<p>
字段在数据库中的设置,都是通过 db.Column 的参数实现的. db.Column 常用参数:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 9:</span> db.Column 常用参数</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">参数</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">name</td>
<td class="org-left">字段在数据库中的名称,如果没有设置,则使用属性名作为字段名</td>
</tr>

<tr>
<td class="org-left">type_</td>
<td class="org-left">字段类型</td>
</tr>

<tr>
<td class="org-left">autoincrement</td>
<td class="org-left">自增</td>
</tr>

<tr>
<td class="org-left">default</td>
<td class="org-left">默认值</td>
</tr>

<tr>
<td class="org-left">index</td>
<td class="org-left">如果设置为 True ,则将该字段设置为索引</td>
</tr>

<tr>
<td class="org-left">nullable</td>
<td class="org-left">是否可以为 NULL ,就是是否可以为空值</td>
</tr>

<tr>
<td class="org-left">onupdate</td>
<td class="org-left">修改对象时,会自动使用这个属性指定的值</td>
</tr>

<tr>
<td class="org-left">primary_key</td>
<td class="org-left">主键</td>
</tr>

<tr>
<td class="org-left">unique</td>
<td class="org-left">设置为 True 表示该字段的值必需唯一</td>
</tr>

<tr>
<td class="org-left">comment</td>
<td class="org-left">创建表时的注释</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9309e5a" class="outline-4">
<h4 id="org9309e5a">CRUD 操作</h4>
<div class="outline-text-4" id="text-org9309e5a">
<p>
使用 ORM 进行 CRUD(create,read,update,delete) 操作,需要先把操作添加到会话中,通过
db.session 可以获取到会话对象.会话对象存在于内存,如果需要把会话的操作提交到数据
库中,要调用 db.session.commit() 操作;如果要将会话的操作回滚,要调用
db.session.rollback() .
</p>

<blockquote>
<p>
其实用其他编程语言而不是原生 SQL 操作数据库,跟写 SQL 语句使用存储过程还是触发器
什么的一样,都要提交生效,回滚取消,具体是什么的现在都忘了,有空再去复习下 SQL.
</p>
</blockquote>
</div>

<ul class="org-ul">
<li><a id="org5f10b1c"></a>Create 操作<br />
<div class="outline-text-5" id="text-org5f10b1c">
<p>
使用 ORM 添加/创建以一条数据非常简单,先用 ORM 模型创建一个对象,然后添加到会话中,
再进行 commit 操作就可以了.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">python app.py
</pre>
</div>

<p>
上面代码中创建了 3个User 类的对象,因为 User 类初始化的参数使用的全是关键字参
数,所以必需要写明 username 和 password, 另外,(我自己)也不推荐在数据库相关的对象
相关操作上使用位置参数,这样很容易出错.由于 id 是一个自增的主键,因此可以不需要赋
值,然后再把三个对象添加到会话中(session), 最后统一进行 commit 操作,即可把数据添
加到数据库中.
</p>

<blockquote>
<p>
总是看见 commit 和 rollback, 不查不舒服,还是去查了下,记起来了需要提交和回滚的数
据库里的概念叫做 "事务",有原子性,一致性,隔离性和持久性,事务中的 SQL 语句要么全部
执行,要么全不执行,"事务" 的原子性,一致性和持久性是靠 "日志" 来实现的日志记录了事
务对数据库的更新,如果发生错误,就可以根据日志撤销事务对数据库的更改,让数据库 "回
滚" 到更改前的状态.这应该就是 "会话" 这个概念/对象的存在需要,不可能为所有执行过
的事务都维护一个日志,那样电脑资源的开销应该会巨大,所以是为每个 "会话" 维护一个事
务的日志,会话结束就可以释放这些日志占用的电脑资源(删除日志).
</p>
</blockquote>
</div>
</li>

<li><a id="org5152ffb"></a>Read 操作<br />
<div class="outline-text-5" id="text-org5152ffb">
<p>
Read 就是查询操作. ORM 模型都继承自 db.Model. db.Model 内置的 query 属性有许多方
法,可以实现对 ORM 模型的查寻操作.
</p>

<p>
query 上的方法可分为两大类,分别是提取和过滤.
</p>

<p>
提取和过滤是对应的简单的SQL 查询和复杂的 SQL 查询操作.
</p>

<p>
先看看简单的(提取):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/fetch"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_fetch</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; User &#34920;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#20027;&#38190;&#20026; 1 &#30340; User &#23545;&#35937;(&#35760;&#24405;)</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#31532;&#19968;&#26465;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#25552;&#21462;&#25104;&#21151;!"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码里 ,all() 方法获取所有的 User 对象,即获取 User 表的所有记录(一条记录对应
一个 Use 对象); get() 方法获取指定主键的 User 对象(差不多等价于 <code>select * from
User where id = **</code>);first() 方法获取第一个 User 对象(第一条记录),提取数据常用的
方法:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 10:</span> 提取数据的常用方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">query.all()</td>
<td class="org-left">获取查询结果集的所有对象,列表类型</td>
</tr>

<tr>
<td class="org-left">query.first()</td>
<td class="org-left">获取查询结果集的第一个对象</td>
</tr>

<tr>
<td class="org-left">query.one()</td>
<td class="org-left">获取查询结果集的一个对象,如果对象数量不等于1,则抛出异常</td>
</tr>

<tr>
<td class="org-left">query.one_or_none()</td>
<td class="org-left">与 one 方法类似,结果不等于1时不是抛出异常,而是返回 None</td>
</tr>

<tr>
<td class="org-left">query.get(pk)</td>
<td class="org-left">根据主键获取当前 ORM 模型的第一条数据</td>
</tr>

<tr>
<td class="org-left">query.exists()</td>
<td class="org-left">判断数据是否存在</td>
</tr>

<tr>
<td class="org-left">query.count()</td>
<td class="org-left">获取查询结果集的个数</td>
</tr>
</tbody>
</table>

<p>
复杂的查询(过滤),经常需要根据多个条件进行判断,分组,排序等操作:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_add</span>():
    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/fetch"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_fetch</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; User &#34920;&#20013;&#30340;&#25152;&#26377;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#20027;&#38190;&#20026; 1 &#30340; User &#23545;&#35937;(&#35760;&#24405;)</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#31532;&#19968;&#26465;&#25968;&#25454;</span>
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#25552;&#21462;&#25104;&#21151;!"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">filter &#26041;&#27861;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">filter_by &#26041;&#27861;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.filter_by(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
filter 方法传递查询条件,emm 应该类似与 WHERE 后面的 SQL 语句, filter_by 传递关键
字参数,应该是限制在字段中的查询. filter 可以查询的范围要更广.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 11:</span> 常用的过滤方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">query.filter()</td>
<td class="org-left">根据查询条件过滤</td>
</tr>

<tr>
<td class="org-left">query.filter_by()</td>
<td class="org-left">根据关键字参数过滤</td>
</tr>

<tr>
<td class="org-left">query.slice(start, stop)</td>
<td class="org-left">对结果进行切片操作</td>
</tr>

<tr>
<td class="org-left">query.limit(limit)</td>
<td class="org-left">对结果进行数量限制</td>
</tr>

<tr>
<td class="org-left">query.offset(offset)</td>
<td class="org-left">在查询时条过前面 offset 条数据</td>
</tr>

<tr>
<td class="org-left">query.order_by()</td>
<td class="org-left">根据给定字段排序</td>
</tr>

<tr>
<td class="org-left">query.group_by()</td>
<td class="org-left">根据给定字段分组</td>
</tr>
</tbody>
</table>


<p>
slice(),limit(),offset() 方法比较简单,不用过多讲解,order_by() 和 group_by() 这两
个用的多也不容易理解的需要演示下用法(即使纯 SQL 这两个也属于复杂操作,特别是
groupby 分组):
</p>

<p>
query.order_by():
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">query.order_by()</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27491;&#24207;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(<span style="font-style: italic;">"id"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(User.<span style="font-weight: bold;">id</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20498;&#24207;</span>
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(db.text(<span style="font-style: italic;">"-id"</span>))
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(User.<span style="font-weight: bold;">id</span>.desc())

    <span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> desc
    <span style="font-weight: bold; font-style: italic;">users</span> = User.query.order_by(desc(<span style="font-style: italic;">"id"</span>))


    <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> users:
        <span style="font-weight: bold;">print</span>(user.<span style="font-weight: bold;">id</span>)

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
query.group_by():
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27979;&#35797;&#26159;&#21542;&#33021;&#25104;&#21151;&#36830;&#25509;</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">with db.engine.connect() as conn:</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">rs = conn.execute("select 1")</span>
<span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">print(rs.fetchone())</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user/filter"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_filter</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">query.group_by()</span>
    <span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> func
    <span style="font-weight: bold; font-style: italic;">users</span> = db.session.query(User.username,func.count(User.<span style="font-weight: bold;">id</span>)).group_by(<span style="font-style: italic;">"username"</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#36807;&#28388;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
分组方法是根据某个字段进行分组,主要用来获取分组后的最大值,最小值,平均值,总和等,
多做统计视图用. 因为提取的数据不再是某个模型,所以不能通过 Model.query 的方式获取,而
是通过 db.session.query 来提取,上面的代码获取了所有用户名在表中存在的个数.
</p>
<blockquote>
<p>
如果我没记错,上面的查询语句应该等价于:
SELECT username, count(id) from User group by username;
</p>

<p>
mysql&gt; SELECT username, count(id) from User group by username;
嗯,没错,执行结果:
</p>
<!-- This HTML table template is generated by emacs 29.1 -->
<table border="1">
  <tr>
    <td align="left" valign="top">
      &nbsp;username&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;count(id)&nbsp;
    </td>
  </tr>
  <tr>
    <td align="left" valign="top">
      &nbsp;张三&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;李四&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />
      &nbsp;王武&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </td>
    <td align="left" valign="top">
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;<br />
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;
    </td>
  </tr>
</table>
<p>
3 rows in set (0.00 sec)
</p>
</blockquote>

<p>
过滤是数据提取中很重要的功能,除了直接使用 <code>==</code> <code>!=</code> 之外,下面这些过滤条件在 SQL
中也很常用,但是这些过滤条件只能通过 filter 方法实现:
</p>
<ul class="org-ul">
<li>like : 模糊查询,与 SQL 语句中的 like 类似,可以在搜索字符串两边添加 <code>%</code> 来匹配
任意字符,例如 <code>users = User.query.filter(User.username.like(%张%))</code>,用来查找用
户名里含有 "张" 这个字符的记录</li>
<li>contains: 也是模糊查找,相当于在 like 的搜索字符两边都加上了 <code>%</code>, <code>users =
  User.query.filter(User.username.contains())</code> 和上面查找名字带 "张" 的 like 语
句效果一样.</li>
<li>in : 判断值是否在指定数据集中,为了不与 Python 的 in 关键字混淆,在 in 后面加上
了下划线,实际的方法名为 in_:
<code>users = User.query.filter(User.username.in_(["张三","李四","王五"]))</code></li>
<li>not in: 作用和 in 相反,使用方法也很简单,在 in_ 方法代码的表达式前面加上 <code>~</code> 就
可以了: <code>users = User.query.filter(~User.username.in_(["张三"]))</code></li>
<li>is null: 判断值是否为空,可以通过值判断是否为 None ,也可以通过 is_ 方法判断(下
划线同样是为了不与 Python is 关键字混淆):
<code>users = User.query.filter(User.username==None)</code>, 查询 username 为空的记录
<code>users = User.query.filter(User.username.is_(None))</code>, 和上面代码等价</li>
<li>is not null: 作用和 is null 相反,实际的方法名为 isnot:
<code>users = User.query.filter(User.username!=(None))</code>, 查询 username 不为空的记录
<code>users = User.query.filter(User.username.isnot(None))</code>, 和上面代码等价</li>
<li><p>
and: 用于同时满足多个条件的查询,实际方法名为 and_:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> and_
<span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(and_(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>, User.<span style="font-weight: bold;">id</span> &lt; 10))
</pre>
</div></li>
<li><p>
or: 用于满足一个或多个条件,实际方法名为 or_:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> or_
<span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">filter</span>(or_(User.username==<span style="font-style: italic;">"&#24352;&#19977;"</span>, User.username==<span style="font-style: italic;">"&#26446;&#22235;"</span>))
</pre>
</div></li>
</ul>
</div>
</li>

<li><a id="orgbe2bdae"></a>update 操作<br />
<div class="outline-text-5" id="text-orgbe2bdae">
<p>
更新操作也分为两种,一种针对一条数据,另一种针对多条数据.
</p>

<p>
更新一条数据可以直接修改对象的属性,然后执行 commit 操作:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
user.<span style="font-weight: bold; font-style: italic;">username</span> = <span style="font-style: italic;">"&#24352;&#19977;_&#26356;&#26032;"</span>
db.session.commit()
</pre>
</div>

<p>
多条数据修改的情况,需要先通过 filter 或 filter_by 获取 BaseQuery 对象,然后再调用
update 方法批量修改,最后提交使修改生效:
</p>
<div class="org-src-container">
<pre class="src src-python">User.query.<span style="font-weight: bold;">filter</span>(User.username.like(<span style="font-style: italic;">"%&#24352;&#19977;%"</span>)).update({<span style="font-style: italic;">"password"</span>: User.password+<span style="font-style: italic;">"_&#26356;&#26032;"</span>}, synchronize_session=<span style="font-weight: bold; text-decoration: underline;">False</span>)
db.session.commit()
</pre>
</div>

<blockquote>
<p>
synchronize_session 的作用: <a href="https://stackoverflow.com/questions/70350298/what-does-synchronize-session-false-do-exactly-in-update-functions-for-sqlalch">https://stackoverflow.com/questions/70350298/what-does-synchronize-session-false-do-exactly-in-update-functions-for-sqlalch</a>
</p>

<p>
简单阅读了下,这个是设置 session 的同步策略的,是在执行更新或删除之前同步还是事务
完成之后同步或是其他策略,我们不希望在更新操作没有执行完毕时就修改了内存中会话缓
存的数据库数据,这样很可能导致错误,尤其是我们使用了模糊匹配,还进行的是更新操作,所
以设置为 False ,当会话结束或事务提交之后才同步内存中缓存的数据库数据.
</p>
</blockquote>
</div>
</li>

<li><a id="org2a55605"></a>delete 操作<br />
<div class="outline-text-5" id="text-org2a55605">
<p>
删除也分删除一条或删除多条数据两种.
</p>

<p>
删除单条数据也很简单:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">user</span> = User.query.get(1)
db.session.delete(user)
db.session.commit()
</pre>
</div>
<p>
删除多条数据和更新多条数据类似:
</p>
<div class="org-src-container">
<pre class="src src-python">User.query.<span style="font-weight: bold;">filter</span>(User.username.contains(<span style="font-style: italic;">"%&#24352;&#19977;%"</span>)).delete(synchronize_session=<span style="font-weight: bold; text-decoration: underline;">False</span>)
db.session.commit()
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8f1ce5e" class="outline-3">
<h3 id="org8f1ce5e">表关系</h3>
<div class="outline-text-3" id="text-org8f1ce5e">
<p>
关系型数据库的一个强大功能就是多个表可以建立关系.
</p>

<p>
例如,存储文章信息的表,通常需要作者的信息,但我们不需要直接保存作者信息到文章的表
里,只需要通过用户id 作为外键引用用户表就可以了.
</p>

<p>
这种表关系可以存储非常复杂的数据,且让查询非常迅速.
</p>


<p>
Flask-SQLAlchemy 对数据库的表关系也有对应的映射实现.表关系的建立是通过数据的外键
实现的,Flask-SQLAlchemy 的对应实现就是创建表(db.Model类)时用 db.ForeignKey 指定
另一个表的字段(类属性).
</p>

<p>
表的关系总的来说可以分为3种: 一对多(多对一), 多对多, 一对一.
</p>
</div>

<div id="outline-container-orgd266ccd" class="outline-4">
<h4 id="orgd266ccd">外键</h4>
<div class="outline-text-4" id="text-orgd266ccd">
<p>
外键是数据库里的概念, Flask-SQLAlchemy 中支持在创建 ORM 模型时就指定外键,创建外
键通过 db.ForeginKey 实现. 例如,前面已经有了用户表 User ,现在要创建一个文章表
Article, 来存储每篇文章的信息,包括作者信息,这张表有一个 author_id 字段,通过外键
引用 User 表的 id 字段,就可以保存文章的作者信息:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"Article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"User.id"</span>))
</pre>
</div>
<p>
上面代码中,除了常规的 id,title,content 属性外,还添加了一个 author_id , author_id
通过 db.ForeignKey("User.id") 引用了前面创建的 User 表里的 id 字段. 因为它是引用
的 User 表的 id 字段,所以 author_id 的字段类型也要和 User.id 字段类型一致.
</p>
</div>
</div>

<div id="outline-container-org6e8cf7b" class="outline-4">
<h4 id="org6e8cf7b">一对多关系</h4>
<div class="outline-text-4" id="text-org6e8cf7b">
<p>
一对多和多对一其实是一个概念(吧),或者说是同一个关系不同角度的解释,一篇博客文章只
能属于一个作者,但一个作者可以发布多篇博客,作者和文章就是一对多的关系,换个角度,文
章和作者就是多对一的关系了.
</p>
</div>

<ul class="org-ul">
<li><a id="org2d48010"></a>建立关系<br />
<div class="outline-text-5" id="text-org2d48010">
<p>
关系是通过外键建立的, <a href="#orgd266ccd">外键</a> 部分创建的 Article 模型中其实已经通过 author_id 外键
建立了博客和作者的关系. 但是只是建立了一个外键,通过 Article 对象还是无法直接获取
到 author_id 对应的 User 对象.
</p>

<p>
可以使用 db.relationship 来引用外键指向的 ORM 模型.
</p>

<blockquote>
<p>
我没记错的话这个在数据库的表结构设计中是不能实现,也是没有必要实现的,因为外键一定
是能唯一识别另一个表的某条记录的,一般就是另一个表的主键,而通过这个外键我们就可以
查询另一个表的数据,所以在输出数据视图时经常会根据外键筛选另一个表的数据,就比如要
展示文章/博客的标题和作者,只需要根据 author_id 去 User 表里查找用户名数据即可,所
以实际上数据库的 Article 表只存储了 User 表的主键,并没有存储该主键对应的某条数据,
但是 ORM 模型通过 db.relationship 来引用 User 表的某条记录,就相当于帮我们把根据
这个外键(author_id)去外键对应的表(User) 查找对应记录的操作完成了,我们直接使用就
可以了,但这是 Flask-SQLAlchemy 做的工作,实际数据库中存储的数据应该只会有外键,而
不会真正存储 db.relationship 返回的数据.
</p>
</blockquote>

<p>
在上面的 Article 模型中添加 db.relationship:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    db.session.add(article)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">article</span> = Article.query.filter_by(title=<span style="font-style: italic;">"aa"</span>).first()
    <span style="font-weight: bold;">return</span> article.author.username
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码的视图函数创建了 article 对象,并添加到数据库中,然后提取出其信息,并通过
article.author.username 访问到了 article 对象的用户名.
</p>

<blockquote>
<p>
这个代码其实有点坑, db.ForeignKey 和 db.relationship 的参数竟然用的是字符串,用字
符串引用/表示数据库表或字段的方式是只有在 Python 中写原生的 SQL 代码才会用到的,
而既然已经使用了 ORM 模型了,那么用对应的 User.id 和 User 的类属性和类来表示/指代
表字段和表格才是合乎编程原则的写法吧,况且这种字符串的写法对数据库配置也有要求,比
如 MYSQL 在 windows 上不分大小写,linux 上却是大小写敏感的,这种写法在测试和运行环
境不同时也可能导致错误.
</p>

<p>
既然 SQLAlchemy 提供Python 和数据库的映射,那应该所有的操作都是可以的,实际上我将
字符串的写法替换成 User.id 和 User 之后仍然正确运行了,这说明确实是可行的,作者要
是想用这种写法表示 SQLAlchemy 操作数据库和原生 SQL 语句用法的无缝衔接那我还能理
解,但他连说明都没有,直接就上了代码,有点难受.
</p>

<p>
后面我把用字符串的方式都换成 SQLAlchemy 的映射对象了,结果发现会出现错误,实际上,
用 SQLAlchemy 映射的对象确实可以,但是有一个问题,就是对象在使用时是否被定义的问题,上
面代码替换后正确运行是因为只在 Article 模型里引用了 User 类和 User.id 属性,而
User 是在 Article 前面定义的,所以没错,但在后面我们需要建立 User 和 Article 的双
向关系的时候,在 User 里面引用 Article 就会报措,因为此时 Article 还是未定义的,因
此 SQLAlchemy 使用相关类/对象的名称(字符串)来引用它们,如果参数是字符串就会交由
<a href="https://docs.sqlalchemy.org/en/20/orm/relationship_api.html#sqlalchemy.orm.relationship.params.argument">registry</a> 来处理,由它来生成对相关类/对象/映射的引用.
</p>

<p>
所以这里不管是 "user.id" 还是 "User" 都是交给 registry 处理的, "User" 确实是类名,所
以大写是必要的, ForeignKey() 的参数中 "user.id" 是 &lt;table&gt;.&lt;column&gt; 格式的字符串,所
以 user 确实是表名,经过测试,这个外键的表名或字段引用的写法是大小写敏感的,与使用
什么数据库无关,有了 registry 这一个概念的认知,才容易理解为什么代码使用字符串作为
参数,而不是使用映射类/对象作为参数.
</p>
</blockquote>
</div>
</li>


<li><a id="orgfa0dfd4"></a>建立双向关系<br />
<div class="outline-text-5" id="text-orgfa0dfd4">
<p>
通过上面代码, Article 模型可以通过 author 属性访问到 User 的实例对象,但 User 的
实例对象不能访问到与其关联的 Article 实例对象,因此,为了实现双向的绑定,我们需要在
User 模型上也添加一个 db.relationship 类型的属性 articles, 并且在双方的
db.relationship 上都加上一个参数 back_populates 用于绑定对方访问自己的属性:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, back_populates=<span style="font-style: italic;">"author"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates= <span style="font-style: italic;">"articles"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码在 User 和 Article 模型之间建立了双向关系,现在 User 也能通过 articles 属
性访问 Article 的实例对象了.
</p>
<blockquote>
<p>
另外,这里 back_populates 直接使用的是 "articles" 和 "author" 并没有加 &lt;table&gt;,
我理解的有两个原因,第一是因为 "关系" 在实际数据库中不是一个真实存在的数据,而是数
据库之间联系的一种概念,所以不应该使用 &lt;table&gt;.&lt;column&gt; 这种形式来引用它们, 第二,
正是因为关系是 Sqlalchemy 抽象出来方便我们操作数据的类,所以 registry 在处理它时
肯定是与数据库中真实存在的内容的映射区分开的,说不定是专门在一个存放 "关系" 实例
对象的容器中引用的.
</p>
</blockquote>
</div>
</li>

<li><a id="orgfb1b600"></a>简化关系定义<br />
<div class="outline-text-5" id="text-orgfb1b600">
<p>
上面的 User 和 Article 模型,二者都通过 db.relationship 传递 bakc_populates 参数
实现双向绑定,这种方式还是有些繁琐.我们可以修改一下代码,实现只在一个模型上定义
db.relationship 类属性,就实现双向绑定,只需要在 db.relationship 实例化时传递
backref 参数即可:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
使用 backref 参数的这种方式,删除了 User 中的 articles 属性,并将 Article 中
author 属性的 db.relationship 的 back_populates 修改成 backref. backref 参数可以
自动给对方添加 db.relationship 属性.
</p>

<p>
这种方式虽然方便,但是在模型较多,团队人数较多时很容易造成困扰,为了更直观和方便团
队协作,还是推荐使用 back_populates 实现双向绑定.
</p>

<blockquote>
<p>
backref 双向绑定可以在第一个绑定对象定义后再进行绑定,这样 db.relationship 就可以
直接使用 ORM 的映射对象了,但是又由于第一个对象中没有定义对应的 db.relationship
属性, backref 又只能使用字符串的方式,结果风格还是不统一,所以还是一直使用字符串方
式引用 ORM 对象吧,都交给 registry 处理就好了.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgf12d702" class="outline-4">
<h4 id="orgf12d702">一对一关系</h4>
<div class="outline-text-4" id="text-orgf12d702">
<p>
一对一的关系,只需要在一对多的基础上,将 "多" 的一端设置未 "一"即可.
</p>

<p>
在 Flask-SQLAlchemy 中,给 db.relationship 传递 uselist=False 就可以将 "多" 设置
为 "一", 在数据库层面,还需要在外键上设置 unique=True. 上面的文章与用户的表格和关
系就不适合一对一,所以换成用户表以及用户信息表来举例,为了查询时的速度保证,一般将
用户的详细信息表与用户表分开存储,用用户id 作为联系. 用户和用户信息就是典型的一对
一关系,一位用户只有一条详细信息的数据,一条详细信息的数据只属于一位用户.
</p>

<p>
下面新增一个 UserInfo 模型,与原来的 User 模型建立一对一关系:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)
db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<blockquote>
<p>
这里"多" 的一端指的是字段被用作外键的表,例如 user_info 表用了 user 表的 id 字段
作为外键,那 user 表就是多的一端,所以就将 User 模型中与 UserInfo 模型的关系属性
info 的 db.relationship 中传递 uselist=False 参数.
</p>
</blockquote>

<p>
外键添加到 UserInfo 模型上,所以 UserInfo 是 "一" 端,要将其在数据库层面的实现设置
为 "一",所以将 user_id 属性设置为 unique=False, User 模型是 "多" 端,要在
Flask-SQLAlchemy 层面限制为 "一" 所以将其关系属性 info 的参数 uselist 设置为
uselist=False.
</p>

<p>
此时,如果要在一个 User 对象上添加多个 UserInfo 对象,就会抛出异常.
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)
db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/one2one"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">one2one</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">info1</span> = UserInfo(school=<span style="font-style: italic;">"&#28165;&#21326;"</span>, user=user)
    <span style="font-weight: bold; font-style: italic;">info2</span> = UserInfo(school=<span style="font-style: italic;">"&#21271;&#22823;"</span>, user=user)
    db.session.add(info1)
    db.session.add(info2)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#28155;&#21152;&#25104;&#21151;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
异常结果会显示类似异常: blablabla <b>"Duplicate entry"</b> blablabla, 主要就看
duplicate entry 显示重复的实体/条目,因为 UserInfo 模型的 user_id 属性设置了
unique=True (user_info 表的 user_id 字段设置了unique), 所以在尝试添加两条
user_id 重复的数据时会抛出异常.
</p>
</div>
</div>

<div id="outline-container-org896c7b2" class="outline-4">
<h4 id="org896c7b2">多对多关系</h4>
<div class="outline-text-4" id="text-org896c7b2">
<p>
多对多的关系在数据库层面需要通过一张中间表来实现, Flask-SQLAlchemy 中也是一样
(ORM 是关系型数据库的抽象,当然得保持一致).文章表和标签表就很适合多对多的关系,一
篇文章可以有多个标签,一个标签也可以添加到多个文章上.
</p>


<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)
    <span style="font-weight: bold; font-style: italic;">tags</span> = db.relationship(<span style="font-style: italic;">"Tag"</span>,secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Tag</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"tag"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"tags"</span>)

<span style="font-weight: bold; font-style: italic;">article_tag_table</span> = db.Table(<span style="font-style: italic;">"article_tag_table"</span>,
                             db.Column(<span style="font-style: italic;">"article_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"article.id"</span>,primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)),
                             db.Column(<span style="font-style: italic;">"tag_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"tag.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)
                             )


db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/article/add"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">article_add</span>():

    <span style="font-weight: bold; font-style: italic;">user1</span> = User(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,password=<span style="font-style: italic;">"111111"</span>)
    <span style="font-weight: bold; font-style: italic;">user2</span> = User(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,password=<span style="font-style: italic;">"222222"</span>)
    <span style="font-weight: bold; font-style: italic;">user3</span> = User(username=<span style="font-style: italic;">"&#29579;&#27494;"</span>,password=<span style="font-style: italic;">"333333"</span>)
    db.session.add(user1)
    db.session.add(user2)
    db.session.add(user3)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"aa"</span>, content = <span style="font-style: italic;">"bb"</span>, author = user)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"bb"</span>, content = <span style="font-style: italic;">"cc"</span>, author = user)
    db.session.add(article1)
    db.session.add(article2)
    db.session.commit()

    <span style="font-weight: bold; font-style: italic;">titles</span> = <span style="font-style: italic;">"{} &#30340;&#25991;&#31456;:"</span>.<span style="font-weight: bold;">format</span>(user.username)
    <span style="font-weight: bold;">for</span> article <span style="font-weight: bold;">in</span> user.articles:
        <span style="font-weight: bold;">print</span>(article.title)
        <span style="font-weight: bold; font-style: italic;">titles</span> += article.title + <span style="font-style: italic;">","</span>
    <span style="font-weight: bold;">return</span>  titles

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/one2one"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">one2one</span>():
    <span style="font-weight: bold; font-style: italic;">user</span> = User.query.first()
    <span style="font-weight: bold; font-style: italic;">info1</span> = UserInfo(school=<span style="font-style: italic;">"&#28165;&#21326;"</span>, user=user)
    <span style="font-weight: bold; font-style: italic;">info2</span> = UserInfo(school=<span style="font-style: italic;">"&#21271;&#22823;"</span>, user=user)
    db.session.add(info1)
    db.session.add(info2)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#28155;&#21152;&#25104;&#21151;"</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
为了实现 Article 和 Tag 模型(表格)的多对多,我们用 db.Table 建立了一张新的表格
article_tag_table, 并添加了 article_id 和 tag_id 两个外键来分别关联 article 和
tag 表,然后在 Tag 和 Article 类中分别添加了 tags 和 articles 属性来建立双向关系,
并且都用 secondary="article_tag_table" 来绑定中间表.
</p>
<blockquote>
<p>
这里代码和作者代码有些许不同,作者把 article_tag_table 表格的建立写在最前面,而
Article 和 Tag 模型里使用的是 secondary=article_tag_table, 这样又使用了不同的编
写风格,而且这个风格还与代码块的顺序有关,所以我直接改用字符串,统一交给 registry
处理就好了.
</p>
</blockquote>

<p>
然后我们可以添加一个 many2many 视图函数来添加数据:
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">info</span> = db.relationship(<span style="font-style: italic;">"UserInfo"</span>, back_populates=<span style="font-style: italic;">"user"</span>, uselist=<span style="font-weight: bold; text-decoration: underline;">False</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"article"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.Integer, db.ForeignKey(User.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"User"</span>, backref= <span style="font-style: italic;">"articles"</span>)
    <span style="font-weight: bold; font-style: italic;">tags</span> = db.relationship(<span style="font-style: italic;">"Tag"</span>,secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"articles"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserInfo</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user_info"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">school</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">user_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = db.relationship(<span style="font-style: italic;">"User"</span>, back_populates=<span style="font-style: italic;">"info"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Tag</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"tag"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">articles</span> = db.relationship(<span style="font-style: italic;">"Article"</span>, secondary=<span style="font-style: italic;">"article_tag_table"</span>, back_populates=<span style="font-style: italic;">"tags"</span>)

<span style="font-weight: bold; font-style: italic;">article_tag_table</span> = db.Table(<span style="font-style: italic;">"article_tag_table"</span>,
                             db.Column(<span style="font-style: italic;">"article_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"article.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>),
                             db.Column(<span style="font-style: italic;">"tag_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"tag.id"</span>), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)
                             )


db.create_all()


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/many2many"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">many2many</span>():
    <span style="font-weight: bold; font-style: italic;">article1</span> = Article(title=<span style="font-style: italic;">"11"</span>, content=<span style="font-style: italic;">"abc"</span>)
    <span style="font-weight: bold; font-style: italic;">article2</span> = Article(title=<span style="font-style: italic;">"12"</span>, content=<span style="font-style: italic;">"abcdef"</span>)
    <span style="font-weight: bold; font-style: italic;">tag1</span> = Tag(name = <span style="font-style: italic;">"Python"</span>)
    <span style="font-weight: bold; font-style: italic;">tag2</span> = Tag(name = <span style="font-style: italic;">"Flask"</span>)
    article1.tags.append(tag1)
    article1.tags.append(tag2)
    article2.tags.append(tag1)
    article2.tags.append(tag2)
    db.session.add_all([article1,article2,tag1,tag2])
    db.session.commit()

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#22810;&#23545;&#22810;&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;!"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面的代码中,分别创建了两个 Article 和两个 Tag 对象,然后把两个 Tag 对象分别添加
到 article1 和 article2 中,最后通过 db.session.add_all 方法添加到会话中,再执行
commit 操作.
</p>

<p>
因为两个 Tag 对象都与 article 和 article2 进行了关联,所以在 article 被添加到会话
中后, 两个 Tag 对象也会被添加到会话中,在多对多关系中,添加对象使用的是 append 方
法,移出对象使用 remove 方法.
</p>

<blockquote>
<p>
上面的代码中没有显式对 article_tag_table 操作的部分,但是数据库的
article_tag_table 表中却插入了对应的记录,这就是 db.relationship 的 secondary 参
数的作用了,它帮我们完成了对应的操作,Tag 的实例与 Article 的实例建立关系后就会自
动在 secondary 设置的关系表中插入对应数据. 我的印象中,多对多的关系用原生 SQL 实
现也只是建立相应表结构,然后还是要使用语句插入对应的数据,并没有直接实现关联就自动
插入数据的,也就是说,如果用 SQL 语句,上面代码的数据需要插入两条 article 表数据,两
条 tag 表数据,还有4条 article_tag_table 数据, 或者说是编写 SQL 语句使用存储过程
来实现功能.虽然SQL 也可以实现,但用 SQL 语句实现要么需要一名数据库管理员,或者后台
开发兼职DBA, 但这样就不利于将来数据库的迁移,而且要配置的东西又多了一堆,这样看
来,ORM 模型正的是个好东西亚.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgad73789" class="outline-4">
<h4 id="orgad73789">级联操作</h4>
<div class="outline-text-4" id="text-orgad73789">
<p>
级联操作(cascade) 是操作某个对象时,其关联的对象也会进行对应的操作.
</p>

<p>
数据库层面的级联操作包括级联删除,级联更新等.
</p>

<p>
Flask-SQLAlchemy 提供了比数据库更强大的级联操作. Flask-SQLAlchemy 的级联是通过对
db.relationship 传递 cascade 参数实现的,参数值可以是 all, save-update, merge,
refresh-expire, expunge, delete 中的一个或多个,多个值需要用逗号隔开(半角英文),例
如 "save-update,delete".
</p>

<p>
设置了 cascade 参数的就是父表, 父表数据变化,关联的从表数据也会执行相应操作.为了
不影响前面的数据,我们使用目录和新闻两个新的 ORM 模型来进行测试:
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates(<span style="font-style: italic;">"category"</span>))

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"news"</span>)

db.create_all()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的代码创建了两个模型,分别是新闻的分类模型 Category 和新闻模型 News, 并且都建
立了联系.
</p>
</div>

<ul class="org-ul">
<li><a id="org9fbd710"></a>save-update<br />
<div class="outline-text-5" id="text-org9fbd710">
<p>
save-update 是 cascade 的默认值,即如果不设置 cascade 就按照 save-update 的方式处
理.它的处理方式是当某个对象被添加到会话中时,与其相关联的对象也会被添加进去:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/auto-update"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">auto_update</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category(name = <span style="font-style: italic;">"&#20891;&#20107;"</span>)
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title=<span style="font-style: italic;">"&#20891;&#20107;&#26032;&#38395;1"</span>, content = <span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;1"</span>)
    news.<span style="font-weight: bold; font-style: italic;">category</span> = category
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
上面代码创建了 news 和 category 对象,但只添加和提交了 news 对象,视图函数执行完毕
后会在数据库中发现 category 对象(记录/数据)也被添加到了 category 数据库中,这是因
为它们两个对象之间建立了联系,所以默认的 cascade 选项 auto-update 将相关的对象自
动添加到会话中了.
如果把模型修改影响,将 News 模型中的 category 关系的 cascade 设置为 "" 即啥都不设
置,并取消默认值:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">""</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/auto-update"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">auto_update</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category(name = <span style="font-style: italic;">"&#20891;&#20107;"</span>)
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title=<span style="font-style: italic;">"&#20891;&#20107;&#26032;&#38395;1"</span>, content = <span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;1"</span>)
    news.<span style="font-weight: bold; font-style: italic;">category</span> = category
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#28155;&#21152;&#25104;&#21151;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后再次访问 "/auto-update" ,会发现页面正常返回 "数据添加成功,请在数据库中查看记
录",但是控制台/终端会打印消息:
</p>
<pre class="example" id="orgd6d369c">
Object of type &lt;Category&gt; not in session, add operation along 'News.category' won't proceed db.session.commit()
</pre>
<p>
意思是 category 这个 Category 类的实例没有添加到会话中, 所以 News 的关系属性
category 不会处理相关操作.
在数据库中会发现只有 news 数据添加了,category 数据没有添加,且新添加的 news 数据
category_id 这一字段是 NULL, 这也是因为 category 对象没有被添加到会话中的原因,因
为我们将 "关系" 交给了 Sqlalchemy 处理,所以前面都没有直接在对象实例化时设置外键
的值,而是设置 "关系",其他的交给 Sqlalchemy 处理,但由于这次 cascade 没有被设置为
save-update, 关联的对象 category 没有被添加到会话中,所以获取不到值,自然就为 NULL
了.
</p>

<blockquote>
<p>
以前没有接触过 ORM 模型的时候用过 C# 操作数据库的,那时侯外键的值之类的全都是需要
自己处理,基本就是换了个环境编写和执行原生的 SQL 语句, ORM 将数据库中的关系概念抽
象出来了,确实方便很多.
</p>
</blockquote>
</div>
</li>

<li><a id="orgb475a06"></a>delete<br />
<div class="outline-text-5" id="text-orgb475a06">
<p>
delete 表示当删除某个对象时,被关联的所有对象都会删除,
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">"delete"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/delete"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cascade_delete</span>():
    <span style="font-weight: bold; font-style: italic;">news</span> = News.query.first()
    db.session.delete(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#21024;&#38500;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
访问 "/delete" 后查看数据库表,会发现上面的视图函数中只删除了 news 对象,但是
category 表对应的记录/数据也被删除了.
</p>

<blockquote>
<p>
emm 这个级联给我的印象是记忆中一个叫做触发器的东西,搜索了下,它们的功能确实有些类
似,总之 ORM 的 "关系" 功能真的好用啊,将多个数据库里不同的概念/操作都用一个
relationship 完成了.
</p>
</blockquote>
</div>
</li>

<li><a id="org5eef527"></a>delete-orphan<br />
<div class="outline-text-5" id="text-org5eef527">
<p>
delete-orphan 表示某个对象被父表解除关联时,该对象也会自动被删除(与 delete 不同的
地方).当然了,如果父表中的数据被删除,该对象也会被删除(与 delete 相同的地方).
</p>

<p>
将 Category 的关系属性 newses 修改,然后在视图函数里执行删除操作:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/delete-orphan"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cascade_delete_orphan</span>():
    <span style="font-weight: bold; font-style: italic;">category</span> = Category.query.first()
    <span style="font-weight: bold; font-style: italic;">news</span> = News(title = <span style="font-style: italic;">"&#26032;&#38395;2"</span>, content=<span style="font-style: italic;">"&#26032;&#38395;&#20869;&#23481;2"</span>)
    category.newses.append(news)
    db.session.add(news)
    db.session.commit()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23558; news &#20174; category &#20013;&#35299;&#38500;&#20851;&#32852;</span>
    category.newses.remove(news)
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#25968;&#25454;&#21024;&#38500;,&#35831;&#22312;&#25968;&#25454;&#24211;&#20013;&#26597;&#30475;&#35760;&#24405;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面的代码先将 news 对象添加到 category.newses 关系属性中,然后通过 commit 操作提
交到数据库.然后又将关系移除(解除关联),因为 Category 的 newses 属性设置了 cascade
为 delete-orphan ,所以一旦解除了关联, newses 对象绑定的 news 就成了 orphan(孤儿),那
么就会自动从数据库中被删除. 这个一般用在一对多的关系,不能用于多对多和多对一,比如
上面的例子,删除了一条新闻数据(多),不会影响到新闻分类(一),删除了新闻分类,该分类的
新闻都被删除了,才符合实际.
</p>

<blockquote>
<p>
作者的代码中是没有 session.add 的,事实上学到这里我就觉得这个作者的示例代码经常有
问题,要么像这里一样不能运行,要么像之前一样关键用法也不说明,直接就摆上代码.
</p>

<p>
session.add 是添加记录用的,如果不加上的话,上面第一个commit 之前的语句就相当于创
建了两个对象 category 和 news 然后进行了一些操作,却没有将这些映射到数据库,所以实
际上什么都不会发生,而按照作者给出的代码会报措 <code>ValueError ValueError:
list.remove(x): x not in list</code> 因为数据根本没有添加到数据库,所以数据库映射出来的
category.newses 的关系里并没有 news 对象(数据/记录).
</p>

<p>
只有执行了 session.add() 才会将改变添加到会话中再进行提交操作就将对 ORM 模型的操
作映射到数据库中了,所以这里又可以知道一点,只有一些真正改变数据库的操作才会让ORM
的操作提交到数据库中去,比如增删改查操作,或者是 Sqlalchemy 抽象出来的 "关系" 的操
作,像上面代码中的创建 news 的操作并没有将新建的对象提交到会话,因此作者书中贴出的
代码才会出错.
</p>
</blockquote>
</div>
</li>

<li><a id="orgd5468db"></a>merge<br />
<div class="outline-text-5" id="text-orgd5468db">
<p>
merge 也是默认的 cascade 值(它是可以有多个值的). 在使用 session.merge 合并对象时,会
使用 db.relationship 关联的对象也进行 merge 操作.
</p>

<p>
这个参数作者说很少用到,让我们了解即可.
</p>

<p>
官网的文档:
<a href="https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.merge">session.merge</a>
</p>

<p>
说是用来复制某个实例的状态到当前会话的实例中,emmm 确实不知道干啥用的, 看说明是根
据主键进行合并,合并的概念暂时不去了解了,先留下链接: <a href="https://docs.sqlalchemy.org/en/20/orm/session_state_management.html#unitofwork-merging">merging</a>
</p>
</div>
</li>

<li><a id="org2b2ac55"></a>expunge<br />
<div class="outline-text-5" id="text-org2b2ac55">
<p>
进行移除操作时,将关联的对象也移除.这个操作只将对象从 session 中移除,而不会从数据
库中删除.
</p>
<blockquote>
<p>
进行移除操作的测试时要先理解部分 session 会话的概念, 实例化的 db.Model 类对象都
是存在于 session 中的,对 session 中的对象进行增删改查等影响实际数据库内容的操作
Sqlalchemy 就会完成相应的操作,执行提交操作后就会将 session 中对象的改变映射到数
据库中. 移除操作就是在 session 中删除某个对象,这样的话不管对该对象进行任何操作,
都不会生效了,因为 commit() 对 session 中的对象生效,而该对象不在 session 中.
</p>
</blockquote>

<p>
我们将 News 模型的 category 属性的 cascade 参数修改,并在视图函数中进行测试:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#25152;&#22312;&#30340;&#20027;&#26426;&#21517;,127.0.0.1 &#23601;&#26159;&#26412;&#26426;</span>
<span style="font-weight: bold; font-style: italic;">HOSTNAME</span> = <span style="font-style: italic;">"127.0.0.1"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#30417;&#21548;&#30340;&#31471;&#21475;&#21495;, &#19968;&#33324;&#40664;&#35748;&#37117;&#26159; 3306</span>
<span style="font-weight: bold; font-style: italic;">PORT</span> = 3306
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36830;&#25509; Mysql &#30340;&#29992;&#25143;&#21517;</span>
<span style="font-weight: bold; font-style: italic;">USERNAME</span> = <span style="font-style: italic;">"root"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#25143;&#21517;&#23545;&#24212;&#30340;&#23494;&#30721;</span>
<span style="font-weight: bold; font-style: italic;">PASSWORD</span> = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Mysql &#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#30340;&#25968;&#25454;&#24211;&#21517;&#31216;,&#22914;&#26524;&#36824;&#27809;&#21019;&#24314;&#23601;&#38656;&#35201;&#20808;&#21435;&#25968;&#25454;&#24211;&#36719;&#20214;&#20013;&#21019;&#24314;&#35813;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;">DATABASE</span> = <span style="font-style: italic;">"database_learn"</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19978;&#38754;&#36825;&#20123;&#25968;&#25454;&#37197;&#32622; Flask &#36830;&#25509;&#25968;&#25454;&#24211;&#20351;&#29992;&#30340; URI</span>
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SQLALCHEMY_DATABASE_URI"</span>] = <span style="font-style: italic;">"mysql+pymysql://{}:{}@{}:{}/{}?charset=utf8"</span>.<span style="font-weight: bold;">format</span>(
    USERNAME, PASSWORD, HOSTNAME, PORT, DATABASE)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; SQLAlchemy &#23545;&#35937;,&#29992;&#26469;&#25805;&#20316;&#25968;&#25454;&#24211;</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36825;&#37324;&#30340; SQLAlchemy &#23545;&#35937;&#26159;&#20174; flask_sqlalchemy &#27169;&#22359;&#37324;&#23548;&#20837;&#30340;,&#21644;&#32431;&#31929;&#30340; SQLAlchemy &#26159;&#26377;&#21306;&#21035;&#30340;(&#21543;),&#25152;&#20197;&#21487;&#20197;&#23558; app &#36825;&#20010; Flask &#23545;&#35937;&#20256;&#36827;&#21435;&#20316;&#20026;&#21442;&#25968;</span>
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Category</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"category"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">newses</span> = db.relationship(<span style="font-style: italic;">"News"</span>, back_populates=<span style="font-style: italic;">"category"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">News</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"news"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>,autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text)
    <span style="font-weight: bold; font-style: italic;">category_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"category.id"</span>))
    <span style="font-weight: bold; font-style: italic;">category</span> = db.relationship(<span style="font-style: italic;">"Category"</span>, back_populates=<span style="font-style: italic;">"newses"</span>, cascade=<span style="font-style: italic;">"expunge"</span>)

db.create_all()

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/expunge"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">expunge</span>():
    <span style="font-weight: bold; font-style: italic;">news</span> = News.query.first()
    <span style="font-weight: bold; font-style: italic;">category</span> = news.category
    db.session.expunge(news)
    category.<span style="font-weight: bold; font-style: italic;">name</span> = <span style="font-style: italic;">"&#27979;&#35797;&#20998;&#31867;"</span>
    db.session.commit()
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#23519;&#30475;&#25968;&#25454;&#24211; category &#34920;&#20013;&#31532;&#19968;&#26465;&#25968;&#25454;&#26159;&#21542;&#25913;&#21464;"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面视图函数里通过 news 表的第一条数据获取了对应的 category 表的一条数据,然后将
news 从 session 中移除了,因为 news 设置了 cascade = "expunge" 所以相关联的
category 也从 session 移除了,因此 session 中就不存在 category 了,那对 category
的 name 属性的更改就只是对某个 python 对象的属性更改,而不会被commit 操作映射到数
据库中了,因此 category 的数据不会被更改.
</p>

<blockquote>
<p>
直接修改实例对象属性值属于单条记录的更新操作,也是会影响数据库的,参见 <a href="#orgbe2bdae">update 操作</a>
</p>
</blockquote>
</div>
</li>

<li><a id="orgebc80fe"></a>all<br />
<div class="outline-text-5" id="text-orgebc80fe">
<p>
all 就是 save-update, merge, expunge, delete 的缩写,不包括 delete-orphan.
</p>
</div>
</li>

<li><a id="orgc2161cc"></a>默认值<br />
<div class="outline-text-5" id="text-orgc2161cc">
<p>
cascade 在没有进行设置时的默认值是 save-update 和 merge.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org544cf63" class="outline-3">
<h3 id="org544cf63">ORM 模型迁移</h3>
<div class="outline-text-3" id="text-org544cf63">
<p>
前面的代码里 ORM 模型定义好了之后,是通过 db.create_all 将 ORM 模型映射到数据库的.
</p>

<p>
这种方法只能识别到新增了模型之后映射到数据库中的对于模型中字段的修改,对于类型的
修改是无法做到的.
</p>
<blockquote>
<p>
这里的修改我暂时还不理解是什么意思,我测试了在数据库已建有表的情况下增加表格的字
段,结果抛出异常了,并不会对已有的表格生效,修改其字段属性,也没有生效,也就是说想要
用这种方法修改已有的表结构,需要先将表格删除才行.因为它只对新的表格生效.
</p>
</blockquote>

<p>
在实际开发中都不会使用 db.create_all 来做 ORM 模型的迁移(修改?), 而是借助第三方
插件 Flask-Migrate 实现.
</p>

<p>
Flask-Migrate 是基于 alembic 实现的, alembic 是专门用来给 SQLAlchemy 的 ORM 模型
做迁移的.它需要额外安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-migrate
</pre>
</div>
<p>
alembic 会自动随着 flask-migrate安装. 完成安装后就可以配置使用了.
</p>
</div>

<div id="outline-container-orgd06e655" class="outline-4">
<h4 id="orgd06e655">创建迁移对象</h4>
<div class="outline-text-4" id="text-orgd06e655">
<p>
先创建迁移对象:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">... &#20013;&#38388;&#20195;&#30721;&#30465;&#30053;</span>

db.SQLAlchemy(app)

<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
</pre>
</div>

<p>
上面代码里,先从 flask_migrate 导入了 Migrate 类,然后实例化该类时传入 app 和 db
对象,并且赋值给 migrate 变量.
<b>在后续的迁移操作时, Flask-Migrate 会自动读取 app.py 中的 migrate 变量,所以变量名必需是 migrate</b>
</p>
</div>
</div>

<div id="outline-container-org4345e72" class="outline-4">
<h4 id="org4345e72">初始化迁移环境</h4>
<div class="outline-text-4" id="text-org4345e72">
<p>
创建迁移对象后,要初始化迁移环境.
</p>

<p>
方法是在当前目录的根目录下执行下面命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db init
</pre>
</div>
<p>
执行完成后会在项目根目录生成一个 migrations 文件夹,其中有下列内容:
</p>
<ul class="org-ul">
<li>versions 文件夹: 用于存放后面生成的迁移脚本文件.出次生成是空文件夹.</li>
<li>alembic.ini: alembic 的配置文件.</li>
<li>env.py: 配合 Flask 项目进行迁移的 Python 文件.</li>
<li>script.py.mako: 生成迁移脚本的模板文件.</li>
</ul>


<p>
上面的文件/夹,除非完全了解自己要做什么,否则不要轻易修改其内容.
</p>

<p>
到此为止,初始化迁移环境就已经完成了,后续只需要不断生成迁移脚本和映射脚本就可以完
成迁移工作,无需再次初始化.
</p>
<blockquote>
<p>
flask 以及其插件都更新迭代得比较快有的版本变动比较大,比如这里用的 Flask-Mirgate,
前面单独使用 SQLAlchemy 操作数据库都没有问题,但使用 Flask-Migrate 就出现问题了,
因为 Flask-Sqlalchemy 和 SQLAlchemy 版本并不共享,所以是会存在兼容问题的,比如这里
我们只指定了 Flask 版本,其他的包下载是 pip 自己决定的版本,所以运行初始化命令时其
实是会出错的,SQLAlchemy 2.0 版本开始移除了 <code>__all__</code> 属性,而自动下载的
SQLAlchemy 是(可用的)最新版本的,所以会出现问题,需要在安装时限制版本:
=pip install sqlalchemy&lt;2.0 =
</p>

<p>
emm 这个地方其实我没做实际测试,上面的结论是根据后面用 requirement.txt 安装得出来
的,但查看 org 文档中安装命令的结果记录,发现前面我并没有直接安装 SQLAlchemy, 而是
flask-sqlalchemy 自动安装的依赖,且该依赖的 SQLAlchemy 是1.* 版本的,而我用
requirement.txt 安装时好像加上了 SQLAlchemy ,这可能就会导致 pip 安装时会安装新版
本的 SQLAlchemy 而不是 flask-sqlalchemy 指定的版本,所以后面才会出错.毕竟前面做
flask-sqlalchemy 相关测试的时候没有出错.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgfb4435b" class="outline-4">
<h4 id="orgfb4435b">生成迁移脚本</h4>
<div class="outline-text-4" id="text-orgfb4435b">
<p>
初始化迁移环境后,无论是新增 ORM 模型,或者是 ORM 模型的字段信息发生变化,且想要将
变化同步到数据库中,都需要将当前的修改生成一个迁移脚本,生成迁移脚本的命令如下:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db migrate -m <span style="font-style: italic;">"&#22791;&#27880;&#20449;&#24687;"</span>
</pre>
</div>
<p>
-m 添加备注信息可以方便察看迁移脚本做了哪些事情, -m 不是必需的,但是强烈推荐加上
备注.
</p>

<p>
执行完毕后,会看到 versions 文件夹中新增了一个 python 脚本文件,该文件记录了此次修
改的变更内容.
</p>
</div>
</div>

<div id="outline-container-orgd0de3ca" class="outline-4">
<h4 id="orgd0de3ca">执行迁移脚本</h4>
<div class="outline-text-4" id="text-orgd0de3ca">
<p>
迁移脚本只是写好了修改数据库的代码,但并没有更新数据库(因为这些代码并没有被执行!),所
以我们需要执行生成的迁移脚本,才能将改变映射到数据库中.
</p>

<p>
执行脚本的命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db upgrage
</pre>
</div>

<p>
上面的命令会自动从 versions 文件夹中寻找最新的迁移脚本文件,然后执行迁移脚本文件
中的 upgrage 函数. 这条命令执行完毕后,修改就真正映射到数据库中了.
</p>

<p>
flask-migrate 进行迁移操作需要注意的是,被迁移的 ORM 模型必需被 app.py 间接或直接
加载. 为了代码组织的更有序,一般会把 ORM 模型放到 models.py 文件中,如果 models.py
没有被 app.py 直接/间接加载,那么 models.py 中的 ORM 模型就不会被 flask-migrate
识别到,就不会参见迁移.
</p>

<blockquote>
<p>
这又让我向到了 session 的概念,我认为这些 ORM 模型的类以及类实例化的对象都是存在
于 session 中的,被 app.py 加载就相当于加载到了 session 中,所以 flask-migrate 很
可能就是读取 session 中的 ORM 模型的数据,然后对比数据库中表的参数执行迁移(修改)
操作的. 所以不被 app.py 加载就不能被识别的原因是 session (吧).
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd42e2c5" class="outline-2">
<h2 id="orgd42e2c5">表单</h2>
<div class="outline-text-2" id="text-orgd42e2c5">
<p>
表单是网站和用户进行交互必不可少的元素.
</p>

<p>
表单可以提供文本输入框,单选按钮,复选框,按钮等供用户提交数据.
</p>

<p>
Flask 中, 抽象出来的表单除了可以表示传统的 HTML 标签(元素)外,还有数据验证的作用.数
据被发送到服务器后,服务器会对提交的数据进行验证,因为有非正常用户会尝试提交一些 "
非法"的数据, 来获得服务器的权限或是破坏网站运行.所以要通过数据验证来保证数据合法,通
常在前端也会有数据合法性的验证和限制,但了解过爬虫或是网络安全的都知道会有各种方
法绕过限制,因此服务器端的数据验证仍然是必要的.
</p>

<p>
要实现表单的验证功能,我们需要使用插件 Flask-WTF, Flask-WTF 是对 WTForms 库的封装,让
WTForms 库在 Flask 项目中更方便的被使用,不过 Flask-WTF 提供的功能有限,大部分是直
接从 WTForms 导入的. WTForms 主要有两个功能,分别是验证数据和在模板中渲染表单HTML
标签. WTForms 也还有一些其他的功能,比如 CSRF 保护,文件上传等.
</p>

<p>
安装 Flask-WTF 同时也会安装依赖 WTForms :
激活虚拟环境:
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/demo06
<span style="font-weight: bold;">source</span> ~/flask_web_py3_10/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/demo06
</pre>
</div>



<p>
安装 Flask-Wtf
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-wtf -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<p>
安装完毕后,创建一个 demo06 文件夹用来存放这一章的项目文件(作者创建的 formlearn
文件夹/项目)
</p>
</div>

<div id="outline-container-org7231ebd" class="outline-3">
<h3 id="org7231ebd">表单验证</h3>
<div class="outline-text-3" id="text-org7231ebd">
<p>
通常表单都是用来提交大量/隐私数据的,所以这里以注册的功能为例,讲解表单的验证功能.
</p>

<p>
注册时一般都需要提供邮箱,用户名,密码,确认密码4个字段的数据.
</p>

<p>
首先,在 templates 文件夹中创建一个 register.html 模板文件:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
上面代码中,创建了一个 form 表单标签,然后设置 action 为 url_for('register') ,就是
将 register 视图函数反转为 URL (就是返回 register 视图函数对应的 URL), 在点击提
交按钮时, form 表单就会将表单标签中输入框的内容都提交给这个 URL. 然后设置了
method 为 POST, 指定数据以 POST 方式提交. 然后在 form 标签下,添加了属性 name 分
别为 username, email, password 以及 confirm_password 的input 标签. 最后添加了一
个 type="submit" 的 input 标签,它会生成一个按钮,点击就会提交数据.
</p>

<p>
模板写好后,再用一个视图函数渲染该模板:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
运行项目,访问 <a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 就会看到4个输入框,一个按钮,以及对应
的说明文本,虽然样式简陋,但功能看起来和用过的注册页面差不多.
</p>
</div>

<div id="outline-container-org95c1c0c" class="outline-4">
<h4 id="org95c1c0c">表单类编写</h4>
<div class="outline-text-4" id="text-org95c1c0c">
<p>
上一小节,完成了前端模板代码的编写,用于已经可以通过该简陋的注册页面输入和提交数据
了,这个页面输入的数据也是有一定要求的:
</p>
<ul class="org-ul">
<li>username : 最少要输入3位以上的字符.</li>
<li>email: 格式必须用 <code>**@example.com</code> 的格式.</li>
<li>password: 至少要输入 6 位以上字符.</li>
<li>confirm password: 该内容必需与上面的 password 内容一致.</li>
</ul>


<p>
一般来说,我们不能指望用户完全按照这些要求输入数据,如果用户输入错误,应该在页面中
进行提示.这个一般是通过前端的 JavaScript 来完成的,但是我们需要在服务器端做好验证,因
为有一定技术功底的"用户",可以通过抓包形式获取请求参数,然后用工具或代码构造请求,
来模拟注册,这样就绕开了前端的限制,而此时我们如果不在服务器端进行限制,那就会导致
错误的数据提交到程序中,好点的后果程序出错,网站崩溃,坏一点的可能就被找到漏洞,让人
黑进服务器了.
</p>

<p>
服务器端的验证可以通过 WTForms 来实现:
先在项目根目录创建一个 forms.py 文件:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])
</pre>
</div>

<p>
上面代码从 wtforms 导入 Form 基类,所有表单类都继承自 Form 类. 然后在
RegisterForm 中添加了 username, email, password 和 confirm_password 4个字段,这里
的字段名称必需和模板文件中表单元素的 name 值一致. 前面模板文件中 4 个 input 标签
的name 是 username , email , password 和 confirm_password 与这里一致.
</p>

<p>
这 4 个属性(字段)都是字符串类型,因此使用 StringField 类型,除了 StringField 外,还
有下表这些类型可以用:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 12:</span> Field类的类型</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">字段类型</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">StringField</td>
<td class="org-left">字符串类型</td>
</tr>

<tr>
<td class="org-left">IntegerField</td>
<td class="org-left">整型类型</td>
</tr>

<tr>
<td class="org-left">FloatField</td>
<td class="org-left">浮点类型</td>
</tr>

<tr>
<td class="org-left">DecimalField</td>
<td class="org-left">定点类型</td>
</tr>

<tr>
<td class="org-left">BooleanField</td>
<td class="org-left">布尔类型</td>
</tr>

<tr>
<td class="org-left">DateTimFielde</td>
<td class="org-left">日期时间类型</td>
</tr>

<tr>
<td class="org-left">DateField</td>
<td class="org-left">日期类型</td>
</tr>

<tr>
<td class="org-left">TimeField</td>
<td class="org-left">时间类型</td>
</tr>

<tr>
<td class="org-left">FileField</td>
<td class="org-left">文件类型</td>
</tr>
</tbody>
</table>

<p>
每个字段都传递了 validators 参数,这个参数可以存储多个验证器的集合. 不同的字段应
该根据实际需要设置不同的验证器:
</p>
<ul class="org-ul">
<li>username : 添加了 length 验证器,用来规定最短和最长的字符串长度,如果不在范围,会
提示错误信息,错误信息的内容为 message 指定的值.</li>
<li>email : 添加了 email 验证器,它会自动验证上传的值是否满足邮箱格式,不满足,则提示
message 指定的值.</li>
<li>password: 同样使用 length 验证器,指定长度6-20 字符.</li>
<li>confirm_password: 确认密码是否一致使用的是 equal_to 验证器,验证两个字段的值是
否相等.</li>
</ul>


<p>
除了上面使用的 length , email 和 equal_to 外,WTForms 还提供了这些验证器:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 13:</span> WTForms 常用验证器</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">验证器</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">length(min,max,message)</td>
<td class="org-left">验证长度是否在区间内</td>
</tr>

<tr>
<td class="org-left">email()</td>
<td class="org-left">验证内容是否满足邮箱格式规则</td>
</tr>

<tr>
<td class="org-left">equal_to(filename,message)</td>
<td class="org-left">验证是否和另一个字段的值相等</td>
</tr>

<tr>
<td class="org-left">ip_address(message)</td>
<td class="org-left">验证是否满足 IP 地址的规则</td>
</tr>

<tr>
<td class="org-left">mac_address(message)</td>
<td class="org-left">验证是否满足 mac 地址的规则</td>
</tr>

<tr>
<td class="org-left">number_range(min,max,message)</td>
<td class="org-left">验证数字是否在指定区间</td>
</tr>

<tr>
<td class="org-left">optional(strip_whitespace)</td>
<td class="org-left">设置数据可以为空,并停止其他验证器的验证</td>
</tr>

<tr>
<td class="org-left">input_required(message)</td>
<td class="org-left">验证是否为空</td>
</tr>

<tr>
<td class="org-left">data_required(message)</td>
<td class="org-left">验证是否有效</td>
</tr>

<tr>
<td class="org-left">url(message)</td>
<td class="org-left">验证是否满足 URL 规则</td>
</tr>

<tr>
<td class="org-left">any_of(values,message, values_formatter)</td>
<td class="org-left">验证是否为 values 中的一个</td>
</tr>

<tr>
<td class="org-left">none_of( values, message, values_formatter)</td>
<td class="org-left">验证是否不是 values 中的一个</td>
</tr>

<tr>
<td class="org-left">regexp(regex, flags, message)</td>
<td class="org-left">自己指定正则表达式验证</td>
</tr>
</tbody>
</table>

<p>
这些验证器中, input_required 和 data_required 经常会被混淆, input_required 只是
验证字段是否有值, data_required 则是验证数据是否有效. 如果字段的类型是
Integerfield, 但是传入的数据不能被转换成整型(比如传入 123a ), input_required 会验证成功,因为有值
传入,但 data_required 会验证失败,因为它不能被转换成整型.
</p>

<blockquote>
<p>
验证器都是小写形式,是为了方便使用,它们的原始名称是大驼峰命名法,如 length 的原始
名称是 Length,input_required 的原始名称是 InputRequired.
</p>

<p>
其实我还是更喜欢下划线命名法,可能是 <del>学 C 语言</del> 用 linux 多的原因吧.看起来更清晰
明了
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgde77770" class="outline-4">
<h4 id="orgde77770">视图函数中使用表单</h4>
<div class="outline-text-4" id="text-orgde77770">
<p>
forms.py 中创建完 RegisterForm 表单类后,就可以在视图函数里对数据进行验证了.
前面的视图函数 register 并没有写完(处理表单的部分用 pass 暂替了),现在我们就可以
完善它了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<blockquote>
<p>
运行后又有坑,邮箱验证器需要  email_validator 包提供支持,作者用的 Pycharm Pro 不
知道是不是自动安装了这些包,毕竟是有 Flask 集成的 Pro 版,反正我自己用 pip 安装是没
有的,运行会报措: <code>Exception: Install 'email_validator' for email validation support.</code>
</p>

<p>
运行下面命令安装:
pip install email_validator -i <a href="https://mirrors.163.com/pypi/simple/">https://mirrors.163.com/pypi/simple/</a>
</p>

<p>
然后就可以正常运行了.
</p>

<p>
另外,要使用 flash 消息,必需要配置 SECRET_KEY  或者直接通过 app.secret_key 设置秘
钥
</p>
</blockquote>

<p>
上面代码先创建了一个 RegisterForm 的 form 对象,并且把 request.form 作为参数传递
给 RegisterForm, request.form 是一个类字典类型,用键值对的形式保存了从浏览器中提
交的表单数据. 然后调用了 form.validate() 方法判断 RegisterForm 中定义的所有字段
是否都通过了验证,如果通过了验证,则可以用 form.&lt;字段名&gt;.data 来获取对应字段的数据,这
里是从 form 对象上获取了数据, 而不是从 request.form 上获取数据的原因,就是服务器
获取从浏览器提交的数据,本质上都是字符串类型,所以 request.form 上的所有数据都是字
符串类型,但是经过 form 对象获取的数据是经过处理的. 上面代码中没有获取
confirm_password 的值,是因为它的意义就是验证值和 password 是否一致,如果通过了,就
相等,所以没有必要再次获取.
</p>

<p>
所有数据都获取了就可以保存数据到数据库或是进行其他的操作了,如果表单验证失败了,
可以通过 form.errors 获取错误信息. form.errors 是字典类型 , key 是字段名称,
value 是错误信息的列表,假如表单中什么都不输入就点击提交按钮,那么 form.errors 的
值就会是:
</p>
<pre class="example" id="orgb53397c">
{"username" : ["请输入正确长度的用户名"],
"email": ["请输入正确格式的邮箱"],
"password": ["请输入正确长度的密码"]}
</pre>
<p>
所以在表单验证失败的情况下,通过循环获取 form.errors.values() 可以获取所有内容,并
将它们存储到 flash 中. 然后就可以在模板中把 flash 消息显示出来(目前的代码,如果验
证失败不会有任何提示,虽然我们把错误消息 flash 到了浏览器的 session 中,但是前端模
板并没有读取这些消息的代码.),修改 register.html 读取flash 的消息:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span>&gt;
        {% for message in get_flashed_messages() %}
        &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
如果在浏览器中访问 <a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 什么都不输入,点击提交按钮,就会
显示下列信息:
</p>
<pre class="example" id="org0c5d325">
请输入正确长度的用户名(3-20个字符)
请输入正确格式的邮箱
请输入正确长度的密码
</pre>
</div>
</div>

<div id="outline-container-orgadc778a" class="outline-4">
<h4 id="orgadc778a">自定义验证字段</h4>
<div class="outline-text-4" id="text-orgadc778a">
<p>
虽然 Wtforms 已经提供了许多验证器,但是我们有时候还是需要根据需求自定义验证逻辑.
</p>

<p>
仍然用上面的 RegisterForm 为例子,在验证 email 字段时,除了验证 email 是否满足邮箱
格式,还需要验证邮箱是否已经被注册过了,这就必需查询数据库,来判断邮箱是否存在.如果
要自定义某个字段的验证逻辑,可以在表单类中自定义方法 validate_&lt;fieldname&gt; 来实现,
以验证 email 字段为例:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to

<span style="font-weight: bold; font-style: italic;">registed_email</span> = [<span style="font-style: italic;">'aa@example.com'</span>, <span style="font-style: italic;">'bb@example.com'</span>]

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold;">if</span> email <span style="font-weight: bold;">in</span> registed_email:
            <span style="font-weight: bold;">raise</span> ValidationError(<span style="font-style: italic;">"&#35813;&#37038;&#31665;&#24050;&#32463;&#34987;&#27880;&#20876;"</span>)
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>

<p>
这里用 registed_email 模拟从数据库中查询出的已经被注册的邮箱,真实应用中可以结合
ORM 和数据库进行查找(另外,这种把所有数据读取到程序中进行判断的思路并不现实,只做
测试用).然后在 RegisterForm 中定义了一个 validate_email(self,fiedl) 方法,以后在
视图函数中调用 form.validate() 方法进行验证时,RegisterForm 类的底层会自动调用
validate_email 方法,并且会传递一个 field 参数,这里验证的是 email ,所以这个 field
就代表 email 字段,如果验证的是其他字段,field 就代表其他字段. 然后通过 field.data
就可以那到对应的值,再进行判断,验证失败就抛出 wtforms.ValidationError 异常,并且指
定一个错误信息,这个错误信息会出现在 form.errors 中,成功就直接返回 True.
</p>
<blockquote>
<p>
这个自定义的验证器需要严格按照规则命名 validate_&lt;fieldname&gt; 因为它的生效机制都是
按照命名来得, fieldname 指定了函数内部 field 会获取哪一个字段的值, validate 开头
表示是一个验证器,在 form.validate() 验证时会自动调用. 要是格式不对,就不能生效了.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org162b946" class="outline-3">
<h3 id="org162b946">渲染表单模板</h3>
<div class="outline-text-3" id="text-org162b946">
<p>
WTForms 和 Flask-WTF 提供了将 Python 表单渲染成 HTML 表单模板的功能.
</p>

<p>
以登录为例,先实现一个登录的表单类:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, BooleanField, SubmitField, ValidationError
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> length, email, equal_to
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> FlaskForm

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30331;&#24405;&#34920;&#21333;&#31867;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LoginForm</span>(FlaskForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(label=<span style="font-style: italic;">"Email:"</span>, validators = [email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)], render_kw={<span style="font-style: italic;">"placeholder"</span>:<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#37038;&#31665;"</span>})

    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(label=<span style="font-style: italic;">"Password:"</span>, validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)],
                           render_kw={<span style="font-style: italic;">"placeholder"</span>:<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#23494;&#30721;"</span>})
    <span style="font-weight: bold; font-style: italic;">remember</span> = BooleanField(label=<span style="font-style: italic;">"Remember Me:"</span>)
    <span style="font-weight: bold; font-style: italic;">submit</span> = SubmitField(label=<span style="font-style: italic;">"Submit"</span>)

<span style="font-weight: bold; font-style: italic;">registed_email</span> = [<span style="font-style: italic;">'aa@example.com'</span>, <span style="font-style: italic;">'bb@example.com'</span>]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34920;&#21333;&#31867;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=3,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;(3-20&#20010;&#23383;&#31526;)"</span>)])
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[length(<span style="font-weight: bold;">min</span>=6,<span style="font-weight: bold;">max</span>=20,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[equal_to(<span style="font-style: italic;">"password"</span>,message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold;">if</span> email <span style="font-weight: bold;">in</span> registed_email:
            <span style="font-weight: bold;">raise</span> ValidationError(<span style="font-style: italic;">"&#35813;&#37038;&#31665;&#24050;&#32463;&#34987;&#27880;&#20876;"</span>)
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>
<p>
新增的 LoginForm 表单类除了新使用了 Booleanfield 和 SubmitField 字段类外只新增了
label 和 render_kw 两个参数, BooleanField 和 SubmitField 字段和其他字段没什么不
同. label 会被被设置成属性 value 的值, render_kw 可以设置表单标签的一些其他属性,
比如上面的 placeholder .
LoginForm 和 RegisterForm 最大的区别是它继承自 FlaskForm 类,而不是 Form 类,
FlaskForm 的父类是 wtforms.Form 类,其在 wtforms.Form 类的基础上增加了一些方便的
方法,来让验证表单数据时,不再需要手动传入 request.form.
</p>

<p>
定义好了表单类后,就可以在视图函数中使用,因为这个表单类和模板深度结合,所以使用方
式有所不同了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(meta={<span style="font-style: italic;">"csrf"</span>:<span style="font-weight: bold; text-decoration: underline;">False</span>})
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<blockquote>
<p>
又有坑来
了
,<a href="https://stackoverflow.com/questions/71652965/importerror-cannot-import-name-safe-str-cmp-from-werkzeug-security">https://stackoverflow.com/questions/71652965/importerror-cannot-import-name-safe-str-cmp-from-werkzeug-security</a>
通过 WTForms 定义表单类并渲染表单的方式会用到 Werkzeug 包, 新版的 Werkzeug 包移
除了 safe_str_cmp, 所以上面代码运行就会报措,根据前面贴出的链接,将 Werkzeug 重新
安装成 2.0.0 且将 Jinja2 安装成 3.0.2 版本,才能正常运行.
</p>
</blockquote>
<p>
上述代码,定义一个 login 视图函数,支持 GET 和 POST 请求,然后创建一个 LoginForm 对
象,并通过传递 meta 参数关闭了 CSRF 验证(<a href="#org26ded82">CSRF 攻击</a> 中会讲到). 不同的重点在于渲染
模板的代码, 我们把 form 对象传递给了 login.html 模板,而在 login.html 模板中,就可
以使用 form 对象来渲染表单了:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Login Page</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tbody</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.email.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.password.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.submit }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;/<span style="font-weight: bold;">tbody</span>&gt;
      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
上述代码,通过 form.&lt;fieldname&gt;.label 渲染了 email, password 和 remember 三个字段
的label标签, 每个字段下面循环 form.&lt;fieldname&gt;.errors 进行验证,若验证出错,就会展
示错误信息.
再重新看看 login() 视图函数,调用 form.validate_on_submit() 判断是否通过 POST 请
求使表单验证成功,如果通过,就下一步,否则仍然渲染 login.html 模板. 此时重新渲染的
模板中传递的 form 已经保存了验证失败的信息,所以在模板中用
form.&lt;fieldname&gt;.errors 可以获取对应字段的错误信息,访问
<a href="http://127.0.0.1:5000/login">http://127.0.0.1:5000/login</a> 不输入数据,直接提交,可以看到错误信息都显示出来了.
</p>

<blockquote>
<p>
作者并不推荐使用 WTForms 和 Flask-WTF 在模板中渲染表单. 因为在 Python 类中去定义
HTML 的标签以及样式,会提高代码的耦合度,造成本该在 HTML 模块中完成的工作却要在
Python 文件中修改,这在前后端工程师共同开发时缺点尤为明显.
</p>

<p>
这点我有点体会,之前也看过一本学 Flask 的书,上来就给我用 Flask 渲染表单,给我一种
不仅要做后端开发,还要别扭的用 python 做前端工作的感觉, 一想到学这个要一个人干两
个人的活,那本书就看不下去了.印象深刻,当时其实都没看太懂,所以就记得那本书讲了个表
单我就读不下去了.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org26ded82" class="outline-3">
<h3 id="org26ded82">CSRF 攻击</h3>
<div class="outline-text-3" id="text-org26ded82">
<p>
CSRF &#x2013; cross site request forgery (跨站请求伪造) 我听别人提到都简称叫跨域攻击.
CSRf 是一种网络攻击.(作者建议能理解原理是最好,暂时不能理解可以在掌握了 cookie 和
session 的相关知识再回过头理解)
</p>

<p>
CSRF 攻击原理: 网站通常都是通过 cookie 实现登录功能,浏览器访问某个网站时,会自动
把之前保存在浏览器中的 cookie 数据携带到服务器上. 如果有一个病毒网站,在其网站源
代码中有恶意的 Javascript 代码,当访问这个病毒网站时,会自动给具有 CSRF 漏洞的网站
的服务器发送请求. 因为发送请求时,浏览器会自动把网站的 cookie 数据发送给对应服务
器,而服务器并不知道请求是用户自己发送的还是由恶意代码伪造的,导致服务器接收并处理
了请求,这样就会造成损失.
比如用户曾经使用浏览器登录过 AC 站,该站没有相应的防御 CSRF 的功能,无法识别请求是
伪造的还是真实的,所以用户后面访问恶意网站时,就被伪造了请求,将 AC 站中的账户里的
硬币全部花掉了.
</p>
</div>

<div id="outline-container-orge760275" class="outline-4">
<h4 id="orge760275">防御 CSRF 攻击原理</h4>
<div class="outline-text-4" id="text-orge760275">
<p>
CSRF 攻击的要点,就在于相应的 cookie 会自动发送给服务器,而服务器无法识别携带
cookie 的请求是来自真实用户还是伪造,所以,可以在用户每次访问有表单的网页时,在表单
中加入一个随机的字符串,例如 csrf_token, 同时在 cookie 中加入一个具有相通值的
csrf_token 键值对,以后再发送请求时,必需在表单和 cookie 中携带 csrf_token, 因为在
不同域名下的 Javascript 不能操作对方的 cookie ,所以服务器只有在检测到 cookie 中
的 csrf_token 和表单中的 csrf_token 相同,才会认为请求是正常的,否则就是伪造的.然
后服务器就会进行相应防御操作.
</p>

<blockquote>
<p>
这个和爬虫和反爬虫也有点像啊, 爬虫需要数据就得尽力伪造真实请求,反爬虫机制识别到
了就进行防御,不过这个 CSRF 是在别人访问恶意网站时通过浏览器发送伪造请求,而爬虫直
接就是分析网站的请求,模拟伪造请求发送.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org1996304" class="outline-4">
<h4 id="org1996304">Flask-WTF 防御 CSRF 攻击</h4>
<div class="outline-text-4" id="text-org1996304">
<p>
使用 Flask-WTF 可以方便地实现 CSRF 防御. CSRF 防御可以分为 3 种方式.
</p>
<ol class="org-ol">
<li>全局防御</li>
<li>表单防御</li>
<li>AJAX</li>
</ol>


<p>
三种方式的前提是 cookie 中已经设置好了 csrf, 然后再从表单中获取 csrf_token, 二者
进行比对,一致则通过验证,否则验证失败.
</p>

<p>
<b>全局防御</b>
CSRF 全局防御是通过 Flask-WTF 中的 CSRFProtect 类实现的,它接收 app 作为参数,使用
CSRFProtect 创建对象后,它会自动在 Jinja2 模板的上下文(context) 中添加 csrf_token
函数,然后通过在模板中调用这个函数,就会自动生成 csrf_token.
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20026; app &#35774;&#32622; CSRF &#38450;&#24481;</span>
app.<span style="font-weight: bold; font-style: italic;">secret_key</span> = <span style="font-style: italic;">"&#33258;&#23450;&#20041;&#30340; app &#23494;&#38053;"</span>
CSRFProtect(app)

app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(meta={<span style="font-style: italic;">"csrf"</span>:<span style="font-weight: bold; text-decoration: underline;">False</span>})
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
使用注册页面 register.html 为例,添加 csrf_token:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;&#39029;&#38754;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Username:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Email:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;Confirm Password:&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt; &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"Submit"</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;

      &lt;/<span style="font-weight: bold;">table</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span>&gt;
        {% for message in get_flashed_messages() %}
        &lt;<span style="font-weight: bold;">li</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
修改后的 register.html 添加了一个 type 为 hidden 的input 标签,它不会被显示在浏览
器上,但是点击提交按钮时,它的值仍然会发送给服务器. 这个标签的 name 设置为了
csrf_token, 除非通过配置文件进行了修改,否则,必须将值设置为 csrf_token, 接着调用
csrf_token() 函数,设置 value 值. 这样渲染模板后,在
<a href="http://127.0.0.1:5000/register">http://127.0.0.1:5000/register</a> 察看网页源代码,可以看到类似的 input 标签:
</p>
<pre class="example" id="orge004d60">
&lt;input type="hidden" name="csrf_token" value="IjdiNGFlOTg4ODY5N2NlOTZiYzMwN2UyYzQwNTFmMjU0MGRkMjZmYTIi.ZEeBXg.HrHQkLzkgThu5gt7VuFQTl8KF5o"&gt;
</pre>
<p>
表单中有 csrf_token 之后,在视图函数中调用 form.validate() 方法时, RegisterForm
会自动对比 request.form 中的 csrf_token 是否和 cookie 中的 csrf 值相等,相等就通
过验证,否则验证失败.
</p>

<p>
<b>单表单防御</b>
单表单防御是通过在模板中传递 FlaskForm 子类实现的,也就是<a href="#org162b946">渲染表单模板</a> 中登录功能
的实现. FlaskForm 子类默认是开启 csrf 防御的,如果想要关闭,在创建表单对象时传递
meta={"csrf":False} 就可以了,不传递这个参数就默认开启 CSRF 防御了. 在 login.html
中只要渲染 form.csrf_token, 就会自动生成 type 为 hiddern 类型的 input 标签:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Login Page</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"POST"</span>&gt;
      &lt;<span style="font-weight: bold;">table</span>&gt;
        &lt;<span style="font-weight: bold;">tbody</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.csrf_token }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.email.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.password }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% for error in form.password.errors %}
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ error }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          {% endfor %}

          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember.label }}&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.remember }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">tr</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">td</span>&gt;{{ form.submit }}&lt;/<span style="font-weight: bold;">td</span>&gt;
          &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;/<span style="font-weight: bold;">tbody</span>&gt;
      &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, url_for, render_template, request, redirect, flash
<span style="font-weight: bold;">from</span> forms <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20026; app &#35774;&#32622; CSRF &#38450;&#24481;</span>
CSRFProtect(app)

app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"1234123"</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"POST"</span>, <span style="font-style: italic;">"GET"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm()
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">form = LoginForm()</span>
    <span style="font-weight: bold;">if</span> form.validate_on_submit():
        <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
        <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>, form=form)

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">request.form &#26159; html &#27169;&#26495;&#25552;&#20132;&#30340;&#34920;&#21333;&#25968;&#25454;</span>
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#34920;&#21333;&#36890;&#36807;&#39564;&#35777; form.validate &#36827;&#34892;&#25968;&#25454;&#39564;&#35777;&#36890;&#36807;&#21017;&#36820;&#22238; True</span>
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data

            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36890;&#36807;&#39564;&#35777;&#23601;&#21487;&#20197;&#20445;&#23384;&#29992;&#25143;&#25552;&#20132;&#30340;&#25968;&#25454;&#20102;,</span>
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#19979;&#38754;&#29992; print &#27169;&#25311;&#20445;&#23384;&#25968;&#25454;&#21040;&#25968;&#25454;&#24211;&#30340;&#25805;&#20316;</span>
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"email:"</span>, email)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"password:"</span>, password)
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"username:"</span>, username)
            <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#27880;&#20876;&#25104;&#21151;"</span>
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25968;&#25454;&#27809;&#26377;&#36890;&#36807;&#39564;&#35777;</span>
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> form.errors.values():
                <span style="font-weight: bold;">for</span> error <span style="font-weight: bold;">in</span> errors:
                    flash(error)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"register"</span>))

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
访问 <a href="http://127.0.0.1:5000/login">http://127.0.0.1:5000/login</a> 察看网页源代码,会看到类似这样的 input 标签:
</p>
<pre class="example" id="orga34e80d">
&lt;input id="csrf_token" name="csrf_token" type="hidden" value="IjdiNGFlOTg4ODY5N2NlOTZiYzMwN2UyYzQwNTFmMjU0MGRkMjZmYTIi.ZEeDsg.tKBe_BowLYOtC0aCvX10dxXY6qo"&gt;
</pre>
<p>
同样的,在视图函数中调用 form.validate() 方法会自动比对cookie 和 form 提交的
csrf, 判断是否通过验证.
</p>

<p>
<b>使用AJAX</b>
使用 AJAX 提交表单数据,前提是开启全局 CSRF 保护.
</p>

<p>
为了方便,我们可以在HTML父模板中的 head 标签内添加一个 meta 标签,然后把
csrf_token 添加到该标签中,这样所有子模板都可以获取到 csrf_token:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
  &lt;<span style="font-weight: bold;">head</span>&gt;
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
    &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"base.css"</span>/&gt;
    &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;"> {% block title %}{% endblock %} </span>&lt;/<span style="font-weight: bold;">title</span>&gt;
    {% block head %}{% endblock %}
    &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;/<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">body</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"body"</span>&gt;
      {% block body %}
      {% endblock %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"footer"</span>&gt;
      {% block footer %}
      <span style="font-weight: bold; font-style: italic;">&amp;copy;</span>Copyright 2008 by &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"http://domain.invalid/"</span>&gt;you&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endblock %}&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
在使用 Javascript 发送请求前,先从模板获取 csrf_token, 然后再设置到请求头中.
Flask-WTF 验证 csrf_token ,除了用 cookie 和表单中的值比对外,还会用 cookie 和请求
头中的值进行对比,从请求头中获取,是通过 X-CSRFToken 参数获取的.
</p>

<p>
以 jQuery 为例,设置每次发送请求之前都添加好 csrf_token:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">csrftoken</span> = $(<span style="font-style: italic;">'meta[name=csrf_token]'</span>.attr(<span style="font-style: italic;">'content'</span>))
$.ajaxSetup({
    beforeSend:
    <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">xhr</span>, <span style="font-weight: bold; font-style: italic;">settings</span>){
        <span style="font-weight: bold;">if</span>(!<span style="font-style: italic;">/^(GET|HEAD|OPTIONS|TRACE)$/</span>i.test(settings.type) &amp;&amp; !<span style="font-weight: bold; text-decoration: underline;">this</span>.crossDomain)
            xhr.setRequestHeader(<span style="font-style: italic;">"X-CSRFTOKEN"</span>, csrftoken)
        }
    })
</pre>
</div>
<p>
上面的代码,先从模板文件中获取了 csrf_token 的值, 然后通过设置 beforeSend 方法,在
每次发送请求之前都把 csrf_token 设置到请求头中,这样就可以完成 csrf 的验证了.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd55657a" class="outline-2">
<h2 id="orgd55657a">Flask 进阶</h2>
<div class="outline-text-2" id="text-orgd55657a">
</div>
<div id="outline-container-orgb9622e8" class="outline-3">
<h3 id="orgb9622e8">类视图</h3>
<div class="outline-text-3" id="text-orgb9622e8">
<p>
之前定义的视图都是用函数实现的,所以叫函数视图.
</p>

<p>
视图也可以用类实现,即叫做类视图. 类视图的好处是可以使用继承,把一些 "手脚架" 在父
类中写好,子类只需要实现核心代码即可.
</p>
</div>

<div id="outline-container-org8854176" class="outline-4">
<h4 id="org8854176">基本使用</h4>
<div class="outline-text-4" id="text-org8854176">
<p>
使用 Flask 类视图需要继承 flask.vews.View 类,然后在子类中实现 dispatch_request
方法,这个方法类似于视图函数,可以进行逻辑处理,并且需要返回一个响应(确实和视图函数
一样,逻辑处理并返回响应).
</p>

<p>
以返回所有用户的列表为例,用类视图实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask.views <span style="font-weight: bold;">import</span> View

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ShowUsers</span>(View):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dispatch_request</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"users.html"</span>, objects=users)

app.add_url_rule(<span style="font-style: italic;">"/users/"</span>, view_func=ShowUsers.as_view(<span style="font-style: italic;">"show_users"</span>))
</pre>
</div>

<p>
上面代码里,从 flask.views 导入 View 类,然后定义类视图 ShowUsers, 继承 Views 类.
然后实现 dispatch_request 方法,这个方法里从数据库里获取了所有用户对象,并且渲染模
板,操作方式和视图函数一样.
</p>

<p>
最后把类视图通过 app.add_url_rule 方法与路由绑定,绑定必须通过 as_view() 方法,把
类转换成实际的视图函数. 传递给 as_view 的字符串是视图函数的名称,后面使用 url_for
反转视图函数对应的路由URL 时要用到这个名称 "show_users".
</p>

<p>
这个类视图看起来和函数视图相比并没有什么优势,如果我们重构以下,把 "手脚架" 代码在
父类中提前定义好,用子类实现核心代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask.views <span style="font-weight: bold;">import</span> View

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ListView</span>(View):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_template_name</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">NotImplementedError</span>()

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">render_template</span>(<span style="font-weight: bold;">self</span>, context):
        <span style="font-weight: bold;">return</span> render_template(<span style="font-weight: bold;">self</span>.get_template_name(), **context)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dispatch_request</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"objects"</span>: <span style="font-weight: bold;">self</span>.get_objects()}

        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.render_template(context)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserView</span>(ListView):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_template_name</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"users.html"</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_objects</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> User.query.<span style="font-weight: bold;">all</span>()
</pre>
</div>
<p>
上面代码定义了一个 ListView 父视图,其中预先定义好了用于获取模板的
get_template_name 方法,因为父视图无法知道具体的模板,所以抛出 NotImplementedError
异常,所以子视图必需实现这个方法,并返回模板的路径.
</p>

<p>
此外,还定义了用于渲染模板的 render_template 方法,以及分发请求的 dispatch_request
方法. 子视图 UserView 实现了 get_template_name 和 get_objects 方法,这样子视图就
在代码量最小的情况下实现了列表渲染功能.
</p>
</div>
</div>

<div id="outline-container-org8baa81b" class="outline-4">
<h4 id="org8baa81b">方法限制</h4>
<div class="outline-text-4" id="text-org8baa81b">
<p>
函数视图中,通过 @app.route 的 methods 参数可以限制请求的方法. 类视图则通过定义
methods 属性实现限制请求:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">MyView</span>(View):
    <span style="font-weight: bold; font-style: italic;">methods</span> = [<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>]

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">dispatch_request</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"POST"</span>:
            <span style="font-weight: bold;">pass</span>

app.add_url_rule(<span style="font-style: italic;">"/myview"</span>, view_func=MyView.as_view(<span style="font-style: italic;">"myview"</span>))
</pre>
</div>
<p>
上面代码中, MyView 类定义了 methods 方法,这个类视图就只能通过 GET 和 POST 方法进
行访问了.
</p>
</div>
</div>

<div id="outline-container-org2ac86c8" class="outline-4">
<h4 id="org2ac86c8">基于方法的类视图</h4>
<div class="outline-text-4" id="text-org2ac86c8">
<p>
目前的类视图时通过判断 request.method 来实现不同方法的逻辑代码的,如果让子视图继
承 flask.views.MethodView , 就可以在类视图中重写对应小写形式的方法,如,GET 请求实
现 get 方法,POST 请求实现 post 方法, flask 会自动根据浏览器请求的 HTTP 方法执行
对应方法:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask.views <span style="font-weight: bold;">import</span> MethodView

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserAPI</span>(MethodView):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">users</span> = User.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">pass</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">user</span> = User.from_form_data(request.form)
        <span style="font-weight: bold;">pass</span>

app.add_url_rule(<span style="font-style: italic;">"/users/"</span>, view_func=UserAPI.as_view(<span style="font-style: italic;">"users"</span>))
</pre>
</div>
<p>
访问 <i>users</i> 这个 URL 时,如果使用的是 GET 方法,就会执行 UserAPI 的 get 方法,用
POST 请求就会执行 UserAPI 的 post 方法.
</p>
</div>
</div>

<div id="outline-container-org243d6d8" class="outline-4">
<h4 id="org243d6d8">添加装饰器</h4>
<div class="outline-text-4" id="text-org243d6d8">
<p>
如果想要在类视图中添加装饰器, 例如某些视图需要登录才能访问,可以在类视图中定义一
个类属性 decorators 来实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserAPI</span>(MethodView):
    <span style="font-weight: bold; font-style: italic;">decorators</span> = [user_required]
</pre>
</div>
<p>
上面代码里,user_required 是自定义的装饰器,可以自行实现.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd90d84a" class="outline-3">
<h3 id="orgd90d84a">蓝图</h3>
<div class="outline-text-3" id="text-orgd90d84a">
<p>
现在,所有的视图函数,类视图都写在 app.py 文件中,但随着项目越来越复杂,这种组织代码
的方式会导致 app.py 越来越大,导致维护难度增加,对于实际项目,我们应该将代码进行模
块化, <b>蓝图</b> 就是用来进行模块化的.
</p>

<p>
以豆瓣网站为例,它分好多模块,读书,电影,音乐,同城,小组等. 每一个模块都可以用一个蓝
图来实现,最终在 app 中统一注册所有蓝图,可以让项目结构更清晰.
</p>
</div>

<div id="outline-container-org11fd3d2" class="outline-4">
<h4 id="org11fd3d2">基本使用</h4>
<div class="outline-text-4" id="text-org11fd3d2">
<p>
以用户模块为例,注册一个蓝图:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/list"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#21015;&#34920;"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/profile/&lt;user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_profile</span>(user_id):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#29992;&#25143;&#31616;&#20171;"</span>
</pre>
</div>
<p>
先从 flask 导入 Blueprint 类,然后用该类初始化一个对象,初始化它时传递三个参数:
</p>
<ol class="org-ol">
<li>蓝图名称: 第一个参数是蓝图名称,在使用 url_for 反转蓝图中的某个视图时,需要用到
&lt;蓝图名&gt;.&lt;视图名&gt;, 例如反转 user_list 需要用 <code>url_for("user.user_list")</code>.</li>
<li>模块名: 第二个参数是模块名,一般设置为 <code>__name__</code>, 用于寻找模板文件和静态文件.</li>
<li>URL 前缀: 第三个参数是 URL 前缀, 以后访问这个蓝图的所有 URL, 都必须加上 /user
前缀,例如获取用户列表的 URL 为 <code>/user/list</code></li>
</ol>


<p>
蓝图注册完成后,还需要将其在 Flask 对象 app 中进行注册:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30465;&#30053;&#20013;&#38388;&#20195;&#30721;</span>

app.register_blueprint(user_bp)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2e3c18a" class="outline-4">
<h4 id="org2e3c18a">寻找模板</h4>
<div class="outline-text-4" id="text-org2e3c18a">
<p>
在蓝图中渲染模板,默认会从项目的根路径下的 templates 文件夹中寻找. 如果想要更换路
径,可以在初始化 Blueprint 对象时,传递 template_folder 参数实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>, template_folder=<span style="font-style: italic;">"templates"</span>)
</pre>
</div>
<p>
这样,在后面渲染模板时,例如 <code>return render_template("user.html")</code>, 默认从项目根目
录的 templates 文件夹中寻找 user.html, 如果没有找到,就会从蓝图所在的文件夹下的
templates 文件夹中寻找.
</p>

<blockquote>
<p>
这里的 template_folder 和实例化 Flask 对象时指定的 template_folder 差不多,其实它
们都是相对于文件所在根目录的,app.py 所在的文件夹就是项目根目录,所以实例化 Flask
对象时指定的 template_folder 是相对于项目目录的路径, 而实例化 Blueprint 时指定的
tempalte_folder 就是相对于该文件所在的目录路径了.
</p>

<p>
按照作者所说,查找模板先查找 app 设置的 template_folder 路径,然后再找 Blueprint
设置的 template_folder, 那么就会设计到重名的问题了,我猜后续在使用蓝图时,模板的命
名一定会带上类似于 <code>bp_user_</code> 这样的前缀的.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org1ea3730" class="outline-4">
<h4 id="org1ea3730">寻找静态文件</h4>
<div class="outline-text-4" id="text-org1ea3730">
<p>
在没有设置的情况下,Jinja2 默认在项目的根目录下的 static 文件夹中寻找静态文件. 在
初始化 Blueprint 对象时,通过 static_folder 参数可以指定静态文件的路径:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>, static_folder=<span style="font-style: italic;">"static"</span>)
</pre>
</div>

<p>
static_folder 可以是相对路径(相对于蓝图文件所在的目录),也可以是绝对路径.在配置完
蓝图后,还需要注意如何在模板中引用静态文件. 模板中引用蓝图,应该使用
<code>&lt;蓝图名&gt;.static</code> 的格式:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.static', filename='about.css') }}"</span>&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8bf2e9a" class="outline-3">
<h3 id="org8bf2e9a">cookie 和 session</h3>
<div class="outline-text-3" id="text-org8bf2e9a">
<p>
cookie 和 session 是 Web 开发中常用的技术,因为 HTTP 请求是无状态的,每次请求之间
是独立的,第一次请求成功后,第二次请求服务器仍然不知道是谁发送的请求. session 和
cookie 就是为了解决这个问题出现的.
</p>

<blockquote>
<p>
HTTP 请求就像脸盲患者,就算第一次认识了,第二次还是不认得朋友的脸,但可以通过服装,
身高,声音,语气等特征来确定某个 "认不清脸" 的人是不是自己的朋友.
</p>
</blockquote>
</div>

<div id="outline-container-org7d03b32" class="outline-4">
<h4 id="org7d03b32">关于 cookie 和 session 的介绍</h4>
<div class="outline-text-4" id="text-org7d03b32">
</div>
<ul class="org-ul">
<li><a id="org2c61bc9"></a>cookie<br />
<div class="outline-text-5" id="text-org2c61bc9">
<p>
cookie 是为了解决 HTTP 请求无状态的问题出现的. 如果想要识别用户,在第一次请求后,
在服务器端生成一段能识别用户的数据,存放到 cookie 中,然后返回给浏览器,浏览器会自
动存储 cookie 数据. 当该用户对同一网站发送第二次请求时,浏览器会自动把上次请求存
储的 cookie 发送给服务器,服务器通过浏览器发送的 cookie 就能知道是哪个用户了.
</p>

<p>
cookie 存储的数据量有限, 不同的浏览器存储容量不同,但是一般不超过 4KB, 因此
cookie 只适合存储少量数据.
</p>
</div>
</li>

<li><a id="org473ac61"></a>session<br />
<div class="outline-text-5" id="text-org473ac61">
<p>
cookie 和 session 作用类似,都是存储用户相关的信息. 不同的是 cookie 是真实存储在
浏览器中的, 而 session 是一个概念,一个服务器存储授权信息的解决方案, 不同的服务器,不
同的框架,不同的编程语言都有不同的实现.
</p>

<p>
Web 发展到现在, session 已经有了非常成熟的解决反干,现在的市场环境中(作者写书是在
2022年之前,这本书是 2022 年出版的,至少电子版是),一般 session 的存储方案有下面两
种:
</p>
<ol class="org-ol">
<li><p>
存储在服务器端: 服务器在存储 session 时,首先生成 session_id ,然后把
session_id 和具体的 session 数据进行关联,并存储在服务器端,如数据库或缓存中
(Memcached, Redis). 接着把 session_id 存放到 cookie 中返回给浏览器,下次用户访
问时, 因为 cookie 会自动发送到服务器,所以服务器会从 cookie 中获取 session_id,
然后从数据库或缓存中获取具体的 session 数据.
</p>

<p>
把 session 存储在服务器的好处是更加安全,不容易被盗取,坏处是会占用服务器资源,
但是现在硬件条件已经非常先进了,存储一些 session 信息还是很容易的.
</p></li>

<li><p>
存储在客户端: 在存储 session 时,先将 session 加密,然后直接存储在 cookie 中返
回给浏览器,下次用户访问时,从 cookie 中获取 session 数据.
</p>

<p>
Flask 默认就是使用这种方式,当然也可以替换成存储在服务器端的方式.
</p></li>
</ol>
</div>
</li>
</ul>
</div>

<div id="outline-container-org4af7804" class="outline-4">
<h4 id="org4af7804">Flask 中使用 cookie 和 session</h4>
<div class="outline-text-4" id="text-org4af7804">
</div>
<ul class="org-ul">
<li><a id="orga797215"></a>Flask 中操作 cookie<br />
<div class="outline-text-5" id="text-orga797215">
<p>
Flask 操作 cookie 是通过响应对像实现的,如 Response 或子类. Response 以及子类有一
个 set_cookie 方法可以设置 cookie, set_cookie 的参数如下:
</p>
<dl class="org-dl">
<dt>key</dt><dd>设置 cookie 的 key.</dd>
<dt>value</dt><dd>设置 cookie 的 value.</dd>
<dt>max_age</dt><dd>设置 cookie 距离现在多少秒后过期.</dd>
<dt>expires</dt><dd>设置 cookie 具体的过期时间,类型为 datetime 或者时间戳.</dd>
<dt>domain</dt><dd>设置 cookie 在哪个域名中有效. 一般设置子域名也能共享 cookie, 例如, cms.example.com</dd>
<dt>path</dt><dd>设置 cookie 在当前域名下的哪些 path 下有效,默认是在所有 path 下都有效.</dd>
</dl>


<p>
在 Flask 中设置和获取 cookie 的示例:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> make_response, request

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622; cookie</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">resp</span> = make_response(render_template())
    resp.set_cookie(<span style="font-style: italic;">"username"</span>, <span style="font-style: italic;">'the username'</span>)

    <span style="font-weight: bold;">return</span> resp

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; cookie</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/user"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user</span>():
    <span style="font-weight: bold; font-style: italic;">username</span> = request.cookies.get(<span style="font-style: italic;">"username"</span>)
</pre>
</div>
<p>
用 make_response 获取一个 Response 对象,然后调用 set_cookie 方法设置 cookie 数据,最
后在 user 视图函数中通过 request.cookies.get 方法获取 cookie 数据.
</p>
</div>
</li>

<li><a id="orgef6a633"></a>Flask 中操作 session<br />
<div class="outline-text-5" id="text-orgef6a633">
<p>
Flask 操作 session 是通过全局对象 flask.session 实现的, flask.session 是一个类字
段类型,对 session 做增删改查都可以使用字典相关的方法:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> session

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;session</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = <span style="font-style: italic;">"The user name"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20854;&#20313;&#20195;&#30721;&#30465;&#30053;</span>

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; session</span>

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user</span>():
    <span style="font-weight: bold; font-style: italic;">username</span> = session[<span style="font-style: italic;">"username"</span>]

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20854;&#20313;&#20195;&#30721;&#30465;&#30053;</span>
</pre>
</div>
<p>
另外, 使用 session 的前提是, 在 app.config 中配置好 SECRET_KEY.
</p>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org5c5efde" class="outline-3">
<h3 id="org5c5efde">request 对象</h3>
<div class="outline-text-3" id="text-org5c5efde">
<p>
Flask 中,要获取客户端提交的数据,可以通过全局线程安全对象 flask.request 实现.
</p>

<p>
flask.request 对象封装了许多属性和方法,常用的属性和方法如下表:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 14:</span> 常用的属性和方法</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">属性/方法</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">args</td>
<td class="org-left">客户端通过查询字符串传递过来的参数,其中查询字符串是经过解析的</td>
</tr>

<tr>
<td class="org-left">form</td>
<td class="org-left">客户端通过表单传递过来的参数</td>
</tr>

<tr>
<td class="org-left">url</td>
<td class="org-left">当前请求的 URL</td>
</tr>

<tr>
<td class="org-left">base_url</td>
<td class="org-left">类似于 url, 但是会去掉查询字符串参数</td>
</tr>

<tr>
<td class="org-left">cookies</td>
<td class="org-left">客户端发送过来的 cookie 数据</td>
</tr>

<tr>
<td class="org-left">files</td>
<td class="org-left">客户端发送过来的文件数据</td>
</tr>

<tr>
<td class="org-left">host</td>
<td class="org-left">客户端请求当前服务器所用的域名</td>
</tr>

<tr>
<td class="org-left">host_url</td>
<td class="org-left">客户端请求当前服务器协议以及所用的域名</td>
</tr>

<tr>
<td class="org-left">is_secure</td>
<td class="org-left">是否用 HTTPS 或 WSS 协议发送</td>
</tr>

<tr>
<td class="org-left">method</td>
<td class="org-left">当前请求使用的方法,如 GET 和 POST 等</td>
</tr>

<tr>
<td class="org-left">path</td>
<td class="org-left">客户端发送请求的 URL 中 path 部分</td>
</tr>

<tr>
<td class="org-left">query_string</td>
<td class="org-left">客户端发送的查询字符串,没有经过解析. args 属性是通过解析的</td>
</tr>

<tr>
<td class="org-left">remote_addr</td>
<td class="org-left">客户端发送请求所用的地址,可一试 IP 地址或者域名</td>
</tr>

<tr>
<td class="org-left">user_agent</td>
<td class="org-left">通过 user_agent.string 可以获取发送请求的浏览器类型</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
emm 写爬虫的时候一般都会伪造请求头,其中就有 User-Agent, 不伪造 User-Agent, 服务
器端可以直接看到请求是从程序发送的而不是浏览器发送的,最容易识别的了.
</p>
</blockquote>

<p>
flask.request 对象完整的属性和方法参考官方文档: <a href="https://flask.palletsprojects.com/en/2.2.x/api/?highlight=flask%20request#incoming-request-data">flask.Request</a>
</p>
</div>
</div>

<div id="outline-container-orge6cf06a" class="outline-3">
<h3 id="orge6cf06a">Flask 信号机制</h3>
<div class="outline-text-3" id="text-orge6cf06a">
<p>
信号是 Flask 中非常强大的功能. 从软件工程角度来讲,可以让数据传递代码彼此解耦;从
功能实现角度讲,可以在某个事件发生时,自动执行一系列配套操作.
</p>
</div>

<div id="outline-container-orga7c8da2" class="outline-4">
<h4 id="orga7c8da2">自定义行号</h4>
<div class="outline-text-4" id="text-orga7c8da2">
<p>
Flask 从0.6 版本开始支持信号机制.
</p>

<p>
信号的作用是在某个事情发生时,直接通知某个函数执行,可以达到代码解耦的效果.
</p>

<p>
Flask 的信号是通过第三方库 blinker 实现的.
</p>

<p>
创建信号的代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> blinker <span style="font-weight: bold;">import</span> Namespace

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23450;&#20041; Namespace &#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">my_signals</span> = Namespace()

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314;&#21517;&#31216;&#20026; model-saved &#30340;&#20449;&#21495;</span>

<span style="font-weight: bold; font-style: italic;">model_saved</span> = my_signals.signal(<span style="font-style: italic;">"model-saved"</span>)
</pre>
</div>
<p>
上述代码创建了一个 Namespace 对象 my_signals 然后通过 my_signals.signal 方法添加
了一个名称为 model-saved 的信号.
创建信号后还需要 "订阅" 此行号,也就是设置该信号发生时,执行什么代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_model_saved</span>(sender):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"&#25429;&#33719;&#21040;&#20449;&#21495;,&#21457;&#36865;&#32773;&#20026;: {}"</span>.<span style="font-weight: bold;">format</span>(sender))

my_signals.connect(log_model_saved)
</pre>
</div>
<p>
上述代码中,通过 my_signals.connect 方法 "订阅" 信号,在信号产生后,会执行
log_model_saved 方法.
</p>

<p>
然后在其他代码需要时,就可以通过 my_signals.send 来发送信号:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Model</span>(<span style="font-weight: bold;">object</span>):
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30465;&#30053;&#37096;&#20998;&#20195;&#30721;</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">save</span>(<span style="font-weight: bold;">self</span>):
        model_saved.send(<span style="font-weight: bold;">self</span>)
</pre>
</div>
<p>
上述代码中, model_save.send 方法中的第一个参数就是发送者,在订阅的函数中可以通过
sender 参数获取发送者的信息.
</p>
</div>
</div>

<div id="outline-container-org016d594" class="outline-4">
<h4 id="org016d594">Flask 内置信号</h4>
<div class="outline-text-4" id="text-org016d594">
<p>
flask 中提前内置了许多信号,在相应的事件发生后,会发送信号,我们只需要监听即可. 在
监听时,我们可以设置只接收哪个发送者的信号,一般都设置为 app.
</p>
</div>

<ul class="org-ul">
<li><a id="org536013b"></a>flask.template_rendered<br />
<div class="outline-text-5" id="text-org536013b">
<p>
模板渲染完毕后会发送此信号,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> template_rendered

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_template_renders</span>(sender, template, context, *args):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"sender:"</span>, sender)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"template:"</span>, sender)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"context:"</span>, context)

template_rendered.connect(log_template_renders, app)
</pre>
</div>
</div>
</li>

<li><a id="orgbe889a7"></a>flask.request_started<br />
<div class="outline-text-5" id="text-orgbe889a7">
<p>
在接收到请求且到达视图函数之前,会发送此信号,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> request_started
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_request_started</span>(sender, **extra):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"sender:"</span>, sender)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"extra:"</span>, extra)

request_started.connect(log_request_started, app)
</pre>
</div>
</div>
</li>

<li><a id="orgbe399d5"></a>flask.request_finished<br />
<div class="outline-text-5" id="text-orgbe399d5">
<p>
请求结束后,在相应发送到客户端之前会发送此信号,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> request_finished
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_request_finished</span>(sender, response, *args):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"response:"</span>, response)

request_finished.connect(log_request_finished, app)
</pre>
</div>
</div>
</li>

<li><a id="org53b58d8"></a>flask.got_request_exception<br />
<div class="outline-text-5" id="text-org53b58d8">
<p>
请求过程中出现异常时会发送此信号,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> got_request_exception
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_exception_finished</span>(sender, exception, *args):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"sender:"</span>, sender)
    <span style="font-weight: bold;">print</span>( <span style="font-weight: bold;">type</span>(exception))

got_request_exception.connect(log_exception_finished, app)
</pre>
</div>
</div>
</li>

<li><a id="orga1910f5"></a>flask.request_tearing_down<br />
<div class="outline-text-5" id="text-orga1910f5">
<p>
请求完成后,在对象被销毁之前会发送此信号.即使请求过程中发生异常,也会发送此信号,示
例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> request_tearing_down
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">log_request_tearing_down</span>(sender,**kwargs):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"coming..."</span>)

request_tearing_down.connect(log_request_tearing_down, app)
</pre>
</div>
</div>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8823c22" class="outline-3">
<h3 id="org8823c22">常用钩子函数</h3>
<div class="outline-text-3" id="text-org8823c22">
<p>
钩子函数是从收到请求到响应请求的整个过程中可以进行拦截的函数,钩子函数都是通过装
饰器来注册的.下面介绍一些常用的钩子函数
</p>
</div>

<div id="outline-container-org2fb48bd" class="outline-4">
<h4 id="org2fb48bd">before_first_request</h4>
<div class="outline-text-4" id="text-org2fb48bd">
<p>
在收到第一个请求之前执行,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.before_first_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">first_request</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"first time request"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org5b0dca0" class="outline-4">
<h4 id="org5b0dca0">before_request</h4>
<div class="outline-text-4" id="text-org5b0dca0">
<p>
每次收到请求之前执行,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>):
        <span style="font-weight: bold;">setattr</span>(g, <span style="font-style: italic;">"user"</span>, <span style="font-style: italic;">"xxxx"</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbed8c39" class="outline-4">
<h4 id="orgbed8c39">teardown_appcontext</h4>
<div class="outline-text-4" id="text-orgbed8c39">
<p>
不管是否有异常,都会在每次请求之后执行,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.teardown_appcontext</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">teardown</span>(exc=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">if</span> exc <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        db.session.rollback()
</pre>
</div>
</div>
</div>

<div id="outline-container-orge5774c9" class="outline-4">
<h4 id="orge5774c9">context_processor</h4>
<div class="outline-text-4" id="text-orge5774c9">
<p>
上下文处理器在每次渲染模板时,都会把这个钩子函数返回的数据添加到模板中,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.context_processor</span>
<span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"current_user"</span>: <span style="font-style: italic;">"xxx"</span>}
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d4c83e" class="outline-4">
<h4 id="org5d4c83e">errorhandler</h4>
<div class="outline-text-4" id="text-org5d4c83e">
<p>
用于指定在出现非 200 状态码时的错误处理方法,示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.errorhandler</span>(404)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">page_not_found</span>(error):
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"This page does not exist"</span>,404
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org18726a3" class="outline-3">
<h3 id="org18726a3">上下文</h3>
<div class="outline-text-3" id="text-org18726a3">
<p>
使用 Flask 开发项目时,经常使用到4个全局变量,即 request, session, current_app 和
g, 这4个全局变量就是上下文对象. 上下文对象时 Flask 中非常 "优雅" 的设计,其作用是
在请求到来后,不需要再把一些常用的对象在函数间层层传递了. Flask 中的上下文对象如
下表所示:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 15:</span> <a id="org03696ac">Flask 中的上下文对象</a></caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">上下文对象</td>
<td class="org-left">类型</td>
<td class="org-left">说明</td>
</tr>

<tr>
<td class="org-left">flask_request</td>
<td class="org-left">请求上下文</td>
<td class="org-left">保存了用户请求的信息</td>
</tr>

<tr>
<td class="org-left">flask_session</td>
<td class="org-left">请求上下文</td>
<td class="org-left">用于记录多次请求之间的状态,默认加密后存储到 cookie 中,也可以自定义存储方式</td>
</tr>

<tr>
<td class="org-left">flask_current_app</td>
<td class="org-left">应用上下文</td>
<td class="org-left">获取当前的 app 对象,此对象并非真正的 app 对象,而是 app 对象的代理</td>
</tr>

<tr>
<td class="org-left">flask_g</td>
<td class="org-left">应用上下文</td>
<td class="org-left">全局对象,常用于请求到来后函数间共享数据</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org526b544" class="outline-4">
<h4 id="org526b544">线程隔离对象</h4>
<div class="outline-text-4" id="text-org526b544">
<p>
学习上下文对象的原理之前,需要先理解什么是线程隔离对象.
</p>

<p>
线程隔离对象可以使数据在多个线程间拥有独自的备份,不会被其他线程影响.
</p>

<p>
在 Flask 中,每收到一个请求就会开启一个线程,而  Flask 中的上下文对象 中的上下文对
象因为是被存放到了线程隔离对象中,所以即使定义成全局变量,在每个线程间都独有一份备
份.
</p>

<p>
Python 内置的 threading 模块中,通过 threading.local() 可以创建一个用于保存线程隔
离对象的变量:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> threading
<span style="font-weight: bold; font-style: italic;">thread_local</span> = threading.local()
thread_local.<span style="font-weight: bold; font-style: italic;">name</span> = <span style="font-style: italic;">"&#20027;&#32447;&#31243;&#30340;&#21464;&#37327;"</span>

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">thread_func</span>(index):
    thread_local.<span style="font-weight: bold; font-style: italic;">name</span> = <span style="font-style: italic;">"&#32447;&#31243;{} &#30340;&#21464;&#37327;"</span>.<span style="font-weight: bold;">format</span>(index)
    <span style="font-weight: bold;">print</span>(thread_local.name)


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    <span style="font-weight: bold;">for</span> x <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(1,3):
        <span style="font-weight: bold; font-style: italic;">th</span> = threading.Thread(target=thread_func, kwargs={<span style="font-style: italic;">"index"</span>: x})
        th.start()
        th.join()
    <span style="font-weight: bold;">print</span>(thread_local.name)
</pre>
</div>

<p>
上面代码中,创建 threading.local 类的对象,然后在这个对象上绑定了 name 属性,之后在
主线程和子线程中分别赋了不同的值. 执行结果显示,每个线程的 name 值都是不一样的,并
且一个线程修改了 name 的值,不会影响到其他线程. 线程隔离对象的实现原理并不复杂,只
需要根据线程 id 进行区分即可.
</p>

<p>
除了内置的 threading 模块提供的线程隔离对象外, werkzeug 也单独定义了一个
werkzeug.local.Local 类, 这个类的实现逻辑和 threading.local 大同小异,我们来看看
werkzeug.local.Local 的源代码(作者删改了源代码,让读者能关注核心代码)
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">try</span>:
    <span style="font-weight: bold;">from</span> greenlet <span style="font-weight: bold;">import</span> getcurrent <span style="font-weight: bold;">as</span> _get_ident
<span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">ImportError</span>:
    <span style="font-weight: bold;">from</span> threading <span style="font-weight: bold;">import</span> get_ident <span style="font-weight: bold;">as</span> _get_ident

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ContextVar</span>:

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, _name: <span style="font-weight: bold;">str</span>) -&gt; <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">storage</span>: t.Dict[<span style="font-weight: bold;">int</span>, t.<span style="font-weight: bold; font-style: italic;">Dict</span>[<span style="font-weight: bold;">str</span>, t.Any]] = {}

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get</span>(<span style="font-weight: bold;">self</span>, default: t.Dict[<span style="font-weight: bold;">str</span>, t.Any]) -&gt; t.Dict[<span style="font-weight: bold;">str</span>, t.Any]:
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.storage.get(_get_ident()) = value

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">set</span>(<span style="font-weight: bold;">self</span>, value: t.Dict[<span style="font-weight: bold;">str</span>, t.Any]) -&gt; <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">storage</span>[_get_ident()]  = value

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Cloal</span>:
    <span style="font-weight: bold; font-style: italic;">__slots__</span> = (<span style="font-style: italic;">"_storage"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">object</span>.__setattr__(<span style="font-weight: bold;">self</span>, <span style="font-style: italic;">"_storage"</span>, ContextVar[<span style="font-style: italic;">"local_storage"</span>])


    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__getattr__</span>(<span style="font-weight: bold;">self</span>, name):
        <span style="font-weight: bold; font-style: italic;">values</span> = <span style="font-weight: bold;">self</span>.storage.get({})
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold;">return</span> values[name]
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">KeyError</span>:
            <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">AttributeError</span>(name)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__setattr__</span>(<span style="font-weight: bold;">self</span>, name, value):
        <span style="font-weight: bold; font-style: italic;">values</span> = <span style="font-weight: bold;">self</span>._storage.get({}).copy()
        <span style="font-weight: bold; font-style: italic;">values</span>[name] = value
        <span style="font-weight: bold;">self</span>._storage.<span style="font-weight: bold;">set</span>(values)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
<p>
上面代码中,首先在 Local 类创建了 <code>_storage</code> 对象,值为 ContextVar 对象,又在
ContextVar 中定义了一个 storage 对象,是一个字典类型,如果安装了 greenlet 就用
greenlet 的协程id作为字典的键,否则使用 threading 模块的线程id 作为键. storage 字
典的值也是一个字典,这个字典存放的是绑定到这个 Local 对象的属性名和属性值. 阅读
Local 的 <code>__getattr__</code> 和 <code>__setattr__</code> 后,可以发现,绑定到 Local 对象的属性,其实
是间接绑定到了 <code>_storage.storage</code> 上了. werkzeug.local.Local 就是通过这种技术,实
现了线程隔离的对象.
</p>

<blockquote>
<p>
storage 是一个字典,键为协程/线程的 id, 每个不同的键对应不同的线程,处理每个请求都
会创建新的线程,所以现存线程通过 id 值在这个字典中区分/独立开来,每个键设置的值就
是相当于该键独立的了. 这种实现的思路和实现很值得学习.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgd3eec7e" class="outline-4">
<h4 id="orgd3eec7e">LocalStack 类</h4>
<div class="outline-text-4" id="text-orgd3eec7e">
<p>
werkzeug.local.LocalStack 类是一个将对象存放到 werkzeug.local.Local 上的栈结构.
</p>

<p>
flask.request, flask.app 等等都是存放在这个类的实例对象上的,下面是 LocalStack 的
源代码(同样经过作者删改):
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LocalStack</span>:

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>) -&gt; <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">_local</span> = Local()

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__call__</span>(<span style="font-weight: bold;">self</span>) -&gt; <span style="font-style: italic;">"LocalProxy"</span>:
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_lookup</span>() -&gt; t.Any:
            <span style="font-weight: bold; font-style: italic;">rv</span> = <span style="font-weight: bold;">self</span>.top
            <span style="font-weight: bold;">if</span> rv <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
                <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">RuntimeError</span>(<span style="font-style: italic;">"object unbound"</span>)
            <span style="font-weight: bold;">return</span> rv

        <span style="font-weight: bold;">return</span> LocalProxy(_lookup)


    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">push</span>(<span style="font-weight: bold;">self</span>, obj: t.Any) -&gt; t.List(t.Any):
        <span style="font-weight: bold; font-style: italic;">rv</span> = <span style="font-weight: bold;">getattr</span>(<span style="font-weight: bold;">self</span>._local, <span style="font-style: italic;">"stack"</span>, []).copy()
        rv.append(obj)
        <span style="font-weight: bold;">self</span>._local.<span style="font-weight: bold; font-style: italic;">stack</span> = rv
        <span style="font-weight: bold;">return</span> rv <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">type: ignore</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">pop</span>(<span style="font-weight: bold;">self</span>) -&gt; t.Any:
        <span style="font-weight: bold; font-style: italic;">stack</span> = getatte(<span style="font-weight: bold;">self</span>._local, <span style="font-style: italic;">"stack"</span>, <span style="font-weight: bold; text-decoration: underline;">None</span>)
        <span style="font-weight: bold;">if</span> stack <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>
        <span style="font-weight: bold;">elif</span> <span style="font-weight: bold;">len</span>(stack) == 1:
            release_local(<span style="font-weight: bold;">self</span>._local)
            <span style="font-weight: bold;">return</span> stack[-1]
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> stack.pop()

    @<span style="font-weight: bold;">property</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">top</span>(<span style="font-weight: bold;">self</span>) -&gt; t.Any:
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>._local.stack[-1]
        <span style="font-weight: bold;">except</span> (<span style="font-weight: bold; text-decoration: underline;">AttributeError</span>, <span style="font-weight: bold; text-decoration: underline;">IndexError</span>):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
<p>
上面的代码实现了 push 和 pop 方法,用来往栈中添加数据和从栈顶删除数据. 通过 top
属性可以获取栈顶数据. 并且所有数据都存放在 Local 对象中,因此同一个请求/线程的所
有数据都是独立于其他线程/请求的.
</p>

<p>
LocalStack 用在哪里呢? 我们可以在 flask.globals 模块中可以看到:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">_request_ctx_stack</span> = LocalStack()
<span style="font-weight: bold; font-style: italic;">_app_ctx_stack</span> = LocalStack()
</pre>
</div>
<p>
<code>_request_ctx_stack</code> 是用来存放请求上下文(contex) 的栈对象, <code>_app_ctx_stack</code> 是
用来存放应用上下文的栈对象.
</p>

<p>
在请求到达 Flask 项目之后,首先会执行 flask.app.wsgi_app 方法,其源代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">wsgi_app</span>(<span style="font-weight: bold;">self</span>, environ: <span style="font-weight: bold;">dict</span>, start_response: t.Callable) -&gt; t.Any:
    <span style="font-weight: bold; font-style: italic;">ctx</span> = <span style="font-weight: bold;">self</span>.request_context(environ)
    <span style="font-weight: bold; font-style: italic;">error</span>: t.Optional[<span style="font-weight: bold; text-decoration: underline;">BaseException</span>] = <span style="font-weight: bold; text-decoration: underline;">None</span>
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold;">try</span>:
            ctx.push()
            <span style="font-weight: bold; font-style: italic;">response</span> = <span style="font-weight: bold;">self</span>.full_dispatch_request()
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
            <span style="font-weight: bold; font-style: italic;">error</span> = e
            <span style="font-weight: bold; font-style: italic;">response</span> = <span style="font-weight: bold;">self</span>.handle_exception(e)
        <span style="font-weight: bold;">except</span>: <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">noqa: B001</span>
            <span style="font-weight: bold; font-style: italic;">error</span> = sys.exc_info()[1]
            <span style="font-weight: bold;">raise</span>
        <span style="font-weight: bold;">return</span> reponse(environ, start_response)
    <span style="font-weight: bold;">finally</span>:
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">self</span>.should_ignore_error(error):
            <span style="font-weight: bold; font-style: italic;">error</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>
        ctx.auto_pop(error)
</pre>
</div>
<p>
接收到请求后, wsgi_app 首先通过 self.request_context 创建一个 RequestContext 对
象 ctx, 然后调用 ctx.push, 再看看 ctx.push 的源代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">push</span>(<span style="font-weight: bold;">self</span>) -&gt; <span style="font-weight: bold; text-decoration: underline;">None</span>:
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#35831;&#27714;&#19978;&#19979;&#25991;&#26632;&#39030;&#20803;&#32032;</span>
    <span style="font-weight: bold; font-style: italic;">top</span> = _request_ctx_stack.top
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#23384;&#22312;,&#20808;&#21024;&#38500;</span>
    <span style="font-weight: bold;">if</span> top <span style="font-weight: bold;">is</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold; text-decoration: underline;">None</span> <span style="font-weight: bold;">and</span> top.preserved:
        top.top(top._preserved_exc)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#24212;&#29992;&#19978;&#19979;&#25991;&#26632;&#39030;&#20803;&#32032;</span>
    <span style="font-weight: bold; font-style: italic;">app_ctx</span> = _app_ctx_stack.top
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#26632;&#20013;&#27809;&#26377;&#20803;&#32032;,&#21017;&#21019;&#24314;&#19968;&#20010;&#24212;&#29992;&#19978;&#19979;&#25991;,&#25512;&#36865;&#21040;&#26632;&#20013;</span>
    <span style="font-weight: bold;">if</span> app_ctx <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span> <span style="font-weight: bold;">or</span> app_ctx.app != <span style="font-weight: bold;">self</span>.app:
        <span style="font-weight: bold; font-style: italic;">app_ctx</span> = <span style="font-weight: bold;">self</span>.app.app_context()
        app_ctx.push()
        <span style="font-weight: bold;">self</span>._implicit_app_ctx_stack.append(app_ctx)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">self</span>._implicit_app_ctx_stack.append(<span style="font-weight: bold; text-decoration: underline;">None</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23558;&#35831;&#27714;&#19978;&#19979;&#25991;&#25512;&#36865;&#21040;&#26632;&#39030;</span>
    _request_ctx_stack.push(<span style="font-weight: bold;">self</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
<p>
push 方法里,可以看到 <code>_request_ctx_stack</code> 和 <code>_app_ctx_stack</code> 两个对象在这里使用
了.整体逻辑是先将应用上下文推送到 <code>_app_ctx_stack</code> 栈顶,然后推送请求上下文到
<code>_request_ctx_stack</code> 栈顶. 这里可以看到,请求上下文和应用上下文是一起创建和销毁的.
</p>

<p>
但是有两个问题:
</p>
<ol class="org-ol">
<li>这里推送到请求上下文和应用上下文的对象是后面用到的 request 和 current_app 吗?</li>
<li>LocakStack 中的 LocalProxy 是做什么的?为什么需要它?</li>
</ol>
</div>
</div>

<div id="outline-container-orgca7d499" class="outline-4">
<h4 id="orgca7d499">LocalProxy 类</h4>
<div class="outline-text-4" id="text-orgca7d499">
<p>
从下面代码可以看到, current_app, request, session, g 这4个上下文对象全部都是
werkzeug.local.LocalProxy 对象:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">current_app</span>: <span style="font-style: italic;">"Flask"</span> = LocalProxy(_find_app) <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">type: ignore</span>

<span style="font-weight: bold; font-style: italic;">request</span>: <span style="font-style: italic;">"Request"</span> = LocalProxy(partial(_lookup_req_object, <span style="font-style: italic;">"request"</span>))

<span style="font-weight: bold; font-style: italic;">session</span>: <span style="font-style: italic;">"SessionMixin"</span> = LocalProxy(partial(_lookup_req_object, <span style="font-style: italic;">"session"</span>)) <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">type: ignore</span>

<span style="font-weight: bold; font-style: italic;">g</span>: <span style="font-style: italic;">"_AppCtxGlobals"</span> = LocalProxy(partial(_lookup_app_object, <span style="font-style: italic;">"g"</span>))
</pre>
</div>
<p>
看看 LocalProxy 实现的核心源代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LocalProxy</span>:
    <span style="font-weight: bold; font-style: italic;">__slots__</span> = (<span style="font-style: italic;">"__local"</span>, <span style="font-style: italic;">"__name"</span>, <span style="font-style: italic;">"__wrapped__"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(
            <span style="font-weight: bold;">self</span>,
            local: t.Union[<span style="font-style: italic;">"Local"</span>, t.Callable[[], t.Any]],
            name: t.Optional[<span style="font-weight: bold;">str</span>] = <span style="font-weight: bold; text-decoration: underline;">None</span>,
    ) -&gt; <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">object</span>.__setattr__(<span style="font-weight: bold;">self</span>, <span style="font-style: italic;">"_LocalProxy__local"</span>, local)
        <span style="font-weight: bold;">object</span>.__setattr__(<span style="font-weight: bold;">self</span>, <span style="font-style: italic;">"_LocalProxy__name"</span>, name)

        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">callable</span>(local) <span style="font-weight: bold;">and</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(local, <span style="font-style: italic;">"__release_local__"</span>):
            <span style="font-weight: bold;">object</span>.__setattr__(<span style="font-weight: bold;">self</span>, <span style="font-style: italic;">"__wrapped__"</span>, local)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_get_current_object</span>(<span style="font-weight: bold;">self</span>) -&gt; t.Any:
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524; self.__local &#27809;&#26377; __release_local &#23646;&#24615;(&#21363;&#26159;&#19968;&#20010;&#21487;&#35843;&#29992;&#23545;&#35937;)</span>
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(<span style="font-weight: bold;">self</span>.__local, <span style="font-style: italic;">"__release_local__"</span>):
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35843;&#29992;&#36825;&#20010;&#23545;&#35937;</span>
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>.__local()

        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; self.__local &#19978;&#33719;&#21462; self.__name &#30340;&#20540;</span>
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">getattr</span>(<span style="font-weight: bold;">self</span>.__local, <span style="font-weight: bold;">self</span>.__name)
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">AttributeError</span>:
            <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">RuntimeError</span>(f<span style="font-style: italic;">"no object bound to (self.__name)"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">...</span>
</pre>
</div>
<p>
上面只是 LocalProxy 的部分代码. LocalProxy 是一个代理对象, 会对创建 LocalProxy
时传递进来的 local 对象进行代理. 使用 LocalProxy 对象的某个属性时,会自动执行
<code>_get_current_object</code> 方法,该方法会判断 self.__local 是否可以调用,如果可以,则执
行调用,如果不行,则从 self.__local 上获取 self.__name 指定的值.再回头看
current_app 和 request 的实现:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_find_app</span>():
    <span style="font-weight: bold; font-style: italic;">top</span> = _app_ctx_stack.top
    <span style="font-weight: bold;">if</span> top <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">RuntimeError</span>(_app_ctx_err_msg)
    <span style="font-weight: bold;">return</span> top.app

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_lookup_req_object</span>(name):
    <span style="font-weight: bold; font-style: italic;">top</span> = _request_ctx_stack.top
    <span style="font-weight: bold;">if</span> top <span style="font-weight: bold;">is</span> <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">raise</span> <span style="font-weight: bold; text-decoration: underline;">RuntimeError</span>(_request_ctx_err_msg)
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">getattr</span>(top, name)

<span style="font-weight: bold; font-style: italic;">current_app</span>: <span style="font-style: italic;">"Flask"</span> = LocalProxy(_find_app)
<span style="font-weight: bold; font-style: italic;">request</span>: <span style="font-style: italic;">"Request"</span> = LocalProxy(partial(_lookup_req_object, <span style="font-style: italic;">"request"</span>))
</pre>
</div>
<p>
current_app 将 <code>_find_app</code> 函数传给了 LocalProxy, 而 <code>_find_app</code> 就是从
<code>_app_ctx_stack</code> 应用上下文栈获取栈顶数据. 所以,在使用 current_app 时,实际上是先
执行 LocalProxy._get_currrent_object 方法,然后执行 _find_app 方法将
_app_ctx_stack 栈顶数据返回.
</p>

<p>
request 创建时传入的是一个 "偏函数", 使用偏函数可以把 request 传入
<code>_lookup_req_object</code> 进行调用. 执行这个函数时,首先获取 <code>_request_ctx_stack</code> 的栈
顶元素,然后获取栈顶元素上的 request 属性.
</p>

<p>
上下文使用 LocalProxy 代理的原因是因为 Flask 的上下文都是动态推送和删除的,不使用
代理的话,上下文对象就只会被赋值一次,不会随着栈元素的更新而更新.
</p>

<blockquote>
<p>
通常的赋值语句都是赋值一次就完事了,但是使用代理就可以 "动态" 给变量赋值,这里的
"动态" 就是访问代理对象的属性,就会执行对应方法,所以每次访问一次代理对象的属性,该
属性都会由对应的方法重新赋值一次,这个方法获取的值是线程隔离的,所以才能保证每次获
取的都是正确的而且是动态的.
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-org981b76f" class="outline-2">
<h2 id="org981b76f">缓存系统</h2>
<div class="outline-text-2" id="text-org981b76f">
<p>
网站访问量提高时,由于计算机性能限制,网站的性能和响应速度都会收到影响.
</p>

<p>
为了提高网站的性能和响应速度,我们需要对网站进行优化.
</p>
<blockquote>
<p>
目前为止,我们的代码涉及到了处理请求,执行逻辑,保存数据,返回响应等操作,其中,影响性
能最大的是操作数据库,保存数据等 I/O 操作,其他的处理请求,执行逻辑等等都是直接在内
存中进行操作的,而数据的保存和读取则需要等待磁盘读写完成.而磁盘的读写速度是没法和
内存比的.
</p>
</blockquote>
<p>
我们可以把一些不是非常重要的数据存储在缓存中(内存),例如验证码,在线人数,session
等. 缓存系同目前使用的最多的是 Memcached 和 Redis. Memcached 是一个纯内存的缓存
软件,比较轻量级,没有自动同步数据到硬盘的功能. Redis 则更强大,更重量级,它除了可以
把数据存储到内存外,还可以自动定时把数据同步到硬盘中.
</p>
</div>



<div id="outline-container-org994bddc" class="outline-3">
<h3 id="org994bddc">Memcached</h3>
<div class="outline-text-3" id="text-org994bddc">
<p>
Memchaced 是一个高性能的分布式内存对象缓存系统. 用它来构建大负载的网站,可以分担
数据库的压力. Memcached 是通过在内存中维护一张统一的,巨大的 Hash 表来存储各种各
样的数据,包括图像,视频,文件以及数据库检索的结果等等.简单点就是预先把数据从硬盘读
取到内存中,然后再从内存中读取使用这些数据,从而提高读取速度.因为 Memcached 是把数
据读取到内存中,不具备自动同步数据功能,所以不建议存储重要的数据,以免导致数据丢失.
Memcached 的存储方式是键值对的形式.
</p>
<blockquote>
<p>
使用缓存系统就像是算法里用空间换时间的思路,使用读取速度快的内存空间来换取网站的
响应时间.
</p>
</blockquote>
</div>

<div id="outline-container-org884f6dd" class="outline-4">
<h4 id="org884f6dd">安装 Memcached</h4>
<div class="outline-text-4" id="text-org884f6dd">
<p>
Windows 上的下载和安装教程见:<a href="https://www.runoob.com/memcached/window-install-memcached.html">菜鸟教程</a>
</p>

<p>
Memcached 官方支持 Linux ,所以查看其
<a href="https://github.com/memcached/memcached/wiki/Install">https://github.com/memcached/memcached/wiki/Install</a> 文档就好了.
emmm 它的官网好像也在墙外,虽然Github文档打不开的官网应该也打不开,但还是贴出来方
便我查看 <a href="https://memcached.org/">https://memcached.org/</a>
</p>

<p>
我用的 Memcached 1.4.4 64位 版本,因为它看起来命令直接.
在安装文件所在的路径下运行 CMD (管理员权限下运行):
安装:
</p>
<pre class="example" id="org7ded84d">
memcached.exe -d install
</pre>
<p>
启动:
</p>
<pre class="example" id="orgcc56a0c">
memcached.exe -d start
</pre>
<p>
停止:
</p>
<pre class="example" id="orgc6f1539">
memcached.exe -d stop
</pre>
<p>
启动 Memcahed 时,还可以传递以下参数配置 Memcached 的运行方式
</p>
<dl class="org-dl">
<dt>-d</dt><dd>让 Memcached 在后台运行.</dd>
<dt>-m</dt><dd>指定占用多少内存,以MB 为单位,默认是64MB.</dd>
<dt>-p</dt><dd>指定运行监听的端口号,默认端口号是 11211.</dd>
<dt>-l</dt><dd>如设置 <code>-l0.0.0.0</code>, 表示允许其他机器通过本机 IP 地址连接到本机的
Memcached, 默认是只能本机连接.</dd>
</dl>
</div>
</div>


<div id="outline-container-org1e50877" class="outline-4">
<h4 id="org1e50877">telnet 操作 Memcached</h4>
<div class="outline-text-4" id="text-org1e50877">
<p>
Linux 和 Windwos 都有 telnet 命令,下面的命令都是在 Linux 的终端或Windows 的 CMD
终端下完成的.
</p>

<p>
在 Memcached 启动的前提下,在终端输入 <code>telnet 127.0.0.1 11211</code> 就可以进入
Memcached 的命令界面,如果要连接其他及其的 Memcached, 把 127.0.0.1 修改成目标机器
的 IP 即可,而且目标机器在运行时需要通过 <code>-l</code> 参数设置是否允许其他及其连接.
</p>

<div class="org-src-container">
<pre class="src src-shell">telnet 127.0.0.1 11211
</pre>
</div>

<blockquote>
<p>
这里要记录一下, Memcached 在 Windows 上的体验并不好,我成功安装了, stats 命令也正
常返回结果,但是输入下面这些命令不是返回 ERROR 就是返回 BAD FORMAT 命令格式错误,
同样的命令,到 linux 上一点问题都没有,索性这些命令也很简单,在 windows 上直接用命
令操作 Memcached 的过程就不再试验了.如果下面用 Python 操作 Memcached 还是有问题,
那要么是我哪个地方没有安装成功(虽然是按照文档安装的),要么就是软件并没有适配
Windows 系统(从官网上来看确实是这样).
</p>

<p>
而且现在只要 web 开发用到非关系型数据库做缓存系统,一般都是提 redis 了,可能也是这
个原因 Memcached 就没有做 windows 的适配吧.
</p>
</blockquote>


<p>
下面是一些 Memcached 中常用命令的讲解
</p>
</div>
<ul class="org-ul">
<li><a id="org2295d2f"></a>set 命令<br />
<div class="outline-text-5" id="text-org2295d2f">
<p>
使用 set 命令可以将数据添加到 Memcached 中,如果数据的键在 Memcached 中已经存在,
则会进行替换(类似于赋值语句,第二次赋值会替换/覆盖前面的值).
</p>

<p>
语法格式:
</p>
<pre class="example" id="orga338685">
set key zip timeout value_length
</pre>
<p>
参数说明:
</p>
<dl class="org-dl">
<dt>key</dt><dd>数据的键</dd>
<dt>zip</dt><dd>是否压缩数据</dd>
<dt>timeout</dt><dd>过期时间,单位为秒(s)</dd>
<dt>value_length</dt><dd>值的长度</dd>
</dl>


<p>
示例命令:
</p>
<pre class="example" id="org3fa9255">
set username 0 60 7
</pre>
<p>
上面这个命令设置了键为 username 的数据,不进行压缩,其过期时间为 60s 值长度为 7.
</p>
<blockquote>
<p>
一般这种数据的长度设置单位都是字节,应该指的是 7 字节长度的数据.
emm 网上搜了下,别人的格式是: <code>set key flags exptime bytes</code> 这就样很清楚了嘛.
</p>
</blockquote>
</div>
</li>

<li><a id="org376be9b"></a>add 命令<br />
<div class="outline-text-5" id="text-org376be9b">
<p>
add 也用于添加数据,不过如果数据的"键"已存在,则会添加失败.
</p>

<p>
语法格式:
</p>
<pre class="example" id="orgdb33e3f">
add key flags exptime bytes
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org89c1a7a">
add username 0 60 7
</pre>
</div>
</li>

<li><a id="org77ea55a"></a>get 命令<br />
<div class="outline-text-5" id="text-org77ea55a">
<p>
get 命令用于从 Memcached 中获取数据,如果数据过期,则获取失败.
</p>

<p>
语法格式:
</p>
<pre class="example" id="org01b5fe5">
get key
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org371884b">
get username
</pre>
</div>
</li>

<li><a id="org5442ebf"></a>delete 命令<br />
<div class="outline-text-5" id="text-org5442ebf">
<p>
delete 用于从 Memcached 中删除指定的键值对的数据.
</p>

<p>
语法格式:
</p>
<pre class="example" id="orgdfc2878">
delete key
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org230f831">
delete username
</pre>
</div>
</li>

<li><a id="org80dfb11"></a>flush_all 命令<br />
<div class="outline-text-5" id="text-org80dfb11">
<p>
flush_all 命令用于删除 Memcached 中的所有数据.
</p>
<pre class="example" id="orgde4f479">
flush_all
</pre>
</div>
</li>

<li><a id="orgbaf282d"></a>stats 命令<br />
<div class="outline-text-5" id="text-orgbaf282d">
<p>
要查看当前 Memcached 的运行状态,例如存储了多少条数据,总共由多少个连接,可以用
stats 命令查看.
</p>

<p>
语法格式:
</p>
<pre class="example" id="orgd46402b">
stats
</pre>
<p>
命令执行的结果类似下面:
</p>
<pre class="example" id="org30cdb46">
STAT pid 6492			--- 进程ID
STAT uptime 3054540365		--- 总运行时间
STAT time 442154261
STAT version 1.4.4-14-g9c660c0	--- memcached 版本号
STAT pointer_size 64
STAT curr_connections 10	--- 当前连接数
STAT total_connections 18	--- 总连接数
STAT connection_structures 12
STAT cmd_get 0			--- get 命令执行的次数
STAT cmd_set 1			--- set 命令执行的次数
STAT cmd_flush 0
STAT get_hits 0			--- get 命令命中的次数
STAT get_misses 0		--- get 命令未命中的次数
STAT delete_misses 0
STAT delete_hits 0
STAT incr_misses 0
STAT incr_hits 0
STAT decr_misses 0
STAT decr_hits 0
STAT cas_misses 0
STAT cas_hits 0
STAT cas_badval 0
STAT auth_cmds 0
STAT auth_errors 0
STAT bytes_read 321		--- memcached 服务器通过网络读取的总字节数
STAT bytes_written 2743		--- memcached 服务器发送到网路上的总字节数
STAT limit_maxbytes 67108864	--- memcached 分配的内存数
STAT accepting_conns 1		--- 当前接收的连接数
STAT listen_disabled_num 0
STAT threads 4
STAT conn_yields 0
STAT bytes 0			--- 存储数据总字节数
STAT curr_items 0		--- 当前存储的 item 总数
STAT total_items 0		--- mamcached 启动依赖存储的 item 总数
STAT evictions 0
END
</pre>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgf7f244e" class="outline-4">
<h4 id="orgf7f244e">Python 操作 Memcached</h4>
<div class="outline-text-4" id="text-orgf7f244e">
<p>
使用 Python 操作 Memcached 需要先安装 python-memcached:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">source</span> ~/flask_web_py3_10/Scripts/activate
pip install python-memcached
</pre>
</div>
<p>
安装完必后,就可以用它来连接 Memcached 服务并操作 Memcached 了.
</p>
</div>

<ul class="org-ul">
<li><a id="org692feeb"></a>建立连接<br />
<div class="outline-text-5" id="text-org692feeb">
<p>
建立连接的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> memcache
<span style="font-weight: bold; font-style: italic;">mc</span> = memcache.Client([<span style="font-style: italic;">'127.0.0.1:11211'</span>], debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
上面代码导入了 memcache 模块,然后用 memcache.Client 类实例化一个对象,并设置了连
接到哪一个服务器,为了更好调试 Memcached 操作代码,还设置了 debug=True. 后续对
Memcached 服务器执行的操作,都是通过 memcache.Client 对象(mc)实现的
</p>
</div>
</li>

<li><a id="org485cbf0"></a>设置数据<br />
<div class="outline-text-5" id="text-org485cbf0">
<p>
mc.set (<code>memcache.Client.set()</code>)方法可以设置一条数据,通过 mc.set_multi 可以一次
性设置多条数据,并通过 time 参数可以设置过期时间:
</p>
<div class="org-src-container">
<pre class="src src-python">mc.<span style="font-weight: bold;">set</span>(<span style="font-style: italic;">"username"</span>, <span style="font-style: italic;">"hello world"</span>, time=60*5)
mc.set_multi({
    <span style="font-style: italic;">"email"</span>: <span style="font-style: italic;">"xxx@qq.com"</span>,
    <span style="font-style: italic;">"telphone"</span>: <span style="font-style: italic;">"111111"</span>},
             time=60*5)
</pre>
</div>
</div>
</li>

<li><a id="org76dc8d3"></a>获取数据<br />
<div class="outline-text-5" id="text-org76dc8d3">
<p>
通过 mc.get 方法可以获取指定键的值:
</p>
<div class="org-src-container">
<pre class="src src-python">mc.get(<span style="font-style: italic;">"username"</span>)
</pre>
</div>
</div>
</li>

<li><a id="org7d1c207"></a>删除数据<br />
<div class="outline-text-5" id="text-org7d1c207">
<p>
通过 mc.delete 方法可以删除指定键的数据:
</p>
<div class="org-src-container">
<pre class="src src-python">mc.delete(<span style="font-style: italic;">"username"</span>)
</pre>
</div>
</div>
</li>

<li><a id="org42e2141"></a>自增长<br />
<div class="outline-text-5" id="text-org42e2141">
<p>
通过 mc.incr 可以对整型类型的值进行自增长,每执行一次会把值加1,例如设置在线人数:
</p>
<div class="org-src-container">
<pre class="src src-python">mc.incr(<span style="font-style: italic;">"online_count"</span>)
</pre>
</div>
</div>
</li>

<li><a id="org1c8bf5a"></a>自减少<br />
<div class="outline-text-5" id="text-org1c8bf5a">
<p>
通过 mc.decr 可以对整型类型的值进行自减少,每执行一次会把值减1,还是以在线人数为
例:
</p>
<div class="org-src-container">
<pre class="src src-python">mc.decr(<span style="font-style: italic;">"online_count"</span>)
</pre>
</div>

<p>
对上面这6个方法进行测试:
</p>
<div class="org-src-container">
<pre class="src src-python">
<span style="font-weight: bold;">import</span> memcache
<span style="font-weight: bold; font-style: italic;">mc</span> = memcache.Client([<span style="font-style: italic;">'127.0.0.1:11211'</span>], debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622; username, email &#21644; telphone &#36825;&#19977;&#20010; item</span>
mc.<span style="font-weight: bold;">set</span>(<span style="font-style: italic;">"username"</span>, <span style="font-style: italic;">"hello world"</span>, time=60*5)
mc.set_multi({
    <span style="font-style: italic;">"email"</span>: <span style="font-style: italic;">"xxx@qq.com"</span>,
    <span style="font-style: italic;">"telphone"</span>: <span style="font-style: italic;">"111111"</span>},
             time=60*5)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#30475; username, email &#21644; telphone &#30340;&#20540;</span>
<span style="font-weight: bold;">print</span>(mc.get(<span style="font-style: italic;">"username"</span>), mc.get(<span style="font-style: italic;">"email"</span>), mc.get(<span style="font-style: italic;">"telphone"</span>))
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21024;&#38500; username ,&#28982;&#21518;&#20877;&#30475;&#33021;&#19981;&#33021;&#33719;&#21462;&#21040;&#23427;</span>
mc.delete(<span style="font-style: italic;">"username"</span>)
<span style="font-weight: bold;">print</span>(mc.get(<span style="font-style: italic;">"username"</span>))

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29992;&#19968;&#27425;&#35774;&#32622;&#22810;&#20010;&#38190;&#30340;&#26041;&#27861;&#35774;&#32622;&#22312;&#32447;&#20154;&#25968;</span>
mc.set_multi(
    {
        <span style="font-style: italic;">"online_count"</span>:0
    },
    time=60*5)

mc.incr(<span style="font-style: italic;">"online_count"</span>)
<span style="font-weight: bold;">print</span>(mc.get(<span style="font-style: italic;">"online_count"</span>))
mc.decr(<span style="font-style: italic;">"online_count"</span>)
<span style="font-weight: bold;">print</span>(mc.get(<span style="font-style: italic;">"online_count"</span>))
</pre>
</div>
<p>
下面是程序执行的结果:
</p>
<pre class="example" id="orge1e123f">
hello world xxx@qq.com 111111   --- 用 mc.get 将所有设置的值都获取到了
None				--- 因为删除了 username 这个 item 所以再次获取就获取不到了,结果为 None
1				--- 自增一次,所以结果为1
0				--- 自减一次,结果为0
</pre>

<blockquote>
<p>
实践证明,在 Windows 上只有用 telnet 连接时才会出现问题,但是 Memcached 的功能还是
可以正常使用的.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org8e4d3a0" class="outline-4">
<h4 id="org8e4d3a0">Memcached 的安全性</h4>
<div class="outline-text-4" id="text-org8e4d3a0">
<p>
Memcached 的操作不需要任何用户名以及密码,只要知道 Memcached 服务器的 IP 地址以及
端口号就可以了. 因此在使用 Memcached 时尤其要注意安全性的问题. 针对其安全性,作者
提供了两种解决方案:
</p>
<ul class="org-ul">
<li>使用 <code>-l</code> 参数设置只有本地可以连接: 这种方式只能通过本机连接,其他机器都不能访
问,可达到最好的安全性.</li>
<li><p>
使用防火强关闭对外的 11211 端口: 外网无法访问本机的 11211 端口,也就无法访问到
Memcached 服务. 以 Ubuntu 系统为例,展示设置防火墙的相关命令用法:
</p>
<pre class="example" id="org43e04b9">
ufw enable		# 开启防火墙
ufw disable		# 关闭防火墙
ufw default deny	# 防火墙以禁止的方式打开,默认是那些没有开启的端口全部禁止
ufw deny 端口号	# 关闭某个端口号
ufw allow 端口号	# 开启某个端口号
</pre></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org31752f0" class="outline-3">
<h3 id="org31752f0">Redis</h3>
<div class="outline-text-3" id="text-org31752f0">
<p>
Redis 是一种 NoSQL 数据库,即非关系型数据库,它的数据默认是存储在内存中的,同时,
Redis 也可以定时将内存中的数据同步到硬盘中. Redis 比 Memcached 支持更多的数据结
构,除了 bool, int, float, string 基本数据类型外,还支持 list(列表), set(集合),
sorter set(有序集合), hash(hash 表).
</p>
</div>

<div id="outline-container-org7576512" class="outline-4">
<h4 id="org7576512">Redis 使用场景</h4>
<div class="outline-text-4" id="text-org7576512">
<p>
Redis 的使用场景非常多,包括但不限于以下:
</p>
<ul class="org-ul">
<li>登录会话存储: 可以把能识别客户端的数据存储在 Redis 中,如 token, session 等.</li>
<li>在线人数/计数器: 直播在线观看人数的实时变动,微博的点赞数等.</li>
<li>消息队列: 如在使用 Celery 实现异步操作时,Redis 可以作为中间人.</li>
<li>常用的数据缓存: 可以把一些网站中经常用到的数据放到 Redis 中,提高加载速度</li>
<li>首页数据缓存: 一个网站的首页是访问频率最高的,可以把首页中部分数据放在
Redis 中.</li>
<li>好友关系: 微博的好友关系极其复杂,如果每次获取好友关系时都要查找数据库,那响应速
度将极大影响用户体验,这时就可以把好友关系存储到 Redis 中.</li>
<li>发布和订阅功能: Redis 由发布和订阅功能,可以用来做聊天软件.</li>
</ul>
</div>
</div>

<div id="outline-container-orge6d64dc" class="outline-4">
<h4 id="orge6d64dc">Redis 和 Memcached 比较</h4>
<div class="outline-text-4" id="text-orge6d64dc">
<p>
Memcached 和 Redis 都是非常优秀的缓存系统.
</p>

<p>
Memcached 优点是轻量级,占用服务器资源少,缺点就是功能较少.
</p>

<p>
Redis 的优点是功能强大,配置项比 Memcached 复杂一些,缺点是对服务器的要求较高.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 16:</span> Memcached 和 Redis 比较</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">属性</td>
<td class="org-left">Memcached</td>
<td class="org-left">Redis</td>
</tr>

<tr>
<td class="org-left">类型</td>
<td class="org-left">纯内存数据库</td>
<td class="org-left">内存磁盘同步数据库</td>
</tr>

<tr>
<td class="org-left">数据类型</td>
<td class="org-left">定义 value 时就要固定数据类型</td>
<td class="org-left">不需要固定数据类型</td>
</tr>

<tr>
<td class="org-left">虚拟内存</td>
<td class="org-left">不支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">过期策略</td>
<td class="org-left">支持</td>
<td class="org-left">支持</td>
</tr>

<tr>
<td class="org-left">存储数据安全</td>
<td class="org-left">不支持</td>
<td class="org-left">可以将数据同步到 dump.db 中</td>
</tr>

<tr>
<td class="org-left">灾难恢复</td>
<td class="org-left">不支持</td>
<td class="org-left">可将磁盘中的数据恢复到内存中</td>
</tr>

<tr>
<td class="org-left">分布式</td>
<td class="org-left">支持</td>
<td class="org-left">主从同步</td>
</tr>

<tr>
<td class="org-left">订阅与发布</td>
<td class="org-left">不支持</td>
<td class="org-left">支持</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org7732869" class="outline-4">
<h4 id="org7732869">Redis 的安装与使用</h4>
<div class="outline-text-4" id="text-org7732869">
<p>
Redis 和 Memcached 一样没有官方的 Windows 支持版本,生产环境中建议使用 Linux 系统.
</p>

<p>
作为学习使用,可以使用非官方发布的 Windows 版本的 Redis.
</p>
</div>

<ul class="org-ul">
<li><a id="orgfbd2943"></a>Windows 系统上安装和使用 Redis<br />
<div class="outline-text-5" id="text-orgfbd2943">
<ul class="org-ul">
<li>下载链接: <a href="https://github.com/tporadowski/redis/releases">https://github.com/tporadowski/redis/releases</a></li>
<li>安装步骤: 双击下载的 msi 文件,在打开的对话框中选择安装路径,勾选上添加到环境变
量的复选框,点击 next, 设置端口号和防火墙, Redis 默认的端口号是 6379, 然后再把
Redis 服务的防火墙关掉(不关掉的话其他计算机就不能访问本机的 Redis 服务),再次点
击 Next, 设置 Redis 最大占用内存,默认没有勾选,即 Redis 的可用内存无限,接着单击
Next, 然后单击 Install ,即可完成安装.</li>
<li>使用: 打开终端,执行 redis-cli 命令,即可进入 Redis 命令行.</li>
</ul>
</div>
</li>

<li><a id="org6f14650"></a>Linux 系统上安装 Redis<br />
<div class="outline-text-5" id="text-org6f14650">
<p>
常用的 Linux 系统上 Redis 很容易安装和使用,以流行的 Ubuntu 系统安装和使用 Redis
为例:
</p>
<ul class="org-ul">
<li>安装命令: <code>apt install redis-server</code></li>
<li>卸载命令: <code>apt purge --autoremove redis-server</code></li>
<li>启动命令: Redis 安装后会自动启动,可以通过 <code>ps aux|grep redis</code> 命令查看.如果想
要手动启动,可以通过 <code>service redis-server start</code></li>
<li>停止命令: <code>service redis-server stop</code></li>
<li><p>
使用: 连接 redis-server 之前,需要启动 redis-server 服务,
命令为 <code>service redis-server start</code>. 启动 redis-server 后,再使用 redis-cli 命
令连接:
</p>
<pre class="example" id="org00f19e2">
redis-cli -h [ip] -p [port]
</pre>
<p>
redis-server 默认的端口号是 6379,连接本机的 redis-server 命令:
</p>
<pre class="example" id="orgc510d91">
redis-cli -h 127.0.0.1 -p 6379
</pre>
<p>
连接成功后,就可以使用下一节的命令对 redis-server 进行操作了.
</p></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgc5966a2" class="outline-4">
<h4 id="orgc5966a2">Redis 操作命令</h4>
<div class="outline-text-4" id="text-orgc5966a2">
<p>
Redis 操作和 Memcached 的命令操作其实很类似,Memcached 的更为简单,如果 Memcached
在我的 Windows 上的 telnet 连接正常的话,那 Redis 和 Memcached 的命令行操作方式在
Windwos 上和 Linux 上都是一样的.
</p>
</div>

<ul class="org-ul">
<li><a id="org9776431"></a>添加数据<br />
<div class="outline-text-5" id="text-org9776431">
<p>
添加数据使用 set 命令:
</p>
<pre class="example" id="org81753b5">
set key value EX timeout
</pre>
<p>
如果 key 已存在,则对其值进行覆盖. EX 参数设置过期时间,如果没有 EX 参数,则该数据
永远不会过期,示例:
</p>
<pre class="example" id="orgf6e95b5">
set username kamisama EX 60
</pre>
<p>
或
</p>
<pre class="example" id="org13cfc4f">
set username kamisama
</pre>
<p>
或者也可以使用 setex 命令同时设置过期时间:
</p>
<pre class="example" id="org17c1007">
setex username 60 kamisama
</pre>
</div>
</li>

<li><a id="org2248a9c"></a>删除数据<br />
<div class="outline-text-5" id="text-org2248a9c">
<p>
删除数据用 delete 命令:
</p>
<pre class="example" id="org608a174">
delete key
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org855919e">
delete username
</pre>
</div>
</li>

<li><a id="org7e2066e"></a>设置过期时间<br />
<div class="outline-text-5" id="text-org7e2066e">
<p>
可以使用 expire 命令来设置数据的过期时间:
</p>
<pre class="example" id="org2898708">
expire key seconds
</pre>
<p>
示例命令:
</p>
<pre class="example" id="orgc0985d5">
expire username 60
</pre>
<p>
即设置 username 这个 item 60 秒过期.
</p>
</div>
</li>

<li><a id="org16bcd65"></a>查看过期时间<br />
<div class="outline-text-5" id="text-org16bcd65">
<p>
如果忘记了某个数据什么时候过期,可以用 ttl 命令查看数据的过期时间:
</p>
<pre class="example" id="orgbc3c75e">
ttl key
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org0c6b6bd">
ttl username
</pre>
</div>
</li>

<li><a id="org5167fcf"></a>查看所有key<br />
<div class="outline-text-5" id="text-org5167fcf">
<p>
如果想要知道当前 Redis 中存储的所有 key, 可以通过 keys 命令实现:
</p>
<pre class="example" id="org65e2c3b">
keys *
</pre>
</div>
</li>

<li><a id="orged7583c"></a>列表操作<br />
<div class="outline-text-5" id="text-orged7583c">
<ul class="org-ul">
<li><p>
在列表左边添加元素:
</p>
<pre class="example" id="org6e92c80">
lpush key value
</pre>
<p>
将 value 插入到 key 指向的列表的最开始位置,如果 key 不存在,就会创建一个空的列表,
将 value 插入到其最开始为止,但是如果 key 存在,却不是列表类型,则会返回错误.
</p></li>
<li><p>
在列表右边添加元素:
</p>
<pre class="example" id="org0bf34cd">
rpush key value
</pre>
<p>
将 value 插入到 key 的末尾. 如果 key 不存在,则创建一个空的列表,并执行 rpush 操
作.当 key 存在但不是列表类型时,会返回一个错误.
</p></li>
<li><p>
查看列表中的元素:
</p>
<pre class="example" id="org4656e90">
lrange key start stop
</pre>
<p>
返回列表 key 中指定区间的元素,区间以偏移量 start 和 stop 指定,如果要查看左边第
一个元素到最后一个元素:
</p>
<pre class="example" id="org3680843">
lrange key 0 -1
</pre></li>
<li><p>
移除列表左边的元素:
</p>
<pre class="example" id="orgef3d9a1">
lpop key
</pre></li>
<li><p>
移除并返回列表右边的元素:
</p>
<pre class="example" id="org33d7736">
rpop key
</pre></li>
<li><p>
移除并返回列表中指定的元素:
</p>
<pre class="example" id="org2e59869">
lrem key count value
</pre>
<p>
这个命令将删除列表 key 中 count 个值为 value 的元素.
</p></li>
<li><p>
获取列表中指定为止的元素:
</p>
<pre class="example" id="org10f3982">
lindex key index
</pre></li>
<li><p>
获取列表元素个数:
</p>
<pre class="example" id="org9191d5f">
llen key
</pre></li>
<li><p>
删除指定元素:
</p>
<pre class="example" id="orga05fa41">
lrem key count value
</pre>
<p>
删除 key 列表中 count 个值为 value 的元素. 如果 count &gt; 0, 则从左往右搜索,移除
值与 value 值相等的 <code>count</code> 个元素. 如果 count &lt; 0 ,则从右往左边搜索,移除与
value 相等的元素,数量为 count 的绝对值.
如果 count=0, 则移除列表中所有与 value 相等的值.
</p></li>
</ul>
</div>
</li>

<li><a id="org6feb9af"></a>集合操作<br />
<div class="outline-text-5" id="text-org6feb9af">
<p>
集合是无序的,且里面的元素不能重复.
</p>

<ul class="org-ul">
<li><p>
添加集合元素:
</p>
<pre class="example" id="org5c60267">
sadd key value1 value2 ...
</pre></li>
<li><p>
查看集合元素:
</p>
<pre class="example" id="orgbd5166f">
smembers key
</pre></li>
<li><p>
移除集合元素:
</p>
<pre class="example" id="orgdd93ef6">
srem key value1 value2 ...
</pre></li>
<li><p>
查看集合中元素个数:
</p>
<pre class="example" id="org8dd5efc">
scard key
</pre></li>
<li><p>
获取多个集合的交集:
</p>
<pre class="example" id="orgde62f2d">
sinter key1 key2 ...
</pre></li>
<li><p>
获取多个集合的差集:
</p>
<pre class="example" id="org4412af1">
sdiff key1 key2 ...
</pre></li>
</ul>
</div>
</li>

<li><a id="org575eb56"></a>哈希(hash)操作<br />
<div class="outline-text-5" id="text-org575eb56">
<p>
哈希(hash)操作可以简单理解为 Python 中的字典,操作 hash 的相关命令如下:
</p>
<ul class="org-ul">
<li><p>
添加新值:
</p>
<pre class="example" id="orgef882a9">
hset key field value
</pre>
<p>
示例命令:
</p>
<pre class="example" id="org47a98e3">
hset website baidu baidu.com
</pre>
<p>
这个命令中,如果 website 这个 key 不存在,就会在 redis-server 中创建一个名为
website 的哈希表.
</p></li>

<li><p>
获取哈希表中 field 的值:
</p>
<pre class="example" id="org3de0fc3">
hget key field
</pre>
<p>
示例命令:
</p>
<pre class="example" id="orgaaaafd0">
hget website baidu
</pre></li>

<li><p>
删除哈希表中某个 field:
</p>
<pre class="example" id="orgc24cb79">
hdel key field
</pre></li>

<li><p>
获取某张哈希表中所有的 field:
</p>
<pre class="example" id="org8b7830c">
hkeys key
</pre></li>

<li><p>
获取某张哈希表中所有的 field 和 value:
</p>
<pre class="example" id="org8be54e2">
hgetall key
</pre></li>

<li><p>
获取某张哈希表中所有的值:
</p>
<pre class="example" id="orgb7c10cd">
hvals key
</pre></li>

<li><p>
判断哈希表中是否存在某个 field:
</p>
<pre class="example" id="org4d7377c">
hexists key field
</pre></li>
</ul>
</div>
</li>

<li><a id="orgc8d21ed"></a>事务操作<br />
<div class="outline-text-5" id="text-orgc8d21ed">
<p>
Redis 事务可以一次性执行多个命令,具有隔离性和原子性. 隔离性意味着事务中执行的所
有命令都会按照顺序执行,不会被其他命令干扰. 原子性意味着在事务中的所有命令,要么全
部执行,要么全部都不执行.
</p>
<ul class="org-ul">
<li><p>
开启一个事务:
</p>
<pre class="example" id="org13bd966">
multi
</pre>
<p>
这个命令执行完毕后,接下来所有命令都会在这个事务中执行.
</p></li>
<li><p>
执行事务:
</p>
<pre class="example" id="org71f6904">
exec
</pre>
<p>
exec 命令会将 multi 和 exec 中的操作一并提交.
</p></li>
<li><p>
取消事务:
</p>
<pre class="example" id="org8a6e8c4">
discard
</pre>
<p>
discard 会将 multi 和 discard 中的操作全部取消.
</p></li>
<li><p>
监视 key:
</p>
<pre class="example" id="org0f81807">
wathc key1 key2 ...
</pre>
<p>
这个命令监视一个或多个key, 如果事务执行前,这些 key 被其他命令修改了,那么事务就
会中断执行.
</p></li>
<li><p>
取消所有key 的监视:
</p>
<pre class="example" id="org80d80f1">
unwatch
</pre></li>
</ul>
</div>
</li>

<li><a id="org825a383"></a>发布/订阅操作<br />
<div class="outline-text-5" id="text-org825a383">
<p>
Redis 的发布/订阅功能类似于 Flask 中的信号机制,可以先订阅某个频道,然后在某些事情
发生的情况下给某个频道发送消息.
</p>
<ul class="org-ul">
<li><p>
给某个频道发布消息:
</p>
<pre class="example" id="org45d31aa">
publish channel message
</pre></li>
<li><p>
订阅某个频道:
</p>
<pre class="example" id="orgaf747ce">
subscribe channel
</pre></li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgeb6ef18" class="outline-4">
<h4 id="orgeb6ef18">同步数据到硬盘</h4>
<div class="outline-text-4" id="text-orgeb6ef18">
<p>
Redis 可以通过配置实现自动同步数据到硬盘. 同步的策略有两种,一种是 RDB(redis
database), 另一种是 AOF(append only file), 可以通过修改 /etc/redis/redis.conf 配
置文件切换不同的同步策略.
</p>
</div>

<ul class="org-ul">
<li><a id="org3e319e0"></a>RDB 策略<br />
<div class="outline-text-5" id="text-org3e319e0">
<p>
RDB 策略的相关配置如下:
</p>
<ul class="org-ul">
<li>开启和关闭: RDB 默认是开启的模式,如果想要关闭,把配置文件中的所有 save 配置选项
注释掉就可以了.</li>
<li>同步机制: 可以指定某个时间内执行多少命令进行同步.如 1min 内执行了两次命令,就做
一次同步.</li>
<li>存储内容: 存储的是 Redis 里面具体的值</li>
<li>存储文件路径: 根据 dir 和 dbfilename 配置项来指定路径和具体的文件名</li>
</ul>


<p>
RDB 策略的优点:
</p>
<ul class="org-ul">
<li>存储数据到文件中会进行压缩,文件体积比使用 AOF 策略小.</li>
<li>因为存储的是 Redis 中具体的值,所以在恢复的时候速度比使用 AOF 策略快.</li>
<li>非常适合于备份.</li>
</ul>


<p>
RDB 策略的缺点:
</p>
<ul class="org-ul">
<li>RDB 配置规则为多少时间内执行了多少命令才进行同步数据,因为采用压缩机制,RDB 在同
步的时候要重新保存整个 Redis 的数据,因此我们一般最少会设置 5min 以上才进行一次
同步. 这种情况下,一旦发生服务器的故障,就会造成 5min 的数据丢失.</li>
<li>在进行数据同步时, Redis 会调用 fork 函数生成一个子进程来同步数据,在数据量比较
大的情况下,会非常耗时.</li>
</ul>
</div>
</li>

<li><a id="org8ed4569"></a>AOF 策略<br />
<div class="outline-text-5" id="text-org8ed4569">
<p>
AOF 策略的相关配置如下:
</p>
<ul class="org-ul">
<li>开启和关闭: 在/etc/redis/redis.conf 配置文件中设置 appendonly 为 yes, 即可开启
AOF, 设置为 no 即可关闭 AOF.</li>
<li>同步机制: 每秒同步或者每次执行命令后同步数据.</li>
<li>存储内容: 存储的不是真实的数据,而是每次执行的命令.</li>
<li>存储文件路径: 根据 dir 以及 appendfilename 来指定具体的路径和文件名.</li>
</ul>


<p>
AOF 策略的优点:
</p>
<ul class="org-ul">
<li>AOF 策略是每秒或者每次发生写操作时都会同步数据,因此即使服务器发生故障,最多只会
损失 1s 的数据.</li>
<li>AOF 存储的是 Redis 命令,并且直接把新增的命令追加到 AOF 文件后面,因此备份的效率
比使用 RDB 策略高.</li>
<li>如果 AOF 文件比较大,那么 Redis 会自动进行重写,只保留最小的命令集合.</li>
</ul>


<p>
AOF 策略的缺点:
</p>
<ul class="org-ul">
<li>AOF 文件因为没有压缩,因此体积比使用 RDB 策略大.</li>
<li>AOF 是在每秒或者每次执行命令时都进行备份,因此如果并发量较高,则效率会比较慢.</li>
<li>因为 AOF 备份的是命令,因此,在灾难恢复时 Redis 会重新执行 AOF 中的命令,速度没有
使用 RDB 策略快.</li>
</ul>
</div>
</li>
</ul>
</div>

<div id="outline-container-org3fb2029" class="outline-4">
<h4 id="org3fb2029">设置密码</h4>
<div class="outline-text-4" id="text-org3fb2029">
<p>
默认情况下, Redis 也是不需要密码的,我们可以配置 /etc/redis/redis.conf 文件中的
requirepass 实现加密访问:
</p>
<pre class="example" id="org5bd5d52">
requirepass kamisama
</pre>
<p>
这个配置把密码设置为 kamisama. 重启 redis-server 后再用 redis-cli 重新连接
redis-server, 然后用命令 <code>auth password</code> 授权:
</p>
<pre class="example" id="org363af82">
auth kamisama
</pre>
<p>
只有成功授权后,才能执行 Redis 的命令.
</p>
</div>
</div>

<div id="outline-container-org1fe8cf8" class="outline-4">
<h4 id="org1fe8cf8">Python 操作 Redis.</h4>
<div class="outline-text-4" id="text-org1fe8cf8">
<p>
Redis 通常是安装在 Linux 系统上的,而编程时一般都使用的 Windows 系统,所以想要在其
他机器上连接 Redis ,必需要配置 Redis 允许其他机器连接,在 /etc/redis/redis.conf
文建中配置 bind 配置项:
</p>
<pre class="example" id="orgfb8eac8">
bind 0.0.0.0
</pre>
<p>
这样配置则设置为允许其他机器通过 redis-server 所在的机器的 IP 地址或者域名连接.
</p>

<p>
使用 Python 操作 Redis 需要通过第三方包 python-redis:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install redis
</pre>
</div>

<pre class="example" id="org37c94a4">
Looking in indexes: https://mirrors.163.com/pypi/simple/
Collecting redis
  Downloading https://mirrors.163.com/pypi/packages/a7/7c/24fb0511df653cf1a5d938d8f5d19802a88cef255706fdda242ff97e91b7/redis-3.5.3-py2.py3-none-any.whl (72 kB)
Installing collected packages: redis
Successfully installed redis-3.5.3
</pre>
<p>
安装完 python-redis 后,就可以用 Python 来操作 Redis 了.
</p>
</div>

<ul class="org-ul">
<li><a id="org6aae191"></a>连接 Redis<br />
<div class="outline-text-5" id="text-org6aae191">
<p>
假设 Redis 所在机器的IP 为 192.168.174.130,监听的端口使用的是默认的 6379,那么可
以用下面的代码实现连接Redis:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20174; redis &#21253;&#23548;&#20837; Redis &#31867;</span>
<span style="font-weight: bold;">from</span> redis <span style="font-weight: bold;">import</span> Redis

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Redis &#23454;&#20363;&#21464;&#37327;</span>
<span style="font-weight: bold; font-style: italic;">xtredis</span> = Redis(host=<span style="font-style: italic;">"182.168.174.130"</span>, port=6379)
</pre>
</div>
<p>
我使用本机安装的 Redis 进行测试,只需要将 host 修改为 "127.0.0.1" 就可以了.
</p>
</div>
</li>

<li><a id="orgac4a0ef"></a>字符串操作<br />
<div class="outline-text-5" id="text-orgac4a0ef">
<p>
字符串操作的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#19968;&#20010;&#20540;,&#24182;&#35774;&#32622;&#36807;&#26399;&#26102;&#38388;&#20026; 60s,&#22914;&#26524;&#19981;&#35774;&#32622;,&#21017;&#27704;&#36828;&#19981;&#20250;&#36807;&#26399;</span>
xtredis.<span style="font-weight: bold;">set</span>(<span style="font-style: italic;">"username"</span>, <span style="font-style: italic;">"kamisama"</span>, ex=60)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#19968;&#20010;&#20540;</span>
xtredis.get(<span style="font-style: italic;">"username"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21024;&#38500;&#19968;&#20010;&#20540;</span>
xtredis.delete(<span style="font-style: italic;">"username"</span>)
</pre>
</div>
</div>
</li>

<li><a id="orgb420ec2"></a>列表操作<br />
<div class="outline-text-5" id="text-orgb420ec2">
<p>
列表操作的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473; languages &#21015;&#34920;&#24448;&#24038;&#36793;&#28155;&#21152;&#19968;&#20010; python</span>
xtredis.lpush(<span style="font-style: italic;">"language"</span>, <span style="font-style: italic;">"python"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473; languages &#21015;&#34920;&#24448;&#24038;&#36793;&#28155;&#21152;&#19968;&#20010; php</span>
xtredis.lpush(<span style="font-style: italic;">"language"</span>, <span style="font-style: italic;">"php"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473; languages &#21015;&#34920;&#24448;&#24038;&#36793;&#28155;&#21152;&#19968;&#20010; javascript</span>
xtredis.lpush(<span style="font-style: italic;">"language"</span>, <span style="font-style: italic;">"javascript"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; languages &#21015;&#34920;&#20013;&#30340;&#25152;&#26377;&#20540;</span>
<span style="font-weight: bold;">print</span>(xtredis.lrange(<span style="font-style: italic;">"language"</span>, 0, -1))
</pre>
</div>
</div>
</li>

<li><a id="org8221315"></a>集合操作<br />
<div class="outline-text-5" id="text-org8221315">
<p>
集合操作的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473;&#38598;&#21512; team &#28155;&#21152;&#19968;&#20010;&#20803;&#32032; kamisama</span>
xtredis.sadd(<span style="font-style: italic;">"team"</span>, <span style="font-style: italic;">"kamisama"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473;&#38598;&#21512; team &#28155;&#21152;&#19968;&#20010;&#20803;&#32032; datuo</span>
xtredis.sadd(<span style="font-style: italic;">"team"</span>, <span style="font-style: italic;">"datuo"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473;&#38598;&#21512; team &#28155;&#21152;&#19968;&#20010;&#20803;&#32032; slice</span>
xtredis.sadd(<span style="font-style: italic;">"team"</span>, <span style="font-style: italic;">"slice"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#38598;&#21512;&#20013;&#25152;&#26377;&#20803;&#32032; -&gt; ["datuo", "slice", "kamisama"] &#26080;&#24207;&#30340;</span>
xtredis.smembers(<span style="font-style: italic;">"team"</span>)
</pre>
</div>
</div>
</li>

<li><a id="org1308a22"></a>哈希操作<br />
<div class="outline-text-5" id="text-org1308a22">
<p>
哈希操作的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473; website &#21704;&#24076;&#34920;&#20013;&#28155;&#21152; baidu &#23383;&#27573;(field), &#20540;&#20026; baidu.com</span>
xtredis.hset(<span style="font-style: italic;">"website"</span>, <span style="font-style: italic;">"baidu"</span>, <span style="font-style: italic;">"baidu.com"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32473; website &#21704;&#24076;&#34920;&#20013;&#28155;&#21152; google &#23383;&#27573;(field), &#20540;&#20026; google.com</span>
xtredis.hset(<span style="font-style: italic;">"website"</span>, <span style="font-style: italic;">"google"</span>, <span style="font-style: italic;">"google.com"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462; website &#21704;&#24076;&#34920;&#20013;&#30340;&#25152;&#26377;&#20540; -&gt; {"baidu": "baidu.com", "google": "google.com"}</span>
<span style="font-weight: bold;">print</span>(xtredis.hgetall(<span style="font-style: italic;">"website"</span>))
</pre>
</div>
</div>
</li>

<li><a id="org22d57ba"></a>事务操作<br />
<div class="outline-text-5" id="text-org22d57ba">
<p>
事务操作的示例代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23450;&#20041;&#19968;&#20010;&#31649;&#36947;&#23454;&#20363;</span>
<span style="font-weight: bold; font-style: italic;">pip</span> = xtredis.pipeline()
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31532;&#19968;&#27493;&#25805;&#20316;&#32473; BankA &#33258;&#20943;1</span>
pip.desc(<span style="font-style: italic;">"BankB"</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25191;&#34892;&#20107;&#21153;</span>
pip.execute()
</pre>
</div>
<blockquote>
<p>
用python 操作 Redis 只有事务操作多了一个管道的概念,其他的都与 Redis 的命令无缝衔
接. 管道概念就是抽象出 Redis 开启事务 multi 到执行事务 exec 中间的过程.
</p>
</blockquote>
</div>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org33cbf50" class="outline-2">
<h2 id="org33cbf50">项目实战</h2>
<div class="outline-text-2" id="text-org33cbf50">
<p>
这部分内容是完成一个 Python 论坛的项目,项目名为 pythonbbs, 目的是将前面的 Flask
基础知识融和,还有一些真实的企业项目功能的解决方案,如文件上传,邮件发送,头像处理,
权限管理等.
</p>


<p>
在开发项目/产品之前,要先有一个需求文档. 一个网站的制作流程大致如下:
</p>
<ol class="org-ol">
<li>公司相关领导提出产品制作计划,描述产品需求.</li>
<li>产品经理整理需求,细化功能,制作产品原型图.</li>
<li>设计师定主色调,按照原型图制作产品设计图.</li>
<li>网站开发者按照原型图和设计图完成产品制作.</li>
<li>测试工程师对产品进行功能和性能测试,如果有问题则提交给网站开发者,开发者继续完
善,直到测试通过.</li>
<li>运维工程师部署产品上线,并负责保证产品正常运行.</li>
</ol>


<p>
为了节省时间,产品需求和 HTML 静态页面为作者提前预设了,所以前面的1,2,3 步省略了.下
面就会讲解开发,测试和运维的步骤.
</p>

<p>
开始开发 pythonbbs 之前,需要搞清项目需求,项目主要由两部分组成,分别是论坛前台和论
坛后台.
</p>

<p>
论坛前台包括登录,注册,查看帖子,过滤帖子,发布帖子,帖子详情,帖子评论,帖子点赞等功
能.
</p>

<p>
论坛后台包括论坛首页,帖子管理,评论管理,用户管理,权限管理,角色管理等.
<img src="imgs/pythonbbs.jpg" alt="pythonbbs.jpg" />
</p>


<blockquote>
<p>
CMS 就是 Content Management System ,内容管理系统,也就是论坛后台.
</p>
</blockquote>
</div>

<div id="outline-container-org6213e93" class="outline-3">
<h3 id="org6213e93">创建项目</h3>
<div class="outline-text-3" id="text-org6213e93">
<p>
作者用 Pycharm 创建项目以及虚拟环境.我就自己创建文件夹,自己创建虚拟环境了.
前面虽然已经创建过了虚拟环境,但是都是测试用的,这里是模拟创建一个全新的项目,所以
我新建一个 pythonbbs 文件夹,并在其中创建 Python 虚拟环境:
</p>

<div class="org-src-container">
<pre class="src src-sh">mkdir ~/flask_web_py3_10/pythonbbs
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/pythonbbs
python -m venv ~/flask_web_py3_10/pythonbbs
</pre>
</div>

<p>
激活虚拟环境:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">source</span> ~/flask_web_py3_10/pythonbbs/Scripts/activate
<span style="font-weight: bold;">cd</span> ~/flask_web_py3_10/pythonbbs
</pre>
</div>


<p>
安装项目用到的包:
Pycharm Pro 创建的 Flask 项目默认已经安装好了 Flask,甚至一些常用的第三方 Flask
可能也自动安装了,但自己用 Python 命令创建的可没有 Flask 包,更没有其他插件,只有一
个纯 Python 虚拟环境,这些包都需要自己安装的.
</p>

<p>
安装包可以用命令,一次安装一个或多个:
</p>
<pre class="example" id="orgbad37e3">
pip install flask
或
pip install flask flask-sqlalchemy pymysql
</pre>
<p>
也可以使用 requirement.txt 文件,将所有需要的包都写入到该文件中,文件的一行表示一
个包,然后用 <code>pip install -r requirement.txt</code> 命令安装文件中所有的包.
示例 requirement.txt(前面测试的项目中安装的所有包):
</p>
<pre class="example" id="orgc55b0d6">
alembic==1.10.3
click==8.1.3
colorama==0.4.6
dnspython==2.1.0
email-validator==1.1.2
Flask==2.0.1
Flask-Migrate==4.0.4
Flask-SQLAlchemy==2.5.1
Flask-WTF==0.14.3
greenlet==1.1.0
idna==3.2
importlib-metadata==6.6.0
importlib-resources==5.12.0
itsdangerous==2.1.2
Jinja2==3.0.2
Mako==1.2.4
MarkupSafe==2.1.2
PyMySQL==1.0.2
python-memcached==1.59
redis==3.5.3
six==1.16.0
SQLAlchemy==1.4.29
typing_extensions==4.5.0
Werkzeug==2.0.0
WTForms==2.3.3
zipp==3.15.0
</pre>
<p>
文件每一行都是代表一个包,可以用 <code>==</code> <code>&gt;=</code> 等来指定包的版本,不指定版本默认应该是
安装最新的包. 上面这个示例文件是我用 <code>pip freeze &gt; requirement.txt</code> 将已安装的包
到出到 requirement.txt 文件中的. 我自己的项目依赖的包也可以按照这个格式来记录.
</p>

<p>
这个 pythonbbs 项目用到的包(随着项目进行慢慢添加的):
requirement.txt:
</p>
<div class="org-src-container">
<pre class="src src-txt">cryptography
Flask==2.0.1
Flask-Migrate
Jinja2==3.0.2
Werkzeug==2.0.0
PyMySQL
Flask-SQLAlchemy
SQLAlchemy&lt;2.0
</pre>
</div>
<p>
一些前面用过的包我是直接从前面导出的 requirement.txt 里复制的,因为之前就有
Werkzeug 的版本问题解决了的,所以按照前面的版本安装不会出现问题,这个项目中新添加
的包,例如 cryptography, 是用于密码的加密和解密的,就没有指定版本,出了兼容问题再来
解决,暂时直接安装最新的就好了.
</p>

<p>
编写好需要的包的 requirement.txt 文件后,就可以直接用它来安装了:
</p>
<blockquote>
<p>
emm 还有一个问题,就是国内的镜像站与pypi 的官方站点的包内容其实并不完全相同,好多
包的版本不全,比如 Werkzeug 2.0.0 支持的 Jinja2 版本应该是3.0.3,但是使用国内镜像
最高版本是 3.0.2,又比如,我的 flask-migrate 是使用官方镜像安装的,所以上面导出的
requirement.txt 里是 4.0.4 版本,但是国内镜像只有最高3.0.1 也不知道是只有163的镜
像不全还是都不全,本来是用国内镜像安装的,后来换成用官方镜像了
</p>
</blockquote>
<div class="org-src-container">
<pre class="src src-sh">pip install -r requirement.txt
</pre>
</div>

<p>
包安装完毕后,我们就以大型项目为标准完善项目结构,把程序框架搭建起来.
</p>
</div>
<div id="outline-container-org5db62f9" class="outline-4">
<h4 id="org5db62f9">config.py 文件</h4>
<div class="outline-text-4" id="text-org5db62f9">
<p>
在 pythonbbs 文件夹(项目根目录)下创建一个 config.py 的 Python 文件,这个文件用来
存放配置项.
</p>

<p>
在项目运行过程中,会需要根据环境不同选择不同的配置,例如数据库的操作,在测试时,连接
的是测试服务器的数据库,上线后,需要连接线上服务器的数据库.为了满足不同环境下的不
同配置,在 config.py 中根据环境创建不同的类,来分别实现具体的配置.
</p>

<p>
在任何环境下都相同的配置项,我们创建一个 BaseConfig 类,将这些配置项放在里面.
开发环境对应的配置项,创建一个 DevelopmentConfig 类,测试环境创建 TestingConfig 类,线
上环境创建 ProductionConfig 类. 其中 BaseConfig 是另外三个类的基类(父类).
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
接下来在 app.py 中,可以根据当前环境选择不同的配置类即可.
</p>

<p>
以开发环境(也就是我们正在使用的环境)为例:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">import</span> config

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

app.config.from_object(config.DevelopmentConfig)
</pre>
</div>
<p>
这个代码的 DevelopmentConfig 类中,配置了数据库连接 SQLALCHEMY_DATABASE_URI, 连接
本机数据库软件(MYSQL)中的 pythonbbs 数据库.
</p>

<blockquote>
<p>
这里和前面讲解数据库部分知识有所不同的是字符集(charset)不是utf8了而是
utf8mb4, utf8 与 utf8mb4 的区别:<a href="https://stackoverflow.com/questions/30074492/what-is-the-difference-between-utf8mb4-and-utf8-charsets-in-mysql">https://stackoverflow.com/questions/30074492/what-is-the-difference-between-utf8mb4-and-utf8-charsets-in-mysql</a>
</p>

<p>
mysql 中,utf8 实际上是 utf8mb3 的简称,它用3个字节来存储 UTF-8 格式的字符,但是
UTF-8 编码(可变长度的编码)最多使用 4 个字节,最少使用 3 个字节,这就意味着 mysql
的 "utf8" 格式的字符集并不能存储所有的 UTF-8 格式的数据,例如 Emoji 表情就需要 4
个字节存储,那么 utf8 格式就存储不了 Emoji, utf8mb4 就是 MYSQL 中使用 4 个字节存
储 UTF-8 字符的字符集设置,所以这里才用 utf8mb4, 我猜测可能是因为论坛里的评论,回
复等存储是存储在数据库中的,而这些内容中需要包含由表情数据?
</p>
</blockquote>
<p>
创建数据库时,需要选择字符集为 utf8mb4, 作者用的图形界面,
我在 <a href="https://dev.mysql.com/doc/refman/8.0/en/charset-database.html">MYSQL 文档-设置 database 字符集</a> 找到相关文档并用命令创建的 pythonbbs 数据
库:
</p>
<pre class="example" id="org63f5ae9">
mysql&gt; CREATE DATABASE pythonbbs CHARACTER SET utf8mb4;
Query OK, 1 row affected (0.08 sec)
</pre>
<p>
查看创建好的数据库:
</p>
<pre class="example" id="orgfbcfa0c">
mysql&gt; show create database pythonbbs;
+-----------+-------------------------------------------------------------------------------------------------------------------------------------+
| Database  | Create Database                                                                                                                     |
+-----------+-------------------------------------------------------------------------------------------------------------------------------------+
| pythonbbs | CREATE DATABASE `pythonbbs` /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION='N' */ |
+-----------+-------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)
</pre>
<p>
可以看到默认字符集设置为 utf8mb4 了,后面的 COLLATE (核准格式) 我创建 pythonbbs
时没有设置,因此使用的时 utf8mb4 默认的核准格式,也可以用下面这个命令来主动设置:
<code>CREATE DATABASE pythonbbs CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;</code>
好了,现在初步设置好了配置以及数据库也创建完成了.可以开始下一步了.
</p>
</div>
</div>
<div id="outline-container-org3886962" class="outline-4">
<h4 id="org3886962">exts.py 文件</h4>
<div class="outline-text-4" id="text-org3886962">
<p>
exts.py 文件是用来存放第三方插件的对象的, 例如 SQLAlchemy 对象, Flask-Mail 对象
等.
用一个专门的文件来存放这些对象是为了防止循环引用. 以 SQLAlchemy 对象为例, 前面我
们在 app.py 中创建了一个 db 对象,用于创建 ORM 模型和进行 ORM 操作.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy(app)
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">User</span>(db.Model):
    <span style="font-weight: bold;">pass</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Article</span>(db.Model):
    <span style="font-weight: bold;">pass</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">...</span>

</pre>
</div>
<p>
随着项目越来越复杂,一般会把 ORM 模型放到其他文件,而创建 ORM 模型又需要 db 变量,
因此要从 app.py 中导入 db 变量(db 变量的创建需要 app 对象,因此必需在 app.py 中,
或是导入 app.py 的 app 对象),而为了让 ORM 模型能映射到数据库中(视图函数/类视图中
进行数据保存等操作),又需要在 app.py 中直接或间接导入 ORM 模型,这样就会导致
app.py 文件以及 ORM 模型文件相互导入,这就是循环引用了.
</p>

<p>
循环应用会导致项目运行失败. 为了打破循环应用,只需要在两者之间加上一个 exts.py 文
件,把会引起循环引用的变量(如 db 变量)放到 exts.py 中,然后其他文件都从 exts.py 导
入变量.例如, exts.py 从 app.py 中导入 app 对象,然后 ORM 模型文件从 exts.py 中导
入需要的 db 变量, app.py 文件从 ORM 模型文件中导入 ORM 模型.
</p>

<p>
以 Flask-SQLAlchemy 插件为例:
exts.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy

<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy()
</pre>
</div>
<p>
可以看到, db 并没有传入 app 对象,原因是如果使用 app.py 中的 app 对象,又会产生循
环引用问题.这样我们可以回到 app.py 中,导入这个 db 变量,再通过 db.init_app(app)
完成初始化:
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)

app.config.from_object(config.DevelopmentConfig)

db.init_app(app)
</pre>
</div>
<p>
通过这种方式一样完成了对 db 变量的初始化,后续其他的插件对象都可以用这种方式解决
引用问题.
</p>
<blockquote>
<p>
这里可能涉及一些 Python 实例化/初始化对象的知识需要补充阅读理解:
<a href="https://realpython.com/python-class-constructor/">了解Python 对象初始化</a>, <a href="https://docs.python.org/3/tutorial/classes.html">Python 官方的 class 教程</a>
</p>

<p>
另外,引用可以理解为 import 某个对象/文件/类 实际上就是把那个对象/类对应的文件给
导入(复制粘贴)到本文件中,并且会执行导入的内容,如果文件 A 中使用了 import B, 而文
件 B 中使用了 import A, 那么执行它们中任意一个,会发生的事情就是 ,A 导入 B ,执行
B 中的代码,而 B 中代码又导入了 A, 那么执行代码的结果是又会导入A, 再执行 A 的代码,然
后一直循环下去,所以这样是会报措的, exts.py 就是在 A 和 B 中添加了一个 C, 将 A 要
用的代码放在 C 里面, B 要的代码也从 A 中分离出来, 这样 A 导入 C, B 导入 C, A 导
入B 就不会发生循环了,一切在第三者 C 这里终结.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgc49e9bc" class="outline-4">
<h4 id="orgc49e9bc">blueprints 模块</h4>
<div class="outline-text-4" id="text-orgc49e9bc">
<p>
从开始的分析可以得知,项目被分成了许多模块. 如果把它们都放到 app.py 中, app.py 会
变得非常臃肿,维护起来也会十分困难.
</p>

<p>
为了使项目结构更清晰,我们会使用蓝图来进行模块化.
</p>

<p>
创建一个名为 blueprints 的包(文件夹),用于存放蓝图模块. 作者的 Pycharm 有命令可用,我
就自己创建文件夹了:
</p>
<div class="org-src-container">
<pre class="src src-sh">mkdir blueprints
</pre>
</div>
<p>
然后在该文件夹下面创建 cms.py , front.py 和 user.py
cms.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)
</pre>
</div>
<p>
front.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)
</pre>
</div>

<p>
user.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)
</pre>
</div>
<p>
三个文件都创建了蓝图对象,且指定了 url 前缀,因为 front 是面向前台的,所以url前缀为空.
蓝图创建好后,还需要在 app.py 中完成注册,否则是无法使用的.
注册蓝图:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp


<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)

db.init_app(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
</pre>
</div>
<p>
后续开发中,所有前台的视图代码会放在 front 蓝图中. 所以 app.py 中实际上不会存放太
多(甚至是没有)视图函数/类的代码.
</p>
</div>
</div>

<div id="outline-container-orgee6ca0e" class="outline-4">
<h4 id="orgee6ca0e">models 模块</h4>
<div class="outline-text-4" id="text-orgee6ca0e">
<p>
为了让项目更加简洁,所有的 ORM 模型也要进行模块化.
创建一个名为 models 的Python Package(文件夹),然后在 models 下创建 user.py 和
post.py 分别用来存放用户和帖子相关的 ORM 模型.
</p>

<p>
到此为止,项目的结构已经搭建好了.
</p>
</div>
</div>
</div>

<div id="outline-container-org98c4418" class="outline-3">
<h3 id="org98c4418">创建用户相关模型</h3>
<div class="outline-text-3" id="text-org98c4418">
</div>
<div id="outline-container-orgbbfae29" class="outline-4">
<h4 id="orgbbfae29">创建权限和角色</h4>
<div class="outline-text-4" id="text-orgbbfae29">
<p>
权限和角色模型已经创建完成了,为了方便后期开发,需要先在这两张表中添加数据.
</p>

<p>
一般情况下,权限和角色的数据在网站上线运营后就不会轻易更改. 实际开发中可以更产品
经理或运营沟通,确定好权限规则以及角色安排,然后在项目中把这些数据写好,并且加成到
命令中,项目上线时,只需要执行命令即可完成数据的初始化.
</p>

<p>
首先,我们需要学习在 Flask 中如何创建命令. click 库(包)的主要作用就是实现命令,在
安装 Flask 时,默认会安装 click 库.
</p>
<blockquote>
<p>
Flask 命令就是我们使用过的 flask run 这种命令,在这部分之前我也不知道原来类似 run
这样的命令在 Flask 中也是可以定制的.
</p>
</blockquote>

<p>
Flask 中已经针对 click 库进行了集成, 通过 app.cli 就可以访问到 click 对象.
</p>

<p>
先用一个简单的命令进行测试:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"my-command"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">my_command</span>():
    click.echo(<span style="font-style: italic;">"&#36825;&#26159;&#25105;&#33258;&#23450;&#20041;&#30340;&#21629;&#20196;"</span>)
</pre>
</div>
<p>
上面的代码通过 <code>@app.cli.command</code> 装饰器将 my_command 函数添加到命令中,并指定命
令的名称为 my-command. 然后在命令行(终端)中就可以使用 my-command 命令了:
</p>

<div class="org-src-container">
<pre class="src src-sh">flask my-command
</pre>
</div>

<p>
现在我们来创建添加权限和角色的命令.
</p>

<p>
权限和角色是针对后台用户的,因此权限和角色都是针对后台数据管理的.
</p>

<p>
后台要管理的数据有 板块,帖子,评论,前台用户,后台用户, 每个模块都要添加对应权限.
</p>

<p>
在 app.py 中实现一个 create-permission 的命令:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"create-permission"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>

<p>
执行命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-permission
</pre>
</div>

<p>
查看数据库的 Permission 表:
</p>
<pre class="example" id="org820bbfd">
mysql&gt; use pythonbbs
Database changed
mysql&gt; select * from Permission;
+----+------------+
| id | name       |
+----+------------+
|  1 | BOARD      |
|  5 | POST       |
|  3 | COMMENT    |
|  4 | FRONT_USER |
|  2 | CMS_USER   |
+----+------------+
5 rows in set (0.00 sec)
</pre>
<p>
可以看到所有权限都已经添加到了 Permission 表中.
</p>

<p>
创建完权限数据后,再来添加角色.暂定有三个角色, 稽查,运营,管理员.它们对应的角色如
下:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 17:</span> 角色包含的权限</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">角色</td>
<td class="org-left">权限</td>
</tr>

<tr>
<td class="org-left">稽查</td>
<td class="org-left">帖子,评论</td>
</tr>

<tr>
<td class="org-left">运营</td>
<td class="org-left">板块,帖子,评论,前台用户</td>
</tr>

<tr>
<td class="org-left">管理员</td>
<td class="org-left">板块,帖子,评论,前台用户,后台用户</td>
</tr>
</tbody>
</table>

<p>
稽查角色负责审核用户发布的帖子和评论是否符合规范,运营可以管理除了后台用户以外的
所有功能,管理员除了拥有运营的权限之外海拥有管理后台用户的权限.
</p>

<p>
根据以上需求,创建添加角色的命令 create-role:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"create-permission"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"create-role"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>
<p>
查看数据库中数据:
</p>
<pre class="example" id="org0152098">
mysql&gt; select * from role;
+----+-----------+-----------------------------------------------+---------------------+
| id | name      | desc                                          | create_time         |
+----+-----------+-----------------------------------------------+---------------------+
|  1 | 稽查      | 负责审核帖子和评论是否符合规范                | 2023-04-30 18:43:44 |
|  2 | 运营      | 负责网站持续正常运行                          | 2023-04-30 18:43:44 |
|  3 | 管理员    | 负责整个网站所有工作                          | 2023-04-30 18:43:44 |
+----+-----------+-----------------------------------------------+---------------------+
3 rows in set (0.00 sec)

mysql&gt; select * from role_permission_table;
+---------+---------------+
| role_id | permission_id |
+---------+---------------+
|       2 |             1 |
|       2 |             5 |
|       2 |             3 |
|       2 |             4 |
|       2 |             2 |
|       3 |             1 |
|       3 |             5 |
|       3 |             3 |
|       3 |             4 |
|       3 |             2 |
|       1 |             5 |
|       1 |             3 |
+---------+---------------+
12 rows in set (0.00 sec)
</pre>
<p>
可以看到 inspector, operator 和 administrator 对应的角色都添加到了角色表,且角色
对应权限关系也添加到了 role_permission_table.
</p>

<p>
虽然成功添加了命令,出于将视图模块化(蓝图),ORM 代码模块化相同的原因,为了项目的简
洁,代码的可维护性,命令相关的代码也需要单独放到一个模块中.
</p>

<p>
pythonbbs 项目根目录下创建一个 commands.py 然后把 create-permission 和
create-role 函数及其装饰器代码剪切到 commands.py 中,把相关依赖包也剪贴进去:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"create-permission"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@app.cli.command</span>(<span style="font-style: italic;">"create-role"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>
<p>
可以看到,commnds.py 的代码中使用了 @app.cli.command 这个装饰器,这个装饰器是 app
对象的装饰器,但此时我们没有导入 app.py 中的 app 对象,一旦导入了,那就成了循环引用,所
以我们需要把装饰器和它装饰的函数分开,函数放在 commands.py 中,装饰器放到 app.py
中,这样就解决引用问题了:
</p>
<blockquote>
<p>
另外,也可以看到这里我们是从 exts 模块里导入了 db, 就避免
了 db 变量的循环引用问题了,前面将第三方插件需要的变量放到 exts.py 文件的好处在这
里就体现出来了.
</p>
</blockquote>

<p>
commands.py 中删除 app 对象的装饰器代码,只保留创建命令的函数:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>

<p>
app.py 中导入 commands 模块(的函数)再使用装饰器添加函数:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
</pre>
</div>

<p>
可以看到修改后的 app.py 文件又变苗条了,而且其中的代码全是某个操作,而操作的实现都
分离出去了,整个文件看起来比之前挤在一起顺眼多了.
</p>
<blockquote>
<p>
装饰器本质上就是函数,反正我一直都把它叫做装饰器函数的,所以装饰器是可以直接当函数
使用的,只不过一般的函数都是以值,类的实例化对象等作为参数,而装饰器函数的参数是
"函数" 这种 "对象".
对象的概念不是初学面向对象理解的是类的实例化对象,应该说面向对象思想里所有东西都
是 object (对象),类是一种对象,变量也是一种对象,类的实例化也叫对象.
</p>

<p>
重温装饰器:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@deco</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">func</span>():<span style="font-weight: bold;">pass</span>
</pre>
</div>

<p>
等价于 <code>func = deco(func)</code>, 而 deco 只是一个普通的函数,只不过它接受的参数是函数
对象,返回的参数也是函数对象.
</p>
</blockquote>

<blockquote>
<p>
这些权限和角色是使用命令创建而不是像之前一样用 SQLAlchemy 直接创建我猜有下面几个
原因:
</p>
<ul class="org-ul">
<li>权限和角色是开发时最基础最基本的数据库内容,所有开发都会涉及到它们,所以必需先设
置好数据.</li>
<li>角色和权限的数据定好了就不会再更改(一般),不然后面所有代码都会受影响.</li>
<li>它没有像之前我们操作数据库一样写在视图里是因为这属于运维/开发的范畴,写在视图中
就相当于网站的数据库还没初始化好,却需要在网站的某个页面给网站做初始化.这在我的
直觉上感觉与分工合作的工作模式矛盾,正常应该是网站部署完毕后,才能通过网页操作网
站,我们之前访问网页(视图)执行操作数据库的操作是为了学习和测试才那样做的.</li>
</ul>
</blockquote>
</div>
</div>
<div id="outline-container-orgf379709" class="outline-4">
<h4 id="orgf379709">创建用户模型</h4>
<div class="outline-text-4" id="text-orgf379709">
<p>
下面可以创建用户模型了.用户数据是网站最重要的数据之一,如果用户主键存储为自增的整
型,很容易被竞争对手猜测出有多少用户,一般的网站都可以查看用户信息,而用户信息的界
面必需携带用户 ID 参数,如果 ID 是自增长的整型,只需要查看个人信息页面的 URL 就可
以了,因为该 URL 必需携带用户 ID 参数.
</p>

<p>
由于用户 ID 用自增长的整型很容易泄漏用户数量的信息,所以商业网站通常用唯一的字符
串作为用户主键.
</p>

<p>
产生唯一字符串的库有很多,最常用的是 UUID(universally unique identifier), UUID 出
现重复值的概率"几乎为零",可以忽略不计.
</p>

<p>
UUID 总长度为 36 个字符, 32 个字符加上 4 个横线, 由于 UUID 太长会对数据库查询造
成影响,所以我们使用 shortuuid, 这个库会对原始 UUID 进行 base57 编码,然后删除相似
的字符,如 I,1,L,O,o, 最后生成默认 22 位长度的字符串.
安装 shortuuid
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install shortuuid
</pre>
</div>
<p>
使用时直接调用 uuid() 方法就可以生成一串唯一的字符串了.
</p>

<p>
现在我们把它添加到用户模型中, models/user.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> enum <span style="font-weight: bold;">import</span> Enum
<span style="font-weight: bold;">from</span> shortuuid <span style="font-weight: bold;">import</span> uuid

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionEnum</span>(Enum):
    <span style="font-weight: bold; font-style: italic;">BOARD</span> = <span style="font-style: italic;">"&#26495;&#22359;"</span>
    <span style="font-weight: bold; font-style: italic;">POST</span>  = <span style="font-style: italic;">"&#24086;&#23376;"</span>
    <span style="font-weight: bold; font-style: italic;">COMMENT</span> = <span style="font-style: italic;">"&#35780;&#35770;"</span>
    <span style="font-weight: bold; font-style: italic;">FRONT_USER</span> = <span style="font-style: italic;">"&#21069;&#21488;&#29992;&#25143;"</span>
    <span style="font-weight: bold; font-style: italic;">CMS_USER</span>  = <span style="font-style: italic;">"&#21518;&#21488;&#29992;&#25143;"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"permission"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.Enum(PermissionEnum), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">roles</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>,back_populates=<span style="font-style: italic;">"permissions"</span>)



<span style="font-weight: bold; font-style: italic;">role_permission_table</span> = db.Table(
    <span style="font-style: italic;">"role_permission_table"</span>,
    db.Column(<span style="font-style: italic;">"role_id"</span>,db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>)),
    db.Column(<span style="font-style: italic;">"permission_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"permission.id"</span>))
)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RoleModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"role"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">desc</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">permissions</span> = db.relationship(<span style="font-style: italic;">"PermissionModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>, back_populates=<span style="font-style: italic;">"roles"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"role"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.String(100), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, default=uuid)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">password</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">email</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">avatar</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">signature</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">join_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Foreign Key</span>
    <span style="font-weight: bold; font-style: italic;">role_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>))
    <span style="font-weight: bold; font-style: italic;">role</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, back_populates=<span style="font-style: italic;">"users"</span>)
</pre>
</div>

<blockquote>
<p>
这里使用 default=uuid 而不是 default=uuid() 的原因:
官方: <a href="https://docs.sqlalchemy.org/en/20/core/metadata.html#sqlalchemy.schema.Column.params.default">scheme.column.params.default</a>
博客: <a href="https://www.weiney.com/2148.html">如何实现 Column 初始化赋值</a> ,这篇博客问题分析的部分.
其实前面 default=datetime.now 的时候也用了 default, 只不过我对 datetime 不熟,还
以为就是这样用的,而且当时出了个拼写错误的 bug db.DateTime 写成了 db.Datetime, 所
以没主意 default 的用法,实际上 default 是 <a href="https://docs.sqlalchemy.org/en/20/core/defaults.html#sqlalchemy.schema.ColumnDefault">class sqlalchemy.schema.ColumnDefault</a>
的快捷使用方式,它接受字面值,可调用函数或 SQL 子句, db.Model 的子类定义只是对数据
库表结构的简单映射,只有真正映射到数据库时(比如插入数据,创建数据表),才会插入这些
值.
我的理解,定义的这些 db.Model 子类,都存储在 session 中,并没有实例化,而 session 是
一个 SQLAlchemy 实例化对象 db 的某个属性,只有在执行 commit 时,才会真正生成值,并
映射到数据库中.
</p>

<p>
照理说这里应该不存在任何理解上的困难,因为只要清楚的了解类定义与类初始化时都进行
了哪些操作,就很容易理解,但是我有些知识忘了,也可能有些还没有学全,所以花费了时间去
理解.
函数调用就是等价于值,函数对象则可以被调用.
</p>
</blockquote>

<p>
上面代码中添加了 UserModel 模型,它有以下字段:
</p>
<ul class="org-ul">
<li>id: 主键,字符串类型,默认使用 shortuuid.uuid 函数自动生成主键.</li>
<li>username: 用户名,不能空,不能重复(值必需唯一).</li>
<li>password: 密码,最大长度为 200, 应先加密再存储.</li>
<li>email: 邮箱,不能为空,值唯一,作为登录凭证.</li>
<li>avatar: 头像,存储图片在服务器中保存的路径,可以为空.</li>
<li>signature: 签名,可以为空.</li>
<li>join_time: 加入时间,第一次创建时会使用当前时间存储.</li>
<li>is_staff: 是否为员工,只有员工才能进入后台系统,默认 False.</li>
<li>is_active: 是否可用,默认可用,不可用则限制登录.</li>
<li>role_id: 角色外键,引用 role 表的 id 字段.</li>
<li>role: 关系属性,引用 RoleModel. 反过来,也可以通过 RoleModel 对象的 users 属性获
取此角色下的所有用户.</li>
</ul>


<p>
用户的密码必须经过加密才能存储,这样即使服务器遭到攻击,密码数据被泄漏,黑客也只能
看到加密后的密码,不是原始密码. 如果黑客获取到原始密码,并获取了用户的其他账号,可
能导致用户其他平台上的账户也被登录,因为许多用户通常会将多个账号密码设置为一样的.所
以密码必须先加密再存储.
</p>

<p>
Flask 项目中,可以通过 werkzeug.securit 模块中的下面两个方法实现密码的加密和验证:
</p>
<ul class="org-ul">
<li>generate_password_hash(password): 对 password 进行加密,并返回加密后的密码.</li>
<li>check_password_hash(pwhash, password): pwhash 是加密后的密码,password 是原始密
码,将 password 按照相同加密方式加密,然后与 pwhash 对比,相同则认为密码正确,否则
认为密码错误.</li>
</ul>


<blockquote>
<p>
generate_password_hash 用来注册时第一次存储密码, check_password_hash 用来登录时
检测用户密码是否输入正确.
</p>
</blockquote>
<p>
用上面的方法添加一条用户数据的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> werkzeug.security <span style="font-weight: bold;">import</span> generate_password_hash

<span style="font-weight: bold; font-style: italic;">user</span> = UserModel(username=<span style="font-style: italic;">"example"</span>, email=<span style="font-style: italic;">"example@domain.com"</span>)
user.<span style="font-weight: bold; font-style: italic;">password</span> = generate_password_hash(<span style="font-style: italic;">"password"</span>)
</pre>
</div>
<p>
为了简化创建用户时生成密码的代码,我们可以将 UserModel 重构,直接将 password 传递
进去就会自动完成加密;或者用户通过 user.password="password" 设置密码时,也要自动完
成加密:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> enum <span style="font-weight: bold;">import</span> Enum
<span style="font-weight: bold;">from</span> shortuuid <span style="font-weight: bold;">import</span> uuid
<span style="font-weight: bold;">from</span> werkzeug.security <span style="font-weight: bold;">import</span> generate_password_hash, check_password_hash

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionEnum</span>(Enum):
    <span style="font-weight: bold; font-style: italic;">BOARD</span> = <span style="font-style: italic;">"&#26495;&#22359;"</span>
    <span style="font-weight: bold; font-style: italic;">POST</span>  = <span style="font-style: italic;">"&#24086;&#23376;"</span>
    <span style="font-weight: bold; font-style: italic;">COMMENT</span> = <span style="font-style: italic;">"&#35780;&#35770;"</span>
    <span style="font-weight: bold; font-style: italic;">FRONT_USER</span> = <span style="font-style: italic;">"&#21069;&#21488;&#29992;&#25143;"</span>
    <span style="font-weight: bold; font-style: italic;">CMS_USER</span>  = <span style="font-style: italic;">"&#21518;&#21488;&#29992;&#25143;"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"permission"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.Enum(PermissionEnum), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">roles</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>,back_populates=<span style="font-style: italic;">"permissions"</span>)



    <span style="font-weight: bold; font-style: italic;">role_permission_table</span> = db.Table(
        <span style="font-style: italic;">"role_permission_table"</span>,
        db.Column(<span style="font-style: italic;">"role_id"</span>,db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>)),
        db.Column(<span style="font-style: italic;">"permission_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"permission.id"</span>))
)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RoleModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"role"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">desc</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">permissions</span> = db.relationship(<span style="font-style: italic;">"PermissionModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>, back_populates=<span style="font-style: italic;">"roles"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"role"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.String(100), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, default=uuid)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">_password</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">email</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">avatar</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">signature</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">join_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Foreign Key</span>
    <span style="font-weight: bold; font-style: italic;">role_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>))
    <span style="font-weight: bold; font-style: italic;">role</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, back_populates=<span style="font-style: italic;">"users"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, *args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">"password"</span> <span style="font-weight: bold;">in</span> kwargs:
            <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">password</span> = kwargs.get(<span style="font-style: italic;">"password"</span>)
            kwargs.pop(<span style="font-style: italic;">"password"</span>)

        <span style="font-weight: bold;">super</span>(UserModel, <span style="font-weight: bold;">self</span>).__init__(*args, **kwargs)

    @<span style="font-weight: bold;">property</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>._password

    <span style="font-weight: bold; text-decoration: underline;">@password.setter</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">_password</span> = generate_password_hash(raw_password)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">check_password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold; font-style: italic;">result</span> = check_password_hash(<span style="font-weight: bold;">self</span>.password, raw_password)
        <span style="font-weight: bold;">return</span> result

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">has_permission</span>(<span style="font-weight: bold;">self</span>, permission):
        <span style="font-weight: bold;">return</span> permission <span style="font-weight: bold;">in</span> [permission.name <span style="font-weight: bold;">for</span> permission <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">self</span>.role.permissions]
</pre>
</div>
<p>
上面的代码把原本的 password 修改成了属性 _password, 然后通过 @property 装饰器将
password() 方法定义为属性,以后通过 user.password 就可以获取加密后的密码, 而
user.password="password" 则会触发 @password.setter 下面的 password 方法,这个方法
把原始的密码加密后赋值给了 _password 属性. 为了后面验证密码的方便,还实现了
check_password 方法,该方法通过调用 check_password_hash 进行检测. 此外这次修改还
实现了一个 has_permission 方法,用来判断当前用户是否拥有某个权限.
</p>

<p>
至此, UserModel 模型创建完成,使用 Flask-Migrate 可以将修改映射到数据库中:
</p>
<ul class="org-ul">
<li><p>
生成迁移脚本:
</p>

<div class="org-src-container">
<pre class="src src-sh">flask db migrate -m <span style="font-style: italic;">"create user model"</span>
</pre>
</div></li>
</ul>


<ul class="org-ul">
<li><p>
执行脚本:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db upgrade
</pre>
</div></li>
</ul>


<p>
使用 flask-migrate 同步数据库的更新确实好用,以前我都是手动删除数据库然后再重新用
代码创建一遍的,用这个库俩命令就搞定了.
</p>
</div>
</div>
<div id="outline-container-org2663ee6" class="outline-4">
<h4 id="org2663ee6">创建测试用户</h4>
<div class="outline-text-4" id="text-org2663ee6">
<p>
为了方便后续的开发,先按照角色个数创建 3 个员工账号,在 commands.py 文件中添加
create_test_user 函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum, UserModel
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_user</span>():
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">zhangsan</span> = UserModel(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,
                         email=<span style="font-style: italic;">"zhangsan@123.com"</span>,
                         password=<span style="font-style: italic;">"111111"</span>,
                         is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                         role=admin_role)


    <span style="font-weight: bold; font-style: italic;">operator_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">lisi</span> = UserModel(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,
                     email=<span style="font-style: italic;">"lisi@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=operator_role)

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">wangwu</span> = UserModel(username=<span style="font-style: italic;">"&#29579;&#20116;"</span>,
                     email=<span style="font-style: italic;">"wangwu@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)

    db.session.add_all([zhangsan,lisi,wangwu])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>
<p>
上面的代码添加了一个 flask 命令,用于添加张三,李四王五三个员工账号,对应管理员,运
营,稽查3种角色,以便后续开发时使用.按照之前的做法,回到 app.py 把命令添加到项目中.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
</pre>
</div>

<p>
添加完成,可以使用该命令创建测试用户了:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-test-user
</pre>
</div>

<p>
查看数据库 user 表:
</p>
<pre class="example" id="orgb416a65">
mysql&gt; select id,username,role_id from user;
+------------------------+----------+---------+
| id                     | username | role_id |
+------------------------+----------+---------+
| 7DHejoyeSd43ZArCiNf9GU | 李四     |       2 |
| EaL9zRjnNTbK5tUxos4MJR | 王五     |       1 |
| fQRQxPPL7TwDLE98TGzCtz | 张三     |       3 |
+------------------------+----------+---------+
3 rows in set (0.00 sec)
</pre>
<p>
可以看到三个测试用户已经添加成功了.
</p>
</div>
</div>

<div id="outline-container-org80c1c09" class="outline-4">
<h4 id="org80c1c09">创建管理员</h4>
<div class="outline-text-4" id="text-org80c1c09">
<p>
项目后期,在部署到服务器后,应该通过命令完成第一个管理员的初始化.
</p>

<p>
添加管理员的 click 命令:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum, UserModel
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_user</span>():
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">zhangsan</span> = UserModel(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,
                         email=<span style="font-style: italic;">"zhangsan@123.com"</span>,
                         password=<span style="font-style: italic;">"111111"</span>,
                         is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                         role=admin_role)


    <span style="font-weight: bold; font-style: italic;">operator_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">lisi</span> = UserModel(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,
                     email=<span style="font-style: italic;">"lisi@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=operator_role)

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">wangwu</span> = UserModel(username=<span style="font-style: italic;">"&#29579;&#20116;"</span>,
                     email=<span style="font-style: italic;">"wangwu@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)

    db.session.add_all([zhangsan,lisi,wangwu])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--username"</span>, <span style="font-style: italic;">"-u"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--email"</span>, <span style="font-style: italic;">"-e"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--password"</span>, <span style="font-style: italic;">"-p"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_admin</span>(username, email, password):
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">admin_user</span> = UserModel(username=username,email=email,password=password, is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>, role=admin_role)
    db.session.add(admin_user)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#31649;&#29702;&#21592;&#21019;&#24314;&#25104;&#21151;!"</span>)
</pre>
</div>
<p>
将命令添加到项目:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
</pre>
</div>

<p>
现在尝试用命令添加一个管理员:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-admin -u kamisama -e kamisama@123.com -p kamisama
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3a05cdc" class="outline-3">
<h3 id="org3a05cdc">注册</h3>
<div class="outline-text-3" id="text-org3a05cdc">
</div>
<div id="outline-container-org4f2131a" class="outline-4">
<h4 id="org4f2131a">渲染注册模板</h4>
<div class="outline-text-4" id="text-org4f2131a">
<p>
用命令添加用户的方法通常都不是给网站的目标用户使用的,而是给开发人员,运维等使用的.
</p>

<p>
要让普通用户能注册,就需要有一个网页界面.
</p>

<p>
作者书中给出的资料里提供了准备好的模板,在 pythonbbs 下的 awebsite 文件夹,所有文
件都是纯静态的.
</p>
<ol class="org-ol">
<li>将该文件夹下的 static 下的所有文件和文件夹复制到自己项目的 pythonbbs/static
中.</li>
<li>将 pythonbbs/awebsite/templates 下的所有文件和文件夹全部复制到
pythonbbs/templates 中.</li>
</ol>


<p>
后续的内容都是基于此完成的.
</p>

<p>
先来看看所有前台页面都会继承的父模板 templates/front/base.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
这个父模板文件是所有前台页面的父模板,在 head 标签中,它加载了以下文件:
</p>
<ul class="org-ul">
<li>jquery.min.js: 3.6.0 版本的 jQuery 文件. JQuery 文件可以快速查找元素,发送 AJAX
请求.</li>
<li>bootstrap.min.css: 4.6.0 版本的 Bootstrap 样式文件. Bootstrap 提供丰富的样式,
可以快速构建网页.</li>
<li>bootstrap.min.js: 4.6.0 版本的 Bootstrap Javascript 文件. Bootstrap 中的一些组
件运行需要通过 bootstrap.min.js 来实现.</li>
<li>base.css: 我们自己编写的样式文件,用来修改父模板的样式.</li>
</ul>


<p>
head 标签中还定义了两个 block, 分别是 title 和 head.
</p>

<p>
body 标签中定义了导航条,这样所有子模板都不用重复写导航条代码即可拥有导航条. 然后
main-container 中定义了一个 body 的 block, 子模板页面的编写就在这个 block 中实现.
</p>

<p>
再看看注册页面, templates/front/register.html:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
该文件中,首先让 register.html 继承自 front/base.html, 然后分别实现了 title, head
和 body 三个 block. title 用来设置页面标题, head 中加载了一个自定义的 sign.css
文件,用来美化页面. body 这个 block 中,除了添加 h1 标签外,还添加了输入框的表单,表
单有5个输入框和1个提交按钮. 输入框用来收集邮箱,邮箱验证码,用户名,密码,确认密码的
信息. 我们先渲染模板,看看效果:
</p>

<p>
在 blueprints/user.py 中  :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return render_template("test.html")</span>
</pre>
</div>
<p>
实现了 register 视图,用来渲染模板 register.html.
</p>
<blockquote>
<p>
这里要提一下,模板继承的 extend 指定模板时,使用的目录是相对于 templates 的目录,
render_template 使用的目录是 template_folder 指定的目录,前面测试时我们直接使用文
件名,是因为文件就在这些指定的目录下面,而现在我们加上了 front 是因为它们位于
templates 目录的子目录 front 中.
</p>
</blockquote>
<p>
现在,我们启动项目,访问 <a href="http://127.0.0.1:5000/user/register">http://127.0.0.1:5000/user/register</a>, 就可以看到注册页面
了:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask run
</pre>
</div>
<p>
emmm 到这里了我竟然没有把前面所有的东西都加到 app.py 中,现在也不迟:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.config.from_object(config.DevelopmentConfig)
db.init_app(app)
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
添加完成,运行上面的命令,浏览器打开页面可以看到注册页面,这个页面的逻辑和常用的注
册页面逻辑一样,用户输入邮箱,点击 "发送验证码" 的按钮,服务器就向该邮箱发送一个验
证码,用户将验证码填入输入框,并完成其他信息的输入,最后单击 "立即注册"按钮,即可实
现注册.
</p>
</div>
</div>

<div id="outline-container-org456fc8b" class="outline-4">
<h4 id="org456fc8b">使用 Flask-Mail 发送邮箱验证码</h4>
<div class="outline-text-4" id="text-org456fc8b">
<p>
根据上面的逻辑,注册的第一步,需要给用户的邮箱发送验证码,下面就实现在 Flask 中发送
邮件.
</p>

<p>
Flask 中发送邮件很简单,总共 3 步:
</p>
<ul class="org-ul">
<li>安装 Flask-Mail</li>
<li>配置邮箱参数</li>
<li>发送邮件</li>
</ul>
</div>

<ul class="org-ul">
<li><a id="org62bc88a"></a>安装 Flask-Mail<br />
<div class="outline-text-5" id="text-org62bc88a">
<p>
Flask-Mail 是第三方插件,需要单独安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-mail
</pre>
</div>

<p>
Flask-Mail 的详细使用说明可以参考官方文档: <a href="https://pythonhosted.org/Flask-Mail/">Flask-Mail</a>
</p>
</div>
</li>

<li><a id="org57dc795"></a>配置邮箱参数<br />
<div class="outline-text-5" id="text-org57dc795">
<p>
发送邮件必须有一个发送者,通常商业网站是由邮箱服务器发送邮件的,而我们个人学习,则
可以使用自己的个人邮箱来实现邮件发送.
</p>
<blockquote>
<p>
我们自己的邮箱就相当于使用的是其他公司的邮箱服务器,比如我们用 QQ 邮箱发送邮件,就
是用腾讯公司提供的邮箱服务器发送邮件,网易,Gmail 等都是一样的.
</p>

<p>
有的公司会自己搭建邮箱服务器,有的公司直接够买第三方的邮箱服务器,比如腾讯企业邮箱,阿
里企业邮箱等.
</p>
</blockquote>

<p>
使用 Flask-Mail 发送邮件需要使用 SMTP 协议(simple mail transfer protocol).
</p>
<blockquote>
<p>
之前我编写过一个给 Kindle 文档服务器发送个人文档的 Python 脚本,用的是 Python 内
置的 smtplib 库.因为只是简单的发送文档,没有其他需求,所以脚本也很简单,但是由于需
要进行网络通信,发送的文档越大,程序执行时间就越长. 这个 Flask-Mail 也使用的这种线
程独占的方式发送邮件,这就会导致只有当邮件发送成功后才会有用户响应,也就是说,在等
待网络请求完成之前,发送邮件的这个线程都会占用 CPU, 直到请求完成才会进行下一步,这
期间如果用户执行另外的操作,是不会被响应的,因为这就相当于程序在这里卡主了,但我们
自己使用别人的网站注册时,都不会发生这种情况,所以一定不是单独用 Flask-Mail 这种来
完成邮件发送的.
</p>
</blockquote>
<p>
而使用个人邮箱通过软件发送邮件,需要开通邮箱服务提供方的 SMTP 服务,网易,QQ 邮箱等
的开启 SMTP 在网上都有详细教程.
</p>

<p>
开启个人邮箱的 SMTP 服务后,会获得一个授权密码,这个密码会在代码中用到,回到
项目的 config.py 文件中,在 DevelopmentConfig 中添加配置:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>
<blockquote>
<p>
邮箱账号以及授权密码涉及隐私,所以我额外用了一个代码块来 tangle, 但是不导出到 html.
</p>
</blockquote>
<p>
新增的配置项参数说明:
</p>
<ul class="org-ul">
<li>MAIL_SERVER: 邮箱服务器,网易是 smtp.163.com, qq 邮箱是 smtp.qq.com, 新浪是
smtp.sina.com</li>
<li>MAIL_USE_SSL: 是否设置加密传输, 设置 MAIL_USE_SSL 或 MAIL_USE_TLS 为 True, 都
可以实现加密传输,但是 SSL 用的是 SSL/TLS 协议, 而 TLS 用的是 STARTTLS, 具体协
议需要根据邮箱服务的提供商来配置,例如,网易不支持 STARTTLS, 因此只能用 SSL, 另
外,如果设置 TLS, 那么端口 MAIL_PORT 应该设置为 587, 465 对应的是 SSL/TLS 协议.</li>
<li>MAIL_USERNAME: 发送邮件所用的用户名,设置为邮箱账号就可以了.</li>
<li>MAIL_PASSWORD: 开启 SMTP 服务时的授权密码.</li>
<li>MAIL_DEFAULT_SENDER: 默认的发送者,设置为邮箱账号即可.</li>
</ul>


<p>
上述配置完成就可以进行邮件的发送了.
</p>
</div>
</li>

<li><a id="org8305d01"></a>发送邮件<br />
<div class="outline-text-5" id="text-org8305d01">
<p>
用 Flask-Mail 发送邮件,要先陈建一个 Flask-Mail 对象, 使用方式和 Flask-SQLAlchemy
类似.
</p>

<p>
先在 exts.py 文件中创建一个 mail 变量:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Mail

<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy()

<span style="font-weight: bold; font-style: italic;">mail</span> = Mail()
</pre>
</div>

<p>
再回到 app.py 中,引入这个变量,并进行初始化:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
初始化完成,后续就可以使用 mail 来发送邮件了.
</p>

<p>
在 blueprints/user.py 中实现发送邮件验证码的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold; font-style: italic;">message</span> = Message(
        subject = <span style="font-style: italic;">"&#37038;&#20214;&#20027;&#39064;"</span>,
        recipients=[<span style="font-style: italic;">"wj915614874@163.com"</span>],
        body = <span style="font-style: italic;">"&#37038;&#20214;&#20869;&#23481;"</span>
    )
    mail.send(message)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"success"</span>

</pre>
</div>
<p>
我们新增了一个 mail_captcha 视图函数,创建了一个对象 flask_mail.Message, Message
类的参数:
</p>
<ul class="org-ul">
<li>subject: 邮件主题.</li>
<li>recipients: 收件方,可以指定多个邮箱地址.</li>
<li>body: 邮件内容.</li>
</ul>


<p>
创建 Message 对象后,调用 mail.send 方法就可以把邮件发送出去了.
我把目标地址设置为我网易邮箱地址(我用的qq 的 smtp 服务,作者用的网易的 smtp 服务),然
后访问网址 <a href="http://127.0.0.1:5000/user/mail/captcha">http://127.0.0.1:5000/user/mail/captcha</a> , 页面显示 success, 然后我的
网易邮箱就收到了一封邮件,内容就是 "邮件内容" (body 变量的内容). 这证明到目前为止
邮件发送的功能已经正常实现了.
</p>

<p>
我们邮箱验证码不可能总发送固定的内容,所以需要用随即验证码,作者采用4位随机的数字,
需要用到 python 的 random 模块. 而且,由于收件方是用户填写的邮箱地址,所以收件方也
不能固定,根据这两个需求,修改 mail_captcha 视图函数:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">email = request.args.get("mail")</span>
    <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-style: italic;">"wj915614874@163.com"</span>
    <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
    <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
    <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
    <span style="font-weight: bold; font-style: italic;">message</span> = Message(
        subject = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        recipients=[email],
        body = body
    )
    mail.send(message)
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"success"</span>

</pre>
</div>
<p>
上面用 random.sample 随机从 0-9 中取出4个值,然后用 "" 拼接起来,返回就是一个4位数
字的字符串,然后拼接成邮件主体.
</p>
<blockquote>
<p>
前面我是直接访问 <a href="http://127.0.0.1:5000/user/mail/captcha">http://127.0.0.1:5000/user/mail/captcha</a> 来测试邮件发送功能,是因
为没有在 html 模板文件中找到访问 user/mail/captcha 的代码,也忘记了还有 js 可以发
送 AJAX 请求,到这里突然记起来前面从作者提供的资料里还复制了静态文件的,去里面找了
找,果然有 register.js 文件,里面确实绑定了发送验证码的行为, 所以是可以直接在注册
页面进行测试的.
</p>

<p>
emmm, 找错了,找的是作者完成的项目中的 javascript 文件, 按照作者书中的顺序,这里是
还没有这些 js 文件的,所以注册页面点击发送验证码并不会发起 mail_captcha 对应的
URL 请求,那至少现在还是把 email 写死,然后直接访问上面用过的网址测试吧.
</p>

<p>
另外,我在消息 body 里写了 h1 标签和换行符 "\n" 也可以测试它们是否会生效.
</p>

<p>
还有,既然需要直接访问就得返回一个响应,不然会报措,但邮件还是照样会发送.
</p>

<p>
嗯,测试结果出来了, 邮件内容中不能直接使用 HTML 标签,带格式的邮件有正式名称的,叫
HTML Email, 它的简单介绍:<a href="https://www.ruanyifeng.com/blog/2013/06/html_email.html">阮一峰:HTML Email 编写指南</a>
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org93f5eb2" class="outline-4">
<h4 id="org93f5eb2">使用 Flask-Caching 和 Redis 缓存验证码</h4>
<div class="outline-text-4" id="text-org93f5eb2">
<p>
目前已经实现了通过 Flask 发送邮件验证码,但是我们并没有做任何记录,也就是说没有建
立邮箱与验证码的关系,用户提交时我们不能确定用户提交的验证码是不是我们发送过去的
验证码,因此,我们需要将验证码保存下来,注册验证码这类数据并不算重要,写错了还可以重
新发送,所以我们一般把它保存在缓存中. 前面介绍过缓存系统,讲解了 Memcached 和
Redis 的使用,由于后期需要用到 Celery 来异步发送邮件, Celery 又需要 Redis 作为中
间人,所以我们选择使用 Redis 来缓存邮件验证码.
</p>
<blockquote>
<p>
讲解缓存系统的时候,有一个过期时间的设置,这和我们平常用过的注册验证码一样,收到验
证码时总会有提示说多长时间内有效.
</p>
</blockquote>
<p>
因为这是一个新的虚拟环境,所以我们需要重新安装 python-redis 来操作 redis 数据库:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install redis
</pre>
</div>

<p>
前面测试学习时是直接通过 python-redis 来操作 redis 数据库的,这和直接用 pymysql
写原生 SQL 语句操作 mysql 数据库的行为差不多,关系型数据库 MYSQL 等有 SQLAlchemy
提供的统一操作接口,类似的 Redis 这样的缓存系统也有相应的库,那就是 Flask-Caching,
使用 Flask-Caching 操作 Redis 而不是直接像我们前面一样操作 Redis 有以下好处:
</p>
<ul class="org-ul">
<li>缓存系统: Flask-Caching 支持多种缓存系统,如 Memcached, Redis, FileSystem 等.</li>
<li>上层接口: Flask-Caching 对不同的缓存系统提供了统一的上层接口.以后如果不用
Redis 作为缓存了,只需要修改配置即可,不需要修改上层操作缓存的代码.</li>
<li>缓存内容: Flask-Caching 可以对 Flask 项目中许多内容进行缓存,如视图缓存,模板缓
存等.</li>
</ul>



<blockquote>
<p>
其实上面的好处同样适用于关系型数据库的 ORM(object relationshop mapping).
#+end_quote上面
</p>

<p>
安装 Flask-Caching:
</p>

<div class="org-src-container">
<pre class="src src-sh">pip install flask-caching
</pre>
</div>

<p>
Flask-Caching 支持多种缓存系统,可以在 app.config 里设置不同的 CACHE_TYPE 来选择
具体的缓存系统.
</p>

<p>
Flask-Caching 支持的常见 CACHE_TYPE 配置:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 18:</span> CACHE_TYPE 配置</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">CACHE_TYPE</td>
<td class="org-left">说明</td>
</tr>

<tr>
<td class="org-left">NullCache</td>
<td class="org-left">空的缓存,不能使用缓存</td>
</tr>

<tr>
<td class="org-left">SimpleCache</td>
<td class="org-left">简单缓存,仅用于开发环境</td>
</tr>

<tr>
<td class="org-left">FileSystemCache</td>
<td class="org-left">文件系统缓存,将数据存储在文件中</td>
</tr>

<tr>
<td class="org-left">RedisCache</td>
<td class="org-left">Redis 缓存,需要安装 redis 包</td>
</tr>

<tr>
<td class="org-left">MemcachedCache</td>
<td class="org-left">Memcached 缓存,需要安装 memcached 包</td>
</tr>
</tbody>
</table>

<p>
完整的 CACHE_TYPE 配置还是参考官网: <a href="https://flask-caching.readthedocs.io/en/latest/index.html#configuring-flask-caching">Config Flask Caching</a>
</p>

<p>
我们准备用 RedisCache, 所以使用 Redis 相关的配置:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">配置项</td>
<td class="org-left">说明</td>
</tr>

<tr>
<td class="org-left">CACHE_DEFAULT_TIMEOUT</td>
<td class="org-left">过期时间,默认 30s</td>
</tr>

<tr>
<td class="org-left">CAHCE_KEY_PREFIX</td>
<td class="org-left">键前缀,默认是 flask_cache_</td>
</tr>

<tr>
<td class="org-left">CACHE_REDIS_HOST</td>
<td class="org-left">Redis 服务器域名</td>
</tr>

<tr>
<td class="org-left">CACHE_REDIS_PORT</td>
<td class="org-left">Redis 服务器端口号</td>
</tr>

<tr>
<td class="org-left">CACHE_REDIS_PASSWORD</td>
<td class="org-left">Redis 服务器密码</td>
</tr>
</tbody>
</table>

<p>
参照上面配置,在 config.py 的 DevelopmentConfig 中添加对应配置信息:
还是老规矩,涉及隐私的单独放一个 block 里,不导出:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32531;&#23384;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_TYPE</span> = <span style="font-style: italic;">"RedisCache"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_HOST</span> = <span style="font-style: italic;">"127.0.0.1"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_PORT</span> = 6379



<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
配置完 Redis 的域名和端口号,再到 exts.py 里创建相应对象:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Mail
<span style="font-weight: bold;">from</span> flask_caching <span style="font-weight: bold;">import</span> Cache

<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy()

<span style="font-weight: bold; font-style: italic;">mail</span> = Mail()

<span style="font-weight: bold; font-style: italic;">cache</span> = Cache()
</pre>
</div>

<p>
再回到 app.py 文件中,从 exts.py 文件里导入 cache 变量,并初始化:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
初始化完成后,就可以用它来缓存数据了.
</p>

<p>
现在,就可以在 blueprints/user.py 里缓存该数据了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail, cache
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">email = request.args.get("mail")</span>
    <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-style: italic;">"wj915614874@163.com"</span>
    <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
    <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
    <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
    <span style="font-weight: bold; font-style: italic;">message</span> = Message(
        subject = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        recipients=[email],
        body = body
    )
    mail.send(message)
    cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">print(cache.get(email))</span>
    <span style="font-weight: bold;">return</span> cache.get(email)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "success"</span>

</pre>
</div>

<p>
很简单的修改,导入了 cache 变量,保存了邮箱和验证码对应关系的键值对,并将数据过期时
间设置为 100s(应该).
等用户点击完成注册按钮的时候,使用 cache.get(email) 就可以获取缓存中保存的验证码
数据了.
</p>

<p>
#+begin_quote
还是可以检验以下是否有错误的,访问 <a href="http://127.0.0.1:5000/user/mail/captcha">http://127.0.0.1:5000/user/mail/captcha</a>, 然后
打开 redis 终端,输入 get flask_cache_wj915614874@163.com 就可以看到是否缓存了验
证码,之所以是 flask_cahce_&#x2026; 是因为前面配置项里提到过,它是默认的键前缀,就是说不
管是保存数据还是读取数据,默认都会在键前面加上 flask_cache_. 由于这个过期时间设置
的比较短,每次没等我查看呢,数据就已经过期了,不过通过 <code>keys *</code> 命令,确实可以看到发
送后有了一个 flask_cache_wj915614874@163.com 的键,不过很快就没了(过期了),之所以
没有继续测试,一个原因是测试太频繁了,好像接收方给我禁了&#x2026;
emmm 将最后的代码修改了以下,改为返回 cache.get, 就是代码里被注释了的 return
<code>return cache.get(email)</code>, 这下就可以直接在页面里看到是否获取到了验证码了,经过测
试确实一致.ok 这部分的也没有问题了.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org766e6a4" class="outline-4">
<h4 id="org766e6a4">使用 Celery 发送邮件</h4>
<div class="outline-text-4" id="text-org766e6a4">
<p>
现在的 mail_captcha 视图函数虽然实现了发送邮件验证码的功能,但体验并不好,一是邮件
需要发起网络请求,这导致必须等邮件发送成功浏览器才会接受到响应,会导致用户等待时间
过长.另一方面,这种操作会导致线程被占用,而导致无法服务其他请求.造成服务器资源紧张.
</p>
<blockquote>
<p>
这里的线程占用,指的是 CPU 的线程,不是程序的,意思是某个程序占用了 CPU 的线程资源
时间长,例如这里的发送邮件,它需要等待网络请求完成,而这期间如果一直占用 CPU 资源,
就等于是浪费了,因为发送邮件时 CPU 资源是一直在等待请求完成,而不是进行计算.如果网
络稍微慢了一点,而同时注册的用户也多了点,一个用户的请求占用一个 CPU 的线程资源,那
么 100 个用户就需要 100 线程的 CPU 才能完成它们的请求,虽然同时 100 人是假设,但网
址还有其他任务的啊,它们也要占用资源,如果都像发送邮件这样等待,那多少核的 CPU 都不
够用的.
</p>
</blockquote>

<p>
所以对于耗时的操作,一般都是通过异步来实现,最常用,最稳定的(可能是 flask 里实现异
步最常用最稳定的?)就是通过 Celery 实现.
</p>

<p>
Celery 是一个任务调度框架,纯 Python 语言实现,它可以轻松集成到 Flask 项目.
</p>

<p>
Celery 有 5 大模块, Task(任务), Broker(中间人), Celery Bead(调度器),
Worker(消费者), Backend(存储).
</p>

<p>
它的工作流程如下:
先在程序中定义好 Task, 然后启动 Celery, Celery 读取 Task 并存放到 Broker 中,
Broker 是具有存储能力的服务,例如 Redis,RabbitMQ,数据库等. Cele Bead 会根据配置,
或者由开发者手动控制,将任务分配给 Worker, Worker 在完成任务后把结果存储到
Backend 中, Backend 也具有存储能力,一般为了方便, Backend 和 Broker 会使用同一个
服务. Backend 不是必需的, 如果没有设置 Backend 则不会存储结果.
</p>

<p>
Celery 非常适合下面两种场景:
</p>
<ul class="org-ul">
<li>异步任务: 会阻塞程序的耗时操作,例如发送邮件,发送短信,视频转码等</li>
<li>定时任务: 可以通过配置实现定时执行任务,例如定时抓取数据,定时发送报告等.</li>
</ul>


<p>
Celery 是一个第三方 Python 框架,需要单独安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install celery
</pre>
</div>

<p>
安装完成后,在 config.py 中添加相应配置:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32531;&#23384;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_TYPE</span> = <span style="font-style: italic;">"RedisCache"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_HOST</span> = <span style="font-style: italic;">"127.0.0.1"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_PORT</span> = 6379

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Celery &#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26684;&#24335; redis://:password@hostname:port/db_number</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_BROKER_RUL</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_RESULT_BACKEND</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
配置完成后,回到 pythonbbs 根目录,创建一个 bbs_celery.py 文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail
<span style="font-weight: bold;">from</span> celery <span style="font-weight: bold;">import</span> Celery

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23450;&#20041;&#20219;&#21153;&#20989;&#25968;</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">send_mail</span>(recipient, subject, body):
    <span style="font-weight: bold; font-style: italic;">message</span> = Message(subject=subject, recipients=[recipient], body=body)
    mail.send(message)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"&#21457;&#36865;&#25104;&#21151;!"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314; Celery &#23545;&#35937;</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">make_celery</span>(app):
    <span style="font-weight: bold; font-style: italic;">celery</span> = Celery(app.import_name, backend=app.config[<span style="font-style: italic;">"CELERY_RESULT_BACKEND"</span>], broker=app.config[<span style="font-style: italic;">"CELERY_BROKER_RUL"</span>])

    <span style="font-weight: bold; font-style: italic;">TaskBase</span> = celery.Task

    <span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ContextTask</span>(TaskBase):
        <span style="font-weight: bold; font-style: italic;">abstract</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>

        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__call__</span>(<span style="font-weight: bold;">self</span>, *args, **kwargs):
            <span style="font-weight: bold;">with</span> app.app_context():
                <span style="font-weight: bold;">return</span> TaskBase.__call__(<span style="font-weight: bold;">self</span>, *args, **kwargs)

    celery.<span style="font-weight: bold; font-style: italic;">Task</span> = ContextTask
    app.<span style="font-weight: bold; font-style: italic;">celery</span> = celery

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#20219;&#21153;</span>
    celery.task(name=<span style="font-style: italic;">"send_mail"</span>)(send_mail)
    <span style="font-weight: bold;">return</span> celery
</pre>
</div>

<p>
上面的代码定义了发送邮件的函数 send_mail, 定义了创建 celery 对象的函数 make_celery.
在 make_celery 中,我们将 send_mail 添加到了 celery 任务中.
</p>

<p>
回到 app.py 导入 make_celery 函数,创建一个 Celery 对象:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
回到 blueprints/user.py, 修改发送邮件的代码,改为用 celery 任务发送邮件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail, cache
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> current_app
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">email = request.args.get("mail")</span>
    <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-style: italic;">"wj915614874@163.com"</span>
    <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
    <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
    <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
    <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">mail.send(message)</span>
    current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
    cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">print(cache.get(email))</span>
    <span style="font-weight: bold;">return</span> cache.get(email)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "success"</span>
</pre>
</div>
<p>
接下来运行 Celery, 如果是在 Windows 下运行 Celery ,还需要第三方库 gevent:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install gevent
</pre>
</div>

<blockquote>
<p>
Celery 是需要单独运行的,它相当于一个第三方?专门用异步方式处理这些耗时的操作.
</p>
</blockquote>

<p>
打开终端运行 Celery:
</p>
<div class="org-src-container">
<pre class="src src-sh">celery -A app.celery worker -P gevent -l info
</pre>
</div>
<p>
现在,再次访问 <a href="http://127.0.0.1:5000/user/mail/captcha">http://127.0.0.1:5000/user/mail/captcha</a> 会发现响应速度快了许多,不
用等几秒钟加载了. Linux 系统不需要 "-P gevent" 参数, 关于 Celery 的详细使用还是
要参考官方文档: <a href="https://docs.celeryproject.org/en/stable/">https://docs.celeryproject.org/en/stable/</a>
</p>

<blockquote>
<p>
前面我是把 email 写死了(硬编码到代码中),但其实还有一种方法测试,就是访问
<a href="http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com">http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com</a> 这样在视图函数
里就可以通过 <code>request.args.get("mail")</code> 来获取邮箱地址了,另外,这也是后面用 AJAX
发起"发送验证码"的请求所使用的 URL. 如果是这种方式测试,就需要把硬编码的代码注销,
换成 request.args.get("mail")
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail, cache
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> current_app
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">email = "wj915614874@163.com"</span>
    <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
    <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
    <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
    <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">mail.send(message)</span>
    current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
    cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">print(cache.get(email))</span>
    <span style="font-weight: bold;">return</span> cache.get(email)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "success"</span>
</pre>
</div>

<p>
因为这种方式才是后面真正使用的方式,所以这里我就直接改过来了.该了之后就只能用
<a href="http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com">http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com</a> 这个URL 测试了.
另外,因为前面一直都是硬编码的方式,所以没注意前面的代码都没有导入 request 这个变
量,到这里报措才注意到,以后写东西的话还是尽量少用硬编码的方式测试吧.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org07048df" class="outline-4">
<h4 id="org07048df">RESTful API</h4>
<div class="outline-text-4" id="text-org07048df">
<p>
RESTful 也叫 REST(representational state transfer, 表层状态转换). 它是 Roy
Fielding 博士在 2000 年提出的一种万维网架构风格,主要作用是提供一种软件间通过
HTTP/HTTPS 协议交互数据的风格. RESTful API 有以下特点:
</p>
<ol class="org-ol">
<li>直观简短的 URL, 例如:
<ul class="org-ul">
<li>/post/list: 帖子列表.</li>
<li>/posts/111: 主键为 111 的帖子详情.</li>
<li>/post/111/comments: 主键为 111 的帖子下的所有评论.</li>
</ul></li>
<li>数据传输格式,如 JSON, XML 等. JSON 因为格式清晰,体积小,已经取代 XML 成为了大
多数互联网产品的首选格式.</li>
<li>操作资源的方法, 根据操作资源的目的,选择不同的 method. 例如获取资源,用 GET, 创
建资源用 POST, 替换资源用 PUT, 删除资源用 DELETE.</li>
<li>响应的状态码. 服务器根据情况返回对应的状态码. 2xx 表示操作成功, 3xx 表示重定
向, 4xx 表示客户端错误, 5xx 表示服务器端错误.</li>
</ol>


<p>
RESTful API 是一种风格,不是规范,也就是说我们不需要严格遵守,可以根据自己的需求调
整.
</p>

<p>
Flask 中提供了 jsonify 方法,用来返回 JSON 格式的数据.
</p>

<p>
下面我们就用 jsonify 方法封装一个用于返回 RESTful API 风格的模块.
</p>

<p>
首先,在 pythonbbs 根目录下,创建一个名为 utils 的包(文件夹), 它用来存放一些工具类
模块, 然后在 utils 包中(文件夹中)创建一个 restful.py 文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> jsonify

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">HttpCode</span>(<span style="font-weight: bold;">object</span>):
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21709;&#24212;&#27491;&#24120;</span>
    <span style="font-weight: bold; font-style: italic;">ok</span> = 200
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27809;&#26377;&#30331;&#24405;(&#31867;&#22411;&#30340;)&#38169;&#35823;</span>
    <span style="font-weight: bold; font-style: italic;">unloginerror</span> = 401
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27809;&#26377;&#26435;&#38480;(&#31867;&#22411;&#30340;)&#38169;&#35823;</span>
    <span style="font-weight: bold; font-style: italic;">permissionerror</span> = 403
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23458;&#25143;&#31471;&#21442;&#25968;&#38169;&#35823;</span>
    <span style="font-weight: bold; font-style: italic;">paramserror</span> = 400

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26381;&#21153;&#22120;&#38169;&#35823;</span>
    <span style="font-weight: bold; font-style: italic;">servererror</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">_restful_result</span>(code, message, data):
    <span style="font-weight: bold;">return</span> jsonify({<span style="font-style: italic;">"message"</span>: message <span style="font-weight: bold;">or</span> <span style="font-style: italic;">""</span>, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}}) , code

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">ok</span>(message=<span style="font-weight: bold; text-decoration: underline;">None</span>, data=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">return</span> _restful_result(code=HttpCode.ok, message=message, data=data)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">unloginerror</span>(message=<span style="font-style: italic;">"&#27809;&#26377;&#30331;&#24405;!"</span>, data=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">return</span> _restful_result(code=HttpCode.unloginerror, message=message, data=data)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">permission_error</span>(message=<span style="font-style: italic;">"&#27809;&#26377;&#35775;&#38382;&#26435;&#38480;!"</span>, data=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">return</span> _restful_result(code=HttpCode.permission_error, message=message, data=data)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">params_error</span>(message=<span style="font-style: italic;">"&#21442;&#25968;&#38169;&#35823;"</span>, data=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">return</span> _restful_result(code=HttpCode.paramserror, message=message, data=data)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">server_error</span>(message=<span style="font-style: italic;">"&#26381;&#21153;&#22120;&#24320;&#23567;&#24046;&#21862;!"</span>, data=<span style="font-weight: bold; text-decoration: underline;">None</span>):
    <span style="font-weight: bold;">return</span> _restful_result(code=HttpCode.servererror, message=message, data=data)
</pre>
</div>
<p>
上面代码中我们针对不同的状态码添加了对应的函数:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 19:</span> 状态码与对应函数说明</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-right">状态码</td>
<td class="org-left">函数</td>
<td class="org-left">说明</td>
</tr>

<tr>
<td class="org-right">200</td>
<td class="org-left">success</td>
<td class="org-left">请求成功</td>
</tr>

<tr>
<td class="org-right">401</td>
<td class="org-left">unloginerror</td>
<td class="org-left">请求需要登录的 API, 但是用户并没有登录</td>
</tr>

<tr>
<td class="org-right">403</td>
<td class="org-left">permissionerror</td>
<td class="org-left">请求需要指定权限的 API 但是用户并没有该权限</td>
</tr>

<tr>
<td class="org-right">400</td>
<td class="org-left">params_error</td>
<td class="org-left">请求 API 所提交的参数错误</td>
</tr>

<tr>
<td class="org-right">500</td>
<td class="org-left">server_error</td>
<td class="org-left">请求 API 时服务器出现错误</td>
</tr>
</tbody>
</table>

<p>
上面的所有函数,不管是什么状态码,不管是否需要给客户端返回数据,最终都调用的是
<code>_restful_result</code> 函数,这个函数里就封装了返回数据的格式,该格式类似于这样:
</p>
<pre class="example" id="orgb18554d">
{
	"message": "...",
	"data": "..."
}
</pre>
<p>
保持格式一致的好处是,客户端在任何情况下都可以获取到这两个参数,不会因为某个 API
下没有某个参数而导致代码抛出异常.
</p>

<p>
网站开发中, RESTful API 一般用于 AJAX 请求. AJAX 是使用 Javascript 语言异步发送
的请求,根据响应对页面进行局部更新.
</p>

<p>
发送邮箱验证码的请求就非常适合使用 AJAX 请求, 因为传统的表单提交方式会导致页面的
跳转.
目前我们发送邮箱验证码的 mail_captcha 函数是返回了从 redis 里读取到的保存的验证
码为内容的,如果是传统的表单方式提交,那就会和我们目前的测试一样跳转到一个返回验证
码的页面,而之前的注册页面却没有了,这就不是我们想要的了. 因为 AJAX 请求就不能说返
回一个页面了,所以我们需要修改一下 mail_captcha 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> mail, cache
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> current_app
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()
</pre>
</div>
<p>
修改后,我使用这个 URL:
<a href="http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com">http://127.0.0.1:5000/user/mail/captcha?mail=wj915614874@163.com</a> 来进行测试,可以
看到返回的结果是一个 JSON 格式的数据,用 F12 查看网络请求,也可以看到是返回 200 的
状态码.另外,由于我是直接运行的 app.py 文件,没有运行 celery, 所以实际上没有执行发
送邮件的任务,但是 BUT! celery 用了 redis 作为中间人,TASK 都发送到 redis 缓存数据
库里了,而且没有设置过期时间(吧,或许过期时间较长),当我意识到没有开启 celery 后,运
行 celery ,发现之前打开过几次测试页面生成的 celery Task 全都开始执行了,一次收到
了好几条验证邮件. 这个和我以前遇到过的注册码迟迟不发送,过了好久一次全发过来了的
情况类似.
</p>

<blockquote>
<p>
有一点需要吐槽的是,这本书在当当上面的代码排版稀烂, Python 的缩进格式本来属于语法
的一部分,结果书里的代码缩进有的用一个空格表示缩进,有的用两个空格表示缩进,不说运
行了,看都容易看错,特别是这部分两个代码块的代码, user.py 的用的是两个空格表示一个
缩进,restful.py 用的是一个空格表示一个缩进,看的我头大.
不过这里在搜索过程中也学到了一点新知识, Python 的4个空格为一个缩进是 "推荐",不是
强制, 只有 python 文件的第一行不能有缩进,因为用空格表示缩进的层次是与上一行比较
得出的,例如,如果这一行的空格数与上一行的相等,则视为这两行是同一层级的代码,需要缩
进的地方,例如if,else 等代码块的层级表示,没有缩进会报措,对于不需要缩进的地方,例如
该在同一层级执行的两条语句,如果有缩进第二条语句的空格多于第一条,会报措,如果第二
条语句的缩进少于第一条,可能不会报措,但是程序是一定会出现错误,例如一个应该在循环
里出现的 return 语句,却跑到循环外了,可能程序不会报措,但运行结果一定与预期不同.
这里说道的缩进,都只针对同一层级而言的,不同层级缩进可以不同,不会报措,但是同一个层
级的缩进一定要相同,例如:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_indent1</span>():
 <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"No Indentation Error"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">test_indent2</span>():
  <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"No Indentation Error"</span>)

test_indent1()
test_indent2()
</pre>
</div>
<p>
这段代码可以成功运行,不会抛出缩进异常,但是这样写的程序看起来很别扭不是吗,格式不
统一,一点都不美观.
emm 方便日后查找文档,附上官方文档链接: <a href="https://docs.python.org/zh-cn/3/reference/lexical_analysis.html#indentation">Python 词法分析:缩进</a>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org56c9c6d" class="outline-4">
<h4 id="org56c9c6d">CSRF 保护</h4>
<div class="outline-text-4" id="text-org56c9c6d">
<p>
只要网页是通过模板渲染的,且在交互过程中存在非 GET 请求,那就必须开启 CSRF 保护.
CSRF 保护的过程在 <a href="#org26ded82">CSRF 攻击</a> 中已经讲解过了.
</p>
<blockquote>
<p>
我原先一直以为 CSRF 是什么跨域攻击,是在学爬虫的时候,不知从哪里看的,还以为是个什
么很复杂的东西,实际上看看 CSRF 的全称就容易理解了, Cross Site Request Forgery,
跨站点请求伪造,在 A 网站的 Javascript 代码中包含一段自动向 B 网站发起请求的代码,
然后用户访问 A 网站就会自动向 B 网站发起一个请求,这个请求会自动带上用户在 B 网站
的 cookie, 如果没有其他设置,那 B 网站会认为该请求是正常请求,从而执行相应操作,这
种行为会导致 B 网站以及用户的数据/财产遭到损失. 所以除非网站是纯展示类型的,不与
用户进行数据的交互,那么就一定要开启 CSRF 保护.
</p>
</blockquote>

<p>
开启 CSRF 保护需要第三方库 flask-wtf 中的 CSRFProtect, 因为是新的环境,所以需要安
装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-wtf
</pre>
</div>

<p>
安装完毕,就可以使用 CSRFProtect 来开启 CSRF 保护了,从前面测试可以看出,只进行
CSRF 不用额外的变量,只需要使用 CSRFProtect 函数就可以了,所以不需要在 exts.py 里
新增变量,直接在 app.py 里导入该函数就可以了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;</span>
CSRFProtect(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
这样修改后,所有的非 GET 请求都必须在请求头或者请求体中加上 csrf_token,否则就会出
现状态码 400, 提示 Bad Request 的错误. 注册功能使用了表单,因此需要在
templates/front/register.html 模板的 form 标签中新增一个 <a href="#coderef-input" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-input');" onmouseout="CodeHighlightOff(this, 'coderef-input');">input 标签</a>:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
<span id="coderef-input" class="coderef-off">      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;</span>
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<blockquote>
<p>
这里要说一下的是, CSRFProtect 在每次渲染页面时都会传递 csrf_token 参数给 context
上下文,然后在页面中发起请求时需要带上这个参数,不然就会导致参数错误.
我还疑惑这个怎么就可以防御 CSRF 攻击了,仔细一想,正常来说,一般的页面没有说什么都
不干,连界面都不渲染,上来就发送请求的吧,所以一般都是先 GET 请求,获得页面,然后再通
过页面中的表单提交数据,发起其他类型的请求的,所以一般流程都是先由 GET 请求将带有
csrf_token 参数的模板页面渲染后返回给用户,然后用户才会发送一个带着 csrf_token 参
数的请求给服务器,这是正常流程,而 CSRF 没有先获取 csrf_token 的这个过程,直接就向
服务器发起请求,而这个请求必须要有 csrf_token 才会被服务器接受,所以这种不带
csrf_token 的伪造请求攻击就被防御住了.
</p>

<p>
不过这里应该涉及到一个检验发送给客户端的 csrf_token 是否与随后客户端发送过来的
csrf_token 是否一致的操作,没有看到具体是怎么实现的,啊不对,我把这个 CSRFProtect
的 csrf_token 与爬虫伪造请求的 token 搞混了,或者说我理解的爬虫的 token 不完全正
确,因为那时想要拿到 token ,发现它们的生成总是和用户已有的输入有关,就是说把用户输
入的数据按照一定算法加密生成的 token, 那它就不可能提前生成这个 token, 发送到客户
端存入 cookie, 然后进行比对,只能是在服务器端进行检验,我以为它只是反爬虫的,刚刚了
解 csrf_token 之后,我以为它原来是 csrf 防御用的,现在详细想了想,反爬虫的 token,
它是同时能够反爬虫和防御 csrf 攻击的,而我们现在用的这个 csrf_token, 它只是防御
csrf 攻击的,如果说它一定程度上反爬虫了,那只能说是无意中防御了刚学爬虫的人写的爬
虫.只要学了一段时间爬虫的都会知道有各种 token 是用来反爬的,而这个 csrf_token 完
全属于没有难度的 "反爬" 手段,值都是显式发送到客户端的,直接提取就行了.
</p>

<p>
像爬虫就是伪造的请求,逆向页面的时候就需要看它提交表单的 token 是怎么生成的,然后
用同样方法生成 token 添加到请求里,才会被服务器接受.
</p>

<p>
写到这里我又记起来确实遇到有的网站请求中有几个 token 的,当时我还疑惑过说这两
token 到底谁是反爬的,现在想想,都是哈哈,一个是防御 CSRF 攻击的,不带上不行,算是反
爬,毕竟爬虫也是 CSRF 中的 RF(request forgery), 另一个就是纯反爬的了.
</p>
</blockquote>

<p>
添加完后,点击 "立即注册" 也就是 submit 提交按钮,就会自动把 csrf_token 对应的值提
交给视图函数.
</p>
</div>
</div>

<div id="outline-container-org44e0a92" class="outline-4">
<h4 id="org44e0a92">使用 AJAX 获取邮箱验证码</h4>
<div class="outline-text-4" id="text-org44e0a92">
<p>
AJAX 技术就是异步请求,异步发送请求可以在不刷新页面的情况下发送请求.
</p>

<p>
作者使用 jQuery 提供的 $.ajax 方法实现AJAX 请求的发送. 因为上一小节我们为项目启
动了 CSRF 保护,所以异步请求需要在请求体或者请求头中添加 csrf_token.
为了方便,我们可以先在父模板 base.html 的 head 标签中添加 <a href="#coderef-base_meta_csrf_token" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-base_meta_csrf_token');" onmouseout="CodeHighlightOff(this, 'coderef-base_meta_csrf_token');">头信息</a> :
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
<span id="coderef-base_meta_csrf_token" class="coderef-off">  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;</span>
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
前面我们从作者提供的资料中复制了 static 文件夹到项目下,在 static/common 文件夹中
有一个 zlajax.js 文件,该文件对 $.ajax 做了一层封装,在非 GET 请求之前,先从模板的
meta 标签中读取 csrf-token 的值,然后将值设置到请求头中,这样就不需要每次发送非
GET 请求时都手动设置 csrf_token 了:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-style: italic;">'use strict'</span>;

<span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">zlajax</span> = {
  <span style="font-style: italic;">'get'</span>: <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">args</span>) {
    args[<span style="font-style: italic;">'method'</span>] = <span style="font-style: italic;">"get"</span>
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">this</span>.ajax(args);
  },
  <span style="font-style: italic;">'post'</span>: <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">args</span>) {
    args[<span style="font-style: italic;">'method'</span>] = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">this</span>.ajax(args);
  },
  <span style="font-style: italic;">'put'</span>: <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">args</span>){
    args[<span style="font-style: italic;">'method'</span>] = <span style="font-style: italic;">"put"</span>
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">this</span>.ajax(args)
  },
  <span style="font-style: italic;">'delete'</span>: <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">args</span>){
    args[<span style="font-style: italic;">'method'</span>] = <span style="font-style: italic;">'delete'</span>
    <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">this</span>.ajax(args)
  },
  <span style="font-style: italic;">'ajax'</span>: <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">args</span>) {
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;csrftoken</span>
    <span style="font-weight: bold; text-decoration: underline;">this</span>._ajaxSetup();
    <span style="font-weight: bold;">return</span> $.ajax(args);
  },
  <span style="font-style: italic;">'_ajaxSetup'</span>: <span style="font-weight: bold;">function</span> () {
    $.ajaxSetup({
      <span style="font-style: italic;">'beforeSend'</span>: <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">xhr</span>, <span style="font-weight: bold; font-style: italic;">settings</span>) {
        <span style="font-weight: bold;">if</span> (!<span style="font-style: italic;">/^(GET|HEAD|OPTIONS|TRACE)$/</span>i.test(settings.type) &amp;&amp; !<span style="font-weight: bold; text-decoration: underline;">this</span>.crossDomain) {
          <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">csrftoken</span> = $(<span style="font-style: italic;">'meta[name=csrf-token]'</span>).attr(<span style="font-style: italic;">'content'</span>);
          xhr.setRequestHeader(<span style="font-style: italic;">"X-CSRFToken"</span>, csrftoken)
        }
      }
    });
  }
};
</pre>
</div>

<blockquote>
<p>
这段 js 代码我只能看(猜)懂它做了哪些事情,有什么作用,具体是什么对象啊,什么类型数
据的我都搞不清除, JS 还是需要去认真学一下的.
</p>
</blockquote>

<p>
由于许多页面都会用到 AJAX, 所以可以把 zlajax 文件放到 front/base.html 父模板的
<a href="#coderef-base_head_zlajax" class="coderef" onmouseover="CodeHighlightOn(this, 'coderef-base_head_zlajax');" onmouseout="CodeHighlightOff(this, 'coderef-base_head_zlajax');">head</a> 标签中,这样所有子模板都能使用这个文件了:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
<span id="coderef-base_head_zlajax" class="coderef-off">  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;</span>

  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;

  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>
<p>
注意,由于 zlajax.js 依赖 jQuery, 所以必须把 zlajax.js 文件的引入放在 jQuery 文件
的后面.
</p>

<p>
现在,我们就可以使用改装后的 ajax 方法 zlajax 来绑定事件发送请求了.
首先,在 static/front/js 文件夹下面创建一个 register.js 文件,用来绑定 "发送验证码
" 的按钮的单击事件,并执行 AJAX 请求:
</p>
<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span>() {
    $(<span style="font-style: italic;">'#captcha-btn'</span>).on(<span style="font-style: italic;">"click"</span>,
                         <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">event</span>){
                             event.preventDefault();
                             <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#37038;&#31665;</span>
                             <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">email</span> = $(<span style="font-style: italic;">"input[name='email']"</span>).val();
                             zlajax.get({
                                 url: <span style="font-style: italic;">"/user/mail/captcha?mail="</span> + email
                             }).done(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">result</span>)
                                     {alert(<span style="font-style: italic;">"&#39564;&#35777;&#30721;&#21457;&#36865;&#25104;&#21151;!"</span>);
                                     }).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                                         alert(error.message);
                                     })
                         });
});
</pre>
</div>
<p>
这段代码里, id 为 captcha-btn 的按钮绑定了单击事件.单击该按钮后,先获取用户输入的
邮箱数据,然后通过 zlajax.get 方法发送请求, URL 不需要带域名,向以 "/" 开头的 URL
发送请求,浏览器会自动使用当前的域名.
如果请求成功,会执行 done 里的函数,如果请求失败,会执行 fail 里的函数.这里的done
和 fail 都用 alert 返回执行结果.
</p>

<p>
js 文件必须要加载到模板中才能生效,所以需要修改 register.html 模板,
在 register.html 的 head 标签中加载 register.js (就是 head 块里加载):
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/register.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
<span id="coderef-input" class="coderef-off">      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;</span>
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
       &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/register.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
       &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
现在,打开注册页面 <a href="http://127.0.0.1:5000/user/register">http://127.0.0.1:5000/user/register</a> 点击发送验证码的按钮,就可
以在不刷新页面的情况下向服务器发送获取验证码的请求了(mail_captcha 视图函数).
</p>
<blockquote>
<p>
这里遇到一个问题,就是 org 的文字示例里 <code>(:ref linkname)</code> 的语法跟 js 以及 html
语法不兼容,上面我用了几个文字示例里的标签,结果 tangle 时也带上了,导致代码执行出
错,只能再复制一份没有标签的代码进行 tangle.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgb914b68" class="outline-4">
<h4 id="orgb914b68"><span class="todo TODO">TODO</span> 实现注册功能</h4>
<div class="outline-text-4" id="text-orgb914b68">
<p>
邮箱验证码可以正常发送后,就可以完善注册功能了.
</p>

<p>
首先,在模板文件 register.html 中,最初的版本 form 标签里是没有设置 action 和
method 属性的,现在要添加上:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/register.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('user.register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
       &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
action 属性的作用是指定在点击提交按钮时,将数据发送到哪个 URL, 这里是提交到
user.register 视图函数中. method 方法则用来表示使用什么 HTTP 方法发送数据,表单数
据的发送通常都采用 POST 方法.
</p>

<p>
表单数据提交到视图函数后,需要先对表单数据进行验证,因为整个网站肯定不止一个提交表
单的地方,所以需要验证的地方也不止一个,我们将这些代码都放在一个 forms 包(文件夹)
中,在 pythonbbs 根目录下建立一个 forms 的包(文件夹),然后在 forms 包中创建一个
user.py 文件,用来处理表单数据的验证,前面 <a href="#org7231ebd">表单验证</a> 部分有验证的详细内容.这里创建
的 forms/user.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, EqualTo, Length
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> cache
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(Form):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">captcha</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=4,<span style="font-weight: bold;">max</span>=4,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#39564;&#35777;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[EqualTo(<span style="font-style: italic;">"password"</span>, message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;!"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validat_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
        <span style="font-weight: bold;">if</span> user:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#37038;&#31665;&#24050;&#23384;&#22312;"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_captcha</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">captcha</span> = field.data
        <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-weight: bold;">self</span>.email.data
        <span style="font-weight: bold; font-style: italic;">cache_captcha</span> = cache.get(email)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cache_captcha <span style="font-weight: bold;">or</span> captcha != cache_captcha:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#39564;&#35777;&#30721;&#38169;&#35823;!"</span>)
</pre>
</div>

<blockquote>
<p>
正如前面我的笔记一样,验证邮箱是需要安装额外的 email_validator 包的,这里作者终于
提到了,这个 pythonbbs 项目的前面已经安装过 flask-wtf 了, 所以现在只需要安装
email_validator:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install email_validator
</pre>
</div>
</blockquote>

<p>
这个 forms/user.py 文件创建了一个 RegisterForm 表单类,定义了 email, captcha,
username, password 和 confirm_password 5个字段,并且都分别指定了验证器,其中 email
和 captcha 还额外指定了自定义的验证器, 用来判断邮箱是否已经注册过了,或者验证码是
否正确.
</p>

<p>
由于每个表单验证我们都要获取验证失败后的错误信息,并把错误信息传递到模板,前面我们
是通过遍历表单对象 form 的属性 : <code>form.errors.values()</code> 来获取错误信息的,对于多
个表单的验证,这种循环遍历的写法就冗余了,此时我们可以把遍历错误值的操作抽象成一个
方法或属性,放在父类中,然后所有表单类都继承这个父类,这样就不用每个表单类都写一个
循环遍历错误消息的代码了, 我们在 forms 包下新建一个 baseform.py 文件:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseForm</span>(Form):
    @<span style="font-weight: bold;">property</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">messages</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">message_list</span> = []
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">self</span>.errors:
            <span style="font-weight: bold;">for</span> errors <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">self</span>.errors.values():
                message_list.extend(errors)
        <span style="font-weight: bold;">return</span> message_list
</pre>
</div>
<p>
然后将 forms/user.py 中的 RegisterForm 类改为继承这个 BaseForm 类:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError
<span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, EqualTo, Length
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> cache
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">email_captcha</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=4,<span style="font-weight: bold;">max</span>=4,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#39564;&#35777;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[EqualTo(<span style="font-style: italic;">"password"</span>, message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;!"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validat_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
        <span style="font-weight: bold;">if</span> user:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#37038;&#31665;&#24050;&#23384;&#22312;"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_captcha</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">captcha</span> = field.data
        <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-weight: bold;">self</span>.email.data
        <span style="font-weight: bold; font-style: italic;">cache_captcha</span> = cache.get(email)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cache_captcha <span style="font-weight: bold;">or</span> captcha != cache_captcha:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#39564;&#35777;&#30721;&#38169;&#35823;!"</span>)
</pre>
</div>

<p>
这样以后可以直接通过 form.messages 获取所有字符串类型的错误信息了. 这些错误信息
可以返回给用户,让用户知道哪里输入错误了.
</p>

<blockquote>
<p>
这里和我遇到过的有些注册页面就不一样了,这里只能一次返回所有错误信息,很多网站也是
这样,一次返回所有信息,将错误信息用显眼文本显示在页面中,但是有的网站可以针对性的
将错误信息显示在出错的输入框元素后面,这样的功能我们这个 messages 属性就做不到,因
为它返回的 message_list 里全是 errors 的键值,而没有 errors 的键名,所以是做不到一
一对应的.
当然了, 也可能我看到的那种它是用前端实现的,例如 Javascript 肯定可以有对应的验证
数据并给出对应提示的功能代码的实现.
</p>
</blockquote>

<p>
然后我们还需要把 RegisterForm 表单类导入 blueprints/user.py 完善 register 视图函
数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Login Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()
</pre>
</div>
<p>
上面代码中, register 视图函数同时支持 GET 和 POST 两种 method 的请求. 在视图函数
中,通过判断 request.method 来执行对应的操作. 如果是 GET 请求,就返回模板, 如果是
POST 请求,就构建 RegisterForm 表单,验证表单,如果验证成功,则创建 UserModel 对象,
并保存到数据库中,跳转到登录界面,如果验证失败,则重定向到注册页面,并把表单的错误信
息添加到 flash 中.
</p>

<p>
因为验证失败时,视图函数会把错误消息添加到 flash 中,所以模板可以通过
get_flashed_messages 获取所有的错误消息, 在 templates/fromt/register.html 的
"立即注册" 按钮上方添加一个显示错误信息的代码:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30693;&#20102;&#35838;&#22530;&#27880;&#20876;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/register.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#27880;&#20876;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('user.register') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"register-form"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"input-group-append"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"captcha-btn"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-secondary"</span>&gt;&#21457;&#36865;&#39564;&#35777;&#30721;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email_captcha"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;&#39564;&#35777;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#29992;&#25143;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
       &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"confirm_password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#30830;&#35748;&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span>&gt;
          {% for message in messages %}
          &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
          {% endfor%}
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% endif %}
      {% endwith %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#36820;&#22238;&#30331;&#38470;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
修改完成,访问 <a href="http://127.0.0.1:5000/user/register">http://127.0.0.1:5000/user/register</a> 按照规则输入数据,即可完成注册.
如果数据格式输入错误,邮箱已存在或验证码错误等,都会在页面中显示出错误信息.
</p>

<blockquote>
<p>
这里也有大坑, 作者前面讲解表单类的时候还说过模板中标签的 name 值要与表单类的属性
名一致,结果他给出的代码中, 模板里输入邮箱验证码的 input 元素的 name 值为
<code>email_captcha</code>, 而它书里贴出的代码图片竟然是 <code>captcha</code>, 看他书里那一段还说可以
"在 templates/front 文件夹下看到这样一个register.html 文件", 但它贴的图片和提供
的文件根本不一样,真是笑死,运行时其他都没问题,就是验证码,输入对与错都会报措,最后
通过调试才发现表单类的 captcha 属性根本没有获取到值,这才定位到问题在这块相关的代
码里,看了 py 文件,发现没问题,看了模板文件,才发现那个 input 元素的 name 值不对.
</p>

<p>
开始没意识到问题是因为模板文件我是直接用 :read 命令从作者提供的文件中读取的,不是
自己手打的,也没怀疑说模板文件还有问题,我意识到是验证码相关的代码出了问题之后都没
有怀疑是模板文件的问题,还在自己的代码里查找了半天,倒是发现了一个无关的拼写错误,
之所以无关,是因为过不了验证程序就运行不到我那个拼写错误的地方去,直到开启调式,发
现其他元素的值都获取的正常,而只有验证码没有获取到值,为 None ,而此前我又检察过视
图函数相关的代码都没问题,这才意识到可能是模板那里有问题的.
</p>

<p>
这个 debug 的过程还是很有必要的,嗯,可以看作这是作者的隐藏教学内容吧,不大不小的一
个 bug 但是分析错误的过程还是很有趣的(解决了 bug 的情况下).
</p>
</blockquote>

<blockquote>
<p>
还有一点要提一下的是,cache.set() 函数中, timeout 参数的单位是秒,设置为 100 时就
是过期时间为 100s, 因为这一片都断网了,流量又慢,所以我设置为了常见的 5 分钟(300s).
设置为 100s, 一般人都是按照顺序填写,点击的,作者提供的模板布局里,获取验证码是最前
面的,我每次都想先获取验证码,然后填写其他信息,这样很容易一分钟就过去了,验证码就过
期了,所以在查找上面那个错误的时候我第一时间是认为时间太长,导致验证码过期导致的,
换成一次性填写完再获取验证码,还是同样的验证码错误,所以又将过期时间设置为 5 分钟,
仍然错误,才排除了过期时间这一个可能导致 bug 的可能性.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org440a569" class="outline-3">
<h3 id="org440a569">登录</h3>
<div class="outline-text-3" id="text-org440a569">
<p>
登录的流程: 用户在登录界面输入邮箱和密码, 提交到视图函数中, 视图函数验证密码是否
正确, 正确,则把能够识别用户的数据添加到 cookie 中,返回给浏览器. 浏览器下次访问本
网站的其他页面时,会自动携带 cookie, 我们就可以知道请求是哪一个用户发出的了. 前面
我们在 blueprints/user.py 中定义了一个很简单的 login 视图函数,只是为了测试注册成
功跳转的页面用的,这里我们就要来真正实现登录这个视图函数. login 视图函数和
register 一样,都支持 GET 和 POST 方法, GET 请求会返回登录模板,我们先实现 GET 请
求的响应:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()
</pre>
</div>

<p>
现在,访问 <a href="http://127.0.0.1:5000/user/login">http://127.0.0.1:5000/user/login</a> 就可以看到输入邮箱和密码的登录页面了.
这个页面的模板文件我们还没有修改过,因此它还没有设置好 csrf_token, 我们在 form 标
签下给它新增一个 input 标签,以及渲染表单验证错误信息的标签,另外还要补充完整
action 属性的值:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#30331;&#24405;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/sign.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"page-title"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30331;&#24405;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sign-box"</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">" {{ url_for('user.login') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;

      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;

      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"password"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#23494;&#30721;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"checkbox"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"checkbox"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"remember"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span>&gt;&#35760;&#20303;&#25105;
        &lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
        {% if messages %}
            &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
              &lt;<span style="font-weight: bold;">ul</span>&gt;
                {% for message in messages%}
                &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
                {% endfor%}
              &lt;/<span style="font-weight: bold;">ul</span>&gt;
            &lt;/<span style="font-weight: bold;">div</span>&gt;
        {% endif %}
      {% endwith %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#31435;&#21363;&#30331;&#24405;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"signup-link"</span>&gt;&#27809;&#26377;&#36134;&#21495;&#65311;&#31435;&#21363;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"resetpwd-link"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span>&gt;&#25214;&#22238;&#23494;&#30721;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后在 forms/user.py 文件中,添加登录表单对应的表单类 LoginForm:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError, BooleanField
<span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, EqualTo, Length
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> cache
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">email_captcha</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=4,<span style="font-weight: bold;">max</span>=4,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#39564;&#35777;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[EqualTo(<span style="font-style: italic;">"password"</span>, message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;!"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validat_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
        <span style="font-weight: bold;">if</span> user:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#37038;&#31665;&#24050;&#23384;&#22312;"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_captcha</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">captcha</span> = field.data
        <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-weight: bold;">self</span>.email.data
        <span style="font-weight: bold; font-style: italic;">cache_captcha</span> = cache.get(email)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cache_captcha <span style="font-weight: bold;">or</span> captcha != cache_captcha:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#39564;&#35777;&#30721;&#38169;&#35823;!"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LoginForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField( validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">remember</span> = BooleanField()
</pre>
</div>

<p>
和实现注册一样,现在回到 login 视图函数中,完成 POST 请求的响应:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()
</pre>
</div>
<p>
新增的代码中,我们先判断邮箱是否存在,然后判断密码是否正确.如果两个条件都满足,就认
为登录成功了,然后把 user.id 储存在 session 中,因为 Flask 里的 session 默认是加密
后储存在 cookie 里的,这就意味着 user.id 会被加密后存放到 cookie 并返回给浏览器.
</p>

<p>
登录页面有一个"记住我"的复选框, 如果用户勾选了,则让 cookie 过期时间延长(默认是浏
览器关闭时, cookie 自动过期),设置 <code>session.permanent=True</code>, 可以将过期时间延长为
默认的 30 天,如果想要自定义过期时间,可以在配置中设置参数
PERMANENT_SESSION_LIFETIME, 这个参数为 timedalta 类型. 例如,设置 7 天过期,则可以
在 config.py 的 Base_config 中添加:
<code>PERMANENT_SESSION_LIFETIME=timedelta(days=7)</code>
timedelta 是 datetime 库中的函数,如果要使用,记得导入它.
</p>

<p>
如果登录成功,就跳转到首页 "/", 为了测试登录成功的效果,我们还需要在
blueprints/front.py 中添加一个 index 视图函数,简单返回 Index Page 文本:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>
</pre>
</div>

<blockquote>
<p>
这里补充下前面关于蓝图文件  cms.py ,front.py, user.py 的思考, 这些蓝图对应的是整
个网站的三个模块, 与用户相关的都在 user.py 里, 与后台管理相关的都在 cms.py ,
front.py 则是前台页面,这里的首页就是属于前台页面,所以我们用 redirect("/") 来重定
向到前台页面.
</p>

<p>
一般的网站首页基本都是根目录,也就是 "<i>" 代表的路径,所以这里直接使用 "</i>", 而不是
用前面提到的 url_for 来表示路径也是可以的,但也有网站首页就不是使用的 "/" 根目录,
所以我觉得还是用 url_for 靠普点, emm 使用 url_for 也有懒的原因,毕竟它一个可以替
代其他所有指代路径的方法.
</p>

<p>
有点小问题就是 url_for 的用法到目前我们已经见过来两种,在同一个蓝图中,直接用视图
函数的函数名就可以指代对应 url ,不同的蓝图中,要用 blueprint_name.view_name 的形
式来指代该 url, 其他的用法暂时没瞧见,有空去查看下文档.
</p>
</blockquote>

<p>
现在,浏览器中访问 <a href="http://127.0.0.1:5000/user/login">http://127.0.0.1:5000/user/login</a> 输入邮箱密码, 成功后会跳转到
首页,看到 "Index Page" 的文本.
</p>
</div>
</div>

<div id="outline-container-org09da87d" class="outline-3">
<h3 id="org09da87d">发布帖子</h3>
<div class="outline-text-3" id="text-org09da87d">
<p>
发布帖子的模块与注册有些类似,都是收集用户输入的数据并发送到服务器存储. 与注册不
同的是,发布帖子需要选择帖子所属的板块,帖子内容是富文本内容.
</p>
</div>

<div id="outline-container-orgc3d81a6" class="outline-4">
<h4 id="orgc3d81a6">添加帖子相关模型</h4>
<div class="outline-text-4" id="text-orgc3d81a6">
<p>
帖子数据是保存在数据库中的,所以我们要先创建对应的 ORM 模型, 与帖子相关的数据有板
块,帖子和评论,这就像是百度贴吧,百度贴吧是一个网站,其中有许多 "吧" 对应这个论坛项
目的板块, 每个吧都有许多帖子,对应我们项目的帖子,每个帖子对应有评论,我们这里也有
评论.
</p>

<p>
所以发帖读帖的帖子相关功能的实现就需要板块,帖子,评论这三个模型.
</p>

<p>
在 models 包(文件夹)下新建一个 post.py 文件,用来保存帖子相关的 ORM 模型的代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<blockquote>
<p>
我这里终于知道为何作者前面推荐使用 back_populates ,为了直观和方便团队协作,但后面
用的都是 backref 自动双向绑定关系了, back_populates 需要手动绑定,如果说一个项目
开始的时候数据库就已经设计好了,或者数据库表的关系很简洁,手动绑定很容易就完成了,
前者是可以一次性完成数据库模型相关的代码,后者纯粹因为代码量少, 但如果是边设计边
开发,或是数据表的关系多而复杂时,手动绑定关系就会向我一样每个对应的模型文件都要去
写绑定的代码这里才三个表,就需要在每个表关系涉及的表模型中新增相应绑定关系的代码,
手动绑定会觉得很繁琐,但如果换成自动双向绑定,就只需要编辑新增的这个 post.py 文件
就可以了, 作者也是属于能省点事就省点事的类型.
</p>

<p>
不过我还是把 backref 都改为 back_populates 了,为了统一格式和方便查看. 虽然费点事,但
代码看起来确实清晰多了, 能在 user.py 模型文件里看到与 post.py 文件中模型的关系,
例如 comments, 这样很直观明了,使用 backref 则只有到 post.py 里才能看到对应的关系.
下面是修改后的 user.py
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> enum <span style="font-weight: bold;">import</span> Enum
<span style="font-weight: bold;">from</span> shortuuid <span style="font-weight: bold;">import</span> uuid
<span style="font-weight: bold;">from</span> werkzeug.security <span style="font-weight: bold;">import</span> generate_password_hash, check_password_hash

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionEnum</span>(Enum):
    <span style="font-weight: bold; font-style: italic;">BOARD</span> = <span style="font-style: italic;">"&#26495;&#22359;"</span>
    <span style="font-weight: bold; font-style: italic;">POST</span>  = <span style="font-style: italic;">"&#24086;&#23376;"</span>
    <span style="font-weight: bold; font-style: italic;">COMMENT</span> = <span style="font-style: italic;">"&#35780;&#35770;"</span>
    <span style="font-weight: bold; font-style: italic;">FRONT_USER</span> = <span style="font-style: italic;">"&#21069;&#21488;&#29992;&#25143;"</span>
    <span style="font-weight: bold; font-style: italic;">CMS_USER</span>  = <span style="font-style: italic;">"&#21518;&#21488;&#29992;&#25143;"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"permission"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.Enum(PermissionEnum), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">roles</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>,back_populates=<span style="font-style: italic;">"permissions"</span>)



    <span style="font-weight: bold; font-style: italic;">role_permission_table</span> = db.Table(
        <span style="font-style: italic;">"role_permission_table"</span>,
        db.Column(<span style="font-style: italic;">"role_id"</span>,db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>)),
        db.Column(<span style="font-style: italic;">"permission_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"permission.id"</span>))
)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RoleModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"role"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">desc</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">permissions</span> = db.relationship(<span style="font-style: italic;">"PermissionModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>, back_populates=<span style="font-style: italic;">"roles"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"role"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.String(100), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, default=uuid)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">_password</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">email</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">avatar</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">signature</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">join_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Foreign Key</span>
    <span style="font-weight: bold; font-style: italic;">role_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>))


    <span style="font-weight: bold; font-style: italic;">role</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, back_populates=<span style="font-style: italic;">"users"</span>)
    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"author"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"author"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, *args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">"password"</span> <span style="font-weight: bold;">in</span> kwargs:
            <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">password</span> = kwargs.get(<span style="font-style: italic;">"password"</span>)
            kwargs.pop(<span style="font-style: italic;">"password"</span>)

        <span style="font-weight: bold;">super</span>(UserModel, <span style="font-weight: bold;">self</span>).__init__(*args, **kwargs)

    @<span style="font-weight: bold;">property</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>._password

    <span style="font-weight: bold; text-decoration: underline;">@password.setter</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">_password</span> = generate_password_hash(raw_password)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">check_password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold; font-style: italic;">result</span> = check_password_hash(<span style="font-weight: bold;">self</span>.password, raw_password)
        <span style="font-weight: bold;">return</span> result

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">has_permission</span>(<span style="font-weight: bold;">self</span>, permission):
        <span style="font-weight: bold;">return</span> permission <span style="font-weight: bold;">in</span> [permission.name <span style="font-weight: bold;">for</span> permission <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">self</span>.role.permissions]
</pre>
</div>
</blockquote>


<p>
模型代码创建完毕后,需要将其导入 app.py (直接或间接), 在 blueprints/front.py 中导
入上述模型:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>
</pre>
</div>

<blockquote>
<p>
其实到这里之前我都对前台,后台,用户这三个模块还是没有清楚的认知,现在,我觉得,用户
模块,是我们经常使用的个人中心/我的** 这种功能所在的模块,是用户管理和查看自己信息
的模块,我一直认为发帖是用户在发,所以发帖应该属于用户模块,这样的想法应该是属于高
耦合了,因为发帖是所有正常用户都可以发的,包括管理员和普通用户,是一个共有的功能,应
该要独立出来做,而不是和其他功能一起做,所以 front 前台这个模块,应该才是所有这些用
户共有的功能所在的模块. 所以发帖功能是放在 blueprints/front.py 中,同样的还有管理
帖子的功能,也应该放在 front.py 中,这里的管理不止是普通用户管理自己的帖子,还有管
理员用户管理他人的帖子它们都属于帖子的管理这一个功能,只是由于权限的不同而表现不
同,当然,这是我猜想的,对不对的就看后续开发过程吧.
</p>
</blockquote>

<p>
导入完成后,就可以使用 flask-migrate 将模型映射到数据库了:
生成迁移脚本
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db migrate -m <span style="font-style: italic;">"add post, comment, board model"</span>
</pre>
</div>

<p>
执行迁移脚本:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db upgrade
</pre>
</div>

<p>
使用 mysql 命令行查看数据库表:
</p>
<pre class="example" id="orgeb89aff">
mysql&gt; use pythonbbs;
Database changed
mysql&gt; show tables;
+-----------------------+
| Tables_in_pythonbbs   |
+-----------------------+
| alembic_version       |
| board                 |
| comment               |
| permission            |
| post                  |
| role                  |
| role_permission_table |
| user                  |
+-----------------------+
8 rows in set (0.00 sec)
</pre>
<p>
可以看到新增的 3 个表都添加成功了.
</p>
</div>
</div>

<div id="outline-container-org08d7ea0" class="outline-4">
<h4 id="org08d7ea0">初始化板块数据</h4>
<div class="outline-text-4" id="text-org08d7ea0">
<p>
和添加初始角色权限等一样,在网站运行前,需要添加初始板块数据,并且板块数据一旦确定
了也不会轻易改变.
</p>

<p>
在 pythonbbs/commands.py 中添加初始化板块的命令函数 create_board :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum, UserModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_user</span>():
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">zhangsan</span> = UserModel(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,
                         email=<span style="font-style: italic;">"zhangsan@123.com"</span>,
                         password=<span style="font-style: italic;">"111111"</span>,
                         is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                         role=admin_role)


    <span style="font-weight: bold; font-style: italic;">operator_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">lisi</span> = UserModel(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,
                     email=<span style="font-style: italic;">"lisi@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=operator_role)

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">wangwu</span> = UserModel(username=<span style="font-style: italic;">"&#29579;&#20116;"</span>,
                     email=<span style="font-style: italic;">"wangwu@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)

    db.session.add_all([zhangsan,lisi,wangwu])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--username"</span>, <span style="font-style: italic;">"-u"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--email"</span>, <span style="font-style: italic;">"-e"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--password"</span>, <span style="font-style: italic;">"-p"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_admin</span>(username, email, password):
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">admin_user</span> = UserModel(username=username,email=email,password=password, is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>, role=admin_role)
    db.session.add(admin_user)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#31649;&#29702;&#21592;&#21019;&#24314;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_board</span>():
    <span style="font-weight: bold; font-style: italic;">board_names</span> = [<span style="font-style: italic;">"Python&#35821;&#27861;"</span>, <span style="font-style: italic;">"web&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#25968;&#25454;&#20998;&#26512;"</span>, <span style="font-style: italic;">"&#27979;&#35797;&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#36816;&#32500;&#24320;&#21457;"</span>]
    <span style="font-weight: bold;">for</span> board_name <span style="font-weight: bold;">in</span> board_names:
        <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel(name=board_name)
        db.session.add(board)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26495;&#22359;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>

<p>
再在 app.py 文件中将函数添加到命令中:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;</span>
CSRFProtect(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
打开终端,执行命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-board
</pre>
</div>

<p>
即可完成板块数据的初始化.
查看数据表 board:
</p>
<pre class="example" id="orgb67fdcc">
mysql&gt; select * from board;
+----+--------------+---------------------+-------------+
| id | name         | create_time         | is_active |
+----+--------------+---------------------+-------------+
|  1 | Python语法   | 2023-05-15 23:54:24 |           1 |
|  2 | web开发      | 2023-05-15 23:54:24 |           1 |
|  3 | 数据分析     | 2023-05-15 23:54:24 |           1 |
|  4 | 测试开发     | 2023-05-15 23:54:24 |           1 |
|  5 | 运维开发     | 2023-05-15 23:54:24 |           1 |
+----+--------------+---------------------+-------------+
5 rows in set (0.00 sec)

mysql&gt;
</pre>
<p>
也可以看到初始板块数据添加成功
</p>
</div>
</div>

<div id="outline-container-org94a3dac" class="outline-4">
<h4 id="org94a3dac">渲染发布帖子模板</h4>
<div class="outline-text-4" id="text-org94a3dac">
<p>
发布帖子功能,需要输入的数据有帖子的标题,发布在哪一个板块,以及帖子的内容,先看看作
者提供的帖子发布页面的模板文件 front/public_post.html:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
可以看到,模板中就一个 form 表单,表单中有三个 div ,一个提交数据的按钮, 标题的 div
只有一个输入框,用来输入帖子标题, 板块的 div 是一个 select 标签,需要提供给它数据
才能实现选择板块的功能, 内容只是一个简单的 div ,如何输入内容还没确定.
</p>

<p>
作者将发布帖子的代码放在 blueprints/post.py 里了,其实如果按照我的理解,我就会把它
放在 front.py 蓝图里了,因为它应该是属于所有人都可以的操作,但还是先跟着作者的来,
创建 blueprints/post.py 文件,先渲染该页面(GET 方法的响应):
不对,这里应该又是作者的大坑,他给的代码里并没有 blueprints/post.py 这个文件,而且
我看了下后面的代码, 这里渲染帖子发布的模板的视图函数确实是放在
blueprints/front.py 里了,所以我理解的应该没错,这里是作者自己的笔误或者脑子糊涂了
才写的"在 blueprints/post.py 中添加 public_post 视图函数",所以还是在
blueprints/front.py 中添加 public_post 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>
</pre>
</div>
<p>
此时访问 <a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> , 可以看到只有输入标题的文本框是正常
的,板块的选择框没有数据,不能选择,内容的输入框也没有输入的地方(因为我们就没写输入
的HTML代码), 先一个一个解决, 首先,选择板块,是需要从板块表中读取数据,然后将数据发
送到模板,才能进行选择的, select 标签的用法我是不了解的,不过跟着作者写嘛, 先在服
务器端,就是我们的 front.py 里,将板块的数据读取出来,然后发送到模板中:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>
</pre>
</div>
<p>
上面修改的 front.py 代码里只是添加了一个 boards 变量,并传递给了 public_post.html
模板.此时板块的选择框还是不能用的,因为前面代码显示了 public_post.html 模板文件中
的 select 标签并没有实现功能,所以我们要实现它,将 boards 参数的值渲染到模板中:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
现在学会了,在 select 标签中添加 option 标签,提交时会将选择的 option 标签的 value
值传递给表单. 修改完成后,再次访问 <a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> 可以发现选择
板块的选择框可以正常使用了,可选的板块真是我们前面加入到 board 表中的那几个板块.
</p>

<p>
下面就剩下帖子内容的 div 实现了,作者后面是介绍使用富文本编辑器来进行帖子内容的编
写,这里我自己先用一个 textarea 测试一下,对了,还要加上 csrf_token:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后在视图函数中设置 POST 请求的响应,来看看表单提交了哪些数据:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
       <span style="font-weight: bold;">return</span> request.form
</pre>
</div>
<p>
这个测试只是简单的返回了收到的 POST 类型 request 请求中的 form 表单,结果是页面收
到一个 JSON 类型的响应数据:
</p>
<pre class="example" id="org0c7216d">
{
  "board_id": "1",
  "content": "asdfasdfasdfasdf",
  "csrf_token": "IjEzMTJjYzc2MjgyNWUyOGMwMTY0Y2I0MWEwMDhhNDJmYjgzZWQxN2Mi.ZGL2ng.zYomxZMYuG51W0Y7TsyK_pTCQJo",
  "title": "123"
}
</pre>
<p>
这其实说明我们的帖子发布功能已经初步实现了.
</p>

<p>
好了,现在我自己的测试做完了, csrf_token 也添加了,除了 csrf_token 的代码可以保留,
剩下的都删除,跟着作者来将富文本编辑器作为内容输入的地方,替换掉那个简陋的
textarea 标签.
</p>
</div>
</div>

<div id="outline-container-org0a10f78" class="outline-4">
<h4 id="org0a10f78">使用 wangEditor 富文本编辑器</h4>
<div class="outline-text-4" id="text-org0a10f78">
<p>
内容部分的输入框,应该具有类似 Word 软件的功能,例如可以设置字体颜色,大小,插入图片
等,且要所见即所得,就是编辑时是什么效果,发布后显示在网页中就是什么效果,这种类型的
编辑器就叫富文本编辑器. 目前互联网上有多种富文本编辑器,其实我用来记笔记的 org 不
也是属于 emacs 的一种富文本编辑器嘛,而且它还超出富文本编辑器许多(功能上).百度有
UEditor, 国外的 CKEditor, 这应该都是 Web 开发或者说是网页端的富文本编辑器吧,毕竟
用得少,不是很了解,不过像博客园,csdn 等这些技术博客或是 github 这种交友网站,它们
的评论以及内容发布都是使用的富文本编辑器,作者推荐这个项目里使用的是国内以王福朋
为首的前端团队开发的 wangEditor, 作者认为在多款富文本编辑器中,它简单易用,功能稳
定,而且有详细的中文文档.
</p>

<blockquote>
<p>
wangEditor 的官方文档: <a href="https://www.wangeditor.com/doc/">https://www.wangeditor.com/doc/</a> .网络仍没修复,暂时不去验
证该地址是否有效.
</p>
</blockquote>
<p>
使用 wangEditor 有4步, 第一步在模板中引入 wangEditor.js 文件, 第二步添加生成编辑
器的占位标签,第三步初始化编辑器,第四步设置图片上传 URL.
</p>
</div>

<ul class="org-ul">
<li><a id="orgbb180e7"></a>引入 wangEditor.js 文件<br />
<div class="outline-text-5" id="text-orgbb180e7">
<p>
打开 templates/front/public_post.html 模板文件,实现 head 这个 block, 引入
wangEditor.js 文件
</p>

<blockquote>
<p>
不得不提这本书错误还是有不少的,这里书中写的是打开 templates/front/public.js 文件.
都 js 文件了,还实现 head block, 真是无语. 写书的时候会写错,但写代码的时候不容易
错的,因为大多数人都是用的 IDE ,直接用鼠标在文件树中打开文件的,我用 org 就不这样
了,一直都是直接操作文件路径,名字不对文件就不对了,这里就差点被带偏了.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cnd.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
这一步的修改只是完成了 head block 加载了 jsdelivr 服务器提供的 cdn 服务上的
wangEditor.min.js 脚本, 如果想要用自己的服务器加载,或是本地测试,可以把
wangEditor.min.js 下载存放到自己的服务器或本地加载即可. 加载本地 js 文件应该也是
给出 src 属性的路径值就可以了.
</p>
</div>
</li>

<li><a id="org9847648"></a>添加生成编辑器的占位标签<br />
<div class="outline-text-5" id="text-org9847648">
<p>
在需要生成 wangEditor 的地方添加一个占位符,一般用 div 就可以了, 为了方便后期定位,给
div 添加一个 id 属性:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cnd.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
这里只新增了一个 id 为 editor 的 div 标签.用于编辑器的占位.
</p>
</div>
</li>

<li><a id="orge25273b"></a>初始化编辑器<br />
<div class="outline-text-5" id="text-orge25273b">
<p>
接着就可以将上面用来占位的 div 标签初始化为真正的编辑器了, 这里需要使用到
JavaScript 代码,现在才是编辑 public_post.js 的时候, 在 static/front/js 下创建一
个 public_post.js 文件:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">editor</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">window.wangEditor</span>(<span style="font-style: italic;">"#editor"</span>);
    editor.create();
});
</pre>
</div>
<p>
这段js 代码很短很简单(才不是,淦,js 没系统学,只能看懂意思), 创建一个对象, 这个对
象是用 wangEditor 函数生成的,函数内传递的参数就是我们上面用来占位的标签的 id 值,
然后调用这个对象的 create() 方法,也就是将这个标签初始化为了编辑器.
</p>

<p>
不过 js 文件不引入到模板文件中是不能生效的,所以我们还需要完善 public_post.html
模板的 head block:
</p>


<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.jsdelivr.net/npm/wangeditor@latest/dist/wangEditor.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/public_post.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
这段代码的修改也很简单,只是在引入 wangEditor.min.js 后又引入了新建的
public_post.js 文件.
</p>

<blockquote>
<p>
刚刚我还在想说 HTML 引入 js 的几种形式我也忘了,现在又发现,使用 url_for 来指定本
地的文件不是很方便? 原生 html 代码引入 js 的方式我还记不清路径是相对还是绝对,如
果是相对,是相对当前路径还是项目路径? 当然,我猜应该是相对路径,而且是相对当前文件
的所在目录的路径.使用 url_for 就简单了,一律是相对项目根目录的路径.
</p>
</blockquote>

<p>
js 文件引入后再次访问  <a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> 应该就可以看到出现一个
比 textarea 好多了的文本编辑器了.
</p>

<p>
因为要测试,所以还是用流量联网了,结果发现作者提供的 wangEditor.min.js 的 cdn 服务
打不开,也不想深究原因了,直接在 wangEditor 官网找到了最新的通过 CDN 安装的地址:
<a href="https://unpkg.com/@wangeditor/editor@latest/dist/index.js">https://unpkg.com/@wangeditor/editor@latest/dist/index.js</a> 把它下载下来命名为
wangeditor.js 文件,放在 static/front/js 文件夹下,代码太长,我就不直接贴在这个文档
里了. 另外也是为了省点流量,所以换成加载本地 js 文件,所以模板文件
public_post.html 的 head 也要修改:
</p>

<blockquote>
<p>
在官网找到的文件原来是 v5 版本的 wangEditor 了,作者用的是 v4 版本的,所以作者的代
码适用的是 v4, 另外找到 cdn 服务打不开的原因了,上面的 url 我手打时打成了 cnd
&#x2026; 所以还是用回作者的版本,不过照样还是下载到本地了
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}
  &#21457;&#24067;&#24086;&#23376;
{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/wangEditor.min.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='front/js/public_post.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#21457;&#24067;&#24086;&#23376;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"mb-4"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"title"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">select</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"board_id"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span>&gt;
        {% for board in boards %}
        &lt;<span style="font-weight: bold;">option</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">option</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">select</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">label</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">label</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-btn"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>


<p>
好了,现在再访问 <a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> ,就可以看到一个可以调节文字大
小,颜色,行高,缩进,下划线等多种功能的文本编辑框了.确实比 textarea 好多了.
</p>

<p>
有点小问题,就是点击 "发布帖子" 后 request.form 并不会收到富文本编辑器的内容,看了
下 wangEditor v4 的文本,内容是需要通过 javascript 代码获取的,不能直接通过 form
标签的提交按钮提交. 内容的提交会在后面讲解的应该.
</p>
</div>
</li>

<li><a id="orga3188bf"></a>设置图片上传 URL<br />
<div class="outline-text-5" id="text-orga3188bf">
<p>
v4 版本的 wangEditor 可以上传图片,这一步不设置也不影响 wangEditor 的使用. 但我们
还是要加上图片上传的功能.
</p>

<p>
首先,在 blueprints/front.py 中添加一个处理上传图片的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
       <span style="font-weight: bold;">return</span> request.form



<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"media.media_file"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })
</pre>
</div>
<p>
新增的代码中,通过视图函数 upload_image 的 request.files 获取 image 参数来获取图
片,这需要前端在上传图片时使用 image 作为参数名. 通过文件名后缀来判断是否为图片,
如果不是就返回 400 错误.这里没有用 resultful 模块中的函数返回 JSON 数据,是因为
wangEditor 使用的返回结果格式为:
</p>
<pre class="example" id="orge21cc11">
{
    "errno": 0,
    "data": [{
	"url": url,
	"alt": "",
	"href": ""
    }]
}
</pre>
<p>
参数说明:
</p>
<ul class="org-ul">
<li>errno : 0 表示正常, 非0 表示异常</li>
<li>data: 图片上传后的信息数组,图片信息包括 URL, 提示信息 alt 以及跳转链接 herf.</li>
</ul>


<p>
为了防止黑客利用图片的文件名攻击服务器,使用 werkzeug.utils.secure_filename 产生
了一个安全的文件名来保存图片,并把文件储存在配置项 UPLOAD_IMAGE_PATH 指定的路径下,这
个配置项需要在 config.py 中设置好.
</p>

<p>
图片保存完成后,再使用 url_for 对 media.media_file 进行反转,用来获取图片的
URL. media.media_file 是新增的用于返回上传的文件的蓝图, 一般为了后期的方便,上传
的文件会切换到 Nginx 服务器上部署.
</p>
<blockquote>
<p>
这里我的理解是一般这些图片,用户头像等的文件是放到一个单独的文件服务器的,这里作者
说的切换到 Nginx 服务器上部署就是这个意思,
</p>
</blockquote>
<p>
下面创建一个 URL (以 /media 开头的蓝图),在开发阶段使用这个蓝图返回图片文件,
blueprints/media.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, current_app
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"media"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/media"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">media_file</span>(filename):
    <span style="font-weight: bold;">return</span> os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename)
</pre>
</div>
<p>
然后在 app.py 中注册蓝图:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprint.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;</span>
CSRFProtect(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
图片上传的视图函数写完后,就可以用 js 代码设置图片上传了,
static/front/js/public_post.js:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">editor</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">window.wangEditor</span>(<span style="font-style: italic;">"#editor"</span>);
    editor.config.uploadImgServer = <span style="font-style: italic;">"/upload/image"</span>;
    editor.config.uploadFileName=<span style="font-style: italic;">"image"</span>;
    editor.create();
});
</pre>
</div>

<p>
重新加载发布帖子页面,单击图片按钮,可以看到上传图片的功能会被添加.
</p>
<blockquote>
<p>
作者给出的效果图和我的不一样,也不知是哪里代码有错还是作者写书时用的 wangEditor
和我现在用的 v4 版本不一样导致的, 作者开发到这里也说了暂时还不能使用图片上传功能
,毕竟都还没用 js 发送请求呢,所以也不能测试是否出错,只有后续继续开发才能测试.
</p>
</blockquote>

<p>
现在还不能使用上传图片,因为 wangEditor 要求使用 POST 上传图片,我们的 pythonbbs
对非 GET 请求做了 CSRF 防御,必须要提交 csrf_token 才能保证安全. 对此可以针对
upload_image 视图函数关闭 CSRF 防御.
</p>

<blockquote>
<p>
前面我就好奇,说第三方插件都在 exts.py 里,但是开启 CSRF 防御只是在 app.py 里直接
使用了,这里就应验了,还是要改到 exts.py 里的, 作者这种完全带着开发的实践内容确实
不错,对于新手可以体会到为什么一个项目需要分模块,为什么开发者们都选择某种代码组织
方式. 之前也看过项目时间的书,好多都是直接就告诉你约定是怎样怎样,就像是网上找的那
些培训结构的教学一样,直接告诉代码怎么组织,但不会讲解原因.
</p>
</blockquote>

<p>
修改 exts.py :
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Mail
<span style="font-weight: bold;">from</span> flask_caching <span style="font-weight: bold;">import</span> Cache
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect

<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy()

<span style="font-weight: bold; font-style: italic;">mail</span> = Mail()

<span style="font-weight: bold; font-style: italic;">cache</span> = Cache()

<span style="font-weight: bold; font-style: italic;">csrf</span> = CSRFProtect()
</pre>
</div>
<p>
新增了一个 csrf 变量
然后到 app.py 中初始化该变量:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
这次修改注释了原来的 CSRFProtect(app) 代码,改为了 csrf.init_app(app).这样修改还
是前面说过的避免循环导入,因为 blueprints/front.py 文件中也需要导入 csrf, 来让
upload_image 视图函数不开启 csrf 保护:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
       <span style="font-weight: bold;">return</span> request.form



<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"media.media_file"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })
</pre>
</div>
<p>
这次修改从 exts.py 中导入了 csrf ,然后在 upload_image 视图函数上新增了一个
@csrf.exempt 装饰器,这样就关闭了 upload_image 视图函数的 CSRF 防御,然后在
wangEditor 中重新上传图片,应该就可以正常使用上传图片功能了.
</p>

<blockquote>
<p>
emm 这里测试了,发现前面和作者示例图不一样的原因是 public_post.js 代码里
uploadImgServer 写成了 uploadImageServer, 所以才不一样的,修改后就可以看到和作者
的效果一样了,但是上传图片又出错了, 浏览器控制台显示访问 upload_image 视图函数返
回的是 500 , 项目运行的终端显示的错误信息是
</p>
<pre class="example" id="org030905a">
  File "C:\Users\kamisama\flask_web_py3_10\pythonbbs\blueprints\front.py", line 35, in upload_image
    f.save(os.path.join(current_app.config.get("UPLOAD_IMAGE_PATH"), filename))
  File "E:\Python38\lib\ntpath.py", line 78, in join
    path = os.fspath(path)
TypeError: expected str, bytes or os.PathLike object, not NoneType
</pre>
<p>
然后才意识到,我还没有配置 UPLOAD_IMAGE_PATH 选项,所以报措传递了一个 NoneType 的
路径,下面就配置一下该路径.
</p>
</blockquote>
<p>
老规矩,一个不导出,一个导出,因为只是测试用一下,我直接设置为了 pythonbbs 的根目录
为上传路径:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32531;&#23384;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_TYPE</span> = <span style="font-style: italic;">"RedisCache"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_HOST</span> = <span style="font-style: italic;">"127.0.0.1"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_PORT</span> = 6379

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Celery &#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26684;&#24335; redis://:password@hostname:port/db_number</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_BROKER_RUL</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_RESULT_BACKEND</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23384;&#20648;&#19978;&#20256;&#22270;&#29255;&#30340;&#36335;&#24452;</span>
    <span style="font-weight: bold; font-style: italic;">UPLOAD_IMAGE_PATH</span> =  r<span style="font-style: italic;">"C:\Users\kamisama\flask_web_py3_10\pythonbbs"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
ok 再次测试上传图片,点击图标,选中本地一张图片上传,但还是报措,不过这次错误不一样
了,浏览器控制台报措下载图片错误,而不是前面的 500 了,这意味着图片是上传成功了,但
用来显示图片的 url 访问失败了,查看项目运行的终端,发现所有请求都是 200 ,就是所有
请求都成功了,去到项目根目录,发现上传的图片已经传递到了项目根目录了,这说明图片确
实上传成功了,只不过用来显示图片的功能出错了,所以才会显示上传错误.
</p>

<p>
经过排查,以及比对作者提供的资料和书中的代码,发现提交图片成功的 post 请求返回的数
据是 :
</p>
<pre class="example" id="org5c11fc8">
url = url_for("media.media_file", filename=filename)
return jsonify(
    {
        "errno": 0,
        "data": [{
            "url": url,
            "alt": "",
            "href": ""
        }]
    })
</pre>
<p>
url 是 url_for 反转来的,看看 media.media_file 代码:
</p>
<pre class="example" id="org21d8827">
@bp.get("/&lt;path:filename&gt;")
def media_file(filename):
    return os.path.join(current_app.config.get("UPLOAD_IMAGE_PATH"), filename)
</pre>
<p>
可以得知最终 url 的值应该是 "/media/file" 形式的,也就是说返回的 url 是
"/media/a.jpg" 这种,这个 url 最终是要在前端模板中显示图片的,但是 "/media/a.jpg"
视图返回的是一个图片在计算机中的路径地址,而不是这个图片本身,所以才会导致报措下载
图片错误的,照我记忆中的知识, img 标签的 src 属性应该是图片的资源定位符,而这里的
src 变成了返回该图片资源定位符的一个资源定位符,所以导致错误.
</p>

<p>
回过头看 <a href="#orga3188bf">设置图片上传 URL</a> 开头的代码解释,作者说 "media.media_file 是用于返回上传
的文件的蓝图" 这部分描述就是错的,它返回的是文件在计算机中的路径,而不是返回该文件,这
里可能有点绕,不过要搞清楚,访问一个图片的 URL, 服务器返回的是该图片文件,才能让
img 标签成为页面中的一张图片,而如果这个 url 返回的是图片的路径,就不能成为图片了,
一个是文件数据(图像文件),一个是字符数据(文件路径).
</p>

<p>
作者没有进一步解释,只说 media.media_file 是开发期间用于返回文件的蓝图,其实也说的
通,毕竟他很熟悉了,不像我们要测试和理解才能明白意思,这个视图函数的返回结果就表示
上传功能实现成功了,所以没有进一步解释.
</p>

<p>
但我还是通过阅读作者提供的代码把正常的情况补全了.
首先, media.media_file 真的只是用来测试下的,它返回的路径并没有什么用,所以上传成
功返回的 url 数据用不到它.需要新建一个视图函数,用来返回上传的图片文件,还是在
front.py 蓝图中修改:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
       <span style="font-weight: bold;">return</span> request.form



<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>
<p>
新增了一个响应 /image/filename 的响应 get 类型的视图函数,返回
"UPLOAD_IMAGE_PATH" 目录下的 filename 这个文件, 并将 upload_image 视图函数返回的
url 数据修改为新增视图函数对应的路由(URL).
</p>

<p>
ok, 再次尝试上传图片,不会报措,而且会在 wangEditor 中显示图片. 这样才算是作者说的
"上传图片功能已经可以正常使用了"
</p>

<blockquote>
<p>
我都怀疑是不是作者这段的部分内容没有写完,对于给出的代码,很明显是有一个从
media_file 变成 uploaded_image 的过程的,但书里没有给出相应内容,我在书里后面内容
搜索也没搜索到,就当是作者 "故意" 给出的"练习" 吧.
</p>

<p>
喜欢写代码读代码其中一个原因就是这种看代码可以了解另外一个人的乐趣,有的大神的代
码就算看不懂他的编程思路,组织代码的方式,也能看出代码的"优雅",而这种可以看懂的代
码,就像是算命一样,通过代码可以推测出作者的某些想法和思路,像是一种不需沟通的的思
想碰撞.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-orgf4b87a6" class="outline-4">
<h4 id="orgf4b87a6">未登录限制</h4>
<div class="outline-text-4" id="text-orgf4b87a6">
<p>
现在发布帖子的页面不需要登录就可以访问,这样是不可以的,用户没有登录的情况下访问,
应该要重定向到登录界面.
</p>

<p>
用户访问网站后,为了方便获取当前用户的信息,需要添加 before_request 钩子函数.
</p>
<blockquote>
<p>
钩子函数就是一类由某种事件,程序运行的某个时刻触发的函数,一般用来在某个事件发生前
或发生后执行一系列操作,这个概念我是学习 Emacs 的时候才有较清晰的了解的,此前都是
一个很模糊的概念.
</p>

<p>
这个 before_request 顾名思义,就是在请求发送或是处理请求之前执行的函数,具体是哪种
还得看后面的具体实现.
</p>
</blockquote>
<p>
在项目根目录下新建 hooks.py 文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> session, g
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bbs_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-style: italic;">"user_id"</span> <span style="font-weight: bold;">in</span> session:
        <span style="font-weight: bold; font-style: italic;">user_id</span> = session.get(<span style="font-style: italic;">"user_id"</span>)
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
            <span style="font-weight: bold;">setattr</span>(g, <span style="font-style: italic;">"user"</span>, user)
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span>:
            <span style="font-weight: bold;">pass</span>
</pre>
</div>
<p>
这个函数会从 session 中获取 "user_id" , 然后在数据库中查询是否有该用户,如果有,则
将该用户的数据设置到全局变量 g 中.
</p>

<p>
然后在 app.py 中将该钩子函数添加进去:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)


<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
这样,用户在登录的情况下访问网站,会在全局对象 g 上添加一个 user 属性,后面通过
g.user 就可以获取当前登录的用户信息,如果 g 没有 user 属性,就说明用户没有登录.
</p>

<p>
我们可以把登录限制的函数做成装饰器,这样可以直接添加到需要登录才能访问的视图函数
中.
</p>

<p>
在根目录创建一个 decorators.py 文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> functools <span style="font-weight: bold;">import</span> wraps
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> redirect, url_for, g

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login_required</span>(func):
    <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inner</span>(*args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>):
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> func(*args, **kwargs)

    <span style="font-weight: bold;">return</span> inner
</pre>
</div>
<p>
这段代码添加了一个 login_required 装饰器函数,它接受一个函数为参数,通过全局对象 g
有无 user 属性,来判断用户是否登录,如果没有则重定向到登录页面,否则就正常执行被装
饰的函数.
</p>

<p>
然后在 blueprints/front.py 中的 public_post 和 upload_image 视图函数上添加
login_required 装饰器:
</p>
<blockquote>
<p>
作者这里又把 front.py 写成了 post.py, 无语.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
       <span style="font-weight: bold;">return</span> request.form



<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
这里要注意装饰器的添加是有顺序的,在有多个装饰器的情况下,装饰器的执行是从里到外的,需
要充分考虑请求到达服务器的执行过程,来分配装饰器的位置.
</p>
<blockquote>
<p>
一篇讲解装饰器的文章: <a href="https://www.programiz.com/python-programming/decorator">python decorator</a> ,从基础到高级用法的讲解.条理清晰.
</p>
</blockquote>

<p>
我们添加的 login_required 装饰器是在最里层的,所以会最先检察是否登录才会执行其他
装饰器.
</p>

<blockquote>
<p>
这个最里层的可能有点不好理解,把装饰器等价的正常写法写出来就容易理解了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@deco1</span>
<span style="font-weight: bold; text-decoration: underline;">@deco2</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">printer</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"func printer"</span>)
</pre>
</div>
<p>
上面的装饰器等价于 <code>printer = deco1(deco2(printer))</code>, 这样就容易理解了.就是函数
的嵌套调用(参数都是函数对象).
</p>
</blockquote>

<p>
现在,在用户未登录的情况下重新访问发布帖子的页面,会被重定向到登录页面.
</p>

<blockquote>
<p>
由于之前进行过登录的测试,然后并没有退出浏览器,所以实际上修改代码后刷新发布帖子的
页面不会跳转到登录页面,因为 cookie 里已经有 session 信息了.所以需要退出浏览器或
者是打开隐私标签(隐私模式不会发送已有的 cookie.) 再访问
<a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> 就会跳转了.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org984c6cd" class="outline-4">
<h4 id="org984c6cd">服务端实现发帖功能</h4>
<div class="outline-text-4" id="text-org984c6cd">
<p>
blueprints/front.py 中的 public_post 视图函数中, GET 返回模板, POST 发布帖子,前
面我为了测试将 POST 请求的响应设置成了 request.form. 但现在就可以来实现帖子发布
了.
</p>

<p>
帖子发布需要接受表单数据,所以要先创建对应表单类,先在 forms 文件夹下创建一个
post.py:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> InputRequired, Length

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PublicPostForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">title</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=100, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#26631;&#39064;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">content</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#20869;&#23481;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">board_id</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#26495;&#22359;!"</span>)])
</pre>
</div>
<p>
post.py 中添加了 PublicPostForm 类,定义了 title,content,board_id 三个字段.
</p>

<blockquote>
<p>
要注意一下的是 content 字段由于我们内容是在 wangEditor 里编辑的,所以不像我测试时
使用 textarea 保存内容,可以直接用 content, 这里的 content 在 public_post.html 模
板中是找不到的,需要根据 wangEditor 的文档获得内容的文本.
</p>
</blockquote>

<p>
然后需要把 PublicPostForm 导入到 blueprints/front.py 中,并完成数据的保存:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"Index Page"</span>

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>
<p>
上面代码中直接使用 g.user 获取用户信息,是因为前面已经用 before_request 钩子函数
将 user 绑定到了 g 对象,所以可以直接访问 g.user. 并且在初始化 PostModel 时赋值给
了 author 关系属性.
</p>

<p>
现在虽然实现了响应发布帖子页面提交发布的 POST 请求的代码,但不能使用,因为我们是无
法获取 content 字段的值的(应该,如果 wangEditor 使用 content 作为内容部分的标签的
name 值那还恰好可以获取,但大概率不是的).
</p>

<p>
现在的帖子内容是通过 wangEditor 编辑的,只有通过 wangEditor 提供的 Javascript 接
口才能获取用户输入的内容,所以发布帖子的请求需要用 AJAX 实现.
</p>

<blockquote>
<p>
上面这段话是下一个小节的内容,但应该放在这里的,这可以解释为什么这里修改的代码中发
布成功的代码返回的是 restful.ok(), 而不是其他内容.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgebd4a29" class="outline-4">
<h4 id="orgebd4a29">使用 AJAX 发布帖子</h4>
<div class="outline-text-4" id="text-orgebd4a29">
<p>
现在的帖子内容是通过 wangEditor 编辑的,只有通过 wangEditor 提供的 Javascript 接
口才能获取用户输入的内容,所以发布帖子的请求需要用 AJAX 实现.
</p>

<p>
wangEditor 通过 editor.txt.html() 方法获取内容, 所以在
static/front/js/public_post.js 脚本文件中添加代码:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">editor</span> = <span style="font-weight: bold;">new</span> <span style="font-weight: bold; text-decoration: underline;">window.wangEditor</span>(<span style="font-style: italic;">"#editor"</span>);
    editor.config.uploadImgServer = <span style="font-style: italic;">"/upload/image"</span>;
    editor.config.uploadFileName=<span style="font-style: italic;">"image"</span>;
    editor.create();

    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25552;&#20132;&#25353;&#38062;&#30340;&#21333;&#20987;&#20107;&#20214;</span>
    $(<span style="font-style: italic;">"#submit-btn"</span>).click(<span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();

        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">title</span> = $(<span style="font-style: italic;">"input[name='title']"</span>).val();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">board_id</span> = $(<span style="font-style: italic;">"select[name='board_id']"</span>).val();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">content</span> = editor.txt.html();

        zlajax.post({
            url: <span style="font-style: italic;">"/post/public"</span>,
            data: {title, board_id, content}
        }).done(<span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">data</span>){
            setTimeout(<span style="font-weight: bold;">function</span>(){
                window.location = <span style="font-style: italic;">"/"</span>;
            }, 2000);
        }).fail(<span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">error</span>){
            alert(error.message);
        });
    });
 });
</pre>
</div>
<p>
这段代码里绑定了提交按钮的单击事件,然后从 HTML 标签中获取用户输入的 title,
board_id 以及 content 数据,载运 zlajax.post 方法把数据发送到服务器,请求成功则跳
转到首页,失败则弹出错误信息的对话框.
</p>

<p>
现在,点击发送帖子的按钮可以成功发送数据了, <a href="http://127.0.0.1:5000/post/public">http://127.0.0.1:5000/post/public</a> .
</p>

<blockquote>
<p>
最好还是退出浏览器后再访问进行测试,或者打开开发者工具,在"存储"-&gt; "cookie" 中删除
浏览器存储的 cookie 然后再刷新页面,重新登录,再测试帖子发布的功能.
</p>

<p>
另外,作者有些代码不会给出导入响应模块或变量的代码,只给出使用的代码,不过一般前面
都有过使用的示例,只要跟着做过来,报措了也很容易找到是因为没有导入,如果使用 IDE 这
种情况会好点,因为 IDE 会提示某个变量/模块没有导入.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org307ef04" class="outline-3">
<h3 id="org307ef04">首页</h3>
<div class="outline-text-3" id="text-org307ef04">
<p>
首页目前还是返回一个简单的 "Index Page", 所以现在我们要实现返回正常首页的视图函
数了:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>
<p>
这里我们只简单的渲染了 front/index.html 模板文件,访问 <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 可以
看到一个奇怪的首页页面,说奇怪是因为页面左侧是帖子列表,但是只显示了一个钢铁是怎样
炼成的的帖子,而且点击并没有反应,右侧板块列表也什么都没有,这里应该显示所有类型的
板块数据的. 这两个区域是都需要从数据库中提取数据并传递给模板文件的, 板块数据前面
再发布帖子功能的实现时已经实现过了,帖子列表的数据可以用同样方法实现:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>
<p>
将数据传递到模板文件了,下面就需要在模板中遍历这些数据生成对应标签,先看看最初的
index.html 文件:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
可以看出我们目前的首页中的数据都是写死的,所以我们需要从传递的参数中读取数据,另外,这
种模板文件应该就是后端经常处理的模板文件了,只会有一个数据的示例代码表示后续的数
据应该按照怎样的标签组织起来.
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% for post in posts %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: {{ post.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;: {{ post.comments|length}}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      {% if current_board %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% else %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endif %}
      {% for board in boards %}
        {% if board.id == current_board %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% else %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif %}
      {% endfor %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
修改后的代码先循环帖子列表,然后把帖子的标题,作者,发表事件以及帖子评论的数量都显
示出来了.
在板块列表中,通过 current_board 参数表示当前选中的是哪一个板块,该参数后续在实现
根据板块过滤帖子的功能时会加进去.
</p>
</div>

<div id="outline-container-orgde2540a" class="outline-4">
<h4 id="orgde2540a">生成帖子测试数据</h4>
<div class="outline-text-4" id="text-orgde2540a">
<p>
在帖子超过一定数量时应该分页,但现在数据库中数据太少,手动生成太繁琐,所以还是使用
程序来生成测试数据.
</p>

<p>
Faker 库是一个用来生成随机数据的库,可以生成姓名,邮箱,地址以及段落等内容.
</p>

<div class="org-src-container">
<pre class="src src-sh">pip install faker
</pre>
</div>

<p>
生成测试数据的代码也应该写成命令,所以在 commands.py 中增加代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum, UserModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> faker <span style="font-weight: bold;">import</span> Faker
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_post</span>():
    <span style="font-weight: bold; font-style: italic;">fake</span> = Faker(locale=<span style="font-style: italic;">"zh_CN"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = UserModel.query.first()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    click.echo(<span style="font-style: italic;">"&#24320;&#22987;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;..."</span>)
    <span style="font-weight: bold;">for</span> x <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(98):
        <span style="font-weight: bold; font-style: italic;">title</span> = fake.sentence()
        <span style="font-weight: bold; font-style: italic;">content</span> = fake.paragraph(nb_sentences=10)
        <span style="font-weight: bold; font-style: italic;">random_index</span> = random.randint(0, 4)
        <span style="font-weight: bold; font-style: italic;">board</span> = boards[random_index]
        <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title, content=content, board=board, author=author)

        db.session.add(post)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#24086;&#23376;&#29983;&#25104;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_user</span>():
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">zhangsan</span> = UserModel(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,
                         email=<span style="font-style: italic;">"zhangsan@123.com"</span>,
                         password=<span style="font-style: italic;">"111111"</span>,
                         is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                         role=admin_role)


    <span style="font-weight: bold; font-style: italic;">operator_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">lisi</span> = UserModel(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,
                     email=<span style="font-style: italic;">"lisi@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=operator_role)

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">wangwu</span> = UserModel(username=<span style="font-style: italic;">"&#29579;&#20116;"</span>,
                     email=<span style="font-style: italic;">"wangwu@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)

    db.session.add_all([zhangsan,lisi,wangwu])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--username"</span>, <span style="font-style: italic;">"-u"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--email"</span>, <span style="font-style: italic;">"-e"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--password"</span>, <span style="font-style: italic;">"-p"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_admin</span>(username, email, password):
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">admin_user</span> = UserModel(username=username,email=email,password=password, is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>, role=admin_role)
    db.session.add(admin_user)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#31649;&#29702;&#21592;&#21019;&#24314;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_board</span>():
    <span style="font-weight: bold; font-style: italic;">board_names</span> = [<span style="font-style: italic;">"Python&#35821;&#27861;"</span>, <span style="font-style: italic;">"web&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#25968;&#25454;&#20998;&#26512;"</span>, <span style="font-style: italic;">"&#27979;&#35797;&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#36816;&#32500;&#24320;&#21457;"</span>]
    <span style="font-weight: bold;">for</span> board_name <span style="font-weight: bold;">in</span> board_names:
        <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel(name=board_name)
        db.session.add(board)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26495;&#22359;&#28155;&#21152;&#25104;&#21151;!"</span>)
</pre>
</div>

<p>
然后在 app.py 中注册该命令
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)


<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后执行命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-test-post
</pre>
</div>

<p>
完成后再次访问网站首页,就可以看到帖子列表中生成了许多帖子,虽然帖子标题可能就是胡
言乱语.不过我们也会发现这些内容很长,会导致整个页面也变得很长,另外还有一个原因就
是,如果数据一次展示太多,对网络的要求也会更高,可能会导致页面响应时间增加,就会让用
户有种这个网站很卡的感觉. 针对我们这里帖子太多的情况,解决方法就是下一部分要讲解
的分页操作.
</p>

<blockquote>
<p>
这里先记录以下通过开发者工具得出的每个请求的响应文件大小和响应时间,几个kb 大小的
响应都在 10 毫秒左右,三十 kb 大小的响应在 100 毫秒以内, 而我们现在的首页是传输了
40 kb 左右的数据,响应在 100 毫秒以上,取决于电脑的运行状态和网络情况,最慢的甚至到
了 400 毫秒左右.
</p>

<p>
记录这个是想看看后面实现分页了之后, 比如一页只显示 10 条帖子数据,是不是会提高响
应速度(减少响应时间).
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org963083e" class="outline-4">
<h4 id="org963083e">使用 Flask-Paginate 实现分页</h4>
<div class="outline-text-4" id="text-org963083e">
<p>
Flask 项目中使用 Flask-Paginate 插件可以轻松实现分页, Flask-Paginate 用的是
Bootstrap 样式,正好这个 pythonbbs 前面也是使用的 Bootstrap 样式,如果要使用其他样
式,可以修改 CSS 属性.
</p>

<p>
这也是一个第三方插件,需要额外安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-paginate
</pre>
</div>

<p>
安装完毕,在 BaseConfig 中添加 PER_PAGE_COUNT 配置,来指定一页中展示多少数据:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold; font-style: italic;">PER_PAGE_COUNT</span> = 10


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32531;&#23384;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_TYPE</span> = <span style="font-style: italic;">"RedisCache"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_HOST</span> = <span style="font-style: italic;">"127.0.0.1"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_PORT</span> = 6379

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Celery &#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26684;&#24335; redis://:password@hostname:port/db_number</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_BROKER_RUL</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_RESULT_BACKEND</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23384;&#20648;&#19978;&#20256;&#22270;&#29255;&#30340;&#36335;&#24452;</span>
    <span style="font-weight: bold; font-style: italic;">UPLOAD_IMAGE_PATH</span> =  r<span style="font-style: italic;">"C:\Users\kamisama\flask_web_py3_10\pythonbbs"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
然后在 blueprints/front.py 的 index 视图函数中,按照当前页码提取对应的数据:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
新增的代码中,先从请求URL 参数中获取 page ,然后计算当前 page 下提取帖子的起始位置
和结束位置. 接着按照帖子的发布时间排序, 统计总共有多少帖子,然后使用 start 和 end
提取帖子列表,最后构建 Pagination 对象, Pagination 的参数:
</p>
<ul class="org-ul">
<li>bs_version: Bootstrap 版本,项目里使用的是 4,这里就要设置为 4.</li>
<li>page: 当前的 page 页码,从 1开始.</li>
<li>total: 当前帖子的总数量.</li>
<li>outer_window: 页码数量太多,出现省略号后,在省略号外层要显示多少个页码,这里设置
为0 就会显示为 1 个页码,总比设置的多一个.</li>
<li>inner_window: 出现省略号后,在当前页面的左右两边显示几个页码.</li>
<li>alignment: 分页盒子在父盒子内的对齐方式,默认是左对齐,这里设置为居中对齐.</li>
</ul>


<p>
最后需要修改以下首页的模板文件,让分页生效:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% for post in posts %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: {{ post.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;: {{ post.comments|length}}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
      {{ pagination.links }}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      {% if current_board %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% else %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endif %}
      {% for board in boards %}
        {% if board.id == current_board %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% else %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif %}
      {% endfor %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
这里只有一个很简单的修改,就是在帖子列表的最底部加上了一个
<code>{{ pagination.links }}</code>. 这个用法可以在 flask-paginate 的 <a href="https://flask-paginate.readthedocs.io/en/master/">文档</a> 中找到.
</p>

<p>
现在,在浏览器重新访问首页,就可以看到分页的效果了.
</p>

<p>
这一次重新查看响应时间,可以发现首页请求的响应时间普遍在 100 毫秒上下,响应的文件
大小也只有不到 10 KB, 所以分页很明显是提高了网页响应速度的.
</p>

<blockquote>
<p>
这里我又注意到,每一次点击分页的按钮,页面都是重新刷新的,而实际上在我们平常浏览的
网站里,点击分页操作是不会刷新页面的,而是刷新页面的内容部分,并且只要是重新刷新页
面,都会存在一个加载静态文件(js, css 文件)的过程,尽管它们一般都是从缓存里加载,但
数量多时也是会耗费时间的,这就让我记起来以前学过的异步请求,虽然没学明白,但有个大
概印象,记得那时是第一次学php, 然后又被迫学了js, 记得是可以通过发送异步请求,然后
用 JS 代码改变 HTML 的内容,就可以避免刷新页面,因为它是直接操作已有的文档内容(没
记错的话代表 HTML 页面结构和内容的概念叫做 DOM 树). 如果要实现的话得从 JS 那边开
始讲解, 模板文件和 js 文件就需要修改了,所以还是暂时放过,免得重点又跑偏了.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org299fdf4" class="outline-4">
<h4 id="org299fdf4">过滤帖子</h4>
<div class="outline-text-4" id="text-org299fdf4">
<p>
前面我们实现了所有板块下的帖子分页,现在我们要实现按照特定板块过滤帖子的功能,这样
就能专门查看某一个板块下的帖子了. 帖子的过滤仍然在 index 视图函数中实现,只不过需
要接收一个代表板块类型的参数,然后将它用于板块过滤.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
现在,我们利用一个 baord_id 参数,在服务器端实现了帖子过滤的功能,但是如果点击过前
面的首页中的帖子或板块的话,会发现它是可点击的,但点击后访问的是
"127.0.0.1:5000/#" 或是 "127.0.0.1:5000/",并没有跳转到其他页面,这是因为这些超链
接标签还没有真正实现,现在,我们就修改 index.html 模板文件来实现它(模板详情功能还
没开始,所以只修改板块过滤部分):
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% for post in posts %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: {{ post.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;: {{ post.comments|length}}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
      {{ pagination.links }}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      {% if current_board %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% else %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endif %}
      {% for board in boards %}
        {% if board.id == current_board %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% else %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id ) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif %}
      {% endfor %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
现在,点击右侧的某个板块,就可以根据板块过滤帖子,只显示该板块下的帖子了.
</p>
</div>
</div>
</div>

<div id="outline-container-org686c917" class="outline-3">
<h3 id="org686c917">帖子详情</h3>
<div class="outline-text-3" id="text-org686c917">
<p>
上一小节我们实现了首页的帖子分页,过滤功能,首页的内容部分就只有帖子详情没有实现了,因
此点击左侧的某个帖子,只会访问 "127.0.0.1:5000/#" 而不会有任何效果. 这一小节就来
实现点击某个帖子,加载它的详情数据.
</p>
</div>

<div id="outline-container-org47b505b" class="outline-4">
<h4 id="org47b505b">动态加载帖子详情数据</h4>
<div class="outline-text-4" id="text-org47b505b">
<p>
先在服务器端实现返回帖子详情数据的视图函数
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)
</pre>
</div>
<p>
这里新增了一个 post_detail 视图函数,它从 URL 里获取 post_id 参数,然后提取帖子对
象,把帖子对象传递到 post_detail.html 模板中.
</p>

<p>
为了能够访问到帖子详情,首页的帖子列表部分的超连接标签的 href 属性需要补充完整:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% for post in posts %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.post_detail', post_id = post.id) }}"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: {{ post.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;: {{ post.comments|length}}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
      {{ pagination.links }}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      {% if current_board %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% else %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endif %}
      {% for board in boards %}
        {% if board.id == current_board %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% else %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id ) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif %}
      {% endfor %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
另外,在帖子的详情页 post_detail.html 中,要把帖子数据也填充进去
</p>

<p>
还是先看看原始的模板文件:
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;&#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;Python&#22522;&#30784;&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;20&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;10&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        &#24086;&#23376;&#20869;&#23481;
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              &#35780;&#35770;&#20869;&#23481;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后再根据这个文件的结构来完成数据填充:
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              &#35780;&#35770;&#20869;&#23481;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
重新加载项目,点击首页的帖子,可以看到帖子的详情页面正确显示了,而且每刷新一次详情
页,阅读数都会加1.
</p>
</div>
</div>

<div id="outline-container-org56d2939" class="outline-4">
<h4 id="org56d2939">发布评论</h4>
<div class="outline-text-4" id="text-org56d2939">
<p>
帖子详情页面底部有一个评论区,是用 textarea 文本框作为输入的,用来发布帖子的评论.
现在我们就来实现评论的功能了.
</p>

<p>
评论发布和帖子发布等一样,是用表单来提交的,所以先在 forms/post.py 中建立一个评论
表单类:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> InputRequired, Length

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PublicPostForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">title</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=100, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#26631;&#39064;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">content</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#20869;&#23481;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">board_id</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#26495;&#22359;!"</span>)])


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PublicCommentForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">content</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=200, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#35780;&#35770;!"</span>)])
</pre>
</div>

<p>
新增的代码中,只定义了 content 字段,发布评论只需要提交评论内容即可.
</p>

<p>
然后在 blueprints/front.py 中,添加一个 public_comment 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g, redirect, flash
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm, PublicCommentForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/post/&lt;int:post_id&gt;/comment"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_comment</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">form</span> = PublicCommentForm(request.form)
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
        <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel(content=content, post_id=post_id, author=g.user)
        db.session.add(comment)
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)

    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.post_detail"</span>, post_id = post_id))
</pre>
</div>

<p>
新增的视图函数中,通过 URL 传递帖子 id, 通过表单获取评论内容,发布评论前提是已经登
录,所以添加了 login_required 装饰器,然后通过 g.user 就可以获取当前登录的用户信息,并
把其作为评论的作者.
</p>

<p>
发表评论成功后,会返回帖子详情页面.用户就能看到最新的评论,当然,在
post_detail.html 里可以看到我们并没有实现展示评论的功能,所以目前只能测试评论是否
发送成功.
</p>

<p>
如果评论发表失败,就会把表单错误传递到 flash 中,同时重新加载页面显示错误信息.
</p>

<p>
下面我们就先来在 post_detail.html 中显示最新的评论信息:
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后我们就可以测试一下发布评论的功能了.
</p>

<p>
这里有一个小问题,就是作者提供的模板中,表单的 action 属性是没有设置的,所以现在测
试会在服务器端返回 405 的错误响应码,浏览器会显示 method not allowed 的错误信息,
action 属性留空,则表单提交时默认会以当前页面的 URL 为目标发起 POST 请求,而我们是
没有实现这样一个路由的,所以才会返回 405 的错误信息.
</p>

<p>
所以我还要把 action 属性用 url_for 补齐:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('front.public_comment', post_id = post.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
emmm 补齐之后,再次测试,发现没有在 post_detail.html 中设置 csrf_token, 所以还得再
修改一次
</p>

<blockquote>
<p>
因为我想要先实现评论的功能,所以选择先实现展示评论后实现展示错误,把作者的顺序颠倒
了,而作者在实现错误展示时就已经设置好 csrf_token 了.
</p>

<p>
另外,这也说明我这第一遍读这本书只是知道了有这些概念,知识,操作步骤,但没有完全掌握,我
认为了解一部分知识可以做到在发生错误时自己找错,debug, 而完全掌握则可以在代码编写
时有清晰的思路,步骤流程,比如这里提交 POST 请求,应该是 表单类,视图函数,模板或者是
自己习惯的顺序来实现,而每个部分的实现也都要有条理, python 文件要先导入或边用边导
入, 模板要注意命名,csrf 等. 这样就可以直接减少错误的产生,条理清晰的编码流程也可
以减少 debug 所需的时间.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('front.public_comment', post_id = post.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token()}}"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
修改完成,现在就可以发表评论并正确显示评论了.
</p>

<p>
但有一个小问题,就是最新的评论在最下面,所以我们要修改一下代码,让最新的评论显示在
最上面,这里就可以重新思考一下 ORM 模型中的 "关系" 概念了, "关系" 属性是 ORM 抽象
出来的多个表之间的联系,不是外键这种表结构上的关系的联系,而是某个表数据改变,另外
的表的数据也随之变化或者是某个表的数据变化依赖于其他表的数据的关系,我理解为是业
务逻辑上的关系,比如在评论表中插入一条数据,我们需要就要用到对应帖子的 id (post 表
数据),登录用户的 id(user 表的数据),才能完成一条评论数据的插入.这在使用原生 SQL
语句实现中 是比较麻烦的(与 ORM 提供的"关系" 比起来真的很麻烦,SQL 熟练的可能觉得
也就那样),需要用一个长条的 INSERT 语句,还需要自己传递各个数据的参数,SQL 语句可能
都没什么,但参数的传递就麻烦点了,自己实现需要在每个有从数据库读取数据的视图函数中
维护/传递一个变量来获取SQL 语句需要的参数(例如 post 表或 user 表的 id), 最后还是
会抽象到一个类中来维护这些数据(一个两个函数可以直接传递,整个项目中多的是用这些参
数的地方,所以用面向对象方法编程的人一般都会走到将它们抽象到一个类里这一步,我目前
的认知是这样认为的.)那后来会发现这些表之间的关系确定之后也是不易改变的,也会想办
法把这些东西抽象出来,而这实际上就是 ORM 所做的事情, Sqlalchemy 则是已经为 Python
把这些工作都完成了,所以除非是为了学习操作数据库程序的编写,否则还是使用
Sqlalchemy 更加高效简洁(最简单的理由, sqlalchemy 是许多优秀的程序员一起开发测试
的,总比自己实现要快要好).
</p>

<p>
回到项目这里的关系, 帖子的评论数据是通过关系属性 comments 获取的:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>)
</pre>
</div>
<p>
所以这里我们只需要修改下这个关系就可以实现了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>, order_by=<span style="font-style: italic;">"desc(CommentModel.create_time)"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<p>
这里和作者给的代码不一样,因为我用的是 back_populates 手动绑定,不过重点还是一样,
添加了一个 order_by 参数,设置为按照 create_time 倒序排序.
</p>

<blockquote>
<p>
作者用的 backref 自动双向绑定,所以可以在 CommentModel 的 post 关系里用
create_time.desc(), 而我用的 back_populates, 在 PostModel 里手动绑定,涉及到类声
明的顺序问题,以及为了格式统一, 不能直接使用 create_time 属性,所以在 sqlalchemy
文档里找到了用法: <a href="https://docs.sqlalchemy.org/en/14/orm/basic_relationships.html#late-evaluation-of-relationship-arguments">延迟执行的 relationship 参数</a>
</p>

<p>
在搜索的过程中,看到好多答案说 sqlalchemy 需要你用写 SQL 的思路来使用sqlalchemy ,
这就是它的 "无缝衔接" 吧,然后好多例子里都用到了 join 一类的参数设置,让我想到是不
是没有 join 的原因,这里的 join 与 sql 中的 join 不同, 它是类似于 select 语句中将
多个表加入查询的意思,例如 select * from table1 和 select * from table1,table2 加
上了一个 table2 的 "join" 有种加入查询语句的意思,而不是 SQL 里级联查询的 join 用
法. 找到正确用法后想了想,搜索中网友给出的答案里有 join 是因为提问的人试图在两个
表的一个对应关系中还加上额外的表/列来进行排序,所以是要加上 join 的,不然
sqlalchemy 不能处理没有指明的复杂关系的. 而我们使用的关系,都是两者之间的关系,这
里的排序也是使用的这两个表之中的一个表的一个字段进行的排序,所以是不需要的.
</p>

<p>
而我想明白这一点也是因为网友提供的思路说想要搞明白在 sqlalchemy 里怎么实现,要先
知道在 SQL 里会怎么实现,普通关系只用到两个表,它本身就对应了
<code>select column from table1,table2 where condition</code> 这样的 sql 语句,因为我们
relationship 的第一个参数就给出了要使用的另一个表的引用,所以不是没有引用表的问题.
而且我也用 SQL 语句执行过测试了,两个表都添加到查询范围,可以查询出正确数据:
</p>
<pre class="example" id="org1831cac">
mysql&gt; select comment.id from comment, post where comment.post_id = post.id;
+----+
| id |
+----+
|  1 |
|  2 |
|  3 |
|  4 |
|  5 |
|  6 |
|  7 |
+----+
7 rows in set (0.00 sec)
</pre>
<p>
如果没有将 post 加入查询范围,则会报措:
</p>
<pre class="example" id="org2bb264e">
mysql&gt; selece comment.id from comment where comment.post_id = post.id;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'selece comment.id from comment where comment.post_id = post.id' at line 1
</pre>

<p>
这就说明我的理解是正确的,我们前面这些 relationship 本身就等价于将两个表都添加进
查询范围的 sql 语句了.所以将结果倒序展示代码报措只有 order_by 的用法不对,找到目
标后就可以针对性的搜索出结果了.
</p>
</blockquote>

<blockquote>
<p>
关系就像是存储过程?具体概念名字忘了,反正其实就是用 py 代码代替/表示某些特定的
SQL 语句结构嘛,这个 comments 字段在 post 表里是没有的,它是通过查询语句查询出来的
数据,感觉最靠近的就是多个表的数据一起确定查询结果的一个概念,也不知是叫多表查询还
是级联查询什么的.例如根据学生姓名在学生表里查找学生id, 再通过学生id 到成绩表里查
找他的所有科目成绩的这种操作.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org47c6993" class="outline-3">
<h3 id="org47c6993">个人中心</h3>
<div class="outline-text-3" id="text-org47c6993">
<p>
个人中心就属于 user 模块的内容了.所以应该都在 user.py 蓝图中实现.
</p>

<p>
个人中心模块中,用户可以修改头像,个性签名等.
</p>

<p>
首先,在 blueprints/user.py 中添加渲染个人中心模板的视图函数:
</p>


<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, user=user)
</pre>
</div>

<p>
新增了一个 profile 视图函数,将 URL 中的 user_id 参数作为参数,访问当前用户的个人
中心和其他用户的个人中心都需要这个参数.
先看看 profile.html 内容:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://pic1.zhimg.com/80/v2-d03aa05346fd377da12dc324d79acda3_720w.jpg"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
然后访问 <a href="http://127.0.0.1:5000/user/profile/EaL9zRjnNTbK5tUxos4MJR">http://127.0.0.1:5000/user/profile/EaL9zRjnNTbK5tUxos4MJR</a> 查看某个用户
的个人中心页面, 这个 URL 中的 user_id 部分是我从数据库 user 表中随便选的一个 id,
因为模板页面数据是写死的,所以我们只是测试能否成功渲染页面,内容暂时与 user_id 无
关.
</p>

<p>
打开页面可以看到有一个保存按钮,就是这个页面是要用于修改个人信息的,例如签名之类的,所
以我们需要判断访问页面的用户 id 是否与 URL 中的 user_id 一致,一致则说明是用户自
己访问自己的个人中心,可以进行修改,不一致则是其他人查看用户信息,不能修改,这个功能
在后面实现,但不妨碍我们现在对访问者是否为用户本身进行判断:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)
</pre>
</div>
<p>
修改的代码中我们通过判断用户已登录且当前登录的用户 id 与个人中心页面的 id 一致来
确定访问页面的是否为用户本人,并将判断结果存放到 is_mine 变量传递到模板文件.
</p>
</div>

<div id="outline-container-org7e2b221" class="outline-4">
<h4 id="org7e2b221">使用 Flask-Avatars 生成随机头像</h4>
<div class="outline-text-4" id="text-org7e2b221">
<p>
用户没有上传头像时,显示空白会影响用户体验,可以使用 Flask-Avatars 插件来生成随即
的头像. Flask-Avatars 也是一个第三方插件,需要额外安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-avatars -i https://mirrors.163.com/pypi/simple/
</pre>
</div>

<p>
安装完成,在 exts.py 中创建 avatars 对象:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_sqlalchemy <span style="font-weight: bold;">import</span> SQLAlchemy
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Mail
<span style="font-weight: bold;">from</span> flask_caching <span style="font-weight: bold;">import</span> Cache
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask_avatars <span style="font-weight: bold;">import</span> Avatars

<span style="font-weight: bold; font-style: italic;">db</span> = SQLAlchemy()

<span style="font-weight: bold; font-style: italic;">mail</span> = Mail()

<span style="font-weight: bold; font-style: italic;">cache</span> = Cache()

<span style="font-weight: bold; font-style: italic;">csrf</span> = CSRFProtect()

<span style="font-weight: bold; font-style: italic;">avatars</span> = Avatars()
</pre>
</div>

<p>
然后在 app.py 中对 avatars 进行初始化:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)


<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
现在,就可以在模板中使用 avatars 变量来随机生成头像了. Flask-Avatars 有5种随机或
默认头像的方案
</p>
</div>

<ul class="org-ul">
<li><a id="orgb9fe8ff"></a>Gravatar<br />
<div class="outline-text-5" id="text-orgb9fe8ff">
<p>
Gravatar (globally recognized avatar) 是一种全球通用的头像服务. 用户只要在
Gravatar 官网(<a href="https://cn.gravatar.com/">https://cn.gravatar.com/</a>) 上用邮箱注册一个账号,并上传头像,那么任何
支持 Gravatar 的网站上使用相同的邮箱,都可以使用这个头像,如果用户没有上传过头像,
则会生成一个随即的头像.在模板中使用 avatars.gravatar 函数:
</p>
<pre class="example">
&lt;img src="{{ avatars.gravatar(email_hash) }}"&gt;
</pre>
<p>
email_hash 是 email 的哈希值,可以通过 hashlib 库获取哈希值:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> hashlib

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">email_hash</span>(email):
    <span style="font-weight: bold;">return</span> hashlib.md5(email.lower().encode(<span style="font-style: italic;">"utf-8"</span>)).hexdigest()
</pre>
</div>

<p>
作者并没有给出具体的实现,但是给出了方法,下面我就来自己试一下用 Gravatar 方案生成
头像.
</p>

<p>
首先,我们要将 email_hash 传递给模板 profile.html ,所以在 profile 视图函数中进行
修改:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">email_hash</span> = hashlib.md5(user.email.lower().encode(<span style="font-style: italic;">"utf-8"</span>)).hexdigest()
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-style: italic;">"email_hash"</span>: email_hash
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)
</pre>
</div>
<p>
修改的代码导入了 hashlib 库,将 user 的 email 进行哈希运算并传递给了 profile.html.
</p>

<p>
然后再在 profile.html 模板中将头像部分的代码替换为使用 avatars.gravatar 的代码:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.gravatar(email_hash) }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后再次访问 <a href="http://127.0.0.1:5000/user/profile/EaL9zRjnNTbK5tUxos4MJR">http://127.0.0.1:5000/user/profile/EaL9zRjnNTbK5tUxos4MJR</a> 可以看到
头像部分变化了, 如果换成另一个用户的 user id 来访问,头像又会变成另一个样子,但同
一个 id 访问多次,头像不会变化,因为 email_hash 值没有变.
</p>
</div>
</li>

<li><a id="orga72186c"></a>Robohash<br />
<div class="outline-text-5" id="text-orga72186c">
<p>
Robohash(<a href="https://robohash.org">https://robohash.org</a>) 是专门提供机器人随机头像的服务,通过
avatars.robohash(text) 获取头像,根据 text 随机生成头像:
</p>

<pre class="example">
&lt;img src="{{ avatars.robohash('jack') }}"&gt;
</pre>

<p>
使用 robohash 也不需要额外修改别的了,只需要修改模板文件就好了:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.robohash(user.username) }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
我将 text 设置为 user.username 用户的用户名,然后刷新页面,可以看到头像变成了机器
人的图像(另外这个网站可能需要科学上网才能访问).
</p>
</div>
</li>

<li><a id="orge4ad596"></a>社交网站头像<br />
<div class="outline-text-5" id="text-orge4ad596">
<p>
对于全球流行的社交平台 Twitter, Facebookd 等,可以用 avatars.social_media 获取指
定平台用户的头像.
</p>

<pre class="example">
&lt;img src="{{ avatars.social_media(username, platform="facebook") }}"&gt;
</pre>

<p>
social_media 默认的平台是 Twitter, 平台参数是可选的,除了 facebook 还可以是
instagram 的头像, 根据 <a href="https://flask-avatars.readthedocs.io/en/latest/">flask-avatars</a> 文档中显示的,只需要选择平台,设置好用户名就
可以获取用户在对应平台的头像了.
</p>

<p>
文档中给出了 realDonaldTrump 的用户名,我也来试试:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.social_media(Suyutong) }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
试了不行,应该是网络原因,或者是相关接口原因,因为换了用户名也获取不到头像,这个就不
继续了,反正墙内没哪个网站淦明目张胆用外网社交软件.
</p>
</div>
</li>

<li><a id="orgd185f17"></a>默认头像<br />
<div class="outline-text-5" id="text-orgd185f17">
<p>
Flask-Avatars 提供一个默认的头像功能,可以通过设置 size 的值为 s,m,l 来显示不同尺
寸的头像:
</p>

<pre class="example">
&lt;img src="{{ avatars.default(size='l') }}"&gt;
</pre>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.default(size='l') }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
默认头像就是很简陋的一个半身人图标.
</p>
</div>
</li>

<li><a id="org46aaed6"></a>Identicon 哈希头像<br />
<div class="outline-text-5" id="text-org46aaed6">
<p>
Identicon 是一种基于用户信息的哈希值生成图像的技术,例如根据 IP 地址,邮箱等, 其雏
形是 9 个方格的图案,现在已经发展到许多其他类型的生成模式了.
</p>

<p>
Identicon 会将生成的图片保存到指定位置.所以我们要在 config.py 中添加参数
AVATARS_SAVE_PATH, 因为是开发环境,所以我们就在 DevelopmentConfig 下添加:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> os

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BaseConfig</span>:
    <span style="font-weight: bold; font-style: italic;">SECRET_KEY</span> = <span style="font-style: italic;">"my secret key"</span>
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold; font-style: italic;">PER_PAGE_COUNT</span> = 10


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">DevelopmentConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://root:kamisama@127.0.0.1:3306/pythonbbs?charset=utf8mb4"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37038;&#31665;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_SERVER</span> = <span style="font-style: italic;">"smtp.163.com"</span> <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#37038;&#31665;&#29992; smtp.qq.com</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USE_SSL</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PORT</span> = 465      <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">qq &#30340;&#31471;&#21475;&#29992; 587</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_USERNAME</span> = <span style="font-style: italic;">"&#37038;&#31665;&#36134;&#21495;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_PASSWORD</span> = <span style="font-style: italic;">"&#24320;&#21551; SMTP &#26381;&#21153;&#26102;&#29983;&#25104;&#30340;&#25480;&#26435;&#23494;&#30721;"</span>
    <span style="font-weight: bold; font-style: italic;">MAIL_DEFAULT_SENDER</span> = <span style="font-style: italic;">"&#37038;&#31665;&#24080;&#21495;"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#32531;&#23384;&#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_TYPE</span> = <span style="font-style: italic;">"RedisCache"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_HOST</span> = <span style="font-style: italic;">"127.0.0.1"</span>
    <span style="font-weight: bold; font-style: italic;">CACHE_REDIS_PORT</span> = 6379

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Celery &#37197;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26684;&#24335; redis://:password@hostname:port/db_number</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_BROKER_RUL</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>
    <span style="font-weight: bold; font-style: italic;">CELERY_RESULT_BACKEND</span> = <span style="font-style: italic;">"redis://127.0.0.1:6379/0"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23384;&#20648;&#19978;&#20256;&#22270;&#29255;&#30340;&#36335;&#24452;</span>
    <span style="font-weight: bold; font-style: italic;">UPLOAD_IMAGE_PATH</span> =  r<span style="font-style: italic;">"C:\Users\kamisama\flask_web_py3_10\pythonbbs"</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Identicon &#22836;&#20687;&#20445;&#23384;&#36335;&#24452;</span>
    <span style="font-weight: bold; font-style: italic;">AVATARS_SAVE_PATH</span> = os.path.join(UPLOAD_IMAGE_PATH, <span style="font-style: italic;">"avatars"</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">TestingConfig</span>(BaseConfig):
    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#27979;&#35797;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#27979;&#35797;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ProductionConfig</span>(BaseConfig):


    <span style="font-weight: bold; font-style: italic;">SQLALCHEMY_DATABASE_URI</span> = <span style="font-style: italic;">"mysql+pymysql://[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MySQL&#29992;&#25143;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#23494;&#30721;]@[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#22495;&#21517;]:[&#29983;&#20135;&#29615;&#22659;&#26381;&#21153;&#22120;MYSQL&#31471;&#21475;&#21495;]/pythonbbs?charset=utf8mb4"</span>
</pre>
</div>

<p>
我们把头像的存储路径设置为 DevelopmentConfig.UPLOAD_IMAGE_PATH 的 avatars 文件夹下面.
</p>

<p>
然后我们要在用户模型中实现一个生成头像的方法:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> flask_avatars.identicon <span style="font-weight: bold;">import</span> Identicon
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> enum <span style="font-weight: bold;">import</span> Enum
<span style="font-weight: bold;">from</span> shortuuid <span style="font-weight: bold;">import</span> uuid
<span style="font-weight: bold;">from</span> werkzeug.security <span style="font-weight: bold;">import</span> generate_password_hash, check_password_hash

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionEnum</span>(Enum):
    <span style="font-weight: bold; font-style: italic;">BOARD</span> = <span style="font-style: italic;">"&#26495;&#22359;"</span>
    <span style="font-weight: bold; font-style: italic;">POST</span>  = <span style="font-style: italic;">"&#24086;&#23376;"</span>
    <span style="font-weight: bold; font-style: italic;">COMMENT</span> = <span style="font-style: italic;">"&#35780;&#35770;"</span>
    <span style="font-weight: bold; font-style: italic;">FRONT_USER</span> = <span style="font-style: italic;">"&#21069;&#21488;&#29992;&#25143;"</span>
    <span style="font-weight: bold; font-style: italic;">CMS_USER</span>  = <span style="font-style: italic;">"&#21518;&#21488;&#29992;&#25143;"</span>

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PermissionModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"permission"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.Enum(PermissionEnum), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">roles</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>,back_populates=<span style="font-style: italic;">"permissions"</span>)



    <span style="font-weight: bold; font-style: italic;">role_permission_table</span> = db.Table(
        <span style="font-style: italic;">"role_permission_table"</span>,
        db.Column(<span style="font-style: italic;">"role_id"</span>,db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>)),
        db.Column(<span style="font-style: italic;">"permission_id"</span>, db.Integer, db.ForeignKey(<span style="font-style: italic;">"permission.id"</span>))
)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RoleModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"role"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">desc</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">permissions</span> = db.relationship(<span style="font-style: italic;">"PermissionModel"</span>, secondary=<span style="font-style: italic;">"role_permission_table"</span>, back_populates=<span style="font-style: italic;">"roles"</span>)
    <span style="font-weight: bold; font-style: italic;">users</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"role"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"user"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.String(100), primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, default=uuid)
    <span style="font-weight: bold; font-style: italic;">username</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">_password</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">email</span> = db.Column(db.String(50), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>, unique=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">avatar_s</span> = db.Column(db.String(64))
    <span style="font-weight: bold; font-style: italic;">avatar_m</span> = db.Column(db.String(64))
    <span style="font-weight: bold; font-style: italic;">avatar_l</span> = db.Column(db.String(64))
    <span style="font-weight: bold; font-style: italic;">signature</span> = db.Column(db.String(100))
    <span style="font-weight: bold; font-style: italic;">join_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">Foreign Key</span>
    <span style="font-weight: bold; font-style: italic;">role_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"role.id"</span>))


    <span style="font-weight: bold; font-style: italic;">role</span> = db.relationship(<span style="font-style: italic;">"RoleModel"</span>, back_populates=<span style="font-style: italic;">"users"</span>)
    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"author"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"author"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__init__</span>(<span style="font-weight: bold;">self</span>, *args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-style: italic;">"password"</span> <span style="font-weight: bold;">in</span> kwargs:
            <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">password</span> = kwargs.get(<span style="font-style: italic;">"password"</span>)
            kwargs.pop(<span style="font-style: italic;">"password"</span>)
        <span style="font-weight: bold;">super</span>(UserModel, <span style="font-weight: bold;">self</span>).__init__(*args, **kwargs)
        <span style="font-weight: bold;">self</span>.generate_avatar()

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">generate_avatar</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold; font-style: italic;">avatar</span> = Identicon()
        <span style="font-weight: bold; font-style: italic;">filenames</span> = avatar.generate(text=<span style="font-weight: bold;">self</span>.email)
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">avatar_s</span> = filenames[0]
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">avatar_m</span> = filenames[1]
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">avatar_l</span> = filenames[2]
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">db.session.commit()</span>

    @<span style="font-weight: bold;">property</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>):
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold;">self</span>._password

    <span style="font-weight: bold; text-decoration: underline;">@password.setter</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold;">self</span>.<span style="font-weight: bold; font-style: italic;">_password</span> = generate_password_hash(raw_password)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">check_password</span>(<span style="font-weight: bold;">self</span>, raw_password):
        <span style="font-weight: bold; font-style: italic;">result</span> = check_password_hash(<span style="font-weight: bold;">self</span>.password, raw_password)
        <span style="font-weight: bold;">return</span> result

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">has_permission</span>(<span style="font-weight: bold;">self</span>, permission):
        <span style="font-weight: bold;">return</span> permission <span style="font-weight: bold;">in</span> [permission.name <span style="font-weight: bold;">for</span> permission <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">self</span>.role.permissions]
</pre>
</div>

<p>
这个修改后的 UserModel 会让以后再创建用户对象时,自动调用 generate_avatar 方法,并
将生成的头像分别存储在 avatar_s,avatar_m,avatar_l 上.
因为作者书中以及资料中的代码都没有真的在 UserModel 中实现生成头像的功能,所以上面
代码是我自己根据作者的示例代码写的, 有点不确定的地方在于作者示例代码中
generate_avatar 函数里有 db.session.commit() 照理说是先实例化 UserModel 对象,然
后再 commit() 的,他给的示例代码可能只是为了说明最后要 commit 才会同步到数据库中,
所以我先把这个疑惑记下来,下面就用 flask-migrate 同步数据库的修改,然后进行测试:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db migrate -m <span style="font-style: italic;">"change UserModel for avatars"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">flask db upgrade
</pre>
</div>

<p>
执行数据库迁移脚本没有报措. 查看数据库的 user 表结构,确实成功修改了,查看 user 表
数据, 新的三个字段值全为 NULL.
那我就新注册一个用户,看看能否成功
</p>

<p>
不出意外是出意外了,作者给出的用法就直接是从 flask-avatars 文档中复制粘贴过来的,
找了半天才发现这点. 我都怀疑作者没有给出完整代码而是直接复制了文档的代码是因为他
就没有真正去实现,就像是搞到最后不想搞了一样.
</p>

<p>
这个文档写的也不是很直接,最后是看着它的 API 和用法示例慢慢改成的. 对了,上面的代
码是已经修改成功后的代码了,图片是可以生成的,只是我用的 email 只有一个所以数据库
会报措重复条目的错误消息(我是直接在注册页面注册的).
</p>

<p>
回想前面的代码,作者用命令添加的初始用户,想到我也可以用命令测试,
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionModel, RoleModel, PermissionEnum, UserModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> faker <span style="font-weight: bold;">import</span> Faker
<span style="font-weight: bold;">import</span> random

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_post</span>():
    <span style="font-weight: bold; font-style: italic;">fake</span> = Faker(locale=<span style="font-style: italic;">"zh_CN"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = UserModel.query.first()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    click.echo(<span style="font-style: italic;">"&#24320;&#22987;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;..."</span>)
    <span style="font-weight: bold;">for</span> x <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(98):
        <span style="font-weight: bold; font-style: italic;">title</span> = fake.sentence()
        <span style="font-weight: bold; font-style: italic;">content</span> = fake.paragraph(nb_sentences=10)
        <span style="font-weight: bold; font-style: italic;">random_index</span> = random.randint(0, 4)
        <span style="font-weight: bold; font-style: italic;">board</span> = boards[random_index]
        <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title, content=content, board=board, author=author)

        db.session.add(post)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#24086;&#23376;&#29983;&#25104;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_permission</span>():
    <span style="font-weight: bold;">for</span> permission_name <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">dir</span>(PermissionEnum):
        <span style="font-weight: bold;">if</span> permission_name.startswith(<span style="font-style: italic;">"__"</span>):
            <span style="font-weight: bold;">continue</span>
        <span style="font-weight: bold; font-style: italic;">permission</span> = PermissionModel(name=<span style="font-weight: bold;">getattr</span>(PermissionEnum,permission_name))
        db.session.add(permission)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26435;&#38480;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_role</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31293;&#26597;</span>
    <span style="font-weight: bold; font-style: italic;">inspector</span> = RoleModel(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#23457;&#26680;&#24086;&#23376;&#21644;&#35780;&#35770;&#26159;&#21542;&#31526;&#21512;&#35268;&#33539;"</span>)
    inspector.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT
        ])).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">operator</span> = RoleModel(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#32593;&#31449;&#25345;&#32493;&#27491;&#24120;&#36816;&#34892;"</span>)
    operator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">filter</span>(
        PermissionModel.name.in_([
            PermissionEnum.POST,
            PermissionEnum.COMMENT,
            PermissionEnum.BOARD,
            PermissionEnum.FRONT_USER,
        ])).<span style="font-weight: bold;">all</span>()

    <span style="font-weight: bold; font-style: italic;">administrator</span> = RoleModel(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>, desc=<span style="font-style: italic;">"&#36127;&#36131;&#25972;&#20010;&#32593;&#31449;&#25152;&#26377;&#24037;&#20316;"</span>)
    administrator.<span style="font-weight: bold; font-style: italic;">permissions</span> = PermissionModel.query.<span style="font-weight: bold;">all</span>()

    db.session.add_all([inspector, operator, administrator])

    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#35282;&#33394;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_test_user</span>():
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">zhangsan</span> = UserModel(username=<span style="font-style: italic;">"&#24352;&#19977;"</span>,
                         email=<span style="font-style: italic;">"zhangsan@123.com"</span>,
                         password=<span style="font-style: italic;">"111111"</span>,
                         is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                         role=admin_role)


    <span style="font-weight: bold; font-style: italic;">operator_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#36816;&#33829;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">lisi</span> = UserModel(username=<span style="font-style: italic;">"&#26446;&#22235;"</span>,
                     email=<span style="font-style: italic;">"lisi@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=operator_role)

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">wangwu</span> = UserModel(username=<span style="font-style: italic;">"&#29579;&#20116;"</span>,
                     email=<span style="font-style: italic;">"wangwu@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)

    db.session.add_all([zhangsan,lisi,wangwu])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#27979;&#35797;&#29992;&#25143;&#28155;&#21152;&#25104;&#21151;!"</span>)

<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--username"</span>, <span style="font-style: italic;">"-u"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--email"</span>, <span style="font-style: italic;">"-e"</span>)
<span style="font-weight: bold; text-decoration: underline;">@click.option</span>(<span style="font-style: italic;">"--password"</span>, <span style="font-style: italic;">"-p"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_admin</span>(username, email, password):
    <span style="font-weight: bold; font-style: italic;">admin_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31649;&#29702;&#21592;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">admin_user</span> = UserModel(username=username,email=email,password=password, is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>, role=admin_role)
    db.session.add(admin_user)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#31649;&#29702;&#21592;&#21019;&#24314;&#25104;&#21151;!"</span>)

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_board</span>():
    <span style="font-weight: bold; font-style: italic;">board_names</span> = [<span style="font-style: italic;">"Python&#35821;&#27861;"</span>, <span style="font-style: italic;">"web&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#25968;&#25454;&#20998;&#26512;"</span>, <span style="font-style: italic;">"&#27979;&#35797;&#24320;&#21457;"</span>, <span style="font-style: italic;">"&#36816;&#32500;&#24320;&#21457;"</span>]
    <span style="font-weight: bold;">for</span> board_name <span style="font-weight: bold;">in</span> board_names:
        <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel(name=board_name)
        db.session.add(board)
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#26495;&#22359;&#28155;&#21152;&#25104;&#21151;!"</span>)


<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">create_avatar_test_user</span>():

    <span style="font-weight: bold; font-style: italic;">inspector_role</span> = RoleModel.query.filter_by(name=<span style="font-style: italic;">"&#31293;&#26597;"</span>).first()
    <span style="font-weight: bold; font-style: italic;">test1</span> = UserModel(username=<span style="font-style: italic;">"&#27979;&#35797;&#22836;&#20687;&#29992;&#25143;1"</span>,
                     email=<span style="font-style: italic;">"avatar1@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)
    <span style="font-weight: bold; font-style: italic;">test2</span> = UserModel(username=<span style="font-style: italic;">"&#27979;&#35797;&#22836;&#20687;&#29992;&#25143;2"</span>,
                     email=<span style="font-style: italic;">"avatar2@123.com"</span>,
                     password=<span style="font-style: italic;">"111111"</span>,
                     is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>,
                     role=inspector_role)
    db.session.add_all([test1,test2])
    db.session.commit()
    click.echo(<span style="font-style: italic;">"&#28155;&#21152;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;12 &#25104;&#21151;!"</span>)

</pre>
</div>

<p>
添加一个 create_avatar_test_user 函数,用于生成两个测试用户, 然后在 app.py 中注册
它们
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-avatar-test-user"</span>)(commands.create_avatar_test_user)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)


<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后执行命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-avatar-test-user
</pre>
</div>

<p>
搞定! 添加成功,这次添加的用户数据的 avatar_s,avatar_m,avatar_l 都有值了,而且存放
头像的文件夹里也有相应头像了, 每个头像文件都以 email_*.png 命名, <code>*</code> 是 s,m,l .
</p>

<p>
这说明我们为用户注册时自动生成头像的功能实现了.
</p>

<p>
看了下,最终作者使用的是第一种方案 Gravatar 生成随机头像. 我想了想,用 Gravatar 也
有好处,最大的好处就是不用存储额外的图片文件了,在没有实现修改头像功能时是很方便的
显示头像的方法,另外就是根据作者的做法,这种方法还可以联系下使用过滤器函数.
</p>

<p>
前面我测试时是直接将 email 的哈希值传递给了模板,这样做只是为了测试练习,实际用这
种方法很不"优雅",看到作者使用过滤器才想到还可以这样做, 视图函数仍返回必要的原始
数据,而进一步加工可以放在过滤器中,这样将功能分开,出错了也容易定位错误.
</p>

<p>
首先,项目根目录下创建一个 filters.py 文件,用来存放自定义的过滤器:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> hashlib

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">email_hash</span>(email):
    <span style="font-weight: bold;">return</span> hashlib.md5(email.lower().encode(<span style="font-style: italic;">"utf-8"</span>)).hexdigest()
</pre>
</div>

<p>
然后在 app.py 中添加过滤器:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks
<span style="font-weight: bold;">import</span> filters

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-avatar-test-user"</span>)(commands.create_avatar_test_user)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#36807;&#28388;&#22120;</span>
app.template_filter(<span style="font-style: italic;">"email_hash"</span>)(filters.email_hash)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
之后在 templates/front/profile.html 中,将头像的代码替换:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  &#24352;&#19977;&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#24352;&#19977;&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#24352;&#19977;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.gravatar(user.email|email_hash) }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;&#25105;&#23601;&#26159;&#25105;&#65292;&#19981;&#19968;&#26679;&#30340;&#28895;&#28779;&#65281;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
对了,因为前面我直接把 email 的哈希值放在一个变量 email_hash 里传递给了模板,所以
这里需要把它删除
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">email_hash = hashlib.md5(user.email.lower().encode("utf-8")).hexdigest()</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">"email_hash": email_hash</span>
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)
</pre>
</div>

<blockquote>
<p>
作者的方案改动之后访问主页就可以看到生成随机头像了,但是他没有处理初始头像的生成
和保存.而且!!! 它给的代码真是混乱之极,说使用 gravatar 的方案,给出的代码确实使用
默认头像 avatars.default ,简直了,这里完全可以断定作者这一部分就没有实现,直接是去
flask-avatar 文档中复制粘贴的代码,他这一小结除了渲染 profile.html 的视图函数以外,其
余的代码全部都是文档里的.
</p>
</blockquote>
</div>
</li>
</ul>
</div>

<div id="outline-container-org17b69f8" class="outline-4">
<h4 id="org17b69f8">修改导航条上的登录状态</h4>
<div class="outline-text-4" id="text-org17b69f8">
<p>
现在,我们要处理一下页面导航栏右侧的登录注册按钮,目前为止,不管是否登录,右侧都显示
登录和注册两个按钮,这在逻辑上是说不通的,我们这一部分就来完善登录状态的链接.
</p>

<p>
我们要让页面在没有登录时显示登录和注册按钮,在登录时显示用户名和退出登录按钮,单击
用户名可以跳转到个人中心页面.
</p>

<p>
因为导航栏是在 base.html 模板中实现的,所以修改 templates/front/base.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;

  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      {% if g.user %}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.profile', user_id=g.user.id) }}"</span>&gt;{{ g.user.username }}&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      {% else %}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.login') }}"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.register') }}"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      {% endif %}
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
新增的代码通过判断对象 g 是否有 user 属性,判断是否已经登录,登录则显示用户名和退
出登录按钮,没有登录则显示登录和注册链接. 因为新增了一个退出登录的链接,所以需要在
blueprints/user.py 中实现它:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">email_hash = hashlib.md5(user.email.lower().encode("utf-8")).hexdigest()</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">"email_hash": email_hash</span>
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/logout"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">logout</span>():
    session.clear()
    <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
</pre>
</div>

<p>
前面说过, Flask 的 session 是通过设置 user_id 作为登录标识的, session.clear() 清
除了 session 中的 user_id, 就相当于我们手动通过开发者工具删除了浏览器中的 cookie
一样(flask 的 session 是通过将标识存储在 cookie 中返回给客户端实现的).
</p>
</div>
</div>

<div id="outline-container-orgea5273d" class="outline-4">
<h4 id="orgea5273d">根据用户显示个人中心</h4>
<div class="outline-text-4" id="text-orgea5273d">
<p>
用户自身的个人中心和他人的用户中心使用的是同一个 URL 和模板,因此需要进行区分.
</p>

<p>
访问用户自己的个人中心时,数据可以编辑;访问别人的个人中心时,仅展示数据.
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  {{ user.username }}&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ user.username }}&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span> <span style="font-weight: bold; font-style: italic;">enctype</span>=<span style="font-style: italic;">"multipart/form-data"</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.username }}"</span>&gt;
            {% else %}
            {{ user.username }}
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.gravatar(user.email|email_hash)|replace('https://gravatarcom/avatar/', 'https://gravatar.loli.net/avatar/') }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;

            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"file"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">accept</span>=<span style="font-style: italic;">"image/jpeg, image/png"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"&#19978;&#20256;&#22836;&#20687;"</span>&gt;
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"signature"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.signature or '' }}"</span>&gt;
            {% else %}
            {{ user.signature or "" }}
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    {% if is_mine %}
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    {% endif %}
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
修改的模板中通过 is_mine 判断是否为用户本人,然后决定是否渲染输入框,在 is_mine 为
True 时,用户可以修改数据并保存. form 标签的 enctype 属性是因为需要上传图片,而因
为现在没有写好修改用户信息的 URL 和视图,所以 action 属性暂时留空. 另外,因为
Gravatar 服务器是国外的,所以作者把服务器替换成了国内的镜像.
</p>
</div>
</div>

<div id="outline-container-org123199c" class="outline-4">
<h4 id="org123199c">修改用户信息</h4>
<div class="outline-text-4" id="text-org123199c">
<p>
上小节实现了个人中心的界面,现在来实现对个人中心数据的修改功能, 修改个人数据,要求
用户访问本人的个人中心,对数据进行修改,然后单击 "保存" 按钮,把数据发送到视图函数
进行数据库中数据的修改.
</p>

<p>
针对用户修改个人数据的表单,要创建一个对应的表单类,在 forms/user.py 中添加一个
EditProfileForm 类:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> Form, StringField, ValidationError, BooleanField, FileField
<span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, EqualTo, Length
<span style="font-weight: bold;">from</span> flask_wtf.<span style="font-weight: bold;">file</span> <span style="font-weight: bold;">import</span> FileAllowed
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> cache
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">RegisterForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">email_captcha</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=4,<span style="font-weight: bold;">max</span>=4,message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#39564;&#35777;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#29992;&#25143;&#21517;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">confirm_password</span> = StringField(validators=[EqualTo(<span style="font-style: italic;">"password"</span>, message=<span style="font-style: italic;">"&#20004;&#27425;&#23494;&#30721;&#19981;&#19968;&#33268;!"</span>)])

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validat_email</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">email</span> = field.data
        <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
        <span style="font-weight: bold;">if</span> user:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#37038;&#31665;&#24050;&#23384;&#22312;"</span>)

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_captcha</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">captcha</span> = field.data
        <span style="font-weight: bold; font-style: italic;">email</span> = <span style="font-weight: bold;">self</span>.email.data
        <span style="font-weight: bold; font-style: italic;">cache_captcha</span> = cache.get(email)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cache_captcha <span style="font-weight: bold;">or</span> captcha != cache_captcha:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#39564;&#35777;&#30721;&#38169;&#35823;!"</span>)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">LoginForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField( validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">password</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=6, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#38271;&#24230;&#30340;&#23494;&#30721;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">remember</span> = BooleanField()

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">EditProfileForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">username</span> = StringField(validators=[Length(<span style="font-weight: bold;">min</span>=2, <span style="font-weight: bold;">max</span>=20, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#29992;&#25143;&#21517;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">avatar</span> = FileField(validators=[FileAllowed([<span style="font-style: italic;">"jpg"</span>, <span style="font-style: italic;">"jpeg"</span>, <span style="font-style: italic;">"png"</span>], message=<span style="font-style: italic;">"&#25991;&#20214;&#31867;&#22411;&#38169;&#35823;"</span>)])
    <span style="font-weight: bold; font-style: italic;">signature</span> = StringField()
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">validate_signature</span>(<span style="font-weight: bold;">self</span>, field):
        <span style="font-weight: bold; font-style: italic;">signature</span> = field.data
        <span style="font-weight: bold;">if</span> signature <span style="font-weight: bold;">and</span> <span style="font-weight: bold;">len</span>(signature) &gt; 100:
            <span style="font-weight: bold;">raise</span> ValidationError(message=<span style="font-style: italic;">"&#31614;&#21517;&#19981;&#33021;&#36229;&#36807;100&#20010;&#23383;&#31526;"</span>)
</pre>
</div>

<p>
表单中添加了 3 个字段,分别识 username, avatar 和 signature. avatar 是文件类型,用
FileAllowed 限制了文件后缀名,指定只能上传 jpeg, jpg 和 png 格式的文件.
</p>

<p>
下面就把 EditProfileForm 导入到 blueprints/user.py 中并实现一个视图函数 edit_profile:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g, send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> werkzeug.datastructures <span style="font-weight: bold;">import</span> CombinedMultiDict
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm, EditProfileForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">email_hash = hashlib.md5(user.email.lower().encode("utf-8")).hexdigest()</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">"email_hash": email_hash</span>
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/logout"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">logout</span>():
    session.clear()
    <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/profile/edit"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_profile</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = EditProfileForm(CombinedMultiDict([request.form, request.files]))
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
        <span style="font-weight: bold; font-style: italic;">avatar</span> = form.avatar.data
        <span style="font-weight: bold; font-style: italic;">signature</span> = form.signature.data

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#19978;&#20659;&#20102;&#38957;&#20687;</span>
        <span style="font-weight: bold;">if</span> avatar:
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29983;&#25104;&#23433;&#20840;&#30340;&#25991;&#20214;&#21517;</span>
            <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(avatar.filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25340;&#25509;&#22836;&#20687;&#23384;&#20648;&#36335;&#24452;</span>
            <span style="font-weight: bold; font-style: italic;">avatar_path</span> = os.path.join(current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>), filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20445;&#23384;&#25991;&#20214;</span>
            avatar.save(avatar_path)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#22836;&#20687; URL</span>
            g.user.<span style="font-weight: bold; font-style: italic;">avatar_l</span> = url_for(<span style="font-style: italic;">"user.uploaded_avatar"</span>, filename=filename)
        g.user.<span style="font-weight: bold; font-style: italic;">username</span> = username
        g.user.<span style="font-weight: bold; font-style: italic;">signature</span> = signature
        db.session.commit()
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/avatar/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_avatar</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
Flask 中,可以通过 request.files 获取前端上传的问津, 通过 request.form 可以获取普
通表单数据. 为了对文件和普通表单数据都能验证,使用了
werkzeug.datastructures.CombinedMultiDict 方法来将 request.files 和 request.form
合并成一个结构,再传给 EditProfileForm 进行验证.
</p>

<blockquote>
<p>
这里我还添加了一个返回上传的图片文件的视图函数,原因和前面 uploaded_image 一样,需
要返回一个文件的 URL 而不是返回一个 返回文件URL 的 URL.
</p>
</blockquote>

<p>
若上传了头像,则将头像保存到 AVATARS_SAVE_PATH 的路径下,然后使用 media.media_file
反转的 URL 赋值给当前用户的 avatar 属性属性,并在后面分别指定用户名和签名,完成用
户信息的修改.
</p>

<p>
在个人中心模块中,要将头像渲染的逻辑修改, 首先要判断 user.avatar 是否有值,如果有,
则渲染 user.avatar, 否则就渲染 gravatar:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'front/base.html' %}

{% block title %}
  {{ user.username }}&#20010;&#20154;&#20013;&#24515;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">style</span>&gt;
  .profile-box{
    width: 400px;
    margin: 0 auto;
  }
  .avatar{
    width: 200px;
  }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"profile-box"</span>&gt;
  &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{{ user.username }}&#20010;&#20154;&#20013;&#24515;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('user.edit_profile') }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span> <span style="font-weight: bold; font-style: italic;">enctype</span>=<span style="font-style: italic;">"multipart/form-data"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered mt-5"</span>&gt;
      &lt;<span style="font-weight: bold;">tbody</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span> <span style="font-weight: bold; font-style: italic;">width</span>=<span style="font-style: italic;">"100px"</span>&gt;&#29992;&#25143;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"username"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.username }}"</span>&gt;
            {% else %}
            {{ user.username }}
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#22836;&#20687;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;

            {% if user.avatar_l %}
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ user.avatar_l }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
            {% else %}
            &lt;<span style="font-weight: bold;">img</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ avatars.gravatar(user.email|email_hash)|replace('https://gravatarcom/avatar/', 'https://gravatar.loli.net/avatar/') }}"</span> <span style="font-weight: bold; font-style: italic;">alt</span>=<span style="font-style: italic;">""</span>&gt;
            {% endif %}

            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"file"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"avatar"</span> <span style="font-weight: bold; font-style: italic;">accept</span>=<span style="font-style: italic;">"image/jpeg, image/png"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"&#19978;&#20256;&#22836;&#20687;"</span>&gt;
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">tr</span>&gt;
          &lt;<span style="font-weight: bold;">th</span>&gt;&#31614;&#21517;&#65306;&lt;/<span style="font-weight: bold;">th</span>&gt;
          &lt;<span style="font-weight: bold;">td</span>&gt;
            {% if is_mine %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"signature"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.signature or '' }}"</span>&gt;
            {% else %}
            {{ user.signature or "" }}
            {% endif %}
          &lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;/<span style="font-weight: bold;">tr</span>&gt;
      &lt;/<span style="font-weight: bold;">tbody</span>&gt;
    &lt;/<span style="font-weight: bold;">table</span>&gt;
    {% if is_mine %}
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center;"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span>&gt;&#20445;&#23384;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    {% endif %}
    &lt;/<span style="font-weight: bold;">form</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
现在网站只有访问用户自己个人中心的入口,访问他人的个人中心只有用测试时的方法将
user id 传递到参数去,所以我们需要在帖子详情页面给作者添加一个个人中心的入口
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.profile', user_id=post.author.id) }}"</span>&gt; {{ post.author.username }} &lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('front.public_comment', post_id = post.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token()}}"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>

<p>
emmm 有一点要注意,前面我对头像的5种方案进行测试的时候将数据库 user 表的结构修改
过了,现在我的数据库表里是没有 avatar 字段的,只有 avatar_s,avatar_m, avatar_l, 所
以上面的代码中,作者给出的 user.avatar 我都替换成了 user.avatar_l.
</p>

<p>
通过阅读作者资料中给出的代码,可以看到作者是将所有图片放在 media 文件夹下面,例如
帖子中的图片,而头像则放在 media 下面的 avatars 文件夹下面的. 而那个 media_file
的视图函数返回一个本地文件的地址就很奇怪,这里我是一直没有搞懂作者的写法,所以我决
定把他提供的代码跑起来看看效果.
</p>

<p>
折腾半天,跑作者的代码一堆报措,不是安装的版本不对,就是 500 错误.前者是网络问题,国
内镜像和官方镜像不是完全一致,版本是很大问题,官方镜像又连不上, 500 错误是我数据库
和作者代码里用的也有差别,不是字段名字有差别,就是字段不一样.
</p>

<p>
跑他的代码不如直接读代码算了,按照头像储存和读取的逻辑读了一遍相关代码,作者在存储
avatar 字段数据时就是存储的一个返回 "返回文件URL" 的URL, 也就是说用作者的代码,数
据库里存放的 avatar 字段是一个 url ,访问这个 url 可以返回一个用户头像存储路径的
URI, 只有再访问这个 URI 才能访问到头像文件,要是按照作者的写法, 模板文件里的 img
标签的 src 属性就不能直接是 user.avatar, 和前面 wangEditor 上传图片是一样的问题,
所以我还是用自己新增的返回头像文件的视图函数继续开发吧,这个 media.media_file 竟
然真的就只是一个检验是不是能正确得到文件路径的函数. 好恼火啊,什么都不说,每次和作
者描述的不一样,就以为哪里写错了,分析半天,发现作者就没有实现,就像是前面准备实现这
个功能的,结果到后面就忘了一样,那个 media_file 真是天猫的令人火大,描述说如果有
avatar 则渲染 user.avatar, 没有则渲染 gravatar, 用他的代码根本渲染不出来
user.avatar  好嘛.
</p>
</div>
</div>
</div>

<div id="outline-container-org89bc5cb" class="outline-3">
<h3 id="org89bc5cb">CMS 管理系统</h3>
<div class="outline-text-3" id="text-org89bc5cb">
<p>
一个用户能发布内容的网站就必须要有 CMS 管理系统,需要审核以及管理用户发布内容是否
合法.
</p>

<p>
pythonbbs 的 CMS 包括帖子管理,评论管理,前台用户管理,后台用户管理等.
</p>

<p>
许多模块的实现技术与我们已经实现的功能大同小异,所以作者选择了几个有代表性的模块
进行讲解,其他的需要我们自己完成.
</p>

<blockquote>
<p>
到了这一部分,作者关于一些细节就是能省则省了,不再是一步步带着做了,因为前面内容都
演示过了.但是我由于用 Org 做笔记和代码管理,所以细节我还是都加上了的.
</p>
</blockquote>
</div>

<div id="outline-container-orgd7e43bf" class="outline-4">
<h4 id="orgd7e43bf">CMS 入口</h4>
<div class="outline-text-4" id="text-orgd7e43bf">
<p>
先在 blueprints/cms.py 中实现一个 CMS 首页的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))
</pre>
</div>
<p>
cms 蓝图前面是已经注册过了的,所以不用再到 app.py 中注册.
</p>

<p>
虽然我们有了进入 CMS 的视图函数,但模板文件中并没有相应可点击的入口,不能总是让可
以进行 CMS 的 user 输入网址进入页面,所以我们需要在导航栏添加一个入口链接,还要进
行判断,如果用户是员工,则显示管理系统的入口链接,否则,就不显示,因为导航栏是所有页
面都会有的所以在 base.html 模板中修改:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/base.css') }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static', filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;

  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-light bg-light"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;Python&#35770;&#22363;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span>
          <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav mr-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item active"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#39318;&#39029; &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sr-only"</span>&gt;(current)&lt;/<span style="font-weight: bold;">span</span>&gt;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-inline my-lg-0"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control mr-sm-2"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"search"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#20851;&#38190;&#23383;"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Search"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-outline-success my-2 my-sm-0"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25628;&#32034;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-4"</span>&gt;
      {% if g.user %}
      {% if g.user.is_staff %}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span>&gt;&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      {% endif %}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.profile', user_id=g.user.id) }}"</span>&gt;{{ g.user.username }}&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      {% else %}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.login') }}"</span>&gt;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.register') }}"</span>&gt;&#27880;&#20876;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      {% endif %}
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-container"</span>&gt;
  {% block body %}{% endblock %}
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在换成 create_test_user 命令函数中创建的员工用户登录,即可看到导航栏出现管理系
统的按钮,而换成我自己用注册页面注册的用户登录,则不会显示(注册页面注册的的用户
is_staff 字段全为 False)
</p>
</div>
</div>

<div id="outline-container-org25a04f1" class="outline-4">
<h4 id="org25a04f1">权限管理</h4>
<div class="outline-text-4" id="text-org25a04f1">
<p>
定义权限时,我们定义了板块,帖子,评论,前台,后台的管理权限,并针对权限定义了稽查,运
营,管理员 3 个角色. 并且非员工用户不允许访问 CMS 系统.
</p>

<p>
上一小节只是在前端页面限制了 CMS 系统的入口,而没有在服务器端进行限制,这样如果有
人直接用网址访问是可以进入 CMS 页面的,所以我们需要像限制需要登录才能访问的页面一
样,限制特定权限(员工用户)才能访问 CMS 页面.
</p>

<p>
先在 blueprint/cms.py 中添加 before_request 钩子函数,在访问蓝图下的视图函数前,判
断 user.is_staff 是否为 True, 不是,则不允许访问:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)
</pre>
</div>

<p>
这里只在 cms 的蓝图中添加 before_request 钩子函数,而不是像前面一样在 app 中添加,
是因为前面添加是需要在所有页面都读取 session 里的 user_id 来判断用户是否登录, 而
这里只需要限制 CMS 页面的访问权限.
</p>

<p>
下面需要针对角色进行权限限制,先规定某个视图函数需要的权限,然后判断当前用户所属角
色有没有权限,如果有,则能访问,否则就不能.
</p>

<p>
这个实现与前面登录限制的实现一样,所以在 blueprints/decorators.py 中添加代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> functools <span style="font-weight: bold;">import</span> wraps
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> redirect, url_for, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> abort

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login_required</span>(func):
    <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inner</span>(*args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>):
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> func(*args, **kwargs)

    <span style="font-weight: bold;">return</span> inner

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">permission_required</span>(permission):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">outer</span>(func):
        <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inner</span>(*args, **kwargs):
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.has_permission(permission):
                <span style="font-weight: bold;">return</span> func(*args, **kwargs)
            <span style="font-weight: bold;">else</span>:
                <span style="font-weight: bold;">return</span> abort(403)

        <span style="font-weight: bold;">return</span> inner
    <span style="font-weight: bold;">return</span> outer
</pre>
</div>
<p>
新增的装饰器 permission_required, 接收一个权限为参数,在装饰器中判断当前用户是否
登录,并确认是否拥有该权限,如果有,则正常执行视图函数,否则抛出 403 错误.
</p>

<p>
如果稽查用户访问 CMS 系统,应该只能看到帖子和评论的功能入口,但现在我们没有在模板
中限制,导致任意角色的用户访问 CMS 系统都会显示所有功能的入口链接.
</p>

<p>
所以我们要在模板中进行判断, 根据 user.role.permissions 来决定用户有哪些权限(就是
UserModel 的 has_permission 方法)然后显示对应的功能链接. 由于要判断,所以我们需要
将 PermissionEnum 传到模板中:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}
</pre>
</div>

<p>
我们新增了一个 context_processor 钩子函数,把 PermissionEnum 传递给模板(全局上下
文).
</p>

<p>
然后在模板文件 cms/base.html 中修改导航栏的渲染功能:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/css/base.css') }}"</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;CMS&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#21069;&#21488;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;

&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-body"</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"left-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sidebar"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-sidebar"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"unfold"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span>&gt;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;

        {% set user = g.user %}
        {% if user.has_permission(PermissionEnum.POST) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group post-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#24086;&#23376;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.COMMENT) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comments-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#35780;&#35770;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.BOARD) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"board-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#26495;&#22359;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.FRONT_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group user-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#29992;&#25143;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.CMS_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group UserModel-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#21592;&#24037;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"right-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span>&gt;
      &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block page_title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main_content"</span>&gt;
        {% block main_content %}{% endblock %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
修改过后,登录不同权限的测试用户,再次访问 CMS 页面,会看到前面创建的张三李四王五登
录对应的左侧导航栏功能都不同. 例如稽查王五只有帖子管理和评论管理的功能.
</p>
</div>
</div>

<div id="outline-container-org8947633" class="outline-4">
<h4 id="org8947633">员工管理页面</h4>
<div class="outline-text-4" id="text-org8947633">
<p>
用户模型属性 is_staff 为 True 的用户为员工. 管理员角色用户可以对其他角色用户进行
管理,例如取消员工资格,修改分组等. 管理员之间无法修改对方的信息.
</p>

<p>
首先,在 blueprints/cms.py 中添加 staff_list 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)
</pre>
</div>
<p>
管理员工必须要有 PermissionEnum.CMS_USER 权限,所以要对 staff_list 视图函数添加
@permission_required(PermissionEnum.CMS_USER) 装饰器限制,后面的添加和编辑员工都
属于员工管理,也需要 CMS_USER 权限.
</p>

<p>
staff_list 视图函数,先提取 is_staff 为 True 的用户,没有分页,但是分页的处理逻辑与
首页帖子列表的处理逻辑一致,等会我自己添加,现在要将 templates/cms/staff_list.html
的员工列表部分修改:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}CMS&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}

{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary mb-3"</span>&gt;&#28155;&#21152;&#21592;&#24037;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#35282;&#33394;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
      {% for user in users %}
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.role.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;
        {% if not user.has_permission(PermissionEnum.CMS_USER) %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm"</span>&gt;&#32534;&#36753;&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif%}
      &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
修改后以管理员用户登录,访问 <a href="http://127.0.0.1:5000/cms/staff/list">http://127.0.0.1:5000/cms/staff/list</a> 可以看到稽查角
色有操作按钮,管理员和运营没有, 这是不正常的,因为管理员应该只是不能操作管理员用户,是
可以操作运营用户的, 因为上面的模板中,我们对用户权限进行了判断,只有拥有 CMS_USER
权限的用户才不会显示操作按钮,而运营本不应该拥有 CMS_USER 权限的,很明显,是创建角
色和权限数据时出错了,检察代码,果然, operator 角色和 administrator 的权限竟然是一
样的,翻书回去对照作者的代码,原来是从书里作者第一次生成角色权限时的代码就是错的,
没得法,将前面所有代码都改过来了,但是数据库里也需要修改,已经做到这里了,想要重新运
行修改后的代码将修改应用,需要删除数据库表重新运行命令,代价太大,我们可以直接删除
运营角色多余的 CMS_USER 权限, 运营角色 id 为 2 ,CMS_USER 权限 id 也为2,只需要删
除 role_permission_table 里 role_id 与 permission_id 为 2 的数据即可:
</p>
<pre class="example" id="orga321efb">
mysql&gt; delete from role_permission_table where role_id=2 and permission_id=2;

Query OK, 1 row affected (0.03 sec)
</pre>
<p>
执行完毕, 访问 <a href="http://127.0.0.1:5000/cms/staff/list">http://127.0.0.1:5000/cms/staff/list</a> 运营角色也显示 "操作" 按钮了.
</p>

<p>
另外,我们需要为员工管理添加超链接,跳转到视图函数 staff_list :
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/css/base.css') }}"</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;CMS&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#21069;&#21488;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;

&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-body"</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"left-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sidebar"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-sidebar"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"unfold"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span>&gt;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;

        {% set user = g.user %}
        {% if user.has_permission(PermissionEnum.POST) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group post-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#24086;&#23376;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.COMMENT) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comments-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#35780;&#35770;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.BOARD) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"board-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#26495;&#22359;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.FRONT_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group user-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#29992;&#25143;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.CMS_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group UserModel-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.staff_list') }}"</span>&gt;&#21592;&#24037;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"right-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span>&gt;
      &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block page_title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main_content"</span>&gt;
        {% block main_content %}{% endblock %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
现在,我们就可以通过左侧的 "员工管理" 按钮跳转到
<a href="http://127.0.0.1:5000/cms/staff/list">http://127.0.0.1:5000/cms/staff/list</a> 页面了.
</p>
</div>
</div>

<div id="outline-container-orgf8a2773" class="outline-4">
<h4 id="orgf8a2773">添加员工</h4>
<div class="outline-text-4" id="text-orgf8a2773">
<p>
员工管理页面,有一个 "添加员工" 按钮,单击后可以跳转到 "添加员工" 页面.
</p>

<p>
现在,我们在 blueprints/cms.py 中添加 add_staff 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
</pre>
</div>

<p>
在 GET 请求中渲染了添加员工的模板. 然后需要在员工管理页面的 "添加员工" 按钮上,添
加跳转到 "添加员工" 页面的超链接:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}CMS&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}

{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.add_staff') }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary mb-3"</span>&gt;&#28155;&#21152;&#21592;&#24037;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#35282;&#33394;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
      {% for user in users %}
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.role.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;
        {% if not user.has_permission(PermissionEnum.CMS_USER) %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm"</span>&gt;&#32534;&#36753;&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif%}
      &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
点击 "添加员工" 链接,进入 "添加员工" 的页面,先看看该页面的模板文件:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#28155;&#21152;&#21592;&#24037;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"email"</span>&gt;&#37038;&#31665;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#35282;&#33394;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio1"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio1"</span>&gt;&#31649;&#29702;&#21592;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio2"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"2"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio2"</span>&gt;&#36816;&#33829;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>

<p>
可以看到,角色是静态数据,不是动态加载的,在 add_staff 视图函数中,我们是把 roles 作
为参数传递到模板了的,现在我们要让 角色 成为动态的数据:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#28155;&#21152;&#21592;&#24037;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"email"</span>&gt;&#37038;&#31665;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#35282;&#33394;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        {% for role in roles %}
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span>&gt;{{ role.name }}&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>
<p>
现在,刷新页面,可以看到角色部分渲染出真实的数据了.
</p>

<p>
下面就来实现添加员工的表单提交功能.
</p>

<p>
首先,在 froms 文件夹下添加 cms.py 文件,用来存放 cms 蓝图下的表单,并创建
AddStaffForm 类:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, InputRequired

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#35282;&#33394;!"</span>)])
</pre>
</div>

<p>
然后在 blueprints/cms.py 的 add_staff 视图函数中完成 POST 请求提交的员工数据验证
和保存:
</p>

<blockquote>
<p>
作者这个 POST 请求没有实现返回表单验证失败的错误信息的数据,我顺手加上了,后面修改
模板文件,我也顺手加上了 csrf_token 和显示验证错误数据的内容.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
</pre>
</div>
<p>
然后在 add_staff.html 中渲染出错误消息
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#28155;&#21152;&#21592;&#24037;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"email"</span>&gt;&#37038;&#31665;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#35282;&#33394;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        {% for role in roles %}
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span>&gt;{{ role.name }}&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span>&gt;
          {% for message in messages %}
          &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
          {% endfor%}
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% endif %}
      {% endwith %}
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>

<p>
现在可以正常添加员工了,只需要给出用户的邮箱就可以将用户添加为员工,并设置为不同角
色.
</p>
<blockquote>
<p>
这里有一个小问题, 管理员添加员工的视图函数是可以把另一个管理员的角色权限"降级"的,这
与在 staff_list 页面中管理员不能操作管理员的逻辑是不符的.因为通过 "添加员工" 页
面将管理员"降级"后,可以间接实现一个管理员去管理其他管理员角色,这个应该是要进行限
制的,例如要设置某个用户为超级管理员,只有该用户才能将其他用户设置为管理员.
</p>

<p>
或者也可能是我的管理员设置多了,能保证管理员用户不会乱用 "添加员工" 功能也可以不
做限制,比如只把自己(网站所有者)作为管理员.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org0dca321" class="outline-4">
<h4 id="org0dca321">编辑员工</h4>
<div class="outline-text-4" id="text-org0dca321">
<p>
编辑员工功能是编辑员工的角色,员工权限,不能修改员工的邮箱,用户名,密码等信息.
</p>

<p>
先在 blueprints/cms.py 中添加一个 edit_staff 视图函数,用来渲染编辑页面和处理数据
提交的表单.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)
</pre>
</div>
<p>
新增的 edit_staff 视图函数只处理了 GET 请求的响应,用来渲染 edit_staff.html 模板,
并传递了 user 和 roles 参数, user 是要编辑的用户对象, roles 是所有角色类型.
</p>

<p>
然后我们需要在 "编辑" 按钮上添加编辑该员工的超链接, staff_list.html :
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}CMS&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}

{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.add_staff') }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary mb-3"</span>&gt;&#28155;&#21152;&#21592;&#24037;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#35282;&#33394;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
      {% for user in users %}
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.role.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;
        {% if not user.has_permission(PermissionEnum.CMS_USER) %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.edit_staff', user_id=user.id) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm"</span>&gt;&#32534;&#36753;&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif%}
      &lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
重新访问员工管理页面,单击某个 "编辑" 按钮,就可以跳转到对应员工的编辑页面, 可以看
下 edit_staff.html 模板,作者已经将参数 user 和 roles 的数据进行了解析处理, 处理
方式前面的内容里也有,都是一样的,不过还没有完善表单提交相关的修改,因为我们下一步
才会实现表单提交.
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#32534;&#36753;&#21592;&#24037;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"email"</span>&gt;&#37038;&#31665;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span> readonly <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.email }}"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#21592;&#24037;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          {% if user.is_staff %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span> checked&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span>&gt;
          {% endif %}
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span>&gt;&#26159;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff0"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"0"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"staff0"</span>&gt;&#21542;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#35282;&#33394;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        {% for role in roles %}
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
            {% if user.role.id == role.id %}
              &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span> checked&gt;
            {% else %}
              &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span>&gt;
            {% endif %}
            &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span>&gt;{{ role.name }}&lt;/<span style="font-weight: bold;">label</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}

</pre>
</div>

<p>
在 forms/cms.py 中添加一个 EditStaffForm 表单类:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField, BooleanField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, InputRequired

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#35282;&#33394;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">EditStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = BooleanField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#26159;&#21542;&#20026;&#21592;&#24037;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#20998;&#32452;!"</span>)])
</pre>
</div>

<p>
完成表单类后,在 edit_staff 视图函数中完善 POST 请求的响应处理:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
</pre>
</div>

<p>
在 edit_staff 模板中添加 csrf_token 和完善 action 属性,以及错误信息提示:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#32534;&#36753;&#21592;&#24037;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('cms.edit_staff', user_id=user.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{csrf_token()}}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"email"</span>&gt;&#37038;&#31665;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"email"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#37038;&#31665;"</span> readonly <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ user.email }}"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#21592;&#24037;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          {% if user.is_staff %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span> checked&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"1"</span>&gt;
          {% endif %}
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"staff1"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"is_staff"</span>&gt;&#26159;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
          &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"staff0"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"0"</span>&gt;
          &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"staff0"</span>&gt;&#21542;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span>&gt;&#35282;&#33394;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        {% for role in roles %}
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check form-check-inline"</span>&gt;
            {% if user.role.id == role.id %}
              &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span> checked&gt;
            {% else %}
              &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-input"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"radio"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"role"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ role.id }}"</span>&gt;
            {% endif %}
            &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-check-label"</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"inlineRadio{{ loop.index }}"</span>&gt;{{ role.name }}&lt;/<span style="font-weight: bold;">label</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span>&gt;
          {% for message in messages %}
          &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
          {% endfor%}
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% endif %}
      {% endwith %}
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}

</pre>
</div>

<p>
在测试功能时,发现无论编辑的是谁的信息,编辑员工页面都显示的当前登录页面的信息,最
后编辑提交的数据也是针对当前登录用户的,操作完成等于是自己修改自己的权限信息了.
这肯定是不对的,最开始我以为是 edit_staff 视图函数返回的 user 参数与当前用户的
g.user 参数搞混了. 于是我使用了不同的参数名,但发现仍然是错误的,后来开始分析,根据
这种错误,推断出一定是传参问题,前面使用 user 参数都没有错误,但这里就出错了,我也没
想到是 user 参数的问题,查看作者给出的代码,发现他书里和资料中都没有真正实现相应功
能,所以只能自己找错,发现 edit_staff 函数与 edit_staff.html 模板中相应的代码其实
并没有问题,但数据还是不对,所以可能是前面的代码导致的,最大可能性就是使用了同名的
参数,很快我就搜索到了前面 base.html 中使用了 {%set user=g.user%} 语句,这下就懂了,
这个语句直接把 user 设置为了 g.user ,而且 base.html 是最前面的代码,所以后面的页
面都会受影响,就算视图函数传递了 user 数据到模板,还是会被这条语句覆盖数据.我也疑
惑为什么 add_staff 和 staff_list 部分没有收到影响,又读了下代码,发现它们一个没有
用到 user, 一个用到的是 users, 都没有使用 user ,所以只有这里的 edit_staff 收到影
响. 我试验错误的时候偷懒没有把 user 参数名给换掉(前面都没出过错,下意识以为不会是
它出错),只是添加了一个额外的 user_id 参数传递 user_id, 结果刚好就没有发现是 user
的错, 现在发现了,属于参数有效范围的问题,两个解决方案,一个是把前面 base.html 中的
user 改成 current_user, 另一个就是使用 with 语句限制 user 的有效范围.其实还有就
是修改视图函数返回的参数名称,但这样模板中也要修改,而且并没有从根源上解决问题,只
是解决了表面的异常,下一次还可能出现类似的问题.
</p>

<blockquote>
<p>
其实从代码里我得到的认知是普通的参数 user 和全局变量 g 中的参数 user 是不会相互
干扰的, 它们一个是普通参数,一个是对象的某个属性,在名称的引用上不是一个层面的,所
以我才认为它们是不会相互影响的,谁知道还有个 {% set user = g.user %} 呢.
</p>
</blockquote>

<p>
既然作者前面讲解过 with 的用法,那我就用 with 限制 base.html 中 user 的有效范围:
</p>

<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/css/base.css') }}"</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;CMS&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#21069;&#21488;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;

&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-body"</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"left-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sidebar"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-sidebar"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"unfold"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span>&gt;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;

        {% with %}
        {% set user = g.user %}
        {% if user.has_permission(PermissionEnum.POST) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group post-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#24086;&#23376;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.COMMENT) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comments-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#35780;&#35770;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.BOARD) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"board-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#26495;&#22359;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.FRONT_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group user-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#29992;&#25143;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.CMS_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group UserModel-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.staff_list') }}"</span>&gt;&#21592;&#24037;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% endwith %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"right-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span>&gt;
      &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block page_title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main_content"</span>&gt;
        {% block main_content %}{% endblock %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
修改过后,可以正常显示被编辑的员工信息,以及正常修改其(权限)信息了.
</p>
</div>
</div>

<div id="outline-container-orge5f1ca9" class="outline-4">
<h4 id="orge5f1ca9">管理前台用户</h4>
<div class="outline-text-4" id="text-orge5f1ca9">
<p>
前台用户的管理包括禁用和取消禁用,如果需求更复杂,还可以实现对某个用户禁言一段时间,但
是不能修改用户的信息,例如邮箱,密码等. 而且由于信息的价值,一般不会轻易删除用户.
</p>

<p>
下面首先在 cms.py 蓝图中添加 user_list 视图函数,用于返回用户列表模板:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)
</pre>
</div>

<p>
然后在 base.html 中添加 "用户管理" 的超链接:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/css/base.css') }}"</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;CMS&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#21069;&#21488;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;

&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-body"</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"left-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sidebar"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-sidebar"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"unfold"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span>&gt;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;

        {% with %}
        {% set user = g.user %}
        {% if user.has_permission(PermissionEnum.POST) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group post-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#24086;&#23376;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.COMMENT) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comments-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#35780;&#35770;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.BOARD) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"board-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#26495;&#22359;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.FRONT_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group user-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.user_list') }}"</span>&gt;&#29992;&#25143;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.CMS_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group UserModel-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.staff_list') }}"</span>&gt;&#21592;&#24037;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% endwith %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"right-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span>&gt;
      &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block page_title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main_content"</span>&gt;
        {% block main_content %}{% endblock %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
看看 users.html 模板文件:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/users.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for user in users %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if user.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#21462;&#28040;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
访问 "用户管理" 页面,发现没有数据,分析了模板文件和视图函数,没有问题,也没有前面的
参数范围干扰的问题,所以可能是数据问题,看了下数据库数据,发现前面我测试时把所有注
册的测试用户改成员工了,随便将一个用户的 is_staff 设置为 False, 刷新页面就有数据
了.
</p>

<p>
用户管理页面的用户列表中,每条数据都有 "禁用" 按钮,这适合使用 AJAX 方式实现,用纯
表单提交会导致页面刷新,影响使用体验.
</p>

<p>
现在 cms.py 蓝图中实现响应 "禁用" 请求的 active_user 视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>

<p>
因为采用 AJAX 交互数据,所以返回的是 restful 模块的 JSON 格式的响应,在实现功能前,
我们先看看 users.html 里关于取消禁用和禁用的代码:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/users.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for user in users %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if user.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#21462;&#28040;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
它们是通过 data-active 和 data-user-id 属性绑定用户的 id 和用户当前是否可用. 这
样在 javascript 里可以通过属性值获取数据.
</p>

<p>
在 static/cms/js 文件夹下创建 users.js 文件
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    $(<span style="font-style: italic;">".active-btn"</span>).click(
        <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
            event.preventDefault();
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">is_active</span> = parseInt($this.attr(<span style="font-style: italic;">"data-active"</span>));
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = is_active?<span style="font-style: italic;">"&#30830;&#23450;&#31105;&#29992;&#35813;&#29992;&#25143;?"</span>:<span style="font-style: italic;">"&#30830;&#23450;&#21462;&#28040;&#31105;&#29992;&#35813;&#29992;&#25143;?"</span>;
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">user_id</span> = $this.attr(<span style="font-style: italic;">"data-user-id"</span>);
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
            <span style="font-weight: bold;">if</span>(!result){
                <span style="font-weight: bold;">return</span>;
            }
            <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">data</span> = {
                is_active: is_active?0:1
            }
            zlajax.post({
                url: <span style="font-style: italic;">"/cms/users/active/"</span> + user_id,
                data: data
            }).done(<span style="font-weight: bold;">function</span> (){
                window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                    alert(error.message);
                })
        });
});
</pre>
</div>

<p>
然后在 users.html 中加载 users.js:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#29992;&#25143;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/users.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;#&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#37038;&#31665;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#29992;&#25143;&#21517;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21152;&#20837;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for user in users %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ loop.index }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.email }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ user.join_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if user.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-user-id</span>=<span style="font-style: italic;">"{{ user.id }}"</span>&gt;&#21462;&#28040;&#31105;&#29992;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>
<p>
这个 js 文件通过 active-btn 找到了按钮元素,然后绑定单击事件. 然后通过获取
is_active 来判断当前用户是应该"禁用"还是"取消禁用". 通过 confirm 判断是否要真的
执行操作,如果选择确定,则发起请求更改用户状态.
</p>

<p>
在用户被禁用后,需要限制用户的登录,在 login 视图函数中,修改代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g, send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> werkzeug.datastructures <span style="font-weight: bold;">import</span> CombinedMultiDict
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm, EditProfileForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user.is_active:
                    flash(<span style="font-style: italic;">"&#35813;&#29992;&#25143;&#24050;&#32463;&#34987;&#31105;&#29992;!"</span>)
                    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">email_hash = hashlib.md5(user.email.lower().encode("utf-8")).hexdigest()</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">"email_hash": email_hash</span>
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/logout"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">logout</span>():
    session.clear()
    <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/profile/edit"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_profile</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = EditProfileForm(CombinedMultiDict([request.form, request.files]))
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
        <span style="font-weight: bold; font-style: italic;">avatar</span> = form.avatar.data
        <span style="font-weight: bold; font-style: italic;">signature</span> = form.signature.data

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#19978;&#20659;&#20102;&#38957;&#20687;</span>
        <span style="font-weight: bold;">if</span> avatar:
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29983;&#25104;&#23433;&#20840;&#30340;&#25991;&#20214;&#21517;</span>
            <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(avatar.filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25340;&#25509;&#22836;&#20687;&#23384;&#20648;&#36335;&#24452;</span>
            <span style="font-weight: bold; font-style: italic;">avatar_path</span> = os.path.join(current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>), filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20445;&#23384;&#25991;&#20214;</span>
            avatar.save(avatar_path)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#22836;&#20687; URL</span>
            g.user.<span style="font-weight: bold; font-style: italic;">avatar_l</span> = url_for(<span style="font-style: italic;">"user.uploaded_avatar"</span>, filename=filename)
        g.user.<span style="font-weight: bold; font-style: italic;">username</span> = username
        g.user.<span style="font-weight: bold; font-style: italic;">signature</span> = signature
        db.session.commit()
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/avatar/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_avatar</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
在 login 视图函数中添加了一个判断 is_active 是否为 True 的 if 语句, 如果为
False, 则返回提示消息,并重定向到登录页面.
</p>

<blockquote>
<p>
到这里发现跟着作者做的许多错误的地方和坑改起来很难受,因为涉及到数据库了,这样找错
或改错很麻烦,好在我发现到现在为止所有的测试数据其实都是通过那几个命令生成的,其实
删了数据库重新用正确代码生成也不是很麻烦.重新执行了一遍命令,再测试顺利多了.
</p>
</blockquote>

<p>
除了在登录时判断用户是否被禁用外,还需要在 login_required 装饰器中也判断用户是否
被禁用了,
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> functools <span style="font-weight: bold;">import</span> wraps
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> redirect, url_for, g
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> abort

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login_required</span>(func):
    <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inner</span>(*args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>):
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">elif</span> <span style="font-weight: bold;">not</span> g.user.is_active :
            flash(<span style="font-style: italic;">"&#35813;&#29992;&#25143;&#24050;&#34987;&#31105;&#29992;!"</span>)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> func(*args, **kwargs)

    <span style="font-weight: bold;">return</span> inner

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">permission_required</span>(permission):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">outer</span>(func):
        <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
        <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">inner</span>(*args, **kwargs):
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.has_permission(permission):
                <span style="font-weight: bold;">return</span> func(*args, **kwargs)
            <span style="font-weight: bold;">else</span>:
                <span style="font-weight: bold;">return</span> abort(403)

        <span style="font-weight: bold;">return</span> inner
    <span style="font-weight: bold;">return</span> outer
</pre>
</div>

<p>
现在,所有需要登录或需要登录权限的页面,被禁用的用户都无法访问了.
</p>
</div>
</div>

<div id="outline-container-org1394b85" class="outline-4">
<h4 id="org1394b85">帖子管理</h4>
<div class="outline-text-4" id="text-org1394b85">
<p>
帖子管理也仅仅用于帖子的隐藏和显示,不是编辑用户的帖子.
</p>

<p>
隐藏帖子和禁用用户类似.
</p>


<p>
首先要渲染帖子列表的页面:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, posts=posts)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>

<p>
上面的代码我们新增了 get 方法渲染 cms/posts.html 模板, post 方法用于切换帖子的状
态.
</p>

<p>
现在,访问 <a href="http://127.0.0.1:5000/cms/posts">http://127.0.0.1:5000/cms/posts</a> 可以看到管理帖子的列表页,不过页面没有
分页, 所有数据都在同一页面,可以按照前面首页的帖子列表设置分页,不过我还是准备先把
管理禁用的功能处理了再来实现分页.
</p>

<p>
可以看到每个帖子后面都有一个操作按钮,但是点击没有效果,因为我们没有对它们的点击时
事件绑定任何操作.下面我们就来实现这一点.
</p>

<p>
在 static/cms/js 下面创建一个 posts.js 文件:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    $(<span style="font-style: italic;">".active-btn"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">is_active</span> = parseInt($this.attr(<span style="font-style: italic;">"data-active"</span>));
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = is_active?<span style="font-style: italic;">"hide this post?"</span>:<span style="font-style: italic;">"show this post?"</span>;
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">post_id</span> = $this.attr(<span style="font-style: italic;">"data-post-id"</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
        <span style="font-weight: bold;">if</span> (!result){ <span style="font-weight: bold;">return</span> ;}
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">data</span> = {
            is_active: is_active?0:1
        }
        console.log(data);
        zlajax.post({
            url: <span style="font-style: italic;">"/cms/posts/active/"</span>+post_id,data:data
        }).done(<span style="font-weight: bold;">function</span>(){
            window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                alert(error.message);
            })
    });
});
</pre>
</div>

<p>
这个逻辑和 users.js 中禁用用户的逻辑是一样的,只需要修改 URL 和相关参数即可.下面
还需要在 templates/csm/posts.html 模板中加载这个posts.js 文件:
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#24086;&#23376;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/posts.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21457;&#24067;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#20316;&#32773;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for post in posts %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">target</span>=<span style="font-style: italic;">"_blank"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.post_detail<span style="font-style: italic;">",post_id=post.id) }}"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.author.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if post.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-post-id</span>=<span style="font-style: italic;">"{{ post.id }}"</span>&gt;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-post-id</span>=<span style="font-style: italic;">"{{ post.id }}"</span>&gt;&#21462;&#28040;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}

    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
现在,点击隐藏按钮,就可以实现隐藏帖子的功能了,但是如果此时访问首页查看帖子列表,还
是会看到刚刚已经被隐藏的那个帖子,这是因为在 front.py 的 index 视图函数中,我们没
有针对帖子的 is_active 进行限制,所以我们还需要在 index 视图函数中过滤掉被隐藏的
帖子:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g, redirect, flash
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm, PublicCommentForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>).order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/post/&lt;int:post_id&gt;/comment"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_comment</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">form</span> = PublicCommentForm(request.form)
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
        <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel(content=content, post_id=post_id, author=g.user)
        db.session.add(comment)
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)

    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.post_detail"</span>, post_id = post_id))
</pre>
</div>

<p>
这里的修改只是对查询对象 query_obj 新增了一个 filter_by 函数,来获取 is_active 字
段为 True 的数据.
</p>

<p>
既然都改到 index 视图函数了,顺便看了下分页的代码,再来仿照这个代码给帖子管理的页
面进行分页:
</p>

<p>
在视图函数中返回分页数据:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>
<p>
在模板文件中让分页生效:
</p>


<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#24086;&#23376;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/posts.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26631;&#39064;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21457;&#24067;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#20316;&#32773;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for post in posts %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">target</span>=<span style="font-style: italic;">"_blank"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.post_detail<span style="font-style: italic;">",post_id=post.id) }}"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ post.author.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if post.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-post-id</span>=<span style="font-style: italic;">"{{ post.id }}"</span>&gt;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-post-id</span>=<span style="font-style: italic;">"{{ post.id }}"</span>&gt;&#21462;&#28040;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}

    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
      {{ pagination.links }}
{% endblock %}
</pre>
</div>

<blockquote>
<p>
这个分页的实现确实比较简单,只需要传递 pagination 对象到模板就可以了,看起来都没有
进行后端数据和前端展示的绑定,应该是 Pagination 库进行了相关处理的.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org3b5a8b5" class="outline-4">
<h4 id="org3b5a8b5">评论管理</h4>
<div class="outline-text-4" id="text-org3b5a8b5">
<p>
评论管理的实现逻辑和帖子管理类似,作者让我们自己完成,并提醒我们,在禁用了评论后,帖
子的详情页里也需要过滤掉被禁用的评论.
</p>

<p>
过滤评论的思路应该是和前面过滤的功能思路一样的,但是这里我们获取评论是通过
post.comments 获取的,作者说 post.comments 是一个列表,无法使用 filter_by 方法过滤,所
以需要将原来 CommentModel 模型的 post 属性:
</p>
<pre class="example">
post = db.relationship("PostModel", back_populates="comments")
</pre>
<p>
修改为:
</p>
<pre class="example">
post = db.relationship("PostModel", backref=db.backref("comments", order_by=create_time.desc(), lazy="dynamic"))
</pre>
<p>
但是因为从前面我就用的 back_populates 进行双向绑定, 所以需要自己进行修改. 不过根
据作者说的, post.comments 是从 list 变成 AppenderQuery 对象,从而能使用 filter 或
filter_by 过滤.而且作者提到,非列表类型不能使用 length 过滤器,需要用
AppenderQuery 对象的 count 方法显示评论数量.我需要根据这些提示进行修改.
</p>

<p>
看看评论管理页面的源代码, 评论数据是放在 comments 参数里的:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'cms/base.html' %}

{% block title %}&#35780;&#35770;&#31649;&#29702;{% endblock %}

{% block head %}
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/comments.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
    {{ self.title() }}
{% endblock %}

{% block main_content %}
    &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#20869;&#23481;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21457;&#24067;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25152;&#23646;&#24086;&#23376;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#20316;&#32773;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for comment in comments %}
      &lt;<span style="font-weight: bold;">tr</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ comment.content }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.post_detail',post_id=comment.post.id) }}"</span>&gt;{{ comment.post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          {% if comment.is_active %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span> <span style="font-weight: bold; font-style: italic;">data-comment-id</span>=<span style="font-style: italic;">"{{ comment.id }}"</span>&gt;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-info btn-sm active-btn"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span> <span style="font-weight: bold; font-style: italic;">data-comment-id</span>=<span style="font-style: italic;">"{{ comment.id }}"</span>&gt;&#21462;&#28040;&#38544;&#34255;&lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
首先,编写视图函数渲染评论管理页面以及处理评论的禁用:
</p>
<blockquote>
<p>
因为这里是作者给出了模板文件,模板文件里的基本参数已经写好了,所以我是先看模板文件
再根据模板文件决定视图函数传递哪些参数,如果是从零开始的,我觉得应该是先写视图函数,决
定传递哪些参数,然后再到模板文件中解析这些参数的数据.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>

<p>
访问 <a href="http://127.0.0.1:5000/cms/comments">http://127.0.0.1:5000/cms/comments</a> 可以看到所有评论列表,因为我前面重新生成
了数据,所以评论数据是空的,什么都没有,可以随便找个帖子发几条评论就有数据了.和前面
一样的,点击禁用是没有任何效果的,所以我们需要新增一个 static/cms/js/comments.js
文件,思路和前面的 users.js, posts.js 一样,只是需要修改参数和 URL 即可:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    $(<span style="font-style: italic;">".active-btn"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">is_active</span> = parseInt($this.attr(<span style="font-style: italic;">"data-active"</span>));
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = is_active?<span style="font-style: italic;">"hide this comment?"</span>:<span style="font-style: italic;">"show this comment?"</span>;
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">comment_id</span> = $this.attr(<span style="font-style: italic;">"data-comment-id"</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
        <span style="font-weight: bold;">if</span> (!result){ <span style="font-weight: bold;">return</span> ;}
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">data</span> = {
            is_active: is_active?0:1
        }
        console.log(data);
        zlajax.post({
            url: <span style="font-style: italic;">"/cms/comments/active/"</span> + comment_id ,data:data
        }).done(<span style="font-weight: bold;">function</span>(){
            window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                alert(error.message);
            })
    });
});
</pre>
</div>

<p>
好了,现在我们就可以禁用或取消禁用某条评论了,那么我们就需要在帖子的详情页过滤掉这
些被禁用的评论,因此需要修改 post_detail.html 模板对应的视图函数或模板文件.
</p>

<p>
看看渲染帖子详情页的视图函数:
</p>
<pre class="example">
@bp.get("/post/detail/&lt;int:post_id&gt;")
def post_detail(post_id):
    post = PostModel.query.get(post_id)
    post.read_count += 1
    db.session.commit()
    return render_template("front/post_detail.html", post=post)
</pre>
<p>
发现只是传入了 post 数据,所以评论数据是通过 post.comments 获取的.这一步就是作者
提示的列表类型不能用 filter(_by) 的地方了,查看 post_detail.html 的源代码:
</p>

<pre class="example">
{% for comment in post.comments %}
&lt;li&gt;
  &lt;div class="comment-content"&gt;
    &lt;p class="author-info"&gt;
      &lt;span&gt;{{ comment.author.username }}&lt;/span&gt;
      &lt;span&gt;{{ comment.create_time }}&lt;/span&gt;
    &lt;/p&gt;
    &lt;p class="comment-txt"&gt;
      {{ comment.content }}
    &lt;/p&gt;
  &lt;/div&gt;
&lt;/li&gt;
{% endfor %}
</pre>

<p>
可以看到评论全是通过 post.comments 获取的,到这里我就大致理解作者说的是什么意思了,
</p>

<p>
尝试不修改模型代码,直接使用 filter_by 方法:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments|length }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments.filter_by(is_active=True) %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('front.public_comment', post_id = post.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
访问帖子详情,会出现以下报措:
</p>
<pre class="example" id="orgb1429c7">
jinja2.exceptions.UndefinedError: 'sqlalchemy.orm.collections.InstrumentedList object' has no attribute 'filter_by'
</pre>
<p>
说的是 'sqlalchemy.orm.collections.InstrumentedList' 这种类型的对象没有
filter_by 属性. 搜索文档得到 :
<a href="https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#sqlalchemy.orm.Query.filter_by">https://docs.sqlalchemy.org/en/20/orm/queryguide/query.html#sqlalchemy.orm.Query.filter_by</a>
发现只有 class sqlalchemy.orm.Query 对象才会有 filter_by 方法. 而我们的 comments
属性是  class sqlalchemy.orm.Relationship 类型的对象, 根据作者给出的代码提示,我
们只需要将自己修改的模型中的 comments 关系属性里添加一个 lazy 参数并设置为
"dynamic" 即可将 relationship 转为 query 对象, 当然了,这只是简略的解释,详细的在
<a href="https://docs.sqlalchemy.org/en/20/orm/relationship_api.html#sqlalchemy.orm.relationship.params.lazy">lazy</a> 文档这里.
</p>

<p>
我的理解呢就是 lazy 默认值 select ,表现为不会在创建 Model 对象时就将数据读取到关
系属性中,而是在访问该关系属性时才会加载数据. 而 dynamic 表现为在进行所有读取的操
作时,会返回一个 Query 对象,以便进行下一步的过滤操作,进行过滤操作后,才会返回数据
给读取操作. 就是一个直接返回了数据,所以是一种列表类型, 另一个则是返回一个可供进
一步过滤处理的 Query 对象.
</p>

<p>
下面就来尝试修改:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>, order_by=<span style="font-style: italic;">"desc(CommentModel.create_time)"</span>, lazy=<span style="font-style: italic;">"dynamic"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<p>
因为关系属性不涉及到数据库结构变化,所以不需要迁移数据库,再次访问某个帖子的详情,
得到下列错误信息:
</p>
<pre class="example" id="org698f444">

TypeError: object of type 'AppenderQuery' has no len()

</pre>
<p>
前面的那个报措修复了,这个报措提示我们 AppenderQuery 没有 len() 方法.这就是作者提
到的不能使用 len 过滤器的地方了,所以我们要修改模板里的 len 过滤器为使用 count() 函数.
</p>

<p>
详情页:
</p>
<div class="org-src-container">
<pre class="src src-html">
{% extends 'front/base.html' %}

{% block title %}
  &#24086;&#23376;&#26631;&#39064;
{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/post_detail.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-container"</span>&gt;
      &lt;<span style="font-weight: bold;">h2</span>&gt;<span style="font-weight: bold; font-style: italic; text-decoration: underline;">{{ post.title }}</span>&lt;/<span style="font-weight: bold;">h2</span>&gt;
      &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;&#65306;{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;&#65306;{{ post.author.username }} &lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#25152;&#23646;&#26495;&#22359;&#65306;{{ post.board.name }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#38405;&#35835;&#25968;&#65306;{{ post.read_count }}&lt;/<span style="font-weight: bold;">span</span>&gt;
        &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;&#25968;&#65306;{{ post.comments.count() }}&lt;/<span style="font-weight: bold;">span</span>&gt;
      &lt;/<span style="font-weight: bold;">p</span>&gt;
      &lt;<span style="font-weight: bold;">article</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"post-content"</span>&gt;
        {{ post.content|safe }}
      &lt;/<span style="font-weight: bold;">article</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#35780;&#35770;&#21015;&#34920;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-list-group"</span>&gt;
        {% for comment in post.comments.filter_by(is_active=True) %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-content"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"author-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;{{ comment.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-txt"</span>&gt;
              {{ comment.content }}
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"add-comment-group"</span>&gt;
      &lt;<span style="font-weight: bold;">h3</span>&gt;<span style="font-style: italic; text-decoration: underline;">&#21457;&#34920;&#35780;&#35770;</span>&lt;/<span style="font-weight: bold;">h3</span>&gt;
      &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('front.public_comment', post_id = post.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token()}}"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"content"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"editor"</span> <span style="font-weight: bold; font-style: italic;">cols</span>=<span style="font-style: italic;">"30"</span> <span style="font-weight: bold; font-style: italic;">rows</span>=<span style="font-style: italic;">"5"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comment-btn-group"</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"comment-btn"</span>&gt;&#21457;&#34920;&#35780;&#35770;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">form</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;&lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
首页帖子列表:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "front/base.html" %}

{% block title %}&#30693;&#20102;Python&#35770;&#22363;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='front/css/index.css') }}"</span>&gt;
{% endblock %}

{% block body %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"lg-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-group"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#38050;&#38081;&#26159;&#24590;&#26679;&#28860;&#25104;&#30340;&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: &#24352;&#19977;&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:2021-10-01&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;:0&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% for post in posts %}
        &lt;<span style="font-weight: bold;">li</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info-group"</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-title"</span>&gt;
              &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.post_detail', post_id = post.id) }}"</span>&gt;{{ post.title }}&lt;/<span style="font-weight: bold;">a</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
            &lt;<span style="font-weight: bold;">p</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"post-info"</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#20316;&#32773;: {{ post.author.username }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#21457;&#34920;&#26102;&#38388;:{{ post.create_time }}&lt;/<span style="font-weight: bold;">span</span>&gt;
              &lt;<span style="font-weight: bold;">span</span>&gt;&#35780;&#35770;: {{ post.comments.count() }}&lt;/<span style="font-weight: bold;">span</span>&gt;
            &lt;/<span style="font-weight: bold;">p</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endfor %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
      {{ pagination.links }}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sm-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-bottom:10px;"</span>&gt;
      &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for("</span>front.public_post<span style="font-style: italic;">") }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-warning btn-block"</span>&gt;&#21457;&#24067;&#24086;&#23376;&lt;/<span style="font-weight: bold;">a</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span>&gt;
      {% if current_board %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% else %}
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;&#25152;&#26377;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
      {% endif %}
      {% for board in boards %}
        {% if board.id == current_board %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item active"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% else %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('front.index', board_id=board.id ) }}"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">a</span>&gt;
        {% endif %}
      {% endfor %}
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
{% endblock %}
</pre>
</div>
<p>
修改完成,可以发现被禁用的评论已经不会再显示到详情页面了.
</p>

<blockquote>
<p>
记录一下我自己的两个小疑问:
</p>

<p>
第一, 在解决 has no len() 报措,修改 post_detail.html 模板文件时,发现没有 len()
这个函数,而只有 length 过滤器,愣了一秒,想到了过滤器名称和函数名称并不是必须一样,
这是作者前面自定义 <a href="#org8a499e5">自定义过滤器</a> 部分讲解过的.这个疑问并没有困扰我太多时间是因为
模板文件中只有一个 length ,直接查找 len 就找到了,所以不需要太多思考,直接就想到了
是过滤器名称与过滤器函数名不必须一致的原因.
</p>

<p>
第二, 这里是间隔了几天后才开始的,已经有点忘记前面的内容了,我在写 AJAX 请求禁用评
论时,产生疑惑,这里的视图函数没有用 @csrf.exempt 取消 csrf 防御,又没有在模板中添
加 csrf_token ,怎么没有报措 bad request 参数错误呢? 因为没有报措,所以就没有立刻
去找答案,写了一段代码后,才记起来,早在编写 zlajax.js 文件的时候,我们就已经将 head
标签中的 meta 标签里的 csrf_token 添加到了 ajax 请求的请求头中了,所以后面我们使
用 zlajax.js 发送 ajax 请求都不需要额外添加 csrf_token 参数.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org9b1fc70" class="outline-4">
<h4 id="org9b1fc70">板块管理</h4>
<div class="outline-text-4" id="text-org9b1fc70">
<p>
板块管理的知识也与用户管理类似,作者也让我们读者自己完成了. 不过也给出了要实现的
功能提示:
</p>
<ul class="org-ul">
<li>禁用和取消禁用: 禁用板块后,在首页不应该再渲染该板块,且该板块下的帖子不能再访问.</li>
<li>编辑板块: 只能对板块的名称进行修改.</li>
</ul>


<p>
老样子,先渲染板块管理页面:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )
</pre>
</div>

<p>
访问 <a href="http://127.0.0.1:5000/cms/boards">http://127.0.0.1:5000/cms/boards</a> 可以看到所有板块的信息,每个板块右边都有
"编辑" 和 "删除" 的按钮.
</p>

<p>
当然, "删除" 肯定只是禁用该板块,而不是真正删除该板块以及该板块下的所有帖子数据,
因为数据是有价值的,所以 "删除" 只是将 is_active 设置为 False.
</p>

<p>
而编辑功能的话,可以根据前面作者在员工管理部分编辑员工数据的 edit_staff 来实现类
似的功能,因为作者没有提供 edit_board 模板, 所以我开始还在想是不是可以用 JS 代码
来实现编辑和"删除" 功能,但又想到后面其实还可能会有添加模板的需求,所以还是和员工
管理部分一样新增添加以及编辑的页面好了,这样才是往 "高内聚低耦合" 的方向编码.
</p>

<p>
先来实现 "删除" 功能,这个和用户管理,评论管理的思路是一样的,所以先创建一个视图函
数 active_board 来处理是否"删除"板块:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/active/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    board.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>

<p>
然后新建 boards.js 发送 ajax 请求.
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    $(<span style="font-style: italic;">".active-board-btn"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">is_active</span> = parseInt($this.attr(<span style="font-style: italic;">"data-active"</span>));
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = is_active?<span style="font-style: italic;">"hide this comment?"</span>:<span style="font-style: italic;">"show this comment?"</span>;
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">board_id</span> = $this.attr(<span style="font-style: italic;">"data-board-id"</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
        <span style="font-weight: bold;">if</span> (!result){ <span style="font-weight: bold;">return</span> ;}
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">data</span> = {
            is_active: is_active?0:1
        }
        console.log(data);
        zlajax.post({
            url: <span style="font-style: italic;">"/cms/boards/active/"</span> + board_id ,data:data
        }).done(<span style="font-weight: bold;">function</span>(){
            window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                alert(error.message);
            })
    });
});
</pre>
</div>

<p>
点击板块管理页面中的 "删除" 按钮,发现没有任何变化,查看源代码:
</p>
<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}&#26495;&#22359;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/boards.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"top-box"</span>&gt;
    &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"add-board-btn"</span>&gt;&#28155;&#21152;&#26032;&#26495;&#22359;&lt;/<span style="font-weight: bold;">button</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&#21517;&#31216;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#24086;&#23376;&#25968;&#37327;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21019;&#24314;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for board in boards %}
      &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">data-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.posts|length }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-default btn-sm edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#32534;&#36753;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>
<p>
这个模板竟然是以删除某个板块为目的的,这样的逻辑不好,应该是在和前面类似的"隐藏"的
逻辑上新增一个删除.
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}&#26495;&#22359;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/boards.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"top-box"</span>&gt;
    &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"add-board-btn"</span>&gt;&#28155;&#21152;&#26032;&#26495;&#22359;&lt;/<span style="font-weight: bold;">button</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&#21517;&#31216;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#24086;&#23376;&#25968;&#37327;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21019;&#24314;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for board in boards %}
      &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">data-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.posts|length }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;

          {% if board.is_active %}
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-default btn-sm edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#32534;&#36753;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span>&gt;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-default btn-sm edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#32534;&#36753;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span>&gt;&#21462;&#28040;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<p>
修改后板块管理页面每条数据多出一个隐藏按钮,点击可以切换帖子的 is_active 字段值.然
后还有一个 "删除" 按钮,这个就是真正的 "删除" 整个板块的数据了.
在 blueprints/cms.py 中添加一个删除板块的视图函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/active/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    board.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/delete/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">delete_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">is_active = request.form.get("is_active", type=int)</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">if is_active == None:</span>
    <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">return restful.params_error(message="&#35831;&#20256;&#20837; is_active &#21442;&#25968;!")</span>
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.delete()</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.is_active = bool(is_active)</span>

    db.session.delete(board)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()
</pre>
</div>

<p>
然后在 boards.js 中绑定删除按钮的点击事件:
</p>

<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
    $(<span style="font-style: italic;">".active-board-btn"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">is_active</span> = parseInt($this.attr(<span style="font-style: italic;">"data-active"</span>));
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = is_active?<span style="font-style: italic;">"hide this comment?"</span>:<span style="font-style: italic;">"show this comment?"</span>;
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">board_id</span> = $this.attr(<span style="font-style: italic;">"data-board-id"</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
        <span style="font-weight: bold;">if</span> (!result){ <span style="font-weight: bold;">return</span> ;}
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">data</span> = {
            is_active: is_active?0:1
        }
        console.log(data);
        zlajax.post({
            url: <span style="font-style: italic;">"/cms/boards/active/"</span> + board_id ,data:data
        }).done(<span style="font-weight: bold;">function</span>(){
            window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                alert(error.message);
            })
    });
    $(<span style="font-style: italic;">".delete-board-btn"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
        event.preventDefault();
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">$this</span> = $(<span style="font-weight: bold; text-decoration: underline;">this</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">message</span> = <span style="font-style: italic;">"Delete this Board ?"</span>;
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">board_id</span> = $this.attr(<span style="font-style: italic;">"data-board-id"</span>);
        <span style="font-weight: bold;">var</span> <span style="font-weight: bold; font-style: italic;">result</span> = confirm(message);
        <span style="font-weight: bold;">if</span> (!result){ <span style="font-weight: bold;">return</span> ;}
        zlajax.post({
            url: <span style="font-style: italic;">"/cms/boards/delete/"</span> + board_id
        }).done(<span style="font-weight: bold;">function</span>(){
            window.location.reload();}).fail(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">error</span>){
                alert(error.message);
            })
    });
});
</pre>
</div>

<p>
然后刷新板块管理页面,点击删除按钮,就可以真正删除数据库中的数据了,由于 cascade 级
联操作的参数默认值为 save-update 和 merge, 所以删除板块的操作并不会删除该板块下
的帖子数据,这一是不合逻辑,二是会导致 post 表中该板块下的帖子数据的 board_id 字段
为 NULL, 所以我需要将 BoardModel 中的 posts 关系属性的 cascade 值添加一个
delete, 也可以加一个 delete-orphan .
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>, order_by=<span style="font-style: italic;">"desc(CommentModel.create_time)"</span>, lazy=<span style="font-style: italic;">"dynamic"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<p>
现在,再点击删除板块的按钮,会发现该板块下的帖子数据也一并删除了.
</p>

<p>
我实现了删除板块功能,也在服务器端实现了隐藏板块的功能,还需要在首页以及详情页过滤
掉该板块下的帖子以及该板块自身:
首先,在帖子详情页中,已经被禁用的板块下的帖子是不能被访问的:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g, redirect, flash
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm, PublicCommentForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>).order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    <span style="font-weight: bold;">if</span> post.board.is_active == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#24086;&#23376;&#19981;&#23384;&#22312;!"</span>
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/post/&lt;int:post_id&gt;/comment"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_comment</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">form</span> = PublicCommentForm(request.form)
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
        <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel(content=content, post_id=post_id, author=g.user)
        db.session.add(comment)
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)

    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.post_detail"</span>, post_id = post_id))
</pre>
</div>
<p>
这里的修改只是在 post_detail 里判断了帖子所属板块是否被禁用,如果是,则简单返回一
个提示 "帖子不存在", 刚好我们还没有在首页阻止已被禁用的帖子被渲染,所以我们可以在
首页访问已经被禁用的板块下的帖子,点击进去,就可以看到 "你访问的帖子不存在!" 的内
容了.
</p>

<p>
接着我们就要在首页的帖子列表和板块列表中禁止被禁用的板块及其板块下的帖子被渲染了.
</p>

<blockquote>
<p>
这里就涉及到我从网上搜索学到的新知识了, 虽然我们可以访问 ORM 对象的关系属性来访
问对应的另一个 ORM 对象的数据,但是在 ORM 对象没有真正加载数据之前,也就是它们还处
于 SQL 语句这种状态时(比喻),是不能访问关系属性对应的对象的数据的,而我需要将板块
已经禁用的帖子数据在首页的帖子列表中过滤掉,这就要求我在将帖子数据发送到模板前就
将数据过滤,当然,我也想过直接把数据传递到模板,然后通过 post.board.is_active 进行
判断,然后将禁用的板块下的帖子不渲染,但这样是会影响分页的,而且也很别扭,在我看来模
板里应该只用来简单的解析数据,做数据的展示,应该把数据的处理尽量放在视图函数里. 所
以我尝试了直接使用关系属性 PostModel.board.is_active 但是各种报措,经过搜索,发现
还是前面一样的问题 relationship 只是抽象出的数据库表之间的 "关系", 它们代表的是
根据一些关联字段确定其他表的对应数据的查询语句,因此我们并不能直接像某个属性对象
一样访问 "关联" 的表数据,在解析数据时可以这样访问是因为那时它们已经是读取出来的
数据了,"关系" 也赋值为了它们对应的查询语句的结果数据,所以我们才可以用
post.board.is_active 来读取某条帖子的板块的 is_active 字段的值.但在查询阶段就不
能这样了,当然了想到这里,我就意识到了可以读取出所有帖子数据 posts, 然后遍历它们的
board.is_active 值,因为此时它们已经是数据了,所以可以这样做,但很显然,这样做并不优
雅,而且需要额外的开销来临时存储数据,我的认知告诉我,这样的需求肯定是很常见的,所以
alchemy 库一定有对应的实现, <a href="https://stackoverflow.com/questions/8561470/sqlalchemy-filtering-by-relationship-attribute/69428118#69428118">filtering by relationship attribute</a> 里就提到了好几种
方法,很早的答案使用的是 join 和 has ,这个就很 "原始",更接近与原生的 SQL 语句,抽
象程度并不高,最近的答案里就提到了使用 <a href="https://docs.sqlalchemy.org/en/20/orm/extensions/associationproxy.html#module-sqlalchemy.ext.associationproxy">association proxy</a> (关系代理?) 根据文档的说
明,这个代理是根据 "关系" 可以创建目标属性的读/写的视图,就是说通过这个代理,可以访
问关系对应的模型的某个属性了.
</p>
</blockquote>

<p>
根据查找到的资料,我在帖子模型中新增了一个 board_active 关系代理,通过它可以直接在
查询函数里访问 board 关系属性对应的 BoardModel 的 is_active 字段.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> sqlalchemy.ext.associationproxy <span style="font-weight: bold;">import</span> association_proxy

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>, order_by=<span style="font-style: italic;">"desc(CommentModel.create_time)"</span>, lazy=<span style="font-style: italic;">"dynamic"</span>)

    <span style="font-weight: bold; font-style: italic;">board_active</span> = association_proxy(<span style="font-style: italic;">"board"</span>,<span style="font-style: italic;">"is_active"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<p>
然后我就在 index 视图函数中通过 board_active 过滤掉所属板块已被禁用的帖子数据:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g, redirect, flash
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm, PublicCommentForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">filter</span>(PostModel.board_active==<span style="font-weight: bold; text-decoration: underline;">True</span>).order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    <span style="font-weight: bold;">if</span> post.board.is_active == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#24086;&#23376;&#19981;&#23384;&#22312;!"</span>
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/post/&lt;int:post_id&gt;/comment"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_comment</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">form</span> = PublicCommentForm(request.form)
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
        <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel(content=content, post_id=post_id, author=g.user)
        db.session.add(comment)
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)

    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.post_detail"</span>, post_id = post_id))
</pre>
</div>

<p>
OK, 再次访问首页,可以看到只会显示没有被禁用的帖子数据和板块,尝试将某个板块禁用/
取消禁用,再次访问首页,会发现帖子以及板块数据消失/重新出现.
</p>

<p>
好了,目前已经实现了板块的删除,禁用功能,下面就来实现板块的编辑和新增,编辑只能编辑
板块名称,新增想一下,应该也是只需要一个板块名字而已.实现的思路就照着添加员工和编
辑员工的来.
</p>

<p>
先添加视图函数用来渲染添加版块的页面以及处理添加板块的表单请求:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/active/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    board.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/delete/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">delete_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">is_active = request.form.get("is_active", type=int)</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">if is_active == None:</span>
    <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">return restful.params_error(message="&#35831;&#20256;&#20837; is_active &#21442;&#25968;!")</span>
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.delete()</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.is_active = bool(is_active)</span>

    db.session.delete(board)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/board/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_board</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"/cms/add_board.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">pass</span>
</pre>
</div>

<p>
我不像作者那么熟练,所以一步步来,新增了 add_board 视图函数,接收 GET 和 POST 请求,
目前只实现了 GET 请求的响应功能,渲染添加板块的模板页面,当然了,这个页面作者是没有
提供的,需要我自己仿照 add_staff.html 模板写一个:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends "cms/base.html" %}

{% block title -%}
  &#28155;&#21152;&#26495;&#22359;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">""</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"board-name"</span>&gt;&#26495;&#22359;&#21517;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"board-name"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"name"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#26495;&#22359;&#21517;"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#31435;&#21363;&#28155;&#21152;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span>&gt;
          {% for message in messages %}
          &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
          {% endfor%}
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% endif %}
      {% endwith %}
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后再将添加 "添加新板块" 的按钮换成 a 标签,让它成为添加板块页面的入口链接:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}&#26495;&#22359;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/boards.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"top-box"</span>&gt;
    &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"add-board-btn"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.add_board') }}"</span>&gt;&#28155;&#21152;&#26032;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&#21517;&#31216;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#24086;&#23376;&#25968;&#37327;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21019;&#24314;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for board in boards %}
      &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">data-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.posts|length }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;

          {% if board.is_active %}
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-default btn-sm edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#32534;&#36753;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span>&gt;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-default btn-sm edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;&#32534;&#36753;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span>&gt;&#21462;&#28040;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<blockquote>
<p>
其实好像用 js 绑定 "添加新版快" 这个按钮的点击事件来跳转也应该是可以的,但没必要,
因为在模板里修改,还可以使用 url_for 反转视图函数名得到 URL 链接 ,而在 js 里绑定,(应
该)就只能使用硬编码的 URL 链接了.我有这个想法只是因为我知道这样是可以实现同样功
能的,但我不会(忘了,以前自学过有印象是可以的,而且到现在用了这么多 ajax.post 了,猜
也能猜到有对应的 get 方法的),所以我才考虑这一点是否可行. 只能说是对不确定的事物
总是抱有好奇以及个人来说难以控制的注意偏移.
</p>
</blockquote>

<p>
虽然添加板块只有一个板块名的数据,但它也是从表单提交的,所以还是需要新建表单类,用
来读取和验证表单数据,在 forms/cms.py 中新建 AddBoardForm 类:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField, BooleanField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, InputRequired

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#35282;&#33394;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">EditStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = BooleanField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#26159;&#21542;&#20026;&#21592;&#24037;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#20998;&#32452;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddBoardForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">name</span> = StringField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#26495;&#22359;&#21517;!"</span>)])
</pre>
</div>

<p>
接着就可以在视图函数中用该表单类来读取和验证添加板块的表单提交的数据了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm, AddBoardForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/active/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    board.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/delete/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">delete_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">is_active = request.form.get("is_active", type=int)</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">if is_active == None:</span>
    <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">return restful.params_error(message="&#35831;&#20256;&#20837; is_active &#21442;&#25968;!")</span>
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.delete()</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.is_active = bool(is_active)</span>

    db.session.delete(board)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/board/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_board</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"/cms/add_board.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddBoardForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">name</span> = form.name.data
            <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel(name=name)
            db.session.add(board)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.board_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_board"</span>))
</pre>
</div>

<p>
现在,点击"添加新版块",在添加板块页面输入板块名称,提交,成功后会重定向到板块管理页
面,可以成功看到新添加的板块数据.
</p>

<p>
现在就剩下一个编辑板块的功能实现了,作者提示过,编辑板块只能编辑板块的名称,那实现
也很简单了,一个和添加板块差不多的模板页面,然后新建一个表单类,还有一个渲染编辑页
面和处理表单提交的视图函数.
</p>

<p>
首先是编辑板块的模板页面,
</p>

<div class="org-src-container">
<pre class="src src-html">
{% extends "cms/base.html" %}

{% block title -%}
  &#32534;&#36753;&#26495;&#22359;
{%- endblock %}

{% block head %}
{% endblock %}

{% block page_title -%}
  {{ self.title() }}
{%- endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">form</span> <span style="font-weight: bold; font-style: italic;">action</span>=<span style="font-style: italic;">"{{ url_for('cms.edit_board', board_id=board.id) }}"</span> <span style="font-weight: bold; font-style: italic;">method</span>=<span style="font-style: italic;">"post"</span>&gt;
    &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"hidden"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf_token"</span> <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{csrf_token()}}"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group form-inline"</span>&gt;
        &lt;<span style="font-weight: bold;">label</span> <span style="font-weight: bold; font-style: italic;">for</span>=<span style="font-style: italic;">"board-name"</span>&gt;&#26495;&#22359;&#21517;&#65306;&lt;/<span style="font-weight: bold;">label</span>&gt;
        &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"board-name"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-control"</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"name"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#26495;&#22359;&#21517;"</span>  <span style="font-weight: bold; font-style: italic;">value</span>=<span style="font-style: italic;">"{{ board.name }}"</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit"</span>&gt;&#25552;&#20132;&#20462;&#25913;&lt;/<span style="font-weight: bold;">button</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% with messages = get_flashed_messages() %}
      {% if messages %}
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"form-group"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span>&gt;
          {% for message in messages %}
          &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"text-danger"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">li</span>&gt;
          {% endfor%}
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      {% endif %}
      {% endwith %}
  &lt;/<span style="font-weight: bold;">form</span>&gt;
{% endblock %}
</pre>
</div>

<p>
然后在板块管理的 "编辑" 按钮上添加 "edit_board.html" 页面的超链接:
</p>

<div class="org-src-container">
<pre class="src src-html">{% extends 'cms/base.html' %}

{% block title %}&#26495;&#22359;&#31649;&#29702;{% endblock %}

{% block head %}
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/js/boards.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
{% endblock %}

{% block page_title %}
  {{ self.title() }}
{% endblock %}

{% block main_content %}
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"top-box"</span>&gt;
    &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"add-board-btn"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.add_board') }}"</span>&gt;&#28155;&#21152;&#26032;&#26495;&#22359;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">table</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"table table-bordered"</span>&gt;
    &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#26495;&#22359;&#21517;&#31216;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#24086;&#23376;&#25968;&#37327;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#21019;&#24314;&#26102;&#38388;&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;&#25805;&#20316;&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    &lt;/<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for board in boards %}
      &lt;<span style="font-weight: bold;">tr</span> <span style="font-weight: bold; font-style: italic;">data-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.posts|length }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;{{ board.create_time }}&lt;/<span style="font-weight: bold;">td</span>&gt;
        &lt;<span style="font-weight: bold;">td</span>&gt;

          {% if board.is_active %}
            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.edit_board', board_id=board.id) }}"</span>&gt;&#32534;&#36753;&lt;/<span style="font-weight: bold;">a</span>&gt;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"1"</span>&gt;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% else %}

            &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-primary"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"float:right;"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"edit-board-btn"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.edit_board', board_id=board.id) }}"</span>&gt;&#32534;&#36753;&lt;/<span style="font-weight: bold;">a</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm active-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> <span style="font-weight: bold; font-style: italic;">data-active</span>=<span style="font-style: italic;">"0"</span>&gt;&#21462;&#28040;&#38544;&#34255;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"btn btn-danger btn-sm delete-board-btn"</span> <span style="font-weight: bold; font-style: italic;">data-board-id</span>=<span style="font-style: italic;">"{{ board.id }}"</span>
                  <span style="font-weight: bold; font-style: italic;">data-board-name</span>=<span style="font-style: italic;">"{{ board.name }}"</span> &gt;&#21024;&#38500;
          &lt;/<span style="font-weight: bold;">button</span>&gt;
          {% endif %}
        &lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
    &lt;/<span style="font-weight: bold;">tbody</span>&gt;
  &lt;/<span style="font-weight: bold;">table</span>&gt;
{% endblock %}
</pre>
</div>

<blockquote>
<p>
因为这里和上面的操作基本是一样的,然后我又忘了按照一个固定流程来编码,所以这里先处
理的模板文件,但是模板文件中用了 <code>url_for('cms.edit_board', baord_id=baord.id)</code>
而我们还没有创建 edit_baord 视图函数,所以此时刷新管理板块的页面是会报措的.
</p>
</blockquote>

<p>
然后新建一个 EditBoardForm 表单类:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> .baseform <span style="font-weight: bold;">import</span> BaseForm
<span style="font-weight: bold;">from</span> wtforms <span style="font-weight: bold;">import</span> StringField, IntegerField, BooleanField
<span style="font-weight: bold;">from</span> wtforms.validators <span style="font-weight: bold;">import</span> Email, InputRequired

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">email</span> = StringField(validators=[Email(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#26684;&#24335;&#30340;&#37038;&#31665;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#35282;&#33394;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">EditStaffForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">is_staff</span> = BooleanField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#26159;&#21542;&#20026;&#21592;&#24037;!"</span>)])
    <span style="font-weight: bold; font-style: italic;">role</span> = IntegerField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36873;&#25321;&#20998;&#32452;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">AddBoardForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">name</span> = StringField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#26495;&#22359;&#21517;!"</span>)])

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">EditBoardForm</span>(BaseForm):
    <span style="font-weight: bold; font-style: italic;">name</span> = StringField(validators=[InputRequired(message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#26495;&#22359;&#21517;!"</span>)])
</pre>
</div>

<p>
最后就是新建视图函数 edit_board:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> render_template, g, request, flash, redirect, url_for, current_app
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> PermissionEnum, UserModel, RoleModel
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> PostModel, CommentModel, BoardModel
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> permission_required
<span style="font-weight: bold;">from</span> forms.cms <span style="font-weight: bold;">import</span> AddStaffForm, EditStaffForm, AddBoardForm, EditBoardForm
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"cms"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/cms"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">""</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template((<span style="font-style: italic;">"cms/index.html"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.before_request</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">or</span> g.user.is_staff == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.context_processor</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">cms_context_processor</span>():
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"PermissionEnum"</span>: PermissionEnum}

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/staff/list"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">staff_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/staff_list.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>,<span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_staff</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/add_staff.html"</span>, roles=roles)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user:
                flash(<span style="font-style: italic;">"&#27809;&#26377;&#27492;&#29992;&#25143;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))
            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
            user.<span style="font-weight: bold; font-style: italic;">role</span> = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.staff_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_staff"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/staff/edit/&lt;string:user_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.CMS_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_staff</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">roles</span> = RoleModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_staff.html"</span>, user=user, roles=roles)

    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditStaffForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">is_staff</span> = form.is_staff.data
            <span style="font-weight: bold; font-style: italic;">role_id</span> = form.role.data

            user.<span style="font-weight: bold; font-style: italic;">is_staff</span> = is_staff
            <span style="font-weight: bold;">if</span> user.role.<span style="font-weight: bold;">id</span> != role_id:
                user.<span style="font-weight: bold; font-style: italic;">role</span>  = RoleModel.query.get(role_id)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_staff"</span>, user_id=user_id))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/users"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">user_list</span>():
    <span style="font-weight: bold; font-style: italic;">users</span> = UserModel.query.filter_by(is_staff=<span style="font-weight: bold; text-decoration: underline;">False</span>).<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/users.html"</span>, users=users)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/users/active/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.FRONT_USER)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_user</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    user.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/posts"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.POST)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_list</span>():
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">posts = PostModel.query.all()</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start,end)

    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)
    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"pagination"</span>: pagination
    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/posts.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/posts/active/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_post</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    post.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/comments"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.COMMENT)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">comment_list</span>():
    <span style="font-weight: bold; font-style: italic;">comments</span> = CommentModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/comments.html"</span>, comments=comments)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/comments/active/&lt;int:comment_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_comment</span>(comment_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel.query.get(comment_id)
    comment.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/boards"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">board_list</span>():
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/boards.html"</span>, boards = boards )

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/active/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">active_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">is_active</span> = request.form.get(<span style="font-style: italic;">"is_active"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>)
    <span style="font-weight: bold;">if</span> is_active == <span style="font-weight: bold; text-decoration: underline;">None</span>:
        <span style="font-weight: bold;">return</span> restful.params_error(message=<span style="font-style: italic;">"&#35831;&#20256;&#20837; is_active &#21442;&#25968;!"</span>)
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    board.<span style="font-weight: bold; font-style: italic;">is_active</span> = <span style="font-weight: bold;">bool</span>(is_active)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/boards/delete/&lt;int:board_id&gt;"</span>)
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">delete_board</span>(board_id):
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">is_active = request.form.get("is_active", type=int)</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">if is_active == None:</span>
    <span style="font-weight: bold; font-style: italic;">#    </span><span style="font-weight: bold; font-style: italic;">return restful.params_error(message="&#35831;&#20256;&#20837; is_active &#21442;&#25968;!")</span>
    <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.delete()</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">board.is_active = bool(is_active)</span>

    db.session.delete(board)
    db.session.commit()
    <span style="font-weight: bold;">return</span> restful.ok()

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/board/add"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_board</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"/cms/add_board.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = AddBoardForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">name</span> = form.name.data
            <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel(name=name)
            db.session.add(board)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.board_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.add_board"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/board/edit/&lt;int:board_id&gt;"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@permission_required</span>(PermissionEnum.BOARD)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_board</span>(board_id):
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"cms/edit_board.html"</span>,board=board)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = EditBoardForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">name</span> = form.name.data
            <span style="font-weight: bold; font-style: italic;">board</span> = BoardModel.query.get(board_id)
            board.<span style="font-weight: bold; font-style: italic;">name</span> = name
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.board_list"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"cms.edit_board"</span>, board_id=board.<span style="font-weight: bold;">id</span>))
</pre>
</div>

<p>
刷新页面,点击编辑按钮,输入板块名称,提交,就可以在板块列表里看到板块的名称已经被修
改了.
</p>

<p>
到这里, cms 的所有功能都已经实现了.当然,还有一点小细节,就是左侧导航栏的超链接还
没有实现,以及有些页面是根据作者提供的模板修改的,有的细节没有修改过来.
</p>

<p>
完善导航栏超链接:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"csrf-token"</span> <span style="font-weight: bold; font-style: italic;">content</span>=<span style="font-style: italic;">"{{ csrf_token() }}"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css"</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"{{ url_for('static',filename='common/zlajax.js') }}"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">link</span> <span style="font-weight: bold; font-style: italic;">rel</span>=<span style="font-style: italic;">"stylesheet"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('static',filename='cms/css/base.css') }}"</span>&gt;
  {% block head %}{% endblock %}
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">nav</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar navbar-expand-lg navbar-dark bg-dark"</span>&gt;
  &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-brand"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"#"</span>&gt;&#30693;&#20102;CMS&#31649;&#29702;&#31995;&#32479;&lt;/<span style="font-weight: bold;">a</span>&gt;
  &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler"</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">data-toggle</span>=<span style="font-style: italic;">"collapse"</span> <span style="font-weight: bold; font-style: italic;">data-target</span>=<span style="font-style: italic;">"#navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-controls</span>=<span style="font-style: italic;">"navbarSupportedContent"</span> <span style="font-weight: bold; font-style: italic;">aria-expanded</span>=<span style="font-style: italic;">"false"</span> <span style="font-weight: bold; font-style: italic;">aria-label</span>=<span style="font-style: italic;">"Toggle navigation"</span>&gt;
    &lt;<span style="font-weight: bold;">span</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-toggler-icon"</span>&gt;&lt;/<span style="font-weight: bold;">span</span>&gt;
  &lt;/<span style="font-weight: bold;">button</span>&gt;

  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"collapse navbar-collapse"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"navbarSupportedContent"</span>&gt;
    &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"navbar-nav ml-auto"</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"/"</span>&gt;&#21069;&#21488;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-item"</span>&gt;
        &lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-link"</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('user.logout') }}"</span>&gt;&#36864;&#20986;&#30331;&#24405;&lt;/<span style="font-weight: bold;">a</span>&gt;
      &lt;/<span style="font-weight: bold;">li</span>&gt;
    &lt;/<span style="font-weight: bold;">ul</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">nav</span>&gt;

&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main-body"</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"left-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"sidebar"</span>&gt;
      &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-sidebar"</span>&gt;
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"unfold"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.index') }}"</span>&gt;&#39318;&#39029;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;

        {% with %}
        {% set user = g.user %}
        {% if user.has_permission(PermissionEnum.POST) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group post-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.post_list') }}"</span>&gt;&#24086;&#23376;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.COMMENT) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"comments-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.comment_list') }}"</span>&gt;&#35780;&#35770;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.BOARD) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"board-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.board_list') }}"</span>&gt;&#26495;&#22359;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.FRONT_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group user-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.user_list') }}"</span>&gt;&#29992;&#25143;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% if user.has_permission(PermissionEnum.CMS_USER) %}
        &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"nav-group UserModel-manage"</span>&gt;&lt;<span style="font-weight: bold;">a</span> <span style="font-weight: bold; font-style: italic;">href</span>=<span style="font-style: italic;">"{{ url_for('cms.staff_list') }}"</span>&gt;&#21592;&#24037;&#31649;&#29702;&lt;/<span style="font-weight: bold;">a</span>&gt;&lt;/<span style="font-weight: bold;">li</span>&gt;
        {% endif %}
        {% endwith %}
      &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"right-body"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span>&gt;
      &lt;<span style="font-weight: bold;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">{% block page_title %}{% endblock %}</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main_content"</span>&gt;
        {% block main_content %}{% endblock %}
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
在测试导航栏的超链接时,出现了一个错误,就是评论管理页面报措大致是说某个 None 类型
的对象没有 id 属性,这就表示某个地方没读取到数据,或者没有数据,但之前测试都是好的,
从模板文件到视图函数,再到数据表模型都检察了一遍,没有发现问题,然后想到在完成评论
功能后测试其他功能的时候删除了一些板块和帖子数据的,可能是因为这个,到数据库里检察,果
然,有评论数据对应的帖子被删除了,所以才会出现 None, 把这些测试评论数据删除就不报
措了,但这也告诉了我一个问题,就是帖子被删除了那对应的评论也应该被删除.虽然帖子管
理只有隐藏帖子的功能,但是板块删除时是会将所有该板块的帖子都删除的,如果按照数据库
老师教的知识,这个数据库的涉及目前还是存在问题的,需要让帖子和评论建立一个类似板块
和帖子的关系,只需要在 PostModel 的 comments 关系属性中设置 cascade 即可:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db
<span style="font-weight: bold;">from</span> datetime <span style="font-weight: bold;">import</span> datetime
<span style="font-weight: bold;">from</span> sqlalchemy.ext.associationproxy <span style="font-weight: bold;">import</span> association_proxy

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26495;&#22359;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">BoardModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"board"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = db.Column(db.String(20), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)

    <span style="font-weight: bold; font-style: italic;">posts</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"board"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24086;&#23376;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">PostModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"post"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">title</span> = db.Column(db.String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">read_count</span> = db.Column(db.Integer, default=0)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">board_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"board.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)

    <span style="font-weight: bold; font-style: italic;">board</span> = db.relationship(<span style="font-style: italic;">"BoardModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"posts"</span>)
    <span style="font-weight: bold; font-style: italic;">comments</span> = db.relationship(<span style="font-style: italic;">"CommentModel"</span>, back_populates=<span style="font-style: italic;">"post"</span>, order_by=<span style="font-style: italic;">"desc(CommentModel.create_time)"</span>, lazy=<span style="font-style: italic;">"dynamic"</span>, cascade=<span style="font-style: italic;">"delete, delete-orphan"</span>)

    <span style="font-weight: bold; font-style: italic;">board_active</span> = association_proxy(<span style="font-style: italic;">"board"</span>,<span style="font-style: italic;">"is_active"</span>)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35780;&#35770;&#27169;&#22411;</span>
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">CommentModel</span>(db.Model):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"comment"</span>
    <span style="font-weight: bold;">id</span> = db.Column(db.Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>, autoincrement=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">content</span> = db.Column(db.Text, nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">create_time</span> = db.Column(db.DateTime, default=datetime.now)
    <span style="font-weight: bold; font-style: italic;">is_active</span> = db.Column(db.Boolean, default=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">post_id</span> = db.Column(db.Integer, db.ForeignKey(<span style="font-style: italic;">"post.id"</span>))
    <span style="font-weight: bold; font-style: italic;">author_id</span> = db.Column(db.String(100), db.ForeignKey(<span style="font-style: italic;">"user.id"</span>))

    <span style="font-weight: bold; font-style: italic;">post</span> = db.relationship(<span style="font-style: italic;">"PostModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = db.relationship(<span style="font-style: italic;">"UserModel"</span>, back_populates=<span style="font-style: italic;">"comments"</span>)
</pre>
</div>

<p>
现在,我在某个现存板块下的帖子里发表评论,然后删除该板块,再到评论管理中查看,会发现
刚刚发布的评论也被删除了.
</p>

<p>
到了这里作者提到的基本的功能都已经实现了.
</p>
</div>
</div>
</div>

<div id="outline-container-org716fcd7" class="outline-3">
<h3 id="org716fcd7">错误处理</h3>
<div class="outline-text-3" id="text-org716fcd7">
<p>
网站处理用户的请求时,返回的响应状态码不一定全是 200, 有可能出现存在 URL 不存在的
404 错误, 或者是没有权限的 403 错误等. 针对非 200 的响应码,可以为每个错误状态码
实现一个页面,出现类似错误时, Flask 会自动返回一个包含错误码的页面.
</p>

<p>
添加错误码的处理逻辑是通过 @app.errorhandler 装饰器实现,它也是属于钩子函数的一种.
</p>

<p>
我们可以在 hooks.py 中添加代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> session, g, render_template
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bbs_before_request</span>():
    <span style="font-weight: bold;">if</span> <span style="font-style: italic;">"user_id"</span> <span style="font-weight: bold;">in</span> session:
        <span style="font-weight: bold; font-style: italic;">user_id</span> = session.get(<span style="font-style: italic;">"user_id"</span>)
        <span style="font-weight: bold;">try</span>:
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
            <span style="font-weight: bold;">setattr</span>(g, <span style="font-style: italic;">"user"</span>, user)
        <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span>:
            <span style="font-weight: bold;">pass</span>

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bbs_404_error</span>(error):
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"errors/404.html"</span>), 404

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bbs_401_error</span>(error):
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"errors/401.html"</span>), 401

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">bbs_500_error</span>(error):
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"errors/500.html"</span>), 500
</pre>
</div>

<p>
然后到 app.py 中注册错误处理的钩子函数:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks
<span style="font-weight: bold;">import</span> filters

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-avatar-test-user"</span>)(commands.create_avatar_test_user)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)
app.errorhandler(401)(hooks.bbs_401_error)
app.errorhandler(404)(hooks.bbs_404_error)
app.errorhandler(500)(hooks.bbs_500_error)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#36807;&#28388;&#22120;</span>
app.template_filter(<span style="font-style: italic;">"email_hash"</span>)(filters.email_hash)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>
<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
添加完毕,随便访问一个不存在的 URL 例如: <a href="http://127.0.0.1:5000/abcd">http://127.0.0.1:5000/abcd</a> 就可以看到显
示 404 的错误页面了.
</p>
</div>
</div>

<div id="outline-container-org1684c1f" class="outline-3">
<h3 id="org1684c1f">日志</h3>
<div class="outline-text-3" id="text-org1684c1f">
<p>
日志是一个(商业)网站必备的功能, 日志可以记录网站运行中产生的信息,这些信息包括网
站运行时的异常或用户行为等.
</p>

<ul class="org-ul">
<li>用户相关行为: 登录,退出登录,注册, 找回密码,不正确的密码尝试等.通过日志记录和分
析用户行为,可以提高用户体验以及发现非法登录.</li>
<li>补充数据库记录: 后台用户谁禁用了帖子,谁添加了帖子,这些在数据库中是没有记录的,
可以用日志补充记录.</li>
<li>错误: 程序出现的异常,数据库操作异常,响应了错误状态码等,都可以用日志记录下来,后
期可以根据这些信息优化程序.</li>
</ul>



<p>
Flask 使用了 Python 中内置的 logging 模块. logging 模块有 4 个子模块, 非别是
loogers, handlers, filters 和 formatters .
</p>
</div>

<div id="outline-container-orgc67b2f0" class="outline-4">
<h4 id="orgc67b2f0">loggers模块</h4>
<div class="outline-text-4" id="text-orgc67b2f0">
<p>
loggers 模块是用来创建日志. 在 Flask 中通过 app.logger 可以获取当前的 logger 对
象,然后用 logger.info, logger.debug 等级别创建日志. Python 内置的 logging 模块中,日
志分为 6 个级别:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 20:</span> 日志级别</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">级别名称</td>
<td class="org-right">数值</td>
<td class="org-left">描述</td>
</tr>

<tr>
<td class="org-left">NOTEST</td>
<td class="org-right">0</td>
<td class="org-left">没有设置</td>
</tr>

<tr>
<td class="org-left">DEBUG</td>
<td class="org-right">10</td>
<td class="org-left">调试级别</td>
</tr>

<tr>
<td class="org-left">INFO</td>
<td class="org-right">20</td>
<td class="org-left">信息级别</td>
</tr>

<tr>
<td class="org-left">WARNING/WARN</td>
<td class="org-right">30</td>
<td class="org-left">警告级别</td>
</tr>

<tr>
<td class="org-left">ERROR</td>
<td class="org-right">40</td>
<td class="org-left">普通错误级别</td>
</tr>

<tr>
<td class="org-left">CRITICAL/FATAL</td>
<td class="org-right">50</td>
<td class="org-left">致命错误级别</td>
</tr>
</tbody>
</table>

<p>
记录日志时,只会记录比当前级别高的日志. 例如,日志设置为 INFO , 则 DEBUG 级别的
logger.debug 不会产生日志记录. Flask 中默认的日志级别为 DEBUG, 如果需要修改日志
级别,可以通过 app.logger.setLevel 修改. 例如修改为 INFO 级别:
<code>app.logger.setLevel(logging.INFO)</code>
</p>

<p>
我们在 blueprints/fornt.py 中的 index 视图函数中添加一条测试日志:
<code>current_app.logger.info("index 页面被请求了")</code>
</p>

<p>
在浏览器中访问首页后,运行项目的终端会显示该日志信息.
</p>
</div>
</div>

<div id="outline-container-org996c933" class="outline-4">
<h4 id="org996c933">handlers模块</h4>
<div class="outline-text-4" id="text-org996c933">
<p>
handlers 模块用来指定日志被定向到何处. Flask 中默认是定向到控制台(终端)打印日志
消息. 如果要定向到文件,就用 FileHandler 或 RotatingFileHandler; 如果要用邮箱发送
日志,就用 SMTPHandler.
</p>

<blockquote>
<p>
logging 模块支持的所有 handler 可以参阅 Python 的官方文档
<a href="https://docs.python.org/3/library/logging.handlers.html">https://docs.python.org/3/library/logging.handlers.html</a> 中的 logging 模块.
</p>
</blockquote>

<p>
如果需要定向日志到文件,可以给 app.logger 再添加一个 handler:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">file_handler</span> = logging.FileHandler(<span style="font-style: italic;">"pythonbbs.log"</span>, encoding=<span style="font-style: italic;">"utf-8"</span>)
app.logger.addHandler(file_handler)
</pre>
</div>
<p>
添加后,在请求项目首页时就可以看到,除了控制台(终端) 显示了日志信息,还会在项目根目
录下生成一个 pythonbbs.log 文件,里面也有日志信息. 如果不想要打印 Flask 默认的控
制台下的日志信息,可以通过下面代码移除:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask.logging <span style="font-weight: bold;">import</span> default_handler
app.logger.removeHandler(default_handler)
</pre>
</div>

<p>
FileHandler 会把所有日志文件打印在一个文件中,随着网站不断运行,这个日志文件会不断
变大. 商业项目中可以使用 RotatingFileHandler 或 TimeRotatingFileHandler,
RotatingFileHandler 可以指定文件大小,超过大小限制时就会自动开启一个新的日志文件.
TimeRotatingFileHandler 则根据时间判断是否要开启下一个新的日志文件.
</p>

<ul class="org-ul">
<li>RotatingFileHandler(finename, maxBytes=0, backupCount=0): 当 maxBytes 大于等于
0 时,如果文件大小超过 maxBytes 就会创建一个新的文件, 新日志文件以 filename 为
基本名称,并在后面加上 ".1", ".2" 等. 例如, filename 的值为 app.log, 则新的日志
文件为 app.log.1 , app.log.2 等. backupCount 指定最多创建多少个文件, 只有当
backupCount 大于等于1 时,才会产生新的文件, RotatingFileHandler 写入日志的逻辑:
先写入 filename 指定的文件中,如, app.log, 如果 app.log 的大小接近 maxBytes 则
将 app.log 重命名为 app.log.1, 然后创建新的 app.log 用于写入日志.</li>
<li><p>
TimeRotatingFileHandler(filename, when, interval=1, backupCount=0): when 用于
指定按照什么时间单位创建新的日志文件, when 可以取值:
</p>
<ul class="org-ul">
<li>S: 按照秒为单位</li>
<li>M: 按照分钟为单位</li>
<li>H: 按照小时为单位</li>
<li>D: 按照天为单位</li>
<li>midnight: 按照半夜 12 点为单位</li>
<li>W{0-6}: 按照星期为单位, W0 为星期一.</li>
</ul>

<p>
interval 表示等待多少个单位 when 的时间后创建新的日志文件. 创建文件的规则与
RotatingFileHandler 类似, 如果 backupCount 不为0, 则最多保留 backupCount 个文
件,如果超过 backupCount 个文件,则最旧的文件会被删除.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org52bc74b" class="outline-4">
<h4 id="org52bc74b">filters 模块</h4>
<div class="outline-text-4" id="text-org52bc74b">
<p>
filters 模块是用来给 Logger 和 Handler 提供过滤器的, 只有过滤器返回 True 的日志
才会被记录, 先执行 Logger 的过滤器,再执行 Handler 的过滤器.
</p>

<p>
给 Logger 添加过滤器的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">stringFilter</span>(logging.Filter):
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">filter</span>(<span style="font-weight: bold;">self</span>, record):
        <span style="font-weight: bold;">if</span> record.msg.startwith(<span style="font-style: italic;">"abc"</span>):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>

app.logger.addFilter(stringFilter())
app.logger.info(<span style="font-style: italic;">"abc-test"</span>)
app.logger.info(<span style="font-style: italic;">"123-test"</span>)
</pre>
</div>
<p>
这段示例代码,因为在 app.logger 中添加了 stringFilter 过滤器,会过滤掉以 abc 开头
的日志,只会记录 123-test 这条日志信息,而不会记录 abc-test. 其中 filter 方法的
record 参数为 logging.LogRecord 对象.
</p>
</div>
</div>

<div id="outline-container-org79c4fba" class="outline-4">
<h4 id="org79c4fba">formatters 模块</h4>
<div class="outline-text-4" id="text-org79c4fba">
<p>
formatters 模块用来指定日志记录的格式. logging 模块内置了一些变量, 我们在定义格
式时可以直接使用.变量的说明如下:
</p>

<dl class="org-dl">
<dt><code>%(asctime)s</code></dt><dd>日志被创建的时间.</dd>
<dt><code>%(filename)s</code></dt><dd>被创建的日志所在的文件.</dd>
<dt><code>%(funcName)s</code></dt><dd>被创建的日志所在的函数.</dd>
<dt><code>%(levelname)s</code></dt><dd>被创建的日志的级别.</dd>
<dt><code>%(lineno)d</code></dt><dd>被创建的日志所在文件的代码行号.</dd>
<dt><code>%(message)s</code></dt><dd>日志文本的内容.</dd>
<dt><code>%(module)s</code></dt><dd>被创建的日志所在的模块.</dd>
</dl>


<p>
使用上面的变量,我们可以灵活组合出自己想要的日志格式. 完整的使用示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> logging
<span style="font-weight: bold;">from</span> flask.logging <span style="font-weight: bold;">import</span> default_handler
<span style="font-weight: bold;">from</span> logging.handlers <span style="font-weight: bold;">import</span> RotatingFileHandler

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31227;&#38500; Flask &#33258;&#24102;&#30340; handler</span>
app.logger.removeHandler(default_handler)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314;&#19968;&#20010; RotatingFileHandler &#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">file_handler</span> = RotatingFileHandler(<span style="font-style: italic;">"pythonbbs.log"</span>, maxBytes=16384, backupCount=20)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622; handler &#32423;&#21035;&#20026; INFO</span>
file_handler.setLevel(logging.INFO)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#26085;&#24535;&#35760;&#24405;&#30340;&#26684;&#24335;</span>
<span style="font-weight: bold; font-style: italic;">file_formatter</span> = logging.Formatter(<span style="font-style: italic;">"%(asctime)s %(levelname)s:%(message)s [in %(filename)s: %(lineno)d]"</span>)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23558;&#26085;&#24535;&#26684;&#24335;&#23545;&#35937;&#28155;&#21152;&#21040; handler &#20013;</span>
file_handler.setFormatter(file_formatter)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23558; handler &#28155;&#21152;&#21040; app.logger &#20013;</span>
app.logger.addHandler(file_handler)
</pre>
</div>


<p>
作者并没有给出实际项目中的代码,所以我需要自己实现日志记录相关的功能.
</p>

<p>
根据作者的描述, 日志是用来记录额外的信息用的, 所以我尝试在用户模块完成日志功能.
</p>

<p>
用户的登录,退出登录,密码错误等操作在 Flask 中是默认不会被记录的, Flask 默认的日
志只会记录网络请求,服务器的响应以及程序的运行异常信息,所以关于用户登录成功,密码
错误登录失败,以及退出登录的操作 Flask 是不会记录的,所以这些就是我需要完成的.
</p>

<p>
首先,我想要日志除了打印到终端外还保存到文件中, 所以我需要给 app 添加一个
FileHandler :
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks
<span style="font-weight: bold;">import</span> filters
<span style="font-weight: bold;">import</span> logging
<span style="font-weight: bold;">from</span> flask.logging <span style="font-weight: bold;">import</span> default_handler
<span style="font-weight: bold;">from</span> logging <span style="font-weight: bold;">import</span> FileHandler


<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-avatar-test-user"</span>)(commands.create_avatar_test_user)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)
app.errorhandler(401)(hooks.bbs_401_error)
app.errorhandler(404)(hooks.bbs_404_error)
app.errorhandler(500)(hooks.bbs_500_error)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#36807;&#28388;&#22120;</span>
app.template_filter(<span style="font-style: italic;">"email_hash"</span>)(filters.email_hash)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>

app.logger.setLevel(logging.INFO)
<span style="font-weight: bold; font-style: italic;">log_file_handler</span> = FileHandler(<span style="font-style: italic;">"pythonbbs.log"</span>, encoding=<span style="font-style: italic;">"utf-8"</span>)
app.logger.addHandler(log_file_handler)
app.logger.error(<span style="font-style: italic;">"&#27979;&#35797;&#19968;&#26465;&#38169;&#35823;&#32423;&#21035;&#30340;&#26085;&#24535;"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
然后在 blueprints/front.py 中对首页的请求添加一条测试的日志信息:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, request, render_template, current_app, url_for, jsonify, g, redirect, flash
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> models.post <span style="font-weight: bold;">import</span> BoardModel, PostModel, CommentModel
<span style="font-weight: bold;">from</span> forms.post <span style="font-weight: bold;">import</span> PublicPostForm, PublicCommentForm
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> csrf, db
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> flask_paginate <span style="font-weight: bold;">import</span> Pagination
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"front"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">""</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    current_app.logger.info(<span style="font-style: italic;">"index &#39029;&#38754;&#34987;&#35831;&#27714;&#20102;!"</span>)
    <span style="font-weight: bold; font-style: italic;">posts</span> = PostModel.query.<span style="font-weight: bold;">all</span>()
    <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#39029;&#30721;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">page</span> = request.args.get(<span style="font-style: italic;">"page"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=1)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;: &#33719;&#21462;&#26495;&#22359;&#21442;&#25968;</span>
    <span style="font-weight: bold; font-style: italic;">board_id</span> = request.args.get(<span style="font-style: italic;">"board_id"</span>, <span style="font-weight: bold;">type</span>=<span style="font-weight: bold;">int</span>, default=0)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#36215;&#22987;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">start</span> = (page - 1) * current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#32467;&#26463;&#20301;&#32622;</span>
    <span style="font-weight: bold; font-style: italic;">end</span> = start + current_app.config.get(<span style="font-style: italic;">"PER_PAGE_COUNT"</span>)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26597;&#35810;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">query_obj</span> = PostModel.query.filter_by(is_active=<span style="font-weight: bold; text-decoration: underline;">True</span>).<span style="font-weight: bold;">filter</span>(PostModel.board_active==<span style="font-weight: bold; text-decoration: underline;">True</span>).order_by(PostModel.create_time.desc())
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:&#36807;&#28388;&#24086;&#23376;</span>
    <span style="font-weight: bold;">if</span> board_id:
        <span style="font-weight: bold; font-style: italic;">query_obj</span> = query_obj.filter_by(board_id=board_id)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24635;&#20849;&#22810;&#23569;&#24086;&#23376;</span>
    <span style="font-weight: bold; font-style: italic;">total</span> = query_obj.count()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24403;&#21069; page &#19979;&#30340;&#24086;&#23376;&#21015;&#34920;</span>
    <span style="font-weight: bold; font-style: italic;">posts</span> = query_obj.<span style="font-weight: bold;">slice</span>(start, end)

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20998;&#39029;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">pagination</span> = Pagination(bs_version=4, page=page, total=total, outer_window=0,inner_window=2, alignment=<span style="font-style: italic;">"center"</span>)

    <span style="font-weight: bold; font-style: italic;">context</span> = {
        <span style="font-style: italic;">"posts"</span>: posts,
        <span style="font-style: italic;">"boards"</span>: boards,
        <span style="font-style: italic;">"pagination"</span>: pagination,
        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26032;&#22686;:</span>
        <span style="font-style: italic;">"current_board"</span>: board_id

    }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/index.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/post/public"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_post</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold; font-style: italic;">boards</span> = BoardModel.query.<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/public_post.html"</span>, boards=boards)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = PublicPostForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">title</span> = form.title.data
            <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
            <span style="font-weight: bold; font-style: italic;">board_id</span> = form.board_id.data
            <span style="font-weight: bold; font-style: italic;">post</span> = PostModel(title=title,content=content,board_id=board_id,author=g.user)
            db.session.add(post)
            db.session.commit()
            <span style="font-weight: bold;">return</span> restful.ok()
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold; font-style: italic;">message</span> = form.messages[0]
            <span style="font-weight: bold;">return</span> restful.params_error(message=message)


<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/upload/image"</span>)
<span style="font-weight: bold; text-decoration: underline;">@csrf.exempt</span>
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">upload_image</span>():
    <span style="font-weight: bold; font-style: italic;">f</span> = request.files.get(<span style="font-style: italic;">"image"</span>)
    <span style="font-weight: bold; font-style: italic;">extension</span> = f.filename.split(<span style="font-style: italic;">"."</span>)[-1].lower()
    <span style="font-weight: bold;">if</span> extension <span style="font-weight: bold;">not</span> <span style="font-weight: bold;">in</span> [<span style="font-style: italic;">"jpg"</span>,<span style="font-style: italic;">"gif"</span>,<span style="font-style: italic;">"png"</span>,<span style="font-style: italic;">"jpeg"</span> ]:
        <span style="font-weight: bold;">return</span> jsonify(
            {<span style="font-style: italic;">"errno"</span>: 400,
             <span style="font-style: italic;">"data"</span>: []
            })
    <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(f.filename)
    f.save(os.path.join(current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>), filename))
    <span style="font-weight: bold; font-style: italic;">url</span> = url_for(<span style="font-style: italic;">"front.uploaded_image"</span>, filename=filename)
    <span style="font-weight: bold;">return</span> jsonify(
        {
            <span style="font-style: italic;">"errno"</span>: 0,
            <span style="font-style: italic;">"data"</span>: [{
                <span style="font-style: italic;">"url"</span>: url,
                <span style="font-style: italic;">"alt"</span>: <span style="font-style: italic;">""</span>,
                <span style="font-style: italic;">"href"</span>: <span style="font-style: italic;">""</span>
            }]
        })

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_image</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"UPLOAD_IMAGE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/post/detail/&lt;int:post_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">post_detail</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">post</span> = PostModel.query.get(post_id)
    <span style="font-weight: bold;">if</span> post.board.is_active == <span style="font-weight: bold; text-decoration: underline;">False</span>:
        <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"&#20320;&#35775;&#38382;&#30340;&#24086;&#23376;&#19981;&#23384;&#22312;!"</span>
    post.<span style="font-weight: bold; font-style: italic;">read_count</span> += 1
    db.session.commit()
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/post_detail.html"</span>, post=post)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/post/&lt;int:post_id&gt;/comment"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">public_comment</span>(post_id):
    <span style="font-weight: bold; font-style: italic;">form</span> = PublicCommentForm(request.form)
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">content</span> = form.content.data
        <span style="font-weight: bold; font-style: italic;">comment</span> = CommentModel(content=content, post_id=post_id, author=g.user)
        db.session.add(comment)
        db.session.commit()
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)

    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.post_detail"</span>, post_id = post_id))
</pre>
</div>

<p>
就可以在终端以及 pythonbbs.log 文件中看到测试日志信息了.
</p>

<blockquote>
<p>
另外,作者在 <a href="#orgc67b2f0">loggers模块</a> 提到 Flask 默认日志级别是 DEBUG, 但实际上 logger 不能简
单认为某个项目的日志级别, logger 是有 "层级" 的, 最高层级的 logger 是 root
logger, 而这个 logger 的日志层级是 NOTSET , 只有显式设置了之后 root logger 才会
被设置为其他层级(就是说 logger 类不设置日志级别则为 NOTSET, 这是自定义 logger 类
时需要用到的知识, 而使用 python 提供的库则是已经设置好的),而 Flask 使用的就是标
准的 python 提供的 logging 库,它默认是 WARNING 级别的日志,所以作者这里说 Flask
默认是 DEBUG 级别的日志就是错误的,之所以我会发现,就是因为作者说默认是 DEBUG, 那
我记录 INFO 级别的日志是应该会被记录的,结果却没有日志记录,作者没有发现,可能是因
为他使用 <code>app.logger.setLevel(logging.INFO)</code> 设置了日志级别,所以没有异常,导致作
者没有发现这个错误,但我根据作者的描述,觉得既然默认 DEBUG ,那我生成一条 INFO 级别
的日志就不需要这条代码,所以初步我是没有这一条语句的,结果才能发现作者这里的错误.
</p>
</blockquote>

<p>
现在我就可以在 blueprints/user.py 中实现用户登录相关操作的日志记录了:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Blueprint, render_template, request, current_app, redirect, url_for, flash, session, g, send_from_directory
<span style="font-weight: bold;">from</span> werkzeug.utils <span style="font-weight: bold;">import</span> secure_filename
<span style="font-weight: bold;">from</span> werkzeug.datastructures <span style="font-weight: bold;">import</span> CombinedMultiDict
<span style="font-weight: bold;">from</span> flask_mail <span style="font-weight: bold;">import</span> Message
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span>  cache, db
<span style="font-weight: bold;">from</span> utils <span style="font-weight: bold;">import</span> restful
<span style="font-weight: bold;">from</span> forms.user <span style="font-weight: bold;">import</span> RegisterForm, LoginForm, EditProfileForm
<span style="font-weight: bold;">from</span> models.user <span style="font-weight: bold;">import</span> UserModel
<span style="font-weight: bold;">import</span> random
<span style="font-weight: bold;">import</span> hashlib
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">import</span> os

<span style="font-weight: bold; font-style: italic;">bp</span> = Blueprint(<span style="font-style: italic;">"user"</span>, <span style="font-weight: bold;">__name__</span>, url_prefix=<span style="font-style: italic;">"/user"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/register"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">register</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/register.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = RegisterForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel(email=email, username=username,password=password)
            db.session.add(user)
            db.session.commit()
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.register"</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/login"</span>, methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">form</span> = LoginForm(request.form)
        <span style="font-weight: bold;">if</span> form.validate():
            <span style="font-weight: bold; font-style: italic;">email</span> = form.email.data
            <span style="font-weight: bold; font-style: italic;">password</span> = form.password.data
            <span style="font-weight: bold; font-style: italic;">remember</span> = form.remember.data
            <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.filter_by(email=email).first()
            <span style="font-weight: bold;">if</span> user <span style="font-weight: bold;">and</span> user.check_password(password):
                <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> user.is_active:
                    flash(<span style="font-style: italic;">"&#35813;&#29992;&#25143;&#24050;&#32463;&#34987;&#31105;&#29992;!"</span>)
                    <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
                <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">'user_id'</span>] = user.<span style="font-weight: bold;">id</span>
                <span style="font-weight: bold;">if</span> remember:
                    session.<span style="font-weight: bold; font-style: italic;">permanent</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
                current_app.logger.info(<span style="font-style: italic;">"{} &#30331;&#24405;&#25104;&#21151;!,ID:{}"</span>.<span style="font-weight: bold;">format</span>(user.username,user.<span style="font-weight: bold;">id</span>))
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"front.index"</span>))
            <span style="font-weight: bold;">else</span>:
                current_app.logger.info(<span style="font-style: italic;">"{} &#30331;&#24405;&#22833;&#36133;!,ID:{}"</span>.<span style="font-weight: bold;">format</span>(user.username,user.<span style="font-weight: bold;">id</span>))
                flash(<span style="font-style: italic;">"&#37038;&#31665;&#25110;&#23494;&#30721;&#38169;&#35823;!"</span>)
                <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.login"</span>))
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
                flash(message)
            <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/login.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@bp.route</span>(<span style="font-style: italic;">"/mail/captcha"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">mail_captcha</span>():
    <span style="font-weight: bold;">try</span>:
        <span style="font-weight: bold; font-style: italic;">email</span> = request.args.get(<span style="font-style: italic;">"mail"</span>)
        <span style="font-weight: bold; font-style: italic;">digits</span> = [<span style="font-style: italic;">"0"</span>,<span style="font-style: italic;">"1"</span>,<span style="font-style: italic;">"2"</span>,<span style="font-style: italic;">"3"</span>,<span style="font-style: italic;">"4"</span>,<span style="font-style: italic;">"5"</span>,<span style="font-style: italic;">"6"</span>,<span style="font-style: italic;">"7"</span>,<span style="font-style: italic;">"8"</span>,<span style="font-style: italic;">"9"</span>]
        <span style="font-weight: bold; font-style: italic;">captcha</span> = <span style="font-style: italic;">""</span>.join(random.sample(digits, 4))
        <span style="font-weight: bold; font-style: italic;">body</span> = <span style="font-style: italic;">"&lt;h1&gt;pythonbbs&lt;/h1&gt;</span><span style="font-weight: bold; text-decoration: underline;">\n</span><span style="font-style: italic;">  &#27880;&#20876;&#39564;&#35777;&#30721;&#26159;: {},&#35831;&#19981;&#35201;&#21578;&#35785;&#20182;&#20154;!"</span>.<span style="font-weight: bold;">format</span>(captcha)
        <span style="font-weight: bold; font-style: italic;">subject</span> = <span style="font-style: italic;">"pythonbbs &#37038;&#20214;&#39564;&#35777;&#30721;"</span>,
        current_app.celery.send_task(<span style="font-style: italic;">"send_mail"</span>, (email, subject, body))
        cache.<span style="font-weight: bold;">set</span>(email, captcha, timeout=100)
        <span style="font-weight: bold;">return</span> restful.ok()
    <span style="font-weight: bold;">except</span> <span style="font-weight: bold; text-decoration: underline;">Exception</span> <span style="font-weight: bold;">as</span> e:
        <span style="font-weight: bold;">print</span>(e)
        <span style="font-weight: bold;">return</span> restful.server_error()


<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/profile/&lt;string:user_id&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">profile</span>(user_id):
    <span style="font-weight: bold; font-style: italic;">user</span> = UserModel.query.get(user_id)
    <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">False</span>
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">hasattr</span>(g, <span style="font-style: italic;">"user"</span>) <span style="font-weight: bold;">and</span> g.user.<span style="font-weight: bold;">id</span> == user_id:
        <span style="font-weight: bold; font-style: italic;">is_mine</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">email_hash = hashlib.md5(user.email.lower().encode("utf-8")).hexdigest()</span>
    <span style="font-weight: bold; font-style: italic;">context</span> = {<span style="font-style: italic;">"user"</span>: user,
               <span style="font-style: italic;">"is_mine"</span>: is_mine,
               <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">"email_hash": email_hash</span>
               }
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"front/profile.html"</span>, **context)

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/logout"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">logout</span>():
    current_app.logger.info(<span style="font-style: italic;">"&#36864;&#20986;&#30331;&#24405;!,ID:{}"</span>.<span style="font-weight: bold;">format</span>(session[<span style="font-style: italic;">"user_id"</span>]))
    session.clear()
    <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/"</span>)

<span style="font-weight: bold; text-decoration: underline;">@bp.post</span>(<span style="font-style: italic;">"/profile/edit"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">edit_profile</span>():
    <span style="font-weight: bold; font-style: italic;">form</span> = EditProfileForm(CombinedMultiDict([request.form, request.files]))
    <span style="font-weight: bold;">if</span> form.validate():
        <span style="font-weight: bold; font-style: italic;">username</span> = form.username.data
        <span style="font-weight: bold; font-style: italic;">avatar</span> = form.avatar.data
        <span style="font-weight: bold; font-style: italic;">signature</span> = form.signature.data

        <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22914;&#26524;&#19978;&#20659;&#20102;&#38957;&#20687;</span>
        <span style="font-weight: bold;">if</span> avatar:
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#29983;&#25104;&#23433;&#20840;&#30340;&#25991;&#20214;&#21517;</span>
            <span style="font-weight: bold; font-style: italic;">filename</span> = secure_filename(avatar.filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25340;&#25509;&#22836;&#20687;&#23384;&#20648;&#36335;&#24452;</span>
            <span style="font-weight: bold; font-style: italic;">avatar_path</span> = os.path.join(current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>), filename)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20445;&#23384;&#25991;&#20214;</span>
            avatar.save(avatar_path)
            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#22836;&#20687; URL</span>
            g.user.<span style="font-weight: bold; font-style: italic;">avatar_l</span> = url_for(<span style="font-style: italic;">"user.uploaded_avatar"</span>, filename=filename)
        g.user.<span style="font-weight: bold; font-style: italic;">username</span> = username
        g.user.<span style="font-weight: bold; font-style: italic;">signature</span> = signature
        db.session.commit()
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold;">for</span> message <span style="font-weight: bold;">in</span> form.messages:
            flash(message)
        <span style="font-weight: bold;">return</span> redirect(url_for(<span style="font-style: italic;">"user.profile"</span>, user_id=g.user.<span style="font-weight: bold;">id</span>))

<span style="font-weight: bold; text-decoration: underline;">@bp.get</span>(<span style="font-style: italic;">"/image/avatar/&lt;path:filename&gt;"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">uploaded_avatar</span>(filename):
    <span style="font-weight: bold; font-style: italic;">path</span> = current_app.config.get(<span style="font-style: italic;">"AVATARS_SAVE_PATH"</span>)
    <span style="font-weight: bold;">return</span> send_from_directory(path, filename)
</pre>
</div>

<p>
在上面这次修改中,我在登录成功,登录失败,以及退出登录的对应代码中添加了日志记录的
信息. 测试后可以发现这些日志信息都正常显示在终端和记录在日志文件中了.
但是它们只记录我的日志信息,没有记录相关时间.这是因为我们没有为设置新增的 handler
的 formatter, 所以日志信息只会以原本的日志信息格式记录. 我们通常看到的有文件,时
间,代码行数等额外信息的日志信息是因为它们都设置了统一的日志格式.所以我也需要为其
添加格式:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_migrate <span style="font-weight: bold;">import</span> Migrate
<span style="font-weight: bold;">from</span> flask_wtf <span style="font-weight: bold;">import</span> CSRFProtect
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask
<span style="font-weight: bold;">from</span> models <span style="font-weight: bold;">import</span> user
<span style="font-weight: bold;">from</span> exts <span style="font-weight: bold;">import</span> db, mail, cache, csrf, avatars
<span style="font-weight: bold;">from</span> blueprints.cms <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> cms_bp
<span style="font-weight: bold;">from</span> blueprints.front <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> front_bp
<span style="font-weight: bold;">from</span> blueprints.user <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> user_bp
<span style="font-weight: bold;">from</span> blueprints.media <span style="font-weight: bold;">import</span> bp <span style="font-weight: bold;">as</span> media_bp
<span style="font-weight: bold;">from</span> bbs_celery <span style="font-weight: bold;">import</span> make_celery
<span style="font-weight: bold;">import</span> click
<span style="font-weight: bold;">import</span> config
<span style="font-weight: bold;">import</span> commands
<span style="font-weight: bold;">import</span> hooks
<span style="font-weight: bold;">import</span> filters
<span style="font-weight: bold;">import</span> logging
<span style="font-weight: bold;">from</span> flask.logging <span style="font-weight: bold;">import</span> default_handler
<span style="font-weight: bold;">from</span> logging <span style="font-weight: bold;">import</span> FileHandler


<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#37197;&#32622;</span>
app.config.from_object(config.DevelopmentConfig)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#24320;&#21551; CSRF &#20445;&#25252;, &#20462;&#25913;&#20026;&#20102; csrf.init_app(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">CSRFProtect(app)</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36830;&#25509;</span>
db.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270;&#25968;&#25454;&#24211;&#36801;&#31227;&#23545;&#35937;</span>
<span style="font-weight: bold; font-style: italic;">migrate</span> = Migrate(app, db)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; Flask-Mail &#23545;&#35937;</span>
mail.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; &#32531;&#23384;&#23545;&#35937;</span>
cache.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; csrf &#23545;&#35937;</span>
csrf.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21021;&#22987;&#21270; avatars</span>
avatars.init_app(app)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26500;&#24314; celery</span>
<span style="font-weight: bold; font-style: italic;">celery</span> = make_celery(app)


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#27880;&#20876;&#34013;&#22270;</span>

app.register_blueprint(cms_bp)
app.register_blueprint(front_bp)
app.register_blueprint(user_bp)
app.register_blueprint(media_bp)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-permission"</span>)(commands.create_permission)
app.cli.command(<span style="font-style: italic;">"create-role"</span>)(commands.create_role)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#27979;&#35797;&#29992;&#25143;</span>
app.cli.command(<span style="font-style: italic;">"create-test-user"</span>)(commands.create_test_user)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#31649;&#29702;&#21592;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-admin"</span>)(commands.create_admin)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#26495;&#22359;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-board"</span>)(commands.create_board)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#27979;&#35797;&#24086;&#23376;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-test-post"</span>)(commands.create_test_post)
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29983;&#25104;&#22836;&#20687;&#27979;&#35797;&#29992;&#25143;&#30340;&#21629;&#20196;</span>
app.cli.command(<span style="font-style: italic;">"create-avatar-test-user"</span>)(commands.create_avatar_test_user)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#38057;&#23376;&#20989;&#25968;</span>
app.before_request(hooks.bbs_before_request)
app.errorhandler(401)(hooks.bbs_401_error)
app.errorhandler(404)(hooks.bbs_404_error)
app.errorhandler(500)(hooks.bbs_500_error)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#36807;&#28388;&#22120;</span>
app.template_filter(<span style="font-style: italic;">"email_hash"</span>)(filters.email_hash)

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">@app.route("/")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">def hello():</span>
    <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">return "Hello"</span>

app.logger.setLevel(logging.INFO)
<span style="font-weight: bold; font-style: italic;">log_file_handler</span> = FileHandler(<span style="font-style: italic;">"pythonbbs.log"</span>, encoding=<span style="font-style: italic;">"utf-8"</span>)
<span style="font-weight: bold; font-style: italic;">file_formatter</span> = logging.Formatter(<span style="font-style: italic;">"%(asctime)s %(levelname)s:%(message)s [in %(filename)s: %(lineno)d]"</span>)
log_file_handler.setFormatter(file_formatter)
app.logger.addHandler(log_file_handler)
app.logger.error(<span style="font-style: italic;">"&#27979;&#35797;&#19968;&#26465;&#38169;&#35823;&#32423;&#21035;&#30340;&#26085;&#24535;"</span>)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    app.run(debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
ok, 现在我们可以知道日志产生的时间,信息,级别,以及位置等信息了. 虽然按照我的理解,
日志格式最好也是需要根据级别的不同使用不同的格式,但其实 flask 终端打印的日志信息
的格式已经够用了.
</p>
</div>
</div>
</div>

<div id="outline-container-org1cca4a6" class="outline-3">
<h3 id="org1cca4a6">部署</h3>
<div class="outline-text-3" id="text-org1cca4a6">
<p>
项目所有功能都开发完成,并经过测试没有 bug 后, 就可以把项目部署到服务器上面了.
</p>

<p>
作者以 Ubuntu 20.04 LTS Server 操作系统为例子进行讲解,因为我自己本身就使用 Linux
作为日常使用的操作系统,所以并不陌生,相关笔记可能不会很详细.
</p>
</div>

<div id="outline-container-org31fe80a" class="outline-4">
<h4 id="org31fe80a">导出依赖包</h4>
<div class="outline-text-4" id="text-org31fe80a">
<p>
完成项目的开发后,我们需要把项目使用的虚拟环境的依赖包导出,方便在真正的运行环境上
部署按照.
</p>

<p>
在终端输入下面命令就可以将当前的 python 环境下安装的包导出到文件:
</p>

<div class="org-src-container">
<pre class="src src-sh">pip freeze &gt; requirements.txt
</pre>
</div>

<p>
这个命令执行完成,会在项目的根目录生成一个 requirements.txt 文件. 这个文件记录了
当前项目所依赖的包,项目上传到服务器后,可以通过下面命令完成项目中所有用到的依赖包
的安装:
</p>

<div class="org-src-container">
<pre class="src src-sh">pip install -r requirements.txt
</pre>
</div>
</div>
</div>

<div id="outline-container-org1d62643" class="outline-4">
<h4 id="org1d62643">使用 Git 上传代码</h4>
<div class="outline-text-4" id="text-org1d62643">
<p>
开发好的项目可以通过多种方式上传到服务器, scp, git 等等.
</p>

<p>
git 更新代码十分方便,而且有版本管理功能,可以随时切换到之前保存的版本.
</p>

<p>
作者也选择使用 Git 来提交代码.
</p>

<p>
因为我本来就是用 git 来管理笔记和代码的,所以关于 Github 的使用就不做详细的笔记了.
</p>

<p>
简单记录下首次将项目上传到 Github 的流程:
</p>
<ul class="org-ul">
<li>Github 新建仓库.</li>
<li>在本地机器上的项目根目录下初始化 git 仓库.</li>
<li>为本地 git 仓库添加远程仓库地址.</li>
<li>将本地的项目代码添加到缓存区.</li>
<li>将代码提交到本地仓库.</li>
<li>将代码推送到远程仓库(第一步中 Github 上创建的仓库)</li>
</ul>


<p>
通过上面步骤,可以将在本地的项目推送到 Github 服务器上.
</p>

<p>
推送过一次后,想要从 Github 上下载最新的项目代码可以用 pull 命令.
</p>

<p>
我们在本地将其上开发代码,用 git push 命令将代码推送到 Github 服务器, 然后在运行
环境(网站服务器)上用 git pull 命令获取最新的项目代码更新.
</p>

<blockquote>
<p>
Github 只是全球最大的代码托管网站, Git 服务器可以自己搭建,也可以使用类似 Github
这种第三方服务器. 我自己就在树莓派 zero 上搭建了一个简易的 Git 服务器,有时候可以
应急使用,也可以作为一个方便携带的随身 Git 服务器.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org0a12af9" class="outline-4">
<h4 id="org0a12af9">生产环境的配置</h4>
<div class="outline-text-4" id="text-org0a12af9">
<p>
这部分说的是将配置中的 DevelopmentConfig 修改为 ProductionConfig, 并完善
ProductionConfig 配置类, 以便完成生产环境的代码修改.
</p>

<p>
代码修改的部分很简单,也没什么必要,因为这只是一个练手的项目,我并没有真的生产环境
服务器,但是作者提到的 Git 的工作流程很有必要记录.
</p>

<p>
Git 的分支功能十分有用. Git 的一个基本的工作流程是将尚未完成测试的代码,先放到
dev 或者 development 分支下. 在测试完成并修改完 bug 后,再把代码合并到 main 分支.
</p>

<p>
这一点是我一直都没有用到的, 我从来都是在一个 main 下面修改代码的,因为我认为 git
有版本控制嘛,有了错误可以在前面的代码里找,但是我自己在以往代码中找过错误,真的很
难,但是分析了下作者提到的分支, main 分支里可以保证所有代码都是 bug 最少的,这样定
位错误代码的时候多数代码都是正常运行的,而在修改过多次的代码中定位错误代码很容易
遇到一个修改过的代码定位到另一个修改过的代码,导致需要查找阅读的代码量大而且追踪
代码运行过程困难.
</p>

<blockquote>
<p>
以前读过代码设计的书,那时侯确实看不懂,只知道高内聚低耦合的概念,现在觉得软件开发
设计的方方面面都有这个高内聚低耦合的思想, 这种将事情模块化,有条理地做事情的思想
才是需要学习的.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orga2eb202" class="outline-4">
<h4 id="orga2eb202">安装常用软件</h4>
<div class="outline-text-4" id="text-orga2eb202">
</div>
<ul class="org-ul">
<li><a id="orga01a564"></a>安装OpenSSH<br />
<div class="outline-text-5" id="text-orga01a564">
<p>
OpenSSH 可以实现远程控制. 我们常用的 ssh 命令就是这个软件的命令.
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install openssh-server openssh-client
</pre>
</div>

<p>
如果是 windows 系统则可以使用 putty 或者 xshell, Mac 系统的终端自带 ssh 命令,
Linux 其他系统的安装命令与上面的命令用法都差不多.
</p>
</div>
</li>

<li><a id="org7e8b747"></a>安装Vim<br />
<div class="outline-text-5" id="text-org7e8b747">
<p>
Vim 在 linux 系统上非常好用,几乎是 Linux 系统必备的软件.就算我现在用 Emacs 也使
用了 Evil mode 模拟 Vim 的按键操作.
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install vim
</pre>
</div>
</div>
</li>

<li><a id="org1151d2c"></a>安装MySQL<br />
<div class="outline-text-5" id="text-org1151d2c">
<p>
我们的项目是学习测试使用,所以 MySQL 是安装在项目所在的机器上面的.实际的商业项目,
规模大一点的都会使用单独的 MySQL 服务器,也就是将 MySQL 安装到另一台服务器上,而不
是项目所在的服务器上.这样可以减少项目运行的服务器的计算机资源使用,而提高项目性能.
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install mysql-server mysql-client
sudo apt install libmysqld-dev
</pre>
</div>
</div>
</li>

<li><a id="org626625c"></a>安装Redis<br />
<div class="outline-text-5" id="text-org626625c">
<p>
我们的项目使用了 Redis 来缓存邮箱验证码和Celery 数据, 所以需要安装 Redis.
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install redis
</pre>
</div>
</div>
</li>

<li><a id="org666cc82"></a>安装Python3<br />
<div class="outline-text-5" id="text-org666cc82">
<p>
有些服务器的初始包比较旧,只有 python2.x 所以需要安装 python3
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install python3
</pre>
</div>
<p>
有的系统 pip 和 python 是分开的,所以 python3 的 pip 工具也要额外安装.
</p>

<div class="org-src-container">
<pre class="src src-sh">sudo apt install python3-pip
</pre>
</div>

<p>
有时还需要安装 python3 依赖的头文件等的开发包
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt install python3-dev
</pre>
</div>
</div>
</li>

<li><a id="org84064cc"></a>安装Git<br />
<div class="outline-text-5" id="text-org84064cc">
<p>
我们需要通过 Git 工具从 Git 服务器获取代码.
</p>

<div class="org-src-container">
<pre class="src src-sh">suod apt install git
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-orge091f1c" class="outline-4">
<h4 id="orge091f1c">配置网站</h4>
<div class="outline-text-4" id="text-orge091f1c">
<p>
安装完所有需要的软件,就可以开始配置网站了.
</p>
</div>

<ul class="org-ul">
<li><a id="org7812b11"></a>创建新用户<br />
<div class="outline-text-5" id="text-org7812b11">
<p>
默认登录服务器的 root 账号权限太大,通常不会用 root 用户部署网站.
</p>

<p>
可以使用下面命令创建一个新的用户,赋予 root 权限,然后切换到该用户:
</p>
<div class="org-src-container">
<pre class="src src-sh">adduser projectUser
usermod aG sudo projectUser
su projectUser
</pre>
</div>
</div>
</li>

<li><a id="orge5e78f8"></a>使用Git拉取代码<br />
<div class="outline-text-5" id="text-orge5e78f8">
<p>
现在代码还是位于 Git 服务器上,所以我们需要在生产环境的服务器上用下面命令将代码拉
取到服务器.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="font-weight: bold;">cd</span> /home/projectUser
mkdir pythonbbs
git remote add origin &#39033;&#30446;&#20301;&#20110;git&#19978;&#30340;&#22320;&#22336;
git gull origin main
</pre>
</div>
<p>
执行 pull 命令时会提示输入 Github 网站的用户名和密码.输入后就可以将代码从 Github
上拉取到网站服务器了. 注意 项目位于git上的地址 是 http 地址,不是 ssh 地址.
</p>
</div>
</li>

<li><a id="org961b145"></a>安装 Python 依赖包<br />
<div class="outline-text-5" id="text-org961b145">
<p>
前面我们从开发项目的机器上将项目的依赖包导出到了 requirements.txt 所以现在可以通
过该文件安装依赖包:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install -r requirements.txt
</pre>
</div>
</div>
</li>

<li><a id="orgeefd068"></a>创建数据库<br />
<div class="outline-text-5" id="text-orgeefd068">
<p>
登录Mysql 后,使用下面命令创建一个叫做 pythonbbs 的数据库:
</p>
<pre class="example" id="org0b4e40b">
mysql&gt; CREATE DATABASE pythonbbs CHARACTER SET utf8mb4;
Query OK, 1 row affected (0.08 sec)
</pre>
</div>
</li>

<li><a id="org3b4436f"></a>同步 ORM 模型到数据库<br />
<div class="outline-text-5" id="text-org3b4436f">
<p>
我们在开发机上使用 migrate 生成的迁移脚本,可以直接在网站上进行映射:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask db upgrade
</pre>
</div>
<p>
这个命令会执行 pythonbbs/migrations/versions 下面的所有迁移脚本,将ORM 模型同步到
数据库中生成数据库表.
</p>

<p>
这样做的前提是在开发机上,我们已经在完成所有对 ORM 模型的修改后用 flask migrate
命令将所有的修改部分生成到了迁移脚本中.
</p>
</div>
</li>

<li><a id="orga18b687"></a>创建初始数据<br />
<div class="outline-text-5" id="text-orga18b687">
<p>
网站开始运营前,需要将初始数据创建好,包括角色,权限,板块,以及初始的管理员用户等.
</p>
<ul class="org-ul">
<li><p>
创建角色:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-role
</pre>
</div></li>
<li><p>
创建权限:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-permission
</pre>
</div></li>
<li><p>
创建板块:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-board
</pre>
</div></li>
<li><p>
创建管理员:
</p>
<div class="org-src-container">
<pre class="src src-sh">flask create-admin --username &#24352;&#19977; --email zhangsan@qq.com --password 111111
</pre>
</div></li>
</ul>


<p>
这些命令的使用在前面都讲解过.
</p>
</div>
</li>

<li><a id="org53c8051"></a>运行 Celery<br />
<div class="outline-text-5" id="text-org53c8051">
<p>
pythonbbs 项目的运行依赖 Celery, Celery 依赖 Redis, 因此运行 Celery 之前需要先运
行 Redis:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo service redis start
</pre>
</div>
<p>
运行 celery 的命令前面也使用过:
</p>
<div class="org-src-container">
<pre class="src src-sh">celery -A app.celery worker -P gevent -l info
</pre>
</div>
</div>
</li>
</ul>
</div>

<div id="outline-container-org773c918" class="outline-4">
<h4 id="org773c918">使用 Gunicorn 部署网站</h4>
<div class="outline-text-4" id="text-org773c918">
<p>
学习使用 Gunicorn(Green Unicorn)来部署网站之前,需要弄清楚 Web 服务器, 应用服务器
和 Web 应用这 3 个概念.
</p>

<ul class="org-ul">
<li>Web 服务器: 负责处理 HTTP 请求,并响应静态文件. 常见的有 Apache, Ngnix 以及微软
的 IIS 等.</li>
<li>应用服务器: 负责处理逻辑的服务器. 例如 Java, Python 的代码是不能直接通过 Nginx
这种 Web 服务器处理的,只能通过应用服务器来处理,常见的应用服务器有 uWSGI,
Gunicorn 以及 Tomcat 等.</li>
<li>Web 应用框架: 使用某种编程语言,封装了常用的Web 功能的框架就是 Web 应用框架.
Flask, Django 以及 Java 的 SSH(Structs+Spring+Hibernate) 等都是Web 应用框架.</li>
</ul>


<p>
WSGI(Web server gateway interface, web 服务网关接口) 是 Python 中定义的 Web 服务
器和 Web 应用框架之间的一种简单通用的接口.
</p>

<p>
开发阶段,我们是使用的 werkzeug 作为 WSGI 应用服务器,但是 werkzeug 并不能用于生产
环境(作者说的;<a href="https://stackoverflow.com/questions/50152641/why-cant-use-werkzeug-in-production">why can't use werkzeug in production</a> 有时网络不好点不进去,还是简单
说下,就是 werkzeug 这个 WSGI 并不是作为一个健壮,可靠,快速的 HTTP 服务器设计的,也
就是说在处理大一点的负载时,该服务器的表现就会出问题了,所以不能用于生产环境.).
</p>

<p>
生产环境中应该选择性能强悍,稳定性高的 WSGI 应用服务器,例如 uWSGI 和 Gunicorn.
</p>

<p>
因为 Gunicorn 性能强,配置简单,所以选择该 WSGI 应用服务器作为 pythonbbs 项目的应
用服务器.
</p>

<p>
安装 Gunicorn:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo pip install gunicorn
</pre>
</div>

<p>
然后在项目根目录创建 gunicorn.conf.py 文件.作为 gunicorn 的运行配置文件:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> multiprocessing

<span style="font-weight: bold; font-style: italic;">bind</span> = <span style="font-style: italic;">"127.0.0.1:8000"</span>
<span style="font-weight: bold; font-style: italic;">workers</span> = multiprocessing.cpu_count()*2 + 1
<span style="font-weight: bold; font-style: italic;">accesslog</span> = <span style="font-style: italic;">"/var/log/pythonbbs/access.log"</span>
<span style="font-weight: bold; font-style: italic;">daemon</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>
</pre>
</div>

<ul class="org-ul">
<li>bind: 监听的 IP 地址和端口号,语法为 IP:PORT. 如果想让其他机器能够访问,则设置成
0.0.0.0 或者留空, 然后让 Gunicorn 监听 8000 端口即可. 后面会用到 Nginx 做 Web
服务器, Nginx 和 Gunicorn 之间通过 8000 端口通信,所以 IP 设置为 127.0.0.1</li>
<li>workers: workers 的数量. Gunicorn 官方推荐的配置是 CPU 数量×2+1.</li>
<li>accesslog: 连接 Gunicorn 的日志文件.</li>
<li>daemon: 是否作为守护进程执行,设置为 True.</li>
</ul>


<p>
最后在 pythonbbs 项目根目录下,执行下面命令启动 pythonbbs 项目:
</p>
<div class="org-src-container">
<pre class="src src-sh">gunicorn app:app
</pre>
</div>
<p>
这个命令会自动在当前路径下面查找 gunicorn.config.py 文件,然后执行 app.py 模块下
的 app 对象. 到这里, Gunicorn 就完成了对 pythonbbs 项目的部署.
</p>


<p>
我们应该将 bind 的 ip 地址修改为 0.0.0.0, 执行 gunicorn reload 命令可以重新加载
配置文件,然后就可以通过 <a href="http://ip:8000">http://ip:8000</a> 就可以访问该网站.
</p>
</div>
</div>

<div id="outline-container-orga2070da" class="outline-4">
<h4 id="orga2070da">使用Nginx 部署网站</h4>
<div class="outline-text-4" id="text-orga2070da">
<p>
Gunicorn 可以让网站正常运行,但是并不是最佳选择. 下面我们使用 Gunicorn 推荐的
Nginx 作为 Web 服务器. Nginx, Gunicorn, 和项目程序 pythonbbs 的关系如下:
</p>


<div id="org5013ba1" class="figure">
<p><a href="imgs/ddreader_20230612-094600.png"><img src="file:///home/kamisama/MyLife/blog_source/content/Books/imgs/ddreader_20230612-094600.png" alt="ddreader_20230612-094600.png" /></a>
</p>
</div>

<p>
浏览器向服务器发送请求,先由 Nginx 处理,遇到对 /static 开头的静态文件的请求时,返
回静态文件; 遇到非静态路由时,通过反向代理给 Gunicorn 服务器,Gunicorn 服务器再将
请求传递给 pythonbbs 项目程序进行处理.
</p>

<p>
使用 Nginx 作为 Web 服务器有以下好处:
</p>
<ul class="org-ul">
<li>Gunicorn 对静态文件的处理效率不好,包括响应速度和缓存, Nginx 则不然.</li>
<li>Nginx 作为专业的 Web 服务器,可以对外界隐藏应用服务器,更加安全.</li>
<li>Nginx 运维更加方便. 如设置负载均衡,配置 IP 黑名单等都非差功能方便,但使用
Gunicorn 实现这些则很麻烦.</li>
</ul>


<p>
使用 Nginx 首先要安装:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt install nginx
</pre>
</div>

<p>
然后启动 Nginx:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo service nginx start
</pre>
</div>

<p>
还有关闭和重启的命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo service nginx stop
sudo service nginx restart
</pre>
</div>

<p>
另外还有一个命令非常有用:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo service nginx configtest
</pre>
</div>
<p>
这个命令可以测试配置文件是否正确.
</p>

<p>
启动 Nginx 后,访问 <a href="http://serverip">http://serverip</a> 会看到 Nginx 的欢迎页面,这就表示 nginx 运行成
功.
</p>

<p>
运行成功后我们还需要对其进行配置,才能让 Nginx 作为我们项目的 Web 服务器.
</p>

<p>
在 /etc/nginx/conf.d 目录下创建 pythonbbs.conf 文件:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36127;&#36733;&#22343;&#34913;</span>
<span style="font-weight: bold; text-decoration: underline;">upstream pythonbbs</span>{
         server 127.0.0.1:8000;
}
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#37197;&#32622;&#26381;&#21153;&#22120;</span>
<span style="font-weight: bold; text-decoration: underline;">server</span> {
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#30417;&#21548;&#31471;&#21475;&#21495;</span>
       listen 80;
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#22495;&#21517;</span>
       server_name 192.168.0.2;

       charset utf-8;

       access_log /var/log/nginx/pythonbbs_access.log;
       error_log /var/log/nginx/pythonbbs_error.log;

       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26368;&#22823;&#30340;&#25991;&#20214;&#19978;&#20256;&#23610;&#23544;</span>
       client_max_body_size 75M;
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#38745;&#24577;&#25991;&#20214;&#35775;&#38382;&#30340; URL</span>
       <span style="font-weight: bold; text-decoration: underline;">location /static</span> {
                <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#38745;&#24577;&#25991;&#20214;&#22320;&#22336;</span>
                alias /home/projectUser/pythonbbs/static;
                <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#38745;&#24577;&#25991;&#20214;&#36807;&#26399;&#26102;&#38388;</span>
                expires 60d;
       }

       <span style="font-weight: bold; text-decoration: underline;">location /media</span> {
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25991;&#20214;&#19978;&#20256;&#22320;&#22336;</span>
       alias /home/projectUser/pythonbbs/media;
       expires 100d;
       }
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26368;&#21518;,&#25152;&#26377;&#38750;&#38745;&#24577;&#25991;&#20214;&#21457;&#36865;&#21040; Gunicorn</span>
       <span style="font-weight: bold; text-decoration: underline;">location /</span> {
       proxy_pass http://pythonbbs;
       <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">uwsgi_params &#25991;&#20214;&#22320;&#22336;</span>
       include /etc/nginx/uwsgi_params;
       proxy_set_header Host $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-Proto $scheme;
       }
}
</pre>
</div>

<p>
这个配置中, upstream 是用来设置负载均衡的,可以设置多个 server, Nginx 会根据策略
选择不同的后端服务器来实现负载均衡. server 部分是用来配置 Nginx 服务器的, 监听
80 端口,指定服务器名称为 192.168.0.2 ,以后通过这个服务器名称就可以访问到 Nginx
服务器,这里就是真实部署项目的服务器的 IP 地址,如果有域名,而且做好了域名和服务器
的映射,这里也可以设置为域名. access_log 和 error_log 是配置客户端连接 Nginx 服务
器的日志. location /static 用于指定以 /static 开头的静态文件的处理逻辑, 使用
alias 指定静态文件寻找的路径,并设置过期时间为 60 天, /media 也是差不多的设置,用
来获取用户上传后的图片. 最后是非静态文件和非 media 文件,通过方向代理传给
Gunicorn 服务器,设置的 proxy_set_header 是为了能准确获取客户端的信息.
</p>

<p>
现在,通过 80 以及 8000 端口都可以访问到网站了,原因是 Nginx 监听 80端口, Gunicorn
监听 8000 端口.
</p>

<p>
而预想的效果是客户端仅仅通过 80 端口访问, 8000 只用于 Nginx 和 Gunicorn 之间的通
信. 可以通过设置防火墙来关闭 8000 端口的对外权限:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo ufw enable
sudo ufw allow 80
sudo ufw deny 8000
sudo ufw allow 22
</pre>
</div>
<p>
上面的命令作用分别为打开防火墙,打开80 端口,关闭 8000 端口,打开22 端口. 22 端口是
为了能在开发机上通过远程连接服务器, SSH 服务的监听端口就是22.
</p>
</div>
</div>

<div id="outline-container-org61aeff9" class="outline-4">
<h4 id="org61aeff9">压力测试</h4>
<div class="outline-text-4" id="text-org61aeff9">
<p>
项目部署后,我们就可以进行压力测试了. 压力测试是为了查看网站处理请求的效率.
</p>

<p>
进行压力测试要使用到 apache2-utils 中的 ab 命令.
首先,需要安装 apache2-utils:
</p>
<div class="org-src-container">
<pre class="src src-sh">sudo apt install apache2-utils
</pre>
</div>
<p>
然后执行下面命令:
</p>
<div class="org-src-container">
<pre class="src src-sh">ab -n 50000 -c 1000 http://127.0.0.1/
</pre>
</div>
<p>
ab 是压力测试命令,参数的含义:
</p>
<ul class="org-ul">
<li>-n: 总共发起请求的数量,这里设置为 50000.</li>
<li>-c: 并发的数量,这里设置为 1000.</li>
<li><a href="http://127.0.0.1/">http://127.0.0.1/</a>: 压力测试的URL</li>
</ul>



<p>
执行完命令后会看到一连串的输出,由于我是在 windows 系统,所以没有进行测试,但是列出
作者给出的输出中各项指标的意义:
</p>
<ul class="org-ul">
<li>Completed xxx requests: 请求完成的数量.</li>
<li>Server Software: 服务器软件名.</li>
<li>Server Hostname: 服务器主机名.</li>
<li>Server Port: 服务器端口号.</li>
<li>Document Path: 请求的 URL Path</li>
<li>Document Length: http 响应数据的正文长度.</li>
<li>Document Level: 并发量.</li>
<li>Concurrency Level: 并发量.</li>
<li>Time taken for tests: 总共耗费的时间.</li>
<li>Complete requests: 完成的请求数量.</li>
<li>Failed requests: 失败的请求数量.</li>
<li>Total transferred: 所有请求响应数据的长度.</li>
<li>HTML transferred: 所有请求响应数据的长度.</li>
<li>Requests per second: 每秒完成的请求数量,也叫 RPS(吞吐量).</li>
<li>Time per request(mean): 一个请求用户平均等待时间.</li>
<li>Tiem per request(mean, across all concurrent requests): 服务器完成一个请求的平
均时间.</li>
<li>Transfer rate: 网络传输速率.</li>
<li>Connection Times(ms): 从请求到响应的整个过程消耗的时间. 从请求到响应包含
Connect(网络连接), Processing(程序处理), Waiting(等待) 3个过程. 其中 min 表示
最小值, mean 表示平均值,[+/-sd] 表示标准差(反应数据的离散程度,数值越大则数据越
离散.) median 表示中位数, max 表示最大值.</li>
<li>Percentage of the requests served within a certain time(ms): 在 50000 个请求中
的不同完成率阶段进行菜羊,请求所消耗的时间. 如 50%, 就是在第 25000 个请求时,花
费了 <b>* 的时间, 100% 就是在第 50000 个请求消耗了 *</b> 的时间.</li>
</ul>


<p>
作者的测试结果是使用 2GB 内存, 单核 CPU 3600Hz 加上机械硬盘的硬件配置测试的,
RPS(request per second)/QPS(queries per second) 每秒请求数达到了 13000 以上.
最长的响应时间的请求是第50000 个请求,响应时间为 1107 ms.
</p>

<p>
这个结果意味着按照作者给出的硬件数据,我们的项目处理50000 个请求只需要1.1 秒的时
间.
</p>

<p>
想了想, CPU 3600Hz, 1Ghz = 1×10³ Mhz = 1 × 10⁶ hz, 3600 Hz 连我的 raspberry pi
zero 都不如,我的树莓派 zero 还是单核 1GHz, 觉得这里可能会有问题,等会把项目部署到
我的树莓派上进行下压力测试.
</p>

<blockquote>
<p>
折腾这个部署和测试搞了好久,树莓派 zero w 上速度太慢,网站开发的开发环境也不好,下
载个包都下不了,最终放弃,尝试在我的 manjaro 系统上测试,终究不是像租用的服务器一样
新的环境,问题很多,系统和一般用于代理网站的系统不同,软件配置也有差别,还有以前的一
些软件和配置干扰,最后结果只能说网站部署成功了,由于权限问题,静态文件(/static/*)
交给 nginx 代理时会出现无法加载的情况,压力测试也不知怎么只能请求很小数量的请求,
使用作者测试的 50000 会直接被关闭连接. 部署的内容很杂,需要额外花时间去查资料才能
搞清楚,暂时先不管了.
</p>
</blockquote>
</div>
</div>
</div>
</div>

<div id="outline-container-org43a6c3e" class="outline-2">
<h2 id="org43a6c3e">WebSocket实战</h2>
<div class="outline-text-2" id="text-org43a6c3e">
<p>
传统的 http 协议实现的服务,需要主动请求服务器才能获取到数据,对于视频实时弹幕,在
线客服,协同编辑等功能来说,使用传统的 http 协议实现就需要隔一段时间主动请求服务器,使
用这种方式开发的好处是开发简单,不会长时间占用服务器资源,缺点则是效率地下,数据获
取的不及时.
</p>

<p>
为了解决 Web 开发中客户端与服务器端双向即时通信的问题, IETF(internet engineering
task force, 互联网工程任务组) 标准化了 WebSocket 协议,使用 WebSocket 协议相关的
API, 在客户端和服务器端只需要完成一次握手,就可以进行双向即时通信.
</p>

<p>
Flask 中有多种使用 WebSocket 的解决方案,做常用的是两个框架 Flask-Sockets 和
Flask-SocketIO. Flask-Sockets 仅对 WebSocket 协议进行了包装,因此只适合支持
WebSocket 协议的浏览器. Flask-SocketIO 则是基于 JavaScript SocketIO 开源库的消息
协议针对 Flask 框架的实现,因此 SocketIO 对于不支持 WebSocket 协议的浏览器也能实
习那相同的效果,因此使用 Flask-SocketIO 对客户端的兼容性更好.
</p>

<blockquote>
<p>
我的理解,这两个库一个是直接使用 WebSocket 协议进行通信,因此需要浏览器支持
WebSocket 协议的使用,另一个则是使用 JavaScript 进行通信只要浏览器支持使用
JavaScript 就可以实现即时通信.
</p>

<p>
WebSocket 是一个协议,协议可以有多种实现方式,Flask-Sockets 应该是用 Python 直接对
WebSocket 协议的实现,相当于服务器端直接用 Python 建立一个 WebSocket 协议的通信,
因此通信双方的客户端也需要支持 WebSocket, 这里的支持指的是客户端是否能直接处理
WebSocket 协议的通信请求.其实一般现在的浏览器是都支持 WebSocket 的,但是也有一些
不支持,不过不支持 WebSocket 的一般都会支持 JavaScript, 如果两者都不支持,那这个浏
览器也太"老"了.
</p>
</blockquote>

<p>
这一部分会以一个在线即时聊天的网站为例子,让我们熟悉 Flask-SocketIO 的使用.
</p>

<p>
首先,来看一下这个在线聊天项目需要实现的功能:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption class="t-above"><span class="table-number">Table 21:</span> 在线即时聊天网站功能表</caption>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left">功能</td>
<td class="org-left">相关技术点</td>
</tr>

<tr>
<td class="org-left">登录</td>
<td class="org-left">session 的使用和权限验证</td>
</tr>

<tr>
<td class="org-left">聊天页面</td>
<td class="org-left">WebSocket 连接; 广播所有在线用户</td>
</tr>

<tr>
<td class="org-left">单聊</td>
<td class="org-left">获取对方信息; 客户端发送单聊消息; 服务器端发送单聊消息</td>
</tr>

<tr>
<td class="org-left">群聊</td>
<td class="org-left">获取群聊信息;加入群聊;客户端发送群聊信息;服务器端发送群聊信息</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
注意: 到了这一章节了,作者给的代码都是关键地方的代码了,不会给出所有编程细节,比如
说模块导入,文件位置之类的细节都省略了,需要我们读者自己完成.
</p>
</blockquote>
</div>
<div id="outline-container-org845b4ea" class="outline-3">
<h3 id="org845b4ea">安装相应的包</h3>
<div class="outline-text-3" id="text-org845b4ea">
<p>
服务器端,项目使用的是 Flask-SocketIO 库:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install flask-socketio
</pre>
</div>

<p>
客户端,项目使用 socketio 库, 在 HTML 文件中加载该 js 实现的库即可:
</p>
<pre class="example" id="orgbf2ad06">
&lt;script src="https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"&gt;&lt;/script&gt;
</pre>
</div>
</div>

<div id="outline-container-org8bf77b5" class="outline-3">
<h3 id="org8bf77b5">创建 SocketIO 对象</h3>
<div class="outline-text-3" id="text-org8bf77b5">
<p>
创建一个新的Flask 项目,命名为 im_demon.
</p>

<p>
在 app.py 中添加下面代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run()
</pre>
</div>

<p>
这段代码中,从 flask_socketio 导入了 SocketIO 类,把 app 作为参数传入,创建了一个
SocketIO 类的对象 socketio. 在运行时将 app.run 改为了 socketio.run.
</p>

<p>
socketio.run 会根据一下情境选择底层运行服务器:
</p>
<ul class="org-ul">
<li>开启了 Debug 模式,使用 werkzeug 作为开发服务器.</li>
<li>在生产环境,如果安装了 eventlet 会优先使用 eventlet 作为服务器.</li>
<li>判断是否安装了 gevent, 如果安装,则使用 gevent 作为服务器. gevent 默认不带
WebSocket 功能,如果使用 gevent, 还需要安装 gevent-websocket.</li>
<li>如果 eventlet 和 gevent 都没有安装,则使用 werkzeug 开发服务器运行项目.</li>
</ul>
</div>
</div>

<div id="outline-container-org9945a17" class="outline-3">
<h3 id="org9945a17">实现登录</h3>
<div class="outline-text-3" id="text-org9945a17">
<p>
虽然 app.run 改为了 socketio.run 但是不影响 Flask 传统的开发模式,例如渲染模板,处
理 cookie 和 session 等都和前面一样. socketio.run 在保留传统功能外,增加了
WebSocket 支持. 因此, 登录功能我们依然可以使用前面使用过的 HTTP 协议的方式实现.
</p>

<p>
登录页面的模板 login.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#32842;&#22825;&#23460;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"/static/login.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">style</span>&gt;
    *{
      list-style: none;
      padding: 0;
      margin: 0;
    }
    html{
      height: 100%;
    }
    body{
      height: 100%;
      {#background-color: #aaa;#}
    }
    .main{
      width: 300px;
      margin: 0 auto;
    }
    .username-input{
      box-sizing: border-box;
      display: block;
      width: 100%;
      height: calc(1.5em + .75rem + 2px);
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
      outline: none;
    }
    .submit-button{
      display: block;
      width: 100%;
      font-weight: 400;
      text-align: center;
      vertical-align: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      border: 1px solid transparent;
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: .25rem;
      transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
      cursor: pointer;
    }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-top: 100px;"</span>&gt;
    &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center; padding-bottom: 20px;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#21363;&#26102;&#32842;&#22825;&#30331;&#24405;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username-group"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"username-input"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username-input"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button-group"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"margin-top: 20px;text-align: right"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"submit-button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-button"</span>&gt;&#25552;&#20132;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run()
</pre>
</div>

<p>
新增的代码中,实现了登录的URL 和视图函数. 如果用 GET 请求,则返回登录页面的模板,如
果是 POST 请求,则执行登录操作.这里简化了登录过程,用户只要输入用户名即可. 如果条
件符合,则把用户名储存在 session 中. 为了让代码更规范,还添加了返回状态码的
ResultCode 类,以及返回 JSON 格式的 result 函数. 另外还用到了 UserManager 类来管
理当前登录的用户, UserManager 类代码如下:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserManager</span>:
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21333;&#20363;&#23454;&#20363;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">__instance</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25152;&#26377;&#29992;&#25143;,&#37324;&#38754;&#20648;&#23384;&#30340;&#26159;&#23383;&#20856;&#31867;&#22411;,&#23383;&#20856;&#20013;&#20998;&#21035;&#20026; sid &#21644; username</span>
    <span style="font-weight: bold; font-style: italic;">_user</span> = []

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#21333;&#20363;&#35774;&#35745;&#27169;&#24335;</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__new__</span>(cls, *args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cls.__instance:
            cls.<span style="font-weight: bold; font-style: italic;">__instance</span> = <span style="font-weight: bold;">super</span>(UserManager, cls).__new__(cls)
        <span style="font-weight: bold;">return</span> cls.__instance

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29992;&#25143;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">remove_user</span>(cls, username):
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"username"</span>] == username:
                cls._users.remove(user)
                <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; key &#33719;&#21462;&#29992;&#25143;, key &#21487;&#20197;&#20026; sid &#25110; username</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_user</span>(cls, key):
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"sid"</span>] == key <span style="font-weight: bold;">or</span> user[<span style="font-style: italic;">"username"</span>] == key:
                <span style="font-weight: bold;">return</span> user
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; key &#21028;&#26029;&#26159;&#21542;&#26377;&#26576;&#20010;&#29992;&#25143;, key &#21487;&#20197;&#20026; sid &#25110; username</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">has_user</span>(cls, key):
        <span style="font-weight: bold;">if</span> cls.get_user(key):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
        <span style="font-weight: bold;">else</span>:

            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#29992;&#25143;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_current_user</span>(cls):
        <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"username"</span>] == username:
                <span style="font-weight: bold;">return</span> user
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#25152;&#26377;&#29992;&#25143;&#30340;&#29992;&#25143;&#21517;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">all_username</span>(cls):
        <span style="font-weight: bold;">return</span> [user[<span style="font-style: italic;">"username"</span>] <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users]
</pre>
</div>

<p>
UserManager 的代码中,定义了两个类属性, "_instance" 和 "_users" , <code>_instance</code> 是用来
保存单例对象的, <code>_users</code> 是用来保存所有用户信息的.
</p>

<p>
通过重写 <code>__new__</code> 方法,让 UserManager 仅能被创建一次, 也就是单例对象.
</p>

<p>
接着定义了一系列的类方法,分别为添加用户,移除用户,获取用户判断用户是否存在,获取当
前用户以及获取所有用户的用户名. 这些类方法可以使得后续处理即时消息时更加简单.
</p>

<p>
为了保证用户必须登录后才能访问,我们还需要一个 login_required 装饰器.
</p>

<p>
decorators.py :
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> functools <span style="font-weight: bold;">import</span> wraps
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> redirect, session
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login_required</span>(func):
    <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">wrapper</span>(*args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> session.get(<span style="font-style: italic;">"username"</span>):
            <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/login"</span>)
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> func(*args, **kwargs)
        <span style="font-weight: bold;">return</span> wrapper
</pre>
</div>

<p>
我们先完成渲染 index.html 页面的视图函数 index, 然后再为其添加 login_required 装
饰器.
</p>

<p>
index.html 模板文件:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#32842;&#22825;&#23460;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/art-template/4.13.2/lib/template-web.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"/static/index.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">style</span>&gt;
    *{
      list-style: none;
      padding: 0;
      margin: 0;
    }
    html{
      height: 100%;
    }
    body{
      height: 100%;
      background: url("/static/bg.jpg") no-repeat 100% 100%;
    }
    .main{
      width: 800px;
      margin: 0 auto;
    }
    .chat-container{
      height: 590px;
      display: flex;
      justify-content: flex-start;
    }
    .chat-list-group{
      background-color: #ffffff;
      width: 200px;
      border-right: 1px solid #cccccc;
    }
    .chat-group{
      background-color: #ffffff;
      flex: 1;
    }
    .module-title{
      height: 40px;
      line-height: 40px;
      padding-left: 10px;
      font-weight: 700;
      border-bottom: 1px solid #ccc;
    }
    .list-group{
      height: 549px;
      overflow-y: scroll;
    }
    .list-group .list-group-item{
      padding: 0 10px;
      border-bottom: 1px solid #ccc;
      height: 60px;
      line-height: 60px;
      box-sizing: border-box;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      cursor: pointer;
    }
    .chat-box{
      height: 340px;
      background-color: #ffffff;
      padding: 10px;
      overflow-y: scroll;
      border-bottom: 1px solid #cccccc;
    }
    .chat-content-box{
      margin-bottom: 10px;
      overflow-y: hidden;
      display: flex;
      justify-items: center;
      padding: 5px;
    }
    .chat-content{
      background-color: #ccc;
      padding: 5px;
    }
    .username{
      padding: 5px;
    }
    .friend{}
    .me{
      justify-content: right;
    }
    .chat-input-group{
      padding: 10px;
      box-sizing: border-box;
    }
    .chat-input-group .chat-textarea{
      display: block;
      width: 100%;
      height: 120px;
      outline: none;
      border: none;
      resize: none;
    }
    .button{
      display: inline-block;
      width: 80px;
      height: 30px;
      cursor: pointer;
    }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-template"</span>&gt;
  {% raw %}
    {{ each chats }}
      &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#31169;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
    {{ /each }}
  {% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"group-list-template"</span>&gt;
{% raw %}
  {{ each groups }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#32676;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
  {% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-content-template"</span>&gt;
{% raw %}
  {{ if from_user=="me" }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box me"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;&#65306;&#25105;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
  {{ else }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;{{ from_user }}&#65306;&lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
  {{ /if }}
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-top: 100px;"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-container"</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#21015;&#34920;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-ul"</span>&gt;
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#31383;&#21475;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-box"</span>&gt;
          &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-box"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-box"</span>&gt;
          &lt;/<span style="font-weight: bold;">ul</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-input-group"</span>&gt;
          &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"chat-content"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#32842;&#22825;&#20869;&#23481;..."</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-textarea"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-textarea"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
          &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button-group"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: right;"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"create-room-button"</span>&gt;&#21019;&#24314;&#32676;&#32842;&lt;/<span style="font-weight: bold;">button</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"send-button"</span>&gt;&#21457;&#36865;&lt;/<span style="font-weight: bold;">button</span>&gt;
          &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
      &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div>

<p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    render_template(<span style="font-style: italic;">"index.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run()
</pre>
</div>

<p>
将作者没有在书中给出的细节完善之后可以在 im_demon 文件夹下看到 decorators.py ,
usermanager.py 和 app.py 文件,以及 templates 文件夹, 还有位于 static 文件夹下的
用于响应用户操作的 js 文件.
</p>

<ul class="org-ul">
<li><p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> usermanager <span style="font-weight: bold;">import</span> UserManager

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run(app)
</pre>
</div></li>

<li><p>
decorators.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> functools <span style="font-weight: bold;">import</span> wraps
<span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> redirect, session
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login_required</span>(func):
    <span style="font-weight: bold; text-decoration: underline;">@wraps</span>(func)
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">wrapper</span>(*args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> session.get(<span style="font-style: italic;">"username"</span>):
            <span style="font-weight: bold;">return</span> redirect(<span style="font-style: italic;">"/login"</span>)
        <span style="font-weight: bold;">else</span>:
            <span style="font-weight: bold;">return</span> func(*args, **kwargs)
    <span style="font-weight: bold;">return</span> wrapper
</pre>
</div></li>

<li><p>
usermanager.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> session
<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">UserManager</span>:
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21333;&#20363;&#23454;&#20363;&#23545;&#35937;</span>
    <span style="font-weight: bold; font-style: italic;">__instance</span> = <span style="font-weight: bold; text-decoration: underline;">None</span>
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#25152;&#26377;&#29992;&#25143;,&#37324;&#38754;&#20648;&#23384;&#30340;&#26159;&#23383;&#20856;&#31867;&#22411;,&#23383;&#20856;&#20013;&#20998;&#21035;&#20026; sid &#21644; username</span>
    <span style="font-weight: bold; font-style: italic;">_users</span> = []

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#35774;&#32622;&#21333;&#20363;&#35774;&#35745;&#27169;&#24335;</span>

    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">__new__</span>(cls, *args, **kwargs):
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> cls.__instance:
            cls.<span style="font-weight: bold; font-style: italic;">__instance</span> = <span style="font-weight: bold;">super</span>(UserManager, cls).__new__(cls)
        <span style="font-weight: bold;">return</span> cls.__instance

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#28155;&#21152;&#29992;&#25143;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">add_user</span>(cls, username, sid):
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"sid"</span>] == sid <span style="font-weight: bold;">or</span> user[<span style="font-style: italic;">"username"</span>] == username:
                <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>
        cls._users.append({<span style="font-style: italic;">"sid"</span>: sid, <span style="font-style: italic;">"username"</span>: username})

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31227;&#38500;&#29992;&#25143;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">remove_user</span>(cls, username):
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"username"</span>] == username:
                cls._users.remove(user)
                <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; key &#33719;&#21462;&#29992;&#25143;, key &#21487;&#20197;&#20026; sid &#25110; username</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_user</span>(cls, key):
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"sid"</span>] == key <span style="font-weight: bold;">or</span> user[<span style="font-style: italic;">"username"</span>] == key:
                <span style="font-weight: bold;">return</span> user
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#26681;&#25454; key &#21028;&#26029;&#26159;&#21542;&#26377;&#26576;&#20010;&#29992;&#25143;, key &#21487;&#20197;&#20026; sid &#25110; username</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">has_user</span>(cls, key):
        <span style="font-weight: bold;">if</span> cls.get_user(key):
            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">True</span>
        <span style="font-weight: bold;">else</span>:

            <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">False</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#24403;&#21069;&#29992;&#25143;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">get_current_user</span>(cls):
        <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users:
            <span style="font-weight: bold;">if</span> user[<span style="font-style: italic;">"username"</span>] == username:
                <span style="font-weight: bold;">return</span> user
        <span style="font-weight: bold;">return</span> <span style="font-weight: bold; text-decoration: underline;">None</span>

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#33719;&#21462;&#25152;&#26377;&#29992;&#25143;&#30340;&#29992;&#25143;&#21517;</span>
    @<span style="font-weight: bold;">classmethod</span>
    <span style="font-weight: bold;">def</span> <span style="font-weight: bold;">all_username</span>(cls):
        <span style="font-weight: bold;">return</span> [user[<span style="font-style: italic;">"username"</span>] <span style="font-weight: bold;">for</span> user <span style="font-weight: bold;">in</span> cls._users]
</pre>
</div></li>

<li><p>
templates/index.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#32842;&#22825;&#23460;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/art-template/4.13.2/lib/template-web.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"/static/index.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">style</span>&gt;
    *{
    list-style: none;
    padding: 0;
    margin: 0;
    }
    html{
    height: 100%;
    }
    body{
    height: 100%;
    background: url("/static/bg.jpg") no-repeat 100% 100%;
    }
    .main{
    width: 800px;
    margin: 0 auto;
    }
    .chat-container{
    height: 590px;
    display: flex;
    justify-content: flex-start;
    }
    .chat-list-group{
    background-color: #ffffff;
    width: 200px;
    border-right: 1px solid #cccccc;
    }
    .chat-group{
    background-color: #ffffff;
    flex: 1;
    }
    .module-title{
    height: 40px;
    line-height: 40px;
    padding-left: 10px;
    font-weight: 700;
    border-bottom: 1px solid #ccc;
    }
    .list-group{
    height: 549px;
    overflow-y: scroll;
    }
    .list-group .list-group-item{
    padding: 0 10px;
    border-bottom: 1px solid #ccc;
    height: 60px;
    line-height: 60px;
    box-sizing: border-box;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    cursor: pointer;
    }
    .chat-box{
    height: 340px;
    background-color: #ffffff;
    padding: 10px;
    overflow-y: scroll;
    border-bottom: 1px solid #cccccc;
    }
    .chat-content-box{
    margin-bottom: 10px;
    overflow-y: hidden;
    display: flex;
    justify-items: center;
    padding: 5px;
    }
    .chat-content{
    background-color: #ccc;
    padding: 5px;
    }
    .username{
    padding: 5px;
    }
    .friend{}
    .me{
    justify-content: right;
    }
    .chat-input-group{
    padding: 10px;
    box-sizing: border-box;
    }
    .chat-input-group .chat-textarea{
    display: block;
    width: 100%;
    height: 120px;
    outline: none;
    border: none;
    resize: none;
    }
    .button{
    display: inline-block;
    width: 80px;
    height: 30px;
    cursor: pointer;
    }
&lt;/<span style="font-weight: bold;">style</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-template"</span>&gt;
{% raw %}
    {{ each chats }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#31169;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
    {{ /each }}
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"group-list-template"</span>&gt;
{% raw %}
{{ each groups }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#32676;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-content-template"</span>&gt;
{% raw %}
{{ if from_user=="me" }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box me"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;&#65306;&#25105;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
{{ else }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;{{ from_user }}&#65306;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
{{ /if }}
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-top: 100px;"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#21015;&#34920;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-ul"</span>&gt;
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#31383;&#21475;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-box"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-box"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-box"</span>&gt;
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-input-group"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"chat-content"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#32842;&#22825;&#20869;&#23481;..."</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-textarea"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-textarea"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button-group"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: right;"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"create-room-button"</span>&gt;&#21019;&#24314;&#32676;&#32842;&lt;/<span style="font-weight: bold;">button</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"send-button"</span>&gt;&#21457;&#36865;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div></li>

<li><p>
templates/login.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
  &lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
  &lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#32842;&#22825;&#23460;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"/static/login.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
  &lt;<span style="font-weight: bold;">style</span>&gt;
    *{
      list-style: none;
      padding: 0;
      margin: 0;
    }
    html{
      height: 100%;
    }
    body{
      height: 100%;
      {#background-color: #aaa;#}
    }
    .main{
      width: 300px;
      margin: 0 auto;
    }
    .username-input{
      box-sizing: border-box;
      display: block;
      width: 100%;
      height: calc(1.5em + .75rem + 2px);
      padding: .375rem .75rem;
      font-size: 1rem;
      font-weight: 400;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: .25rem;
      transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
      outline: none;
    }
    .submit-button{
      display: block;
      width: 100%;
      font-weight: 400;
      text-align: center;
      vertical-align: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      border: 1px solid transparent;
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: .25rem;
      transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
      cursor: pointer;
    }
  &lt;/<span style="font-weight: bold;">style</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
  &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-top: 100px;"</span>&gt;
    &lt;<span style="font-weight: bold;">h1</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: center; padding-bottom: 20px;"</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#21363;&#26102;&#32842;&#22825;&#30331;&#24405;</span>&lt;/<span style="font-weight: bold;">h1</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username-group"</span>&gt;
      &lt;<span style="font-weight: bold;">input</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"username-input"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username-input"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button-group"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"margin-top: 20px;text-align: right"</span>&gt;
      &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"submit-button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"submit-button"</span>&gt;&#25552;&#20132;&lt;/<span style="font-weight: bold;">button</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
  &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div></li>

<li><p>
static/login.js:
</p>
<div class="org-src-container">
<pre class="src src-javascript">$(<span style="font-weight: bold;">function</span> (){
  $(<span style="font-style: italic;">"#submit-button"</span>).click(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">event</span>){
    event.preventDefault();
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">username</span> = $(<span style="font-style: italic;">"#username-input"</span>).val();
    <span style="font-weight: bold;">if</span>(!username){
      alert(<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;&#65281;"</span>);
      <span style="font-weight: bold;">return</span>;
    }
    $.post({
      url: <span style="font-style: italic;">"/login"</span>,
      data: {<span style="font-style: italic;">"username"</span>: username},
    }).done(<span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">data</span>){
        <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">code</span> = data[<span style="font-style: italic;">'code'</span>];
        <span style="font-weight: bold;">if</span>(code != 200){
          alert(data[<span style="font-style: italic;">'message'</span>]);
          <span style="font-weight: bold;">return</span>;
        }<span style="font-weight: bold;">else</span>{
          window.location = <span style="font-style: italic;">"/"</span>;
        }
      });
  });
});
</pre>
</div></li>
</ul>

<p>
完善这些文件后,运行项目 im_demon, 访问 <a href="http://127.0.0.1:5000">http://127.0.0.1:5000</a> 会因为没有登录而跳
转到登录页面,输入用户名,点击登录,就会由 login.js 向login 视图函数发起 post 请求,
登录成功后会跳转到 index 页面.这样登录功能就初步完成了,虽然此时登录成功后的
index 页面中仍然没有变化,但此时浏览器的 session 中是已经有了加密后的我们登录时输
入的 username 数据的.
</p>

<blockquote>
<p>
到了这里的 session 我还疑惑说怎么才能代表用户登录成功,因为没有 return session 到
发送给客户端的响应里啊, 然后想了下,前面 pythonbbs 里也没有 return session 这样的
操作,但照样实现了登录,只是当时我跟着作者一步步做过来的,没有注意,最早作者就说过了,
flask 的 session 是储存在 cookie 中,随着响应一起发送给客户端的,所以只要设置了
session, 返回了响应,就可以将 session 数据发送到客户端了,不用在 return 里显式
return session.
</p>

<p>
另外,pythonbbs 里将用户数据储存到全局变量 g 里,因此可以在模板文件中访问登录的用
户数据,这里我们只是简单的实现通信功能,不需要访问用户数据,所以没有相似的实现,而且
通信功能主要是由服务器端实现的,不是两个客户端之间直接连接,所以没有在模板中(客户
端)获取用户名的必要(暂时),因为服务器总能从请求的 session 中获取 username 来唯一
标识该用户.
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgf955bab" class="outline-3">
<h3 id="orgf955bab">连接和取消连接</h3>
<div class="outline-text-3" id="text-orgf955bab">
<p>
进入首页后,需要连接上 WebSocket. Flask-SocketIO 是通过事件形式进行通信
的,Flask-SocketIO 内置了很多事件,最常用的就是 connect 和 disconnect 事件.
</p>

<p>
先在服务器端实现 connect 事件:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO, emit

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">'connect'</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">connect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"connected!"</span>)
    UserManager.add_user(session.get(<span style="font-style: italic;">"username"</span>), request.sid)
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<blockquote>
<p>
这只是示例,不是最终代码.
</p>
</blockquote>

<p>
示例中,我们用 @socketio.on 装饰器来设置事件发生后的执行函数,这里定义的是 connect
事件. 客户端在连接 connect 事件后,先把用户储存在 UserManager 中, 在储存用户信息
时,把用户名以及当前用户的 Session ID (request.sid) 都存放进去,然后通过 emit 函数
发送一个 users 事件, 有新用户登录后,我们需要通知所有已连接的用户,所以设置
broadcast 为 True, 即采用广播的方式进行发送. 接下来,就需要在客户端使用
Javascript 的 SocketIO 库发送 connect 事件,示例代码如下:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">socket</span> = io()
socket.on(<span style="font-style: italic;">"connect"</span>, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"Connected!"</span>);
});
</pre>
</div>

<p>
在浏览器被关闭后,应该要主动断开连接. 服务器在收到断开连接的事件后,应该把当前用户
从 UserManager 中移除,并广播给其他用户,代码示例:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"disconnect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">disconnect</span>():
    UserManager.remove_user(session.get(<span style="font-style: italic;">"username"</span>))
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>

<p>
接下来,还要在浏览器端监听页面的关闭事件,在浏览器关闭之前发送 disconnect 事件:
</p>
<div class="org-src-container">
<pre class="src src-javascript">$(window).bind(<span style="font-style: italic;">"beforeunload"</span>, <span style="font-weight: bold;">function</span>(){
    socket.on(<span style="font-style: italic;">"disconnect"</span>);
});
</pre>
</div>
<p>
这段 js 代码中,使用了 jQuery 的事件绑定方式,对 beforeunload 事件进行了绑定,在发
生这个事件后,会主动向服务器发送 disconnect 事件.
</p>

<p>
将连接和断开连接的代码实现:
</p>

<ul class="org-ul">
<li><p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO, emit
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> usermanager <span style="font-weight: bold;">import</span> UserManager

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"connect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">connect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} Connected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.add_user(session.get(<span style="font-style: italic;">"username"</span>), request.sid)
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"disconnect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">disconnect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} disconnected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.remove_user(session.get(<span style="font-style: italic;">"username"</span>))
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run(app, debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div></li>

<li><p>
static/index.js:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">socket</span> = io()
socket.on(<span style="font-style: italic;">"connect"</span>, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"Connected!"</span>);
})
$(window).bind(<span style="font-style: italic;">"beforeunload"</span>, <span style="font-weight: bold;">function</span>(){
    socket.on(<span style="font-style: italic;">"disconnect"</span>);
})
</pre>
</div></li>
</ul>


<p>
访问 <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> 登录后跳转到聊天室首页,就可以在控制台看见
<code>user*** connected</code> 的消息,这说明客户端与服务器端完成了握手,实现了长连接.
后续就可以通过其他事件来实现客户端与服务器端的双向通信.在关闭聊天室标签页时,会在
控制台打印 <code>user *** disconnect</code> 的消息.
</p>
</div>
</div>

<div id="outline-container-orge0f9d00" class="outline-3">
<h3 id="orge0f9d00">获取在线用户</h3>
<div class="outline-text-3" id="text-orge0f9d00">
<p>
在客户端,我们需要获取当前在线的用户,才能选择用户进行单聊操作.
</p>

<p>
在每个客户端连接成功后,服务器端会广播 users 事件,并把当前登录的所有用户的用户名
都发送过去. 所以在客户端想要获取在线用户,只需要监听 users 事件( <code>emit 的代码</code>).
</p>

<p>
示例代码:
</p>
<div class="org-src-container">
<pre class="src src-javascript">socket.on(<span style="font-style: italic;">"users"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">result</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">users</span> = result.users;
    <span style="font-weight: bold;">for</span>(<span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">index</span>=0; index&lt;users.length; index++){
        <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">username</span> = users[index];
        console.log(username);
    }
});
</pre>
</div>
<p>
users 事件虽然不是 socketio 内置的,但是服务器端通过 emit 发送的任何事件都可以在
客户端通过 socket.on 监听,不管事件是不是内置的.
</p>

<ul class="org-ul">
<li><p>
static/index.js:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">socket</span> = io()
socket.on(<span style="font-style: italic;">"connect"</span>, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"Connected!"</span>);
})
$(window).bind(<span style="font-style: italic;">"beforeunload"</span>, <span style="font-weight: bold;">function</span>(){
    socket.on(<span style="font-style: italic;">"disconnect"</span>);
})
socket.on(<span style="font-style: italic;">"users"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">result</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">users</span> = result.users;
    <span style="font-weight: bold;">for</span>(<span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">index</span>=0; index&lt;users.length; index++){
        <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">username</span> = users[index];
        console.log(username);
    }
});
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5c1ff25" class="outline-3">
<h3 id="org5c1ff25">实现单聊</h3>
<div class="outline-text-3" id="text-org5c1ff25">
<p>
socketio 中没有提供单聊的事件,所以需要我们自定义,这里定义一个 personal 事件. 首
先,在服务器端实现如下代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"personal"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">send_personal</span>(data):
    <span style="font-weight: bold; font-style: italic;">to_username</span> = data.get(<span style="font-style: italic;">"to_user"</span>)
    <span style="font-weight: bold; font-style: italic;">message</span> = data.get(<span style="font-style: italic;">"message"</span>)
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> to_username <span style="font-weight: bold;">or</span> <span style="font-weight: bold;">not</span> UserManager.has_user(to_username):
        <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#30340;&#30446;&#26631;&#29992;&#25143;"</span>)
    <span style="font-weight: bold; font-style: italic;">to_user</span> = UserManager.get_user(to_username)
    emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"message"</span>: message, <span style="font-style: italic;">"from_user"</span>: session.get(<span style="font-style: italic;">"username"</span>)}, to=[to_user.get(<span style="font-style: italic;">"sid"</span>)])
</pre>
</div>

<p>
这段代码通过 <code>@socketio.on("personal")</code> 自定义了 personal 事件,以及
send_personal 处理函数,并且能接收客户端传递的参数. 在 send_personal 处理函数中,
先是获取了消息要发送的目标用户以及消息内容,在满足条件后,通过 emit 函数发送
personal 事件到 room 参数指定的客户端, 并且携带了消息内容以及消息发送者. 客户端
则通过监听和发送 personal 事件来实现与服务器端的交互, 客户端监听 personal 事件的
示例代码:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#30417;&#21548; personal &#20107;&#20214;</span>
socket.on(<span style="font-style: italic;">"personal"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">data</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">message</span> = data.message;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">from_user</span> = data.from_user;
    console.log(<span style="font-style: italic;">"message:"</span>+ message+ <span style="font-style: italic;">",from_user:"</span> + from_user);
});
</pre>
</div>
<p>
客户端主动向服务器发送 personal 事件的代码:
</p>

<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#23458;&#25143;&#31471;&#21521;&#26381;&#21153;&#22120;&#31471;&#21457;&#36865; personal &#20107;&#20214;</span>
socket.emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"to_user"</span>: to_user, <span style="font-style: italic;">"message"</span>: message}, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;"</span>);
});
</pre>
</div>
<p>
上面的监听和发送 personal 事件的代码中,我们实现了回调函数,在 personal 消息被成功
接收和发送后,都执行对应的回调函数.在回调函数中,我们执行了一些操作,例如将消息体添
加到对话中.
</p>

<blockquote>
<p>
回调函数就是 socket.on 和 socket.emit 函数的最后一个参数 <code>function(){}</code>
</p>
</blockquote>

<p>
将这部分的代码完善到项目中:
</p>

<ul class="org-ul">
<li><p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO, emit
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> usermanager <span style="font-weight: bold;">import</span> UserManager

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"connect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">connect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} Connected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.add_user(session.get(<span style="font-style: italic;">"username"</span>), request.sid)
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"disconnect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">disconnect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} disconnected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.remove_user(session.get(<span style="font-style: italic;">"username"</span>))
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"personal"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">send_personal</span>(data):
    <span style="font-weight: bold; font-style: italic;">to_username</span> = data.get(<span style="font-style: italic;">"to_user"</span>)
    <span style="font-weight: bold; font-style: italic;">message</span> = data.get(<span style="font-style: italic;">"message"</span>)
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> to_username <span style="font-weight: bold;">or</span> <span style="font-weight: bold;">not</span> UserManager.has_user(to_username):
        <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#30340;&#30446;&#26631;&#29992;&#25143;"</span>)
    <span style="font-weight: bold; font-style: italic;">to_user</span> = UserManager.get_user(to_username)
    emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"message"</span>: message, <span style="font-style: italic;">"from_user"</span>: session.get(<span style="font-style: italic;">"username"</span>)}, to=[to_user.get(<span style="font-style: italic;">"sid"</span>)])

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run(app, debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div></li>

<li><p>
static/index.js:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">socket</span> = io()
socket.on(<span style="font-style: italic;">"connect"</span>, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"Connected!"</span>);
})
$(window).bind(<span style="font-style: italic;">"beforeunload"</span>, <span style="font-weight: bold;">function</span>(){
    socket.on(<span style="font-style: italic;">"disconnect"</span>);
})
socket.on(<span style="font-style: italic;">"users"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">result</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">users</span> = result.users;
    <span style="font-weight: bold;">for</span>(<span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">index</span>=0; index&lt;users.length; index++){
        <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">username</span> = users[index];
        console.log(username);
    }
});
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#30417;&#21548; personal &#20107;&#20214;</span>
socket.on(<span style="font-style: italic;">"personal"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">data</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">message</span> = data.message;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">from_user</span> = data.from_user;
    console.log(<span style="font-style: italic;">"message:"</span>+ message+ <span style="font-style: italic;">",from_user:"</span> + from_user);
});
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#23458;&#25143;&#31471;&#21521;&#26381;&#21153;&#22120;&#31471;&#21457;&#36865; personal &#20107;&#20214;</span>
socket.emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"to_user"</span>: to_user, <span style="font-style: italic;">"message"</span>: message}, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;"</span>);
});
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1b117b1" class="outline-3">
<h3 id="org1b117b1">实现群聊</h3>
<div class="outline-text-3" id="text-org1b117b1">
<p>
Flask-SocketIO 中对群聊功能做了非常好的封装,例如,加入群聊有 join_room 函数,离开
群聊有 leave_room 函数. 服务器端加入群聊和离开群聊的示例代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21152;&#20837;&#32676;&#32842;</span>
<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"join"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">join</span>(data):
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    join_room(room)
    <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
    send(username+ <span style="font-style: italic;">"&#21152;&#20837;&#32676;&#32842;"</span>, to=room)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#31163;&#24320;&#32676;&#32842;</span>
<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"leave"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">leave</span>(data):
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    leave_room(room)
    <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
    send(username + <span style="font-style: italic;">"&#31163;&#24320;&#32676;&#32842;"</span>, to=room)
</pre>
</div>

<p>
客户端在某些情况下(例如,单击加入群聊),通过使用 emit 函数发送 join 事件,即可加入
房间, 代码如下.
</p>

<div class="org-src-container">
<pre class="src src-javascript">socket.emti(<span style="font-style: italic;">"join"</span>, {<span style="font-style: italic;">"room"</span>: <span style="font-style: italic;">"Flask&#20132;&#27969;&#32676;"</span>});
</pre>
</div>

<p>
通过以上代码就可以加入 "Flask交流群" 这个房间了. 也可以在某些情况下发送 levae 事
件,即可离开房间:
</p>
<div class="org-src-container">
<pre class="src src-javascript">socket.emti(<span style="font-style: italic;">"leave"</span>, {<span style="font-style: italic;">"room"</span>: <span style="font-style: italic;">"Flask&#20132;&#27969;&#32676;"</span>});
</pre>
</div>

<p>
房间名称如果之前不存在,不需要执行创建操作, Flask-SocketIO 会自动创建并让这个用户
加入房间. 加入房间后,就可以在房间里聊天了.
</p>

<p>
服务器端实现群聊:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@scoketio.on</span>(<span style="font-style: italic;">"room_chat"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">room_chat</span>(data):
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    <span style="font-weight: bold; font-style: italic;">message</span> = data.get(<span style="font-style: italic;">"message"</span>)
    <span style="font-weight: bold; font-style: italic;">from_user</span> = UserManager.get_current_user().get(<span style="font-style: italic;">"username"</span>)
    send({<span style="font-style: italic;">"message"</span>: message, <span style="font-style: italic;">"from_user"</span>: from_user, <span style="font-style: italic;">"room"</span>: room}, to=room)
</pre>
</div>

<p>
这段示例代码中,先从 data 中获取房间和消息内容,然后使用 flask_socketio.send 函数
将消息和消息发送者发送到 to 参数指定的房间中. 这样所有加入了这个房间的用户都可以
收到该消息,客户端监听房间消息的示例代码如下:
</p>
<div class="org-src-container">
<pre class="src src-javascript">socket.on(<span style="font-style: italic;">"room_chat"</span>, <span style="font-weight: bold;">function</span> (<span style="font-weight: bold; font-style: italic;">result</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">from_user</span> = result.from_user;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">message</span> = result.message;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">room</span> = result.room;
    console.log(<span style="font-style: italic;">"&#25151;&#38388;&#21495;:"</span> + room + <span style="font-style: italic;">"&#25910;&#21040;&#26469;&#33258;"</span> + from_user + <span style="font-style: italic;">"&#30340;&#28040;&#24687;"</span> + message);
});
</pre>
</div>
<p>
其他客户端发送了 room_chat 事件后,就能通过回调函数收到消息的相关信息了. 客户端想
要发送房间消息,调用 emit 函数即可.
</p>

<div class="org-src-container">
<pre class="src src-javascript">socket.emit(<span style="font-style: italic;">"room_chat"</span>, {<span style="font-style: italic;">"room"</span>: <span style="font-style: italic;">"Flask&#20132;&#27969;&#32676;"</span>, <span style="font-style: italic;">"message"</span>: <span style="font-style: italic;">"hello!"</span>});
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb58bee5" class="outline-3">
<h3 id="orgb58bee5">完整项目代码</h3>
<div class="outline-text-3" id="text-orgb58bee5">
<p>
因为我们是聊天室项目,所以聊天功能的实现一定是用 js 动态加载数据的,不能向
pythonbbs 项目一样先把数据传递到模板然后再完成渲染传递给客户端,因为是实时通信,所
以一定是收到数据后用 js 代码修改页面的内容, 作者给出的示例代码只是用来测试这些事
件是否成功进行了通信,在页面中是没有任何效果的,最多能在开发者工具的控制台中看到打
印的消息.
</p>

<blockquote>
<p>
准备直接实现群聊功能,跟着作者的代码搞了半天,没搞清楚这些消息发送和监听的详细机制,可
以发送 room_chat 事件,但就是接收不到消息,准备放弃的时候想到查找文档时看到的内容,
每个连接的用户都有一个自己的房间号,房间号名一般为 sid, 想到是不是监听还有房间号
的参数要求,结果发现 sid 就是 session 的 ID 每个客户端的 Session 设置后都会自动分
配且唯一的,不存在是找不到 sid 的问题,没办法,退一步准备先看看单聊的实现,结果发现
作者书里给的代码中实现单聊部分 emit 函数的关键字参数就错了, emit 只有关键字 to
的参数来指定发送的房间号,而不是 room, 作者给的代码里用的是 room 所以单聊的实现也
是可以发送但不能接收,将我所有 emit 中的 room= 改为了 to 之后一个客户端向另一个客
户端发送消息就可以收到了. 成功一次之后对 socketio 的事件机制有了一个大概正确的了
解了, 然后再次尝试实现群聊,在房间号正确,消息发送成功, 服务器端也收到了客户端发送
的消息的情况下,房间 Flask 仍然无法接收到消息,这说明客户端都没问题,只有服务器端发
送消息的时候出问题了,仔细阅读了代码,发现作者给的代码里单聊用的是 emit 发出
personal 事件给客户端传递消息,而群聊里用的是 send 给客户端发送消息,单聊中客户端
用 <code>socket.on("personal")</code> 监听事件和接收数据,但是群聊里仍然用的
<code>socket.on("room_chat")</code> 来监听事件和数据,这就不对了,因为 send 没有绑定任何事件,
所以客户端是监听不到 send 发送的信息的,所以才收不到消息. 另外,需要设置 broadcast
关键字参数为 True 才会让服务器向所有 to 参数指定的客户端发送消息(广播),否则,就算
to 指定的是一个房间号,服务器也不会向房间里所有用户发送消息,而是只向发起事件的客
户端发送响应的事件和消息.例如向 Flask 房间所有用户广播消息:
</p>
<div class="org-src-container">
<pre class="src src-python">emit(<span style="font-style: italic;">"room_chat"</span>, {<span style="font-style: italic;">"message"</span>: <span style="font-style: italic;">"hello"</span>, <span style="font-style: italic;">"from_user"</span>: <span style="font-style: italic;">"kamisama"</span>,<span style="font-style: italic;">"room"</span>:<span style="font-style: italic;">"Flask"</span>},to=<span style="font-style: italic;">"Flask"</span>,broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div>
<p>
修改了这几个重要的地方才能真正完成广播的功能.
</p>

<p>
因为只是为了搞懂 Flask 实现 WebSocket 的用法,所以成功实现功能后我就不打算进一步
完善这个项目了(好吧,其实就是不想去搞前端的 html 和 js 逻辑了.)
</p>
</blockquote>

<ul class="org-ul">
<li><p>
app.py:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> flask <span style="font-weight: bold;">import</span> Flask, render_template, request, redirect, session
<span style="font-weight: bold;">from</span> flask_socketio <span style="font-weight: bold;">import</span> SocketIO, emit, join_room, leave_room, send
<span style="font-weight: bold;">from</span> decorators <span style="font-weight: bold;">import</span> login_required
<span style="font-weight: bold;">from</span> usermanager <span style="font-weight: bold;">import</span> UserManager

<span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.<span style="font-weight: bold; font-style: italic;">config</span>[<span style="font-style: italic;">"SECRET_KEY"</span>] = <span style="font-style: italic;">"kamisama"</span>
<span style="font-weight: bold; font-style: italic;">socketio</span> = SocketIO(app)


<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">ResultCode</span>:
    <span style="font-weight: bold; font-style: italic;">OK</span> = 200
    <span style="font-weight: bold; font-style: italic;">ERROR_PARAMS</span> = 400
    <span style="font-weight: bold; font-style: italic;">ERROR_SERVER</span> = 500

<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">result</span>(code=ResultCode.OK, data=<span style="font-weight: bold; text-decoration: underline;">None</span>, message=<span style="font-style: italic;">""</span>):
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"code"</span>: code, <span style="font-style: italic;">"data"</span>: data <span style="font-weight: bold;">or</span> {}, <span style="font-style: italic;">"message"</span>: message}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)


<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/login"</span>,methods=[<span style="font-style: italic;">"GET"</span>, <span style="font-style: italic;">"POST"</span>])
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">login</span>():
    <span style="font-weight: bold;">if</span> request.method == <span style="font-style: italic;">"GET"</span>:
        <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"login.html"</span>)
    <span style="font-weight: bold;">else</span>:
        <span style="font-weight: bold; font-style: italic;">username</span> = request.form.get(<span style="font-style: italic;">"username"</span>)
        <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> username:
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#29992;&#25143;&#21517;"</span>)
        <span style="font-weight: bold;">elif</span> UserManager.has_user(username):
            <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS,message=<span style="font-style: italic;">"&#27492;&#29992;&#25143;&#21517;&#24050;&#23384;&#22312;"</span>)
        <span style="font-weight: bold; font-style: italic;">session</span>[<span style="font-style: italic;">"username"</span>] = username
        <span style="font-weight: bold;">return</span> result()

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"connect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">connect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} Connected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.add_user(session.get(<span style="font-style: italic;">"username"</span>), request.sid)
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"disconnect"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">disconnect</span>():
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"user {} disconnected!"</span>.<span style="font-weight: bold;">format</span>(session.get(<span style="font-style: italic;">"username"</span>)))
    UserManager.remove_user(session.get(<span style="font-style: italic;">"username"</span>))
    emit(<span style="font-style: italic;">"users"</span>, {<span style="font-style: italic;">"users"</span>: UserManager.all_username()}, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)

<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"personal"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">send_personal</span>(data):
    <span style="font-weight: bold; font-style: italic;">to_username</span> = data.get(<span style="font-style: italic;">"to_user"</span>)
    <span style="font-weight: bold; font-style: italic;">message</span> = data.get(<span style="font-style: italic;">"message"</span>)
    <span style="font-weight: bold;">if</span> <span style="font-weight: bold;">not</span> to_username <span style="font-weight: bold;">or</span> <span style="font-weight: bold;">not</span> UserManager.has_user(to_username):
        <span style="font-weight: bold;">return</span> result(ResultCode.ERROR_PARAMS, message=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#27491;&#30830;&#30340;&#30446;&#26631;&#29992;&#25143;"</span>)
    <span style="font-weight: bold; font-style: italic;">to_user</span> = UserManager.get_user(to_username)
    emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"message"</span>: message, <span style="font-style: italic;">"from_user"</span>: session.get(<span style="font-style: italic;">"username"</span>)}, to=[to_user.get(<span style="font-style: italic;">"sid"</span>)])


<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21152;&#20837;&#32676;&#32842;</span>
<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"join"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">join</span>(data):
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    join_room(room)
    <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
    send(username+<span style="font-style: italic;">"&#21152;&#20837;&#32676;&#32842;"</span>, to=room)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"{} emit join room: {}"</span>.<span style="font-weight: bold;">format</span>(username, room))

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#36864;&#20986;&#32676;&#32842;</span>
<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"leave"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">leave</span>(data):
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    leave_room(room)
    <span style="font-weight: bold; font-style: italic;">username</span> = session.get(<span style="font-style: italic;">"username"</span>)
    send(username + <span style="font-style: italic;">"&#31163;&#24320;&#32676;&#32842;"</span> , to=room)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#23454;&#29616;&#32676;&#32842;</span>
<span style="font-weight: bold; text-decoration: underline;">@socketio.on</span>(<span style="font-style: italic;">"room_chat"</span>)
<span style="font-weight: bold; text-decoration: underline;">@login_required</span>
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">room_chat</span>(data):
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"does room_chat received?"</span>)
    <span style="font-weight: bold; font-style: italic;">room</span> = data.get(<span style="font-style: italic;">"room"</span>)
    <span style="font-weight: bold; font-style: italic;">message</span> = data.get(<span style="font-style: italic;">"message"</span>)
    <span style="font-weight: bold; font-style: italic;">from_user</span> = UserManager.get_current_user().get(<span style="font-style: italic;">"username"</span>)
    emit(<span style="font-style: italic;">"room_chat"</span>, {<span style="font-style: italic;">"message"</span>: message, <span style="font-style: italic;">"from_user"</span>: from_user, <span style="font-style: italic;">"room"</span>:room}, to=room, broadcast=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"{} send to room: {} a message :{}"</span>.<span style="font-weight: bold;">format</span>(from_user, room, message))


<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    socketio.run(app, debug=<span style="font-weight: bold; text-decoration: underline;">True</span>)
</pre>
</div></li>
<li><p>
templates/index.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">!DOCTYPE</span> html&gt;
&lt;<span style="font-weight: bold;">html</span> <span style="font-weight: bold; font-style: italic;">lang</span>=<span style="font-style: italic;">"en"</span>&gt;
&lt;<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">meta</span> <span style="font-weight: bold; font-style: italic;">charset</span>=<span style="font-style: italic;">"UTF-8"</span>&gt;
&lt;<span style="font-weight: bold;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">&#30693;&#20102;&#32842;&#22825;&#23460;</span>&lt;/<span style="font-weight: bold;">title</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/socket.io/4.1.3/socket.io.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"https://cdn.bootcdn.net/ajax/libs/art-template/4.13.2/lib/template-web.min.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">style</span>&gt;
    *{
    list-style: none;
    padding: 0;
    margin: 0;
    }
    html{
    height: 100%;
    }
    body{
    height: 100%;
    background: url("/static/bg.jpg") no-repeat 100% 100%;
    }
    .main{
    width: 800px;
    margin: 0 auto;
    }
    .chat-container{
    height: 590px;
    display: flex;
    justify-content: flex-start;
    }
    .chat-list-group{
    background-color: #ffffff;
    width: 200px;
    border-right: 1px solid #cccccc;
    }
    .chat-group{
    background-color: #ffffff;
    flex: 1;
    }
    .module-title{
    height: 40px;
    line-height: 40px;
    padding-left: 10px;
    font-weight: 700;
    border-bottom: 1px solid #ccc;
    }
    .list-group{
    height: 549px;
    overflow-y: scroll;
    }
    .list-group .list-group-item{
    padding: 0 10px;
    border-bottom: 1px solid #ccc;
    height: 60px;
    line-height: 60px;
    box-sizing: border-box;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    cursor: pointer;
    }
    .chat-box{
    height: 340px;
    background-color: #ffffff;
    padding: 10px;
    overflow-y: scroll;
    border-bottom: 1px solid #cccccc;
    }
    .chat-content-box{
    margin-bottom: 10px;
    overflow-y: hidden;
    display: flex;
    justify-items: center;
    padding: 5px;
    }
    .chat-content{
    background-color: #ccc;
    padding: 5px;
    }
    .username{
    padding: 5px;
    }
    .friend{}
    .me{
    justify-content: right;
    }
    .chat-input-group{
    padding: 10px;
    box-sizing: border-box;
    }
    .chat-input-group .chat-textarea{
    display: block;
    width: 100%;
    height: 120px;
    outline: none;
    border: none;
    resize: none;
    }
    .button{
    display: inline-block;
    width: 80px;
    height: 30px;
    cursor: pointer;
    }
&lt;/<span style="font-weight: bold;">style</span>&gt;
&lt;/<span style="font-weight: bold;">head</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-template"</span>&gt;
{% raw %}
    {{ each chats }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#31169;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
    {{ /each }}
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"group-list-template"</span>&gt;
{% raw %}
{{ each groups }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group-item"</span>&gt;&#12304;&#32676;&#12305;{{ $value.name }}&lt;/<span style="font-weight: bold;">li</span>&gt;
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">type</span>=<span style="font-style: italic;">"text/html"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-content-template"</span>&gt;
{% raw %}
{{ if from_user=="me" }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box me"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;&#65306;&#25105;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
{{ else }}
    &lt;<span style="font-weight: bold;">li</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-content-box"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"username"</span>&gt;{{ from_user }}&#65306;&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"friend chat-content"</span>&gt;{{ message }}&lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">li</span>&gt;
{{ /if }}
{% endraw %}
&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;<span style="font-weight: bold;">body</span>&gt;
&lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"main"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"padding-top: 100px;"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-container"</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#21015;&#34920;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"list-group"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-ul"</span>&gt;
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-group"</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"module-title"</span>&gt;&#32842;&#22825;&#31383;&#21475;&lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-box"</span>&gt;
        &lt;<span style="font-weight: bold;">ul</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-list-box"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-list-box"</span>&gt;
        &lt;/<span style="font-weight: bold;">ul</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-input-group"</span>&gt;
        &lt;<span style="font-weight: bold;">textarea</span> <span style="font-weight: bold; font-style: italic;">name</span>=<span style="font-style: italic;">"chat-content"</span> <span style="font-weight: bold; font-style: italic;">placeholder</span>=<span style="font-style: italic;">"&#35831;&#36755;&#20837;&#32842;&#22825;&#20869;&#23481;..."</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"chat-textarea"</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"chat-textarea"</span>&gt;&lt;/<span style="font-weight: bold;">textarea</span>&gt;
        &lt;<span style="font-weight: bold;">div</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button-group"</span> <span style="font-weight: bold; font-style: italic;">style</span>=<span style="font-style: italic;">"text-align: right;"</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"create-room-button"</span>&gt;&#21019;&#24314;&#32676;&#32842;&lt;/<span style="font-weight: bold;">button</span>&gt;
            &lt;<span style="font-weight: bold;">button</span> <span style="font-weight: bold; font-style: italic;">class</span>=<span style="font-style: italic;">"button"</span> <span style="font-weight: bold; font-style: italic;">id</span>=<span style="font-style: italic;">"send-button"</span>&gt;&#21457;&#36865;&lt;/<span style="font-weight: bold;">button</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
        &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
    &lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;/<span style="font-weight: bold;">div</span>&gt;
&lt;<span style="font-weight: bold;">script</span> <span style="font-weight: bold; font-style: italic;">src</span>=<span style="font-style: italic;">"/static/index.js"</span>&gt;&lt;/<span style="font-weight: bold;">script</span>&gt;
&lt;/<span style="font-weight: bold;">body</span>&gt;
&lt;/<span style="font-weight: bold;">html</span>&gt;
</pre>
</div></li>
<li><p>
static/index.js:
</p>
<div class="org-src-container">
<pre class="src src-javascript"><span style="font-weight: bold;">const</span> <span style="font-weight: bold; font-style: italic;">socket</span> = io()
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#24314;&#31435;&#36830;&#25509;</span>
socket.on(<span style="font-style: italic;">"connect"</span>, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"Connected!"</span>);
})
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#36864;&#20986;&#21069;&#26029;&#24320;&#36830;&#25509;</span>
$(window).bind(<span style="font-style: italic;">"beforeunload"</span>, <span style="font-weight: bold;">function</span>(){
    socket.on(<span style="font-style: italic;">"disconnect"</span>);
});
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#30417;&#21548; users &#20107;&#20214;,&#33719;&#21462;&#25152;&#26377;&#36830;&#25509;&#30340; username</span>
socket.on(<span style="font-style: italic;">"users"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">result</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">users</span> = result.users;
    $(<span style="font-style: italic;">"#chat-ul"</span>).empty();
    <span style="font-weight: bold;">for</span>(<span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">index</span>=0; index&lt;users.length; index++){
        <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">username</span> = users[index];
        console.log(username);
        $(<span style="font-style: italic;">"#chat-ul"</span>).append( <span style="font-style: italic;">"&lt;li&gt;"</span> + username + <span style="font-style: italic;">"&lt;/li&gt;"</span>);
    };
});

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#31169;&#32842;</span>
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#30417;&#21548; personal &#20107;&#20214;</span>
socket.on(<span style="font-style: italic;">"personal"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">data</span>){
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">message</span> = data.message;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">from_user</span> = data.from_user;
    console.log(<span style="font-style: italic;">"message:"</span>+ message+ <span style="font-style: italic;">",from_user:"</span> + from_user);
});
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#23458;&#25143;&#31471;&#21521;&#26381;&#21153;&#22120;&#31471;&#21457;&#36865; personal &#20107;&#20214;</span>
socket.emit(<span style="font-style: italic;">"personal"</span>, {<span style="font-style: italic;">"to_user"</span>: <span style="font-style: italic;">"kamisama"</span>, <span style="font-style: italic;">"message"</span>: <span style="font-style: italic;">"hello kamisama"</span>}, <span style="font-weight: bold;">function</span>(){
    console.log(<span style="font-style: italic;">"&#28040;&#24687;&#21457;&#36865;&#25104;&#21151;"</span>);
});

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#32676;&#32842;</span>

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21152;&#20837; Flask&#20132;&#27969;&#32676;</span>
socket.emit(<span style="font-style: italic;">"join"</span>, {<span style="font-style: italic;">"room"</span>: <span style="font-style: italic;">"Flask"</span>});
<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#25509;&#25910;&#32676;&#32842;</span>
socket.on(<span style="font-style: italic;">"room_chat"</span>, <span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">result</span>){
    console.log(<span style="font-style: italic;">"test debug"</span>);
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">from_user</span> = result.from_user;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">message</span> = result.message;
    <span style="font-weight: bold;">let</span> <span style="font-weight: bold; font-style: italic;">room</span> = result.room;
    console.log(<span style="font-style: italic;">" &#25151;&#38388;&#21495;:"</span> + room + <span style="font-style: italic;">"&#25910;&#21040;&#26469;&#33258;"</span> + from_user + <span style="font-style: italic;">"&#30340;&#28040;&#24687;: "</span> + message);
    <span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">$("#chat-list-box").append("&lt;li&gt;" + message + "&lt;/li&gt;");</span>
});

<span style="font-weight: bold; font-style: italic;">// </span><span style="font-weight: bold; font-style: italic;">&#21457;&#36865;&#32676;&#32842;&#28040;&#24687;</span>
$(<span style="font-style: italic;">"#send-button"</span>).click(<span style="font-weight: bold;">function</span>(<span style="font-weight: bold; font-style: italic;">event</span>){
    event.preventDefault();
    console.log(<span style="font-style: italic;">"asdfasdfasdf"</span>);
    socket.emit(<span style="font-style: italic;">"room_chat"</span>, {<span style="font-style: italic;">"room"</span>: <span style="font-style: italic;">"Flask"</span>, <span style="font-style: italic;">"message"</span>: <span style="font-style: italic;">"hello"</span>});
    console.log(<span style="font-style: italic;">"asdfasdfasdf"</span>);
});
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-orgd97f277" class="outline-3">
<h3 id="orgd97f277">部署项目</h3>
<div class="outline-text-3" id="text-orgd97f277">
<p>
作者仍然使用 gunicorn 部署 Flask-SocketIO 项目,另外还要使用 eventlet 或 gevent
来运行 Flask-SocketIO. 官方推荐 eventlet ,而且 eventlet 比 gevent 效率高(没测).
</p>

<p>
安装 eventlet:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install eventlet
</pre>
</div>

<p>
gunicorn.conf.py 配置:
</p>
<div class="org-src-container">
<pre class="src src-python">gunicorn --worker-<span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">eventlet</span> app:app
</pre>
</div>
<p>
<code>--worker-class</code> 指定工作进程由 eventlet 运行.
</p>

<p>
和 pythonbbs 一样,使用 Nginx 作为项目的 Web 服务器. Nginx 的配置都大致相同,不同
的是 Nginx 需要增加 JavaScript SocketIO 默认的 /socket.io 转发.
Nginx 配置:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span style="font-weight: bold; text-decoration: underline;">server</span>{
        listen 80;
        server_name _;
        <span style="font-weight: bold; text-decoration: underline;">location /</span>{
        include proxy_params;
        proxy_pass http://127.0.0.1:5000;
        }
        <span style="font-weight: bold; text-decoration: underline;">location /static</span>{
        alias &lt;path/to/application&gt;/static;
        expires 30d;
        }
        <span style="font-weight: bold; text-decoration: underline;">location /socket.io</span>{
        indclude proxy_params;
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection <span style="font-style: italic;">"Upgrade"</span>;
        proxy_pass http://127.0.0.1:5000/socket.io;
        }
}
</pre>
</div>

<p>
Nginx 监听到 location/socket.io 后,会把请求代理给 Flask-SocketIO 项目的
location/socket.io 路径,这样就完成了 Nginx 配置.
</p>

<blockquote>
<p>
鉴于前面 pythonbbs 部署时作者给出的配置代码与我本机系统以及软件版本可能的不兼容
或是错误的配置,导致我浪费大量事件去找错,这个项目我就不进行部署了,反正没有什么新
的内容,还可能一堆错误,而且越到后面就感觉书的内容质量越差了,最后这个 websocket 实
战和下一章Flask 异步编程我都怀疑是不是拿来凑数的,要不是没有在文档里找到完全一样
的代码,我都怀疑是不是又是从哪个官方文档里粘贴过来的.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orgf62f186" class="outline-2">
<h2 id="orgf62f186">Flask 异步编程</h2>
<div class="outline-text-2" id="text-orgf62f186">
<p>
Python 3.6 开始官方将异步编程标准库 asyncio 转正为内置库后,python 的异步编程开始
大放异彩.
</p>

<p>
aio-libs 组织(<a href="https://github.com/aio-libs">https://github.com/aio-libs</a>) 发布了一系列的异步编程库,如网络请求的
aiohttp 库,(<a href="https://docs.aiohttp.org">https://docs.aiohttp.org</a>), 连接 Redis 的 aioredis-py 库等等. Flask
在 2.0 版本开始支持异步编程. 同时配套的 SQLAlchemy 在 1.4 开始增加了异步 API
,Jinja2 在 2.9 版本开始支持异步模式,其他框架如 Django 在3.0 版本也加入了异步支持.
</p>
</div>

<div id="outline-container-org66f8cec" class="outline-3">
<h3 id="org66f8cec">asyncio 标准库</h3>
<div class="outline-text-3" id="text-org66f8cec">
<p>
Flask 异步编程是基于 Python 内置的 asyncio 模块的, 所以只有学懂了 asyncio 的相关
概念和基本用法,才能理解 Flask 的异步编程.
</p>

<p>
这个部分会围绕 "事件循环","协程","Task对象","Future对象" 等概念讲解 asyncio 的工
作机制.
</p>

<blockquote>
<p>
python 3.8 的 asyncio 库在 windows 上有一个 bug , 在运行时出现 ValueError:
set_wakeup_fd only works in main thread 的错误, 将 python 升级到 3.9 可以解决.
</p>
</blockquote>
</div>

<div id="outline-container-org56daade" class="outline-4">
<h4 id="org56daade">事件循环</h4>
<div class="outline-text-4" id="text-org56daade">
<p>
在非阻塞代码的执行过程中,为了在事件发生时能准确执行回调,需要不断轮询是否有事件发
生. 轮询等待事件的过程,就叫做 <b>事件循环</b>. 在 asyncio 库中,一般不需要自己手动创建
事件循环,通过 asyncio.run 运行协程便会自动创建事件循环.
</p>
</div>
</div>

<div id="outline-container-orgf08c80a" class="outline-4">
<h4 id="orgf08c80a">协程</h4>
<div class="outline-text-4" id="text-orgf08c80a">
<p>
从 Python 3.5 添加 async 和 await 关键字依赖,只要以 async def 开头定义的函数,就
都叫做协程.
</p>

<p>
协程在执行过程中可以被挂起和恢复,因此可以用于构建异步程序. 驱动协程执行必须使用
await 关键字.
</p>

<p>
示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> asyncio

<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">nested</span>():
    asyncio.sleep(1)
    <span style="font-weight: bold;">return</span> 42

<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">main</span>():
    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21482;&#21019;&#24314;&#19968;&#20010;&#21327;&#31243;&#23545;&#35937;,&#24182;&#27809;&#26377;&#25191;&#34892;.</span>
    nested()

    <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#20351;&#29992; await &#20851;&#38190;&#23383;,&#39537;&#21160;&#24182;&#31561;&#24453;&#21327;&#31243;&#23545;&#35937;&#25191;&#34892;</span>
    <span style="font-weight: bold; font-style: italic;">result</span> = <span style="font-weight: bold;">await</span> nested()

    <span style="font-weight: bold;">print</span>(result)

<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&#21019;&#24314;&#19968;&#20010;&#20107;&#20214;&#24490;&#29615;&#24182;&#25191;&#34892; main &#21327;&#31243;</span>
asyncio.run(main())
</pre>
</div>
</div>
</div>

<div id="outline-container-org0f06a04" class="outline-4">
<h4 id="org0f06a04">Task(任务)对象</h4>
<div class="outline-text-4" id="text-org0f06a04">
<p>
Task 是用来调度协程的挂起和恢复的. 协程本身只能通过同步的方式执行,如果需要并行执
行多个协程,则必须把协程封装为 Task 对象. 在 asyncio 库中,可以通过 asyncio.gather
方法将多个协程并行执行, asyncio.gather 方法内部会自动将协程封装为 Task, 无需手动
封装. 并行执行任务的示例代码:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> asyncio
<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">my_worker</span>(index):
    <span style="font-weight: bold;">await</span> asyncio.sleep(1)
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"worker %d"</span> % index)

<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">main</span>():
    <span style="font-weight: bold; font-style: italic;">tasks</span> = []
    <span style="font-weight: bold;">for</span> x <span style="font-weight: bold;">in</span> <span style="font-weight: bold;">range</span>(1, 6):
        tasks.append(my_worker(x))
    <span style="font-weight: bold;">await</span> asyncio.gather(*tasks)
</pre>
</div>

<p>
mian 协程中创建了 5 个 my_worker 协程对象,并添加到列表 tasks 中, 然后统一传递给
asyncio.gather 方法并行执行. 上述的 main 协程只需要 1s 就可以完成 5 个 my_worker
协程的执行.
</p>
</div>
</div>

<div id="outline-container-org50fd794" class="outline-4">
<h4 id="org50fd794">Future对象</h4>
<div class="outline-text-4" id="text-org50fd794">
<p>
Future对象有两个作用:
</p>
<ul class="org-ul">
<li>保存协程执行后的结果.</li>
<li>用来和 Task 对象配合,调度执行协程.</li>
</ul>


<p>
Future 在 asyncio 库中相对来讲是比较低层级的对象,通常没有必要在应用层级代码中创
建 Future 对象.
</p>
</div>
</div>
</div>

<div id="outline-container-orgdb2ec77" class="outline-3">
<h3 id="orgdb2ec77">aiohttp库</h3>
<div class="outline-text-3" id="text-orgdb2ec77">
<p>
aio-libs 组织发布了一系列异步库,其中就有异步网络库 aiohttp .
</p>

<p>
aiohttp 库有以下特点:
</p>
<ul class="org-ul">
<li>aiohttp 既是 HTTP 客户端, 也是 HTTP 服务端.</li>
<li>aiohttp 同时支持服务端的 WebSocket 和客户端的 WebSocket.</li>
<li>aiohttp 作为服务端来说,有中间件,信号和可插拔的路由.</li>
</ul>


<p>
因为 aiohttp 库简单易用,功能强大,所以成为了 python 中发送异步网络请求的首选框架.
</p>

<p>
安装 aiohttp:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install aiohttp[speedups]
</pre>
</div>
<p>
这个安装命令除了安装 aiohttp 库,还会安装 cchardet 和 aiodns 库. cchardet 库是为
了替换默认的 chardet 库,从而达到更高的效率, aiodns 库可以提高 DNS 域名的解析速度.
</p>

<p>
aiohttp 的使用示例:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">import</span> aiohttp
<span style="font-weight: bold;">import</span> asyncio

<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">main</span>():
    <span style="font-weight: bold;">async with</span> aiohttp.ClientSession() <span style="font-weight: bold;">as</span> session:
        <span style="font-weight: bold;">async with</span> session.get(<span style="font-style: italic;">"http://python.org"</span>) <span style="font-weight: bold;">as</span> response:
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"StatusCode:"</span>, response.status)
            <span style="font-weight: bold; font-style: italic;">html</span> = <span style="font-weight: bold;">await</span> response.text()
            <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"Response:"</span>, html)

<span style="font-weight: bold;">if</span> <span style="font-weight: bold;">__name__</span> == <span style="font-style: italic;">"__main__"</span>:
    asyncio.run(main())
</pre>
</div>


<p>
这个示例中,使用 async with 创建了一个会话对象 session, 其中 async with 是异步上
下文,与普通的 with 用法类似,然后使用 session.get 获取数据,将响应赋值给 response
对象. 因为状态码可以直接获取,所以不需要执行 await, 响应体需要经过读取和解码因此
使用 await 等待协程完成的方式获取,这样就使用 aiohttp 库完成了一个基本网络请求.
</p>
</div>
</div>

<div id="outline-container-org63522f9" class="outline-3">
<h3 id="org63522f9">异步版 Flask 安装与异步编程性能</h3>
<div class="outline-text-3" id="text-org63522f9">
<p>
Flask 在 2.0起就实现了异步功能,这部分会讲解异步Flask 的安装,Flask 异步编程性能,
以及异步编程在 Flask 项目中的实战应用场景.
</p>
</div>

<div id="outline-container-orgde8d330" class="outline-4">
<h4 id="orgde8d330">安装异步版Flask</h4>
<div class="outline-text-4" id="text-orgde8d330">
<p>
要在 Flask 中执行异步编程,需要 3.7 以上的 python 版本,其次,在安装 Flask 时要选择
异步扩展.
</p>

<div class="org-src-container">
<pre class="src src-sh">pip install flask[async]
</pre>
</div>

<p>
上面的命令除了安装异步版 Flask 还会安装 asgiref, 用来将同步代码和异步代码相互转
换.安装了 asgiref 后,在 Flask 中,视图函数,钩子函数(如 error_handlers,
before_request 等)都可以定义成异步的:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/get-data"</span>)
<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">get_data</span>():
    <span style="font-weight: bold; font-style: italic;">data</span> = <span style="font-weight: bold;">await</span> async_db_query()
    <span style="font-weight: bold;">return</span> jsonify(data)
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc76b3b1" class="outline-4">
<h4 id="orgc76b3b1">Flask异步编程性能</h4>
<div class="outline-text-4" id="text-orgc76b3b1">
<p>
Flask 是符合 WSGI 接口的框架, WSGI 本身是同步执行的. WSGI 服务器每次收到一个请求,就
会启动一个新的线程,然后在线程中可以创建事件循环来执行异步视图函数,每一个请求就创
建一个新线程,因此,异步和同步的并发量其实是一致的. 异步的代码不一定比同步代码执行
效率更高,只有在执行 I/O 操作时才能体现并发的优势,当函数有一些 I/O 操作,且每个
I/O 操作不需要花费太长事件时才考虑使用异步代码.例如一下场景:
</p>
<ul class="org-ul">
<li>向站外发送一些 HTTP 请求.</li>
<li>和数据库有一些交互操作.</li>
<li>有文件操作.</li>
</ul>


<p>
对于一些长时间的任务和 CPU 密集型的任务,是不适合使用异步的:
</p>
<ul class="org-ul">
<li>运行机器学习模型.</li>
<li>处理图片,转码视频或者生成 PDF 文件等.</li>
<li>执行备份.</li>
</ul>


<p>
这一类长时间或CPU 密集型的任务,建议使用 Celery 异步框架.
</p>
</div>
</div>

<div id="outline-container-orgc8e81e4" class="outline-4">
<h4 id="orgc8e81e4">实战&#x2013;异步发送HTTP请求</h4>
<div class="outline-text-4" id="text-orgc8e81e4">
<p>
发送一些 HTTP 请求是异步最合适的场景之一. 如果按照同步的方法执行,必须要等到第一
个请求响应后才会执行第二个请求,以此类推,如果每个请求响应时间为 1s ,10 个请求就需
要至少 10s 才能完成.
</p>

<p>
我们使用 requests 库发送同步请求,先安装 requests 库:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install requests
</pre>
</div>

<p>
然后发送 5 个网络请求,并计算时间:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/website/sync"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">website_sync</span>():
    <span style="font-weight: bold; font-style: italic;">start_time</span> = time.time()
    <span style="font-weight: bold; font-style: italic;">urls</span> = [<span style="font-style: italic;">"https://www.python.org/"</span>,
            <span style="font-style: italic;">"https://www.php.net/"</span>,
            <span style="font-style: italic;">"https://java.com/"</span>,
            <span style="font-style: italic;">"https://dotnet.microsoft.com/"</span>,
            <span style="font-style: italic;">"https://www.javascript.com/"</span>]
    <span style="font-weight: bold; font-style: italic;">sites</span> = []
    <span style="font-weight: bold;">for</span> url <span style="font-weight: bold;">in</span> urls:
        <span style="font-weight: bold; font-style: italic;">response</span> = requests.get(url)
        sites.append({<span style="font-style: italic;">"url"</span>:response.url, <span style="font-style: italic;">"status"</span>:response.status_code})
    <span style="font-weight: bold; font-style: italic;">response</span> = <span style="font-style: italic;">"&lt;h1&gt;URLs:&lt;/h1&gt;"</span>
    <span style="font-weight: bold;">for</span> site <span style="font-weight: bold;">in</span> sites:
        <span style="font-weight: bold; font-style: italic;">response</span> += <span style="font-style: italic;">"&lt;p&gt;URL:{}, Status Code: {}&lt;/p&gt;"</span>.<span style="font-weight: bold;">format</span>(site[<span style="font-style: italic;">"url"</span>], site[<span style="font-style: italic;">"status"</span>])
    <span style="font-weight: bold; font-style: italic;">end_time</span> = time.time()
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"time:{.2f}"</span>.<span style="font-weight: bold;">format</span>(end_time-start_time))
    <span style="font-weight: bold;">return</span> response
</pre>
</div>
<p>
这个视图函数向 5 个不同的 URL 发送请求,使用的是同步的方法.执行消耗时间为 10.28s.
</p>

<p>
如果用异步完成上面的 5 个请求,假设每个请求响应时间为 1s, 一次性发起 5 个请求,则
5 个请求可以在 1s 多一点的时间内完成:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">fetch_url</span>(session, url):
    <span style="font-weight: bold; font-style: italic;">response</span> = <span style="font-weight: bold;">await</span> session.get(url)
    <span style="font-weight: bold;">return</span> {<span style="font-style: italic;">"url"</span>: response.url, <span style="font-style: italic;">"status"</span>: response.status}

<span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/website/async"</span>)
<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">website_async</span>():
    <span style="font-weight: bold; font-style: italic;">start_time</span> = time.time()
    <span style="font-weight: bold; font-style: italic;">urls</span> = [<span style="font-style: italic;">"https://www.python.org/"</span>,
            <span style="font-style: italic;">"https://www.php.net/"</span>,
            <span style="font-style: italic;">"https://java.com/"</span>,
            <span style="font-style: italic;">"https://dotnet.microsoft.com/"</span>,
            <span style="font-style: italic;">"https://www.javascript.com/"</span>]

    <span style="font-weight: bold;">async with</span> aiohttp.ClientSession() <span style="font-weight: bold;">as</span> session:
        <span style="font-weight: bold; font-style: italic;">tasks</span> = []
        <span style="font-weight: bold;">for</span> url <span style="font-weight: bold;">in</span> urls:
            tasks.append(fetch_url(session,url))
        <span style="font-weight: bold; font-style: italic;">sites</span> = <span style="font-weight: bold;">await</span> asyncio.gather(*tasks)
    <span style="font-weight: bold; font-style: italic;">response</span> = <span style="font-style: italic;">"&lt;h1&gt;URLs:&lt;/h1&gt;"</span>
    <span style="font-weight: bold;">for</span> site <span style="font-weight: bold;">in</span> sites:
        <span style="font-weight: bold; font-style: italic;">response</span> += <span style="font-style: italic;">"&lt;p&gt;URL:{}, Status Code: {}&lt;/p&gt;"</span>.<span style="font-weight: bold;">format</span>(site[<span style="font-style: italic;">"url"</span>], site[<span style="font-style: italic;">"status"</span>])
    <span style="font-weight: bold; font-style: italic;">end_time</span> = time.time()
    <span style="font-weight: bold;">print</span>(<span style="font-style: italic;">"time:{.2f}"</span>.<span style="font-weight: bold;">format</span>(end_time-start_time))
    <span style="font-weight: bold;">return</span> response
</pre>
</div>
<p>
这段代码里,使用了 asyncio 将 5 个 HTTP 请求的协程并行运行. 执行上述代码消耗的时
间为2.57s. 执行效率是同步的 4 倍左右.
</p>

<p>
如果上面的任务不是用 asyncio.gather 并行运行,则执行过程仍为同步.
</p>
</div>
</div>

<div id="outline-container-org4d2f930" class="outline-4">
<h4 id="org4d2f930">使用异步SQLAlchemy</h4>
<div class="outline-text-4" id="text-org4d2f930">
<p>
SQLAlchemy 在 1.4 版本开始就添加了异步 API, 可以方便地倍集成到 Flask 和其他 Web
框架(如 FastAPI)中. 在 Flask 中使用异步 SQLAlchemy 不能选择 Flask-SQLAlchemy,
Flask-SQLAlchemy 没有提供用来替换 AsyncEngine 和 AsyncSession 的接口,因此需要手
动创建连接对象.
</p>

<p>
作者说为了简单,就使用 sqlite (python 自带的小型数据库)作为数据库 ,先要安装异步连
接 sqlite 数据库的驱动包:
</p>
<div class="org-src-container">
<pre class="src src-sh">pip install aiosqlite
</pre>
</div>

<blockquote>
<p>
如果想要异步操作 MYSQL 数据库,需要安装 pymysql 和 aiomysql 两个驱动程序,并在数据
库连接 URL 上将 mysql+pymysql 修改为 mysql+aiomysql
</p>
</blockquote>
<p>
使用 SQLAlchemy 创建异步连接 sqlite 对象的示例代码:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">from</span> sqlalchemy.ext.asyncio <span style="font-weight: bold;">import</span> create_async_engine, AsyncSession
<span style="font-weight: bold;">from</span> sqlalchemy.orm <span style="font-weight: bold;">import</span> declarative_base, sessionmaker
<span style="font-weight: bold;">from</span> sqlalchemy <span style="font-weight: bold;">import</span> Column, Integer, String, Float

<span style="font-weight: bold; font-style: italic;">DATABASE_URL</span> = <span style="font-style: italic;">"sqlite+aiosqlite:///./book.db"</span>
<span style="font-weight: bold; font-style: italic;">engine</span> = create_async_engine(DATABASE_URL, echo=<span style="font-weight: bold; text-decoration: underline;">True</span>)
<span style="font-weight: bold; font-style: italic;">async_session</span> = sessionmaker(bind=engine, expire_on_commit=<span style="font-weight: bold; text-decoration: underline;">False</span>, class_ = AsyncSession)

<span style="font-weight: bold; font-style: italic;">Base</span> = declarative_base()
</pre>
</div>
<p>
这段代码中,首先创建了连接数据库的配置URL，然后使用 create_async_engine 方法创建
了一个异步引擎,接着使用 sessionmaker 方法创建了一个异步 session 对象, 并指定创建
的父类是 AsyncSession. 最后用 declarative_base 方法创建了一个 ORM 模型的基类
Base. 这样以后所有的 ORM 模型都需要继承自 Base.
</p>

<p>
下面就创建一个 Book 模型作为示例:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold;">class</span> <span style="font-weight: bold; text-decoration: underline;">Book</span>(Base):
    <span style="font-weight: bold; font-style: italic;">__tablename__</span> = <span style="font-style: italic;">"books"</span>
    <span style="font-weight: bold;">id</span> = Column(Integer, primary_key=<span style="font-weight: bold; text-decoration: underline;">True</span>)
    <span style="font-weight: bold; font-style: italic;">name</span> = Column(String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = Column(String(200), nullable=<span style="font-weight: bold; text-decoration: underline;">False</span>)
    <span style="font-weight: bold; font-style: italic;">price</span>  = Column(Float, default=0)
</pre>
</div>
<p>
在第一次请求前,需要把 ORM 模型创建到数据库中,所以添加以下钩子函数:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.before_first_request</span>
<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">before_first_request</span>():
    <span style="font-weight: bold;">async with</span> engine.begin() <span style="font-weight: bold;">as</span> conn:
        <span style="font-weight: bold;">await</span> conn.run_sync(Base.metadata.drop_all)
        <span style="font-weight: bold;">await</span> conn.run_sync(Base.metadata.create_all)
</pre>
</div>
<p>
上述代码将钩子函数 before_first_request 定义成了协程,然后用 async with 异步上下
文来创建了一个事务,以同步的方式将原来的表删除,并创建新的表. 这里用同步的方式是因
为 Base.metadata.drop_all 和 Base.metadata.create_all 两个方法都没有被定义成异步.
</p>

<blockquote>
<p>
如果想要用类似 flask-migrate 的方法同步 ORM 模型到数据库, 可以使用 alembic 官网: <a href="https://alembic.sqlalchemy.org/en/latest/">https://alembic.sqlalchemy.org/en/latest/</a>
</p>
</blockquote>

<p>
接着添加一个创建图书的异步视图:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.post</span>(<span style="font-style: italic;">"/books/add"</span>)
<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">add_books</span>():
    <span style="font-weight: bold; font-style: italic;">name</span> = request.form.get(<span style="font-style: italic;">"name"</span>)
    <span style="font-weight: bold; font-style: italic;">author</span> = request.form.get(<span style="font-style: italic;">"author"</span>)
    <span style="font-weight: bold; font-style: italic;">price</span> = request.form.get(<span style="font-style: italic;">"price"</span>)
    <span style="font-weight: bold;">async with</span> async_session() <span style="font-weight: bold;">as</span> session:
        <span style="font-weight: bold;">async with</span> session.begin():
            <span style="font-weight: bold; font-style: italic;">book</span> = Book(name=name, author=author, price=price)
            session.add(book)
            <span style="font-weight: bold;">await</span> session.flush()

    <span style="font-weight: bold;">return</span> <span style="font-style: italic;">"success"</span>
</pre>
</div>
<p>
这段代码首先使用异步上下文创建一个 session 对象,然后使用 session.begin 创建一个
事务,在事务中添加图书到数据库. 这个例子里没有涉及并行 I/O 操作,和同步执行的效率
是一样的. 这也说明了同步编程的方式仍然是大部分场景的首选方式.
</p>

<p>
更多关于异步SQLAlchemy 的知识,参考文档: <a href="https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html">https://docs.sqlalchemy.org/en/14/orm/extensions/asyncio.html</a>
</p>
</div>
</div>

<div id="outline-container-org59862d7" class="outline-4">
<h4 id="org59862d7">Jinja2开启异步支持</h4>
<div class="outline-text-4" id="text-org59862d7">
<p>
Jinja2 从2.9 版本开始增加了异步支持,在创建 Environment 时,通过设置 enable_async
参数即可开启异步模式. 但是 Flask 对象默认已经创建了 Environment 对象,我们只需要
设置 app.jinja_env.is_async=True 即可开启异步模式.
</p>

<p>
Jinja2 开启异步模式后,就可以在模板中使用协程. 下面就通过 app.jinja_env.globals
添加协程:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; font-style: italic;">app</span> = Flask(<span style="font-weight: bold;">__name__</span>)
app.jinja_env.<span style="font-weight: bold; font-style: italic;">is_async</span> = <span style="font-weight: bold; text-decoration: underline;">True</span>

<span style="font-weight: bold;">async def</span> <span style="font-weight: bold;">get_all_books</span>():
    <span style="font-weight: bold;">async with</span> async_session() <span style="font-weight: bold;">as</span> session:
        <span style="font-weight: bold; font-style: italic;">stmt</span> = select(Book)
        <span style="font-weight: bold; font-style: italic;">result</span> = <span style="font-weight: bold;">await</span> session.execute(stmt)
        <span style="font-weight: bold; font-style: italic;">books</span> = result.scalars().<span style="font-weight: bold;">all</span>()
        <span style="font-weight: bold;">return</span> books

app.jinja_env.<span style="font-weight: bold;">globals</span>[<span style="font-style: italic;">"books"</span>] = get_all_books
</pre>
</div>
<p>
这段代码中我们用 app.jinja_env.is_async 开启了异步模式,然后定义了一个
get_all_books 的协程,取名为 books 添加到模板全局环境中.这样在环境中就可以直接使
用 books 执行协程了.
</p>

<p>
在 templates 下创建 index.html 模板,并在首页的视图函数中渲染它.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="font-weight: bold; text-decoration: underline;">@app.route</span>(<span style="font-style: italic;">"/"</span>)
<span style="font-weight: bold;">def</span> <span style="font-weight: bold;">index</span>():
    <span style="font-weight: bold;">return</span> render_template(<span style="font-style: italic;">"index.html"</span>)
</pre>
</div>
<p>
index.html:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span style="font-weight: bold;">table</span>&gt;
  &lt;<span style="font-weight: bold;">thead</span>&gt;
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;bookname&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;author&lt;/<span style="font-weight: bold;">th</span>&gt;
      &lt;<span style="font-weight: bold;">th</span>&gt;price&lt;/<span style="font-weight: bold;">th</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
  &lt;/<span style="font-weight: bold;">thead</span>&gt;
  &lt;<span style="font-weight: bold;">tbody</span>&gt;
    {% for book in books() %}
    &lt;<span style="font-weight: bold;">tr</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ book.name }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ book.author }}&lt;/<span style="font-weight: bold;">td</span>&gt;
      &lt;<span style="font-weight: bold;">td</span>&gt;{{ book.price }}&lt;/<span style="font-weight: bold;">td</span>&gt;
    &lt;/<span style="font-weight: bold;">tr</span>&gt;
    {% endfor %}
  &lt;/<span style="font-weight: bold;">tbody</span>&gt;
</pre>
</div>
<p>
这个模板中, books 协程被当作普通函数执行,即可得到 books 协程返回的结果.
</p>


<blockquote>
<p>
可能正如作者所说,同步编程的方式仍然是大部分场景的首选,所以在最后这一章的异步编程
里感觉只是介绍了一下 Flask 异步编程与普通 Flask 编程的区别,以及需要用的一些库,没
有更深入的知识,最实用的知识还是这一章最开始讲解 asyncio 标准库基本几个概念的内容.
</p>
</blockquote>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: kamisama</p>
</div>
</body>
</html>